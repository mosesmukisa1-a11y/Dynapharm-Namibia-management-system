<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dynapharm International Namibia - v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .logo {
            text-align: center;
            padding: 20px;
            background: white;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .branch-selector {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .branch-selector select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            width: 300px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #c41e3a;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }
        .tab-button.active { background: white; color: #c41e3a; font-weight: bold; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .form-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #c41e3a;
        }
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #c41e3a;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .required::after { content: ' *'; color: red; font-weight: bold; }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .checkbox-item { display: flex; align-items: center; padding: 5px; }
        .checkbox-item input { margin-right: 8px; width: auto; }
        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #ddd;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #c41e3a;
            cursor: pointer;
        }
        .slider-value {
            display: inline-block;
            margin-left: 15px;
            font-weight: bold;
            color: #c41e3a;
            font-size: 1.2rem;
        }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .client-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .follow-up-card {
            border-left: 4px solid #ddd;
        }

        .follow-up-card.overdue {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .follow-up-card.today {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .follow-up-card.upcoming {
            border-left-color: #3498db;
            background: #f0f8ff;
        }

        .follow-up-card.future {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .follow-up-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .follow-up-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .follow-up-status.overdue {
            background: #e74c3c;
            color: white;
        }

        .follow-up-status.today {
            background: #f39c12;
            color: white;
        }

        .follow-up-status.upcoming {
            background: #3498db;
            color: white;
        }

        .follow-up-status.future {
            background: #27ae60;
            color: white;
        }

        .follow-up-details {
            margin-bottom: 15px;
        }

        .follow-up-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .follow-up-actions {
            display: flex;
            gap: 10px;
        }

        .prescription-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .selected-medicines h4 {
            color: #c41e3a;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .selected-medicines ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .selected-medicines li {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #c41e3a;
            font-weight: 500;
        }

        .notes-display {
            margin-top: 15px;
        }

        .notes-preview {
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }

        .notes-preview h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .notes-content {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: inherit;
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close { 
            float: right; 
            font-size: 28px; 
            cursor: pointer; 
        }
        .user-profile {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .reference-number {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #ffc107;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.3rem;
        }
        .signature-pad {
            border: 2px dashed #c41e3a;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            border-radius: 5px;
            cursor: pointer;
        }
        .na-option {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
            cursor: pointer;
            display: inline-block;
            font-size: 0.9rem;
        }
        .search-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-box input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .search-box input:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .portal-header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c41e3a;
        }
        .medicine-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 2px solid #ddd;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .medicine-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        .medicine-item input {
            margin-right: 8px;
            width: auto;
        }
        .prescription-form {
            background: white;
            padding: 30px;
            margin: 0 auto;
            max-width: 900px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .prescription-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #c41e3a;
            padding-bottom: 20px;
        }
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .symptoms-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .symptom-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            
            body { 
                background: white; 
                padding: 0; 
                font-size: 10px;
                line-height: 1.3;
                font-family: Arial, sans-serif;
                max-width: 21cm;
                margin: 0 auto;
            }
            
            /* Hide unnecessary elements */
            .tabs, .btn, .modal, .logo, .search-box, .portal-header, .action-buttons { 
                display: none !important; 
            }
            
            /* Client registration form specific styles */
            #client {
                display: block !important;
            }
            
            .form-section {
                margin-bottom: 15px;
                page-break-inside: avoid;
                padding: 10px; 
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 2px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .form-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 9px;
                font-weight: bold;
                display: block;
                margin-bottom: 3px; 
            }
            
            .form-group input, .form-group select, .form-group textarea {
                width: 100%;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 3px;
                font-size: 9px;
            }
            
            .signature-pad {
                border: 2px solid #c41e3a;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                border-radius: 5px;
                min-height: 60px;
                font-size: 10px;
            }
            
            .reference-number {
                font-size: 14px;
                font-weight: bold;
                color: #c41e3a;
                text-align: center;
                margin-bottom: 20px;
                padding: 10px;
                background: #e8f5e9;
                border: 2px solid #c41e3a;
                border-radius: 5px;
            }
            
            /* Prescription form specific print styles */
            .prescription-form {
                max-width: none !important;
                padding: 15px !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .prescription-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #c41e3a;
                page-break-after: avoid;
            }
            
            .prescription-header h2 {
                font-size: 20px;
                margin-bottom: 8px;
                color: #c41e3a;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            .prescription-header h3 {
                font-size: 16px;
                margin: 8px 0;
                color: #333;
                font-weight: bold;
            }
            
            .prescription-header p {
                font-size: 12px;
                margin: 4px 0;
                color: #666;
            }
            
            .patient-info {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                background: #f8f9fa;
                padding: 12px;
                border-radius: 5px;
                margin-bottom: 15px;
                font-size: 10px;
                page-break-inside: avoid;
            }
            
            .patient-info div {
                margin-bottom: 3px;
            }
            
            .form-section { 
                margin-bottom: 12px;
                page-break-inside: avoid;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 1px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .symptoms-display {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-top: 5px;
            }
            
            .symptom-tag {
                background: #e3f2fd;
                color: #1976d2;
                padding: 3px 8px;
                border-radius: 10px;
                font-size: 9px;
                font-weight: 500;
            }
            
            .medicine-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 3px;
                max-height: none;
                padding: 8px;
                border: 1px solid #ddd;
                background: #f9f9f9;
                border-radius: 3px;
                font-size: 8px;
                page-break-inside: avoid;
            }
            
            .medicine-item {
                padding: 2px;
                background: white;
                border-radius: 2px;
                border: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                min-height: 20px;
            }
            
            .medicine-item input {
                margin-right: 3px;
                width: auto;
                transform: scale(0.8);
            }
            
            .medicine-item label {
                font-size: 8px;
                margin: 0;
                line-height: 1.2;
            }

            .prescription-display {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                margin-top: 15px !important;
                page-break-inside: avoid;
            }

            .selected-medicines h4 {
                font-size: 12px !important;
                color: #c41e3a !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .selected-medicines ul {
                list-style: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .selected-medicines li {
                padding: 4px 8px !important;
                margin: 3px 0 !important;
                background: white !important;
                border-left: 3px solid #c41e3a !important;
                font-size: 9px !important;
                font-weight: 500 !important;
            }

            .notes-display {
                margin-top: 10px !important;
            }

            .notes-preview {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }

            .notes-preview h4 {
                font-size: 12px !important;
                color: #1976d2 !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .notes-content {
                background: white !important;
                padding: 8px !important;
                border: 1px solid #ddd !important;
                font-size: 10px !important;
                white-space: pre-wrap !important;
            }
            
            textarea {
                width: 100%;
                min-height: 60px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 3px;
                font-size: 10px;
                resize: none;
            }
            
            /* Consultant signature and follow-up section */
            .consultant-footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 3px solid #c41e3a;
                page-break-inside: avoid;
            }
            
            .consultant-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 20px;
            }
            
            .signature-section {
                text-align: center;
            }
            
            .signature-line {
                border-bottom: 2px solid #333;
                width: 250px;
                margin: 25px auto 8px;
                height: 40px;
            }
            
            .follow-up-section {
                text-align: center;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                border: 2px solid #c41e3a;
            }
            
            .follow-up-section h4 {
                font-size: 14px;
                margin-bottom: 10px;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .follow-up-date {
                border: 2px solid #c41e3a;
                padding: 8px;
                width: 180px;
                margin: 15px auto;
                text-align: center;
                font-weight: bold;
                font-size: 12px;
                background: white;
            }
            
            .contact-info {
                font-size: 10px;
                color: #666;
                margin-top: 15px;
            }
            
            /* General container adjustments */
            .container { 
                box-shadow: none; 
                border-radius: 0;
                margin: 0;
                max-width: none;
            }
            
            .modal-content {
                position: static !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            
            .modal {
                position: static !important;
                display: block !important;
                background: white !important;
            }
            
            @page { 
                size: A4; 
                margin: 15mm;
            }
        }

        /* Real-time notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Real-time status indicator */
        .realtime-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .realtime-status.offline {
            background: #e74c3c;
        }

        .realtime-status.syncing {
            background: #f39c12;
        }
    </style>
</head>
<body>
    <!-- Real-time status indicator -->
    <div id="realtimeStatus" class="realtime-status" style="display: none;">
        üîÑ Real-time sync active
    </div>

    <div class="container">
        <div class="logo"><img src="./assets/dynapharm-logo.png" alt="Dynapharm Namibia Logo" style="max-width:200px;height:auto;"></div>

        <div class="header">
            <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
            <p>Comprehensive Health Management System</p>
            <p style="font-size: 0.9rem;">Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
            
            <div class="branch-selector">
                <label style="color: white; margin-right: 10px;">Select Branch:</label>
                <select id="branchSelect" required>
                    <option value="">-- Select Branch --</option>
            </select>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('client', event)">Client Registration</button>
            <button class="tab-button" onclick="openTab('consultant', event)">Consultant Portal</button>
            <button class="tab-button" onclick="openTab('dispenser', event)">Dispenser Portal</button>
            <button class="tab-button" onclick="openTab('admin', event)">Admin Portal</button>
        </div>

        <!-- Client Registration -->
        <div id="client" class="tab-content active">
            <h2>Naturopathy Clinic Health Questionnaire</h2>
            <div class="reference-number" id="clientRefNumber" style="display: none;"></div>
            
            <!-- Network sync test buttons -->
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4 style="color: #c41e3a; margin-bottom: 10px;">üåê Network Synchronization Test</h4>
                <button class="btn btn-info" onclick="refreshAllData()" style="margin: 5px;">üîÑ Refresh Data</button>
                <button class="btn btn-success" onclick="testNetworkSync()" style="margin: 5px;">üåê Test Network Sync</button>
                <button class="btn btn-warning" onclick="checkConnectionStatus()" style="margin: 5px;">üì° Check Connection</button>
            </div>
            
            <form id="clientForm">
                <!-- Member/Referral Information -->
                <div class="form-section">
                    <h3>Member/Referral Information</h3>
                    <p style="margin-bottom: 15px; color: #666;">Please select your membership status:</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Membership Status *</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="member" required style="margin-right: 8px;">
                                    <span>I am a registered member</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="referred" required style="margin-right: 8px;">
                                    <span>I was referred by a member</span>
                                </label>
                        </div>
                        </div>
                    </div>
                    
                    <div id="referralDetails" style="display: none; margin-top: 15px;">
                        <h4>Referral Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Referral Name *</label>
                                <input type="text" name="referralName" placeholder="Full name of person who referred you" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Referral NB Number *</label>
                            <input type="text" name="referralNbNumber" placeholder="e.g., NB12345678 or NB01234567" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                            </div>
                        </div>
                    </div>
                    
                    <div id="memberDetails" style="display: none; margin-top: 15px;">
                        <h4>Member Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Member ID</label>
                                <input type="text" name="memberId" placeholder="Your member ID (if known)">
                            </div>
                            <div class="form-group">
                                <label>Member Since</label>
                                <input type="date" name="memberSince">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Information -->
                <div class="form-section">
                    <h3>Client Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" name="fullName" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Namibian ID Number</label>
                            <input type="text" name="nbNumber" required placeholder="e.g., 12345678901" title="Enter your Namibian national identification number">
                        </div>
                        <div class="form-group">
                            <label class="required">Date</label>
                            <input type="date" name="date" id="currentDate" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Gender</label>
                            <select name="gender" required>
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Date of Birth</label>
                            <input type="date" name="dob" required onchange="calculateAge()">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" name="age" id="age" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Height (cm)</label>
                            <input type="number" name="height" min="0" max="300" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Weight (kg)</label>
                            <input type="number" name="weight" min="0" max="500" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Email Address</label>
                            <input type="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Occupation</label>
                            <input type="text" name="occupation" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Emergency Contact Name & Number</label>
                            <input type="text" name="emergencyContact" placeholder="Name - Phone Number" required>
                        </div>
                    </div>
                </div>

                <!-- Health History -->
                <div class="form-section">
                    <h3>Health History</h3>
                    
                    <div class="form-group">
                        <label class="required">1. Primary Reason for Visit</label>
                        <textarea name="primaryReason" required placeholder="Describe your main health concern..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">2. Past Medical History</label>
                        <span class="na-option" onclick="selectNA('medicalHistory')">Select N/A if none</span>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="na" id="mh_na">
                                <label for="mh_na">N/A - No medical history</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="highBloodPressure" id="mh1">
                                <label for="mh1">High Blood Pressure</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="diabetes" id="mh2">
                                <label for="mh2">Diabetes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="heartDisease" id="mh3">
                                <label for="mh3">Heart Disease</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="asthma" id="mh4">
                                <label for="mh4">Asthma / Breathing Issues</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="digestiveDisorders" id="mh5">
                                <label for="mh5">Digestive Disorders (IBS, Crohn's, etc.)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="thyroid" id="mh6">
                                <label for="mh6">Thyroid Disorders (Hyper/Hypo)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="kidneyLiver" id="mh7">
                                <label for="mh7">Kidney or Liver Disease</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="chronicFatigue" id="mh8">
                                <label for="mh8">Chronic Fatigue / Fibromyalgia</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="arthritis" id="mh9">
                                <label for="mh9">Arthritis (Osteo / Rheumatoid)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="skinConditions" id="mh10">
                                <label for="mh10">Skin Conditions (Eczema, Psoriasis, Acne)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="mentalHealth" id="mh11">
                                <label for="mh11">Anxiety / Depression / Mental Health</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="autoimmune" id="mh12">
                                <label for="mh12">Autoimmune Conditions (Lupus, RA, etc.)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="medicalHistory" value="cancer" id="mh13">
                                <label for="mh13">Cancer (current/past)</label>
                            </div>
                        </div>
                        <input type="text" name="medicalHistoryOther" placeholder="Other conditions (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">3. Surgeries/Procedures</label>
                        <textarea name="surgeries" required placeholder="List any surgeries or medical procedures (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">4. Current Medications</label>
                        <textarea name="currentMedications" required placeholder="List all current medications (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">5. Supplements / Herbal Remedies</label>
                        <textarea name="supplements" required placeholder="List all supplements and herbal remedies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">6. Family Medical History</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="na" id="fh_na">
                                <label for="fh_na">N/A - No family history</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="heartDisease" id="fh1">
                                <label for="fh1">Heart Disease</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="hypertension" id="fh2">
                                <label for="fh2">Hypertension</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="diabetes" id="fh3">
                                <label for="fh3">Diabetes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="stroke" id="fh4">
                                <label for="fh4">Stroke</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="cancer" id="fh5">
                                <label for="fh5">Cancer</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="familyHistory" value="mentalHealth" id="fh6">
                                <label for="fh6">Mental Health Issues</label>
                            </div>
                        </div>
                        <input type="text" name="familyHistoryOther" placeholder="Other family history or cancer type (if applicable)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Lifestyle and Diet -->
                <div class="form-section">
                    <h3>Lifestyle and Diet</h3>
                    
                    <div class="form-group">
                        <label class="required">7. Diet & Nutrition - Do you follow a specific diet?</label>
                        <div class="radio-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="yes" id="dietYes" required onchange="toggleDietOptions()">
                                <label for="dietYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="no" id="dietNo" required onchange="toggleDietOptions()">
                                <label for="dietNo">No</label>
                            </div>
                        </div>
                        <div class="checkbox-group" id="dietOptions" style="display: none; margin-top: 10px;">
                            <div class="checkbox-item">
                                <input type="checkbox" name="dietType" value="vegetarian" id="dt1">
                                <label for="dt1">Vegetarian</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="dietType" value="vegan" id="dt2">
                                <label for="dt2">Vegan</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="dietType" value="glutenFree" id="dt3">
                                <label for="dt3">Gluten-free</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="dietType" value="keto" id="dt4">
                                <label for="dt4">Keto</label>
                            </div>
                        </div>
                        <input type="text" name="dietOther" placeholder="Other diet type..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">8. Food Intolerances/Allergies</label>
                        <textarea name="foodAllergies" required placeholder="List any food intolerances or allergies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">9. Water Intake</label>
                        <select name="waterIntake" required>
                            <option value="">Select daily water intake</option>
                            <option value="less1">Less than 1 litre/day</option>
                            <option value="1to2">1-2 litres/day</option>
                            <option value="2to3">2-3 litres/day</option>
                            <option value="more3">More than 3 litres/day</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">10. Caffeine Intake (per day)</label>
                        <div class="form-grid">
                            <div>
                                <label>Coffee (cups)</label>
                                <input type="number" name="coffeeCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Tea (cups)</label>
                                <input type="number" name="teaCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Energy drinks</label>
                                <select name="energyDrinks" required>
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">11. Smoking, Alcohol & Drugs</label>
                        <div class="form-grid">
                            <div>
                                <label>Do you smoke?</label>
                                <select name="smoking" required onchange="toggleSmokingDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="smokingPerDay" id="smokingPerDay" placeholder="How many per day?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you drink alcohol?</label>
                                <select name="alcohol" required onchange="toggleAlcoholDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="drinksPerWeek" id="drinksPerWeek" placeholder="Drinks per week?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you use recreational drugs?</label>
                                <select name="recreationalDrugs" required onchange="toggleDrugDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="text" name="drugDetails" id="drugDetails" placeholder="Specify..." style="display: none; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Activity and Sleep -->
                <div class="form-section">
                    <h3>Physical Activity and Sleep</h3>
                    
                    <div class="form-group">
                        <label class="required">12. Exercise Frequency</label>
                        <select name="exerciseFreq" required>
                            <option value="">Select frequency</option>
                            <option value="never">Never</option>
                            <option value="1-2">1-2 times per week</option>
                            <option value="3-4">3-4 times per week</option>
                            <option value="5+">5+ times per week</option>
                        </select>
                        <input type="text" name="exerciseType" placeholder="Type of exercise (e.g., walking, gym, sports)..." required style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">13. Sleep Patterns</label>
                        <div>
                            <label>Hours per night:</label>
                            <select name="sleepHours" required>
                                <option value="">Select hours</option>
                                <option value="<5">&lt;5 hours</option>
                                <option value="5-6">5-6 hours</option>
                                <option value="7-8">7-8 hours</option>
                                <option value="9+">9+ hours</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>Do you have sleep problems?</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" name="sleepProblems" value="difficulty_falling" id="sp1">
                                    <label for="sp1">Difficulty falling asleep</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="sleepProblems" value="waking_night" id="sp2">
                                    <label for="sp2">Waking during the night</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="sleepProblems" value="waking_early" id="sp3">
                                    <label for="sp3">Waking too early</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="sleepProblems" value="none" id="sp4">
                                    <label for="sp4">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mental and Emotional Health -->
                <div class="form-section">
                    <h3>Mental and Emotional Health</h3>
                    
                    <div class="form-group">
                        <label class="required">14. Stress Level (1-10)</label>
                        <input type="range" name="stressLevel" min="1" max="10" value="5" class="slider" id="stressSlider" required>
                        <span class="slider-value" id="stressValue">5</span>
                    </div>

                    <div class="form-group">
                        <label class="required">15. Mental Health</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="none" id="mhc0">
                                <label for="mhc0">None</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="anxiety" id="mhc1">
                                <label for="mhc1">Anxiety</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="depression" id="mhc2">
                                <label for="mhc2">Depression</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="panic_attacks" id="mhc3">
                                <label for="mhc3">Panic Attacks</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="mood_swings" id="mhc4">
                                <label for="mhc4">Mood Swings</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mentalHealthConcerns" value="burnout" id="mhc5">
                                <label for="mhc5">Burnout/Fatigue</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">16. Chronic Pain</label>
                        <select name="chronicPain" required onchange="togglePainDetails()">
                            <option value="">Select</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                        <div id="painDetails" style="display: none; margin-top: 10px;">
                            <input type="text" name="painLocation" placeholder="Location of pain...">
                            <label style="margin-top: 10px;">Pain severity (0-10)</label>
                            <input type="range" name="painSeverity" min="0" max="10" value="0" class="slider" id="painSlider">
                            <span class="slider-value" id="painValue">0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>17. Trauma/Abuse History (Optional)</label>
                        <select name="traumaHistory">
                            <option value="prefer_not">Prefer not to answer</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>

                <!-- Other Assessments -->
                <div class="form-section">
                    <h3>Other Assessments</h3>
                    
                    <div class="form-group">
                        <label>18. Women's Health (if applicable)</label>
                        <div class="form-grid">
                            <div>
                                <label>Menstrual cycle</label>
                                <select name="menstrualCycle">
                                    <option value="na">N/A</option>
                                    <option value="regular">Regular</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                            <div>
                                <label>Menopause status</label>
                                <select name="menopause">
                                    <option value="na">N/A</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="pmsSymptoms" placeholder="PMS Symptoms (if any)..." style="margin-top: 10px;">
                        <input type="text" name="pregnancyHistory" placeholder="Pregnancy history (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>19. Men's Health (if applicable)</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="mensHealth" value="na" id="mens0">
                                <label for="mens0">N/A</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mensHealth" value="prostate" id="mens1">
                                <label for="mens1">Prostate issues</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mensHealth" value="urinary" id="mens2">
                                <label for="mens2">Urinary issues</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="mensHealth" value="libido" id="mens3">
                                <label for="mens3">Libido/energy concerns</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">20. Digestive Health</label>
                        <div class="form-grid">
                            <div>
                                <label>Appetite</label>
                                <select name="appetite" required>
                                    <option value="">Select</option>
                                    <option value="poor">Poor</option>
                                    <option value="fair">Fair</option>
                                    <option value="good">Good</option>
                                </select>
                            </div>
                            <div>
                                <label>Bowel Movements</label>
                                <select name="bowelMovements" required>
                                    <option value="">Select</option>
                                    <option value="daily">Daily</option>
                                    <option value="constipation">Constipation</option>
                                    <option value="diarrhea">Diarrhea</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="digestiveOther" placeholder="Other digestive issues..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">21. Allergies</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="none" id="allergy0">
                                <label for="allergy0">None</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="food" id="allergy1">
                                <label for="allergy1">Food</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="seasonal" id="allergy2">
                                <label for="allergy2">Seasonal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="chemical" id="allergy3">
                                <label for="allergy3">Chemical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="environmental" id="allergy4">
                                <label for="allergy4">Environmental</label>
                            </div>
                        </div>
                        <input type="text" name="allergiesOther" placeholder="Other allergies (specify)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Consent -->
                <div class="form-section" style="background: #e8f5e9;">
                    <h3>Consent to Treatment</h3>
                    <p style="margin-bottom: 15px;">I consent to naturopathic care and understand all details are kept confidential.</p>
                    <div class="form-group">
                        <input type="checkbox" id="consentCheck" required style="width: auto; margin-right: 10px;" onchange="handleConsentChange()">
                        <label for="consentCheck" style="display: inline;">I agree to the terms of treatment and data usage</label>
                    </div>
                    <div class="form-group">
                        <label class="required">Electronic Signature</label>
                        <div class="signature-pad" id="signaturePad" onclick="signDocument()">
                            Click here to sign electronically
                        </div>
                        <input type="hidden" name="signature" id="signatureField">
                    </div>
                </div>

                <div style="text-align: center; margin: 20px;">
                    <button type="submit" class="btn btn-success">Save Client Information</button>
                    <button type="button" class="btn btn-warning" onclick="clearForm()">Clear Form</button>
                    <button type="button" class="btn" onclick="printClientForm()">Print</button>
                </div>
            </form>
        </div>

        <!-- Consultant Portal -->
        <div id="consultant" class="tab-content">
            <div id="consultantAuth">
                <div class="portal-header">
                    <h2>üë®‚Äç‚öïÔ∏è Consultant Portal</h2>
                    <p>Access client records and create medical reports</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">üîÑ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access consultant portal</p>
                    <button class="btn" onclick="showLogin('consultant')">üîê Login</button>
                </div>
            </div>
            <div id="consultantContent" style="display: none;">
                <div class="user-profile" id="consultantProfile"></div>
                
                <div class="portal-header">
                    <h2>üë®‚Äç‚öïÔ∏è Consultant Portal - Client Management</h2>
                    <p>Review client information and create medical reports</p>
                </div>
                
                <div class="search-box">
                    <input type="text" id="consultantSearch" placeholder="Search client by name, phone, or reference number...">
                    <button class="btn" onclick="searchClients('consultant')">üîç Search</button>
                    <button class="btn btn-info" onclick="showAllClients('consultant')">üìã Show All Clients</button>
                    <button class="btn btn-success" onclick="refreshConsultantData()">üîÑ Refresh Data</button>
                </div>

                <div id="clientList"></div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìã My Created Reports</h3>
                    <div class="search-box">
                        <input type="text" id="reportSearch" placeholder="Search reports by client name or report ID...">
                        <button class="btn" onclick="searchMyReports()">üîç Search</button>
                        <button class="btn btn-info" onclick="showAllMyReports()">üìã Show All</button>
                        <button class="btn btn-success" onclick="refreshMyReports()">üîÑ Refresh</button>
                    </div>
                    <div id="myReportsList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìÖ Upcoming Follow-ups</h3>
                    <div class="search-box">
                        <input type="date" id="followUpSearch" placeholder="Filter by date..." onchange="filterFollowUps()">
                        <button class="btn btn-primary" onclick="showAllFollowUps()">Show All</button>
                        <button class="btn btn-info" onclick="refreshFollowUps()">üîÑ Refresh</button>
                    </div>
                    <div id="followUpList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìä My Performance Analytics</h3>
                    <div class="search-box">
                        <select id="analyticsTimeframe" onchange="refreshAnalytics()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshAnalytics()">üîÑ Refresh Analytics</button>
                        <button class="btn btn-primary" onclick="printAnalytics()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="analyticsDisplay"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìÖ Appointment Calendar</h3>
                    <div class="search-box">
                        <button class="btn btn-success" onclick="showAppointmentCalendar()">üìÖ Open Calendar</button>
                        <button class="btn btn-primary" onclick="bookAppointment()">‚ûï Book Appointment</button>
                        <button class="btn btn-info" onclick="viewTodayAppointments()">üëÅÔ∏è Today's Appointments</button>
                    </div>
                    <div id="appointmentCalendar" style="display: none; margin-top: 20px;"></div>
                    <div id="appointmentsList"></div>
                </div>
            </div>
        </div>

        <!-- Dispenser Portal -->
        <div id="dispenser" class="tab-content">
            <div id="dispenserAuth">
                <div class="portal-header">
                    <h2>üíä Dispenser Portal</h2>
                    <p>Manage prescriptions and dispensing operations</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">üîÑ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access dispenser portal</p>
                    <button class="btn" onclick="showLogin('dispenser')">üîê Login</button>
                </div>
            </div>
            <div id="dispenserContent" style="display: none;">
                <div class="user-profile" id="dispenserProfile"></div>
                
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">üíä Dispenser Portal - Prescription Management</h2>
                
                <!-- Cash Drawer Status -->
                <div id="cashDrawerStatus" style="background: #f8f9fa; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <!-- Will be populated by displayCashDrawerStatus() -->
                </div>
                
                <div class="search-box">
                    <input type="text" id="dispenserSearch" placeholder="Search prescriptions by client name, report ID, or consultant...">
                    <button class="btn" onclick="searchPrescriptions('dispenser')">üîç Search</button>
                    <button class="btn btn-info" onclick="showAllPrescriptions('dispenser')">üíä Show All Prescriptions</button>
                    <button class="btn btn-warning" onclick="updateExistingReportsPricing()">üí∞ Update Pricing</button>
                    <button class="btn btn-primary" onclick="showDailyStatementModal()">üìä Daily Statement</button>
                    <button class="btn btn-success" onclick="refreshDispenserData()">üîÑ Refresh Data</button>
                </div>

                <div id="prescriptionList"></div>

                <!-- Business Intelligence Dashboard -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìà Business Intelligence Dashboard</h3>
                    <div class="search-box">
                        <select id="biTimeframe" onchange="refreshBusinessIntelligence()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshBusinessIntelligence()">üîÑ Refresh</button>
                        <button class="btn btn-primary" onclick="printBusinessIntelligence()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="biDisplay"></div>
                </div>
                
                <!-- Price List Section -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üí∞ Official Price List - June 2025</h3>
                    <div class="search-box">
                        <input type="text" id="priceSearch" placeholder="Search products by name..." onkeyup="searchPriceList()">
                        <button class="btn btn-info" onclick="showAllPrices()">üìã Show All Prices</button>
                        <button class="btn btn-success" onclick="printPriceList()">üñ®Ô∏è Print Price List</button>
                    </div>
                    <div id="priceList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                </div>
            </div>
        </div>

        <!-- Admin Portal -->
        <div id="admin" class="tab-content">
            <h2>Admin Portal</h2>
            <div id="adminAuth">
                <p>Please login to access admin portal</p>
                <button class="btn" onclick="showLogin('admin')">Login</button>
            </div>
            <div id="adminContent" style="display: none;">
                <div class="form-section">
                    <h3>User Management</h3>
                    <button class="btn btn-success" onclick="showAddUser()">Add User</button>
                    <button class="btn btn-warning" onclick="showChangePassword()">Change Password</button>
                    <button class="btn btn-primary" onclick="refreshAllData()">üîÑ Refresh Data</button>
                    <div id="userList"></div>
                </div>
                
                <div class="form-section">
                    <h3>üîß System Maintenance</h3>
                    <button class="btn btn-info" onclick="updateExistingReportsPricing()">üí∞ Fix Package Pricing</button>
                    <button class="btn btn-info" onclick="fixExistingClientNBNumbers()">üÜî Fix NB Numbers</button>
                    <button class="btn btn-success" onclick="runSystemMaintenance()">üîß Run All Fixes</button>
                    <div style="margin-top: 15px; font-size: 0.85rem; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <p><strong>System Maintenance Tools:</strong></p>
                        <p>‚Ä¢ <strong>Fix Package Pricing:</strong> Updates existing reports with correct package pricing and component selection</p>
                        <p>‚Ä¢ <strong>Fix NB Numbers:</strong> Converts old NB number formats to new "NB" format</p>
                        <p>‚Ä¢ <strong>Run All Fixes:</strong> Executes both fixes in sequence</p>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Branch Management</h3>
                    <input type="text" id="newBranchName" placeholder="Branch name" style="padding: 10px; margin-right: 10px;">
                    <button class="btn btn-success" onclick="addBranch()">Add Branch</button>
                    <div id="branchList"></div>
                </div>
                
                <div class="form-section">
                    <h3>üì¶ Inventory Management</h3>
                    <div class="search-box">
                        <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="searchInventory()">
                        <button class="btn btn-success" onclick="showAllInventory()">üìã Show All</button>
                        <button class="btn btn-warning" onclick="showLowStockItems()">‚ö†Ô∏è Low Stock Alert</button>
                        <button class="btn btn-primary" onclick="printInventoryReport()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="inventoryList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Login Modal -->
    <div class="modal" id="loginModal" style="display: none;">
        <div class="modal-content" style="max-width: 450px; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 id="loginModalTitle" style="margin: 0; color: #c41e3a; font-size: 1.8rem; font-weight: 700;">Portal Login</h2>
                <span class="close" onclick="closeLoginModal()" style="font-size: 28px; font-weight: bold; color: #999; cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='#c41e3a'" onmouseout="this.style.color='#999'">&times;</span>
            </div>
            
            <form id="loginForm" novalidate>
                <div id="loginError" style="display: none; background: #fee; color: #c41e3a; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #c41e3a; font-size: 0.9rem; line-height: 1.5;">
                    <strong>‚ö†Ô∏è</strong> <span id="loginErrorText"></span>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="loginUsername" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.9rem;">Username</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        placeholder="Enter your username" 
                        required 
                        autocomplete="username"
                        style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box;"
                        onfocus="this.style.borderColor='#c41e3a'; this.style.outline='none'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    >
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label for="loginPassword" style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.9rem;">Password</label>
                    <div style="position: relative;">
                        <input 
                            type="password" 
                            id="loginPassword" 
                            placeholder="Enter your password" 
                            required 
                            autocomplete="current-password"
                            style="width: 100%; padding: 14px 16px; padding-right: 50px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#c41e3a'; this.style.outline='none'"
                            onblur="this.style.borderColor='#e0e0e0'"
                        >
                        <button 
                            type="button" 
                            id="togglePassword" 
                            onclick="togglePasswordVisibility()"
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 1.2rem; padding: 5px;"
                            title="Show/Hide Password"
                        >üëÅÔ∏è</button>
                    </div>
                </div>
                
                <button 
                    type="submit" 
                    class="btn" 
                    id="loginSubmitButton" 
                    style="width: 100%; background: linear-gradient(135deg, #c41e3a 0%, #a01a2e 100%); color: white; padding: 16px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(196, 30, 58, 0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(196, 30, 58, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(196, 30, 58, 0.3)'"
                >
                    üîê Sign In
                </button>
                
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 1px solid #dee2e6;">
                    <p style="margin: 0 0 12px 0; font-weight: 600; color: #495057; font-size: 0.9rem;">üìã Test Accounts:</p>
                    <div style="font-size: 0.85rem; color: #6c757d; line-height: 1.8;">
                        <div><strong>Admin:</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px;">admin</code> / <code style="background: white; padding: 2px 6px; border-radius: 4px;">walker33</code></div>
                        <div><strong>Consultant:</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px;">consultant</code> / <code style="background: white; padding: 2px 6px; border-radius: 4px;">consultant123</code></div>
                        <div><strong>Dispenser:</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px;">dispenser</code> / <code style="background: white; padding: 2px 6px; border-radius: 4px;">dispenser123</code></div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>Add User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <input type="text" name="fullName" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="text" name="username" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="password" name="password" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="tel" name="phone" placeholder="Phone Number" required>
                </div>
                <div class="form-group">
                    <select name="role" required onchange="toggleAdditionalBranches()">
                        <option value="">Select Role</option>
                        <option value="consultant">Consultant</option>
                        <option value="dispenser">Dispenser</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Branch Assignment:</label>
                    <div id="branchSelection">
                        <select name="branch" id="userBranchSelect" required>
                            <option value="">Select Primary Branch</option>
                        </select>
                    </div>
                    <div id="additionalBranches" style="display: none; margin-top: 10px;">
                        <label>Additional Branches (for Consultants):</label>
                        <div id="branchCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Create User</button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2>Change Password</h2>
            <form id="changePasswordForm">
                <div class="form-group">
                    <input type="password" name="currentPassword" placeholder="Current Password" required>
                </div>
                <div class="form-group">
                    <input type="password" name="newPassword" placeholder="New Password" required>
                </div>
                <div class="form-group">
                    <input type="password" name="confirmPassword" placeholder="Confirm Password" required>
                </div>
                <button type="submit" class="btn btn-success">Change Password</button>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            
            <div class="prescription-form">
                <div class="prescription-header">
                    <h2>DYNAPHARM INTERNATIONAL NAMIBIA</h2>
                    <p id="branchInfo"></p>
                    <h3>Summary Analysis Report Card</h3>
            </div>

                <div class="patient-info" id="patientInfo"></div>

                <div class="form-section">
                    <h3>Presenting Symptoms</h3>
                    <div id="patientSymptoms"></div>
            </div>

                <div class="form-section">
                    <h3>Health Assessment</h3>
                    <div id="healthAssessment"></div>
                </div>

                <div class="form-section" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                    <h3 style="color: #2196f3;">ü©∫ ABOUT THE PROBLEMS OF SUB-HEALTH TRENDS</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Select the body system(s) and symptoms affecting the patient to view lifestyle recommendations:</p>
                    
                    <div id="bodySystemsSelector" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <!-- Body systems will be populated here -->
                    </div>
                    
                    <div id="lifestyleRecommendations" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #2196f3; min-height: 100px; display: none;">
                        <!-- Lifestyle recommendations will appear here -->
                    </div>
                </div>

                <div class="form-section" style="background: #e8f5e9; border-left: 5px solid #27ae60;">
                    <h3 style="color: #27ae60;">üéØ AI-Powered Product Recommendations</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Based on symptoms and health conditions, here are suggested products:</p>
                    <div id="recommendationsDisplay" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #27ae60;">
                        <p style="text-align: center; color: #7f8c8d; font-style: italic;">Analyzing patient data...</p>
                    </div>
                    <button type="button" class="btn btn-success" onclick="applyRecommendations()" style="margin-top: 15px; width: 100%;">
                        ‚úÖ Apply All Recommended Products
                    </button>
                </div>

                <div class="form-section">
                    <h3>Consultant's Notes & Diagnosis</h3>
                    <textarea id="consultantNotes" rows="5" style="width: 100%;" placeholder="Enter diagnosis and treatment notes..." oninput="updateNotesDisplay()"></textarea>
                    <div id="notesDisplay" class="notes-display"></div>
                </div>

                <div class="form-section">
                    <h3>Follow-up Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <label for="followUpDate">Recommended Follow-up Date:</label>
                            <input type="date" id="followUpDate" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div>
                            <label for="followUpNotes">Follow-up Notes (Optional):</label>
                            <input type="text" id="followUpNotes" placeholder="e.g., Review progress, adjust dosage..." style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Prescription & Medicine Selection</h3>
                    <div class="medicine-grid" id="medicineGrid"></div>
                    <div id="prescriptionDisplay" class="prescription-display"></div>
                </div>

            <div class="form-group">
                <label>Upload PDF (Optional)</label>
                <input type="file" id="pdfUpload" accept=".pdf" onchange="handlePDF(event)">
                <p id="pdfStatus"></p>
            </div>

                <div class="consultant-footer">
                    <div class="consultant-info">
                        <div class="signature-section">
                            <h4>Consultant Signature</h4>
                            <div class="signature-line"></div>
                            <p id="consultantSignatureName">${currentUser ? currentUser.fullName : 'Consultant Name'}</p>
                            <div class="contact-info" id="consultantContactInfo">
                                <p>Tel: 061-300877</p>
                                <p>Email: info@dynapharm.com.na</p>
                            </div>
                        </div>
                        <div class="follow-up-section">
                            <h4>Follow-up Date</h4>
                            <div class="follow-up-date" id="followUpDateDisplay">________________</div>
                            <p>Next appointment recommended</p>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveReport()">üíæ Save Report</button>
                    <button class="btn btn-warning" onclick="printReport()">üñ®Ô∏è Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Branches Modal -->
    <div class="modal" id="editBranchesModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editBranchesModal')">&times;</span>
            <h2>Edit User Branches</h2>
            <div id="editUserInfo" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            </div>
            <form id="editBranchesForm">
                <div class="form-group">
                    <label>Primary Branch:</label>
                    <select name="primaryBranch" id="editPrimaryBranch" required>
                        <option value="">Select Primary Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Branches (for Consultants):</label>
                    <div id="editBranchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Branches</button>
            </form>
        </div>
    </div>

    <!-- Daily Statement Modal -->
    <div class="modal" id="dailyStatementModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('dailyStatementModal')">&times;</span>
            <h2 style="text-align: center; color: #c41e3a; margin-bottom: 10px;">üìä Daily Statement Preview</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                Review today's activity, then print or simply close to view only
            </p>
            
            <div id="dailyStatementContent" style="background: white; padding: 20px; border-radius: 8px; max-height: 60vh; overflow-y: auto;">
                <!-- Content will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 2px solid #ddd; background: #f8f9fa; border-radius: 8px;">
                <p style="margin-bottom: 15px; color: #666; font-weight: 500;">Choose an action:</p>
                <button class="btn btn-success" onclick="printDailyStatementA4()" style="margin-right: 10px;">üñ®Ô∏è Print A4 / PDF</button>
                <button class="btn btn-warning" onclick="printDailyStatementThermal()" style="margin-right: 10px;">üßæ Thermal Receipt</button>
                <button class="btn btn-secondary" onclick="closeModal('dailyStatementModal')">üëÅÔ∏è View Only (Close)</button>
            </div>
        </div>
    </div>

    <script>
        // IMMEDIATE TEST - This will alert if script runs at all
        alert('Script is loading!');
        
        // Check if script is running
        console.log('üöÄ Script loaded and executing...');
        
        // ----------------------------------------------------------
        //  DYNAPHARM ‚Äì UNIFIED AUTH SYSTEM (FINAL VERSION)
        //  Replaces unifiedStaffLogin, checkExistingSession, old loginPortalRequest,
        //  old setAuthenticatedUser, and old handlePortalLoginSuccess.
        // ----------------------------------------------------------

        // ----------------------------------------------------------
        // 1. MODERN AUTHENTICATION: API First, Local Fallback
        // ----------------------------------------------------------
        window.loginPortalRequest = async function loginPortalRequest(username, password) {
            // Try API authentication first
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        return data.user;
                    }
                } else {
                    const err = await response.json().catch(() => ({ message: 'Invalid credentials.' }));
                    throw new Error(err.message || 'Invalid credentials.');
                }
            } catch (apiError) {
                // If API fails (network error, timeout, etc.), try local authentication
                console.warn('API authentication failed, trying local fallback:', apiError.message);
                
                // Local user authentication fallback
                if (typeof users !== 'undefined' && Array.isArray(users)) {
                    const user = users.find(u => 
                        (u.username || '').toLowerCase() === username.toLowerCase() && 
                        (u.password || '') === password
                    );
                    
                    if (user) {
                        // Return user in expected format
                        return {
                            id: user.id,
                            username: user.username,
                            role: user.role,
                            fullName: user.fullName || user.username,
                            email: user.email,
                            phone: user.phone,
                            branch: user.branch,
                            branches: user.branches || []
                        };
                    }
                }
                
                // If both fail, throw appropriate error
                if (apiError.name === 'AbortError') {
                    throw new Error('Request timeout. Please check your connection and try again.');
                } else if (apiError.message) {
                    throw apiError;
                } else {
                    throw new Error('Invalid username or password.');
                }
            }
        };


        // ----------------------------------------------------------
        // 2. GLOBAL: Persist authenticated user
        // ----------------------------------------------------------
        function setAuthenticatedUser(user) {
            if (!user) return;

            const session = {
                username: user.username || null,
                role: user.role || null,
                fullName: user.fullName || null,
                email: user.email || null,
                phone: user.phone || null,
                branch: user.branch || null,
                branches: user.branches || [],
                token: user.token || null,           // if provided
                timestamp: Date.now()
            };

            localStorage.setItem('dyna_portal_user', JSON.stringify(session));
            window.currentUser = session;
            currentUser = session; // Also set local variable
        }


        // ----------------------------------------------------------
        // 3. GLOBAL: Success Handler ‚Üí Redirect to Correct Portal
        // ----------------------------------------------------------
        function handlePortalLoginSuccess(user, options = {}) {
            // Store user
            setAuthenticatedUser(user);

            // Determine which portal they should see
            const role = (user.role || "").toLowerCase();

            const portalRoutes = {
                "client": "distributor-portal.html",
                "distributor": "distributor-portal.html",
                "branch": "branch-stock-inventory.html",
                "warehouse": "branch-stock-inventory.html",
                "hr": "dynapharm-complete-system.html",
                "hr_manager": "dynapharm-complete-system.html",
                "hr_admin": "dynapharm-complete-system.html",
                "gm": "gm-portal.html",
                "director": "director-portal.html",
                "admin": "admin-portal.html",
                "mis": "mis-portal.html",
                "consultant": "consultant-portal.html"
            };

            const redirectUrl = portalRoutes[role] || "distributor-portal.html";

            if (!options.silent) {
                console.log(`üîê Login successful. Redirecting to ${redirectUrl}`);
            }

            window.location.href = redirectUrl;
        }

        // Ensure global access
        window.handlePortalLoginSuccess = handlePortalLoginSuccess;
        window.setAuthenticatedUser = setAuthenticatedUser;


        // ----------------------------------------------------------
        // 4. MODERN LOGIN FORM HANDLER with Enhanced UX
        // ----------------------------------------------------------
        
        // Error handling functions (defined globally for accessibility)
        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            const loginErrorText = document.getElementById('loginErrorText');
            if (loginError && loginErrorText) {
                loginErrorText.textContent = message;
                loginError.style.display = 'block';
                
                // Scroll error into view
                loginError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideLoginError() {
            const loginError = document.getElementById('loginError');
            if (loginError) {
                loginError.style.display = 'none';
            }
        }
        
        // Make error functions globally accessible
        window.showLoginError = showLoginError;
        window.hideLoginError = hideLoginError;
        
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');
            const loginErrorText = document.getElementById('loginErrorText');
            const loginSubmitButton = document.getElementById('loginSubmitButton');
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');

            if (!loginForm) {
                console.warn('‚ö†Ô∏è Login form not found');
                return;
            }

            // Clear error on input
            [usernameInput, passwordInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => {
                        if (loginError && loginError.style.display === 'block') {
                            hideLoginError();
                        }
                    });
                }
            });

            // Handle form submission
            loginForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const username = usernameInput?.value.trim();
                const password = passwordInput?.value.trim();

                // Validation
                if (!username || !password) {
                    showLoginError('Please enter both username and password.');
                    usernameInput?.focus();
                    return;
                }

                // Hide previous errors
                hideLoginError();

                // Update UI for loading state
                const originalButtonText = loginSubmitButton.textContent;
                const originalButtonStyle = loginSubmitButton.style.cssText;
                
                loginSubmitButton.disabled = true;
                loginSubmitButton.textContent = 'üîê Signing in...';
                loginSubmitButton.style.opacity = '0.7';
                loginSubmitButton.style.cursor = 'not-allowed';

                try {
                    // Attempt authentication
                    const user = await loginPortalRequest(username, password);
                    
                    // Success - show success message briefly
                    loginSubmitButton.textContent = '‚úÖ Success!';
                    loginSubmitButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    
                    // Close modal and handle login
                    setTimeout(() => {
                        closeLoginModal();
                        if (typeof handlePortalLoginSuccess === 'function') {
                            handlePortalLoginSuccess(user);
                        } else {
                            console.error('‚ö†Ô∏è handlePortalLoginSuccess function not found');
                            alert('Login successful but redirect failed. Please refresh the page.');
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('Login error:', error);
                    // Show error message
                    showLoginError(error.message || 'Unable to login. Please try again.');
                    
                    // Reset button
                    loginSubmitButton.disabled = false;
                    loginSubmitButton.textContent = originalButtonText;
                    loginSubmitButton.style.cssText = originalButtonStyle;
                    
                    // Focus on password field for retry
                    passwordInput?.focus();
                    passwordInput?.select();
                }
            });
        });


        // ----------------------------------------------------------
        // 5. ENHANCED SESSION MANAGEMENT & AUTO-RESTORE
        // ----------------------------------------------------------
        function getStoredSession() {
            try {
                const saved = localStorage.getItem('dyna_portal_user');
                if (!saved) return null;
                
                const session = JSON.parse(saved);
                
                // Check if session is still valid (not older than 7 days)
                const SESSION_MAX_AGE = 7 * 24 * 60 * 60 * 1000; // 7 days
                if (session.timestamp && (Date.now() - session.timestamp > SESSION_MAX_AGE)) {
                    localStorage.removeItem('dyna_portal_user');
                    return null;
                }
                
                return session;
            } catch (e) {
                console.warn("‚ö†Ô∏è Failed to parse stored session:", e);
                localStorage.removeItem('dyna_portal_user');
                return null;
            }
        }

        function clearSession() {
            localStorage.removeItem('dyna_portal_user');
            window.currentUser = null;
            currentUser = null;
        }

        // Auto-restore session on page load
        (function restoreSession() {
            const session = getStoredSession();
            if (session && session.username) {
                window.currentUser = session;
                currentUser = session;
                console.log('‚úÖ Session restored for:', session.username);
                
                // Optionally auto-login (commented out to prevent unwanted redirects)
                // handlePortalLoginSuccess(session, { silent: true });
            }
        })();
        
        // Make session functions globally accessible
        window.getStoredSession = getStoredSession;
        window.clearSession = clearSession;

        let clients = [
            {"referenceNumber": "CLT-NGHISHIDIMBWA-NB96061001371-1759828718144", "fullName": "Nghishidimbwa Mathias Nghipangelwa", "nbNumber": "NB96061001371", "email": "", "phone": "0816716038", "membershipStatus": "referred", "referralName": "mogan maria ", "referralNbNumber": "12345678", "memberId": "", "memberSince": "", "gender": "Male", "dob": "1996-06-10", "age": "28", "height": "175", "weight": "70", "occupation": "Teacher", "emergencyContact": "0812345678", "primaryReason": "General Health Check", "medicalHistory": "None", "currentMedications": "None", "supplements": "None", "familyHistory": ["None"], "waterIntake": "1-2 liters", "exerciseFreq": "1-2 times per week", "sleepHours": "6-7 hours", "stressLevel": "Moderate", "symptoms": ["None"], "signature": "Nghishidimbwa Mathias Nghipangelwa", "branch": "townshop", "timestamp": "2025-10-07T09:18:38.144Z", "lastUpdated": "2025-10-07T10:11:14.845Z", "updatedBy": "NAEM HANGULA", "allergies": ""},
            {"referenceNumber": "CLT-MWAREWANGEPO-NBN/A-1759832656098", "fullName": "Mwarewangepo Munyaradzi Gwinyayi", "nbNumber": "N/A", "email": "m.g.mwarewangepo@gmail.com", "phone": "0816432344", "membershipStatus": "referred", "referralName": "Maria Mogen", "referralNbNumber": "Nb008304", "memberId": "", "memberSince": "", "gender": "male", "dob": "1969-09-08", "age": "56", "height": "1", "weight": "101", "occupation": "teacher", "emergencyContact": "0857468102", "primaryReason": "check my well-being", "medicalHistory": ["highBloodPressure", "diabetes"], "currentMedications": "Yes", "supplements": "N/A", "familyHistory": ["hypertension"], "waterIntake": "2to3", "exerciseFreq": "3-4", "sleepHours": "5-6", "stressLevel": "1", "symptoms": ["none"], "signature": "Mwarewangepo Munyaradzi Gwinyayi", "branch": "townshop", "timestamp": "2025-10-07T10:24:16.098Z"},
            {"referenceNumber": "CLT-JEROME-NB07083000452-1759833199954", "fullName": "JEROME JOSEPH", "nbNumber": "07083000452", "email": "jjoseph@gmail.com", "phone": "0814803618", "membershipStatus": "referred", "referralName": "Jennifer Joseph", "referralNbNumber": "123456789", "memberId": "", "memberSince": "", "gender": "male", "dob": "2007-08-30", "age": "18", "height": "165", "weight": "45", "occupation": "student", "emergencyContact": "0812161169", "primaryReason": "Persistent Migraines", "medicalHistory": ["na"], "currentMedications": "none", "supplements": "Hibiscus tea", "familyHistory": ["hypertension"], "waterIntake": "1to2", "exerciseFreq": "3-4", "sleepHours": "7-8", "stressLevel": "2", "symptoms": ["headache"], "signature": "JEROME JOSEPH", "branch": "townshop", "timestamp": "2025-10-07T10:33:19.954Z"},
            {"referenceNumber": "CLT-KAUANDENGE-NB80010910204-1759835675309", "fullName": "Kauandenge Erenfried", "nbNumber": "80010910204", "email": "Erenfriedkauandenge@gmail.com", "phone": "0812337395", "membershipStatus": "referred", "referralName": "Aibino Apolinario Ndikwete", "referralNbNumber": "NB007695", "memberId": "", "memberSince": "", "gender": "male", "dob": "1980-01-09", "age": "45", "height": "175", "weight": "90", "occupation": "N/A", "emergencyContact": "0814501583", "primaryReason": "General check-up", "medicalHistory": ["highBloodPressure"], "currentMedications": "High blood pressure", "supplements": "N/A", "familyHistory": [], "waterIntake": "less1", "exerciseFreq": "1-2", "sleepHours": "7-8", "stressLevel": "5", "symptoms": ["swelling"], "signature": "Kauandenge Erenfried", "branch": "townshop", "timestamp": "2025-10-07T11:14:35.309Z"},
            {"referenceNumber": "CLT-MVULA-NBNB009561-1759842430247", "fullName": "Mvula", "nbNumber": "NB009561", "email": "mvuladesign@gamil.com", "phone": "0814088881", "membershipStatus": "referred", "referralName": "Jeniffer Joseph", "referralNbNumber": "NB009561", "memberId": "", "memberSince": "", "gender": "male", "dob": "1989-12-09", "age": "35", "height": "180", "weight": "78", "occupation": "Graphic designer", "emergencyContact": "0814088881", "primaryReason": "General check up", "medicalHistory": [], "currentMedications": "TB", "supplements": "N/A", "familyHistory": [], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "7-8", "stressLevel": "3", "symptoms": [], "signature": "Mvula", "branch": "townshop", "timestamp": "2025-10-07T13:07:10.247Z"},
            {"referenceNumber": "CLT-HERMAN-NBNB011114-1759844161976", "fullName": "HERMAN OTTO JACOBES", "nbNumber": "NB011114", "email": "dynapharmnamibia@gmail.com", "phone": "0812959041", "membershipStatus": "referred", "referralName": "KAROLINA NGHIPUNY", "referralNbNumber": "NB011114", "memberId": "", "memberSince": "", "gender": "male", "dob": "1961-03-09", "age": "64", "height": "168", "weight": "67", "occupation": "pensioner", "emergencyContact": "0812791116", "primaryReason": "GENERAL CHECK UP", "medicalHistory": ["na"], "currentMedications": "NO", "supplements": "NO", "familyHistory": ["hypertension", "cancer"], "waterIntake": "less1", "exerciseFreq": "3-4", "sleepHours": "5-6", "stressLevel": "2", "symptoms": [], "signature": "HERMAN OTTO JACOBES", "branch": "townshop", "timestamp": "2025-10-07T13:36:01.976Z"},
            {"referenceNumber": "CLT-MARTH-NBNb9101040323-1759913384085", "fullName": "Marth Ashuulu", "nbNumber": "Nb9101040323", "email": "mo@gmail.com", "phone": "0812801012", "membershipStatus": "referred", "referralName": "Maria Mogen", "referralNbNumber": "008304123412", "memberId": "", "memberSince": "", "gender": "female", "dob": "1991-10-08", "age": "34", "height": "1", "weight": "50", "occupation": "student", "emergencyContact": "0812791116", "primaryReason": "Check my well being", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "less1", "exerciseFreq": "1-2", "sleepHours": "5-6", "stressLevel": "1", "symptoms": ["none"], "signature": "Marth Ashuulu", "branch": "townshop", "timestamp": "2025-10-08T08:49:44.085Z"},
            {"referenceNumber": "CLT-NGATJIZEKO-NBNb-1759915843760", "fullName": "Ngatjizeko Theodor", "nbNumber": "Nb", "email": "tngatjizeko28@gmail.com", "phone": "0817644224", "membershipStatus": "referred", "referralName": "Felisitas Karieue", "referralNbNumber": "009216123456", "memberId": "", "memberSince": "", "gender": "male", "dob": "1988-02-04", "age": "37", "height": "172", "weight": "101", "occupation": "N/A", "emergencyContact": "0815504657", "primaryReason": "Check my well being", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "more3", "exerciseFreq": "5+", "sleepHours": "7-8", "stressLevel": "1", "symptoms": ["weight_changes", "swelling"], "signature": "Ngatjizeko Theodor", "branch": "townshop", "timestamp": "2025-10-08T09:30:43.760Z"},
            {"referenceNumber": "CLT-GWESU-NBNB0631297150942-1759921485554", "fullName": "Gwesu Munyaradzi", "nbNumber": "NB0631297150942", "email": "munyanic2010@gmail.com", "phone": "081351233", "membershipStatus": "member", "referralName": "Klementine Tobias", "referralNbNumber": "NB010733", "memberId": "NB010733", "memberSince": "", "gender": "male", "dob": "1967-09-20", "age": "58", "height": "1", "weight": "73", "occupation": "Diplomate", "emergencyContact": "0812347440", "primaryReason": "Check my well being", "medicalHistory": ["na"], "currentMedications": "N/B", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "2to3", "exerciseFreq": "3-4", "sleepHours": "7-8", "stressLevel": "6", "symptoms": [], "signature": "Gwesu Munyaradzi", "branch": "townshop", "timestamp": "2025-10-08T11:04:45.554Z"},
            {"referenceNumber": "CLT-PENNY-NB00112900593-1759930702178", "fullName": "PENNY", "nbNumber": "00112900593", "email": "josephpeneyambeko42@gmail.com", "phone": "0815807840", "membershipStatus": "member", "referralName": "Octavia Maharero", "referralNbNumber": "NB01108145614", "memberId": "MAHERERO NB011081", "memberSince": "", "gender": "female", "dob": "2000-11-29", "age": "24", "height": "126", "weight": "59", "occupation": "sales", "emergencyContact": "0815807380", "primaryReason": "general check uo", "medicalHistory": ["na"], "currentMedications": "no", "supplements": "no", "familyHistory": ["hypertension"], "waterIntake": "less1", "exerciseFreq": "never", "sleepHours": "5-6", "stressLevel": "5", "symptoms": [], "signature": "PENNY", "branch": "townshop", "timestamp": "2025-10-08T13:38:22.178Z"},
            {"referenceNumber": "CLT-OCTAVIA-NB95061900782-1759932029999", "fullName": "Octavia Maharero", "nbNumber": "95061900782", "email": "mo@gmail.com", "phone": "0813451376", "membershipStatus": "referred", "referralName": "Maria Mogen", "referralNbNumber": "NB008304", "memberId": "", "memberSince": "", "gender": "female", "dob": "1995-06-19", "age": "30", "height": "1", "weight": "65", "occupation": "N/A", "emergencyContact": "0812155173", "primaryReason": "General check up", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "Dyna tonic", "familyHistory": ["diabetes"], "waterIntake": "less1", "exerciseFreq": "3-4", "sleepHours": "5-6", "stressLevel": "2", "symptoms": [], "signature": "Octavia Maharero", "branch": "khomasdal", "timestamp": "2025-10-08T14:00:29.999Z"},
            {"referenceNumber": "CLT-AMASIA-NB88101000755-1759992170364", "fullName": "Amasia N Iileka", "nbNumber": "88101000755", "email": "amasiaileka@gmail.com", "phone": "0815672716", "membershipStatus": "referred", "referralName": "Ndeshipanda Shiponeni", "referralNbNumber": "NB003023", "memberId": "011081", "memberSince": "2024-12-31", "gender": "male", "dob": "1988-10-10", "age": "37", "height": "1", "weight": "93", "occupation": "Truck Driver", "emergencyContact": "0812359540", "primaryReason": "General check up", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "5-6", "stressLevel": "2", "symptoms": [], "signature": "Amasia N Iileka", "branch": "townshop", "timestamp": "2025-10-09T06:42:50.364Z"},
            {"referenceNumber": "CLT-PETRUS-NB54040300645-1759994851719", "fullName": "Petrus Tsitsilia", "nbNumber": "54040300645", "email": "thresialeonard@gmail.com", "phone": "0818129298", "membershipStatus": "referred", "referralName": "Maria Mogen", "referralNbNumber": "NB008304", "memberId": "011081", "memberSince": "2024-12-31", "gender": "female", "dob": "1954-04-03", "age": "71", "height": "1", "weight": "32", "occupation": "Pansioner", "emergencyContact": "0813295565", "primaryReason": "General check up", "medicalHistory": ["highBloodPressure"], "currentMedications": "Yes", "supplements": "N/A", "familyHistory": ["stroke"], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "<5", "stressLevel": "5", "symptoms": [], "signature": "Petrus Tsitsilia", "branch": "townshop", "timestamp": "2025-10-09T07:27:31.719Z"},
            {"referenceNumber": "CLT-MWAMBO-NB58110700365-1759997280974", "fullName": "Mwambo Nyama Maria", "nbNumber": "58110700365", "email": "ndumbperry@gmail.com", "phone": "0813985792", "membershipStatus": "referred", "referralName": "Victoria  Kamati", "referralNbNumber": "NB008427", "memberId": "011081", "memberSince": "2024-12-31", "gender": "female", "dob": "1958-07-11", "age": "67", "height": "1", "weight": "68", "occupation": "Pansioner", "emergencyContact": "0857895744", "primaryReason": "General check up", "medicalHistory": ["highBloodPressure", "digestiveDisorders"], "currentMedications": "Yes", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "7-8", "stressLevel": "1", "symptoms": [], "signature": "Mwambo Nyama Maria", "branch": "townshop", "timestamp": "2025-10-09T08:08:00.974Z"},
            {"referenceNumber": "CLT-HELIVI-NB90072900962-1759998742790", "fullName": "HELIVI NAMUPALA SHIMI", "nbNumber": "90072900962", "email": "shimihelvi@gmail.com", "phone": "0816615812", "membershipStatus": "referred", "referralName": "TUSNELDE  POMBANDA", "referralNbNumber": "NB010109", "memberId": "", "memberSince": "", "gender": "female", "dob": "1990-07-29", "age": "35", "height": "170", "weight": "64", "occupation": "CARE GIVER", "emergencyContact": "0818004759", "primaryReason": "LOWER ABDORMEN PAIN", "medicalHistory": ["na"], "currentMedications": "NO", "supplements": "NO", "familyHistory": ["na"], "waterIntake": "1to2", "exerciseFreq": "1-2", "sleepHours": "7-8", "stressLevel": "3", "symptoms": [], "signature": "HELIVI NAMUPALA SHIMI", "branch": "townshop", "timestamp": "2025-10-09T08:32:22.790Z"},
            {"referenceNumber": "CLT-MWINGA-NB80052810526-1760005460677", "fullName": "Mwinga Matruda", "nbNumber": "80052810526", "email": "mwinga@gmail.com", "phone": "0814140601", "membershipStatus": "member", "referralName": "", "referralNbNumber": "", "memberId": "80052810526", "memberSince": "2024-04-22", "gender": "female", "dob": "1980-05-28", "age": "45", "height": "165", "weight": "85", "occupation": "Solder", "emergencyContact": "0814140601", "primaryReason": "pain under  the feet", "medicalHistory": ["na"], "currentMedications": "NONE", "supplements": "Dynapharm supplement", "familyHistory": ["na"], "waterIntake": "2to3", "exerciseFreq": "5+", "sleepHours": "5-6", "stressLevel": "5", "symptoms": [], "signature": "Mwinga Matruda", "branch": "townshop", "timestamp": "2025-10-09T10:24:20.677Z"},
            {"referenceNumber": "CLT-NAKALEKE-NB801110010632-1760007765521", "fullName": "Nakaleke Johanna", "nbNumber": "801110010632", "email": "jonnynakaleke@gmail.com", "phone": "0813346918", "membershipStatus": "referred", "referralName": "Octavia Maharero", "referralNbNumber": "NB011081", "memberId": "80052810526", "memberSince": "2024-04-22", "gender": "female", "dob": "1980-10-11", "age": "45", "height": "175", "weight": "56", "occupation": "N/A", "emergencyContact": "0812982462", "primaryReason": "General check up", "medicalHistory": ["na"], "currentMedications": "NONE", "supplements": "NONE\n", "familyHistory": ["na"], "waterIntake": "1to2", "exerciseFreq": "1-2", "sleepHours": "5-6", "stressLevel": "1", "symptoms": [], "signature": "Nakaleke Johanna", "branch": "townshop", "timestamp": "2025-10-09T11:02:45.521Z"},
            {"referenceNumber": "CLT-SITARARA-NB82021210022-1760008610147", "fullName": "Sitarara Djami", "nbNumber": "82021210022", "email": "mo@gmail.com", "phone": "0814359347", "membershipStatus": "referred", "referralName": "Maria Mogen", "referralNbNumber": "NB008304", "memberId": "", "memberSince": "", "gender": "Male", "dob": "0001-02-12", "age": "2026", "height": "1", "weight": "52", "occupation": "machardice", "emergencyContact": "0812684853", "primaryReason": "Check my well being", "medicalHistory": "na", "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "", "exerciseFreq": "", "sleepHours": "", "stressLevel": "", "symptoms": [], "signature": "Sitarara Djami", "branch": "townshop", "timestamp": "2025-10-09T11:16:50.147Z", "allergies": "", "lastUpdated": "2025-10-09T13:16:41.361Z", "updatedBy": "HILMA C"},
            {"referenceNumber": "CLT-IYAMBO-NB87032300650-1760012033988", "fullName": "Iyambo Fillemon", "nbNumber": "87032300650", "email": "pomwenerejoice@gmail.com", "phone": "0814572099", "membershipStatus": "referred", "referralName": "Maria Nakweenda", "referralNbNumber": "NB008222", "memberId": "87032300650", "memberSince": "2021-11-11", "gender": "male", "dob": "1987-03-23", "age": "38", "height": "170", "weight": "84", "occupation": "unemployed", "emergencyContact": "0812742950", "primaryReason": "too much wind in the stomach", "medicalHistory": ["na"], "currentMedications": "None", "supplements": "None", "familyHistory": ["hypertension"], "waterIntake": "2to3", "exerciseFreq": "1-2", "sleepHours": "<5", "stressLevel": "4", "symptoms": [], "signature": "Iyambo Fillemon", "branch": "townshop", "timestamp": "2025-10-09T12:13:53.988Z"},
            {"referenceNumber": "CLT-BALIE-NB71010110780-1760081902894", "fullName": "Balie Rebekka", "nbNumber": "71010110780", "email": "dynapharmnamibia@gmail.com", "phone": "0813450408", "membershipStatus": "referred", "referralName": "Felisitas Karieue", "referralNbNumber": "NB009216", "memberId": "", "memberSince": "", "gender": "female", "dob": "1971-01-01", "age": "54", "height": "152", "weight": "65", "occupation": "pensioner", "emergencyContact": "0812036569", "primaryReason": "GENERAL check up", "medicalHistory": ["asthma"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["hypertension", "cancer"], "waterIntake": "less1", "exerciseFreq": "never", "sleepHours": "5-6", "stressLevel": "4", "symptoms": [], "signature": "Balie Rebekka", "branch": "townshop", "timestamp": "2025-10-10T07:38:22.894Z"},
            {"referenceNumber": "CLT-KANKAMENI-NB79112910217-1760082464630", "fullName": "Kankameni Samuel eelu", "nbNumber": "79112910217", "email": "dynapharmnamibia@gmail.com", "phone": "0811491107", "membershipStatus": "referred", "referralName": "Octavia Maharero", "referralNbNumber": "NB011081", "memberId": "", "memberSince": "", "gender": "male", "dob": "1979-11-29", "age": "45", "height": "165", "weight": "73", "occupation": "N/A", "emergencyContact": "0811491107", "primaryReason": "General check up", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "less1", "exerciseFreq": "1-2", "sleepHours": "7-8", "stressLevel": "1", "symptoms": [], "signature": "Kankameni Samuel eelu", "branch": "townshop", "timestamp": "2025-10-10T07:47:44.630Z"},
            {"referenceNumber": "CLT-EISEB-NB99101100319-1760085115356", "fullName": "EISEB Marion Mackenzie", "nbNumber": "99101100319", "email": "dynapharmnamibia@gmail.com", "phone": "0818369443", "membershipStatus": "referred", "referralName": "KAROLINA NGHIPUNYA", "referralNbNumber": "NB011114", "memberId": "", "memberSince": "", "gender": "male", "dob": "1999-10-11", "age": "26", "height": "166", "weight": "65", "occupation": "N/A", "emergencyContact": "0818228389", "primaryReason": "General check up", "medicalHistory": ["kidneyLiver"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["hypertension"], "waterIntake": "1to2", "exerciseFreq": "5+", "sleepHours": "5-6", "stressLevel": "1", "symptoms": [], "signature": "EISEB Marion Mackenzie", "branch": "townshop", "timestamp": "2025-10-10T08:31:55.356Z"},
            {"referenceNumber": "CLT-KANYANGA-NB55040900171-1760166923173", "fullName": "Kanyanga Alfonsina Konde", "nbNumber": "55040900171", "email": "vallentino.haingura@nampower.com.na", "phone": "0818299601", "membershipStatus": "referred", "referralName": "Octavia Maharero", "referralNbNumber": "NB011081", "memberId": "", "memberSince": "", "gender": "female", "dob": "1955-09-04", "age": "70", "height": "169", "weight": "36", "occupation": "pensioner", "emergencyContact": "0812955782", "primaryReason": "General check up.", "medicalHistory": ["na"], "currentMedications": "Paracetamol ect", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "less1", "exerciseFreq": "5+", "sleepHours": "7-8", "stressLevel": "3", "symptoms": [], "signature": "Kanyanga Alfonsina Konde", "branch": "townshop", "timestamp": "2025-10-11T07:15:23.173Z"},
            {"referenceNumber": "CLT-SAMUEL-NB88090100880-1760168518518", "fullName": "Samuel Mateus", "nbNumber": "88090100880", "email": "matheussamuel270@gmail.com", "phone": "0813125014", "membershipStatus": "referred", "referralName": "Maggy Nakweenda", "referralNbNumber": "NB008222", "memberId": "", "memberSince": "", "gender": "male", "dob": "1988-09-01", "age": "37", "height": "160", "weight": "74", "occupation": "truck driver", "emergencyContact": "0853125014", "primaryReason": "back pain", "medicalHistory": ["na"], "currentMedications": "Paracetamol ect", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "1to2", "exerciseFreq": "5+", "sleepHours": "5-6", "stressLevel": "3", "symptoms": [], "signature": "Samuel Mateus", "branch": "townshop", "timestamp": "2025-10-11T07:41:58.518Z"},
            {"referenceNumber": "CLT-NANSES-NB91102300087-1760350491604", "fullName": "NANSES ALIEN GERTHY", "nbNumber": "91102300087", "email": "Kabistro@gmail.com", "phone": "0818831447", "membershipStatus": "referred", "referralName": "Ndapandula david", "referralNbNumber": "NB008994", "memberId": "", "memberSince": "", "gender": "female", "dob": "1991-10-23", "age": "33", "height": "159", "weight": "130", "occupation": "N/A", "emergencyContact": "0812753609", "primaryReason": "JUST to know my well being", "medicalHistory": ["highBloodPressure"], "currentMedications": "For high blood pressure", "supplements": "N/A", "familyHistory": ["heartDisease", "diabetes", "stroke"], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "5-6", "stressLevel": "5", "symptoms": [], "signature": "NANSES ALIEN GERTHY", "branch": "townshop", "timestamp": "2025-10-13T10:14:51.604Z"},
            {"referenceNumber": "CLT-HASHEELA-NB00041300556-1760351526340", "fullName": "Hasheela Wilma-Ngonyofi", "nbNumber": "00041300556", "email": "dynapharmnamibia@gmail.com", "phone": "0815572970", "membershipStatus": "referred", "referralName": "KAROLINA NGHIPUNYA", "referralNbNumber": "NB011114", "memberId": "", "memberSince": "", "gender": "female", "dob": "2000-04-13", "age": "25", "height": "155", "weight": "48", "occupation": "unemployed", "emergencyContact": "08182141586", "primaryReason": "General body check up,stomach problem", "medicalHistory": ["digestiveDisorders"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["na"], "waterIntake": "less1", "exerciseFreq": "never", "sleepHours": "9+", "stressLevel": "3", "symptoms": [], "signature": "Hasheela Wilma-Ngonyofi", "branch": "townshop", "timestamp": "2025-10-13T10:32:06.340Z"},
            {"referenceNumber": "CLT-KAMBONDE-NB00111000912-1760352132905", "fullName": "Kambonde Ester Ndapandula", "nbNumber": "00111000912", "email": "ndapandulakam00@gmail.com", "phone": "0815526522", "membershipStatus": "referred", "referralName": "Octavia Maharero", "referralNbNumber": "NB011081", "memberId": "", "memberSince": "", "gender": "female", "dob": "2000-11-10", "age": "24", "height": "158", "weight": "80", "occupation": "student", "emergencyContact": "0814092395", "primaryReason": "General body check up...", "medicalHistory": ["na"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["heartDisease", "diabetes"], "waterIntake": "1to2", "exerciseFreq": "never", "sleepHours": "5-6", "stressLevel": "1", "symptoms": [], "signature": "Kambonde Ester Ndapandula", "branch": "townshop", "timestamp": "2025-10-13T10:42:12.906Z"},
            {"referenceNumber": "CLT-KATOOLE-NB76091510479-1760353131373", "fullName": "Katoole Hilma", "nbNumber": "76091510479", "email": "dynapharmnamibia@gmail.com", "phone": "0817275372", "membershipStatus": "referred", "referralName": "KAROLINA NGHIPUNYA", "referralNbNumber": "NB011114", "memberId": "", "memberSince": "", "gender": "female", "dob": "1976-09-15", "age": "49", "height": "163", "weight": "62", "occupation": "Self employed", "emergencyContact": "0812868541", "primaryReason": "Stomach  problem,joints issues,headache,back pain and migraine. ", "medicalHistory": ["digestiveDisorders", "arthritis", "mentalHealth"], "currentMedications": "N/A", "supplements": "N/A", "familyHistory": ["hypertension", "diabetes"], "waterIntake": "less1", "exerciseFreq": "5+", "sleepHours": "5-6", "stressLevel": "7", "symptoms": [], "signature": "Katoole Hilma", "branch": "townshop", "timestamp": "2025-10-13T10:58:51.373Z"}
        ];
        let users = [
            {"id": "USR001", "username": "admin", "password": "walker33", "fullName": "Administrator", "email": "admin@dynapharm.com.na", "phone": "061-300877", "role": "admin", "branch": "townshop", "branches": ["townshop"]},
            {"id": "USR1759829667953", "username": "moses", "password": "walker33", "fullName": "MOSES MUKISA", "email": "mosesmukisa1@gmail.com", "phone": "0817317160", "role": "consultant", "branch": "townshop", "branches": ["townshop", "khomasdal", "katima", "outapi", "ondangwa", "okongo", "okahao", "nkurenkuru", "swakopmund", "hochland-park", "rundu", "gobabis", "walvisbay", "eenhana", "otjiwarongo"], "createdAt": "2025-10-07T09:34:27.953Z"},
            {"id": "USR1759829814781", "username": "Geneva", "password": "Pearl_11", "fullName": "Jennifer Joseph", "email": "shange1124@gmail.com", "phone": "0852803618", "role": "consultant", "branch": "townshop", "branches": ["townshop", "khomasdal", "katima", "outapi", "ondangwa", "okongo", "okahao", "nkurenkuru", "swakopmund", "hochland-park", "rundu", "gobabis", "walvisbay", "eenhana", "otjiwarongo"], "createdAt": "2025-10-07T09:36:54.781Z"},
            {"id": "USR1759830625722", "username": "NAEM", "password": "PASSWORD", "fullName": "NAEM HANGULA", "email": "naemhangula4@gmail.com", "phone": "0817499757", "role": "dispenser", "branch": "townshop", "branches": ["townshop"], "createdAt": "2025-10-07T09:50:25.722Z"},
            {"id": "USR1759928153488", "username": "GEINGOS", "password": "ALBERTO99", "fullName": "HILMA C", "email": "geingoshilma@gmail", "phone": "0814137106", "role": "consultant", "branch": "townshop", "branches": ["townshop", "khomasdal", "katima", "outapi", "ondangwa", "okongo", "okahao", "nkurenkuru", "swakopmund", "hochland-park", "rundu", "gobabis", "walvisbay", "eenhana", "otjiwarongo"], "createdAt": "2025-10-08T12:55:53.488Z"}
        ];
        let branches = [
            {"id": "townshop", "name": "TOWNSHOP (Head Office)", "location": "Shop No.1 Continental Building Independence Avenue - Windhoek", "phone": "814683999"},
            {"id": "khomasdal", "name": "KHOMASDAL DPC", "location": "Shop No.2 Khomasdal Funky Town - Windhoek", "phone": "814682991"},
            {"id": "katima", "name": "KATIMA DPC", "location": "Opposite Open Market Hospital Road, Katima", "phone": "817375818"},
            {"id": "outapi", "name": "OUTAPI DPC", "location": "Okasilili Location in Christmas Building, Next Tolemeka Garage Main Road Oshakati - Outapi", "phone": "814685886"},
            {"id": "ondangwa", "name": "ONDANGWA DPC", "location": "Shop No.3 Woerman Block Oluno, Opposite Fresco, Cash and Carry Entrance Ondangwa", "phone": "814685882"},
            {"id": "okongo", "name": "OKONGO DPC", "location": "Handongo Festus Erf 333 Okongo Village Council", "phone": "814684935"},
            {"id": "okahao", "name": "OKAHAO DPC", "location": "Iteka complex opposite Pep store Okahao - Oshakati main road", "phone": "814683963"},
            {"id": "nkurenkuru", "name": "NKURENKURU DPC", "location": "Total Service Station, Next to Oluno Bar - Nkurenkuru", "phone": "814684939"},
            {"id": "swakopmund", "name": "SWAKOPMUND DPC", "location": "Opposite Mondesa Usave Swakopmund", "phone": "814686806"},
            {"id": "hochland-park", "name": "HOCHLAND PARK", "location": "House No.2 Robin Road, Taubern Glain Street, Next to OK Food Windhoek", "phone": "813207195"},
            {"id": "rundu", "name": "RUNDU DPC", "location": "Shop No.6 Fish Building opposite, Dr. Romanus Kampungi Stadium", "phone": "814050125"},
            {"id": "gobabis", "name": "GOBABIS", "location": "Shop No. Church Street Woerman Complex Gobabis", "phone": "814685905"},
            {"id": "walvisbay", "name": "WALVISBAY", "location": "Shop No.6 Pelican Mall Shop Sam Nujoma Avenue", "phone": "814685894"},
            {"id": "eenhana", "name": "EENHANA", "location": "Shop No.3 Tangi Complex, Next to Namibia Funeral Supply, Dimo Amaambo Street Eenhana", "phone": "814682049"},
            {"id": "otjiwarongo", "name": "OTJIWARONGO DPC", "location": "Erindi Complex next to Spar", "phone": "814681997"}
        ];
        let reports = [];
        let currentUser = null;
        let currentPortal = null;
        let currentClientId = null;
        let currentBranch = '';
        let uploadedPDF = null;
        let autoRefreshInterval = null;

        let PACKAGE_DATABASE = window.PACKAGE_DATABASE || {};
        
        // Cash management
        let cashDrawer = {
            openingBalance: 0,
            currentBalance: 0,
            isOpen: false,
            openedBy: null,
            openedAt: null,
            drops: [],
            expenses: []
        };
        
        // Inventory tracking
        let inventory = {};
        
        // Initialize inventory from price list (called on login)
        function initializeInventory() {
            if (Object.keys(inventory).length === 0) {
                // Initialize from PRICE_LIST
                PRICE_LIST.forEach(product => {
                    inventory[product.description] = {
                        currentStock: 0,
                        reorderLevel: 5,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
                
                // Initialize packages
                Object.keys(PACKAGE_DATABASE).forEach(packageName => {
                    inventory[packageName] = {
                        currentStock: 0,
                        reorderLevel: 2,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
            }
        }
        
        // Appointments tracking
        let appointments = [];
        
        let lastDataHash = null;
        
        // API Configuration
        const API_BASE = 'http://192.168.178.182:8001/api';

        // Official Price List - June 2025
        const PRICE_LIST = [
            {description: "ARABICA COFFEE MIX W/GOAT'S AND GANO 25gx20's", dp: 260, cp: 320, bv: 43},
            {description: "BEE POLEN CAPSULE (30's)", dp: 182, cp: 237, bv: 32},
            {description: "BEE POLLEN CAPSULE (100's)", dp: 320, cp: 390, bv: 75},
            {description: "BODY CONTOUR CREAM", dp: 290, cp: 377, bv: 75},
            {description: "COMPACT POWDER 12g", dp: 190, cp: 247, bv: 55},
            {description: "D.I GROW (GREEN) (1 LITER)", dp: 300, cp: 390, bv: 38},
            {description: "D.I GROW (GREEN) (4LITERS)", dp: 650, cp: 780, bv: 115},
            {description: "D.I GROW (RED) (1 LITER)", dp: 240, cp: 312, bv: 38},
            {description: "D.I GROW (RED) (4LITERS)", dp: 560, cp: 728, bv: 115},
            {description: "D.I GROW BIO-8 1 LTR", dp: 220, cp: 286, bv: 27},
            {description: "D.I GROW K 1 LTR", dp: 220, cp: 286, bv: 30},
            {description: "D.I. INSTANT GOAT'S MILK POWDER PREMIX 20's x 21g", dp: 325, cp: 400, bv: 43},
            {description: "D.I. INSTANT SOYBEAN MIXTURE WITH GINGER 25g x 20'", dp: 221, cp: 287, bv: 38},
            {description: "DI LIQUID ALFALFA PLUS GUARANA (500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI LIQUID ALFALFAPLUS GUARANA (150ml)", dp: 200, cp: 260, bv: 21},
            {description: "DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml", dp: 430, cp: 530, bv: 75},
            {description: "Di Liquid Alpha Alpha 500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI NONI 500ml", dp: 350, cp: 455, bv: 110},
            {description: "DI NONI JUICE 1 L", dp: 750, cp: 950, bv: 175},
            {description: "DYNA C- 100 TABLET 150's", dp: 140, cp: 182, bv: 32},
            {description: "DYNA C- 250 TABLET 90's", dp: 140, cp: 182, bv: 27},
            {description: "DYNA 'S' TABLET 120's", dp: 290, cp: 360, bv: 65},
            {description: "DYNA SERENOA TABLET 100's", dp: 520, cp: 620, bv: 115},
            {description: "DYNA SERENOA TABLET 30's", dp: 195, cp: 254, bv: 38},
            {description: "DYNA TONIC (150ml)", dp: 208, cp: 270, bv: 27},
            {description: "DYNA TONIC (780ml)", dp: 600, cp: 710, bv: 120},
            {description: "DYNA TOOTHBRUSH (SET 3 OF 3)", dp: 70, cp: 91, bv: 15},
            {description: "DYNA-RH CAPSULE 100's", dp: 300, cp: 390, bv: 60},
            {description: "E-VITA CREAM (50g)", dp: 610, cp: 700, bv: 165},
            {description: "GANODERMA LOTION 150ML", dp: 182, cp: 237, bv: 38},
            {description: "GANODERMA SHOWER GEL 150ml(GANODERMA BODY SCRUB)", dp: 220, cp: 285, bv: 38},
            {description: "GANODERMA SOAP 2 x 100g", dp: 140, cp: 182, bv: 30},
            {description: "GANODERMA TOOTHPASTE (150g)", dp: 150, cp: 194, bv: 20},
            {description: "GINALI CAPSULE 100's", dp: 403, cp: 493, bv: 80},
            {description: "GINALI CAPSULE 30's", dp: 195, cp: 254, bv: 38},
            {description: "GINSENG CAPSULE 9 x 10's", dp: 546, cp: 655, bv: 115},
            {description: "GOAT'S MILK SOAP (100g)", dp: 70, cp: 91, bv: 15},
            {description: "GOAT'S MILK TABLET 150's", dp: 286, cp: 372, bv: 48},
            {description: "GOAT'S MILK TABLET 75's", dp: 170, cp: 221, bv: 27},
            {description: "GREEN TEA CAPSULE 30's", dp: 195, cp: 254, bv: 43},
            {description: "GREEN TEA CAPSULE 60's", dp: 344, cp: 430, bv: 85},
            {description: "HERBA WARISAN MAHARANI 6 x 10g", dp: 520, cp: 620, bv: 110},
            {description: "HIGH FIBER NUTRITION FOOD 30'sx25g", dp: 660, cp: 790, bv: 120},
            {description: "INSTANT CAPPUCCINO W/ GANO 15's x 35g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT CEREAL 15's x 32g", dp: 325, cp: 423, bv: 48},
            {description: "INSTANT CEREAL 30's x 32g", dp: 510, cp: 610, bv: 95},
            {description: "INSTANT CHOC W/ GANO 30's x 30g", dp: 325, cp: 423, bv: 43},
            {description: "INSTANT COFFEE MIX W/GANODERMA, COLLAGEN & KACIP", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE MIX W/TONGKAT & MACA POWDER(15'sx21g)", dp: 250, cp: 300, bv: 38},
            {description: "Tongkat Ali & Maca - C", dp: 250, cp: 300, bv: 38},
            {description: "INSTANT COFFEE MIX WITH GANODERMA 4-IN-1(SACHET) (20's x 21g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GANO, GREEN TEA 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GINKGO & GINSENG 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ TONGKAT ALI 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/GANO & TONGKAT ALI BLACK 30's x 5g", dp: 276, cp: 359, bv: 59},
            {description: "INSTANT GINSENG HONEY GINGER 500g", dp: 350, cp: 420, bv: 43},
            {description: "INSTANT PEGAGA CAF√â 25G x 15s", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT PREMIX COFFEE WITH MANGOSTEEN(25'sx15g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT WHEATGRASS W/ CHLOROPHYLL 20's x 10g", dp: 286, cp: 372, bv: 43},
            {description: "MILK TEA WITH TONGKAT ALI 21g x 20's", dp: 230, cp: 290, bv: 43},
            {description: "MILK THISTLE TABLET 120's", dp: 500, cp: 592, bv: 125},
            {description: "MILK THISTLE TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "MINERAL POT", dp: 1250, cp: 1625, bv: 265},
            {description: "Nano Home Feminine Wash Antiseptic w/ Sirih 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "Nano Home Feminine Wash Kacip Fatimah 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME FEMININE WASH with GAMAT 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME GAMAT SOAP 100g", dp: 70, cp: 91, bv: 15},
            {description: "NANO HOME PEGAGA SOAP 100g", dp: 70, cp: 91, bv: 8},
            {description: "NONI PLUS TEA 30's x 3g", dp: 299, cp: 360, bv: 65},
            {description: "NUTMEG OINTMENT (2's x 20g)", dp: 180, cp: 234, bv: 19.5},
            {description: "PRESIDENT'S CHOICE 4 IN 1 AND CHOCOLATE COFFEE 20'", dp: 288, cp: 374, bv: 43},
            {description: "PRO- LSB TABLET 150's", dp: 455, cp: 573, bv: 100},
            {description: "PROLINK 20's x 20g", dp: 588, cp: 688, bv: 135},
            {description: "PROLINK 30's x 20g", dp: 600, cp: 719, bv: 170},
            {description: "RED COFFEE W/ GINSENG (12's x 25g)", dp: 260, cp: 320, bv: 38},
            {description: "REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "SEA CUCUMBER JELLY (250ml)", dp: 312, cp: 406, bv: 55},
            {description: "SEA CUCUMBER JELLY (500ml)", dp: 533, cp: 633, bv: 110},
            {description: "SEA WATER SPIRULINA POWDER 500g", dp: 340, cp: 420, bv: 48},
            {description: "SOYBEAN POWDER 454g", dp: 260, cp: 338, bv: 38},
            {description: "SPIRULINA TABLET (1,000's)", dp: 750, cp: 900, bv: 150},
            {description: "SPIRULINA TABLET (100's)", dp: 208, cp: 270, bv: 27},
            {description: "SPIRULINA TABLET (300's)", dp: 351, cp: 456, bv: 64},
            {description: "TEA TREE OIL FEMININE WASH (250ml)", dp: 190, cp: 247, bv: 43},
            {description: "TEA TREE OIL LOTION (250ml)", dp: 180, cp: 234, bv: 19.5},
            {description: "TEA TREE OIL TOOTHPASTE (175g)", dp: 150, cp: 194, bv: 20},
            {description: "TONGKAT ALI CAPSULE 100's", dp: 400, cp: 490, bv: 80},
            {description: "TONGKAT ALI CAPSULE 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEGANO CAPSULE 30's", dp: 195, cp: 254, bv: 27},
            {description: "YEEGANO CAPSULE 90's", dp: 364, cp: 454, bv: 75},
            {description: "Yeeginako Tabs 90's , 30's", dp: 364, cp: 454, bv: 75},
            {description: "YEEGARLIC CAPSULE 90's", dp: 300, cp: 390, bv: 64},
            {description: "YEEGINKGO TABLET (30's)", dp: 234, cp: 304, bv: 27},
            {description: "YEEGINKGO TABLETS 90's", dp: 420, cp: 500, bv: 80},
            {description: "YEEYANGYEN TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEYANGYEN TABLET 90's", dp: 370, cp: 455, bv: 90}
        ];

        // Price lookup function with package support
        function findProductPrice(productName) {
            if (!productName) return {description: productName, dp: 0, cp: 0, bv: 0};
            
            // First check if it's a package - exact match
            if (PACKAGE_DATABASE.hasOwnProperty(productName)) {
                const packageData = PACKAGE_DATABASE[productName];
                return {
                    description: productName,
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            // Try fuzzy matching for packages (e.g., "Blood Circulation Package" -> "Blood Circulation Pack")
            const normalizedProductName = productName.toLowerCase().trim();
            const packageMatch = Object.keys(PACKAGE_DATABASE).find(key => {
                const normalizedKey = key.toLowerCase().trim();
                return normalizedKey === normalizedProductName ||
                       normalizedKey.replace(/pack/g, 'package') === normalizedProductName ||
                       normalizedProductName.replace(/pack/g, 'package') === normalizedKey ||
                       normalizedKey.replace(/\s+/g, '') === normalizedProductName.replace(/\s+/g, '');
            });
            
            if (packageMatch) {
                const packageData = PACKAGE_DATABASE[packageMatch];
                return {
                    description: packageMatch, // Return the correct package name
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            const searchName = productName.toLowerCase().trim();
            
            // Normalize the search name (remove special chars, extra spaces)
            const normalizedSearch = searchName.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
            
            // First try exact match
            let product = PRICE_LIST.find(p => 
                p.description.toLowerCase() === searchName
            );
            
            // Try normalized exact match
            if (!product) {
                product = PRICE_LIST.find(p => {
                    const normalizedDesc = p.description.toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
                    return normalizedDesc === normalizedSearch;
                });
            }
            
            // Try keyword matching (all keywords must be present)
            if (!product) {
                const keywords = normalizedSearch.split(' ').filter(w => w.length > 2);
                product = PRICE_LIST.find(p => {
                    const desc = p.description.toLowerCase();
                    return keywords.every(keyword => desc.includes(keyword));
                });
            }
            
            // Try partial match (most similar)
            if (!product) {
                const matches = PRICE_LIST.filter(p => {
                    const desc = p.description.toLowerCase();
                    return desc.includes(normalizedSearch) || normalizedSearch.includes(desc);
                });
                
                if (matches.length > 0) {
                    // Return the best match (shortest description usually more specific)
                    product = matches.reduce((best, current) => 
                        current.description.length < best.description.length ? current : best
                    );
                }
            }
            
            // Log if product not found for debugging
            if (!product) {
                console.warn(`Product not found in price list: "${productName}"`);
            }
            
            return product || {description: productName, dp: 0, cp: 0, bv: 0};
        }

        // Calculate prescription totals with member/referral pricing and consultation fees
        function calculatePrescriptionTotals(medicines, clientMembershipStatus = 'referred') {
            // Get consultation fee based on membership status
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            
            // Initialize totals with consultation fee
            let totalDP = clientMembershipStatus === 'member' ? consultationFee : 0;
            let totalCP = clientMembershipStatus === 'member' ? 0 : consultationFee;
            let totalBV = 0;
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let pendingDP = 0, pendingCP = 0, pendingBV = 0;
            let paidDP = 0, paidCP = 0, paidBV = 0;
            let outstandingDP = 0, outstandingCP = 0, outstandingBV = 0;

            medicines.forEach(med => {
                const price = findProductPrice(med.name);
                
                // Check if it's a package and calculate based on dispensed items
                let effectivePrice;
                let packageFullPrice = { dp: 0, cp: 0, bv: 0 };
                let packageDispensedPrice = { dp: 0, cp: 0, bv: 0 };
                let packagePendingPrice = { dp: 0, cp: 0, bv: 0 };
                
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                    
                    // Get full package price
                if (clientMembershipStatus === 'member') {
                        packageFullPrice = { dp: packagePricing.packageTotal.dp, cp: packagePricing.packageTotal.dp, bv: packagePricing.packageTotal.bv };
                        packageDispensedPrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                    } else {
                        packageFullPrice = { dp: 0, cp: packagePricing.packageTotal.cp, bv: 0 };
                        packageDispensedPrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                    }
                    
                    // Calculate pending price (full package - dispensed items)
                    packagePendingPrice.dp = packageFullPrice.dp - packageDispensedPrice.dp;
                    packagePendingPrice.cp = packageFullPrice.cp - packageDispensedPrice.cp;
                    packagePendingPrice.bv = packageFullPrice.bv - packageDispensedPrice.bv;
                    
                    effectivePrice = packageDispensedPrice; // For dispensed calculation
                } else {
                    // Individual product pricing
                    if (clientMembershipStatus === 'member') {
                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                } else {
                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                    }
                }
                
                // Add to totals
                if (price.isPackage) {
                    totalDP += packageFullPrice.dp;
                    totalCP += packageFullPrice.cp;
                    totalBV += packageFullPrice.bv;
                    
                    // Add dispensed items
                    dispensedDP += packageDispensedPrice.dp;
                    dispensedCP += packageDispensedPrice.cp;
                    dispensedBV += packageDispensedPrice.bv;
                    
                    // Add pending items
                    pendingDP += packagePendingPrice.dp;
                    pendingCP += packagePendingPrice.cp;
                    pendingBV += packagePendingPrice.bv;
                    
                    // For packages, check payment on dispensed items
                    if (med.paid) {
                        paidDP += packageDispensedPrice.dp;
                        paidCP += packageDispensedPrice.cp;
                        paidBV += packageDispensedPrice.bv;
                    } else {
                        outstandingDP += packageDispensedPrice.dp;
                        outstandingCP += packageDispensedPrice.cp;
                        outstandingBV += packageDispensedPrice.bv;
                    }
                } else {
                totalDP += effectivePrice.dp;
                totalCP += effectivePrice.cp;
                totalBV += effectivePrice.bv;

                if (med.dispensed) {
                    dispensedDP += effectivePrice.dp;
                    dispensedCP += effectivePrice.cp;
                    dispensedBV += effectivePrice.bv;
                    
                    // Check if payment is recorded
                    if (med.paid) {
                        paidDP += effectivePrice.dp;
                        paidCP += effectivePrice.cp;
                        paidBV += effectivePrice.bv;
                    } else {
                        outstandingDP += effectivePrice.dp;
                        outstandingCP += effectivePrice.cp;
                        outstandingBV += effectivePrice.bv;
                    }
                } else {
                    pendingDP += effectivePrice.dp;
                    pendingCP += effectivePrice.cp;
                    pendingBV += effectivePrice.bv;
                    }
                }
            });
            
            // Add consultation fee to appropriate categories
            const hasDispensedItems = medicines.some(m => {
                if (m.dispensed) return true;
                const price = findProductPrice(m.name);
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(m, clientMembershipStatus);
                    return packagePricing.dispensedCount > 0;
                }
                return false;
            });
            
            if (hasDispensedItems) {
                // At least one medicine or package item dispensed, add consultation fee to dispensed and paid
                if (clientMembershipStatus === 'member') {
                    dispensedDP += consultationFee;
                    paidDP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                } else {
                    dispensedCP += consultationFee;
                    paidCP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                }
            } else {
                // No medicines dispensed yet, add consultation fee to pending
                if (clientMembershipStatus === 'member') {
                    pendingDP += consultationFee;
                } else {
                    pendingCP += consultationFee;
                }
            }

            return {
                total: { dp: totalDP, cp: totalCP, bv: totalBV },
                dispensed: { dp: dispensedDP, cp: dispensedCP, bv: dispensedBV },
                pending: { dp: pendingDP, cp: pendingCP, bv: pendingBV },
                paid: { dp: paidDP, cp: paidCP, bv: paidBV },
                outstanding: { dp: outstandingDP, cp: outstandingCP, bv: outstandingBV }
            };
        }

        // Update existing reports with new pricing
        async function updateExistingReportsPricing() {
            try {
                console.log('Updating existing reports with new pricing...');
                
                // Get all reports
                await loadData();
                
                let updatedCount = 0;
                
                // Update each report
                for (let report of reports) {
                    if (report.medicines && report.medicines.length > 0) {
                        let reportUpdated = false;
                        
                        // Update pricing for each medicine in the report
                        report.medicines.forEach(med => {
                            // First, try to match package names for existing reports
                            let medicineName = med.name;
                            let matchedPackage = null;
                            
                            // Check if this is a package that needs name matching
                            const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                                key.toLowerCase().includes(medicineName.toLowerCase()) || 
                                medicineName.toLowerCase().includes(key.toLowerCase()) ||
                                medicineName.toLowerCase().replace(/\s+/g, '') === key.toLowerCase().replace(/\s+/g, '')
                            );
                            
                            if (possibleMatch && PACKAGE_DATABASE[possibleMatch]) {
                                console.log(`Found package match: "${medicineName}" -> "${possibleMatch}"`);
                                medicineName = possibleMatch;
                                med.name = possibleMatch; // Update the medicine name
                                matchedPackage = PACKAGE_DATABASE[possibleMatch];
                                reportUpdated = true;
                            }
                            
                            const newPrice = findProductPrice(medicineName);
                            
                            // Update the medicine with current pricing
                            if (newPrice && (newPrice.dp !== 0 || newPrice.cp !== 0)) {
                                med.currentPrice = {
                                    dp: newPrice.dp,
                                    cp: newPrice.cp,
                                    bv: newPrice.bv,
                                    isPackage: newPrice.isPackage || false,
                                    updatedAt: new Date().toISOString()
                                };
                                
                                // Initialize packageStatus for package medicines if it doesn't exist
                                if (newPrice.isPackage && !med.packageStatus) {
                                    med.packageStatus = {};
                                    console.log(`Initialized packageStatus for ${medicineName} in report ${report.id}`);
                                    reportUpdated = true;
                                }
                                
                                reportUpdated = true;
                            }
                        });
                        
                        if (reportUpdated) {
                            // Update the report in backend
                            try {
                                const result = await apiRequest('/reports', 'PUT', report);
                                if (result.success) {
                                    updatedCount++;
                                    console.log(`Updated pricing for report: ${report.id}`);
                                }
                            } catch (error) {
                                console.error(`Error updating report ${report.id}:`, error);
                            }
                        }
                    }
                }
                
                console.log(`Successfully updated pricing for ${updatedCount} reports`);
                
                // Refresh the display
                if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'consultant') {
                    await displayMyReports();
                }
                
                alert(`‚úÖ Successfully updated ${updatedCount} reports with new pricing and package functionality!`);
                
                return updatedCount;
            } catch (error) {
                console.error('Error updating existing reports pricing:', error);
                alert('‚ùå Error updating reports. Please try again.');
                return 0;
            }
        }

        // Fix existing client NB numbers to follow new format
        async function fixExistingClientNBNumbers() {
            try {
                console.log('Fixing existing client NB numbers...');
                
                // Get all clients
                await loadData();
                
                let fixedCount = 0;
                
                // Fix each client's referral NB number if needed
                for (let client of clients) {
                    if (client.membershipStatus === 'referred' && client.referralNbNumber) {
                        // Check if the referral NB number needs fixing
                        if (!/^NB[0-9]+$/.test(client.referralNbNumber)) {
                            // Try to fix common patterns
                            let fixedNB = client.referralNbNumber;
                            
                            // If it's just digits, add NB prefix
                            if (/^[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB;
                            }
                            // If it starts with 'Nb' (lowercase), capitalize it
                            else if (/^Nb[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB.substring(2);
                            }
                            
                            // If we made a change, update the client
                            if (fixedNB !== client.referralNbNumber) {
                                client.referralNbNumber = fixedNB;
                                client.lastUpdated = new Date().toISOString();
                                client.updatedBy = currentUser ? currentUser.fullName : 'System';
                                
                                // Update in backend
                                try {
                                    const result = await apiRequest('/clients', 'PUT', client);
                                    if (result.success) {
                                        fixedCount++;
                                        console.log(`Fixed NB number for client: ${client.fullName} - ${client.referralNbNumber}`);
                                    }
                                } catch (error) {
                                    console.error(`Error updating client ${client.referenceNumber}:`, error);
                                }
                            }
                        }
                    }
                }
                
                if (fixedCount > 0) {
                    alert(`‚úÖ Successfully fixed ${fixedCount} client NB numbers to follow the new format!`);
                } else {
                    alert('‚úÖ All client NB numbers are already in the correct format!');
                }
                
                return fixedCount;
            } catch (error) {
                console.error('Error fixing client NB numbers:', error);
                alert('‚ùå Error fixing client NB numbers. Please try again.');
                return 0;
            }
        }

        // Run all system maintenance fixes
        async function runSystemMaintenance() {
            try {
                if (!confirm('This will fix all existing data to work with the new system. Continue?')) {
                    return;
                }
                
                console.log('Running system maintenance...');
                
                // Fix NB numbers first
                const nbFixed = await fixExistingClientNBNumbers();
                
                // Then fix package pricing
                const pricingFixed = await updateExistingReportsPricing();
                
                alert(`‚úÖ System maintenance completed!\n\n‚Ä¢ Fixed ${nbFixed} client NB numbers\n‚Ä¢ Fixed ${pricingFixed} reports with package pricing\n\nAll existing data is now compatible with the new system!`);
                
            } catch (error) {
                console.error('Error running system maintenance:', error);
                alert('‚ùå Error running system maintenance. Please try again.');
            }
        }

        // Function to ensure all new reports use updated pricing
        function validateReportPricing(report) {
            if (!report.medicines || report.medicines.length === 0) return report;
            
            // Update each medicine with current pricing
            report.medicines.forEach(med => {
                const currentPrice = findProductPrice(med.name);
                if (currentPrice && (currentPrice.dp !== 0 || currentPrice.cp !== 0)) {
                    med.currentPrice = {
                        dp: currentPrice.dp,
                        cp: currentPrice.cp,
                        bv: currentPrice.bv,
                        isPackage: currentPrice.isPackage || false,
                        updatedAt: new Date().toISOString()
                    };
                }
            });
            
            return report;
        }

        // Handle membership status change
        function handleMembershipStatusChange() {
            const memberRadio = document.querySelector('input[name="membershipStatus"][value="member"]');
            const referredRadio = document.querySelector('input[name="membershipStatus"][value="referred"]');
            const referralDetails = document.getElementById('referralDetails');
            const memberDetails = document.getElementById('memberDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');
            
            if (memberRadio && referredRadio) {
                memberRadio.addEventListener('change', function() {
                    if (this.checked) {
                        referralDetails.style.display = 'none';
                        memberDetails.style.display = 'block';
                        referralNameInput.required = false;
                        referralNbInput.required = false;
                    }
                });
                
                referredRadio.addEventListener('change', function() {
                    if (this.checked) {
                        referralDetails.style.display = 'block';
                        memberDetails.style.display = 'none';
                        referralNameInput.required = true;
                        referralNbInput.required = true;
                    }
                });
            }
        }

        // Real-time data synchronization
        function createDataHash() {
            const dataString = JSON.stringify({
                clients: clients.length,
                users: users.length,
                branches: branches.length,
                reports: reports.length,
                lastUpdate: new Date().toISOString()
            });
            return btoa(dataString).substring(0, 16);
        }

        function hasDataChanged() {
            const currentHash = createDataHash();
            if (lastDataHash && lastDataHash !== currentHash) {
                lastDataHash = currentHash;
                return true;
            }
            lastDataHash = currentHash;
            return false;
        }

        // Consultation fees
        const CONSULTATION_FEES = {
            member: 150,    // N$150 for registered members
            referred: 200   // N$200 for referred clients
        };

        async function init() {
            await loadData();
            loadBranches();
            handleMembershipStatusChange();
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('stressSlider').addEventListener('input', function() {
                document.getElementById('stressValue').textContent = this.value;
            });
            document.getElementById('branchSelect').addEventListener('change', e => {
                currentBranch = e.target.value;
            });
            
            // Add event listener for full name field to update signature
            document.querySelector('input[name="fullName"]').addEventListener('input', function() {
                const consentCheck = document.getElementById('consentCheck');
                if (consentCheck && consentCheck.checked) {
                    handleConsentChange();
                }
            });
        }

        // API Functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                updateRealtimeStatus('syncing');
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                updateRealtimeStatus('online');
                return result;
            } catch (error) {
                console.error('API Error:', error);
                updateRealtimeStatus('offline');
                // Fallback to localStorage if API is not available
                return await fallbackToLocalStorage(endpoint, method, data);
            }
        }

        async function fallbackToLocalStorage(endpoint, method, data) {
            console.log('API unavailable, using localStorage fallback');
            if (endpoint === '/clients') {
                if (method === 'GET') {
                    return JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                } else if (method === 'POST') {
                    const clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                    clients.push(data);
            localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    return { success: true, message: 'Client saved (offline)' };
                }
            }
            // Add more fallback logic as needed
            return { error: 'Offline mode - limited functionality' };
        }

        async function loadData() {
            try {
                clients = await apiRequest('/clients');
                users = await apiRequest('/users');
                branches = await apiRequest('/branches');
                reports = await apiRequest('/reports');
                
                // If API returns empty arrays, initialize with defaults
                if (users.length === 0) {
                users = [
                    {"id":"USR001","username":"admin","password":"walker33","fullName":"Administrator","email":"admin@dynapharm.com.na","phone":"061-300877","role":"admin","branch":"townshop","branches":["townshop"]},
                    {"id":"USR002","username":"consultant","password":"consultant123","fullName":"Dr. John Smith","email":"consultant@dynapharm.com.na","phone":"061-300877","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","hochland-park"]},
                    {"id":"USR003","username":"dispenser","password":"dispenser123","fullName":"Jane Doe","email":"dispenser@dynapharm.com.na","phone":"061-300877","role":"dispenser","branch":"townshop","branches":["townshop"]}
                ];
                }
                
                if (branches.length === 0) {
                    branches = [
                        {"id":"townshop","name":"TOWNSHOP (Head Office)","location":"Shop No.1 Continental Building Independence Avenue - Windhoek","phone":"814683999"},
                        {"id":"khomasdal","name":"KHOMASDAL DPC","location":"Shop No.2 Khomasdal Funky Town - Windhoek","phone":"814682991"},
                        {"id":"katima","name":"KATIMA DPC","location":"Opposite Open Market Hospital Road, Katima","phone":"817375818"},
                        {"id":"outapi","name":"OUTAPI DPC","location":"Okasilili Location in Christmas Building, Next Tolemeka Garage Main Road Oshakati - Outapi","phone":"814685886"},
                        {"id":"ondangwa","name":"ONDANGWA DPC","location":"Shop No.3 Woerman Block Oluno, Opposite Fresco, Cash and Carry Entrance Ondangwa","phone":"814685882"},
                        {"id":"okongo","name":"OKONGO DPC","location":"Handongo Festus Erf 333 Okongo Village Council","phone":"814684935"},
                        {"id":"okahao","name":"OKAHAO DPC","location":"Iteka complex opposite Pep store Okahao - Oshakati main road","phone":"814683963"},
                        {"id":"nkurenkuru","name":"NKURENKURU DPC","location":"Total Service Station, Next to Oluno Bar - Nkurenkuru","phone":"814684939"},
                        {"id":"swakopmund","name":"SWAKOPMUND DPC","location":"Opposite Mondesa Usave Swakopmund","phone":"814686806"},
                        {"id":"hochland-park","name":"HOCHLAND PARK","location":"House No.2 Robin Road, Taubern Glain Street, Next to OK Food Windhoek","phone":"813207195"},
                        {"id":"rundu","name":"RUNDU DPC","location":"Shop No.6 Fish Building opposite, Dr. Romanus Kampungi Stadium","phone":"814050125"},
                        {"id":"gobabis","name":"GOBABIS","location":"Shop No. Church Street Woerman Complex Gobabis","phone":"814685905"},
                        {"id":"walvisbay","name":"WALVISBAY","location":"Shop No.6 Pelican Mall Shop Sam Nujoma Avenue","phone":"814685894"},
                        {"id":"eenhana","name":"EENHANA","location":"Shop No.3 Tangi Complex, Next to Namibia Funeral Supply, Dimo Amaambo Street Eenhana","phone":"814682049"},
                        {"id":"otjiwarongo","name":"OTJIWARONGO DPC","location":"Erindi Complex next to Spar","phone":"814681997"}
                    ];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback to localStorage
            clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                users = JSON.parse(localStorage.getItem('dyna_users') || '[{"id":"USR001","username":"admin","password":"walker33","fullName":"Administrator","email":"admin@dynapharm.com.na","phone":"061-300877","role":"admin","branch":"townshop","branches":["townshop"]},{"id":"USR002","username":"consultant","password":"consultant123","fullName":"Dr. John Smith","email":"consultant@dynapharm.com.na","phone":"061-300877","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","hochland-park"]},{"id":"USR003","username":"dispenser","password":"dispenser123","fullName":"Jane Doe","email":"dispenser@dynapharm.com.na","phone":"061-300877","role":"dispenser","branch":"townshop","branches":["townshop"]}]');
            branches = JSON.parse(localStorage.getItem('dyna_branches') || '[{"id":"townshop","name":"TOWNSHOP (Head Office)","location":"Shop No.1 Continental Building Independence Avenue - Windhoek","phone":"814683999"},{"id":"khomasdal","name":"KHOMASDAL DPC","location":"Shop No.2 Khomasdal Funky Town - Windhoek","phone":"814682991"},{"id":"katima","name":"KATIMA DPC","location":"Opposite Open Market Hospital Road, Katima","phone":"817375818"},{"id":"outapi","name":"OUTAPI DPC","location":"Okasilili Location in Christmas Building, Next Tolemeka Garage Main Road Oshakati - Outapi","phone":"814685886"},{"id":"ondangwa","name":"ONDANGWA DPC","location":"Shop No.3 Woerman Block Oluno, Opposite Fresco, Cash and Carry Entrance Ondangwa","phone":"814685882"},{"id":"okongo","name":"OKONGO DPC","location":"Handongo Festus Erf 333 Okongo Village Council","phone":"814684935"},{"id":"okahao","name":"OKAHAO DPC","location":"Iteka complex opposite Pep store Okahao - Oshakati main road","phone":"814683963"},{"id":"nkurenkuru","name":"NKURENKURU DPC","location":"Total Service Station, Next to Oluno Bar - Nkurenkuru","phone":"814684939"},{"id":"swakopmund","name":"SWAKOPMUND DPC","location":"Opposite Mondesa Usave Swakopmund","phone":"814686806"},{"id":"hochland-park","name":"HOCHLAND PARK","location":"House No.2 Robin Road, Taubern Glain Street, Next to OK Food Windhoek","phone":"813207195"},{"id":"rundu","name":"RUNDU DPC","location":"Shop No.6 Fish Building opposite, Dr. Romanus Kampungi Stadium","phone":"814050125"},{"id":"gobabis","name":"GOBABIS","location":"Shop No. Church Street Woerman Complex Gobabis","phone":"814685905"},{"id":"walvisbay","name":"WALVISBAY","location":"Shop No.6 Pelican Mall Shop Sam Nujoma Avenue","phone":"814685894"},{"id":"eenhana","name":"EENHANA","location":"Shop No.3 Tangi Complex, Next to Namibia Funeral Supply, Dimo Amaambo Street Eenhana","phone":"814682049"},{"id":"otjiwarongo","name":"OTJIWARONGO DPC","location":"Erindi Complex next to Spar","phone":"814681997"}]');
            reports = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
            }
        }

        async function saveData() {
            // This function is kept for compatibility but data is now saved via API calls
            console.log('Data saved via API calls');
        }

        // Global refresh function to update all portals
        async function refreshAllData() {
            const previousHash = lastDataHash;
            await loadData();
            loadBranches();
            
            // Check if data has changed and show notification
            if (previousHash && hasDataChanged()) {
                showDataUpdateNotification();
            }
            
            // Refresh current portal data if user is logged in
            if (currentUser) {
                if (currentPortal === 'consultant') {
                    await displayClients();
                    await displayFollowUps();
                } else if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'admin') {
                    loadUserList();
                    loadBranchListAdmin();
                }
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh every 5 seconds when user is logged in for better real-time sync
            autoRefreshInterval = setInterval(async () => {
                if (currentUser) {
                    await refreshAllData();
                }
            }, 5000);
            
            console.log('üîÑ Auto-refresh started (5 second intervals)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚èπÔ∏è Auto-refresh stopped');
            }
        }

        // Show notification when data is updated
        function showDataUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = 'üîÑ Data updated from another device';
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Show/hide real-time status indicator
        function showRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'block';
                status.className = 'realtime-status';
                status.innerHTML = 'üîÑ Real-time sync active';
            }
        }

        function hideRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'none';
            }
        }

        function updateRealtimeStatus(status) {
            const statusElement = document.getElementById('realtimeStatus');
            if (statusElement) {
                statusElement.className = `realtime-status ${status}`;
                switch(status) {
                    case 'offline':
                        statusElement.innerHTML = '‚ùå Connection lost';
                        break;
                    case 'syncing':
                        statusElement.innerHTML = 'üîÑ Syncing...';
                        break;
                    default:
                        statusElement.innerHTML = 'üîÑ Real-time sync active';
                }
            }
        }

        // Network synchronization test functions
        async function testNetworkSync() {
            try {
                updateRealtimeStatus('syncing');
                
                // Test API connectivity
                const response = await fetch(`${API_BASE}/clients`);
                const data = await response.json();
                
                updateRealtimeStatus('online');
                
                alert(`‚úÖ Network sync test successful!\n\nConnected to: ${API_BASE}\nTotal clients in system: ${data.length}\n\nLatest clients:\n${data.slice(-3).map(c => `- ${c.fullName} (${c.referenceNumber})`).join('\n')}`);
                
            } catch (error) {
                updateRealtimeStatus('offline');
                alert(`‚ùå Network sync test failed!\n\nError: ${error.message}\n\nPlease check:\n1. Backend server is running\n2. Network connection\n3. Firewall settings`);
            }
        }

        async function checkConnectionStatus() {
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/clients`);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const data = await response.json();
                
                alert(`üì° Connection Status Report\n\n‚úÖ API Server: Connected\nüåê Endpoint: ${API_BASE}\n‚è±Ô∏è Response Time: ${responseTime}ms\nüìä Total Clients: ${data.length}\nüîÑ Auto-refresh: ${autoRefreshInterval ? 'Active (5s intervals)' : 'Inactive'}\nüë§ Current User: ${currentUser ? currentUser.fullName : 'Not logged in'}`);
                
            } catch (error) {
                alert(`‚ùå Connection Status Report\n\n‚ùå API Server: Disconnected\nüåê Endpoint: ${API_BASE}\n‚ö†Ô∏è Error: ${error.message}\n\nTroubleshooting:\n1. Check if backend server is running\n2. Verify network connectivity\n3. Check firewall settings`);
            }
        }

        function loadBranches() {
            console.log('Loading branches:', branches);
            const selects = [document.getElementById('branchSelect'), document.getElementById('userBranchSelect')];
            selects.forEach(select => {
                if(select) {
                    select.innerHTML = '<option value="">Select Branch</option>';
                    branches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    });
                    console.log('Populated select:', select.id, 'with', branches.length, 'branches');
                }
            });
        }

        function openTab(tabName, event) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            
            // Show the selected tab content
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            } else {
                console.warn('Tab content not found:', tabName);
            }
            
            // Add active class to the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by tab name
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        // Make openTab globally accessible
        window.openTab = openTab;

        function calculateAge() {
            const dob = document.querySelector('[name="dob"]').value;
            if (dob) {
                const age = Math.floor((new Date() - new Date(dob)) / 31536000000);
                document.getElementById('age').value = age;
            }
        }

        function selectNA(fieldName) {
            const checkboxes = document.querySelectorAll(`[name="${fieldName}"]`);
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('mh_na').checked = true;
        }

        function signDocument() {
            const name = prompt('Enter your full name for signature:');
            if (name) {
                document.getElementById('signatureField').value = name;
                document.getElementById('signaturePad').innerHTML = `Signed: ${name}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
            }
        }

        function handleConsentChange() {
            const consentCheck = document.getElementById('consentCheck');
            const fullName = document.querySelector('input[name="fullName"]').value.trim();
            
            if (consentCheck.checked && fullName) {
                // Auto-fill signature with client's name
                document.getElementById('signatureField').value = fullName;
                document.getElementById('signaturePad').innerHTML = `Signed: ${fullName}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
            } else if (!consentCheck.checked) {
                // Clear signature if consent is unchecked
                document.getElementById('signatureField').value = '';
                document.getElementById('signaturePad').innerHTML = 'Click here to sign electronically';
                document.getElementById('signaturePad').style.background = '#f0f8ff';
            }
        }

        function printClientForm() {
            // Get form data
            const formData = new FormData(document.getElementById('clientForm'));
            const branchSelect = document.getElementById('branchSelect');
            const branchName = branchSelect.options[branchSelect.selectedIndex]?.text || 'Select Branch';
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Client Registration Form</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 8mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 8pt;
                            line-height: 1.2;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 6px 10px;
                            text-align: center;
                            border-radius: 3px;
                            margin-bottom: 6px;
                        }
                        
                        .header h1 {
                            font-size: 14pt;
                            margin-bottom: 2px;
                        }
                        
                        .header p {
                            font-size: 7pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin-bottom: 5px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 3px 6px;
                            font-size: 9pt;
                            font-weight: bold;
                            border-radius: 2px;
                            margin-bottom: 3px;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 3px 8px;
                            background: #f8f9fa;
                            padding: 5px;
                            border-radius: 2px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 7pt;
                            line-height: 1.1;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 60px;
                            font-size: 7pt;
                        }
                        
                        .info-item[style*="grid-column: span 2"] {
                            grid-column: span 2;
                        }
                        
                        .info-item[style*="grid-column: span 3"] {
                            grid-column: span 3;
                        }
                        
                        .footer {
                            margin-top: 6px;
                            padding-top: 5px;
                            border-top: 1px solid #c41e3a;
                            font-size: 6pt;
                            text-align: center;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè• DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>CLIENT REGISTRATION FORM</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üë§ PERSONAL INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${formData.get('fullName') || ''}</div>
                            <div class="info-item"><strong>ID:</strong> ${formData.get('nbNumber') || ''}</div>
                            <div class="info-item"><strong>Gender:</strong> ${formData.get('gender') || ''}</div>
                            <div class="info-item"><strong>DOB:</strong> ${formData.get('dob') || ''}</div>
                            <div class="info-item"><strong>Age:</strong> ${formData.get('age') || ''}y</div>
                            <div class="info-item"><strong>Height:</strong> ${formData.get('height') || ''}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${formData.get('weight') || ''}kg</div>
                            <div class="info-item"><strong>Phone:</strong> ${formData.get('phone') || ''}</div>
                            <div class="info-item"><strong>Email:</strong> ${formData.get('email') || ''}</div>
                            <div class="info-item"><strong>Occupation:</strong> ${formData.get('occupation') || ''}</div>
                            <div class="info-item" style="grid-column: span 2;"><strong>Emergency:</strong> ${formData.get('emergencyContact') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üë• MEMBERSHIP/REFERRAL</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Status:</strong> ${formData.get('membershipStatus') === 'member' ? 'Member' : 'Referred'}</div>
                            ${formData.get('membershipStatus') === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${formData.get('memberId') || 'N/A'}</div>
                                <div class="info-item"><strong>Since:</strong> ${formData.get('memberSince') || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${formData.get('referralName') || 'N/A'}</div>
                                <div class="info-item"><strong>NB:</strong> ${formData.get('referralNbNumber') || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üè• HEALTH INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;"><strong>Primary Reason:</strong> ${formData.get('primaryReason') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Surgeries:</strong> ${formData.get('surgeries') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Current Medications:</strong> ${formData.get('currentMedications') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Supplements:</strong> ${formData.get('supplements') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üçé LIFESTYLE</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Water:</strong> ${formData.get('waterIntake') || ''}</div>
                            <div class="info-item"><strong>Exercise:</strong> ${formData.get('exerciseFreq') || ''}</div>
                            <div class="info-item"><strong>Sleep:</strong> ${formData.get('sleepHours') || ''}h</div>
                            <div class="info-item"><strong>Stress:</strong> ${formData.get('stressLevel') || ''}/10</div>
                            <div class="info-item"><strong>Smoking:</strong> ${formData.get('smoking') || ''}</div>
                            <div class="info-item"><strong>Alcohol:</strong> ${formData.get('alcohol') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">‚úÖ CONSENT & SIGNATURE</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;">
                                <strong>Consent:</strong> I consent to naturopathic care and understand all details are kept confidential.
                            </div>
                            <div class="info-item"><strong>Signature:</strong> ${formData.get('signature') || 'Not signed'}</div>
                            <div class="info-item"><strong>Date:</strong> ${new Date().toLocaleString()}</div>
                            <div class="info-item"></div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Confidential Registration Form</strong> - For inquiries: info@dynapharm.com.na | www.dynapharm.com.na</p>
                        <p>‚úì 2-Page Maximum Format | This information is confidential and for internal use only</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear the entire form? All data will be lost.')) {
                document.getElementById('clientForm').reset();
                document.getElementById('signatureField').value = '';
                document.getElementById('signaturePad').innerHTML = 'Click here to sign electronically';
                document.getElementById('signaturePad').style.background = '#f0f8ff';
            }
        }

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentBranch) {
                alert('Please select a branch first');
                return;
            }
            
            const formData = new FormData(this);
            const fullName = formData.get('fullName').trim();
            const nbNumber = formData.get('nbNumber').trim();
            const membershipStatus = formData.get('membershipStatus');
            const referralName = formData.get('referralName')?.trim();
            const referralNbNumber = formData.get('referralNbNumber')?.trim();
            
            // Validate referral information for referred clients
            if (membershipStatus === 'referred') {
                if (!referralName) {
                    alert('‚ùå Referral Name is required for referred clients');
                    return;
                }
                
                if (!referralNbNumber) {
                    alert('‚ùå Referral NB Number is required for referred clients');
                    return;
                }
                
                // Validate NB number format (NB followed by any digits including 0)
                if (!/^NB[0-9]+$/.test(referralNbNumber)) {
                    alert('‚ùå Please enter a valid Referral NB Number (NB followed by any digits, e.g., NB12345678 or NB01234567)');
                    return;
                }
            }
            
            const firstName = fullName.split(' ')[0].toUpperCase();
            const referenceNumber = `CLT-${firstName}-NB${nbNumber}-${Date.now()}`;
            
            const client = {
                referenceNumber: referenceNumber,
                fullName: fullName,
                nbNumber: nbNumber,
                email: formData.get('email'),
                phone: formData.get('phone'),
                membershipStatus: membershipStatus,
                referralName: referralName,
                referralNbNumber: referralNbNumber,
                memberId: formData.get('memberId'),
                memberSince: formData.get('memberSince'),
                gender: formData.get('gender'),
                dob: formData.get('dob'),
                age: formData.get('age'),
                height: formData.get('height'),
                weight: formData.get('weight'),
                occupation: formData.get('occupation'),
                emergencyContact: formData.get('emergencyContact'),
                primaryReason: formData.get('primaryReason'),
                medicalHistory: formData.getAll('medicalHistory'),
                currentMedications: formData.get('currentMedications'),
                supplements: formData.get('supplements'),
                familyHistory: formData.getAll('familyHistory'),
                waterIntake: formData.get('waterIntake'),
                exerciseFreq: formData.get('exerciseFreq'),
                sleepHours: formData.get('sleepHours'),
                stressLevel: formData.get('stressLevel'),
                symptoms: formData.getAll('symptoms'),
                signature: formData.get('signature'),
                branch: currentBranch,
                timestamp: new Date().toISOString()
            };
            
            try {
                const result = await apiRequest('/clients', 'POST', client);
                if (result.success) {
            clients.push(client);
            
            const refEl = document.getElementById('clientRefNumber');
            refEl.textContent = 'Reference Number: ' + referenceNumber;
            refEl.style.display = 'block';
            
            alert(`Client saved!\n\nReference: ${referenceNumber}\nReferred by: ${client.referralName}\n\nSave this reference number for future visits.`);
            
            if (confirm('Print form?')) {
                window.print();
                    }
                } else {
                    alert('Error saving client: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving client:', error);
                alert('Error saving client. Please try again.');
            }
        });

        function clearForm() {
            if (confirm('Clear form?')) {
                document.getElementById('clientForm').reset();
                document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('signaturePad').innerHTML = 'Click here to sign electronically';
                document.getElementById('signaturePad').style.background = '#f0f8ff';
                document.getElementById('clientRefNumber').style.display = 'none';
            }
        }

        function printClientForm() {
            // Ensure we're on the client tab
            openTab('client');
            
            // Add a small delay to ensure the tab is active
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Modern Login System Functions
        function showLogin(portal) {
            console.log('üîê showLogin called for portal:', portal);
            
            if (!portal) portal = 'default';
            currentPortal = portal;
            
            const loginModal = document.getElementById('loginModal');
            const modalTitle = document.getElementById('loginModalTitle');
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const errorDiv = document.getElementById('loginError');
            
            console.log('Login modal found:', !!loginModal);
            console.log('Login elements:', {
                modalTitle: !!modalTitle,
                usernameInput: !!usernameInput,
                passwordInput: !!passwordInput,
                errorDiv: !!errorDiv
            });
            
            if (!loginModal) {
                console.error('‚ùå Login modal not found!');
                alert('Login modal not found. Please refresh the page.');
                return;
            }
            
            // Update modal title
            if (modalTitle) {
                const PORTAL_LABELS = {
                    frontdesk: 'Front Desk',
                    consultant: 'Consultant',
                    dispenser: 'Branch',
                    admin: 'Admin',
                    finance: 'Finance',
                    stock: 'Stock Management',
                    mis: 'MIS',
                    gm: 'General Manager',
                    director: 'Director',
                    'hr-portal': 'HR',
                    client: 'Client',
                    default: 'Portal'
                };
                const label = PORTAL_LABELS[portal] || portal.charAt(0).toUpperCase() + portal.slice(1);
                modalTitle.textContent = `${label} Portal Login`;
            }
            
            // Clear form and errors
            if (usernameInput) {
                usernameInput.value = '';
                setTimeout(() => usernameInput.focus(), 100);
            }
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.type = 'password';
            }
            if (errorDiv) {
                errorDiv.style.display = 'none';
                const errorText = document.getElementById('loginErrorText');
                if (errorText) errorText.textContent = '';
            }
            
            // Show modal
            loginModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Login modal displayed');
        }
        
        function closeLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleBtn = document.getElementById('togglePassword');
            if (passwordInput && toggleBtn) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleBtn.textContent = 'üôà';
                } else {
                    passwordInput.type = 'password';
                    toggleBtn.textContent = 'üëÅÔ∏è';
                }
            }
        }
        
        // Close modal when clicking outside (but not on child elements)
        window.addEventListener('click', function(event) {
            const loginModal = document.getElementById('loginModal');
            if (loginModal && event.target === loginModal) {
                closeLoginModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const loginModal = document.getElementById('loginModal');
                if (loginModal && loginModal.style.display === 'block') {
                    closeLoginModal();
                }
            }
        });
        
        // Make functions globally accessible
        window.showLogin = showLogin;
        window.closeLoginModal = closeLoginModal;
        window.togglePasswordVisibility = togglePasswordVisibility;
        
        // Confirm functions are accessible
        console.log('‚úÖ Login functions registered:', {
            showLogin: typeof window.showLogin,
            closeLoginModal: typeof window.closeLoginModal,
            togglePasswordVisibility: typeof window.togglePasswordVisibility
        });

        function logout() {
            // Clear session using the new session management
            clearSession();
            
            // Stop any running processes
            if (typeof stopAutoRefresh === 'function') stopAutoRefresh();
            if (typeof hideRealtimeStatus === 'function') hideRealtimeStatus();
            
            // Reset UI
            if (currentPortal) {
                const authEl = document.getElementById(currentPortal + 'Auth');
                const contentEl = document.getElementById(currentPortal + 'Content');
                if (authEl) authEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';
            }
            
            // Return to client tab
            if (typeof openTab === 'function') {
                openTab('client');
            }
            
            console.log('‚úÖ Logged out successfully');
        }
        
        // Make logout globally accessible
        window.logout = logout;

        async function displayClients() {
            // Refresh data from API
            await loadData();
            
            const list = document.getElementById('clientList');
            if (clients.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìã No clients registered</h3><p>Clients will appear here once they register through the client portal.</p></div>';
                return;
            }
            
            // Sort clients by timestamp - latest first
            const sortedClients = [...clients].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            sortedClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'üë§ Member' : 'ü§ù Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üìû Phone:</strong> ${client.phone}</p>
                        <p><strong>üéÇ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>üë§ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>üÜî Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>üìÖ Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üéØ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">üìù Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Search functionality for consultant portal
        function searchClients(portal) {
            const searchTerm = document.getElementById('consultantSearch').value.toLowerCase();
            const list = document.getElementById('clientList');
            
            if (!searchTerm) {
                displayClients();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.fullName.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                client.referenceNumber.toLowerCase().includes(searchTerm) ||
                client.nbNumber.includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No clients found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Sort search results by timestamp - latest first
            filteredClients.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            filteredClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'üë§ Member' : 'ü§ù Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üìû Phone:</strong> ${client.phone}</p>
                        <p><strong>üéÇ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>üë§ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>üÜî Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>üìÖ Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üéØ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">üìù Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllClients(portal) {
            document.getElementById('consultantSearch').value = '';
            displayClients();
        }

        async function refreshConsultantData() {
            await loadData();
            await displayClients();
            await displayMyReports();
            await displayFollowUps();
            await refreshAnalytics();
        }

        async function refreshAnalytics() {
            await loadData();
            
            const display = document.getElementById('analyticsDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Performance Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalClients}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total Clients</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalReports}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Reports Created</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 28pt; margin-bottom: 5px;">${analyticsData.followUpsDue}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Follow-ups Due</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 28pt; margin-bottom: 5px;">${analyticsData.conversionRate}%</h3>
                            <p style="color: #666; font-size: 0.9rem;">Member Conversion</p>
                        </div>
                    </div>

                    <!-- Client Type Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üë• Client Distribution</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Registered Members:</span>
                                    <strong style="color: #27ae60;">${analyticsData.memberClients}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.memberPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Referred Clients:</span>
                                    <strong style="color: #f39c12;">${analyticsData.referredClients}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 10px; border-radius: 5px;">
                                    <div style="background: #f39c12; height: 100%; width: ${analyticsData.referredPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Follow-up Compliance</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Completed Follow-ups:</span>
                                    <strong style="color: #27ae60;">${analyticsData.completedFollowUps}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.followUpCompleteRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Missed Follow-ups:</span>
                                    <strong style="color: #e74c3c;">${analyticsData.missedFollowUps}</strong>
                                </div>
                                <div style="background: #ffebee; height: 10px; border-radius: 5px;">
                                    <div style="background: #e74c3c; height: 100%; width: ${analyticsData.followUpMissedRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                Compliance Rate: <strong style="color: #2196f3;">${analyticsData.followUpCompleteRate}%</strong>
                            </p>
                        </div>
                    </div>

                    <!-- Top Prescribed Products -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üíä Top Prescribed Products</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Times Prescribed</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">% of Scripts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analyticsData.topProducts.slice(0, 10).map((product, idx) => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                        <td style="padding: 8px;">${product.name}</td>
                                        <td style="padding: 8px; text-align: center;">${product.count}</td>
                                        <td style="padding: 8px; text-align: right;">
                                            <div style="display: inline-block; width: 60px; background: #e8f5e9; height: 8px; border-radius: 4px; vertical-align: middle;">
                                                <div style="background: #27ae60; height: 100%; width: ${product.percentage}%; border-radius: 4px;"></div>
                                            </div>
                                            <span style="margin-left: 5px;">${product.percentage}%</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Common Symptoms Treated -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ü©∫ Common Symptoms Treated</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            ${analyticsData.topSymptoms.slice(0, 8).map(symptom => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.9rem;">${symptom.name}</span>
                                        <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                            ${symptom.count}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateConsultantAnalytics(timeframe) {
            const myReports = reports.filter(r => r.consultant === currentUser.fullName);
            const myClients = clients.filter(c => {
                return myReports.some(r => r.clientId === c.referenceNumber);
            });
            
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = myReports.filter(r => new Date(r.timestamp) >= startDate);
            const filteredClients = myClients.filter(c => new Date(c.timestamp) >= startDate);
            
            // Calculate metrics
            const memberClients = filteredClients.filter(c => c.membershipStatus === 'member').length;
            const referredClients = filteredClients.filter(c => c.membershipStatus === 'referred').length;
            const totalClients = filteredClients.length;
            
            // Follow-up tracking
            const reportsWithFollowUp = filteredReports.filter(r => r.followUpDate);
            const followUpsDue = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                return followUpDate < new Date();
            }).length;
            
            // Check for completed follow-ups (client has another report after follow-up date)
            const completedFollowUps = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                const hasReturnVisit = myReports.some(r2 => 
                    r2.clientId === r.clientId && 
                    new Date(r2.timestamp) > followUpDate &&
                    r2.id !== r.id
                );
                return hasReturnVisit;
            }).length;
            
            const missedFollowUps = followUpsDue - completedFollowUps;
            const followUpCompleteRate = followUpsDue > 0 ? Math.round((completedFollowUps / followUpsDue) * 100) : 0;
            const followUpMissedRate = followUpsDue > 0 ? Math.round((missedFollowUps / followUpsDue) * 100) : 0;
            
            // Product prescription trends
            const productCounts = {};
            let totalPrescriptions = 0;
            
            filteredReports.forEach(r => {
                if (r.medicines) {
                    r.medicines.forEach(med => {
                        productCounts[med.name] = (productCounts[med.name] || 0) + 1;
                        totalPrescriptions++;
                    });
                }
            });
            
            const topProducts = Object.entries(productCounts)
                .map(([name, count]) => ({
                    name,
                    count,
                    percentage: Math.round((count / totalPrescriptions) * 100)
                }))
                .sort((a, b) => b.count - a.count);
            
            // Symptom tracking
            const symptomCounts = {};
            
            filteredReports.forEach(r => {
                if (r.symptoms) {
                    r.symptoms.forEach(s => {
                        symptomCounts[s.symptom] = (symptomCounts[s.symptom] || 0) + 1;
                    });
                }
            });
            
            const topSymptoms = Object.entries(symptomCounts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
            
            // Conversion rate (referred ‚Üí member)
            const referredCount = myClients.filter(c => c.membershipStatus === 'referred').length;
            const conversionRate = referredCount > 0 ? Math.round((memberClients / (memberClients + referredCount)) * 100) : 0;
            
            return {
                totalClients: totalClients,
                totalReports: filteredReports.length,
                memberClients,
                referredClients,
                memberPercentage: totalClients > 0 ? Math.round((memberClients / totalClients) * 100) : 0,
                referredPercentage: totalClients > 0 ? Math.round((referredClients / totalClients) * 100) : 0,
                followUpsDue,
                completedFollowUps,
                missedFollowUps,
                followUpCompleteRate,
                followUpMissedRate,
                topProducts,
                topSymptoms,
                conversionRate
            };
        }

        function showAppointmentCalendar() {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const isVisible = calendarDiv.style.display !== 'none';
            calendarDiv.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                renderCalendar(new Date());
            }
        }

        function renderCalendar(currentDate) {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get appointments for this month
            const monthAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getMonth() === month && aptDate.getFullYear() === year;
            });
            
            let calendarHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #c41e3a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-sm" onclick="changeMonth(-1)">‚óÄ Previous</button>
                        <h3 style="color: #c41e3a;">${monthNames[month]} ${year}</h3>
                        <button class="btn btn-sm" onclick="changeMonth(1)">Next ‚ñ∂</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                            <div style="background: #c41e3a; color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px;">
                                ${day}
                            </div>
                        `).join('')}
                        
                        ${Array(startingDayOfWeek).fill(null).map(() => 
                            '<div style="background: #f8f9fa; padding: 20px; border-radius: 5px;"></div>'
                        ).join('')}
                        
                        ${Array(daysInMonth).fill(null).map((_, i) => {
                            const day = i + 1;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const today = new Date();
                            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                            
                            const dayAppointments = monthAppointments.filter(apt => 
                                apt.date.startsWith(dateStr)
                            );
                            
                            return `
                                <div onclick="selectCalendarDate('${dateStr}')" 
                                     style="background: ${isToday ? '#e3f2fd' : 'white'}; 
                                            border: 2px solid ${dayAppointments.length > 0 ? '#27ae60' : '#ddd'}; 
                                            padding: 10px; 
                                            border-radius: 5px; 
                                            cursor: pointer; 
                                            text-align: center;
                                            transition: all 0.3s;
                                            position: relative;">
                                    <div style="font-weight: bold; font-size: 14pt; color: ${isToday ? '#2196f3' : '#2c3e50'};">
                                        ${day}
                                    </div>
                                    ${dayAppointments.length > 0 ? `
                                        <div style="background: #27ae60; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; margin-top: 5px;">
                                            ${dayAppointments.length} apt${dayAppointments.length > 1 ? 's' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div id="selectedDateAppointments" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <!-- Appointments for selected date will appear here -->
                    </div>
                </div>
            `;
            
            calendarDiv.innerHTML = calendarHTML;
            window.currentCalendarDate = currentDate;
        }

        function changeMonth(delta) {
            if (!window.currentCalendarDate) {
                window.currentCalendarDate = new Date();
            }
            
            window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
            renderCalendar(window.currentCalendarDate);
        }

        function selectCalendarDate(dateStr) {
            const selectedDiv = document.getElementById('selectedDateAppointments');
            if (!selectedDiv) return;
            
            const dayAppointments = appointments.filter(apt => apt.date.startsWith(dateStr));
            
            if (dayAppointments.length === 0) {
                selectedDiv.style.display = 'block';
                selectedDiv.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p style="margin-bottom: 15px;"><strong>No appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</strong></p>
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">‚ûï Book Appointment for This Date</button>
                    </div>
                `;
                return;
            }
            
            selectedDiv.style.display = 'block';
            selectedDiv.innerHTML = `
                <div>
                    <h4 style="color: #c41e3a; margin-bottom: 15px;">üìÖ Appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</h4>
                    ${dayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${apt.clientName}</strong>
                                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ‚è∞ ${apt.time} | üë®‚Äç‚öïÔ∏è ${apt.consultant}
                                    </p>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #888; margin-top: 5px;">üìù ${apt.notes}</p>` : ''}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="cancelAppointment('${apt.id}')">‚ùå Cancel</button>
                            </div>
                        </div>
                    `).join('')}
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">‚ûï Add Another Appointment</button>
                    </div>
                </div>
            `;
        }

        function bookAppointment() {
            const date = prompt('Enter appointment date (YYYY-MM-DD or leave blank for today):');
            const appointmentDate = date || new Date().toISOString().split('T')[0];
            
            const time = prompt('Enter appointment time (HH:MM in 24-hour format):');
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: appointmentDate,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`‚úÖ Appointment booked\nDate: ${new Date(appointmentDate).toLocaleDateString('en-GB')}\nTime: ${time}\nClient: ${clientName}`);
            
            if (document.getElementById('appointmentCalendar').style.display !== 'none') {
                renderCalendar(window.currentCalendarDate || new Date());
            }
            viewTodayAppointments();
        }

        function quickBookAppointment(dateStr) {
            const time = prompt(`Book appointment for ${new Date(dateStr).toLocaleDateString('en-GB')}\n\nEnter time (HH:MM in 24-hour format):`);
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: dateStr,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`‚úÖ Appointment booked\nTime: ${time}\nClient: ${clientName}`);
            renderCalendar(window.currentCalendarDate || new Date());
            selectCalendarDate(dateStr);
        }

        function cancelAppointment(aptId) {
            if (!confirm('Cancel this appointment?')) return;
            
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments.splice(index, 1);
                alert('‚úÖ Appointment cancelled');
                renderCalendar(window.currentCalendarDate || new Date());
                viewTodayAppointments();
            }
        }

        function viewTodayAppointments() {
            const listDiv = document.getElementById('appointmentsList');
            if (!listDiv) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = appointments.filter(apt => 
                apt.date === today && apt.consultant === currentUser.fullName
            ).sort((a, b) => a.time.localeCompare(b.time));
            
            if (todayAppointments.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;"><p>No appointments scheduled for today</p></div>';
                return;
            }
            
            listDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">Today's Appointments (${todayAppointments.length})</h4>
                    ${todayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="font-size: 1.1rem;">‚è∞ ${apt.time}</strong> - <strong>${apt.clientName}</strong>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #666; margin-top: 5px;">üìù ${apt.notes}</p>` : ''}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="markAppointmentComplete('${apt.id}')" style="margin-right: 5px;">‚úÖ Complete</button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelAppointment('${apt.id}')">‚ùå Cancel</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function markAppointmentComplete(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'completed';
                appointments[index].completedAt = new Date().toISOString();
                alert('‚úÖ Appointment marked as complete');
                viewTodayAppointments();
            }
        }

        function printAnalytics() {
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Performance Analytics - ${currentUser.fullName}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Consultant Performance Analytics - ${timeframeText}</p>
                        <p>Consultant: ${currentUser.fullName}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('analyticsDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function displayMyReports() {
            await loadData();
            
            const list = document.getElementById('myReportsList');
            if (!list) return;
            
            // Get all reports created by this consultant
            const myReports = reports.filter(r => r.id && r.consultant === currentUser.fullName);
            
            if (myReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìã No reports created yet</h3><p>Reports you create will appear here for review and editing.</p></div>';
                return;
            }
            
            // Sort by timestamp - latest first
            myReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            myReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client) return;
                
                const dispensedCount = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;
                const totalMedicines = report.medicines ? report.medicines.length : 0;
                const isFullyDispensed = dispensedCount === totalMedicines && totalMedicines > 0;
                
                const card = document.createElement('div');
                card.className = 'client-card';
                card.style.borderLeft = isFullyDispensed ? '5px solid #27ae60' : '5px solid #f39c12';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Report ID: ${report.id}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${isFullyDispensed ? '#e8f5e9' : '#fff3cd'}; color: ${isFullyDispensed ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">
                                ${isFullyDispensed ? '‚úÖ Fully Dispensed' : `‚è≥ ${dispensedCount}/${totalMedicines} Dispensed`}
                            </span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üìÖ Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                        <p><strong>üìû Client Phone:</strong> ${client.phone}</p>
                        <p><strong>üíä Medicines:</strong> ${totalMedicines} items</p>
                        ${report.followUpDate ? `<p><strong>üìÖ Follow-up:</strong> ${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
                    </div>
                    ${report.notes ? `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #f39c12;">
                        <p style="font-size: 0.9rem;"><strong>üìù Notes:</strong> ${report.notes.substring(0, 100)}${report.notes.length > 100 ? '...' : ''}</p>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <button class="btn btn-warning" onclick="editReport('${report.id}')" ${isFullyDispensed ? 'disabled title="Cannot edit fully dispensed report"' : ''}>
                            ‚úèÔ∏è Edit Report
                        </button>
                        <button class="btn btn-info" onclick="viewReportDetails('${report.id}')">üëÅÔ∏è View Details</button>
                        <button class="btn" onclick="printReportById('${report.id}')">üñ®Ô∏è Print</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function searchMyReports() {
            const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
            if (!searchTerm) {
                displayMyReports();
                return;
            }
            
            const list = document.getElementById('myReportsList');
            const myReports = reports.filter(r => {
                if (!r.id || r.consultant !== currentUser.fullName) return false;
                const client = clients.find(c => c.referenceNumber === r.clientId);
                return r.id.toLowerCase().includes(searchTerm) || 
                       (client && client.fullName.toLowerCase().includes(searchTerm));
            });
            
            if (myReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No reports found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Use same display logic (will need to extract into reusable function)
            displayMyReports();
        }

        function showAllMyReports() {
            document.getElementById('reportSearch').value = '';
            displayMyReports();
        }

        async function refreshMyReports() {
            await loadData();
            await displayMyReports();
        }

        function editReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) {
                alert('Report not found');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Set current client ID for editing
            currentClientId = report.clientId;
            
            // Fill the report modal with existing data
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list and pre-select medicines from report
            loadMedicineList();
            
            // Pre-select medicines after a brief delay to ensure checkboxes are rendered
            setTimeout(() => {
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            if (cb.value === med.name) {
                                cb.checked = true;
                            }
                        });
                    });
                }
                updatePrescriptionDisplay();
            }, 100);
            
            // Pre-fill consultant notes
            document.getElementById('consultantNotes').value = report.notes || '';
            
            // Pre-fill follow-up date and notes
            if (report.followUpDate) {
                document.getElementById('followUpDate').value = report.followUpDate.split('T')[0];
            }
            if (report.followUpNotes) {
                document.getElementById('followUpNotes').value = report.followUpNotes;
            }
            
            // Initialize body systems
            initializeBodySystems();
            
            // Restore symptom selections from saved report
            setTimeout(() => {
                if (report.symptoms && report.symptoms.length > 0) {
                    report.symptoms.forEach(symptomData => {
                        const systemId = symptomData.system.replace(/[^a-zA-Z0-9]/g, '_');
                        const symptomCheckboxes = document.querySelectorAll('.symptom-checkbox');
                        
                        symptomCheckboxes.forEach(cb => {
                            if (cb.dataset.system === systemId && cb.dataset.symptom === symptomData.symptom) {
                                cb.checked = true;
                            }
                        });
                    });
                    // Trigger the symptom selection handler to update the display
                    handleSymptomSelection();
                }
            }, 200);
            
            // Set consultant signature
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            updateFollowUpDisplay();
            setupFollowUpListener();
            updateNotesDisplay();
            generateRecommendations(client);
            
            // Store report ID for updating instead of creating new
            window.editingReportId = reportId;
            
            // Show modal
            document.getElementById('reportModal').style.display = 'block';
        }

        function viewReportDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            let detailsHTML = `
                <h3>Report Details</h3>
                <p><strong>Report ID:</strong> ${report.id}</p>
                <p><strong>Client:</strong> ${client ? client.fullName : 'Unknown'}</p>
                <p><strong>Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                <p><strong>Consultant:</strong> ${report.consultant}</p>
                
                <h4 style="margin-top: 20px;">Prescribed Medicines:</h4>
                <ul>
                    ${report.medicines ? report.medicines.map(m => `<li>${m.name} ${m.dispensed ? '‚úÖ' : '‚è≥'}</li>`).join('') : '<li>None</li>'}
                </ul>
                
                ${report.notes ? `<h4>Notes:</h4><p>${report.notes}</p>` : ''}
                ${report.followUpDate ? `<h4>Follow-up:</h4><p>${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
            `;
            
            alert(detailsHTML.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n'));
        }

        function printReportById(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // Set current client ID and simulate printing
            currentClientId = report.clientId;
            
            // We need to reload the report modal to print
            // For now, use simplified print
            alert('Opening print preview...');
            editReport(reportId);
            setTimeout(() => {
                printReport();
            }, 1000);
        }

        async function displayFollowUps() {
            const list = document.getElementById('followUpList');
            if (!list) return;

            // Get all reports with follow-up dates
            const reportsWithFollowUp = reports.filter(r => r.followUpDate && r.consultant === currentUser.fullName);
            
            if (reportsWithFollowUp.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìÖ No follow-ups scheduled</h3><p>Follow-ups will appear here once you create reports with follow-up dates.</p></div>';
                return;
            }

            // Sort by follow-up date
            reportsWithFollowUp.sort((a, b) => new Date(a.followUpDate) - new Date(b.followUpDate));

            list.innerHTML = '';
            reportsWithFollowUp.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client) return;

                const followUpDate = new Date(report.followUpDate);
                const today = new Date();
                const daysUntil = Math.ceil((followUpDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = '';
                let statusText = '';
                if (daysUntil < 0) {
                    statusClass = 'overdue';
                    statusText = `Overdue by ${Math.abs(daysUntil)} days`;
                } else if (daysUntil === 0) {
                    statusClass = 'today';
                    statusText = 'Today';
                } else if (daysUntil <= 7) {
                    statusClass = 'upcoming';
                    statusText = `In ${daysUntil} days`;
                } else {
                    statusClass = 'future';
                    statusText = `In ${daysUntil} days`;
                }

                const card = document.createElement('div');
                card.className = `client-card follow-up-card ${statusClass}`;
                card.innerHTML = `
                    <div class="follow-up-header">
                        <h4>${client.fullName}</h4>
                        <span class="follow-up-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="follow-up-details">
                        <p><strong>Follow-up Date:</strong> ${followUpDate.toLocaleDateString('en-GB')}</p>
                        <p><strong>Client:</strong> ${client.fullName} (${client.referenceNumber})</p>
                        <p><strong>Phone:</strong> ${client.phone}</p>
                        <p><strong>Last Visit:</strong> ${new Date(report.timestamp).toLocaleDateString('en-GB')}</p>
                        ${report.followUpNotes ? `<p><strong>Notes:</strong> ${report.followUpNotes}</p>` : ''}
                        <p><strong>Prescription:</strong> ${report.prescription || 'No prescription'}</p>
                    </div>
                    <div class="follow-up-actions">
                        <button class="btn btn-primary" onclick="viewClientDetails('${client.referenceNumber}')">View Client</button>
                        <button class="btn btn-success" onclick="createReport('${client.referenceNumber}')">Create New Report</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function filterFollowUps() {
            const searchDate = document.getElementById('followUpSearch').value;
            if (!searchDate) {
                displayFollowUps();
                return;
            }

            const list = document.getElementById('followUpList');
            const cards = list.querySelectorAll('.follow-up-card');
            
            cards.forEach(card => {
                const dateText = card.querySelector('.follow-up-details p').textContent;
                const cardDate = new Date(dateText.split(': ')[1]).toISOString().split('T')[0];
                card.style.display = cardDate === searchDate ? 'block' : 'none';
            });
        }

        function showAllFollowUps() {
            document.getElementById('followUpSearch').value = '';
            displayFollowUps();
        }

        async function refreshFollowUps() {
            await loadData();
            await displayFollowUps();
        }

        function viewClientDetails(referenceNumber, editMode = false) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a detailed view modal with edit functionality
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.id = 'clientDetailsModal';
            
            const editForm = editMode ? createClientEditForm(client) : createClientViewForm(client);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>${editMode ? 'Edit Client Details' : 'Client Details'} - ${client.referenceNumber}</h2>
                    ${editForm}
                    <div style="text-align: center; margin-top: 20px;">
                        ${editMode ? `
                            <button class="btn btn-success" onclick="saveClientChanges('${client.referenceNumber}')">üíæ Save Changes</button>
                            <button class="btn btn-secondary" onclick="viewClientDetails('${client.referenceNumber}', false)">‚ùå Cancel</button>
                        ` : `
                            <button class="btn btn-warning" onclick="viewClientDetails('${client.referenceNumber}', true)">‚úèÔ∏è Edit Details</button>
                            <button class="btn btn-primary" onclick="printClientDetails('${client.referenceNumber}')">üñ®Ô∏è Print Details</button>
                            <button class="btn" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function createClientViewForm(client) {
            return `
                <div class="client-details-print">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'} years</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Height:</strong> ${client.height || 'Not provided'} cm</div>
                            <div><strong>Weight:</strong> ${client.weight || 'Not provided'} kg</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || 'None')}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branches.find(b => b.id === client.branch)?.name || client.branch}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createClientEditForm(client) {
            return `
                <form id="clientEditForm" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Full Name</label>
                                <input type="text" name="fullName" value="${client.fullName}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Namibian ID Number</label>
                                <input type="text" name="nbNumber" value="${client.nbNumber}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Date of Birth</label>
                                <input type="date" name="dob" value="${client.dob || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" name="age" value="${client.age || ''}" min="1" max="120" readonly>
                            </div>
                            <div class="form-group">
                                <label class="required">Gender</label>
                                <select name="gender" required>
                                    <option value="Male" ${client.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${client.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${client.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Phone</label>
                                <input type="tel" name="phone" value="${client.phone}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" name="email" value="${client.email || ''}">
                            </div>
                            <div class="form-group">
                                <label class="required">Height (cm)</label>
                                <input type="number" name="height" value="${client.height || ''}" min="0" max="300" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Weight (kg)</label>
                                <input type="number" name="weight" value="${client.weight || ''}" min="0" max="500" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-group">
                            <label>Membership Status</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="member" ${client.membershipStatus === 'member' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Registered Member</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="referred" ${client.membershipStatus === 'referred' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Referred by Member</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="memberEditDetails" style="display: ${client.membershipStatus === 'member' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Member ID</label>
                                    <input type="text" name="memberId" value="${client.memberId || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Member Since</label>
                                    <input type="date" name="memberSince" value="${client.memberSince || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div id="referralEditDetails" style="display: ${client.membershipStatus === 'referred' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Referral Name *</label>
                                    <input type="text" name="referralName" value="${client.referralName || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Referral NB Number *</label>
                                    <input type="text" name="referralNbNumber" value="${client.referralNbNumber || ''}" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Primary Reason for Visit</label>
                                <input type="text" name="primaryReason" value="${client.primaryReason}" required>
                            </div>
                            <div class="form-group">
                                <label>Current Medications</label>
                                <textarea name="currentMedications" rows="3">${client.currentMedications || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Allergies</label>
                                <textarea name="allergies" rows="3">${client.allergies || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Medical History</label>
                                <textarea name="medicalHistory" rows="3">${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || '')}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Water Intake</label>
                                <select name="waterIntake">
                                    <option value="">Select...</option>
                                    <option value="Less than 1 liter" ${client.waterIntake === 'Less than 1 liter' ? 'selected' : ''}>Less than 1 liter</option>
                                    <option value="1-2 liters" ${client.waterIntake === '1-2 liters' ? 'selected' : ''}>1-2 liters</option>
                                    <option value="2-3 liters" ${client.waterIntake === '2-3 liters' ? 'selected' : ''}>2-3 liters</option>
                                    <option value="More than 3 liters" ${client.waterIntake === 'More than 3 liters' ? 'selected' : ''}>More than 3 liters</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Exercise Frequency</label>
                                <select name="exerciseFreq">
                                    <option value="">Select...</option>
                                    <option value="Never" ${client.exerciseFreq === 'Never' ? 'selected' : ''}>Never</option>
                                    <option value="1-2 times per week" ${client.exerciseFreq === '1-2 times per week' ? 'selected' : ''}>1-2 times per week</option>
                                    <option value="3-4 times per week" ${client.exerciseFreq === '3-4 times per week' ? 'selected' : ''}>3-4 times per week</option>
                                    <option value="Daily" ${client.exerciseFreq === 'Daily' ? 'selected' : ''}>Daily</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sleep Hours</label>
                                <select name="sleepHours">
                                    <option value="">Select...</option>
                                    <option value="Less than 5 hours" ${client.sleepHours === 'Less than 5 hours' ? 'selected' : ''}>Less than 5 hours</option>
                                    <option value="5-6 hours" ${client.sleepHours === '5-6 hours' ? 'selected' : ''}>5-6 hours</option>
                                    <option value="6-7 hours" ${client.sleepHours === '6-7 hours' ? 'selected' : ''}>6-7 hours</option>
                                    <option value="7-8 hours" ${client.sleepHours === '7-8 hours' ? 'selected' : ''}>7-8 hours</option>
                                    <option value="More than 8 hours" ${client.sleepHours === 'More than 8 hours' ? 'selected' : ''}>More than 8 hours</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stress Level</label>
                                <select name="stressLevel">
                                    <option value="">Select...</option>
                                    <option value="Low" ${client.stressLevel === 'Low' ? 'selected' : ''}>Low</option>
                                    <option value="Moderate" ${client.stressLevel === 'Moderate' ? 'selected' : ''}>Moderate</option>
                                    <option value="High" ${client.stressLevel === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Very High" ${client.stressLevel === 'Very High' ? 'selected' : ''}>Very High</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="form-group">
                            <label>Select Symptoms (Hold Ctrl/Cmd to select multiple)</label>
                            <select name="symptoms" multiple size="6" style="width: 100%;">
                                <option value="Fatigue" ${client.symptoms && client.symptoms.includes('Fatigue') ? 'selected' : ''}>Fatigue</option>
                                <option value="Headaches" ${client.symptoms && client.symptoms.includes('Headaches') ? 'selected' : ''}>Headaches</option>
                                <option value="Digestive Issues" ${client.symptoms && client.symptoms.includes('Digestive Issues') ? 'selected' : ''}>Digestive Issues</option>
                                <option value="Sleep Problems" ${client.symptoms && client.symptoms.includes('Sleep Problems') ? 'selected' : ''}>Sleep Problems</option>
                                <option value="Joint Pain" ${client.symptoms && client.symptoms.includes('Joint Pain') ? 'selected' : ''}>Joint Pain</option>
                                <option value="Skin Issues" ${client.symptoms && client.symptoms.includes('Skin Issues') ? 'selected' : ''}>Skin Issues</option>
                                <option value="Weight Issues" ${client.symptoms && client.symptoms.includes('Weight Issues') ? 'selected' : ''}>Weight Issues</option>
                                <option value="Mood Changes" ${client.symptoms && client.symptoms.includes('Mood Changes') ? 'selected' : ''}>Mood Changes</option>
                                <option value="None" ${client.symptoms && client.symptoms.includes('None') ? 'selected' : ''}>None</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
        }

        function toggleEditMembershipStatus() {
            const memberRadio = document.querySelector('input[name="membershipStatus"][value="member"]');
            const referredRadio = document.querySelector('input[name="membershipStatus"][value="referred"]');
            const memberDetails = document.getElementById('memberEditDetails');
            const referralDetails = document.getElementById('referralEditDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');
            
            if (memberRadio && referredRadio && memberDetails && referralDetails) {
                if (memberRadio.checked) {
                    memberDetails.style.display = 'block';
                    referralDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                } else if (referredRadio.checked) {
                    memberDetails.style.display = 'none';
                    referralDetails.style.display = 'block';
                    if (referralNameInput) referralNameInput.required = true;
                    if (referralNbInput) referralNbInput.required = true;
                }
            }
        }

        async function saveClientChanges(referenceNumber) {
            const form = document.getElementById('clientEditForm');
            if (!form) return;

            const formData = new FormData(form);
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Update client data
            const updatedClient = {
                ...client,
                fullName: formData.get('fullName').trim(),
                nbNumber: formData.get('nbNumber').trim(),
                email: formData.get('email'),
                phone: formData.get('phone'),
                age: formData.get('age'),
                gender: formData.get('gender'),
                membershipStatus: formData.get('membershipStatus'),
                memberId: formData.get('memberId'),
                memberSince: formData.get('memberSince'),
                referralName: formData.get('referralName'),
                referralNbNumber: formData.get('referralNbNumber'),
                primaryReason: formData.get('primaryReason'),
                currentMedications: formData.get('currentMedications'),
                allergies: formData.get('allergies'),
                medicalHistory: formData.get('medicalHistory'),
                waterIntake: formData.get('waterIntake'),
                exerciseFreq: formData.get('exerciseFreq'),
                sleepHours: formData.get('sleepHours'),
                stressLevel: formData.get('stressLevel'),
                symptoms: Array.from(formData.getAll('symptoms')),
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser ? currentUser.fullName : 'Unknown'
            };

            try {
                const result = await apiRequest('/clients', 'PUT', updatedClient);
                if (result.success) {
                    // Update local data
                    const index = clients.findIndex(c => c.referenceNumber === referenceNumber);
                    if (index !== -1) {
                        clients[index] = updatedClient;
                    }
                    
                    // Refresh the display
                    if (currentPortal === 'consultant') {
                        await displayClients();
                    }
                    
                    // Close modal and show success
                    document.getElementById('clientDetailsModal').remove();
                    alert('‚úÖ Client details updated successfully!');
                } else {
                    alert('Error updating client: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating client:', error);
                alert('Error updating client. Please try again.');
            }
        }

        function printClientDetails(referenceNumber) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a print-friendly window
            const printWindow = window.open('', '_blank');
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Client Details - ${client.referenceNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.3;
                            max-width: 21cm;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #c41e3a;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            font-size: 18px;
                            color: #c41e3a;
                            margin-bottom: 5px;
                        }
                        .header h2 {
                            font-size: 14px;
                            color: #333;
                            margin: 5px 0;
                        }
                        .section {
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .section h3 {
                            font-size: 12px;
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid #c41e3a;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        .form-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                        }
                        .symptoms-display {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 5px;
                            margin-top: 5px;
                        }
                        .symptom-tag {
                            background: #e3f2fd;
                            color: #1976d2;
                            padding: 3px 8px;
                            border-radius: 10px;
                            font-size: 9px;
                            font-weight: 500;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Client Registration Details</h2>
                        <p>Branch: ${branchName} | Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Reference Number:</strong> ${client.referenceNumber}</div>
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'}</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${client.medicalHistory || 'None'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branchName}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function createReport(refNum) {
            currentClientId = refNum;
            const client = clients.find(c => c.referenceNumber === refNum);
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Clear editing flag (we're creating a new report, not editing)
            window.editingReportId = null;
            
            // Fill prescription modal
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            // Display symptoms
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            // Health Assessment
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list
            loadMedicineList();
            
            // Set consultant signature name and contact info
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            // Set default follow-up date (2 weeks from now)
            const followUpDate = new Date();
            followUpDate.setDate(followUpDate.getDate() + 14);
            document.getElementById('followUpDate').value = followUpDate.toISOString().split('T')[0];
            
            // Update follow-up date display
            updateFollowUpDisplay();
            
            // Setup event listener for follow-up date
            setupFollowUpListener();
            
            // Update prescription display
            updatePrescriptionDisplay();
            
            // Update notes display
            updateNotesDisplay();
            
            // Generate recommendations based on symptoms and health data
            generateRecommendations(client);
            
            // Initialize body systems selector
            initializeBodySystems();
            
            document.getElementById('reportModal').style.display = 'block';
        }

        // Body Systems and Lifestyle Recommendations Database
        const BODY_SYSTEMS_DATABASE = {
            'Nervous System': {
                symptoms: {
                    'Headaches and dizziness': 'Practice stress-management techniques like meditation, prayer, or deep breathing.',
                    'Insomnia or restless sleep': 'Maintain a regular sleep routine (7‚Äì8 hours daily).',
                    'Poor concentration and memory loss': 'Take short breaks from screens to rest the mind and eat foods rich in B-vitamins, omega-3, and magnesium (e.g., fish, nuts, leafy greens).'
                }
            },
            'Cardiovascular System': {
                symptoms: {
                    'Palpitations or irregular heartbeat': 'Practice relaxation techniques to reduce stress-induced hypertension and engage in light aerobic exercise.',
                    'Shortness of breath': 'Engage in aerobic exercise (walking, swimming, cycling) for at least 30 minutes, 4‚Äì5 times weekly.',
                    'Cold hands and feet or fatigue': 'Eat a balanced diet rich in fruits, vegetables, and healthy fats (olive oil, avocados) to improve circulation.'
                }
            },
            'Digestive System': {
                symptoms: {
                    'Bloating and indigestion': 'Eat meals on time and chew slowly to aid digestion.',
                    'Constipation or diarrhea': 'Increase fiber and water intake; reduce processed foods.',
                    'Loss of appetite or heartburn': 'Avoid late-night eating and use probiotic-rich foods (yogurt, fermented vegetables) to maintain gut health.'
                }
            },
            'Respiratory System': {
                symptoms: {
                    'Frequent cough or shortness of breath': 'Practice deep breathing exercises and outdoor walks in clean air.',
                    'Chest tightness': 'Avoid smoking and dusty environments; keep indoor air fresh with plants or ventilation.',
                    'Low lung endurance': 'Strengthen lungs through light aerobic activity or yoga.'
                }
            },
            'Immune System': {
                symptoms: {
                    'Frequent colds or infections': 'Eat immune-boosting foods (citrus fruits, garlic, mushrooms) and sleep adequately.',
                    'Slow wound healing': 'Maintain personal hygiene, stay hydrated, and ensure adequate rest.',
                    'Allergic reactions or fatigue': 'Exercise moderately to stimulate immune response and avoid chronic stress.'
                }
            },
            'Endocrine System': {
                symptoms: {
                    'Weight fluctuations': 'Keep consistent sleep and meal times to stabilize hormones and engage in regular moderate exercise.',
                    'Mood swings or irritability': 'Reduce sugar, alcohol, and processed food intake to balance hormones.',
                    'Irregular menstruation or libido changes': 'Consume hormone-supportive foods like soy, flaxseed, and whole grains.'
                }
            },
            'Musculoskeletal System': {
                symptoms: {
                    'Muscle stiffness or pain': 'Stretch daily and maintain good posture throughout the day.',
                    'Joint aches': 'Engage in strength and flexibility training with adequate calcium, magnesium, and vitamin D intake.',
                    'Back or neck discomfort': 'Avoid prolonged sitting ‚Äî stand or walk every hour and maintain proper posture.'
                }
            },
            'Urinary System': {
                symptoms: {
                    'Frequent urination or urgency': 'Limit salt and caffeine intake; avoid holding urine for long periods.',
                    'Lower back pain': 'Drink 1.5‚Äì2 liters of water daily to flush toxins and maintain kidney health.',
                    'Swelling in legs or feet': 'Limit salt intake, stay hydrated, and elevate legs when resting.'
                }
            },
            'Reproductive System': {
                symptoms: {
                    'Reduced sexual desire': 'Eat zinc- and vitamin E-rich foods (nuts, seeds, eggs) and manage stress through proper rest.',
                    'Irregular cycles or erectile issues': 'Exercise to improve circulation and avoid excessive alcohol, smoking, and processed fats.',
                    'Hormonal imbalances': 'Ensure proper rest, eat hormone-supportive foods, and maintain a regular exercise routine.'
                }
            },
            'Integumentary System (Skin, Hair, Nails)': {
                symptoms: {
                    'Dry or dull skin': 'Drink plenty of water and consume antioxidant-rich foods (berries, green tea).',
                    'Hair loss or brittleness': 'Get enough sleep to support skin and hair repair, and ensure adequate protein intake.',
                    'Acne or skin sensitivity': 'Keep the skin clean and moisturized; avoid excessive sun exposure and use natural skincare.'
                }
            },
            'Lymphatic System': {
                symptoms: {
                    'Swollen lymph nodes': 'Engage in light exercise and massage to improve lymph circulation.',
                    'Puffy face or limbs': 'Stay hydrated, avoid heavy oily foods, and include detoxifying foods like lemon and ginger.',
                    'Chronic fatigue': 'Maintain proper posture, avoid tight clothing that blocks flow, and get adequate rest.'
                }
            },
            'Sensory System (Eyes, Ears, Nose)': {
                symptoms: {
                    'Eye fatigue or blurred vision': 'Take screen breaks every 30‚Äì40 minutes and do simple eye relaxation exercises (palming, distant focusing).',
                    'Ringing in the ears (tinnitus)': 'Avoid loud noise exposure, maintain ear hygiene, and ensure adequate magnesium intake.',
                    'Sensitivity to light or sound': 'Maintain good lighting while working or reading and eat foods rich in vitamin A and lutein (carrots, spinach).'
                }
            }
        };

        function initializeBodySystems() {
            const container = document.getElementById('bodySystemsSelector');
            let html = '';
            
            Object.keys(BODY_SYSTEMS_DATABASE).forEach((systemName, index) => {
                const system = BODY_SYSTEMS_DATABASE[systemName];
                const systemId = systemName.replace(/[^a-zA-Z0-9]/g, '_');
                
                html += `
                    <div class="body-system-card" style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleSystemSymptoms('${systemId}')">
                            <input type="checkbox" id="system_${systemId}" onchange="handleSystemSelection('${systemId}')" 
                                   style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                            <h4 style="color: #2196f3; margin: 0; flex: 1; font-size: 1.1rem;">${systemName}</h4>
                            <span id="toggle_${systemId}" style="font-size: 1.2rem; color: #2196f3;">‚ñº</span>
                        </div>
                        
                        <div id="symptoms_${systemId}" style="display: none; margin-top: 10px; padding-left: 30px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 8px; font-weight: 600;">Common Symptoms:</p>
                            ${Object.keys(system.symptoms).map((symptom, i) => `
                                <label style="display: block; padding: 5px 0; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" class="symptom-checkbox" data-system="${systemId}" data-symptom="${symptom.replace(/"/g, '&quot;')}"
                                           onchange="handleSymptomSelection()" style="margin-right: 8px;">
                                    ${symptom}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleSystemSymptoms(systemId) {
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const toggleIcon = document.getElementById(`toggle_${systemId}`);
            
            if (symptomsDiv.style.display === 'none') {
                symptomsDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                symptomsDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function handleSystemSelection(systemId) {
            const checkbox = document.getElementById(`system_${systemId}`);
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const symptomCheckboxes = symptomsDiv.querySelectorAll('.symptom-checkbox');
            
            if (checkbox.checked) {
                // Expand symptoms
                symptomsDiv.style.display = 'block';
                document.getElementById(`toggle_${systemId}`).textContent = '‚ñ≤';
            } else {
                // Uncheck all symptoms
                symptomCheckboxes.forEach(cb => cb.checked = false);
            }
            
            handleSymptomSelection();
        }

        function handleSymptomSelection() {
            const selectedSymptoms = [];
            const recommendationsDiv = document.getElementById('lifestyleRecommendations');
            
            // Find all checked symptoms with their data
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const systemId = checkbox.dataset.system;
                const symptomName = checkbox.dataset.symptom;
                
                // Find the original system name
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName) {
                    const system = BODY_SYSTEMS_DATABASE[systemName];
                    const recommendation = system.symptoms[symptomName];
                    
                    if (recommendation) {
                        selectedSymptoms.push({
                            system: systemName,
                            symptom: symptomName,
                            recommendation: recommendation
                        });
                    }
                }
            });
            
            if (selectedSymptoms.length === 0) {
                recommendationsDiv.style.display = 'none';
                return;
            }
            
            // Display recommendations - one per symptom
            let html = '<h4 style="color: #2196f3; margin-bottom: 20px; font-size: 1.2rem;">üìã Healthy Lifestyle Recommendations</h4>';
            html += '<div style="display: grid; gap: 12px;">';
            
            selectedSymptoms.forEach((item, index) => {
                html += `
                    <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 1.2rem; color: #2196f3;">‚úì</span>
                            <div style="flex: 1;">
                                <strong style="color: #1976d2; font-size: 0.95rem;">${item.symptom}</strong>
                                <span style="color: #666; font-size: 0.85rem; margin-left: 8px;">(${item.system})</span>
                                <p style="margin: 5px 0 0 0; color: #555; line-height: 1.5; font-size: 0.9rem;">${item.recommendation}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            recommendationsDiv.innerHTML = html;
            recommendationsDiv.style.display = 'block';
        }

        // Symptom-to-Medicine Recommendation Database
        const RECOMMENDATION_DATABASE = {
            // Symptoms mapping
            symptoms: {
                fatigue: ['Spirulina Tabs', 'Dyna Tonic 780ml', 'Bee Pollen Capsule 100\'s', 'Ginseng Capsule', 'Yeeginako Tabs'],
                headache: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Nutmeg Ointment'],
                nausea: ['Ginger capsule', 'Soybean & Ginger', 'Noni 1 Ltr', 'Spirulina Tabs'],
                dizziness: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                shortness_breath: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Ginkgo & Ginseng - C'],
                blurred_vision: ['Ginkgo & Ginseng - C', 'Dyna C- 150\'s', 'Spirulina Tabs'],
                joint_pain: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Dyna \'S\' Tablet 120\'s', 'Sea Cucumber 500ml'],
                cough: ['Dyna Tonic 780ml', 'Noni 1 Ltr', 'Spirulina Tabs'],
                digestive_issues: ['Spirulina Tabs', 'Pro LSB', 'Gastritus Package', 'High Fiber'],
                loss_appetite: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml'],
                fever: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Noni 1 Ltr'],
                sore_throat: ['Ganoderma Toothpaste', 'Noni 1 Ltr', 'Dyna C- 150\'s'],
                skin_rash: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s'],
                chest_pain: ['Ginkgo & Ginseng - C', 'Blood Circulation Package', 'Noni 1 Ltr'],
                lower_back: ['Nutmeg Ointment', 'Healthy Joints Pack', 'Sea Cucumber 500ml'],
                weight_changes: ['Diet & Weight Management Pack', 'Spirulina Tabs', 'High Fiber'],
                insomnia: ['Gano & Green Tea - C', 'Spirulina Tabs', 'Maharani'],
                confusion: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                foot_edema: ['Blood Circulation Package', 'Spirulina Tabs'],
                swelling: ['Blood Circulation Package', 'Spirulina Tabs', 'Sea Cucumber 500ml']
            },
            // Medical history mapping
            medicalHistory: {
                highBloodPressure: ['Blood Circulation Package', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Noni 1 Ltr'],
                diabetes: ['Spirulina Tabs', 'Noni 1 Ltr', 'Bitter Gourd Tea', 'Balanced Body System Package'],
                heartDisease: ['Blood Circulation Package', 'Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Noni 1 Ltr'],
                asthma: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Noni 1 Ltr'],
                digestiveDisorders: ['Gastritus Package', 'Spirulina Tabs', 'Pro LSB', 'High Fiber'],
                thyroid: ['Spirulina Tabs', 'Balanced Body System Package', 'Sea Cucumber 500ml'],
                kidneyLiver: ['Cleansing & Detoxification Package', 'Spirulina Tabs', 'Milk Thistle Tablet 120\'s'],
                chronicFatigue: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml', 'Ginseng Capsule'],
                arthritis: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Sea Cucumber 500ml', 'Spirulina Tabs'],
                skinConditions: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s', 'Cleansing & Detoxification Package'],
                mentalHealth: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                autoimmune: ['Spirulina Tabs', 'Balanced Body System Package', 'Noni 1 Ltr'],
                cancer: ['Spirulina Tabs', 'Noni 1 Ltr', 'Total Health Pack']
            },
            // Gender-specific
            gender: {
                female: ['Women\'s Package', 'Kacip Fatimah', 'Collagen & Kacip- C', 'Maharani'],
                male: ['Men\'s Package', 'Tongkat Ali & Maca - C', 'Dyna Serenoa Tablet 100\'s']
            },
            // Lifestyle factors
            lifestyle: {
                poorSleep: ['Gano & Green Tea - C', 'Maharani', 'Spirulina Tabs'],
                highStress: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                lowExercise: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Total Health Pack'],
                poorWater: ['High Fiber', 'Spirulina Tabs']
            },
            // Age-based
            age: {
                elderly: ['Elderly Package (Female)', 'Elderly Package (Male)', 'Spirulina Tabs', 'Ginkgo & Ginseng - C']
            },
            // General wellness
            general: ['Spirulina Tabs', 'Dyna C- 150\'s', 'Bee Pollen Capsule 100\'s']
        };

        function generateRecommendations(client) {
            const recommendations = new Set();
            const reasonsMap = new Map();
            
            // Helper function to add recommendation with reason
            const addRecommendation = (medicine, reason) => {
                recommendations.add(medicine);
                if (!reasonsMap.has(medicine)) {
                    reasonsMap.set(medicine, []);
                }
                reasonsMap.get(medicine).push(reason);
            };
            
            // Check symptoms
            if (client.symptoms && client.symptoms.length > 0) {
                client.symptoms.forEach(symptom => {
                    if (symptom !== 'none' && RECOMMENDATION_DATABASE.symptoms[symptom]) {
                        RECOMMENDATION_DATABASE.symptoms[symptom].forEach(med => {
                            addRecommendation(med, `Symptom: ${symptom.replace(/_/g, ' ')}`);
                        });
                    }
                });
            }
            
            // Check medical history
            if (client.medicalHistory && Array.isArray(client.medicalHistory)) {
                client.medicalHistory.forEach(condition => {
                    if (condition !== 'na' && RECOMMENDATION_DATABASE.medicalHistory[condition]) {
                        RECOMMENDATION_DATABASE.medicalHistory[condition].forEach(med => {
                            addRecommendation(med, `Medical History: ${condition.replace(/([A-Z])/g, ' $1').trim()}`);
                        });
                    }
                });
            }
            
            // Check gender-specific
            const gender = client.gender ? client.gender.toLowerCase() : '';
            if (gender && RECOMMENDATION_DATABASE.gender[gender]) {
                RECOMMENDATION_DATABASE.gender[gender].forEach(med => {
                    addRecommendation(med, `Gender-specific (${gender})`);
                });
            }
            
            // Check lifestyle factors
            if (client.sleepHours === '<5' || client.sleepHours === '5-6') {
                RECOMMENDATION_DATABASE.lifestyle.poorSleep.forEach(med => {
                    addRecommendation(med, 'Poor sleep quality');
                });
            }
            
            if (parseInt(client.stressLevel) >= 7) {
                RECOMMENDATION_DATABASE.lifestyle.highStress.forEach(med => {
                    addRecommendation(med, 'High stress level');
                });
            }
            
            if (client.exerciseFreq === 'never' || client.exerciseFreq === '1-2') {
                RECOMMENDATION_DATABASE.lifestyle.lowExercise.forEach(med => {
                    addRecommendation(med, 'Low physical activity');
                });
            }
            
            if (client.waterIntake === 'less1') {
                RECOMMENDATION_DATABASE.lifestyle.poorWater.forEach(med => {
                    addRecommendation(med, 'Low water intake');
                });
            }
            
            // Check age (elderly 60+)
            if (client.age && parseInt(client.age) >= 60) {
                const elderlyPackage = gender === 'female' ? 'Elderly Package (Female)' : 'Elderly Package (Male)';
                addRecommendation(elderlyPackage, 'Age 60+');
                RECOMMENDATION_DATABASE.age.elderly.forEach(med => {
                    if (med !== elderlyPackage) {
                        addRecommendation(med, 'Age-appropriate');
                    }
                });
            }
            
            // If no specific recommendations, add general wellness
            if (recommendations.size === 0) {
                RECOMMENDATION_DATABASE.general.forEach(med => {
                    addRecommendation(med, 'General wellness');
                });
            }
            
            // Display recommendations
            displayRecommendations(Array.from(recommendations), reasonsMap);
        }

        function displayRecommendations(recommendations, reasonsMap) {
            const display = document.getElementById('recommendationsDisplay');
            
            if (recommendations.length === 0) {
                display.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">No specific recommendations available.</p>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üìã Recommended Products (${recommendations.length})</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                        Click on any product to select it, or use "Apply All" button below to select all recommendations.
                    </p>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            recommendations.forEach((medicine, index) => {
                const reasons = reasonsMap.get(medicine) || [];
                const uniqueReasons = [...new Set(reasons)];
                
                html += `
                    <div class="recommendation-item" style="background: #f0fff4; border: 2px solid #27ae60; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;" 
                         onclick="selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')"
                         onmouseover="this.style.background='#d4edda'; this.style.transform='scale(1.02)'"
                         onmouseout="this.style.background='#f0fff4'; this.style.transform='scale(1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: #27ae60; font-size: 1.05rem;">‚úì ${medicine}</strong>
                                <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                    ${uniqueReasons.map(reason => `<span style="background: #fff; padding: 2px 8px; border-radius: 10px; margin-right: 5px; display: inline-block; margin-top: 3px; border: 1px solid #ddd;">üéØ ${reason}</span>`).join('')}
                                </div>
                            </div>
                            <button class="btn btn-success" style="padding: 5px 15px; font-size: 0.85rem; margin-left: 10px;" 
                                    onclick="event.stopPropagation(); selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')">
                                Add
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            display.innerHTML = html;
            
            // Store recommendations for "Apply All" functionality
            window.currentRecommendations = recommendations;
        }

        function selectRecommendedMedicine(medicineName) {
            // Find the checkbox for this medicine in the medicine grid
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === medicineName && !cb.checked) {
                    cb.checked = true;
                }
            });
            updatePrescriptionDisplay();
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Added';
            btn.style.background = '#2ecc71';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function applyRecommendations() {
            if (!window.currentRecommendations || window.currentRecommendations.length === 0) {
                alert('No recommendations available.');
                return;
            }
            
            // Select all recommended medicines
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            let appliedCount = 0;
            
            window.currentRecommendations.forEach(medicine => {
                checkboxes.forEach(cb => {
                    if (cb.value === medicine && !cb.checked) {
                        cb.checked = true;
                        appliedCount++;
                    }
                });
            });
            
            updatePrescriptionDisplay();
            alert(`‚úÖ Applied ${appliedCount} recommended products to prescription!`);
        }

        // DYNAPHARM NAMIBIA SPECIAL PACKAGE 2025 - Official Package Database
        PACKAGE_DATABASE = window.PACKAGE_DATABASE = {
            'Gastric Package': {
                price: { dp: 2054, cp: 2432, bv: 381 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'PRO-LSB TABLET 150\'s', quantity: 1, dp: 455, cp: 573, bv: 100 },
                    { name: 'INSTANT GINSENG HONEY GINGER 500g', quantity: 1, dp: 350, cp: 455, bv: 43 },
                    { name: 'GOAT\'S MILK TABLET 150\'s', quantity: 1, dp: 286, cp: 372, bv: 48 }
                ]
            },
            'Womens Package': {
                price: { dp: 2543, cp: 2950, bv: 481 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'HERBA WARISAN MAHARANI 6 x 10g', quantity: 1, dp: 520, cp: 620, bv: 110 },
                    { name: 'INSTANT COFFEE MIX W/GANO, COLLAGEN & KACIP 15\'s', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'GAMAT FEMININE WASH (2)', quantity: 1, dp: 200, cp: 260, bv: 23 }
                ]
            },
            'Mens Health Package': {
                price: { dp: 2033, cp: 2362, bv: 388 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Blood Circulation Pack': {
                price: { dp: 3290, cp: 3854, bv: 657 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 }
                ]
            },
            'Elderly Package (Female)': {
                price: { dp: 3801, cp: 4475, bv: 779.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'PROLINK 20\'s x20g', quantity: 1, dp: 588, cp: 688, bv: 135 }
                ]
            },
            'Elderly Package (Male)': {
                price: { dp: 3263, cp: 3883, bv: 663 },
                products: [
                    { name: 'INSTANT COFFEE MIX W/GINKGO & GINSENG 20\'s x21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 }
                ]
            },
            'Total Health Pack': {
                price: { dp: 2570, cp: 2985, bv: 515 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 }
                ]
            },
            'Balanced Body System Pack': {
                price: { dp: 3846, cp: 4446, bv: 835 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'PROLINK 30\'s x20g', quantity: 1, dp: 600, cp: 719, bv: 170 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 }
                ]
            },
            'Cleansing And Detoxification Package': {
                price: { dp: 2183, cp: 2596, bv: 447 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 43 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 }
                ]
            },
            'Weight Management Pack': {
                price: { dp: 2283, cp: 2680, bv: 448 },
                products: [
                    { name: 'GREEN TEA EXTRACT CAPSULE 60\'s', quantity: 1, dp: 344, cp: 430, bv: 85 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 65 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'HIGH FIBER NUTRION FOOD 30\'s x25g', quantity: 1, dp: 660, cp: 780, bv: 120 },
                    { name: 'INSTANT COFFEE MIX W/ GANO & GREEN TEA 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Healthy Joints Package': {
                price: { dp: 3538, cp: 4177, bv: 687.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'D I INSTANT GOAT MILK POWDER PREMIX 20\'s x 21g', quantity: 1, dp: 325, cp: 400, bv: 43 }
                ]
            }
        };

        // Individual product prices (for when sold separately)
        // Get individual products from PRICE_LIST
        const INDIVIDUAL_PRODUCTS = PRICE_LIST.map(item => item.description);

        function loadMedicineList() {
            const packages = Object.keys(PACKAGE_DATABASE);
            const grid = document.getElementById('medicineGrid');
            
            let html = '';
            let itemIndex = 0;
            
            // First, add packages
            packages.forEach(packageName => {
                const packageInfo = PACKAGE_DATABASE[packageName];
                html += `
                    <div class="medicine-item package-item" style="background: #e8f5e9; border-left: 4px solid #27ae60; padding: 12px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${packageName}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}" style="font-weight: bold; color: #27ae60;">
                            üì¶ ${packageName}
                            <br><small style="color: #666; font-weight: normal;">
                                Package (${packageInfo.products.length} products) - DP: N$${packageInfo.price.dp} | CP: N$${packageInfo.price.cp} | BV: ${packageInfo.price.bv}
                                <br><span style="font-size: 0.75rem; color: #888;">Contains: ${packageInfo.products.map(p => `${p.name} (Qty: ${p.quantity})`).join(', ')}</span>
                            </small>
                        </label>
                </div>
                `;
                itemIndex++;
            });
            
            // Then, add individual products from PRICE_LIST
            PRICE_LIST.forEach(product => {
                html += `
                    <div class="medicine-item individual-item" style="padding: 10px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${product.description}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}">
                            ${product.description}
                            <br><small style="color: #666; font-size: 0.85rem;">
                                DP: N$${product.dp} | CP: N$${product.cp} | BV: ${product.bv}
                            </small>
                        </label>
                    </div>
                `;
                itemIndex++;
            });
            
            grid.innerHTML = html;
        }

        function handlePDF(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPDF = {
                        name: file.name,
                        data: e.target.result
                    };
                    document.getElementById('pdfStatus').textContent = `Ready: ${file.name}`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveReport() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push({ name: cb.value, dispensed: false });
            });
            
            if (selectedMeds.length === 0) {
                alert('Please select at least one medicine!');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === currentClientId);
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Check if we're editing an existing report
            const isEditing = window.editingReportId;
            const existingReport = isEditing ? reports.find(r => r.id === window.editingReportId) : null;
            
            // If editing, preserve dispensed status and payment info for existing medicines
            let finalMedicines = selectedMeds;
            if (isEditing && existingReport && existingReport.medicines) {
                finalMedicines = selectedMeds.map(newMed => {
                    const existingMed = existingReport.medicines.find(m => m.name === newMed.name);
                    if (existingMed) {
                        // Preserve dispensed and payment status
                        return {
                            name: newMed.name,
                            dispensed: existingMed.dispensed || false,
                            paid: existingMed.paid || false,
                            dispensedBy: existingMed.dispensedBy,
                            dispensedAt: existingMed.dispensedAt,
                            paidBy: existingMed.paidBy,
                            paidAt: existingMed.paidAt
                        };
                    }
                    return newMed;
                });
            }
            
            const report = {
                id: isEditing ? window.editingReportId : 'RPT' + Date.now(),
                clientId: currentClientId,
                clientInfo: {
                    fullName: client.fullName,
                    phone: client.phone,
                    email: client.email,
                    nbNumber: client.nbNumber
                },
                consultant: currentUser.fullName,
                consultantInfo: {
                    fullName: currentUser.fullName,
                    email: currentUser.email,
                    phone: currentUser.phone
                },
                notes: document.getElementById('consultantNotes').value,
                prescription: finalMedicines.map(med => med.name).join(', '),
                medicines: finalMedicines,
                symptoms: selectedSymptoms,
                followUpDate: document.getElementById('followUpDate').value,
                followUpNotes: document.getElementById('followUpNotes').value,
                pdf: uploadedPDF,
                timestamp: isEditing ? existingReport.timestamp : new Date().toISOString(),
                lastModified: isEditing ? new Date().toISOString() : undefined,
                dispensed: isEditing ? existingReport.dispensed : false
            };
            
            // Validate and update pricing for the report
            const validatedReport = validateReportPricing(report);
            
            try {
                // Use PUT for editing, POST for new reports
                const method = isEditing ? 'PUT' : 'POST';
                const result = await apiRequest('/reports', method, validatedReport);
                
                if (result.success) {
                    if (isEditing) {
                        // Update existing report in local array
                        const index = reports.findIndex(r => r.id === validatedReport.id);
                        if (index !== -1) {
                            reports[index] = validatedReport;
                        }
                        alert('‚úÖ Report updated successfully! ID: ' + validatedReport.id);
                    } else {
                        // Add new report to local array
                        reports.push(validatedReport);
                        alert('‚úÖ Report created successfully! ID: ' + validatedReport.id);
                    }
                    
                    // Clear editing flag
                    window.editingReportId = null;
                    
            closeModal('reportModal');
            document.getElementById('consultantNotes').value = '';
                    document.getElementById('followUpDate').value = '';
                    document.getElementById('followUpNotes').value = '';
            uploadedPDF = null;
            document.getElementById('pdfStatus').textContent = '';
                    
                    // Clear medicine selections
                    document.querySelectorAll('#medicineGrid input:checked').forEach(cb => cb.checked = false);
                    
                    // Refresh consultant data
                    await refreshConsultantData();
                } else {
                    alert('Error saving report: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Error saving report. Please try again.');
            }
        }

        function updateFollowUpDisplay() {
            const followUpDate = document.getElementById('followUpDate').value;
            const displayElement = document.getElementById('followUpDateDisplay');
            if (followUpDate) {
                const date = new Date(followUpDate);
                displayElement.textContent = date.toLocaleDateString('en-GB');
            } else {
                displayElement.textContent = '________________';
            }
        }

        // Add event listener for follow-up date changes when modal opens
        function setupFollowUpListener() {
            const followUpDateInput = document.getElementById('followUpDate');
            if (followUpDateInput) {
                followUpDateInput.addEventListener('change', updateFollowUpDisplay);
            }
        }

        function printReport() {
            const client = clients.find(c => c.referenceNumber === currentClientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Get consultant notes and follow-up
            const consultantNotes = document.getElementById('consultantNotes').value;
            const followUpDate = document.getElementById('followUpDate').value;
            const followUpNotes = document.getElementById('followUpNotes').value;
            
            // Get branch name and address
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            const branchAddress = branches.find(b => b.id === client.branch)?.address || 'Namibia';
            
            // Create professional print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Summary Analytic Report Card - ${client.fullName}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 9pt;
                            line-height: 1.3;
                            color: #333;
                            padding: 12mm 15mm;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 12px 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 12px;
                        }
                        
                        .header h1 {
                            font-size: 18pt;
                            margin-bottom: 5px;
                            font-weight: 900;
                            letter-spacing: 1px;
                        }
                        
                        .header .subtitle {
                            font-size: 12pt;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .header .branch-info {
                            font-size: 10pt;
                            margin: 2px 0;
                            opacity: 0.95;
                        }
                        
                        .header .report-date {
                            font-size: 9pt;
                            margin-top: 8px;
                            opacity: 0.9;
                        }
                        
                        .section {
                            margin-bottom: 8px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .section.allow-break {
                            page-break-inside: auto;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 6px 12px;
                            font-size: 11pt;
                            font-weight: bold;
                            border-radius: 4px;
                            margin-bottom: 6px;
                            text-align: center;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 6px 15px;
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 9pt;
                            line-height: 1.3;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 80px;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item {
                            background: #e3f2fd;
                            padding: 6px 10px;
                            border-radius: 4px;
                            margin-bottom: 5px;
                            border-left: 4px solid #2196f3;
                            font-size: 9pt;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .symptom-item strong {
                            color: #1976d2;
                            display: inline;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item p {
                            color: #555;
                            line-height: 1.4;
                            display: inline;
                            margin-left: 8px;
                        }
                        
                        .recommendation-item {
                            background: white;
                            padding: 5px 8px;
                            border-radius: 3px;
                            border-left: 3px solid #4caf50;
                            margin-bottom: 6px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .medicine-list {
                            background: #e8f5e9;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #27ae60;
                        }
                        
                        .medicine-list ul {
                            list-style: none;
                            padding: 0;
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 4px;
                        }
                        
                        .medicine-list li {
                            padding: 4px 8px;
                            background: white;
                            border-radius: 3px;
                            font-size: 9pt;
                            border-left: 3px solid #27ae60;
                            line-height: 1.3;
                            font-weight: 500;
                        }
                        
                        .notes-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #ffc107;
                            font-size: 9pt;
                            line-height: 1.4;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .footer {
                            margin-top: 12px;
                            padding-top: 10px;
                            border-top: 3px solid #c41e3a;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            page-break-inside: avoid;
                        }
                        
                        .signature-box {
                            text-align: center;
                            font-size: 9pt;
                        }
                        
                        .signature-line {
                            border-bottom: 2px solid #333;
                            margin: 25px 0 6px 0;
                        }
                        
                        .signature-box strong {
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #2196f3;
                            font-size: 9pt;
                        }
                        
                        .follow-up-box strong {
                            color: #1976d2;
                            display: block;
                            margin-bottom: 5px;
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box p {
                            margin: 3px 0;
                            line-height: 1.4;
                        }
                        
                        .summary-footer {
                            text-align: center;
                            margin-top: 15px;
                            padding: 12px;
                            background: #f0f0f0;
                            border-radius: 6px;
                            border: 2px solid #c41e3a;
                            font-size: 9pt;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        .page-limit-warning {
                            text-align: center;
                            margin-top: 10px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            font-size: 8pt;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                            
                            .page-limit-warning {
                                page-break-before: avoid;
                            }
                            
                            .section.allow-break {
                                page-break-inside: auto;
                            }
                            
                            .recommendation-item {
                                page-break-inside: avoid;
                                orphans: 2;
                                widows: 2;
                            }
                            
                            h1, h2, h3, h4, .section-title {
                                page-break-after: avoid;
                                orphans: 3;
                                widows: 3;
                            }
                            
                            * {
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <div class="subtitle">SUMMARY ANALYTIC REPORT CARD</div>
                        <div class="branch-info">${branchName}</div>
                        <div class="branch-info">${branchAddress}</div>
                        <div class="report-date">Report Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="section">
                        <div class="section-title">üìã CLIENT INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${client.fullName}</div>
                            <div class="info-item"><strong>Reference:</strong> ${client.referenceNumber}</div>
                            <div class="info-item"><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div class="info-item"><strong>Age:</strong> ${client.age || 'N/A'} years</div>
                            <div class="info-item"><strong>Gender:</strong> ${client.gender}</div>
                            <div class="info-item"><strong>Phone:</strong> ${client.phone}</div>
                            <div class="info-item"><strong>Height:</strong> ${client.height}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${client.weight}kg</div>
                            <div class="info-item"><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${client.memberId || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${client.referralName || 'N/A'}</div>
                                <div class="info-item"><strong>Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Symptoms & Recommendations -->
                    ${selectedSymptoms.length > 0 ? `
                    <div class="section">
                        <div class="section-title">ü©∫ SUB-HEALTH TRENDS</div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 2px solid #2196f3; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.map(item => `
                                <div style="margin-bottom: 5px; padding: 3px 6px; background: white; border-radius: 3px; border-left: 3px solid #2196f3; display: inline-block; margin-right: 5px;">
                                    <strong>${item.symptom}</strong> (${item.system})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Lifestyle Recommendations -->
                    <div class="section allow-break">
                        <div class="section-title">üåø LIFESTYLE RECOMMENDATIONS</div>
                        <div style="background: #f0f8f0; padding: 10px; border-radius: 4px; border: 2px solid #4caf50; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.length > 0 ? `
                                ${selectedSymptoms.map(item => `
                                    <div class="recommendation-item">
                                        <strong style="color: #2e7d32;">‚úì ${item.symptom}:</strong>
                                        <span style="color: #555;">${item.recommendation}</span>
                                    </div>
                                `).join('')}
                            ` : `
                                <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                    <p>üìã <strong>No specific symptoms selected</strong></p>
                                    <p style="font-size: 8pt; margin-top: 5px;">To view personalized lifestyle recommendations, please select symptoms from the body systems above before printing this report.</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Prescribed Products -->
                    ${selectedMeds.length > 0 ? `
                    <div class="section">
                        <div class="section-title">üíä PRESCRIBED PRODUCTS</div>
                        <div class="medicine-list">
                            <ul>
                                ${selectedMeds.map(med => `<li>‚úì ${med}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Consultant Notes -->
                    ${consultantNotes.trim() ? `
                    <div class="section">
                        <div class="section-title">üìù CONSULTANT'S DIAGNOSIS & NOTES</div>
                        <div class="notes-box">${consultantNotes}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Follow-up & Signature -->
                    <div class="footer">
                        <div>
                            ${followUpDate ? `
                            <div class="follow-up-box">
                                <strong>üìÖ FOLLOW-UP APPOINTMENT</strong>
                                <p><strong>Date:</strong> ${new Date(followUpDate).toLocaleDateString('en-GB')}</p>
                                ${followUpNotes ? `<p><strong>Notes:</strong> ${followUpNotes}</p>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <strong>${currentUser.fullName}</strong>
                            <p>Certified Consultant</p>
                            <p style="font-size: 8pt;">Tel: ${currentUser.phone || '061-300877'}</p>
                            <p style="font-size: 8pt;">Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
                        </div>
                    </div>
                    
                    <!-- Summary Report Card Disclaimer -->
                    <div class="summary-footer">
                        <p>üìã THIS IS A SUMMARY REPORT CARD</p>
                        <p>For detailed analysis and comprehensive information, please refer to the complete Analysis Report Card</p>
                    </div>
                    
                    <!-- Dynapharm Motto -->
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 2px solid #c41e3a;">
                        <div style="font-size: 12pt; color: #c41e3a; font-weight: bold; letter-spacing: 1px;">
                            HEALTH | WEALTH | FREEDOM
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function updatePrescriptionDisplay() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Update the prescription display
            const prescriptionDisplay = document.getElementById('prescriptionDisplay');
            if (prescriptionDisplay) {
                if (selectedMeds.length > 0) {
                    prescriptionDisplay.innerHTML = `
                        <div class="selected-medicines">
                            <h4>Prescribed Medicines:</h4>
                            <ul>
                                ${selectedMeds.map(med => `<li>${med}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    prescriptionDisplay.innerHTML = '<p>No medicines selected</p>';
                }
            }
        }

        function updateNotesDisplay() {
            const notes = document.getElementById('consultantNotes').value;
            const notesDisplay = document.getElementById('notesDisplay');
            if (notesDisplay) {
                if (notes.trim()) {
                    notesDisplay.innerHTML = `
                        <div class="notes-preview">
                            <h4>Diagnosis & Treatment Notes:</h4>
                            <div class="notes-content">${notes}</div>
                        </div>
                    `;
                } else {
                    notesDisplay.innerHTML = '';
                }
            }
        }

        async function displayPrescriptions() {
            // Refresh data from API
            await loadData();
            
            const list = document.getElementById('prescriptionList');
            // Filter only actual reports (with id field) that have prescriptions
            const pendingReports = reports.filter(r => r.id && r.prescription && r.medicines);
            
            if (pendingReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üíä No prescriptions to dispense</h3><p>Prescriptions will appear here once consultants create reports.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            pendingReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                
                // Calculate medicine status
                const pending = report.medicines ? report.medicines.filter(m => !m.dispensed).length : 0;
                const dispensed = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;
                const total = report.medicines ? report.medicines.length : 0;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">Prescription: ${report.id}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Client: ${client ? client.fullName : 'Unknown'} (${report.clientId})</p>
                    </div>
                        <div style="text-align: right;">
                            <span style="background: ${pending > 0 ? '#fff3cd' : '#e8f5e9'}; color: ${pending > 0 ? '#f39c12' : '#27ae60'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">
                                ${pending} pending, ${dispensed} dispensed
                            </span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üë®‚Äç‚öïÔ∏è Consultant:</strong> ${report.consultant}</p>
                        <p><strong>üìÖ Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                        <p><strong>üìû Client Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>üè¢ Branch:</strong> ${client ? client.branch : 'Unknown'}</p>
                        ${client ? (client.membershipStatus === 'member' ? `
                            <p><strong>üÜî NB Number:</strong> ${client.nbNumber || 'N/A'}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `) : ''}
                    </div>
                    ${report.medicines && report.medicines.length > 0 ? (() => {
                        const clientMembershipStatus = client ? client.membershipStatus : 'referred';
                        const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
                        const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
                        return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #c41e3a;">
                        <!-- Consultation Fee -->
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 2px solid #2196f3;">
                            <p style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">üë®‚Äç‚öïÔ∏è CONSULTATION FEE</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Consultant Medical Examination</span>
                                <span style="font-weight: bold; color: #1976d2; font-size: 1.1rem;">
                                    ${clientMembershipStatus === 'member' ? `N$${consultationFee} (DP)` : `N$${consultationFee} (CP)`}
                                </span>
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${clientMembershipStatus === 'member' ? '‚úì Member Rate: N$150' : '‚úì Client Rate: N$200'}
                            </p>
                        </div>
                        
                        <p><strong>üíä Prescription Medicines:</strong></p>
                        <div style="margin-top: 10px;">
                            ${report.medicines.map((med, i) => {
                                const price = findProductPrice(med.name);
                                const isPackage = price.isPackage;
                                
                                // Calculate pricing based on package status
                                let effectivePrice;
                                let packageInfo = null;
                                
                                if (isPackage) {
                                    // Initialize packageStatus if it doesn't exist for existing reports
                                    if (!med.packageStatus) {
                                        med.packageStatus = {};
                                        // Update the report in backend to persist the change
                                        updateReportInBackend(report);
                                    }
                                    
                                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                    if (clientMembershipStatus === 'member') {
                                        effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                    } else {
                                        effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                    }
                                    packageInfo = packagePricing;
                                } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                    }
                                }
                                
                                return `
                                <div style="padding: 12px; margin: 8px 0; background: ${med.dispensed ? '#e8f5e9' : '#fff3cd'}; border-radius: 5px; border-left: 4px solid ${med.dispensed ? '#27ae60' : '#f39c12'};">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="disp_${report.id}_${i}" ${med.dispensed ? 'checked' : ''}
                                            onchange="toggleDispense('${report.id}', ${i})" style="margin-right: 8px;">
                                        <label for="disp_${report.id}_${i}" style="font-weight: 600; flex: 1; font-size: 1.05rem;">
                                            ${med.name} ${med.dispensed ? '‚úÖ Dispensed' : '‚è≥ Pending'}
                                            ${isPackage ? ' üì¶' : ''}
                                        </label>
                                    </div>
                                    
                                    ${isPackage ? `
                                    <div style="background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #b3d9ff;">
                                        <p style="font-weight: 600; color: #1976d2; margin-bottom: 8px; font-size: 0.9rem;">üì¶ Package Contents:</p>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px;">
                                            ${(() => {
                                                const packageData = PACKAGE_DATABASE[med.name];
                                                if (!packageData || !packageData.products) {
                                                    return `<div style="padding: 10px; background: #ffebee; border-radius: 3px; color: #c62828; font-size: 0.8rem;">
                                                        ‚ö†Ô∏è Package data not found. Click "Update Pricing" to refresh.
                                                    </div>`;
                                                }
                                                return packageData.products.map((product, pIndex) => {
                                                    const productStatus = med.packageStatus && med.packageStatus[product.name] ? med.packageStatus[product.name] : 'not_given';
                                                    const escapedProductName = product.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                    return `
                                                    <div style="background: white; padding: 8px; border-radius: 3px; border-left: 3px solid ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                                            <span style="font-weight: 500; flex: 1; font-size: 0.85rem;">${product.name}</span>
                                                            <span style="font-size: 0.75rem; color: ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                                ${productStatus === 'given' ? '‚úÖ' : '‚è≥'}
                                                            </span>
                                                        </div>
                                                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
                                                            Qty: ${product.quantity} | 
                                                            ${clientMembershipStatus === 'member' ? 
                                                                `DP: N$${product.dp} | BV: ${product.bv}` : 
                                                                `CP: N$${product.cp}`}
                                                        </div>
                                                        <select id="package_select_${report.id}_${i}_${pIndex}" 
                                                                onchange="updatePackageStatus('${report.id}', ${i}, '${escapedProductName}', this.value)"
                                                                data-product-name="${escapedProductName}"
                                                                style="width: 100%; padding: 2px 4px; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 3px;">
                                                            <option value="not_given" ${productStatus === 'not_given' ? 'selected' : ''}>Not Given</option>
                                                            <option value="given" ${productStatus === 'given' ? 'selected' : ''}>Given</option>
                                                            <option value="out_of_stock" ${productStatus === 'out_of_stock' ? 'selected' : ''}>Out of Stock</option>
                                                        </select>
                                                    </div>
                                                    `;
                                                }).join('');
                                            })()}
                                        </div>
                                        <div style="background: #e8f5e9; padding: 8px; border-radius: 3px; margin-top: 8px; border: 1px solid #27ae60;">
                                            <div style="font-size: 0.8rem; color: #27ae60; text-align: center;">
                                                <div style="margin-bottom: 4px;">
                                                    <strong>üì¶ Dispensed:</strong> ${packageInfo.dispensedCount}/${packageInfo.totalCount} items
                                                    ${clientMembershipStatus === 'member' ? 
                                                        ` | DP: N$${effectivePrice.dp} | BV: ${effectivePrice.bv}` : 
                                                        ` | CP: N$${effectivePrice.cp}`}
                                                </div>
                                                <div style="font-size: 0.75rem; color: #666;">
                                                    ${packageInfo.dispensedCount < packageInfo.totalCount ? 
                                                        `Remaining: ${packageInfo.totalCount - packageInfo.dispensedCount} items` : 
                                                        '‚úÖ All items dispensed'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ` : `
                                    <div style="font-size: 0.9rem; color: #666; margin-left: 24px;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <span style="margin-right: 15px;"><strong>DP:</strong> N$${effectivePrice.dp}</span>
                                            <span><strong>BV:</strong> ${effectivePrice.bv}</span>
                                        ` : `
                                            <span><strong>CP:</strong> N$${effectivePrice.cp}</span>
                                        `}
                                    </div>
                                    `}
                                    
                                    ${med.dispensed ? `
                                    <div style="margin-left: 24px; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="paid_${report.id}_${i}" ${med.paid ? 'checked' : ''}
                                                onchange="togglePayment('${report.id}', ${i})" style="margin-right: 8px;">
                                            <span style="font-size: 0.85rem; color: #27ae60; font-weight: 500;">üí∞ Payment Received</span>
                                        </label>
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Price Totals -->
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 5px; margin-top: 15px; border: 2px solid #c41e3a;">
                            <h4 style="color: #c41e3a; margin-bottom: 10px; text-align: center;">üí∞ PRESCRIPTION TOTALS</h4>
                            <p style="text-align: center; font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                                (Includes N$${consultationFee} consultation fee)
                            </p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                                <div style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                                    <h5 style="color: #c41e3a; margin-bottom: 5px;">TOTAL</h5>
                                    <div style="font-size: 0.8rem;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <div><strong>DP:</strong> N$${totals.total.dp}</div>
                                            <div><strong>BV:</strong> ${totals.total.bv}</div>
                                        ` : `
                                            <div><strong>CP:</strong> N$${totals.total.cp}</div>
                                        `}
                                    </div>
                                </div>
                                <div style="text-align: center; background: #e8f5e9; padding: 10px; border-radius: 5px;">
                                    <h5 style="color: #27ae60; margin-bottom: 5px;">DISPENSED</h5>
                                    <div style="font-size: 0.8rem;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <div><strong>DP:</strong> N$${totals.dispensed.dp}</div>
                                            <div><strong>BV:</strong> ${totals.dispensed.bv}</div>
                                        ` : `
                                            <div><strong>CP:</strong> N$${totals.dispensed.cp}</div>
                                        `}
                                    </div>
                                </div>
                                <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 5px;">
                                    <h5 style="color: #155724; margin-bottom: 5px;">PAID</h5>
                                    <div style="font-size: 0.8rem;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <div><strong>DP:</strong> N$${totals.paid.dp}</div>
                                            <div><strong>BV:</strong> ${totals.paid.bv}</div>
                                        ` : `
                                            <div><strong>CP:</strong> N$${totals.paid.cp}</div>
                                        `}
                                    </div>
                                </div>
                                <div style="text-align: center; background: #f8d7da; padding: 10px; border-radius: 5px;">
                                    <h5 style="color: #721c24; margin-bottom: 5px;">OUTSTANDING</h5>
                                    <div style="font-size: 0.8rem;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <div><strong>DP:</strong> N$${totals.outstanding.dp}</div>
                                            <div><strong>BV:</strong> ${totals.outstanding.bv}</div>
                                        ` : `
                                            <div><strong>CP:</strong> N$${totals.outstanding.cp}</div>
                                        `}
                                    </div>
                                </div>
                                <div style="text-align: center; background: #fff3cd; padding: 10px; border-radius: 5px;">
                                    <h5 style="color: #f39c12; margin-bottom: 5px;">PENDING</h5>
                                    <div style="font-size: 0.8rem;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <div><strong>DP:</strong> N$${totals.pending.dp}</div>
                                            <div><strong>BV:</strong> ${totals.pending.bv}</div>
                                        ` : `
                                            <div><strong>CP:</strong> N$${totals.pending.cp}</div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    })() : ''}
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üìù Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')">üëÅÔ∏è View Details</button>
                        <button class="btn btn-warning" onclick="printPrescription('${report.id}')">üñ®Ô∏è Print Full</button>
                        <button class="btn btn-success" onclick="printThermalReceipt('${report.id}')">üßæ Thermal Receipt</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Function to calculate package pricing based on dispensed items
        function calculatePackagePricing(medicine, clientMembershipStatus) {
            const packageData = PACKAGE_DATABASE[medicine.name];
            if (!packageData || !packageData.products) {
                // For existing reports with old package names, try to find a match
                const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                    key.toLowerCase().includes(medicine.name.toLowerCase()) || 
                    medicine.name.toLowerCase().includes(key.toLowerCase())
                );
                
                if (possibleMatch) {
                    console.log(`Found package match: "${medicine.name}" -> "${possibleMatch}"`);
                    const matchedPackage = PACKAGE_DATABASE[possibleMatch];
                    
                    // Initialize packageStatus for the matched package
                    if (!medicine.packageStatus) {
                        medicine.packageStatus = {};
                    }
                    
                    // Update the medicine name to the correct package name
                    medicine.name = possibleMatch;
                    
                    // Return pricing for the matched package
                    return {
                        dp: matchedPackage.price.dp,
                        cp: matchedPackage.price.cp,
                        bv: matchedPackage.price.bv,
                        dispensedCount: 0,
                        totalCount: matchedPackage.products.length,
                        packageTotal: matchedPackage.price
                    };
                }
                
                return { dp: 0, cp: 0, bv: 0, dispensedCount: 0, totalCount: 0 };
            }
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let dispensedCount = 0;
            const totalCount = packageData.products.length;
            
            packageData.products.forEach(product => {
                const productStatus = medicine.packageStatus && medicine.packageStatus[product.name] 
                    ? medicine.packageStatus[product.name] : 'not_given';
                
                if (productStatus === 'given') {
                    dispensedDP += product.dp;
                    dispensedCP += product.cp;
                    dispensedBV += product.bv;
                    dispensedCount++;
                }
            });
            
            return {
                dp: dispensedDP,
                cp: dispensedCP,
                bv: dispensedBV,
                dispensedCount,
                totalCount,
                packageTotal: packageData.price
            };
        }

        // Function to update package status for individual products
        function updatePackageStatus(reportId, medicineIndex, productName, status) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medicineIndex]) return;
            
            const medicine = report.medicines[medicineIndex];
            
            // Initialize packageStatus if it doesn't exist
            if (!medicine.packageStatus) {
                medicine.packageStatus = {};
            }
            
            // Update the specific product status
            medicine.packageStatus[productName] = status;
            
            // Update local reports array immediately
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex !== -1) {
                reports[reportIndex] = report;
            }
            
            // Update the report in the backend asynchronously
            updateReportInBackend(report);
            
            // Show status update feedback
            const statusEmoji = status === 'given' ? '‚úÖ' : status === 'out_of_stock' ? '‚ö†Ô∏è' : '‚è≥';
            const statusText = status === 'given' ? 'Given' : status === 'out_of_stock' ? 'Out of Stock' : 'Not Given';
            
            // Show brief feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                padding: 10px 15px; border-radius: 5px; z-index: 10000; font-size: 0.9rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            feedback.textContent = `${statusEmoji} ${productName}: ${statusText}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    document.body.removeChild(feedback);
                }
            }, 2000);
            
            // Refresh the display to show updated totals
            displayPrescriptions();
        }

        // Function to update report in backend
        async function updateReportInBackend(report) {
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    // Update local reports array
                    const index = reports.findIndex(r => r.id === report.id);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                } else {
                    console.error('Failed to update report:', result.message);
                }
            } catch (error) {
                console.error('Error updating report:', error);
            }
        }

        // Search functionality for dispenser portal
        function searchPrescriptions(portal) {
            const searchTerm = document.getElementById('dispenserSearch').value.toLowerCase();
            const list = document.getElementById('prescriptionList');
            
            if (!searchTerm) {
                displayPrescriptions();
                return;
            }
            
            const pendingReports = reports.filter(r => !r.dispensed && r.prescription);
            const filteredReports = pendingReports.filter(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                return (
                    report.id.toLowerCase().includes(searchTerm) ||
                    (client && client.fullName.toLowerCase().includes(searchTerm)) ||
                    report.consultant.toLowerCase().includes(searchTerm) ||
                    report.prescription.toLowerCase().includes(searchTerm)
                );
            });
            
            if (filteredReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No prescriptions found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">Report ${report.id}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Client: ${client ? client.fullName : 'Unknown'}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: #fff3cd; color: #f39c12; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">Pending</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üë®‚Äç‚öïÔ∏è Consultant:</strong> ${report.consultant}</p>
                        <p><strong>üìÖ Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                        <p><strong>üìû Client Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>üÜî Reference:</strong> ${report.clientId}</p>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
                        <p><strong>üíä Prescription:</strong></p>
                        <p style="margin-top: 8px; white-space: pre-wrap;">${report.prescription}</p>
                    </div>
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üìù Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="markDispensed('${report.id}')">‚úÖ Mark Dispensed</button>
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllPrescriptions(portal) {
            document.getElementById('dispenserSearch').value = '';
            displayPrescriptions();
        }

        function refreshDispenserData() {
            displayPrescriptions();
            displayPriceList();
            refreshBusinessIntelligence();
            displayCashDrawerStatus();
        }

        function displayCashDrawerStatus() {
            const statusDiv = document.getElementById('cashDrawerStatus');
            if (!statusDiv) return;
            
            // Calculate today's cash from paid prescriptions
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const todayReports = reports.filter(r => new Date(r.timestamp) >= startOfDay);
            
            let todayCash = 0;
            todayReports.forEach(r => {
                const client = clients.find(c => c.referenceNumber === r.clientId);
                if (r.medicines && client) {
                    const totals = calculatePrescriptionTotals(r.medicines, client.membershipStatus);
                    todayCash += totals.paid.dp + totals.paid.cp;
                }
            });
            
            const totalDrops = cashDrawer.drops.reduce((sum, drop) => sum + drop.amount, 0);
            const totalExpenses = cashDrawer.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const expectedCash = cashDrawer.openingBalance + todayCash - totalDrops - totalExpenses;
            
            statusDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'};">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Drawer Status</p>
                        <h3 style="color: ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'}; font-size: 16pt;">
                            ${cashDrawer.isOpen ? 'üîì OPEN' : 'üîí CLOSED'}
                        </h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #3498db;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Opening Balance</p>
                        <h3 style="color: #3498db; font-size: 16pt;">N$${cashDrawer.openingBalance.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #27ae60;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Today's Cash</p>
                        <h3 style="color: #27ae60; font-size: 16pt;">N$${todayCash.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #f39c12;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Expected in Drawer</p>
                        <h3 style="color: #f39c12; font-size: 16pt;">N$${expectedCash.toFixed(2)}</h3>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    ${!cashDrawer.isOpen ? `
                        <button class="btn btn-success" onclick="openCashDrawer()">üîì Open Cash Drawer</button>
                    ` : `
                        <button class="btn btn-warning" onclick="recordCashDrop()" style="margin-right: 10px;">üí∞ Cash Drop</button>
                        <button class="btn btn-info" onclick="recordExpense()" style="margin-right: 10px;">üìù Record Expense</button>
                        <button class="btn btn-primary" onclick="viewCashHistory()" style="margin-right: 10px;">üìã View History</button>
                        <button class="btn btn-danger" onclick="closeCashDrawer()">üîí Close & Reconcile</button>
                    `}
                </div>
            `;
        }

        function openCashDrawer() {
            const openingBalance = prompt('Enter opening cash balance in drawer (N$):');
            if (openingBalance === null) return;
            
            const amount = parseFloat(openingBalance) || 0;
            
            cashDrawer = {
                openingBalance: amount,
                currentBalance: amount,
                isOpen: true,
                openedBy: currentUser.fullName,
                openedAt: new Date().toISOString(),
                drops: [],
                expenses: []
            };
            
            alert(`‚úÖ Cash drawer opened\nOpening Balance: N$${amount.toFixed(2)}\nOpened by: ${currentUser.fullName}`);
            displayCashDrawerStatus();
        }

        function recordCashDrop() {
            const amount = prompt('Enter cash drop amount (N$):');
            if (!amount) return;
            
            const dropAmount = parseFloat(amount);
            if (isNaN(dropAmount) || dropAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            const notes = prompt('Notes (optional):') || '';
            
            cashDrawer.drops.push({
                amount: dropAmount,
                recordedBy: currentUser.fullName,
                recordedAt: new Date().toISOString(),
                notes: notes,
                reference: 'DROP' + Date.now()
            });
            
            cashDrawer.currentBalance -= dropAmount;
            
            alert(`‚úÖ Cash drop recorded\nAmount: N$${dropAmount.toFixed(2)}\nRemaining in drawer: N$${cashDrawer.currentBalance.toFixed(2)}`);
            displayCashDrawerStatus();
        }

        function recordExpense() {
            const description = prompt('Expense description:');
            if (!description) return;
            
            const amount = prompt('Expense amount (N$):');
            if (!amount) return;
            
            const expenseAmount = parseFloat(amount);
            if (isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            cashDrawer.expenses.push({
                description: description,
                amount: expenseAmount,
                recordedBy: currentUser.fullName,
                recordedAt: new Date().toISOString(),
                reference: 'EXP' + Date.now()
            });
            
            cashDrawer.currentBalance -= expenseAmount;
            
            alert(`‚úÖ Expense recorded\nDescription: ${description}\nAmount: N$${expenseAmount.toFixed(2)}`);
            displayCashDrawerStatus();
        }

        function viewCashHistory() {
            let history = `CASH DRAWER HISTORY\n\n`;
            history += `Opening Balance: N$${cashDrawer.openingBalance.toFixed(2)}\n`;
            history += `Opened by: ${cashDrawer.openedBy} at ${new Date(cashDrawer.openedAt).toLocaleString('en-GB')}\n\n`;
            
            if (cashDrawer.drops.length > 0) {
                history += `CASH DROPS (${cashDrawer.drops.length}):\n`;
                cashDrawer.drops.forEach((drop, idx) => {
                    history += `${idx + 1}. N$${drop.amount.toFixed(2)} - ${new Date(drop.recordedAt).toLocaleString('en-GB')}\n`;
                    history += `   By: ${drop.recordedBy} | Ref: ${drop.reference}\n`;
                    if (drop.notes) history += `   Notes: ${drop.notes}\n`;
                });
                history += `\n`;
            }
            
            if (cashDrawer.expenses.length > 0) {
                history += `EXPENSES (${cashDrawer.expenses.length}):\n`;
                cashDrawer.expenses.forEach((exp, idx) => {
                    history += `${idx + 1}. ${exp.description} - N$${exp.amount.toFixed(2)}\n`;
                    history += `   By: ${exp.recordedBy} at ${new Date(exp.recordedAt).toLocaleString('en-GB')}\n`;
                });
            }
            
            alert(history);
        }

        function closeCashDrawer() {
            const actualCash = prompt('Enter actual cash counted in drawer (N$):');
            if (actualCash === null) return;
            
            const counted = parseFloat(actualCash);
            if (isNaN(counted)) {
                alert('Invalid amount');
                return;
            }
            
            // Calculate expected
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const todayReports = reports.filter(r => new Date(r.timestamp) >= startOfDay);
            
            let todayCash = 0;
            todayReports.forEach(r => {
                const client = clients.find(c => c.referenceNumber === r.clientId);
                if (r.medicines && client) {
                    const totals = calculatePrescriptionTotals(r.medicines, client.membershipStatus);
                    todayCash += totals.paid.dp + totals.paid.cp;
                }
            });
            
            const totalDrops = cashDrawer.drops.reduce((sum, drop) => sum + drop.amount, 0);
            const totalExpenses = cashDrawer.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const expectedCash = cashDrawer.openingBalance + todayCash - totalDrops - totalExpenses;
            const variance = counted - expectedCash;
            
            let reconciliation = `CASH DRAWER RECONCILIATION\n\n`;
            reconciliation += `Opening Balance: N$${cashDrawer.openingBalance.toFixed(2)}\n`;
            reconciliation += `+ Today's Cash: N$${todayCash.toFixed(2)}\n`;
            reconciliation += `- Cash Drops: N$${totalDrops.toFixed(2)}\n`;
            reconciliation += `- Expenses: N$${totalExpenses.toFixed(2)}\n`;
            reconciliation += `= Expected Cash: N$${expectedCash.toFixed(2)}\n\n`;
            reconciliation += `Actual Counted: N$${counted.toFixed(2)}\n`;
            reconciliation += `Variance: N$${variance.toFixed(2)} ${variance >= 0 ? '(Over)' : '(Short)'}\n\n`;
            
            if (Math.abs(variance) > 10) {
                reconciliation += `‚ö†Ô∏è WARNING: Variance exceeds N$10\nPlease investigate discrepancy.\n\n`;
            }
            
            if (confirm(reconciliation + 'Close cash drawer?')) {
                cashDrawer.isOpen = false;
                cashDrawer.closedBy = currentUser.fullName;
                cashDrawer.closedAt = new Date().toISOString();
                cashDrawer.actualCash = counted;
                cashDrawer.variance = variance;
                
                alert('‚úÖ Cash drawer closed successfully');
                displayCashDrawerStatus();
            }
        }

        function showAllInventory() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            list.innerHTML = Object.entries(inventory).map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Reorder At</p>
                                <strong>${data.reorderLevel}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">‚ûï</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">‚ûñ</button>
                            <button class="btn btn-sm btn-info" onclick="setReorderLevel('${productName.replace(/'/g, "\\'")})" style="padding: 5px 10px;">‚öôÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            if (!searchTerm) {
                showAllInventory();
                return;
            }
            
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const filtered = Object.entries(inventory).filter(([name, _]) => 
                name.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = filtered.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">‚ûï</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">‚ûñ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showLowStockItems() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            if (lowStock.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #27ae60;"><h3>‚úÖ All items adequately stocked</h3></div>';
                return;
            }
            
            list.innerHTML = `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è ${lowStock.length} Items Need Reordering</h4>
                </div>
            ` + lowStock.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #e74c3c;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${productName}</strong>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Current: ${data.currentStock} | Reorder at: ${data.reorderLevel}
                            </p>
                        </div>
                        <button class="btn btn-success" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')">üì¶ Restock</button>
                    </div>
                </div>
            `).join('');
        }

        function adjustStock(productName, action) {
            const quantity = prompt(`Enter quantity to ${action === 'add' ? 'add' : 'remove'}:`);
            if (!quantity) return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                alert('Invalid quantity');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: 5,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            }
            
            const previousStock = inventory[productName].currentStock;
            
            if (action === 'add') {
                inventory[productName].currentStock += qty;
            } else {
                inventory[productName].currentStock = Math.max(0, inventory[productName].currentStock - qty);
            }
            
            // Record in history
            inventory[productName].history.push({
                action: action,
                quantity: qty,
                previousStock: previousStock,
                newStock: inventory[productName].currentStock,
                user: currentUser.fullName,
                timestamp: new Date().toISOString(),
                reference: (action === 'add' ? 'STOCK-IN' : 'STOCK-OUT') + Date.now()
            });
            
            inventory[productName].lastUpdated = new Date().toISOString();
            
            alert(`‚úÖ Stock updated\n${productName}\nPrevious: ${previousStock}\nNew: ${inventory[productName].currentStock}`);
            showAllInventory();
        }

        function setReorderLevel(productName) {
            const current = inventory[productName]?.reorderLevel || 5;
            const newLevel = prompt(`Set reorder level for:\n${productName}\n\nCurrent reorder level: ${current}\n\nEnter new reorder level:`);
            
            if (!newLevel) return;
            
            const level = parseInt(newLevel);
            if (isNaN(level) || level < 0) {
                alert('Invalid reorder level');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: level,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            } else {
                inventory[productName].reorderLevel = level;
            }
            
            alert(`‚úÖ Reorder level updated to ${level}`);
            showAllInventory();
        }

        function printInventoryReport() {
            initializeInventory();
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            const totalProducts = Object.keys(inventory).length;
            const totalStock = Object.values(inventory).reduce((sum, data) => sum + data.currentStock, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Inventory Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th { background: #f8f9fa; padding: 8px; border: 1px solid #ddd; text-align: left; }
                        td { padding: 6px 8px; border: 1px solid #ddd; }
                        .low-stock { background: #ffebee; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Inventory Stock Report</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalProducts}</h3>
                            <p>Total Products</p>
                        </div>
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalStock}</h3>
                            <p>Total Units in Stock</p>
                        </div>
                        <div style="text-align: center; background: #ffebee; padding: 12px; border-radius: 5px;">
                            <h3 style="color: #e74c3c;">${lowStock.length}</h3>
                            <p>Low Stock Items</p>
                        </div>
                    </div>
                    
                    ${lowStock.length > 0 ? `
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Low Stock Items (Reorder Required)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Level</th>
                                    <th>Shortage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStock.map(([name, data], idx) => `
                                    <tr class="low-stock">
                                        <td>${idx + 1}</td>
                                        <td>${name}</td>
                                        <td>${data.currentStock}</td>
                                        <td>${data.reorderLevel}</td>
                                        <td>${data.reorderLevel - data.currentStock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <h3 style="margin-top: 30px; margin-bottom: 10px;">üì¶ Full Inventory List</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(inventory).map(([name, data], idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${name}</td>
                                    <td>${data.currentStock}</td>
                                    <td>${data.reorderLevel}</td>
                                    <td>${data.currentStock > data.reorderLevel ? '‚úÖ OK' : '‚ö†Ô∏è LOW'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function refreshBusinessIntelligence() {
            await loadData();
            
            const display = document.getElementById('biDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const biData = calculateBusinessIntelligence(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 24pt; margin-bottom: 3px;">${biData.totalRevenue.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total Revenue (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 24pt; margin-bottom: 3px;">${biData.totalPaid.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Cash Collected (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 24pt; margin-bottom: 3px;">${biData.totalOutstanding.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Outstanding (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #9b59b6; text-align: center;">
                            <h3 style="color: #9b59b6; font-size: 24pt; margin-bottom: 3px;">${biData.totalBV}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total BV</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 24pt; margin-bottom: 3px;">${biData.productsSold}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Products Sold</p>
                        </div>
                    </div>

                    <!-- Top Selling Products & Revenue Breakdown -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üèÜ Top Selling Products</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Qty</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${biData.topSellingProducts.slice(0, 10).map((product, idx) => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                            <td style="padding: 8px;">${product.name}</td>
                                            <td style="padding: 8px; text-align: center;">${product.quantity}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: bold;">N$${product.revenue.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üí∞ Revenue Breakdown</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Member Sales (DP):</span>
                                    <strong style="color: #27ae60;">N$${biData.dpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 12px; border-radius: 6px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.dpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.dpPercentage}%</p>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Referred Sales (CP):</span>
                                    <strong style="color: #f39c12;">N$${biData.cpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 12px; border-radius: 6px;">
                                    <div style="background: #f39c12; height: 100%; width: ${biData.cpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.cpPercentage}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Package vs Individual Sales -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üì¶ Package vs Individual Sales</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Package Sales:</span>
                                    <strong style="color: #27ae60;">${biData.packageSales} (N$${biData.packageRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.packagePercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Individual Sales:</span>
                                    <strong style="color: #2196f3;">${biData.individualSales} (N$${biData.individualRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e3f2fd; height: 10px; border-radius: 5px;">
                                    <div style="background: #2196f3; height: 100%; width: ${biData.individualPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üë• Consultant Performance</h4>
                            ${biData.topConsultants.slice(0, 5).map((consultant, idx) => `
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 0.9rem;">${consultant.name}</span>
                                        <strong style="color: #c41e3a;">N$${consultant.revenue.toFixed(0)}</strong>
                                    </div>
                                    <div style="background: #f8f9fa; height: 8px; border-radius: 4px;">
                                        <div style="background: #c41e3a; height: 100%; width: ${consultant.percentage}%; border-radius: 4px;"></div>
                                    </div>
                                    <p style="font-size: 0.75rem; color: #666; margin-top: 2px;">${consultant.clients} clients | ${consultant.percentage}%</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateBusinessIntelligence(timeframe) {
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = reports.filter(r => new Date(r.timestamp) >= startDate);
            
            // Calculate revenue
            let totalRevenue = 0, totalPaid = 0, totalOutstanding = 0, totalBV = 0;
            let dpRevenue = 0, cpRevenue = 0;
            let packageSales = 0, individualSales = 0;
            let packageRevenue = 0, individualRevenue = 0;
            let productsSold = 0;
            
            const productRevenue = {};
            const consultantRevenue = {};
            
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client || !report.medicines) return;
                
                const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                
                totalRevenue += totals.total.dp + totals.total.cp;
                totalPaid += totals.paid.dp + totals.paid.cp;
                totalOutstanding += totals.outstanding.dp + totals.outstanding.cp;
                totalBV += totals.total.bv;
                
                dpRevenue += totals.total.dp;
                cpRevenue += totals.total.cp;
                
                // Track consultant performance
                if (!consultantRevenue[report.consultant]) {
                    consultantRevenue[report.consultant] = { revenue: 0, clients: 0 };
                }
                consultantRevenue[report.consultant].revenue += totals.paid.dp + totals.paid.cp;
                consultantRevenue[report.consultant].clients++;
                
                // Track products
                report.medicines.forEach(med => {
                    const price = findProductPrice(med.name);
                    const isPackage = price.isPackage;
                    
                    if (isPackage) {
                        packageSales++;
                        const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                        const revenue = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                        packageRevenue += revenue;
                        
                        if (!productRevenue[med.name]) {
                            productRevenue[med.name] = { quantity: 0, revenue: 0 };
                        }
                        productRevenue[med.name].quantity++;
                        productRevenue[med.name].revenue += revenue;
                    } else {
                        if (med.dispensed) {
                            individualSales++;
                            const revenue = client.membershipStatus === 'member' ? price.dp : price.cp;
                            individualRevenue += revenue;
                            
                            if (!productRevenue[med.name]) {
                                productRevenue[med.name] = { quantity: 0, revenue: 0 };
                            }
                            productRevenue[med.name].quantity++;
                            productRevenue[med.name].revenue += revenue;
                        }
                    }
                    productsSold++;
                });
            });
            
            const topSellingProducts = Object.entries(productRevenue)
                .map(([name, data]) => ({
                    name,
                    quantity: data.quantity,
                    revenue: data.revenue
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const topConsultants = Object.entries(consultantRevenue)
                .map(([name, data]) => ({
                    name,
                    revenue: data.revenue,
                    clients: data.clients,
                    percentage: totalPaid > 0 ? Math.round((data.revenue / totalPaid) * 100) : 0
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const totalSales = packageSales + individualSales;
            
            return {
                totalRevenue,
                totalPaid,
                totalOutstanding,
                totalBV,
                dpRevenue,
                cpRevenue,
                dpPercentage: totalRevenue > 0 ? Math.round((dpRevenue / totalRevenue) * 100) : 0,
                cpPercentage: totalRevenue > 0 ? Math.round((cpRevenue / totalRevenue) * 100) : 0,
                packageSales,
                individualSales,
                packageRevenue,
                individualRevenue,
                packagePercentage: totalSales > 0 ? Math.round((packageSales / totalSales) * 100) : 0,
                individualPercentage: totalSales > 0 ? Math.round((individualSales / totalSales) * 100) : 0,
                productsSold,
                topSellingProducts,
                topConsultants
            };
        }

        function printBusinessIntelligence() {
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Business Intelligence Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Business Intelligence Report - ${timeframeText}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('biDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Price list functions
        function displayPriceList() {
            const list = document.getElementById('priceList');
            if (!list) return;
            
            // Combine packages and individual products
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${allItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` üì¶ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function searchPriceList() {
            const searchTerm = document.getElementById('priceSearch').value.toLowerCase();
            const list = document.getElementById('priceList');
            if (!list) return;
            
            if (!searchTerm) {
                displayPriceList();
                return;
            }
            
            // Combine packages and individual products for search
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            const filteredItems = allItems.filter(item => 
                item.description.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">Search Results (${filteredItems.length} items)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${filteredItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` üì¶ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function showAllPrices() {
            document.getElementById('priceSearch').value = '';
            displayPriceList();
        }

        function printPriceList() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #c41e3a; margin-bottom: 10px; }
                        .price-table { width: 100%; border-collapse: collapse; }
                        .price-table th, .price-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .price-table th { background-color: #f8f9fa; font-weight: bold; }
                        .price-table .description { width: 60%; }
                        .price-table .dp, .price-table .cp, .price-table .bv { width: 13.33%; text-align: center; }
                        .dp { color: #c41e3a; font-weight: bold; }
                        .cp { color: #27ae60; font-weight: bold; }
                        .bv { color: #f39c12; font-weight: bold; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h1>
                        <p>DESCRIPTION | DP | CP | BV</p>
                    </div>
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th class="description">DESCRIPTION</th>
                                <th class="dp">DP</th>
                                <th class="cp">CP</th>
                                <th class="bv">BV</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${PRICE_LIST.map(item => `
                                <tr>
                                    <td class="description">${item.description}</td>
                                    <td class="dp">${item.dp}</td>
                                    <td class="cp">${item.cp}</td>
                                    <td class="bv">${item.bv}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function viewPrescriptionDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (report) {
                alert(`Prescription Details:\n\nReport ID: ${report.id}\nClient: ${client ? client.fullName : 'Unknown'}\nConsultant: ${report.consultant}\nCreated: ${new Date(report.timestamp).toLocaleString()}\n\nPrescription:\n${report.prescription}\n\nNotes:\n${report.notes || 'None'}`);
            }
        }

        function printPrescription(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report) return;
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Prescription - ${report.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #c41e3a; padding-bottom: 20px; margin-bottom: 20px; }
                        .patient-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .medicines { margin: 20px 0; }
                        .medicine-item { padding: 8px; margin: 5px 0; border-left: 3px solid #c41e3a; background: #f8f9fa; }
                        .notes { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        .footer { margin-top: 30px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Summary Analysis Report Card</h2>
                        <p>Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
                        <p>Branch: ${client ? client.branch : 'Unknown'}</p>
                    </div>
                    
                    <div class="patient-info">
                        <h3>Patient Information</h3>
                        <p><strong>Name:</strong> ${client ? client.fullName : 'Unknown'}</p>
                        <p><strong>Reference:</strong> ${report.clientId}</p>
                        <p><strong>Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="medicines">
                        <h3>Prescribed Medicines with Prices</h3>
                        ${report.medicines ? (() => {
                            const clientMembershipStatus = client ? client.membershipStatus : 'referred';
                            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
                            return `
                            ${report.medicines.map(med => {
                                const price = findProductPrice(med.name);
                                let effectivePrice;
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                
                                return `
                                <div class="medicine-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${med.name}</strong> ${med.dispensed ? '‚úÖ Dispensed' : '‚è≥ Pending'}
                                            ${med.paid ? 'üí∞ Paid' : ''}
                                        </div>
                                        <div style="text-align: right; font-size: 0.9rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${effectivePrice.dp}</div>
                                                <div><strong>BV:</strong> ${effectivePrice.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${effectivePrice.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            
                            <!-- Receipt Totals -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; border: 2px solid #c41e3a;">
                                <h4 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">PRESCRIPTION TOTALS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                        <h5 style="color: #c41e3a; margin-bottom: 5px;">TOTAL</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.total.dp}</div>
                                                <div><strong>BV:</strong> ${totals.total.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.total.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #e8f5e9; padding: 10px; border-radius: 5px; border: 1px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin-bottom: 5px;">DISPENSED</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.dispensed.dp}</div>
                                                <div><strong>BV:</strong> ${totals.dispensed.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.dispensed.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #155724;">
                                        <h5 style="color: #155724; margin-bottom: 5px;">PAID</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.paid.dp}</div>
                                                <div><strong>BV:</strong> ${totals.paid.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.paid.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #721c24;">
                                        <h5 style="color: #721c24; margin-bottom: 5px;">OUTSTANDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.outstanding.dp}</div>
                                                <div><strong>BV:</strong> ${totals.outstanding.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.outstanding.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin-bottom: 5px;">PENDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.pending.dp}</div>
                                                <div><strong>BV:</strong> ${totals.pending.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.pending.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        })() : '<p>No medicines prescribed</p>'}
                    </div>
                    
                    ${report.notes ? `
                    <div class="notes">
                        <h3>Consultant Notes</h3>
                        <p>${report.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p><strong>Consultant:</strong> ${report.consultant}</p>
                        <p><strong>Report ID:</strong> ${report.id}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printThermalReceipt(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report || !client) {
                alert('Report or client data not found');
                return;
            }
            
            const clientMembershipStatus = client.membershipStatus || 'referred';
            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Create thermal receipt
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Receipt - ${report.id}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        .center {
                            text-align: center;
                        }
                        
                        .bold {
                            font-weight: bold;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                            margin-bottom: 8px;
                        }
                        
                        .header h1 {
                            font-size: 12pt;
                            margin-bottom: 3px;
                        }
                        
                        .header p {
                            font-size: 8pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin: 8px 0;
                            padding-bottom: 5px;
                        }
                        
                        .section-title {
                            font-weight: bold;
                            font-size: 9pt;
                            border-bottom: 1px solid #000;
                            margin-bottom: 4px;
                            padding-bottom: 2px;
                        }
                        
                        .info-line {
                            display: flex;
                            justify-content: space-between;
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        
                        .item {
                            margin: 4px 0;
                            font-size: 9pt;
                        }
                        
                        .item-name {
                            font-weight: bold;
                        }
                        
                        .item-status {
                            display: flex;
                            justify-content: space-between;
                            font-size: 8pt;
                            margin-top: 1px;
                        }
                        
                        .divider {
                            border-top: 1px dashed #000;
                            margin: 6px 0;
                        }
                        
                        .total-line {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            font-size: 10pt;
                            margin: 3px 0;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 10px;
                            border-top: 1px dashed #000;
                            padding-top: 5px;
                            font-size: 8pt;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>PRESCRIPTION RECEIPT</p>
                        <p>${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</p>
                    </div>
                    
                    <!-- Client Details -->
                    <div class="section">
                        <div class="section-title">CLIENT DETAILS</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span class="bold">${client.fullName}</span>
                        </div>
                        <div class="info-line">
                            <span>DOB:</span>
                            <span>${client.dob || 'N/A'}</span>
                        </div>
                        <div class="info-line">
                            <span>Contact:</span>
                            <span>${client.phone}</span>
                        </div>
                        <div class="info-line">
                            <span>Type:</span>
                            <span>${clientMembershipStatus === 'member' ? 'MEMBER (DP)' : 'REFERRED (CP)'}</span>
                        </div>
                        ${clientMembershipStatus === 'referred' ? `
                        <div class="info-line">
                            <span>Referred By:</span>
                            <span>${client.referralName || 'N/A'}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Consultant Info -->
                    <div class="section">
                        <div class="section-title">CONSULTANT</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span>${report.consultant}</span>
                        </div>
                        <div class="info-line">
                            <span>Date:</span>
                            <span>${new Date(report.timestamp).toLocaleDateString('en-GB')}</span>
                        </div>
                        <div class="info-line">
                            <span>Report ID:</span>
                            <span>${report.id}</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Prescribed Items -->
                    <div class="section">
                        <div class="section-title">PRESCRIBED PRODUCTS</div>
                        ${report.medicines.map(med => {
                            const price = findProductPrice(med.name);
                            const isPackage = price.isPackage;
                            let effectivePrice;
                            let isTaken;
                            
                            if (isPackage) {
                                const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                }
                                // For packages, show partial status if some items are dispensed
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    isTaken = '‚úì TAKEN';
                                } else if (packagePricing.dispensedCount > 0) {
                                    isTaken = `‚óê PARTIAL (${packagePricing.dispensedCount}/${packagePricing.totalCount})`;
                                } else {
                                    isTaken = '‚óã NOT TAKEN';
                                }
                            } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                isTaken = med.dispensed ? '‚úì TAKEN' : '‚óã NOT TAKEN';
                            }
                            
                            return `
                            <div class="item">
                                <div class="item-name">${med.name}${isPackage ? ' üì¶' : ''}</div>
                                <div class="item-status">
                                    <span>${isTaken}</span>
                                    <span class="bold">
                                        ${clientMembershipStatus === 'member' ? 
                                            `N$${effectivePrice.dp}` : 
                                            `N$${effectivePrice.cp}`}
                                    </span>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Totals -->
                    <div class="section">
                        <div class="section-title">SUMMARY</div>
                        <div class="info-line">
                            <span>Consultation Fee:</span>
                            <span>N$${consultationFee}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="total-line">
                            <span>TOTAL:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.total.dp}` : 
                                    `N$${totals.total.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Dispensed:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.dispensed.dp}` : 
                                    `N$${totals.dispensed.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Pending:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.pending.dp}` : 
                                    `N$${totals.pending.cp}`}
                            </span>
                        </div>
                        ${clientMembershipStatus === 'member' ? `
                        <div class="info-line">
                            <span>Total BV:</span>
                            <span>${totals.total.bv}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p>HEALTH | WEALTH | FREEDOM</p>
                        <p>Thank you!</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function showDailyStatementModal() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Generate preview content directly (same as what gets printed in A4)
            const content = document.getElementById('dailyStatementContent');
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Summary Statistics -->
                    <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üìä DAILY SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalClientsToday}</h3>
                                <p style="color: #666; font-size: 9pt;">Total Clients</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalMembers}</h3>
                                <p style="color: #666; font-size: 9pt;">Registered Members</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalReferred}</h3>
                                <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</h3>
                        ${Object.keys(statementData.consultantStats).map(consultantName => {
                            const stats = statementData.consultantStats[consultantName];
                            return `
                            <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #e3f2fd;">
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üì¶ PRODUCTS DISPENSED TODAY</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr style="background: #e8f5e9;">
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(statementData.productDispensed).map((product, idx) => `
                                    <tr>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${statementData.totalRevenue.bv}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.dp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(statementData.totalPaid.dp + statementData.totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal
            document.getElementById('dailyStatementModal').style.display = 'block';
        }
        
        function generateDailyStatementData() {
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            
            // Filter reports for today
            const todayReports = reports.filter(r => {
                const reportDate = new Date(r.timestamp);
                return reportDate >= startOfDay && reportDate <= endOfDay;
            });
            
            if (todayReports.length === 0) {
                alert('No consultations recorded for today');
                return;
            }
            
            // Group reports by consultant
            const consultantStats = {};
            let totalClientsToday = 0;
            let totalMembers = 0;
            let totalReferred = 0;
            let totalRevenue = { dp: 0, cp: 0, bv: 0 };
            let totalPaid = { dp: 0, cp: 0, bv: 0 };
            let totalOutstanding = { dp: 0, cp: 0, bv: 0 };
            
            // Product dispensing tracking
            const productDispensed = {};
            
            todayReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client) return;
                
                totalClientsToday++;
                const isMember = client.membershipStatus === 'member';
                if (isMember) totalMembers++;
                else totalReferred++;
                
                // Initialize consultant stats
                if (!consultantStats[report.consultant]) {
                    consultantStats[report.consultant] = {
                        totalClients: 0,
                        members: 0,
                        referred: 0,
                        clients: []
                    };
                }
                
                consultantStats[report.consultant].totalClients++;
                if (isMember) {
                    consultantStats[report.consultant].members++;
                } else {
                    consultantStats[report.consultant].referred++;
                }
                
                consultantStats[report.consultant].clients.push({
                    name: client.fullName,
                    type: isMember ? 'Member' : 'Referred',
                    referralNb: client.referralNbNumber || client.nbNumber || 'N/A',
                    referredBy: client.referralName || 'Self'
                });
                
                // Calculate totals
                if (report.medicines) {
                    const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                    
                    totalRevenue.dp += totals.total.dp;
                    totalRevenue.cp += totals.total.cp;
                    totalRevenue.bv += totals.total.bv;
                    
                    totalPaid.dp += totals.paid.dp;
                    totalPaid.cp += totals.paid.cp;
                    totalPaid.bv += totals.paid.bv;
                    
                    totalOutstanding.dp += totals.outstanding.dp;
                    totalOutstanding.cp += totals.outstanding.cp;
                    totalOutstanding.bv += totals.outstanding.bv;
                    
                    // Track dispensed products
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        const isPackage = price.isPackage;
                        
                        if (isPackage) {
                            // For packages, track individual items
                            const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                            if (packagePricing.dispensedCount > 0) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        partialCount: 0,
                                        fullCount: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].partialCount++;
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    productDispensed[med.name].fullCount++;
                                }
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += packagePricing.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += packagePricing.cp;
                                }
                            }
                        } else {
                            // For individual products
                            if (med.dispensed) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].quantity++;
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += price.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += price.cp;
                                }
                            }
                        }
                    });
                }
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        .summary-box {
                            background: #f8f9fa;
                            border: 2px solid #c41e3a;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-top: 10px;
                        }
                        
                        .summary-item {
                            background: white;
                            padding: 12px;
                            border-radius: 5px;
                            border-left: 4px solid #c41e3a;
                            text-align: center;
                        }
                        
                        .summary-item h3 {
                            color: #c41e3a;
                            font-size: 24pt;
                            margin-bottom: 5px;
                        }
                        
                        .summary-item p {
                            color: #666;
                            font-size: 9pt;
                        }
                        
                        .section {
                            margin-bottom: 25px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 8px 15px;
                            font-size: 12pt;
                            font-weight: bold;
                            border-radius: 5px;
                            margin-bottom: 10px;
                        }
                        
                        .consultant-section {
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            padding: 15px;
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                        }
                        
                        .consultant-section h4 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                            font-size: 11pt;
                        }
                        
                        .client-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .client-table th {
                            background: #e3f2fd;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .client-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .product-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .product-table th {
                            background: #e8f5e9;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .product-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .totals-section {
                            background: #fff3cd;
                            border: 2px solid #ffc107;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        
                        .totals-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        
                        .total-item {
                            background: white;
                            padding: 10px;
                            border-radius: 5px;
                            border-left: 3px solid #f39c12;
                        }
                        
                        .total-item strong {
                            color: #c41e3a;
                            font-size: 11pt;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #c41e3a;
                            font-size: 9pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="summary-box">
                        <h3 style="color: #c41e3a; margin-bottom: 10px; text-align: center;">üìä DAILY SUMMARY</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <h3>${totalClientsToday}</h3>
                                <p>Total Clients</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalMembers}</h3>
                                <p>Registered Members</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalReferred}</h3>
                                <p>Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div class="section">
                        <div class="section-title">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</div>
                        ${Object.keys(consultantStats).map(consultantName => {
                            const stats = consultantStats[consultantName];
                            return `
                            <div class="consultant-section">
                                <h4>üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total Clients:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table class="client-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Client Name</th>
                                            <th>Type</th>
                                            <th>Referral NB</th>
                                            <th>Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td>${idx + 1}</td>
                                                <td>${client.name}</td>
                                                <td>${client.type}</td>
                                                <td>${client.referralNb}</td>
                                                <td>${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div class="section">
                        <div class="section-title">üì¶ PRODUCTS DISPENSED TODAY</div>
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product Name</th>
                                    <th>Quantity Dispensed</th>
                                    <th>Revenue (DP)</th>
                                    <th>Revenue (CP)</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(productDispensed).map((product, idx) => `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${product.name}</td>
                                        <td>
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td>N$${product.revenue.dp.toFixed(2)}</td>
                                        <td>N$${product.revenue.cp.toFixed(2)}</td>
                                        <td><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="totals-section">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                        <div class="totals-grid">
                            <div class="total-item">
                                <strong>Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${totalRevenue.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Paid BV: ${totalPaid.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (DP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Outstanding BV: ${totalOutstanding.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (CP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 12pt; color: #27ae60;">TOTAL CASH COLLECTED: N$${(totalPaid.dp + totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            return statementData;
        }
        
        function generateDailyStatementHTML(data, isThermal) {
            if (isThermal) {
                // Thermal receipt format - compact and bold
                return `
                    <div style="font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold;">
                        <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                            <div style="font-size: 11pt; font-weight: bold;">DYNAPHARM NAMIBIA</div>
                            <div style="font-size: 9pt;">DAILY STATEMENT</div>
                            <div style="font-size: 8pt;">${new Date().toLocaleDateString('en-GB')}</div>
                        </div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">SUMMARY</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total Clients:</span><span>${data.totalClientsToday}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Members:</span><span>${data.totalMembers}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Referred:</span><span>${data.totalReferred}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">REVENUE</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total DP:</span><span>N$${data.totalRevenue.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total CP:</span><span>N$${data.totalRevenue.cp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total BV:</span><span>${data.totalRevenue.bv}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">CASH COLLECTED</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid DP:</span><span>N$${data.totalPaid.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid CP:</span><span>N$${data.totalPaid.cp.toFixed(2)}</span>
                            </div>
                            <div style="border-top: 1px solid #000; margin: 4px 0;"></div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0; font-size: 11pt;">
                                <span>TOTAL:</span><span>N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">OUTSTANDING</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding DP:</span><span>N$${data.totalOutstanding.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding CP:</span><span>N$${data.totalOutstanding.cp.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 8pt;">
                            <div>HEALTH | WEALTH | FREEDOM</div>
                        </div>
                    </div>
                `;
            } else {
                // A4 format - full detailed report
                return `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <!-- Summary Statistics -->
                        <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üìä DAILY SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalClientsToday}</h3>
                                    <p style="color: #666; font-size: 9pt;">Total Clients</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalMembers}</h3>
                                    <p style="color: #666; font-size: 9pt;">Registered Members</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalReferred}</h3>
                                    <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consultant Breakdown -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</h3>
                            ${Object.keys(data.consultantStats).map(consultantName => {
                                const stats = data.consultantStats[consultantName];
                                return `
                                <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                    <p style="margin-bottom: 10px; color: #666;">
                                        <strong>Total:</strong> ${stats.totalClients} | 
                                        <strong>Members:</strong> ${stats.members} | 
                                        <strong>Referred:</strong> ${stats.referred}
                                    </p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                        <thead>
                                            <tr style="background: #e3f2fd;">
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${stats.clients.map((client, idx) => `
                                                <tr>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Products Dispensed -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üì¶ PRODUCTS DISPENSED TODAY</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                <thead>
                                    <tr style="background: #e8f5e9;">
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(data.productDispensed).map((product, idx) => `
                                        <tr>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                                ${product.quantity !== undefined ? 
                                                    `${product.quantity} units` : 
                                                    `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                            </td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Financial Summary -->
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.dp.toFixed(2)}</p>
                                    <p style="font-size: 9pt; color: #666;">Total BV: ${data.totalRevenue.bv}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.cp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.dp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.cp.toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                                <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // For preview (non-thermal), just return empty for now - modal will use direct content
            return '';
        }
        
        function printDailyStatementA4() {
            // Close modal first
            closeModal('dailyStatementModal');
            // Use the existing A4 print function logic
            printDailyStatement();
        }
        
        function printDailyStatementThermal() {
            // Close modal first
            closeModal('dailyStatementModal');
            
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${generateDailyStatementHTML(statementData, true)}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function printDailyStatement() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Create A4 print window with full statement
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${generateDailyStatementHTML(statementData, false)}
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #c41e3a; font-size: 9pt; color: #666;">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function toggleDispense(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (report && report.medicines && report.medicines[medIndex]) {
                const medicine = report.medicines[medIndex];
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                
                // For packages, check if all individual products are given
                if (isPackage) {
                    const packageProducts = price.products || [];
                    const allGiven = packageProducts.every(product => 
                        medicine.packageStatus && medicine.packageStatus[product] === 'given'
                    );
                    
                    if (!allGiven) {
                        alert('‚ö†Ô∏è Please mark all individual products as "Given" in the package before dispensing the entire package.');
                        return;
                    }
                }
                
                medicine.dispensed = !medicine.dispensed;
                
                // Update dispensed timestamp
                if (medicine.dispensed) {
                    medicine.dispensedBy = currentUser.fullName;
                    medicine.dispensedAt = new Date().toISOString();
                } else {
                    delete medicine.dispensedBy;
                    delete medicine.dispensedAt;
                    delete medicine.paid;
                    delete medicine.paidBy;
                    delete medicine.paidAt;
                    
                    // For packages, also reset individual product statuses
                    if (isPackage) {
                        const packageProducts = price.products || [];
                        packageProducts.forEach(product => {
                            if (medicine.packageStatus) {
                                medicine.packageStatus[product] = 'not_given';
                            }
                        });
                    }
                }
                
                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        // Update local data
                        const index = reports.findIndex(r => r.id === reportId);
                        if (index !== -1) {
                            reports[index] = report;
                        }
                        displayPrescriptions();
                        alert(`‚úÖ ${isPackage ? 'Package' : 'Medicine'} status updated successfully`);
                    } else {
                        console.error('Backend error:', result);
                        alert('Error updating prescription: ' + (result.error || result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            } else {
                alert('Report or medicine not found');
            }
        }

        async function togglePayment(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) {
                alert('Report or medicine not found');
                return;
            }
            
            const medicine = report.medicines[medIndex];
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            // If marking as paid, show payment details dialog
            if (!medicine.paid) {
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                let amount;
                
                if (isPackage) {
                    const packagePricing = calculatePackagePricing(medicine, client.membershipStatus);
                    amount = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                } else {
                    amount = client.membershipStatus === 'member' ? price.dp : price.cp;
                }
                
                // Show payment method selection
                const paymentMethod = prompt(`Payment for: ${medicine.name}\nAmount: N$${amount}\n\nEnter payment method:\n1 - Cash\n2 - Card\n3 - Mobile Money\n4 - Bank Transfer\n\nEnter number (1-4):`);
                
                if (!paymentMethod) return; // Cancelled
                
                const methods = { '1': 'Cash', '2': 'Card', '3': 'Mobile Money', '4': 'Bank Transfer' };
                const method = methods[paymentMethod] || 'Cash';
                
                // Initialize payment history if not exists
                if (!medicine.paymentHistory) {
                    medicine.paymentHistory = [];
                }
                
                // Add payment record
                medicine.paymentHistory.push({
                    amount: amount,
                    method: method,
                    paidBy: currentUser.fullName,
                    paidAt: new Date().toISOString(),
                    reference: 'PAY' + Date.now()
                });
                
                medicine.paid = true;
                medicine.paidBy = currentUser.fullName;
                medicine.paidAt = new Date().toISOString();
                medicine.paymentMethod = method;
                medicine.amountPaid = amount;
            } else {
                // Unpay - remove payment info
                medicine.paid = false;
                delete medicine.paidBy;
                delete medicine.paidAt;
                delete medicine.paymentMethod;
                delete medicine.amountPaid;
            }
            
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    const index = reports.findIndex(r => r.id === reportId);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                    displayPrescriptions();
                    if (medicine.paid) {
                        alert(`‚úÖ Payment recorded successfully\nMethod: ${medicine.paymentMethod}\nAmount: N$${medicine.amountPaid}`);
                    }
                } else {
                    console.error('Backend error:', result);
                    alert('Error updating payment: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error updating payment. Please try again.');
            }
        }

        function viewPaymentHistory(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) return;
            
            const medicine = report.medicines[medIndex];
            
            if (!medicine.paymentHistory || medicine.paymentHistory.length === 0) {
                alert('No payment history available for this item');
                return;
            }
            
            let historyHTML = `
                <div style="padding: 20px;">
                    <h3>Payment History: ${medicine.name}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Amount</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Method</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Received By</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Reference</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${medicine.paymentHistory.map(payment => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${new Date(payment.paidAt).toLocaleString('en-GB')}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">N$${payment.amount.toFixed(2)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.method}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.paidBy}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.reference}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="printPaymentReceipt('${reportId}', ${medIndex})">üßæ Print Receipt</button>
                    </div>
                </div>
            `;
            
            alert(historyHTML.replace(/<[^>]*>/g, '\\n').replace(/\\n+/g, '\\n'));
        }

        function printPaymentReceipt(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            const medicine = report.medicines[medIndex];
            
            if (!medicine || !medicine.paymentHistory) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Payment Receipt</title>
                    <style>
                        @page { size: 80mm auto; margin: 0; }
                        body { font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold; padding: 5mm; width: 80mm; }
                        .center { text-align: center; }
                        .divider { border-top: 1px dashed #000; margin: 6px 0; }
                    </style>
                </head>
                <body>
                    <div class="center" style="border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                        <div style="font-size: 12pt;">DYNAPHARM NAMIBIA</div>
                        <div style="font-size: 9pt;">PAYMENT RECEIPT</div>
                        <div style="font-size: 8pt;">${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    
                    <div style="margin: 8px 0; font-size: 9pt;">
                        <div>Client: ${client.fullName}</div>
                        <div>Report: ${report.id}</div>
                        <div>Product: ${medicine.name}</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    ${medicine.paymentHistory.map(payment => `
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Amount:</span>
                                <span>N$${payment.amount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Method:</span>
                                <span>${payment.method}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Ref:</span>
                                <span>${payment.reference}</span>
                            </div>
                            <div style="font-size: 8pt; margin-top: 3px;">
                                ${new Date(payment.paidAt).toLocaleString('en-GB')}
                            </div>
                        </div>
                    `).join('<div class="divider"></div>')}
                    
                    <div class="divider"></div>
                    
                    <div class="center" style="margin-top: 10px; font-size: 8pt;">
                        <div>HEALTH | WEALTH | FREEDOM</div>
                        <div>Thank you!</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function markDispensed(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (report) {
                report.dispensed = true;
                report.dispensedBy = currentUser.fullName;
                report.dispensedAt = new Date().toISOString();
                
                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        alert('‚úÖ Prescription marked as dispensed');
                displayPrescriptions();
                    } else {
                        alert('Error updating prescription: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            }
        }

        function showAddUser() {
            loadBranches();
            loadBranchCheckboxes();
            document.getElementById('addUserModal').style.display = 'block';
        }

        function loadBranchCheckboxes() {
            const branchCheckboxes = document.getElementById('branchCheckboxes');
            branchCheckboxes.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="additionalBranches" value="${branch.id}" style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                branchCheckboxes.appendChild(checkboxDiv);
            });
        }

        function toggleAdditionalBranches() {
            const roleSelect = document.querySelector('select[name="role"]');
            const additionalBranches = document.getElementById('additionalBranches');
            
            if (roleSelect.value === 'consultant') {
                additionalBranches.style.display = 'block';
            } else {
                additionalBranches.style.display = 'none';
                // Clear all checkboxes when not consultant
                const checkboxes = document.querySelectorAll('input[name="additionalBranches"]');
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Get selected additional branches for consultants
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="additionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));
            
            // Create branches array - primary branch + additional branches
            const allBranches = [formData.get('branch')];
            if (formData.get('role') === 'consultant') {
                additionalBranches.forEach(branchId => {
                    if (branchId !== formData.get('branch')) {
                        allBranches.push(branchId);
                    }
                });
            }
            
            const newUser = {
                id: 'USR' + Date.now(),
                username: formData.get('username'),
                password: formData.get('password'),
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                role: formData.get('role'),
                branch: formData.get('branch'),
                branches: allBranches,
                createdAt: new Date().toISOString()
            };
            
            if (users.find(u => u.username === newUser.username)) {
                alert('Username exists');
                return;
            }
            
            try {
                const result = await apiRequest('/users', 'POST', newUser);
                if (result.success) {
            users.push(newUser);
                    alert('‚úÖ User created successfully');
            closeModal('addUserModal');
            this.reset();
                    await refreshAllData();
                } else {
                    alert('Error creating user: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user. Please try again.');
            }
        });

        function loadUserList() {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(user => {
                const branchName = branches.find(b => b.id === user.branch)?.name || user.branch;
                const userBranches = user.branches || [user.branch];
                const branchNames = userBranches.map(branchId => 
                    branches.find(b => b.id === branchId)?.name || branchId
                ).join(', ');
                
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <h4>${user.fullName} (${user.username})</h4>
                    <p>Role: ${user.role} | Primary Branch: ${branchName}</p>
                    <p>All Branches: ${branchNames}</p>
                    <p>Email: ${user.email || 'Not provided'} | Phone: ${user.phone || 'Not provided'}</p>
                    <div style="margin-top: 10px;">
                        ${user.username !== 'admin' ? `
                            <button class="btn btn-warning" onclick="editUserBranches('${user.id}')" style="margin-right: 10px;">Edit Branches</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        ` : '<p style="color: #27ae60;">Protected</p>'}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function deleteUser(userId) {
            if (confirm('Delete user?')) {
                try {
                    const result = await apiRequest(`/users?id=${userId}`, 'DELETE');
                    if (result.success) {
                users = users.filter(u => u.id !== userId);
                        alert('‚úÖ User deleted successfully');
                        await refreshAllData();
                    } else {
                        alert('Error deleting user: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user. Please try again.');
                }
            }
        }

        let editingUserId = null;

        function editUserBranches(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            
            // Show user info
            document.getElementById('editUserInfo').innerHTML = `
                <h4>${user.fullName} (${user.username})</h4>
                <p>Role: ${user.role}</p>
            `;

            // Populate primary branch dropdown
            const primarySelect = document.getElementById('editPrimaryBranch');
            primarySelect.innerHTML = '<option value="">Select Primary Branch</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                if (branch.id === user.branch) {
                    option.selected = true;
                }
                primarySelect.appendChild(option);
            });

            // Populate additional branches checkboxes
            const checkboxesDiv = document.getElementById('editBranchCheckboxes');
            checkboxesDiv.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                
                const isChecked = user.branches && user.branches.includes(branch.id) && branch.id !== user.branch;
                
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="editAdditionalBranches" value="${branch.id}" ${isChecked ? 'checked' : ''} style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                checkboxesDiv.appendChild(checkboxDiv);
            });

            // Show/hide additional branches based on role
            if (user.role === 'consultant') {
                checkboxesDiv.style.display = 'block';
            } else {
                checkboxesDiv.style.display = 'none';
            }

            document.getElementById('editBranchesModal').style.display = 'block';
        }

        document.getElementById('editBranchesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (!editingUserId) return;

            const user = users.find(u => u.id === editingUserId);
            if (!user) return;

            // Get selected additional branches
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="editAdditionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));

            // Create branches array
            const allBranches = [formData.get('primaryBranch')];
            if (user.role === 'consultant') {
                additionalBranches.forEach(branchId => {
                    if (branchId !== formData.get('primaryBranch')) {
                        allBranches.push(branchId);
                    }
                });
            }

            // Update user
            const updatedUser = {
                ...user,
                branch: formData.get('primaryBranch'),
                branches: allBranches
            };

            try {
                const result = await apiRequest('/users', 'PUT', updatedUser);
                if (result.success) {
                    // Update local users array
                    const userIndex = users.findIndex(u => u.id === editingUserId);
                    if (userIndex !== -1) {
                        users[userIndex] = updatedUser;
                    }
                    
                    alert('‚úÖ User branches updated successfully');
                    closeModal('editBranchesModal');
                loadUserList();
                } else {
                    alert('Error updating user branches: ' + result.message);
            }
            } catch (error) {
                console.error('Error updating user branches:', error);
                alert('Error updating user branches. Please try again.');
        }
        });

        function showChangePassword() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (formData.get('currentPassword') !== currentUser.password) {
                alert('Current password incorrect');
                return;
            }
            
            if (formData.get('newPassword') !== formData.get('confirmPassword')) {
                alert('Passwords do not match');
                return;
            }
            
            currentUser.password = formData.get('newPassword');
            
            try {
                const result = await apiRequest('/users', 'PUT', currentUser);
                if (result.success) {
            const index = users.findIndex(u => u.id === currentUser.id);
            users[index] = currentUser;
                    alert('‚úÖ Password changed successfully');
            closeModal('changePasswordModal');
            this.reset();
                } else {
                    alert('Error changing password: ' + result.message);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password. Please try again.');
            }
        });

        async function addBranch() {
            const name = document.getElementById('newBranchName').value;
            if (!name) {
                alert('Enter branch name');
                return;
            }
            
            const branch = {
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name: name
            };
            
            try {
                const result = await apiRequest('/branches', 'POST', branch);
                if (result.success) {
            branches.push(branch);
            document.getElementById('newBranchName').value = '';
                    alert('‚úÖ Branch added successfully');
                    await refreshAllData();
                } else {
                    alert('Error adding branch: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding branch:', error);
                alert('Error adding branch. Please try again.');
            }
        }

        function loadBranchListAdmin() {
            const list = document.getElementById('branchList');
            list.innerHTML = '';
            branches.forEach(branch => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <h4>${branch.name}</h4>
                    <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')">Delete</button>
                `;
                list.appendChild(card);
            });
        }

        async function deleteBranch(branchId) {
            if (confirm('Delete branch?')) {
                try {
                    const result = await apiRequest(`/branches?id=${branchId}`, 'DELETE');
                    if (result.success) {
                branches = branches.filter(b => b.id !== branchId);
                        alert('‚úÖ Branch deleted successfully');
                        await refreshAllData();
                    } else {
                        alert('Error deleting branch: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting branch:', error);
                    alert('Error deleting branch. Please try again.');
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Global modal click handler (but don't interfere with login modal's specific handler)
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                // Don't close login modal with this handler - it has its own handler
                if (event.target.id !== 'loginModal') {
                    event.target.style.display = 'none';
                }
            }
        };

        window.onload = init;
    </script>
</body>
</html>