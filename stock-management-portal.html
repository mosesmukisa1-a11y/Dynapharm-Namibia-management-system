<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Dynapharm Stock Management Portal</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#0b1020; --card:#111831; --muted:#8aa0b5; --text:#e6eef7; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
        header { position: sticky; top:0; z-index:10; background: rgba(11,16,32,0.8); backdrop-filter: blur(8px); border-bottom: 1px solid #1e2a44; }
        .container { max-width: 1280px; margin: 0 auto; padding: 16px; }
        .top-bar { display:flex; align-items:center; justify-content: space-between; gap: 12px; }
        .brand { display:flex; align-items:center; gap:10px; }
        .logo img { display:block; height:32px; width:auto; }
        .title { font-weight:700; letter-spacing: .2px; }
        .filters { display:flex; flex-wrap: wrap; gap: 8px; align-items:center; }
        .select, .input { background: #0e162b; color: var(--text); border: 1px solid #223154; border-radius: 8px; padding: 8px 10px; }
        .grid { display:grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
        .card { background: var(--card); border: 1px solid #1e2a44; border-radius: 12px; padding: 14px; }
        .card h3 { margin: 0 0 8px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: .3px; }
        .kpis { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
        .kpi { background:#0f1830; border:1px solid #1e2a44; border-radius: 12px; padding: 12px; }
        .kpi .label { color: var(--muted); font-size: 12px; }
        .kpi .value { font-weight:700; font-size: 20px; margin-top: 6px; }
        .row { display:flex; gap: 12px; flex-wrap:wrap; }
        .table { width:100%; border-collapse: collapse; font-size: 13px; }
        .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #1e2a44; text-align: left; }
        .pill { display:inline-flex; align-items:center; gap:6px; padding: 2px 8px; border-radius:999px; font-size: 11px; border: 1px solid #263454; background:#0c142a; color: var(--muted); }
        .pill.good { color:#10b981; border-color:#0e7d5c; background: #0b1f1a; }
        .pill.warn { color:#f59e0b; border-color:#5a3d08; background: #211909; }
        .pill.bad { color:#ef4444; border-color:#5b1111; background:#1a0b0b; }
        .status { font-weight:600; }
        .status.success { color:#10b981; }
        .status.pending { color:#f59e0b; }
        .status.failed { color:#ef4444; }
        .list { display:flex; flex-direction:column; gap: 10px; }
        .movement { display:flex; justify-content:space-between; gap:12px; padding:10px; border:1px solid #1e2a44; border-radius:10px; background:#0f1830; }
        .movement .left { display:flex; gap:10px; align-items:center; }
        .badge { background:#0c142a; border:1px solid #263454; color:var(--muted); border-radius:6px; padding: 2px 6px; font-size: 11px; }
        .muted { color: var(--muted); }
        .danger { color: var(--danger); }
        .accent { color: var(--accent); }
        .btn { appearance:none; border:1px solid #1e2a44; background:#0f1830; color:var(--text); border-radius:8px; padding:8px 10px; cursor:pointer; }
        .btn.primary { background:#0f2a24; border-color:#0e7d5c; }
        .btn:disabled { opacity:.6; cursor:not-allowed; }
        .split-6-6 { grid-column: span 12; display:grid; gap:12px; grid-template-columns: repeat(12,1fr); }
        .col-6 { grid-column: span 12; }
        @media(min-width: 980px){ .col-6 { grid-column: span 6; } .split-6-6 { grid-column: span 12; } }
        .footer { color: var(--muted); font-size: 12px; padding: 16px; text-align:center; }
        .workflow-tabs { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
        .workflow-tab { background:#0e162b; border:1px solid #223154; border-radius:999px; padding:8px 14px; color:var(--muted); font-weight:600; cursor:pointer; transition:background .2s ease, border-color .2s ease, color .2s ease; }
        .workflow-tab:hover { border-color: var(--accent); color: var(--text); }
        .workflow-tab.active { background: var(--accent); border-color: var(--accent); color:#04121b; }
        .workflow-section { display:none; }
        .workflow-section.active { display:block; }
        .workflow-section > *:last-child { margin-bottom:0 !important; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 8px !important; }
            .container { padding: 12px !important; }
            header { position: relative; }
            .top-bar { flex-direction: column !important; align-items: stretch !important; gap: 10px !important; }
            .title { font-size: 0.9rem !important; }
            .filters { flex-direction: column !important; gap: 8px !important; }
            .select, .input, .btn { 
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
                padding: 10px !important;
            }
            .kpis { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
            .kpi { padding: 10px !important; }
            .kpi .value { font-size: 1.3rem !important; }
            .grid { gap: 12px !important; }
            .card { padding: 12px !important; }
            .card h3 { font-size: 13px !important; }
            .table { 
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                font-size: 0.8rem;
            }
            .table th, .table td { 
                padding: 6px 4px !important;
                font-size: 0.75rem !important;
            }
            thead { display: table-header-group; }
            tbody { display: table-row-group; }
            thead th { position: sticky; top: 0; background: var(--card); z-index: 1; border-bottom: 1px solid #1e2a44; }
            .list { gap: 8px !important; }
            .movement { padding: 8px !important; }
        }
        
        @media (max-width: 480px) {
            .title { font-size: 0.8rem !important; }
            .kpis { grid-template-columns: 1fr !important; }
            .kpi .value { font-size: 1.1rem !important; }
            .table th, .table td { 
                padding: 5px 3px !important;
                font-size: 0.7rem !important;
            }
        }
        
        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            .btn { min-height: 44px; }
            * { -webkit-tap-highlight-color: rgba(16, 185, 129, 0.2); }
        }
    </style>
    <script defer src="./cloud-sync.js"></script>
    <script defer src="./auto-cloud-sync.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <header>
        <div class="container top-bar">
            <div class="brand">
                <div class="logo"><img src="./assets/dynapharm-logo.png" alt="Dynapharm Namibia Logo"></div>
                <div class="title">üì¶ Dynapharm Stock Management Portal</div>
            </div>
            <div class="filters">
                <select id="branchFilter" class="select">
                    <option value="all">All Branches</option>
                </select>
                <select id="warehouseFilter" class="select">
                    <option value="all">All Warehouses</option>
                    <option value="warehouse-windhoek">Warehouse Windhoek</option>
                    <option value="warehouse-ondangwa">Warehouse Ondangwa</option>
                </select>
                <select id="productFilter" class="select">
                    <option value="all">All Products</option>
                </select>
                <select id="dateRange" class="select">
                    <option value="today">Today</option>
                    <option value="week">Last 7 days</option>
                    <option value="month">Last 30 days</option>
                </select>
                <input id="searchBox" class="input" placeholder="Search product / request / invoice" />
                <button id="refreshBtn" class="btn">Refresh</button>
                <button id="printBtn" class="btn">Print</button>
                <button id="exportBtn" class="btn">Export CSV</button>
                <button id="helpBtnGlobal" class="btn">Help</button>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 18px;">
        <nav class="workflow-tabs" aria-label="Stock workflow navigation">
            <button class="workflow-tab active" data-workflow-target="workflow-overview">üìä Overview</button>
            <button class="workflow-tab" data-workflow-target="workflow-country-import">üì• Country Import</button>
            <button class="workflow-tab" data-workflow-target="workflow-warehouse-distribution">üè¢ Warehouse Distribution</button>
            <button class="workflow-tab" data-workflow-target="workflow-branch-distribution">üè¨ Branch Distribution</button>
            <button class="workflow-tab" data-workflow-target="workflow-transfers">üîÑ Transfers</button>
            <button class="workflow-tab" data-workflow-target="workflow-sharing">ü§ù Sharing</button>
            <button class="workflow-tab" data-workflow-target="workflow-orders">üìã Orders</button>
            <button class="workflow-tab" data-workflow-target="workflow-invoices">üßæ Invoices</button>
            <button class="workflow-tab" data-workflow-target="workflow-country-inventory">üåç Country Inventory</button>
            <button class="workflow-tab" data-workflow-target="workflow-realtime">‚ö° Real-time</button>
        </nav>

        <div class="workflow-section active" id="workflow-overview">
            <section class="kpis" style="margin-bottom: 14px;">
                <div class="kpi"><div class="label">Total Stock Value</div><div id="kpiTotalValue" class="value">‚Äî</div></div>
                <div class="kpi"><div class="label">Pending Transfers</div><div id="kpiPendingTransfers" class="value">‚Äî</div></div>
                <div class="kpi"><div class="label">Low Stock Items</div><div id="kpiLowStock" class="value">‚Äî</div></div>
                <div class="kpi"><div class="label">Alerts Today</div><div id="kpiAlerts" class="value">‚Äî</div></div>
            </section>

            <section class="grid" style="margin-bottom: 14px;">
                <div class="card" style="grid-column: span 12;">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Real-time Stock Movements <button class="btn" data-help="dashboard">Help</button></h3>
                    <div id="movementsList" class="list"></div>
                </div>
            </section>

            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Alerts & Notifications <button class="btn" data-help="dashboard">Help</button></h3>
                <div id="alertsList" class="list"></div>
            </section>
        </div>

        <div class="workflow-section" id="workflow-country-import">
            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Quick Actions <button class="btn" data-help="requests">Help</button></h3>
                <div class="row">
                    <button class="btn primary" id="qaNewRequest">‚ûï New Stock Request</button>
                    <button class="btn" id="qaImportBarcode">üì• Import Barcode Stock (CSV)</button>
                    <button class="btn" id="qaViewAudit">üßæ View Audit Log</button>
                </div>
            </section>

            <section class="card" style="margin-bottom: 14px;">
                <h3>Country Stock Import Workflow</h3>
                <p class="muted">Import batches with FEFO enforcement and barcode tracking. Load cartons from CSV, validate expiries, and refresh to see totals update instantly.</p>
                <div class="row">
                    <button class="btn primary" id="countryImportLaunchBtn">üì• Launch CSV Import</button>
                    <button class="btn" id="countryImportTemplateBtn">‚¨áÔ∏è Download CSV Template</button>
                    <button class="btn" id="countryImportGuideBtn">üìò Import Guide</button>
                    <button class="btn" id="productLabelsBtn">üè∑Ô∏è Generate Product Labels</button>
                </div>
                <div class="muted" style="font-size:12px; margin-top:8px;">Headers accepted: cartonNo, description, batchNo, expiryDate, quantity, totalCtns (aliases allowed). Expiry formats like "Aug-2027" are supported.</div>
            </section>
        </div>

        <div class="workflow-section" id="workflow-warehouse-distribution">
            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Pending Stock Requests <button class="btn" data-help="roles">Help</button></h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Request #</th>
                            <th>Branch</th>
                            <th>Status</th>
                            <th>Return Date</th>
                            <th>Age</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="pendingRequests"></tbody>
                </table>
            </section>

            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Warehouse & Country Stock Snapshot <button class="btn" data-help="warehouse">Help</button></h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Product</th>
                            <th>Total Qty</th>
                            <th>Available to Move</th>
                            <th>Reserved</th>
                            <th>Batch Info</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="warehouseSnapshot"></tbody>
                </table>
            </section>
        </div>

        <div class="workflow-section" id="workflow-branch-distribution">
            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Daily Stock Movements by Branch <button class="btn" data-help="dashboard">Help</button></h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Branch</th>
                            <th>Stock In</th>
                            <th>Stock Out</th>
                            <th>Invoices</th>
                        </tr>
                    </thead>
                    <tbody id="dailyByBranch"></tbody>
                </table>
            </section>

            <section class="card" style="margin-bottom: 14px;">
                <h3>Distribution Playbook</h3>
                <p class="muted">Monitor daily in/out volumes, align dispatches with branch requests, and confirm FEFO compliance before releasing stock to coaches and consultants.</p>
            </section>
        </div>

        <div class="workflow-section" id="workflow-transfers">
            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Active Transfers <button class="btn" data-help="transfers">Help</button></h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Request #</th>
                            <th>From ‚Üí To</th>
                            <th>Status</th>
                            <th>Note</th>
                            <th>Age</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="activeTransfers"></tbody>
                </table>
            </section>
        </div>

        <div class="workflow-section" id="workflow-sharing">
            <section class="card" style="margin-bottom: 14px;">
                <h3>Shop & Warehouse Sharing</h3>
                <p class="muted">Coordinate shared stock pools between retail outlets and warehouses. This dashboard will surface allocation requests and approvals once the sharing workflow is finalised.</p>
            </section>
        </div>

        <div class="workflow-section" id="workflow-orders">
            <section class="card" style="margin-bottom: 14px;">
                <h3>Orders (Auto & Manual)</h3>
                <p class="muted">Auto-generated purchase orders and manual supplier requests will display here. Use the country import workflow to seed stock while integrations are being connected.</p>
            </section>
        </div>

        <div class="workflow-section" id="workflow-invoices">
            <section class="card" style="margin-bottom: 14px;">
                <h3>Invoices</h3>
                <p class="muted">Invoice tracking ties into stock releases and deliveries. Export the latest snapshot or integrate with ERP to keep accounts reconciled.</p>
            </section>
        </div>

        <div class="workflow-section" id="workflow-country-inventory">
            <section class="card" style="margin-bottom: 14px;">
                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:8px;">Workflow Status <button class="btn" data-help="roles">Help</button></h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="workflowStatus"></tbody>
                </table>
            </section>
        </div>

        <div class="workflow-section" id="workflow-realtime">
            <section class="card" style="margin-bottom: 14px;">
                <h3>Real-time Sync & Controls</h3>
                <p class="muted">Data auto-refreshes every 20 seconds. Use the manual controls below if you need to force updates, export a snapshot, or review workflow guidance.</p>
                <div class="row">
                    <button class="btn" id="workflowRefreshBtn">üîÑ Refresh Data</button>
                    <button class="btn" id="workflowExportBtn">üì§ Export CSV</button>
                    <button class="btn" id="workflowHelpBtn">‚ùì Workflow Help</button>
                </div>
            </section>
        </div>
    </main>

    <div class="footer">Dynapharm Namibia ‚Ä¢ Stock Management ‚Ä¢ v1</div>

    <!-- Toasts -->
    <div id="toastContainer" style="position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:60;"></div>

    <!-- Help Modal -->
    <div id="helpModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50;">
        <div style="width:min(920px,94vw); max-height:84vh; overflow:auto; background: var(--card); border:1px solid #1e2a44; border-radius:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1e2a44;">
                <div id="helpModalTitle" style="font-weight:700;">Workflow Help</div>
                <div>
                    <button id="helpCloseBtn" class="btn">Close</button>
                </div>
            </div>
            <div id="helpModalBody" style="padding:12px 14px; font-size:14px; line-height:1.5;"></div>
        </div>
    </div>

    <!-- Dispatch Details Modal -->
    <div id="dispatchModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:55;">
        <div style="width:min(760px,94vw); max-height:84vh; overflow:auto; background: var(--card); border:1px solid #1e2a44; border-radius:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1e2a44;">
                <div style="font-weight:700;">Dispatch Details</div>
                <div><button id="dispatchCloseBtn" class="btn">Close</button></div>
            </div>
            <div style="padding:12px 14px;">
                <div id="dispatchMeta" class="muted" style="margin-bottom:8px;"></div>
                <div id="dispatchNote" style="margin-bottom:10px;"></div>
                <table class="table">
                    <thead><tr><th>Product</th><th>Qty</th></tr></thead>
                    <tbody id="dispatchItems"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dispatch Note Modal -->
    <div id="dispatchNoteModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:58;">
        <div style="width:min(820px,94vw); max-height:88vh; overflow:auto; background:#f8fafc; color:#1e293b; border-radius:12px; border:1px solid #cbd5f5; box-shadow:0 20px 45px rgba(15,23,42,0.35);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #cbd5f5; background:#e0e7ff;">
                <div style="font-weight:700; font-size:18px;">Dispatch Note</div>
                <div style="display:flex; gap:8px;">
                    <button id="dispatchNotePrintBtn" class="btn" style="background:#0f172a; color:#f8fafc; border:none;">Print</button>
                    <button id="dispatchNoteCloseBtn" class="btn">Close</button>
                </div>
            </div>
            <div id="dispatchNoteContent" style="padding:20px; font-size:14px; line-height:1.6; background:#ffffff;"></div>
        </div>
    </div>

    <!-- Create Request Modal -->
    <div id="requestModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:56;">
        <div style="width:min(680px,94vw); background: var(--card); border:1px solid #1e2a44; border-radius:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1e2a44;">
                <div style="font-weight:700;">New Stock Request</div>
                <div><button id="requestCloseBtn" class="btn">Close</button></div>
            </div>
            <div style="padding:12px 14px; display:grid; gap:10px;">
                <div class="row">
                    <select id="reqBranch" class="select"></select>
                    <select id="reqType" class="select">
                        <option value="sales_replenishment">Sales Replenishment</option>
                        <option value="internal">Internal</option>
                    </select>
                    <select id="reqPriority" class="select">
                        <option value="normal">Normal</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="row">
                    <input id="reqProduct" class="input" placeholder="Product (name or ID)" />
                    <input id="reqQty" type="number" class="input" placeholder="Qty" />
                </div>
                <div class="row">
                    <label style="display:flex; flex-direction:column; gap:6px; flex:1; font-size:12px; color:var(--muted);">
                        Return / Required By Date
                        <input id="reqReturnDate" type="date" class="input" />
                    </label>
                </div>
                <textarea id="reqNotes" class="input" placeholder="Notes" style="min-height:80px;"></textarea>
                <div style="text-align:right;">
                    <button id="reqSubmitBtn" class="btn primary">Create Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:57;">
        <div style="width:min(720px,94vw); background: var(--card); border:1px solid #1e2a44; border-radius:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1e2a44;">
                <div style="font-weight:700;">Import Stock From CSV</div>
                <div><button id="csvCloseBtn" class="btn">Close</button></div>
            </div>
            <div style="padding:12px 14px; display:grid; gap:10px;">
                <div class="muted">Required headers (aliases allowed):
                    cartonNo / Cartons No., description, batchNo, expiryDate / Expired Date, quantity / Qty, totalCtns / Total (CTNS). Expiry like "Aug-2027" is accepted.</div>
                <select id="csvImportLocation" class="select">
                    <option value="country_stock">Country Stock (Default)</option>
                    <option value="warehouse-windhoek">Warehouse Windhoek</option>
                    <option value="warehouse-ondangwa">Warehouse Ondangwa</option>
                </select>
                <input type="file" id="csvFileInput" accept=".csv" class="input" />
                <div id="csvPreview" class="muted" style="font-size:12px; max-height:180px; overflow:auto; border:1px dashed #223154; border-radius:8px; padding:8px; display:none;"></div>
                <div style="text-align:right;">
                    <button id="csvImportBtn" class="btn primary" disabled>Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Request Modal -->
    <div id="reviewModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:57;">
        <div style="width:min(760px,94vw); max-height:86vh; overflow:auto; background: var(--card); border:1px solid #1e2a44; border-radius:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1e2a44;">
                <div style="font-weight:700;">Review Stock Request</div>
                <div><button id="reviewCloseBtn" class="btn">Close</button></div>
            </div>
            <div style="padding:12px 14px; display:grid; gap:12px;">
                <div class="muted" style="font-size:12px;">Stock manager can adjust items before forwarding to GM for approval.</div>
                <div id="reviewMeta" class="muted" style="font-size:12px;"></div>
                <div style="overflow:auto;">
                    <table class="table" style="width:100%; min-width:520px;">
                        <thead>
                            <tr>
                                <th style="width:45%;">Product</th>
                                <th style="width:20%;">Qty</th>
                                <th style="width:20%;">Unit</th>
                                <th style="width:15%;"></th>
                            </tr>
                        </thead>
                        <tbody id="reviewItemsBody"></tbody>
                    </table>
                </div>
                <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                    <button id="reviewAddItemBtn" class="btn">Add Item</button>
                    <div style="display:flex; gap:8px;">
                        <button id="reviewSaveBtn" class="btn primary">Save Changes</button>
                        <button id="reviewForwardBtn" class="btn" style="border-color:#0e7d5c;">Forward to GM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Labels Modal -->
    <div id="productLabelsModal" style="position:fixed; inset:0; background: rgba(9,13,24,0.7); display:none; align-items:center; justify-content:center; z-index:60;">
        <div style="width:min(900px,94vw); max-height:90vh; overflow:auto; background:#ffffff; color:#1e293b; border-radius:12px; border:1px solid #cbd5f5; box-shadow:0 24px 55px rgba(15,23,42,0.35);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #cbd5f5; background:#e0e7ff;">
                <div style="font-weight:700; font-size:18px;">Generate Product Labels</div>
                <div style="display:flex; gap:8px;">
                    <button id="productLabelsPrintBtn" class="btn" style="background:#0f172a; color:#f8fafc; border:none;">Print Labels</button>
                    <button id="productLabelsCloseBtn" class="btn">Close</button>
                </div>
            </div>
            <div style="padding:18px 20px; display:grid; gap:18px;">
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
                    <label style="display:flex; flex-direction:column; gap:6px; font-size:12px; color:#475569;">
                        Select Product
                        <select id="productLabelSelect" class="select" style="min-width:220px; color:#0f172a; border-color:#cbd5f5; background:#f8fafc;"></select>
                    </label>
                    <label style="display:flex; flex-direction:column; gap:6px; font-size:12px; color:#475569;">
                        Quantity
                        <input id="productLabelQty" type="number" class="input" value="1" min="1" max="200" style="min-width:120px; color:#0f172a; border-color:#cbd5f5; background:#f8fafc;" />
                    </label>
                    <button id="productLabelAddBtn" class="btn primary">Add to Labels</button>
                </div>
                <div id="productLabelsSummary" style="font-size:12px; color:#475569;">Add products to generate printable barcode labels.</div>
                <div id="productLabelsGrid" style="display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { refreshStockData, getStockRequests, getStockTransfers, getWarehouseStock, getWarehouses, getStockStatistics, approveStockRequest, updateTransferStatus, createStockRequest, updateStockRequest, forwardStockRequestToGM, getDispatchNotes } from './web-modules/stock-api.js';
        import { importStockWithBarcode, getBarcodeStockStatistics } from './web-modules/barcode-stock.js';
        import { getProducts } from './web-modules/products.js';

        // Simple invoice number generator SRQ already exists; we add INV
        function generateInvoiceNumber(branchId) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            const rand = String(Math.floor(Math.random()*10000)).padStart(4,'0');
            return `INV-${branchId?.toUpperCase()||'ALL'}-${y}${m}${d}-${rand}`;
        }

        // State
        let branches = [];
        let products = [];
        let movements = [];
        let alerts = [];
        let csvParsedRows = [];
        let latestDispatchNote = null;
        let productLabelItems = [];
        const currentUser = (window.parent && window.parent.currentUser) ? window.parent.currentUser : null;
        const currentRole = (currentUser && currentUser.role) ? currentUser.role.toLowerCase() : '';
        const reviewModal = document.getElementById('reviewModal');
        const productLabelsModal = document.getElementById('productLabelsModal');
        const productLabelsGrid = document.getElementById('productLabelsGrid');

        async function loadBranches() {
            const isStaticHost = (location.hostname.endsWith('github.io') || location.protocol === 'file:');
            if (isStaticHost) {
                try {
                    const fromLS = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
                    branches = Array.isArray(fromLS) ? fromLS : [];
                } catch(err) {
                    branches = [];
                }
            } else {
                try {
                    // Try backend API first when running on a server
                    const resp = await fetch('/api/branches');
                    if (resp.ok) {
                        const apiResp = await resp.json();
                        branches = Array.isArray(apiResp) ? apiResp : (apiResp.branches || []);
                    }
                } catch (_) {
                    /* ignore and fallback below */
                }
                if (!Array.isArray(branches) || branches.length === 0) {
                    try {
                        const fromLS = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
                        branches = Array.isArray(fromLS) ? fromLS : [];
                    } catch(err) {
                        branches = [];
                    }
                }
            }
            const sel = document.getElementById('branchFilter');
            branches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id; opt.textContent = b.name || b.id; sel.appendChild(opt);
            });
        }

        async function loadProducts() {
            // Try products API (localStorage driven)
            try {
                const res = getProducts({});
                if (res?.success) {
                    products = res.data;
                }
            } catch(e) { /* ignore */ }
            // Fallback to parent PRICE_LIST if available
            if ((!products || products.length === 0) && window.parent && Array.isArray(window.parent.PRICE_LIST)) {
                products = window.parent.PRICE_LIST.map(p => ({ id: p.description, name: p.description, dp: p.dp, cp: p.cp, bv: p.bv }));
            }
            // Populate filter
            const sel = document.getElementById('productFilter');
            products.slice(0, 2000).forEach(p => {
                const opt = document.createElement('option');
                opt.value = (p.id || p.name || '').toString();
                opt.textContent = p.name || p.description || p.id;
                sel.appendChild(opt);
            });
        }

        function pushAlert(type, message, meta={}) {
            alerts.unshift({ id: 'ALT'+Date.now()+Math.random(), type, message, meta, ts: new Date().toISOString() });
            if (alerts.length > 100) alerts.pop();
        }

        function renderAlerts() {
            const list = document.getElementById('alertsList');
            list.innerHTML = '';
            alerts.slice(0, 30).forEach(a => {
                const div = document.createElement('div');
                div.className = 'movement';
                const color = a.type === 'danger' ? 'bad' : (a.type === 'warn' ? 'warn' : 'good');
                div.innerHTML = `
                    <div class="left">
                        <span class="pill ${color}">${a.type.toUpperCase()}</span>
                        <div>
                            <div>${a.message}</div>
                            <div class="muted" style="font-size:11px;">${new Date(a.ts).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="badge">${a.meta?.branch||'‚Äî'}</div>
                `;
                list.appendChild(div);
            });
            document.getElementById('kpiAlerts').textContent = String(alerts.filter(a => new Date(a.ts).toDateString() === new Date().toDateString()).length);
        }

        function renderMovements() {
            const list = document.getElementById('movementsList');
            list.innerHTML = '';
            movements.slice(0, 100).forEach(m => {
                const div = document.createElement('div');
                div.className = 'movement';
                div.innerHTML = `
                    <div class="left">
                        <span class="badge">${m.type}</span>
                        <div>
                            <div><span class="accent">${m.product||m.requestNumber}</span> ‚Ä¢ ${m.qty?('Qty '+m.qty):''}</div>
                            <div class="muted" style="font-size:11px;">${new Date(m.ts).toLocaleString()} ‚Ä¢ ${m.source||m.from||'‚Äî'} ‚Üí ${m.dest||m.to||'‚Äî'}</div>
                        </div>
                    </div>
                    <div class="badge">${m.branch||m.to||'‚Äî'}</div>
                `;
                list.appendChild(div);
            });
        }

        async function renderKpis() {
            try {
                const stats = getStockStatistics();
                const barcodeStats = getBarcodeStockStatistics();
                if (stats?.success) {
                    document.getElementById('kpiPendingTransfers').textContent = stats.data.pendingTransfers;
                    document.getElementById('kpiLowStock').textContent = stats.data.lowStockProducts;
                }
                if (barcodeStats?.success) {
                    document.getElementById('kpiTotalValue').textContent = 'N$ ' + Number(barcodeStats.data.totalStockValue).toLocaleString();
                }
            } catch(e) {
                // noop
            }
        }

        async function renderWarehouseSnapshot() {
            const tbody = document.getElementById('warehouseSnapshot');
            tbody.innerHTML = '';
            
            // Get barcode stock data
            let barcodeStock = [];
            try {
                const stored = localStorage.getItem('dyna_barcode_stock');
                if (stored) {
                    barcodeStock = JSON.parse(stored);
                }
            } catch(e) {
                console.error('Error loading barcode stock:', e);
            }
            
            // Aggregate stock by location and product
            const stockMap = new Map();
            
            // Process warehouse stock (from shared API)
            const warehouses = getWarehouses();
            warehouses.forEach(warehouse => {
                const res = getWarehouseStock(warehouse.id);
                if (res?.success) {
                    const stock = res.data;
                    Object.keys(stock).forEach(pid => {
                        const s = stock[pid];
                        const key = `${warehouse.id}|||${pid}`;
                        if (!stockMap.has(key)) {
                            stockMap.set(key, {
                                locationId: warehouse.id,
                                location: warehouse.name || warehouse.id,
                                product: pid,
                                totalQty: 0,
                                availableQty: 0,
                                reservedQty: 0,
                                reorderLevel: s.reorderLevel || 10,
                                batchInfo: '',
                                isBarcode: false
                            });
                        }
                        const entry = stockMap.get(key);
                        const quantity = Number(s.quantity || 0);
                        const reserved = Number(s.reservedQuantity || 0);
                        const available = s.availableQuantity !== undefined ? Number(s.availableQuantity || 0) : Math.max(0, quantity - reserved);
                        entry.totalQty += quantity;
                        entry.availableQty += available;
                        entry.reservedQty += reserved;
                    });
                }
            });
            
            // Process country stock (barcode stock with location='country_stock')
            const countryStockBatches = barcodeStock.filter(b => 
                b.location === 'country_stock' && 
                b.status === 'available' && 
                b.remainingQuantity > 0
            );
            
            // Aggregate country stock by product
            const countryStockMap = new Map();
            countryStockBatches.forEach(batch => {
                const pid = batch.description || batch.productId || 'Unknown';
                const key = `country_stock|||${pid}`;
                if (!countryStockMap.has(key)) {
                    countryStockMap.set(key, {
                        location: 'Country Stock',
                        product: pid,
                        totalQty: 0,
                        availableQty: 0,
                        reservedQty: 0,
                        reorderLevel: 10,
                        batchInfo: '',
                        batches: [],
                        isBarcode: true
                    });
                }
                const entry = countryStockMap.get(key);
                entry.totalQty += (batch.quantity || 0);
                entry.availableQty += (batch.remainingQuantity || 0);
                entry.batches.push({
                    batchNo: batch.batchNo || '',
                    expiryDate: batch.expiryDate || '',
                    remainingQty: batch.remainingQuantity || 0
                });
            });
            
            // Add country stock to map
            countryStockMap.forEach((entry, key) => {
                const batchInfo = entry.batches.length > 0 
                    ? `${entry.batches.length} batch${entry.batches.length > 1 ? 'es' : ''} (Earliest: ${entry.batches[0].expiryDate})`
                    : 'No batches';
                entry.batchInfo = batchInfo;
                stockMap.set(key, entry);
            });
            
            // Process warehouse barcode stock
            ['warehouse-windhoek','warehouse-ondangwa'].forEach(wh => {
                const whBatches = barcodeStock.filter(b => 
                    b.location === wh && 
                    b.status === 'available' && 
                    b.remainingQuantity > 0
                );
                
                // Aggregate by product
                const whStockMap = new Map();
                whBatches.forEach(batch => {
                    const pid = batch.description || batch.productId || 'Unknown';
                    const key = `${wh}|||${pid}`;
                    if (!whStockMap.has(key)) {
                        whStockMap.set(key, {
                            location: wh,
                            product: pid,
                            totalQty: 0,
                            availableQty: 0,
                            reservedQty: 0,
                            reorderLevel: 10,
                            batchInfo: '',
                            batches: [],
                            isBarcode: true
                        });
                    }
                    const entry = whStockMap.get(key);
                    entry.totalQty += (batch.quantity || 0);
                    entry.availableQty += (batch.remainingQuantity || 0);
                    entry.batches.push({
                        batchNo: batch.batchNo || '',
                        expiryDate: batch.expiryDate || '',
                        remainingQty: batch.remainingQuantity || 0
                    });
                });
                
                // Merge with existing warehouse stock
                whStockMap.forEach((entry, key) => {
                    if (stockMap.has(key)) {
                        const existing = stockMap.get(key);
                        existing.totalQty += entry.totalQty;
                        existing.availableQty += entry.availableQty;
                        existing.reservedQty += entry.reservedQty;
                        if (entry.batches.length > 0) {
                            existing.batches = (existing.batches || []).concat(entry.batches);
                            existing.batchInfo = `${existing.batches.length} batch${existing.batches.length > 1 ? 'es' : ''}`;
                        }
                    } else {
                        entry.batchInfo = entry.batches.length > 0 
                            ? `${entry.batches.length} batch${entry.batches.length > 1 ? 'es' : ''}`
                            : '';
                        stockMap.set(key, entry);
                    }
                });
            });
            
            // Render all stock entries
            const sortedEntries = Array.from(stockMap.values()).sort((a, b) => {
                // Sort by location (country first, then warehouses)
                if (a.location === 'Country Stock' && b.location !== 'Country Stock') return -1;
                if (a.location !== 'Country Stock' && b.location === 'Country Stock') return 1;
                if (a.location < b.location) return -1;
                if (a.location > b.location) return 1;
                // Then by product name
                return (a.product || '').localeCompare(b.product || '');
            });
            
            sortedEntries.forEach(entry => {
                const status = entry.availableQty <= entry.reorderLevel ? 'LOW' :
                              (entry.availableQty > entry.reorderLevel*10 ? 'OVER' : 'OK');
                const color = status==='LOW'?'bad':(status==='OVER'?'warn':'good');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${entry.location}</td>
                    <td>${entry.product}</td>
                    <td>${entry.totalQty}</td>
                    <td><strong class="accent">${entry.availableQty}</strong></td>
                    <td>${entry.reservedQty}</td>
                    <td class="muted" style="font-size:11px;">${entry.batchInfo || '‚Äî'}</td>
                    <td><span class="pill ${color}">${status}</span></td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show empty state if no stock
            if (sortedEntries.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" style="text-align:center; color:var(--muted); padding:20px;">No stock data available. Import stock to get started.</td>`;
                tbody.appendChild(tr);
            }
        }

        function detectSuspicious(m) {
            // Simple rules: unusually large qty, rapid repeated outs, negative stock transitions
            if (m.qty && m.qty > 500) {
                pushAlert('danger', `Unusually large movement of ${m.product||'item'}: ${m.qty}`, { branch: m.branch||m.to||'‚Äî' });
            }
            if (m.type === 'STOCK-OUT' && m.qty && m.qty > 200) {
                pushAlert('warn', `High stock-out: ${m.qty} ‚Ä¢ ${m.product||''}`, { branch: m.branch||m.to||'‚Äî' });
            }
        }

        async function refreshData() {
            const branch = document.getElementById('branchFilter').value;
            const wh = document.getElementById('warehouseFilter').value;
            const range = document.getElementById('dateRange').value;
            const search = document.getElementById('searchBox').value.trim().toLowerCase();
            const productFilter = document.getElementById('productFilter').value;

            await refreshStockData();

            // Transfers and requests
            const { data: transfers = [] } = getStockTransfers({ status: 'all', toBranch: branch==='all'?undefined:branch, fromWarehouse: wh==='all'?undefined:wh }) || { data: [] };
            const { data: requests = [] } = getStockRequests({ branch: branch }) || { data: [] };

            // Build movement events
            const now = new Date();
            const since = new Date(now);
            if (range === 'week') since.setDate(now.getDate()-7); else if (range === 'month') since.setDate(now.getDate()-30); else since.setHours(0,0,0,0);

            const items = [];
            transfers.forEach(t => {
                const tDate = new Date(t.createdAt || t.dispatchedAt || t.deliveredAt || t.receivedAt || t.createdAt);
                if (tDate >= since) {
                    items.push({ type:'TRANSFER', requestNumber: t.requestNumber, from: t.fromWarehouse, to: t.toBranch, ts: tDate.toISOString(), branch: t.toBranch });
                }
            });
            requests.forEach(r => {
                const rDate = new Date(r.createdAt);
                if (rDate >= since) {
                    items.push({ type:'REQUEST', requestNumber: r.requestNumber, source: r.requestingBranch, ts: rDate.toISOString(), branch: r.requestingBranch });
                }
            });

            // Include barcode batch dispatch/sales from localStorage if present
            try {
                const barcodeStore = JSON.parse(localStorage.getItem('dyna_barcode_stock')||'[]');
                barcodeStore.forEach(b => {
                    if (Array.isArray(b.dispatches)) {
                        b.dispatches.forEach(d => {
                            const dDate = new Date(d.dispatchDate);
                            if (dDate >= since) {
                                items.push({ type:'STOCK-OUT', product: b.description, qty: d.quantity, to: d.toBranch, ts: dDate.toISOString(), branch: d.toBranch });
                                detectSuspicious({ type:'STOCK-OUT', product:b.description, qty:d.quantity, to:d.toBranch, branch:d.toBranch });
                            }
                        });
                    }
                });
            } catch(e) {}

            // Filter by search and product
            const filtered = items.filter(i => {
                if (!search) return true;
                return [i.type, i.product, i.requestNumber, i.from, i.to, i.branch].filter(Boolean).join(' ').toLowerCase().includes(search);
            }).filter(i => {
                if (!productFilter || productFilter === 'all') return true;
                return (i.product || '').toString().toLowerCase().includes(productFilter.toString().toLowerCase());
            }).sort((a,b)=> new Date(b.ts) - new Date(a.ts));

            movements = filtered;
            renderMovements();
            renderKpis();
            renderAlerts();
            renderWarehouseSnapshot();
            renderDailyBranch();
            renderWorkflowStatus();
            renderPendingRequestsTable();
            renderActiveTransfersTable();
        }

        function summarizeByBranch(items) {
            const map = {};
            items.forEach(i => {
                const key = i.branch || i.to || i.source || 'unknown';
                if (!map[key]) map[key] = { in:0, out:0, invoices: new Set() };
                if (i.type==='TRANSFER' || i.type==='REQUEST') {
                    map[key].in += 0; // summarized via stock movements
                    if (i.requestNumber) map[key].invoices.add(i.requestNumber);
                }
                if (i.type==='STOCK-OUT') {
                    map[key].out += Number(i.qty||0);
                    map[key].invoices.add(generateInvoiceNumber(key));
                }
            });
            return map;
        }

        function renderDailyBranch() {
            const tbody = document.getElementById('dailyByBranch');
            tbody.innerHTML = '';
            const todayItems = movements.filter(m => new Date(m.ts).toDateString() === new Date().toDateString());
            const map = summarizeByBranch(todayItems);
            Object.keys(map).forEach(branch => {
                const row = map[branch];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${branch}</td>
                    <td>${row.in}</td>
                    <td>${row.out}</td>
                    <td class="muted">${Array.from(row.invoices).slice(0,3).join(', ')}${row.invoices.size>3?' ‚Ä¶':''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Notifications for low stock and overstock based on warehouse snapshot
        function evaluateThresholds() {
            getWarehouses().forEach(warehouse => {
                const res = getWarehouseStock(warehouse.id);
                if (!res?.success) return;
                const stock = res.data;
                Object.values(stock).forEach(s => {
                    if (s.quantity <= s.reorderLevel) {
                        pushAlert('warn', `Low stock ${s.productId} in ${warehouse.name || warehouse.id} (qty ${s.quantity})`, { branch: warehouse.id });
                    } else if (s.quantity > s.reorderLevel * 10) {
                        pushAlert('warn', `Overstock ${s.productId} in ${warehouse.name || warehouse.id} (qty ${s.quantity})`, { branch: warehouse.id });
                    }
                });
            });
        }

        // Real-time: listen to localStorage updates and poll every 20s as fallback
        function setupRealtime() {
            window.addEventListener('storage', (e) => {
                if (['dyna_stock_requests','dyna_stock_transfers','dyna_barcode_stock','dyna_warehouse_stock','dyna_barcode_inventory'].includes(e.key)) {
                    // Immediate refresh when stock data changes
                    setTimeout(() => {
                        refreshData();
                        renderWarehouseSnapshot();
                    }, 100);
                }
            });
            
            // Also listen for custom events from same-window updates
            window.addEventListener('stock-updated', () => {
                setTimeout(() => {
                    refreshData();
                    renderWarehouseSnapshot();
                }, 100);
            });
            
            setInterval(() => { refreshData(); }, 20000);
            // Cloud sync updates from other devices
            try { window.addEventListener('cloud-sync:updated', () => {
                setTimeout(() => {
                    refreshData();
                    renderWarehouseSnapshot();
                }, 100);
            }); } catch(_) {}
        }

        function renderWorkflowStatus() {
            const tbody = document.getElementById('workflowStatus');
            tbody.innerHTML = '';
            const entries = [];
            // Stock
            const warehousesList = getWarehouses();
            const inventoryOk = warehousesList.some(warehouse => {
                const res = getWarehouseStock(warehouse.id);
                return res?.success && Object.keys(res.data || {}).length > 0;
            });
            let barcodeOk = false;
            try { barcodeOk = !!localStorage.getItem('dyna_barcode_stock'); } catch (_) {}
            const stockOk = inventoryOk || barcodeOk;
            const stockDetails = stockOk
                ? `${warehousesList.length} warehouse${warehousesList.length===1?'':'s'} synced${barcodeOk ? ' + barcode cache' : ''}`
                : 'No warehouse inventory available';
            entries.push({ name: 'Stock', ok: stockOk, details: stockDetails });
            // MIS
            const misOk = !!document.querySelector('link[href*="mis-portal.html"], iframe[src*="mis-portal.html"]') || true; // assume available in repo
            entries.push({ name: 'MIS', ok: misOk, details: misOk?'MIS module present':'MIS module not detected' });
            // Finance
            const financeOk = true; // finance portal exists in main system
            entries.push({ name: 'Finance', ok: financeOk, details: 'Finance portal available in main app' });
            // Branches
            const branchesOk = Array.isArray(branches) && branches.length>0;
            entries.push({ name: 'Branches', ok: branchesOk, details: branchesOk?`${branches.length} branches loaded`:'No branches loaded' });
            // GM / Director
            const gmOk = true; const dirOk = true;
            entries.push({ name: 'GM Portal', ok: gmOk, details: 'GM Portal available in main app' });
            entries.push({ name: 'Director Portal', ok: dirOk, details: 'Director Portal available in main app' });

            entries.forEach(en => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${en.name}</td>
                    <td><span class="pill ${en.ok?'good':'bad'}">${en.ok?'CONNECTED':'MISSING'}</span></td>
                    <td class="muted">${en.details}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportCSV() {
            const rows = [['Type','Product','Qty','From','To','Branch','Timestamp','Request/Invoice']];
            movements.forEach(m => rows.push([
                m.type||'', m.product||'', m.qty||'', m.from||m.source||'', m.to||m.dest||'', m.branch||'', m.ts||'', m.requestNumber||''
            ]));
            const csv = rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'stock_movements.csv'; a.click();
            URL.revokeObjectURL(url);
        }

        function printDashboard() {
            const printWin = window.open('', '_blank');
            const styles = '<style>body{font-family: Arial, sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:6px; font-size:12px;} h2{margin:10px 0;}</style>';
            const movementHtml = document.getElementById('movementsList').innerHTML;
            const dailyBody = document.getElementById('dailyByBranch').innerHTML;
            const warehouseBody = document.getElementById('warehouseSnapshot').innerHTML;
            printWin.document.write('<html><head><title>Stock Dashboard</title>'+styles+'</head><body>');
            printWin.document.write('<h2>Real-time Stock Movements</h2><div>'+movementHtml+'</div>');
            printWin.document.write('<h2>Daily Stock Movements by Branch</h2><table><thead><tr><th>Branch</th><th>Stock In</th><th>Stock Out</th><th>Invoices</th></tr></thead><tbody>'+dailyBody+'</tbody></table>');
            printWin.document.write('<h2>Warehouse Stock Snapshot</h2><table><thead><tr><th>Warehouse</th><th>Product</th><th>Qty</th><th>Reserved</th><th>Reorder</th><th>Status</th></tr></thead><tbody>'+warehouseBody+'</tbody></table>');
            printWin.document.write('</body></html>');
            printWin.document.close();
            printWin.focus();
            printWin.print();
        }

        // Debounce helper
        function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }

        document.getElementById('refreshBtn').addEventListener('click', () => refreshData());
        document.getElementById('branchFilter').addEventListener('change', () => refreshData());
        document.getElementById('warehouseFilter').addEventListener('change', () => refreshData());
        document.getElementById('productFilter').addEventListener('change', () => refreshData());
        document.getElementById('dateRange').addEventListener('change', () => refreshData());
        document.getElementById('searchBox').addEventListener('input', debounce(() => refreshData(), 250));
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        document.getElementById('printBtn').addEventListener('click', printDashboard);

        function showToast(message, type = 'info'){
            const wrap = document.getElementById('toastContainer');
            const div = document.createElement('div');
            const color = type==='success'? '#0e7d5c' : type==='error'? '#5b1111' : '#223154';
            div.style.cssText = `background:#0f1830;border:1px solid ${color};border-radius:8px;padding:10px 12px;min-width:220px;max-width:360px;box-shadow:0 10px 30px rgba(0,0,0,.3);`;
            div.textContent = message;
            wrap.appendChild(div);
            setTimeout(()=>{ div.style.opacity='0'; div.style.transition='opacity .3s'; setTimeout(()=>wrap.removeChild(div), 300); }, 2200);
        }

        // --- Help wiring ---
        let workflowsMarkdown = '';
        async function loadWorkflowsMd() {
            if (workflowsMarkdown) return workflowsMarkdown;
            try {
                const resp = await fetch('./STOCK_WORKFLOWS.md', { cache: 'no-store' });
                if (resp.ok) {
                    workflowsMarkdown = await resp.text();
                }
            } catch(e) { /* ignore */ }
            return workflowsMarkdown;
        }

        function mdToBasicHtml(md) {
            let html = md
                .replace(/^###\s+(.*)$/gm, '<h3>$1<\/h3>')
                .replace(/^##\s+(.*)$/gm, '<h2>$1<\/h2>')
                .replace(/^\-\s+\*\*(.*?)\*\*:(.*)$/gm, '<li><strong>$1<\/strong>:$2<\/li>')
                .replace(/^\-\s+(.*)$/gm, '<li>$1<\/li>');
            html = html.replace(/(?:^(?:<li>.*<\/li>)\n?)+/gms, m => `<ul>${m}<\/ul>`);
            return html;
        }

        function extractSection(md, markerRegexArray) {
            for (const rx of markerRegexArray) {
                const m = md.match(rx);
                if (m) {
                    const start = m.index;
                    const rest = md.slice(start);
                    const next = rest.slice(m[0].length).search(/^###\s/m);
                    const section = next >= 0 ? rest.slice(0, m[0].length + next) : rest;
                    return section.trim();
                }
            }
            return '';
        }

        function openHelp(sectionKey) {
            (async () => {
                const md = await loadWorkflowsMd();
                let title = 'Workflow Help';
                let sectionMd = '';
                if (sectionKey === 'dashboard') {
                    title = 'Dashboard Views & FEFO Dispatch';
                    const part1 = extractSection(md, [/^###\s+6\)\s+Dashboard[\s\S]*/m]);
                    const part2 = extractSection(md, [/^###\s+4\)\s+Barcode\/Batch[\s\S]*/m]);
                    sectionMd = [part1, part2].filter(Boolean).join('\n\n');
                } else if (sectionKey === 'warehouse') {
                    title = 'Warehouse Stock Management';
                    sectionMd = extractSection(md, [/^###\s+3\)\s+Warehouse[\s\S]*/m]);
                } else if (sectionKey === 'roles') {
                    title = 'Workflow Status & Roles';
                    const part1 = extractSection(md, [/^###\s+7\)\s+Roles[\s\S]*/m]);
                    const part2 = extractSection(md, [/^###\s+1\)\s+Stock Requests[\s\S]*/m, /^###\s+2\)\s+Stock Transfers[\s\S]*/m]);
                    sectionMd = [part1, part2].filter(Boolean).join('\n\n');
                } else if (sectionKey === 'requests') {
                    title = 'Stock Requests';
                    sectionMd = extractSection(md, [/^###\s+1\)\s+Stock Requests[\s\S]*/m]);
                } else if (sectionKey === 'transfers') {
                    title = 'Stock Transfers';
                    sectionMd = extractSection(md, [/^###\s+2\)\s+Stock Transfers[\s\S]*/m]);
                } else {
                    sectionMd = md.split('\n').slice(0, 80).join('\n');
                }

                const body = document.getElementById('helpModalBody');
                const titleEl = document.getElementById('helpModalTitle');
                titleEl.textContent = title;
                body.innerHTML = mdToBasicHtml(sectionMd);
                document.getElementById('helpModal').style.display = 'flex';
            })();
        }

        const globalHelpBtn = document.getElementById('helpBtnGlobal');
        if (globalHelpBtn) globalHelpBtn.addEventListener('click', () => openHelp('dashboard'));
        const helpCloseBtn = document.getElementById('helpCloseBtn');
        if (helpCloseBtn) helpCloseBtn.addEventListener('click', () => {
            document.getElementById('helpModal').style.display = 'none';
        });
        const helpModal = document.getElementById('helpModal');
        if (helpModal) helpModal.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'helpModal') {
                document.getElementById('helpModal').style.display = 'none';
            }
        });
        Array.from(document.querySelectorAll('[data-help]')).forEach(btn => {
            btn.addEventListener('click', () => openHelp(btn.getAttribute('data-help')));
        });

        function formatAge(ts){ const secs = Math.floor((Date.now() - new Date(ts).getTime())/1000); if (secs<60) return secs+'s'; const mins=Math.floor(secs/60); if(mins<60) return mins+'m'; const hrs=Math.floor(mins/60); if(hrs<48) return hrs+'h'; const days=Math.floor(hrs/24); return days+'d'; }

        function makeStatusPill(status){ const map={ pending:'warn', pending_stock_review:'warn', pending_gm:'warn', pending_warehouse:'warn', approved:'good', fulfilled:'good', rejected:'bad', dispatched:'warn', delivered:'warn', received:'good' }; const cls=map[status]||''; return `<span class="pill ${cls}">${(status||'').toUpperCase()}</span>`; }

        function renderPendingRequestsTable() {
            const tbody = document.getElementById('pendingRequests');
            if (!tbody) return;
            tbody.innerHTML = '';
            const { data: all = [] } = getStockRequests({ status: 'all' }) || { data: [] };
            const relevantStatuses = ['pending_stock_review','pending_gm','pending_warehouse'];
            const pending = all.filter(r => relevantStatuses.includes(r.status)).slice(0, 20);
            pending.forEach(r => {
                const tr = document.createElement('tr');
                const overdue = (Date.now() - new Date(r.createdAt).getTime()) > 48*3600*1000;
                tr.innerHTML = `
                    <td>${r.requestNumber}</td>
                    <td>${r.requestingBranch}</td>
                    <td>${makeStatusPill(r.status)}</td>
                    <td>${r.returnDate ? new Date(r.returnDate).toLocaleDateString() : '‚Äî'}</td>
                    <td>${overdue?`<span class="pill warn">${formatAge(r.createdAt)}</span>`:formatAge(r.createdAt)}</td>
                    <td style="text-align:right;">
                        ${currentRole==='stock_manager' && r.status==='pending_stock_review' ? `<button class="btn" data-review="${r.id}">Review</button>`:''}
                        <button class="btn" data-approve="${r.id}" ${r.status==='pending_stock_review'?'disabled':''}>Approve</button>
                        <button class="btn" data-reject="${r.id}" ${r.status==='pending_stock_review'?'disabled':''}>Reject</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if (currentRole==='stock_manager') {
                tbody.querySelectorAll('[data-review]').forEach(btn => btn.addEventListener('click', () => openReviewModal(btn.getAttribute('data-review'))));
            }
            tbody.querySelectorAll('[data-approve]').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-approve');
                const who = (window.parent && window.parent.currentUser) ? window.parent.currentUser.fullName : 'Approver';
                const role = (window.parent && window.parent.currentUser) ? window.parent.currentUser.role : 'manager';
                const res = await approveStockRequest(id, { approverRole: role, approvedBy: who, approved: true, notes: '' });
                if (!res || res.success === false) {
                    showToast('Failed to approve request','error');
                    return;
                }
                showToast('Request approved','success');
                await refreshData();
                await renderWarehouseSnapshot();
            }));
            tbody.querySelectorAll('[data-reject]').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-reject');
                const who = (window.parent && window.parent.currentUser) ? window.parent.currentUser.fullName : 'Approver';
                const role = (window.parent && window.parent.currentUser) ? window.parent.currentUser.role : 'manager';
                if (confirm('Reject this request?')) {
                    const res = await approveStockRequest(id, { approverRole: role, approvedBy: who, approved: false, notes: '' });
                    if (!res || res.success === false) {
                        showToast('Failed to update request','error');
                        return;
                    }
                    showToast('Request rejected','info');
                    await refreshData();
                }
            }));
        }

        function renderActiveTransfersTable() {
            const tbody = document.getElementById('activeTransfers');
            if (!tbody) return;
            tbody.innerHTML = '';
            const { data: transfers = [] } = getStockTransfers({ status: 'all' }) || { data: [] };
            const active = transfers.filter(t => ['pending','dispatched','delivered'].includes(t.status)).slice(0, 12);
            active.forEach(t => {
                const tr = document.createElement('tr');
                const canReceive = (window.parent && window.parent.currentUser && window.parent.currentUser.branch) ? (window.parent.currentUser.branch === t.toBranch) : true;
                tr.innerHTML = `
                    <td>${t.requestNumber}</td>
                    <td>${t.fromWarehouse||'‚Äî'} ‚Üí ${t.toBranch||'‚Äî'}</td>
                    <td>${makeStatusPill(t.status)}</td>
                    <td class="muted">${t.dispatchNotes ? (String(t.dispatchNotes).slice(0,40) + (String(t.dispatchNotes).length>40?'‚Ä¶':'')) : '‚Äî'}</td>
                    <td>${formatAge(t.createdAt)}</td>
                    <td style="text-align:right;">
                        <button class="btn" data-view-dispatch="${t.id}">View</button>
                        ${t.status==='pending'?'<button class="btn" data-tstatus="dispatched" data-id="'+t.id+'">Dispatch</button>':''}
                        ${t.status==='dispatched'?'<button class="btn" data-tstatus="delivered" data-id="'+t.id+'">Mark Delivered</button>':''}
                        ${t.status==='delivered'?('<button class="btn primary" data-tstatus="received" data-id="'+t.id+'" '+(canReceive?'':'disabled')+'>Confirm & Receive</button>'):''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('[data-tstatus]').forEach(btn => btn.addEventListener('click', async () => {
                const status = btn.getAttribute('data-tstatus');
                const id = btn.getAttribute('data-id');
                const user = (window.parent && window.parent.currentUser) ? window.parent.currentUser.fullName : 'User';
                try {
                    const res = await updateTransferStatus(id, status, { user });
                    if (!res || res.success === false) {
                        showToast('Failed to update transfer','error');
                        return;
                    }
                    showToast('Transfer updated: ' + status, 'success');
                    if (status === 'dispatched') {
                        let note = res.note;
                        if (!note) {
                            const lookup = getDispatchNotes({ transferId: id });
                            if (lookup && lookup.success && Array.isArray(lookup.data) && lookup.data.length) {
                                note = lookup.data[0];
                            }
                        }
                        if (note) {
                            openDispatchNoteModal(note);
                        }
                    }
                } catch (err) {
                    console.error('Transfer update error:', err);
                    showToast('Transfer update failed','error');
                } finally {
                    await refreshData();
                    await renderWarehouseSnapshot();
                }
            }));
            tbody.querySelectorAll('[data-view-dispatch]').forEach(btn => btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-view-dispatch');
                const { data: transfersAll = [] } = getStockTransfers({ status: 'all' }) || { data: [] };
                const t = transfersAll.find(x => x.id === id);
                if (!t) return;
                const meta = document.getElementById('dispatchMeta');
                meta.textContent = `${t.requestNumber} ‚Ä¢ ${t.fromWarehouse||'‚Äî'} ‚Üí ${t.toBranch||'‚Äî'} ‚Ä¢ ${new Date(t.createdAt).toLocaleString()}`;
                document.getElementById('dispatchNote').textContent = t.dispatchNotes || '‚Äî';
                const tb = document.getElementById('dispatchItems');
                tb.innerHTML = '';
                (t.items||[]).forEach(it => {
                    const trEl = document.createElement('tr');
                    trEl.innerHTML = `<td>${it.productId||it.id||it.description||'‚Äî'}</td><td>${it.quantity||0}</td>`;
                    tb.appendChild(trEl);
                });
                document.getElementById('dispatchModal').style.display = 'flex';
            }));
        }

        function openCsvImportModal() {
            const preview = document.getElementById('csvPreview');
            if (preview) {
                preview.style.display = 'none';
                preview.textContent = '';
            }
            const fileInput = document.getElementById('csvFileInput');
            if (fileInput) fileInput.value = '';
            const locationSelect = document.getElementById('csvImportLocation');
            if (locationSelect) locationSelect.value = 'country_stock';
            if (csvImportBtn) csvImportBtn.disabled = true;
            csvParsedRows = [];
            const modal = document.getElementById('csvModal');
            if (modal) modal.style.display = 'flex';
        }

        // Quick actions (lightweight wired)
        const qaNewRequest = document.getElementById('qaNewRequest');
        if (qaNewRequest) qaNewRequest.addEventListener('click', () => {
            const sel = document.getElementById('reqBranch');
            sel.innerHTML = '';
            const currentBranch = (window.parent && window.parent.currentUser && window.parent.currentUser.branch) ? window.parent.currentUser.branch : null;
            const all = [{ id:'all', name:'Select Branch' }, ...branches];
            all.forEach(b => { const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name||b.id; sel.appendChild(opt); });
            if (currentBranch) sel.value = currentBranch;
            document.getElementById('requestModal').style.display = 'flex';
        });
        const qaImportBarcode = document.getElementById('qaImportBarcode');
        if (qaImportBarcode) qaImportBarcode.addEventListener('click', openCsvImportModal);
        const qaViewAudit = document.getElementById('qaViewAudit');
        if (qaViewAudit) qaViewAudit.addEventListener('click', () => openHelp('roles'));

        const countryImportLaunchBtn = document.getElementById('countryImportLaunchBtn');
        if (countryImportLaunchBtn) countryImportLaunchBtn.addEventListener('click', openCsvImportModal);

        const countryImportTemplateBtn = document.getElementById('countryImportTemplateBtn');
        if (countryImportTemplateBtn) countryImportTemplateBtn.addEventListener('click', () => {
            const template = [
                'Carton No.,Description,Batch No.,Expiry Date,Quantity,Total (CTNS)',
                'A1-001,Spirulina 500mg,SP500-2301,2027-08,120,10',
                'A1-002,Omega 3 Premium,OM3-2402,2028-02,60,5'
            ].join('\n');
            const blob = new Blob([template], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'dynapharm-stock-import-template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        const countryImportGuideBtn = document.getElementById('countryImportGuideBtn');
        if (countryImportGuideBtn) countryImportGuideBtn.addEventListener('click', () => {
            const guideUrl = new URL('./LOCAL_STOCK_UPLOAD_GUIDE.md', window.location.href);
            window.open(guideUrl.toString(), '_blank', 'noopener');
        });

        const productLabelsBtn = document.getElementById('productLabelsBtn');
        if (productLabelsBtn) productLabelsBtn.addEventListener('click', openProductLabelsModal);

        const workflowTabs = Array.from(document.querySelectorAll('.workflow-tab'));
        const workflowSections = Array.from(document.querySelectorAll('.workflow-section'));

        function activateWorkflow(targetId) {
            if (!targetId) return;
            workflowTabs.forEach(tab => {
                const isTarget = tab.getAttribute('data-workflow-target') === targetId;
                tab.classList.toggle('active', isTarget);
                tab.setAttribute('aria-pressed', isTarget ? 'true' : 'false');
            });
            workflowSections.forEach(section => {
                section.classList.toggle('active', section.id === targetId);
            });
        }

        workflowTabs.forEach(tab => {
            tab.setAttribute('role', 'button');
            tab.setAttribute('aria-pressed', tab.classList.contains('active') ? 'true' : 'false');
            tab.setAttribute('tabindex', '0');
            const target = tab.getAttribute('data-workflow-target');
            tab.addEventListener('click', () => activateWorkflow(target));
            tab.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    activateWorkflow(target);
                }
            });
        });

        const workflowRefreshBtn = document.getElementById('workflowRefreshBtn');
        if (workflowRefreshBtn) workflowRefreshBtn.addEventListener('click', () => refreshData());

        const workflowExportBtn = document.getElementById('workflowExportBtn');
        if (workflowExportBtn) workflowExportBtn.addEventListener('click', () => exportCSV());

        const workflowHelpBtn = document.getElementById('workflowHelpBtn');
        if (workflowHelpBtn) workflowHelpBtn.addEventListener('click', () => openHelp('dashboard'));

        // Modal close handlers
        const dispatchCloseBtn = document.getElementById('dispatchCloseBtn');
        if (dispatchCloseBtn) dispatchCloseBtn.addEventListener('click', () => { document.getElementById('dispatchModal').style.display = 'none'; });
        const dispatchModal = document.getElementById('dispatchModal');
        if (dispatchModal) dispatchModal.addEventListener('click', (e) => { if (e.target && e.target.id === 'dispatchModal') dispatchModal.style.display = 'none'; });

        const requestCloseBtn = document.getElementById('requestCloseBtn');
        if (requestCloseBtn) requestCloseBtn.addEventListener('click', () => { document.getElementById('requestModal').style.display = 'none'; });
        const requestModal = document.getElementById('requestModal');
        if (requestModal) requestModal.addEventListener('click', (e) => { if (e.target && e.target.id === 'requestModal') requestModal.style.display = 'none'; });

        const csvCloseBtn = document.getElementById('csvCloseBtn');
        if (csvCloseBtn) csvCloseBtn.addEventListener('click', () => { document.getElementById('csvModal').style.display = 'none'; });
        const csvModal = document.getElementById('csvModal');
        if (csvModal) csvModal.addEventListener('click', (e) => { if (e.target && e.target.id === 'csvModal') csvModal.style.display = 'none'; });
        const reviewCloseBtn = document.getElementById('reviewCloseBtn');
        if (reviewCloseBtn) reviewCloseBtn.addEventListener('click', () => { if (reviewModal) reviewModal.style.display = 'none'; });
        if (reviewModal) reviewModal.addEventListener('click', (event) => { if (event.target && event.target.id === 'reviewModal') reviewModal.style.display = 'none'; });

        const dispatchNoteCloseBtn = document.getElementById('dispatchNoteCloseBtn');
        if (dispatchNoteCloseBtn) dispatchNoteCloseBtn.addEventListener('click', () => closeDispatchNoteModal());
        const dispatchNotePrintBtn = document.getElementById('dispatchNotePrintBtn');
        if (dispatchNotePrintBtn) dispatchNotePrintBtn.addEventListener('click', () => printDispatchNote());

        const productLabelsCloseBtn = document.getElementById('productLabelsCloseBtn');
        if (productLabelsCloseBtn) productLabelsCloseBtn.addEventListener('click', () => closeProductLabelsModal());
        if (productLabelsModal) productLabelsModal.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'productLabelsModal') {
                closeProductLabelsModal();
            }
        });
        const productLabelsPrintBtn = document.getElementById('productLabelsPrintBtn');
        if (productLabelsPrintBtn) productLabelsPrintBtn.addEventListener('click', () => printProductLabels());
        const productLabelAddBtn = document.getElementById('productLabelAddBtn');
        if (productLabelAddBtn) productLabelAddBtn.addEventListener('click', () => addProductLabel());
        const productLabelSelect = document.getElementById('productLabelSelect');
        if (productLabelSelect) productLabelSelect.addEventListener('change', () => {
            const qtyInput = document.getElementById('productLabelQty');
            if (qtyInput) qtyInput.focus();
        });
        if (productLabelsGrid) productLabelsGrid.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('[data-label-remove]');
            if (!removeBtn) return;
            const index = Number(removeBtn.getAttribute('data-label-remove'));
            if (!Number.isNaN(index)) {
                removeProductLabel(index);
            }
        });

        const reqSubmitBtn = document.getElementById('reqSubmitBtn');
        if (reqSubmitBtn) reqSubmitBtn.addEventListener('click', async () => {
            const branch = document.getElementById('reqBranch').value;
            const type = document.getElementById('reqType').value;
            const priority = document.getElementById('reqPriority').value;
            const product = document.getElementById('reqProduct').value.trim();
            const qty = Number(document.getElementById('reqQty').value);
            const notes = document.getElementById('reqNotes').value.trim();
            const returnDate = document.getElementById('reqReturnDate').value;
            if (!branch || branch==='all' || !product || !qty || qty<=0) { showToast('Fill branch, product, and quantity','error'); return; }
            if (!returnDate) { showToast('Select return / required date','error'); return; }
            const user = (window.parent && window.parent.currentUser) ? window.parent.currentUser : { fullName:'Requestor', role:'dispenser' };
            const res = await createStockRequest({ branch, type, priority, items:[{ productId: product, description: product, quantity: qty }], notes, returnDate, requestedBy: user.fullName, requestedByRole: user.role });
            if (res && res.success) {
                showToast('Request created: '+res.data.requestNumber,'success');
                document.getElementById('requestModal').style.display = 'none';
                await refreshData();
                await renderWarehouseSnapshot();
            } else {
                showToast('Failed to create request','error');
            }
        });

        // CSV parsing and import
        const csvFileInput = document.getElementById('csvFileInput');
        const csvImportBtn = document.getElementById('csvImportBtn');
        const csvPreview = document.getElementById('csvPreview');

        function parseCSV(text){
            // Robust comma-delimited parser with RFC4180-style quoted fields
            function splitCSVLine(line){
                const out = [];
                let cur = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i+1] === '"') { // escaped quote
                            cur += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (ch === ',' && !inQuotes) {
                        out.push(cur);
                        cur = '';
                    } else {
                        cur += ch;
                    }
                }
                out.push(cur);
                return out.map(s => s.trim());
            }
            const rawLines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            const lines = rawLines.filter(l => l.trim().length > 0);
            if (lines.length === 0) return { headers: [], rows: [] };
            const headers = splitCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, ''));
            const rows = lines.slice(1).map(line => {
                const cols = splitCSVLine(line).map(c => c.replace(/^"|"$/g, ''));
                const obj = {};
                headers.forEach((h, i) => { obj[h] = (cols[i] ?? ''); });
                return obj;
            });
            return { headers, rows };
        }

        if (csvFileInput) csvFileInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev){
                const text = ev.target.result;
                const { headers, rows } = parseCSV(text);

                // Build flexible header mapping (normalize by removing non-alphanumerics and lowercasing)
                function norm(h){ return String(h||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
                const headerIndex = Object.fromEntries(headers.map((h,i)=>[norm(h), i]));
                const candidates = {
                    cartonNo: ['cartonno','cartonsno','cartonnumber','cartonno','cartonsno.','cartons','carton'],
                    description: ['description','desc','product','item'],
                    batchNo: ['batchno','batchnumber','batch'],
                    expiryDate: ['expirydate','expireddate','expiry','expdate'],
                    quantity: ['quantity','qty','qtybag','qtybox'],
                    totalCtns: ['totalctns','total','ctns','totalcartons','totalcarton']
                };
                const mapped = {};
                Object.keys(candidates).forEach(key => {
                    const found = candidates[key].find(alias => headerIndex.hasOwnProperty(alias));
                    if (found) mapped[key] = headers[headerIndex[found]];
                });

                const missingCanon = Object.keys(candidates).filter(k => !mapped[k]);
                if (missingCanon.length){
                    csvPreview.style.display = 'block';
                    csvPreview.textContent = 'Missing required headers: ' + missingCanon.join(', ');
                    csvImportBtn.disabled = true;
                    csvParsedRows = [];
                    return;
                }

                function parseExpiry(val){
                    const s = String(val||'').trim();
                    if (/^\d{4}-\d{2}$/.test(s)) return s; // already YYYY-MM
                    // Accept Aug-2027, Aug/2027, Aug 2027, 2027/08, 2027.08, 2027-08-15
                    const months = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
                    const m1 = s.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[^0-9]*?(\d{4})$/i);
                    if (m1){ const mm = String(months[m1[1].toLowerCase()]).padStart(2,'0'); return `${m1[2]}-${mm}`; }
                    const m2 = s.match(/^(\d{4})[^0-9]*?(\d{1,2})/);
                    if (m2){ return `${m2[1]}-${String(m2[2]).padStart(2,'0')}`; }
                    const m3 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                    if (m3){ return `${m3[1]}-${m3[2]}`; }
                    return '';
                }

                function parseIntSafe(v){
                    const s = String(v||'').replace(/[^0-9-]/g,'').replace(/\s+/g,'');
                    const n = parseInt(s,10);
                    return Number.isFinite(n) ? n : NaN;
                }

                // Transform rows into canonical shape
                const transformed = rows.map(r => ({
                    cartonNo: r[mapped.cartonNo],
                    description: r[mapped.description],
                    batchNo: r[mapped.batchNo],
                    expiryDate: parseExpiry(r[mapped.expiryDate]),
                    quantity: parseIntSafe(r[mapped.quantity]),
                    totalCtns: parseIntSafe(r[mapped.totalCtns])
                }));

                // Preview first 5 rows
                const previewLines = transformed.slice(0,5).map((r,i) => `${i+1}) ${r.cartonNo}, ${r.description}, ${r.batchNo}, ${r.expiryDate}, ${r.quantity}, ${r.totalCtns}`);
                csvPreview.style.display = 'block';
                csvPreview.textContent = 'Rows detected: ' + transformed.length + '\n' + previewLines.join('\n');
                csvParsedRows = transformed;
                csvImportBtn.disabled = transformed.length === 0;
            };
            reader.readAsText(file);
        });

        if (csvImportBtn) csvImportBtn.addEventListener('click', async () => {
            try {
                if (!csvParsedRows || csvParsedRows.length === 0){ 
                    showToast('No rows to import','error'); 
                    return; 
                }
                const csvImportLocationEl = document.getElementById('csvImportLocation');
                const importLocation = (csvImportLocationEl && csvImportLocationEl.value) ? csvImportLocationEl.value : 'country_stock';
                let ok = 0, fail = 0;
                for (const r of csvParsedRows) {
                    try {
                        const qty = parseInt(r.quantity, 10);
                        const ctns = parseInt(r.totalCtns, 10);
                        const dateOk = /^\d{4}-\d{2}$/.test(String(r.expiryDate||''));
                        if (!r.cartonNo || !r.description || !r.batchNo || !dateOk || !Number.isFinite(qty) || qty <= 0 || !Number.isFinite(ctns) || ctns <= 0){
                            fail++; 
                            return;
                        }
                        // Import with location specified
                        const importData = { 
                            cartonNo:r.cartonNo, 
                            description:r.description, 
                            batchNo:r.batchNo, 
                            expiryDate:r.expiryDate, 
                            quantity:qty, 
                            totalCtns:ctns,
                            sourceWarehouseId: importLocation !== 'country_stock' ? importLocation : null
                        };
                        if (typeof importStockWithBarcode === 'function') {
                            const res = await importStockWithBarcode(importData);
                            if (res && res.success) ok++; else fail++;
                        } else {
                            console.error('importStockWithBarcode function not found');
                            fail++;
                        }
                    } catch (err) {
                        console.error('Error importing row:', err, r);
                        fail++;
                    }
                }
                showToast(`Import done: ${ok} ok, ${fail} failed. Stock imported to ${importLocation}`, fail ? 'error' : 'success');
                const csvModal = document.getElementById('csvModal');
                if (csvModal) csvModal.style.display = 'none';
                // Immediately refresh to show imported stock
                setTimeout(() => {
                    if (typeof refreshData === 'function') refreshData();
                    if (typeof renderWarehouseSnapshot === 'function') renderWarehouseSnapshot();
                }, 100);
            } catch (error) {
                console.error('CSV import error:', error);
                showToast('Error during CSV import: ' + (error.message || 'Unknown error'), 'error');
            }
        });

        function renderReviewRows(items) {
            const tbody = document.getElementById('reviewItemsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" class="input" data-review-field="description" data-index="${idx}" value="${item.description || ''}" style="width:100%;"></td>
                    <td><input type="number" class="input" data-review-field="quantity" data-index="${idx}" value="${item.quantity || 0}" style="width:100%;"></td>
                    <td><input type="text" class="input" data-review-field="uom" data-index="${idx}" value="${item.uom || 'units'}" style="width:100%;"></td>
                    <td style="text-align:right;"><button class="btn" data-remove-index="${idx}">Remove</button></td>`;
                tbody.appendChild(tr);
            });
        }

        let reviewRequest = null;

        function openReviewModal(requestId) {
            const all = (getStockRequests({ status: 'all' }) || { data: [] }).data || [];
            const found = all.find(r => r.id === requestId || r.requestNumber === requestId);
            if (!found) {
                showToast('Request not found','error');
                return;
            }
            reviewRequest = JSON.parse(JSON.stringify(found));
            const meta = document.getElementById('reviewMeta');
            if (meta) {
                meta.textContent = `${found.requestNumber} ‚Ä¢ ${found.requestingBranch || '‚Äî'} ‚Ä¢ Return by ${found.returnDate || '‚Äî'}`;
            }
            renderReviewRows(reviewRequest.items && reviewRequest.items.length ? reviewRequest.items : [{ description: '', quantity: 0, uom: 'units' }]);
            reviewModal.style.display = 'flex';
        }

        function syncReviewItemsFromInputs() {
            if (!reviewRequest) return;
            const rows = Array.from(document.querySelectorAll('#reviewItemsBody tr'));
            const items = rows.map(tr => {
                const description = tr.querySelector('input[data-review-field="description"]').value.trim();
                const quantity = Number(tr.querySelector('input[data-review-field="quantity"]').value);
                const uom = tr.querySelector('input[data-review-field="uom"]').value.trim() || 'units';
                return { description, productId: description, quantity, uom };
            }).filter(item => item.description && item.quantity > 0);
            reviewRequest.items = items;
        }

        const reviewAddItemBtn = document.getElementById('reviewAddItemBtn');
        if (reviewAddItemBtn) reviewAddItemBtn.addEventListener('click', () => {
            if (!reviewRequest) return;
            reviewRequest.items = reviewRequest.items || [];
            reviewRequest.items.push({ description: '', quantity: 0, uom: 'units' });
            renderReviewRows(reviewRequest.items);
        });

        const reviewItemsBody = document.getElementById('reviewItemsBody');
        if (reviewItemsBody) reviewItemsBody.addEventListener('click', (event) => {
            const btn = event.target.closest('[data-remove-index]');
            if (!btn || !reviewRequest) return;
            const index = Number(btn.getAttribute('data-remove-index'));
            reviewRequest.items.splice(index, 1);
            if (reviewRequest.items.length === 0) {
                reviewRequest.items.push({ description: '', quantity: 0, uom: 'units' });
            }
            renderReviewRows(reviewRequest.items);
        });

        const reviewSaveBtn = document.getElementById('reviewSaveBtn');
        if (reviewSaveBtn) reviewSaveBtn.addEventListener('click', async () => {
            if (!reviewRequest) return;
            syncReviewItemsFromInputs();
            if (!reviewRequest.items || reviewRequest.items.length === 0) {
                showToast('Add at least one item','error');
                return;
            }
            const reviewer = currentUser ? currentUser.fullName : 'Stock Manager';
            const res = await updateStockRequest(reviewRequest.id, { items: reviewRequest.items, reviewedBy: reviewer });
            if (res && res.success) {
                showToast('Changes saved','success');
                reviewModal.style.display = 'none';
                await refreshData();
            } else {
                showToast('Failed to save changes','error');
            }
        });

        const reviewForwardBtn = document.getElementById('reviewForwardBtn');
        if (reviewForwardBtn) reviewForwardBtn.addEventListener('click', async () => {
            if (!reviewRequest) return;
            syncReviewItemsFromInputs();
            if (!reviewRequest.items || reviewRequest.items.length === 0) {
                showToast('Add at least one item','error');
                return;
            }
            const reviewer = currentUser ? currentUser.fullName : 'Stock Manager';
            const resSave = await updateStockRequest(reviewRequest.id, { items: reviewRequest.items, reviewedBy: reviewer });
            if (!resSave || !resSave.success) {
                showToast('Save changes before forwarding','error');
                return;
            }
            const resForward = await forwardStockRequestToGM(reviewRequest.id, { reviewedBy: reviewer });
            if (resForward && resForward.success) {
                showToast('Forwarded to GM','success');
                reviewModal.style.display = 'none';
                await refreshData();
            } else {
                showToast('Forward failed','error');
            }
        });

        function buildDispatchNoteHtml(note) {
            if (!note) return '<div>No dispatch note data available.</div>';
            const created = new Date(note.createdAt || Date.now()).toLocaleString();
            const expected = note.expectedArrival ? new Date(note.expectedArrival).toLocaleDateString() : '‚Äî';
            const totalQty = (note.items || []).reduce((sum, item) => sum + Number(item.quantity || 0), 0);
            const barcodeId = `dispatch-note-barcode-${note.id}`;
            const rows = (note.items || []).length
                ? note.items.map(item => `
                    <tr>
                        <td>${(item.description || item.productId || 'Item').toString()}</td>
                        <td style="text-align:center;">${Number(item.quantity || 0)}</td>
                        <td style="text-align:center;">${item.uom || 'units'}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" style="text-align:center; color:#64748b;">No items listed</td></tr>';

            return `
                <div style="font-family: 'Inter', Arial, sans-serif; color:#1e293b;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
                        <div>
                            <h1 style="margin:0; font-size:20px; letter-spacing:0.4px;">Dynapharm Dispatch Note</h1>
                            <div style="font-size:12px; color:#475569; margin-top:4px;">Generated: ${created}</div>
                            <div style="font-size:12px; color:#475569; margin-top:2px;">Note ID: ${note.id}</div>
                        </div>
                        <div style="text-align:center;">
                            <svg id="${barcodeId}" width="220" height="70"></svg>
                            <div style="font-size:11px; letter-spacing:2px; color:#0f172a; margin-top:6px;">${note.barcode}</div>
                        </div>
                    </div>
                    <div style="margin-top:18px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px;">
                        <div style="background:#eef2ff; padding:12px; border-radius:10px;">
                            <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.8px; color:#4338ca;">From</div>
                            <div style="font-weight:600; margin-top:6px;">${note.fromWarehouse || '‚Äî'}</div>
                        </div>
                        <div style="background:#eef2ff; padding:12px; border-radius:10px;">
                            <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.8px; color:#4338ca;">Destination</div>
                            <div style="font-weight:600; margin-top:6px;">${note.toBranch || '‚Äî'}</div>
                            <div style="font-size:12px; color:#475569; margin-top:4px;">Expected: ${expected}</div>
                        </div>
                        <div style="background:#eef2ff; padding:12px; border-radius:10px;">
                            <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.8px; color:#4338ca;">Reference</div>
                            <div style="font-weight:600; margin-top:6px;">${note.requestNumber || '‚Äî'}</div>
                            <div style="font-size:12px; color:#475569; margin-top:4px;">Dispatched by: ${note.dispatchedBy || '‚Äî'}</div>
                        </div>
                    </div>
                    <div style="margin-top:22px;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#1d4ed8; color:#f8fafc;">
                                    <th style="padding:10px; text-align:left;">Product</th>
                                    <th style="padding:10px; text-align:center; width:90px;">Qty</th>
                                    <th style="padding:10px; text-align:center; width:90px;">UoM</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                                <tr style="background:#f1f5f9; font-weight:600;">
                                    <td style="padding:10px;">Total</td>
                                    <td style="padding:10px; text-align:center;">${totalQty}</td>
                                    <td style="padding:10px; text-align:center;">items</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:24px; display:flex; gap:20px; flex-wrap:wrap; font-size:12px; color:#475569;">
                        <div style="flex:1; min-width:220px;">
                            <div style="font-weight:600; color:#0f172a;">Dispatch Notes</div>
                            <div style="margin-top:6px; background:#f8fafc; border:1px dashed #cbd5f5; padding:12px; border-radius:10px; min-height:58px;">${note.dispatchNotes || 'None recorded'}</div>
                        </div>
                        <div style="flex:1; min-width:220px;">
                            <div style="font-weight:600; color:#0f172a;">Verification Checklist</div>
                            <ul style="margin:8px 0 0 18px; padding:0;">
                                <li>Check carton count matches quantities.</li>
                                <li>Confirm batch & expiry for FEFO compliance.</li>
                                <li>Sign & upload photo via branch portal if discrepancies.</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top:28px; display:flex; gap:28px; flex-wrap:wrap; font-size:12px; color:#475569;">
                        <div style="flex:1; min-width:220px;">
                            <div style="border-bottom:1px solid #94a3b8; padding-bottom:36px;"></div>
                            <div style="margin-top:8px;">Warehouse Signature</div>
                        </div>
                        <div style="flex:1; min-width:220px;">
                            <div style="border-bottom:1px solid #94a3b8; padding-bottom:36px;"></div>
                            <div style="margin-top:8px;">Branch Verification</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openDispatchNoteModal(note) {
            const modal = document.getElementById('dispatchNoteModal');
            const content = document.getElementById('dispatchNoteContent');
            if (!modal || !content || !note) return;
            latestDispatchNote = note;
            content.innerHTML = buildDispatchNoteHtml(note);
            modal.style.display = 'flex';
            setTimeout(() => {
                const svgId = `#dispatch-note-barcode-${note.id}`;
                if (window.JsBarcode && document.querySelector(svgId)) {
                    try {
                        window.JsBarcode(svgId, note.barcode, { width: 2, height: 60, displayValue: false, margin: 0 });
                    } catch (err) {
                        console.warn('Barcode render failed', err);
                    }
                }
            }, 0);
        }

        function closeDispatchNoteModal() {
            const modal = document.getElementById('dispatchNoteModal');
            if (modal) modal.style.display = 'none';
        }

        function printDispatchNote() {
            const content = document.getElementById('dispatchNoteContent');
            if (!content) return;
            const noteHtml = content.innerHTML;
            const printWindow = window.open('', '_blank', 'width=900,height=1000');
            if (!printWindow) return;
            const html = `<!DOCTYPE html><html><head><title>Dispatch Note</title><style>
                body{font-family:'Inter',Arial,sans-serif;color:#1e293b;margin:24px;}
                table{width:100%;border-collapse:collapse;margin-top:18px;}
                th,td{border:1px solid #cbd5f5;padding:8px 10px;text-align:left;font-size:13px;}
                th{background:#1d4ed8;color:#f8fafc;}
                h1{font-size:20px;margin:0;}
                ul{margin:8px 0 0 18px;}
            </style></head><body>${noteHtml}
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <script>window.addEventListener('load',function(){
                document.querySelectorAll('svg[id^="dispatch-note-barcode"]').forEach(function(node){
                    var code=node.nextElementSibling?node.nextElementSibling.textContent.trim():'';
                    if (code){ try { JsBarcode(node, code, { width:2, height:60, displayValue:false, margin:0 }); } catch(e){} }
                });
                setTimeout(function(){ window.print(); }, 300);
            });<\/script>
            </body></html>`;
            printWindow.document.open();
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
        }

        function sanitizeProductCode(code) {
            return String(code || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 24) || 'PRODUCT';
        }

        function buildProductLabelHtml(item, index) {
            const svgId = `product-label-barcode-${index}`;
            const name = (item.productName || item.productId || 'Product').toString();
            return `
                <div style="border:1px solid #cbd5f5; border-radius:12px; padding:12px 14px; background:#f8fafc; display:flex; flex-direction:column; gap:12px;">
                    <div style="display:flex; justify-content:space-between; gap:8px; align-items:flex-start;">
                        <div style="font-weight:600; color:#0f172a; max-width:70%;">${name}</div>
                        <button class="btn" data-label-remove="${index}" style="padding:6px 8px; font-size:11px;">Remove</button>
                    </div>
                    <div style="display:flex; justify-content:center;">
                        <svg id="${svgId}" width="180" height="60"></svg>
                    </div>
                    <div style="font-size:11px; letter-spacing:1px; text-align:center; color:#1e293b;">${item.barcode}</div>
                </div>
            `;
        }

        function renderProductLabels() {
            const grid = document.getElementById('productLabelsGrid');
            const summary = document.getElementById('productLabelsSummary');
            if (!grid || !summary) return;
            if (!productLabelItems.length) {
                grid.innerHTML = '<div style="color:#475569; font-size:12px;">No labels queued. Select a product and quantity, then click "Add to Labels".</div>';
                summary.textContent = 'Add products to generate printable barcode labels.';
                return;
            }
            summary.textContent = `${productLabelItems.length} label ${productLabelItems.length === 1 ? 'entry' : 'entries'} ready for printing.`;
            grid.innerHTML = productLabelItems.map((item, idx) => buildProductLabelHtml(item, idx)).join('');
            productLabelItems.forEach((item, idx) => {
                const svgSelector = `#product-label-barcode-${idx}`;
                if (window.JsBarcode && document.querySelector(svgSelector)) {
                    try {
                        window.JsBarcode(svgSelector, item.barcode, { width: 1.8, height: 54, displayValue: false, margin: 0 });
                    } catch (err) {
                        console.warn('Label barcode render failed', err);
                    }
                }
            });
        }

        function openProductLabelsModal() {
            const modal = document.getElementById('productLabelsModal');
            const select = document.getElementById('productLabelSelect');
            if (!modal || !select) return;
            select.innerHTML = '';
            if (products && products.length) {
                products.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = sanitizeProductCode(prod.id || prod.sku || prod.name);
                    option.textContent = prod.name || prod.description || prod.id;
                    select.appendChild(option);
                });
            }
            productLabelItems = [];
            renderProductLabels();
            modal.style.display = 'flex';
        }

        function closeProductLabelsModal() {
            const modal = document.getElementById('productLabelsModal');
            if (modal) modal.style.display = 'none';
        }

        function addProductLabel() {
            const select = document.getElementById('productLabelSelect');
            const qtyInput = document.getElementById('productLabelQty');
            if (!select || !qtyInput) return;
            const qty = Math.max(1, Math.min(200, Number(qtyInput.value) || 1));
            const productCode = sanitizeProductCode(select.value || select.options[select.selectedIndex]?.value || 'PRODUCT');
            const labelName = select.options[select.selectedIndex]?.text || productCode;
            for (let i = 0; i < qty; i += 1) {
                const barcode = `${productCode}-${String(Date.now() + i).slice(-6)}`;
                productLabelItems.push({ productId: productCode, productName: labelName, barcode });
            }
            renderProductLabels();
        }

        function removeProductLabel(index) {
            productLabelItems.splice(index, 1);
            renderProductLabels();
        }

        function printProductLabels() {
            if (!productLabelItems.length) {
                showToast('Add products before printing labels','error');
                return;
            }
            const printWindow = window.open('', '_blank', 'width=900,height=1000');
            if (!printWindow) return;
            const payload = JSON.stringify(productLabelItems);
            const html = `<!DOCTYPE html><html><head><title>Product Labels</title><style>
                body{margin:24px;font-family:'Inter',Arial,sans-serif;color:#0f172a;}
                .label-card{display:inline-block;width:240px;height:140px;margin:8px;padding:12px 14px;border:1px solid #94a3b8;border-radius:12px;box-sizing:border-box;}
                .label-card h4{margin:0;font-size:13px;font-weight:600;text-align:center;color:#0f172a;}
                .label-barcode{margin-top:12px;text-align:center;}
                .label-code{font-size:11px;letter-spacing:1px;text-align:center;margin-top:6px;}
                @media print{body{margin:12px;} .label-card{break-inside:avoid;}}
            </style></head><body>
            <div id="labels-root"></div>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <script>
                const labels = ${payload};
                const root = document.getElementById('labels-root');
                labels.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'label-card';
                    const title = document.createElement('h4');
                    title.textContent = item.productName;
                    card.appendChild(title);
                    const barcodeWrap = document.createElement('div');
                    barcodeWrap.className = 'label-barcode';
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('id', 'print-label-' + idx);
                    svg.setAttribute('width', '200');
                    svg.setAttribute('height', '60');
                    barcodeWrap.appendChild(svg);
                    card.appendChild(barcodeWrap);
                    const code = document.createElement('div');
                    code.className = 'label-code';
                    code.textContent = item.barcode;
                    card.appendChild(code);
                    root.appendChild(card);
                });
                window.addEventListener('load', function(){
                    labels.forEach((item, idx) => {
                        const svg = document.getElementById('print-label-' + idx);
                        if (svg) {
                            try { JsBarcode(svg, item.barcode, { width:1.8, height:54, displayValue:false, margin:0 }); } catch(e) {}
                        }
                    });
                    setTimeout(function(){ window.print(); }, 300);
                });
            <\/script>
            </body></html>`;
            printWindow.document.open();
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
        }

        (async function init(){
            await loadBranches();
            await loadProducts();
            setupRealtime();
            evaluateThresholds();
            await refreshData();
        })();
    </script>
</body>
</html>


