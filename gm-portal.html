<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>GM Portal - Business Transaction Monitor</title>
    <link rel="icon" href="./favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .logo img { display:block; height:32px; width:auto; margin-bottom:8px; }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .change {
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        .change.positive {
            color: #10b981;
        }
        
        .change.negative {
            color: #ef4444;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .transaction-table th,
        .transaction-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .transaction-table th {
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        
        .transaction-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-select,
        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .gm-request-card {
            background: #f8f9ff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .gm-request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .gm-request-meta {
            font-size: 0.9em;
            color: #666;
        }
        .gm-request-items {
            margin-top: 12px;
            font-size: 0.95em;
            color: #4b5563;
        }
        .gm-request-items ul {
            margin: 8px 0 0 18px;
        }
        .gm-request-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 14px;
        }
        .btn-approve {
            background: #10b981;
            color: #fff;
        }
        .btn-approve:hover {
            background: #0b9a6f;
        }
        .btn-reject {
            background: #ef4444;
            color: #fff;
        }
        .btn-reject:hover {
            background: #c53030;
        }
        
        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .activity-item h4 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .activity-item p {
            color: #666;
            font-size: 0.9em;
        }
        
        .activity-time {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body { padding: 12px !important; }
            .container { max-width: 100% !important; }
            .header { padding: 20px !important; margin-bottom: 20px !important; }
            .header h1 { font-size: 1.5rem !important; }
            .header p { font-size: 0.9rem !important; }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            .stat-card { padding: 16px !important; }
            .stat-card .value { font-size: 1.8rem !important; }
            .main-content { gap: 20px !important; }
            .card { padding: 20px !important; }
            .card h2 { font-size: 1.2rem !important; }
            .filter-bar { flex-direction: column !important; gap: 10px !important; }
            .filter-select, .filter-input, .btn { width: 100% !important; min-height: 44px; font-size: 16px; }
            .transaction-table {
                font-size: 0.85em;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
            .transaction-table th,
            .transaction-table td {
                padding: 10px 6px !important;
            }
            thead { display: table-header-group; }
            tbody { display: table-row-group; }
            thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
            .gm-request-card { padding: 14px !important; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1.2rem !important; }
            .stats-grid { grid-template-columns: 1fr !important; }
            .stat-card .value { font-size: 1.5rem !important; }
            .transaction-table th,
            .transaction-table td {
                padding: 8px 4px !important;
                font-size: 0.75rem !important;
            }
            .gm-request-card { padding: 12px !important; }
        }
        
        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            .btn { min-height: 44px; }
            * { -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2); }
        }
    </style>
    <script defer src="./cloud-sync.js"></script>
    <script defer src="./auto-cloud-sync.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"><img src="./assets/dynapharm-logo.png" alt="Dynapharm Namibia Logo"></div>
            <h1>üè¢ GM Business Portal</h1>
            <p>Real-time monitoring of all business transactions</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="totalRevenue">NAD 0</div>
                <div class="change positive">
                    <span id="revenueChange">+0%</span> from last month
                </div>
            </div>
            
            <div class="stat-card">
                <h3>Transactions Today</h3>
                <div class="value" id="transactionsToday">0</div>
                <div class="change positive">
                    <span id="dailyChange">+0</span> transactions
                </div>
            </div>
            
            <div class="stat-card">
                <h3>Active Clients</h3>
                <div class="value" id="activeClients">0</div>
                <div class="change positive">
                    Active this month
                </div>
            </div>
            
            <div class="stat-card">
                <h3>Pending Orders</h3>
                <div class="value" id="pendingOrders">0</div>
                <div class="change negative">
                    Requires attention
                </div>
            </div>
        </div>
        
        <div class="filter-bar">
            <select class="filter-select" id="dateRange">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
                <option value="all">All Time</option>
            </select>
            
            <select class="filter-select" id="statusFilter">
                <option value="all">All Status</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="cancelled">Cancelled</option>
            </select>
            
            <select class="filter-select" id="branchFilter">
                <option value="all">All Branches</option>
            </select>
            
            <input type="text" class="filter-input" id="searchInput" placeholder="Search transactions...">
            
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
        </div>
        
        <div class="main-content">
            <div class="card">
                <h2>Recent Transactions</h2>
                <div style="overflow-x: auto;">
                    <table class="transaction-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Client</th>
                                <th>Branch</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr>
                                <td colspan="6" class="no-data">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2>Recent Activity</h2>
                <div class="recent-activity" id="recentActivity">
                    <div class="no-data">Loading activity...</div>
                </div>
            </div>
            <div class="card" style="grid-column: span 2;">
                <h2>Stock Requests Awaiting GM Approval</h2>
                <div id="gmStockRequests" class="gm-requests-container">
                    <div class="no-data">Loading stock requests...</div>
                </div>
            </div>

            <div class="card">
                <h2>Branch Performance</h2>
                <div style="overflow-x: auto;">
                    <table class="transaction-table" id="branchPerformanceTable">
                        <thead>
                            <tr>
                                <th>Branch</th>
                                <th>Revenue</th>
                                <th>Transactions</th>
                                <th>Active Clients</th>
                                <th>Avg Txn Value</th>
                            </tr>
                        </thead>
                        <tbody id="branchPerformanceBody">
                            <tr>
                                <td colspan="5" class="no-data">Loading branch performance...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { getStockRequests, approveStockRequest } from './web-modules/stock-requests.js';
        // Sample data storage (in production, this would come from API)
        let allTransactions = [];
        let allClients = [];
        let allBranches = [];
        let gmPendingRequests = [];
        const gmUser = (window.parent && window.parent.currentUser) ? window.parent.currentUser : { fullName: 'General Manager', role: 'general_manager' };
        
        // Initialize the portal
        async function initializePortal() {
            try {
                await loadData();
                updateDashboard();
                loadTransactionsTable();
                loadRecentActivity();
                loadGmStockRequests();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    refreshData();
                }, 30000);
                
            } catch (error) {
                console.error('Error initializing portal:', error);
            }
        }
        
        // Load data from various sources
        async function loadData() {
            try {
                // Try to load from API first - use localStorage and API as fallback
                let transactions = [];
                
                // Try API endpoint for reports/transactions
                try {
                    const reportsResponse = await fetch('/api/reports');
                    if (reportsResponse.ok) {
                        const reportsData = await reportsResponse.json();
                        if (Array.isArray(reportsData)) {
                            transactions = transformReportsToTransactions(reportsData);
                        } else if (reportsData.reports && Array.isArray(reportsData.reports)) {
                            transactions = transformReportsToTransactions(reportsData.reports);
                        }
                    }
                } catch (apiError) {
                    console.warn('API call failed, trying localStorage:', apiError);
                }
                
                // If no transactions from API, try localStorage
                if (transactions.length === 0) {
                    try {
                        const localReports = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                        if (Array.isArray(localReports)) {
                            transactions = transformReportsToTransactions(localReports);
                        }
                    } catch (localError) {
                        console.warn('localStorage read failed:', localError);
                    }
                }
                
                // Also try walk-in sales
                try {
                    const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
                    if (Array.isArray(walkInSales)) {
                        const salesTransactions = walkInSales.map(sale => ({
                            id: sale.id || `TXN-${Date.now()}`,
                            clientName: sale.customerName || 'Walk-in Customer',
                            branch: sale.branch || 'Unknown',
                            amount: sale.total || sale.totalAmount || 0,
                            date: sale.date || sale.timestamp?.split('T')[0] || new Date().toISOString().split('T')[0],
                            status: 'completed',
                            type: 'Walk-in Sale',
                            timestamp: new Date(sale.timestamp || Date.now())
                        }));
                        transactions = [...transactions, ...salesTransactions];
                    }
                } catch (salesError) {
                    console.warn('Walk-in sales load failed:', salesError);
                }
                
                allTransactions = transactions;
                
                // Update branches from transactions
                allBranches = [...new Set(allTransactions.map(t => t.branch).filter(Boolean))];
                if (allBranches.length === 0) {
                    allBranches = ['Windhoek', 'Walvis Bay', 'Oshakati', 'Rundu'];
                }
                
                // Load clients for reference (serverless API returns array)
                try {
                    const clientsResponse = await fetch('/api/clients');
                    if (clientsResponse.ok) {
                        const clientsData = await clientsResponse.json();
                        allClients = Array.isArray(clientsData) ? clientsData : [];
                    }
                } catch (e) {
                    // Try localStorage as fallback
                    try {
                        const localClients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                        allClients = Array.isArray(localClients) ? localClients : [];
                    } catch (localError) {
                        allClients = [];
                    }
                }
                
                populateBranchFilter();
                
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use sample data as last resort
                allTransactions = getSampleTransactions();
                allClients = getSampleClients();
                allBranches = ['Windhoek', 'Walvis Bay', 'Oshakati', 'Rundu'];
                populateBranchFilter();
            }
        }
        
        // Transform reports to transaction format
        function transformReportsToTransactions(reports) {
            return reports.map((report, index) => ({
                id: report.id || `TXN-${index + 1}`,
                clientName: report.clientName || 'Unknown Client',
                branch: report.branch || 'Unknown',
                amount: calculateReportValue(report),
                date: report.date || new Date().toISOString().split('T')[0],
                status: 'completed',
                type: 'Sale',
                timestamp: new Date()
            }));
        }
        
        function calculateReportValue(report) {
            let total = 0;
            if (report.products && Array.isArray(report.products)) {
                report.products.forEach(product => {
                    total += (product.quantity || 0) * (product.price || 0);
                });
            }
            return total.toFixed(2);
        }
        
        // Sample data generators
        function getSampleTransactions() {
            return [
                {
                    id: 'TXN-001',
                    clientName: 'Pharmacy ABC',
                    branch: 'Windhoek',
                    amount: 15000.00,
                    date: new Date().toISOString().split('T')[0],
                    status: 'completed',
                    type: 'Sale'
                },
                {
                    id: 'TXN-002',
                    clientName: 'Clinic XYZ',
                    branch: 'Walvis Bay',
                    amount: 8500.50,
                    date: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                    status: 'completed',
                    type: 'Sale'
                },
                {
                    id: 'TXN-003',
                    clientName: 'Hospital DEF',
                    branch: 'Oshakati',
                    amount: 25000.00,
                    date: new Date(Date.now() - 172800000).toISOString().split('T')[0],
                    status: 'pending',
                    type: 'Sale'
                }
            ];
        }
        
        function getSampleClients() {
            return [
                { name: 'Pharmacy ABC', branch: 'Windhoek' },
                { name: 'Clinic XYZ', branch: 'Walvis Bay' },
                { name: 'Hospital DEF', branch: 'Oshakati' }
            ];
        }
        
        function populateBranchFilter() {
            const branchFilter = document.getElementById('branchFilter');
            branchFilter.innerHTML = '<option value="all">All Branches</option>';
            
            allBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchFilter.appendChild(option);
            });
        }
        
        // Update dashboard statistics
        function updateDashboard() {
            const filtered = filterTransactions();
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate total revenue
            const totalRevenue = filtered.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            document.getElementById('totalRevenue').textContent = `NAD ${totalRevenue.toFixed(2)}`;
            
            // Calculate transactions today
            const todayTransactions = allTransactions.filter(t => t.date === today);
            document.getElementById('transactionsToday').textContent = todayTransactions.length;
            
            // Calculate active clients
            const uniqueClients = new Set(filtered.map(t => t.clientName));
            document.getElementById('activeClients').textContent = uniqueClients.size;
            
            // Calculate pending orders
            const pending = allTransactions.filter(t => t.status === 'pending');
            document.getElementById('pendingOrders').textContent = pending.length;
        }
        
        // Filter transactions based on selected filters
        function filterTransactions() {
            const dateRange = document.getElementById('dateRange').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            return allTransactions.filter(transaction => {
                // Date range filter
                if (dateRange !== 'all') {
                    const now = new Date();
                    const transactionDate = new Date(transaction.date);
                    
                    switch (dateRange) {
                        case 'today':
                            if (transaction.date !== now.toISOString().split('T')[0]) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (transactionDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (transactionDate < monthAgo) return false;
                            break;
                        case 'year':
                            const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                            if (transactionDate < yearAgo) return false;
                            break;
                    }
                }
                
                // Status filter
                if (statusFilter !== 'all' && transaction.status !== statusFilter) return false;
                
                // Branch filter
                if (branchFilter !== 'all' && transaction.branch !== branchFilter) return false;
                
                // Search filter
                if (searchInput) {
                    const searchTerm = searchInput.toLowerCase();
                    if (!transaction.id.toLowerCase().includes(searchTerm) &&
                        !transaction.clientName.toLowerCase().includes(searchTerm) &&
                        !transaction.branch.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // Load transactions table
        function loadTransactionsTable() {
            const filtered = filterTransactions();
            const tbody = document.getElementById('transactionsBody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No transactions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.slice(0, 10).map(transaction => `
                <tr>
                    <td>${transaction.id}</td>
                    <td>${transaction.clientName}</td>
                    <td>${transaction.branch}</td>
                    <td>NAD ${parseFloat(transaction.amount).toFixed(2)}</td>
                    <td>${formatDate(transaction.date)}</td>
                    <td><span class="status-badge status-${transaction.status}">${transaction.status.toUpperCase()}</span></td>
                </tr>
            `).join('');
        }
        
        // Load recent activity
        function loadRecentActivity() {
            const sortedTransactions = [...allTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentActivity = document.getElementById('recentActivity');
            
            recentActivity.innerHTML = sortedTransactions.slice(0, 5).map(transaction => `
                <div class="activity-item">
                    <h4>${transaction.type}: ${transaction.clientName}</h4>
                    <p>NAD ${parseFloat(transaction.amount).toFixed(2)} - ${transaction.branch}</p>
                    <div class="activity-time">${formatDate(transaction.date)}</div>
                </div>
            `).join('');
        }

        function loadGmStockRequests() {
            try {
                const result = getStockRequests({ status: 'all' }) || { data: [] };
                const requests = Array.isArray(result.data) ? result.data : [];
                gmPendingRequests = requests
                    .filter(req => req.status === 'pending_gm')
                    .sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0))
                    .slice(0, 20);
                renderGmStockRequests();
            } catch (error) {
                console.error('Failed to load GM stock requests:', error);
                gmPendingRequests = [];
                renderGmStockRequests();
            }
        }

        function renderGmStockRequests() {
            const container = document.getElementById('gmStockRequests');
            if (!container) return;

            if (!gmPendingRequests.length) {
                container.innerHTML = '<div class="no-data">No stock requests are waiting for GM approval.</div>';
                return;
            }

            container.innerHTML = gmPendingRequests.map(req => {
                const items = Array.isArray(req.items) ? req.items : [];
                const formattedDate = req.returnDate ? new Date(req.returnDate).toLocaleDateString() : '‚Äî';
                const notes = req.notes && req.notes.trim() ? req.notes : 'No additional notes';
                const listItems = items.length
                    ? `<ul>${items.map(item => `<li>${(item.description || item.productId || 'Item').toString()} ‚Äî <strong>${Number(item.quantity || 0)}</strong> ${item.uom || 'units'}</li>`).join('')}</ul>`
                    : '<div>No line items captured.</div>';
                return `
                    <div class="gm-request-card" data-request-id="${req.id}">
                        <div class="gm-request-header">
                            <div><strong>${req.requestNumber || req.id}</strong> ‚Ä¢ ${req.requestingBranch || 'Unknown branch'}</div>
                            <div class="gm-request-meta">Return by: ${formattedDate}</div>
                        </div>
                        <div class="gm-request-meta">Priority: ${(req.priority || 'normal').toUpperCase()}</div>
                        <div class="gm-request-items">
                            <div><strong>Items</strong></div>
                            ${listItems}
                        </div>
                        <div class="gm-request-meta" style="margin-top:10px;">Notes: ${notes}</div>
                        <div class="gm-request-actions">
                            <button class="btn btn-reject" data-gm-action="reject" data-request-id="${req.id}">Reject</button>
                            <button class="btn btn-approve" data-gm-action="approve" data-request-id="${req.id}">Approve</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showGmFeedback(message, variant = 'info') {
            const container = document.getElementById('gmStockRequests');
            if (!container) {
                alert(message);
                return;
            }
            const colors = {
                success: { bg: '#d1fae5', text: '#065f46' },
                warning: { bg: '#fef3c7', text: '#92400e' },
                error: { bg: '#fee2e2', text: '#991b1b' },
                info: { bg: '#e0e7ff', text: '#3730a3' }
            };
            const tone = colors[variant] || colors.info;
            const banner = document.createElement('div');
            banner.style.background = tone.bg;
            banner.style.color = tone.text;
            banner.style.padding = '10px 12px';
            banner.style.borderRadius = '8px';
            banner.style.marginBottom = '12px';
            banner.style.fontSize = '0.9em';
            banner.textContent = message;
            container.prepend(banner);
            setTimeout(() => {
                banner.style.opacity = '0';
                banner.style.transition = 'opacity .3s ease';
                setTimeout(() => banner.remove(), 320);
            }, 2000);
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // Refresh data
        async function refreshData() {
            try {
                await loadData();
                updateDashboard();
                loadTransactionsTable();
                loadRecentActivity();
                loadGmStockRequests();
                loadBranchPerformance();
                
                // Show success indicator
                const btn = document.querySelector('.btn-primary');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Refreshed';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Failed to refresh data. Please try again.');
            }
        }
        
        // Event listeners
        document.getElementById('dateRange').addEventListener('change', () => {
            loadTransactionsTable();
            updateDashboard();
        });
        
        document.getElementById('statusFilter').addEventListener('change', () => {
            loadTransactionsTable();
            updateDashboard();
        });
        
        document.getElementById('branchFilter').addEventListener('change', () => {
            loadTransactionsTable();
            updateDashboard();
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            loadTransactionsTable();
            updateDashboard();
        });
        
        const gmRequestsContainer = document.getElementById('gmStockRequests');
        if (gmRequestsContainer) {
            gmRequestsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('[data-gm-action]');
                if (!button) return;
                const action = button.getAttribute('data-gm-action');
                const requestId = button.getAttribute('data-request-id');
                if (!requestId) return;
                if (action === 'reject' && !confirm('Reject this stock request?')) {
                    return;
                }
                try {
                    approveStockRequest(requestId, {
                        approverRole: 'general_manager',
                        approvedBy: gmUser.fullName || 'General Manager',
                        approved: action === 'approve',
                        notes: ''
                    });
                    showGmFeedback(action === 'approve' ? 'Request forwarded to warehouse.' : 'Request rejected.', action === 'approve' ? 'success' : 'warning');
                    loadGmStockRequests();
                } catch (error) {
                    console.error('GM approval error:', error);
                    showGmFeedback('Failed to update request. Please try again.', 'error');
                }
            });
        }

        window.addEventListener('storage', (event) => {
            if (event.key === 'dyna_stock_requests') {
                loadGmStockRequests();
            }
        });
        window.addEventListener('stock-updated', () => loadGmStockRequests());

        // Initialize when page loads
        initializePortal();

        // Export current filtered transactions to CSV
        function exportCSV() {
            const filtered = filterTransactions();
            if (!filtered.length) {
                alert('No transactions to export for current filter.');
                return;
            }
            const headers = ['ID','Client','Branch','Amount','Date','Status'];
            const rows = filtered.map(t => [
                t.id,
                t.clientName,
                t.branch,
                parseFloat(t.amount).toFixed(2),
                t.date,
                t.status
            ]);
            const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gm-transactions-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        window.refreshData = refreshData;
        window.exportCSV = exportCSV;

        // Load branch performance using API helper
        async function loadBranchPerformance() {
            try {
                const { getBranchPerformance } = await import('./web-modules/transactions.js');
                const performance = await getBranchPerformance();
                const tbody = document.getElementById('branchPerformanceBody');
                if (!performance || !performance.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No branch data available</td></tr>';
                    return;
                }
                tbody.innerHTML = performance.map(p => `
                    <tr>
                        <td>${p.branch}</td>
                        <td>NAD ${parseFloat(p.revenue).toFixed(2)}</td>
                        <td>${p.transactions}</td>
                        <td>${p.activeClients}</td>
                        <td>NAD ${parseFloat(p.avgTransactionValue).toFixed(2)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading branch performance:', e);
                const tbody = document.getElementById('branchPerformanceBody');
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">Failed to load branch performance</td></tr>';
            }
        }
    </script>
</body>
</html>
