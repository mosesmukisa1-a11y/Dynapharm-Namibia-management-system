 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="api-base" content="/api">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#c41e3a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dynapharm">
    <link rel="manifest" href="./manifest.json">
    <!-- Explicit favicon to avoid /favicon.ico 404s -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23c41e3a'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, Helvetica, sans-serif' font-size='28' fill='%23ffffff'%3ED%3C/text%3E%3C/svg%3E">
    <script src="./cloud-sync.js"></script>
    <script src="./inventory-reporting.js"></script>
    <script>
        // Suppress console noise from expected image 404 errors
        // Note: Product images may not exist for all products, 404s are expected and handled gracefully
        (function() {
            const originalError = console.error;
            const originalWarn = console.warn;
            
            // Filter console.error calls
            console.error = function(...args) {
                // Filter out image 404 errors to reduce console noise
                const message = args.join(' ');
                if (message.includes('404') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    // Silently ignore expected image 404 errors - they're handled by onerror handlers
                    return;
                }
                // Filter 507 (Insufficient Storage) errors for images
                if (message.includes('507') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    return;
                }
                originalError.apply(console, args);
            };
            
            // Filter console.warn calls
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('404') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    return;
                }
                originalWarn.apply(console, args);
            };
            
            // Intercept network errors using global error handler
            window.addEventListener('error', function(event) {
                // Check if it's an image loading error
                if (event.target && event.target.tagName === 'IMG') {
                    const src = event.target.src || '';
                    if (src.includes('wp-content/uploads/products') || src.includes('dynapharm.net/ph/wp-content')) {
                        // Suppress the error - it's already handled by onerror handlers
                        event.preventDefault();
                        return false;
                    }
                }
                // Allow other errors through
            }, true); // Use capture phase to catch before default handlers
            
            // Intercept unhandled promise rejections from image loading
            window.addEventListener('unhandledrejection', function(event) {
                const reason = event.reason?.message || event.reason?.toString() || '';
                if (reason.includes('404') || reason.includes('wp-content/uploads/products') || reason.includes('dynapharm.net/ph/wp-content')) {
                    event.preventDefault();
                }
            });
        })();
        
        // Collect local data (localStorage + IndexedDB) and upload to /api/collect
        async function collectAndUploadSnapshot(providedToken) {
            try {
                const token = providedToken || (window.cloudStorage && window.cloudStorage.getStoredToken && window.cloudStorage.getStoredToken()) || '';
                if (!token) {
                    alert('GitHub token required to upload snapshot. Click the Save to Cloud button to store one.');
                    return { success: false };
                }

                // Gather localStorage keys starting with "dyna_"
                const ls = {};
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith('dyna_')) {
                            try { ls[k] = JSON.parse(localStorage.getItem(k)); } catch(_) { ls[k] = localStorage.getItem(k); }
                        }
                    }
                } catch(_) {}

                // Dump IndexedDB: DynapharmDB stores if present
                async function dumpIndexedDB() {
                    const out = {};
                    try {
                        const req = indexedDB.open('DynapharmDB');
                        const db = await new Promise((resolve, reject) => {
                            req.onerror = () => reject(req.error);
                            req.onsuccess = () => resolve(req.result);
                        });
                        const storeNames = Array.from(db.objectStoreNames || []);
                        for (const name of storeNames) {
                            try {
                                const tx = db.transaction(name, 'readonly');
                                const store = tx.objectStore(name);
                                const getAllReq = store.getAll();
                                const rows = await new Promise((resolve, reject) => {
                                    getAllReq.onerror = () => resolve([]);
                                    getAllReq.onsuccess = () => resolve(getAllReq.result || []);
                                });
                                out[name] = rows;
                            } catch(_) {}
                        }
                        try { db.close(); } catch(_) {}
                    } catch(_) {}
                    return out;
                }

                const idb = await dumpIndexedDB();

                const meta = {
                    hostname: location.hostname,
                    href: location.href,
                    userAgent: navigator.userAgent,
                    at: new Date().toISOString(),
                    currentUser: (window.currentUser && window.currentUser.username) || null,
                };
                const snapshot = { localStorage: ls, indexedDB: idb };

                const resp = await fetch('/api/collect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, snapshot, meta })
                });
                const json = await resp.json();
                if (resp.ok && json && json.success) {
                    alert('Snapshot uploaded: ' + json.id);
                    return { success: true };
                } else {
                    alert('Upload failed: ' + (json && json.error ? json.error : 'Unknown error'));
                    return { success: false };
                }
            } catch(e) {
                alert('Snapshot error: ' + e.message);
                return { success: false };
            }
        }

        function getAutoOrderSettings() {
            const defaults = {
                enabled: true,
                threshold: 20,
                frequency: 'weekly',
                requireApproval: false,
            };
            try {
                const stored = localStorage.getItem('dyna_auto_order_settings');
                if (!stored) return defaults;
                const parsed = JSON.parse(stored);
                return Object.assign({}, defaults, parsed || {});
            } catch (_) {
                return defaults;
            }
        }

        function applyAutoOrderSettings() {
            const settings = getAutoOrderSettings();
            const enabled = document.getElementById('autoOrdersEnabled');
            const threshold = document.getElementById('reorderThreshold');
            const freq = document.getElementById('autoOrderFrequency');
            const require = document.getElementById('requireOrderApproval');
            if (enabled) enabled.checked = !!settings.enabled;
            if (threshold) threshold.value = settings.threshold;
            if (freq) freq.value = settings.frequency;
            if (require) require.checked = !!settings.requireApproval;
        }

        function saveAutoOrderSettings() {
            const settings = {
                enabled: !!document.getElementById('autoOrdersEnabled')?.checked,
                threshold: Number(document.getElementById('reorderThreshold')?.value || 0),
                frequency: document.getElementById('autoOrderFrequency')?.value || 'weekly',
                requireApproval: !!document.getElementById('requireOrderApproval')?.checked,
                updatedAt: new Date().toISOString(),
            };
            localStorage.setItem('dyna_auto_order_settings', JSON.stringify(settings));
            showToast('Automatic order settings saved.');
            applyAutoOrderSettings();
        }

        function refreshAutomaticOrders() {
            loadStockOrders();
            showToast('Automatic orders refreshed.');
        }

        function closeManualOrderModal() {
            const modal = document.getElementById('manualOrderModal');
            if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
        }

        function getCatalogProducts() {
            const fromStorage = safeParseFromStorage('dyna_products', '[]');
            if (Array.isArray(fromStorage) && fromStorage.length) return fromStorage;
            if (Array.isArray(window.PRICE_LIST) && window.PRICE_LIST.length) {
                return window.PRICE_LIST.map(p => ({
                    id: createSlugId(p.description, 'prod'),
                    name: p.description,
                    description: p.description,
                }));
            }
            const barcodeStock = getBarcodeStockList();
            const map = new Map();
            barcodeStock.forEach(batch => {
                const name = batch.description || batch.productName || '';
                if (!name) return;
                map.set(name, { id: createSlugId(name, 'prod'), name, description: name });
            });
            return Array.from(map.values());
        }

        function showCreateManualOrder() {
            if (document.getElementById('manualOrderModal')) return;
            if (!Array.isArray(branches) || branches.length === 0) {
                syncBranchesFromBackend(true)
                    .then(() => showCreateManualOrder())
                    .catch(() => showToast('Unable to load branches. Try again later.'));
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'manualOrderModal';
            modal.style.position = 'fixed';
            modal.style.inset = '0';
            modal.style.background = 'rgba(15,23,42,0.6)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '10000';

            const dialog = document.createElement('div');
            dialog.style.background = '#ffffff';
            dialog.style.borderRadius = '12px';
            dialog.style.border = '1px solid #cbd5f5';
            dialog.style.width = 'min(520px, 94vw)';
            dialog.style.maxHeight = '90vh';
            dialog.style.overflowY = 'auto';
            dialog.style.boxShadow = '0 20px 45px rgba(15,23,42,0.35)';

            dialog.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #e2e8f0;">
                    <h3 style="margin:0;">Create Manual Order</h3>
                    <button class="btn" onclick="closeManualOrderModal()">Close</button>
                </div>
                <form id="manualOrderForm" style="padding:20px; display:grid; gap:16px;">
                    <div class="form-group">
                        <label class="required">Product</label>
                        <select id="manualOrderProduct" required></select>
                    </div>
                    <div class="form-group">
                        <label class="required">Quantity</label>
                        <input type="number" id="manualOrderQuantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Destination Branch</label>
                        <select id="manualOrderBranch">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="manualOrderSupplier" placeholder="Supplier name">
                    </div>
                    <div class="form-group">
                        <label>Expected Arrival</label>
                        <input type="date" id="manualOrderEta">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="manualOrderNotes" rows="2" placeholder="Special instructions or reference"></textarea>
                    </div>
                    <div style="text-align:right;">
                        <button type="submit" class="btn btn-success">Create Order</button>
                    </div>
                </form>
            `;

            modal.appendChild(dialog);
            modal.addEventListener('click', (event) => {
                if (event.target && event.target.id === 'manualOrderModal') {
                    closeManualOrderModal();
                }
            });
            document.body.appendChild(modal);

            const productSelect = document.getElementById('manualOrderProduct');
            const catalog = getCatalogProducts();
            productSelect.innerHTML = '<option value="">Select Product</option>';
            catalog.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod.name || prod.description;
                option.textContent = prod.name || prod.description || 'Product';
                option.dataset.productId = prod.id || '';
                productSelect.appendChild(option);
            });

            const branchSelect = document.getElementById('manualOrderBranch');
            if (branchSelect) {
                (branches || []).forEach(b => {
                    const option = document.createElement('option');
                    option.value = b.id;
                    option.textContent = b.name;
                    branchSelect.appendChild(option);
                });
            }

            const form = document.getElementById('manualOrderForm');
            form.addEventListener('submit', handleManualOrderSubmit);
        }

        function handleManualOrderSubmit(event) {
            event.preventDefault();
            const productSelect = document.getElementById('manualOrderProduct');
            const quantityInput = document.getElementById('manualOrderQuantity');
            if (!productSelect || !quantityInput) return;

            const productName = productSelect.value;
            const productId = productSelect.selectedOptions[0]?.dataset?.productId || '';
            const quantity = Number(quantityInput.value || 0);
            if (!productName) { showToast('Select a product.'); return; }
            if (!Number.isFinite(quantity) || quantity <= 0) { showToast('Enter a valid quantity.'); return; }

            const branchId = document.getElementById('manualOrderBranch')?.value || '';
            const supplier = (document.getElementById('manualOrderSupplier')?.value || '').trim();
            const eta = document.getElementById('manualOrderEta')?.value || '';
            const notes = (document.getElementById('manualOrderNotes')?.value || '').trim();

            const orders = getOrderList();
            orders.unshift({
                id: `ORDER-${Date.now()}`,
                type: 'manual',
                productId,
                product: productName,
                quantity,
                branchId: branchId || null,
                supplier: supplier || null,
                eta: eta || null,
                notes: notes || null,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.fullName || 'system',
            });
            persistOrderList(orders);
            loadStockOrders();
            showToast('Manual order created.');
            closeManualOrderModal();
        }

        function getSharingLocationOptions() {
            const options = [
                { id: 'country_stock', label: 'Country Stock' },
                { id: 'warehouse:windhoek', label: 'Warehouse ‚Ä¢ Windhoek' },
                { id: 'warehouse:ondangwa', label: 'Warehouse ‚Ä¢ Ondangwa' },
            ];
            (branches || []).forEach(branch => {
                options.push({
                    id: `branch:${branch.id}`,
                    label: `Branch ‚Ä¢ ${branch.name}`,
                });
            });
            return options;
        }

        function populateSharingLocations() {
            const fromSelect = document.getElementById('sharingFrom');
            const toSelect = document.getElementById('sharingTo');
            if (!fromSelect || !toSelect) return;
            const options = getSharingLocationOptions();
            const renderOptions = (select) => {
                select.innerHTML = '<option value="">Select Location</option>';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });
            };
            renderOptions(fromSelect);
            renderOptions(toSelect);
        }

        // Auto-trigger when URL has ?collect=1
        (function(){
            try {
                const u = new URL(location.href);
                if (u.searchParams.get('collect') === '1') {
                    setTimeout(() => { collectAndUploadSnapshot(); }, 500);
                }
            } catch(_) {}
        })();

        // Fun: Floating Cat overlay (toggleable)
        (function addFloatingCat(){
            try {
                const style = document.createElement('style');
                style.textContent = `
                @keyframes dyna-cat-float { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
                #dynaFloatingCat { position: fixed; right: 16px; bottom: 16px; z-index: 9999; display: flex; align-items: flex-end; gap: 8px; }
                #dynaFloatingCat .cat { width: 72px; height: 72px; animation: dyna-cat-float 3s ease-in-out infinite; filter: drop-shadow(0 4px 8px rgba(0,0,0,.2)); cursor: pointer; }
                #dynaFloatingCat .toggle { background:#c41e3a; color:#fff; border:none; border-radius:999px; padding:8px 10px; cursor:pointer; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,.2) }
                @media (max-width: 480px) { #dynaFloatingCat .cat { width: 56px; height: 56px; } }
                `;
                document.head.appendChild(style);

                const wrap = document.createElement('div');
                wrap.id = 'dynaFloatingCat';
                wrap.innerHTML = `
                    <img class="cat" alt="Friendly cat" title="Meow!" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%23fff3'/%3E%3Cpath d='M32 52c0-18 12-28 32-28s32 10 32 28-14 28-32 28S32 70 32 52z' fill='%23ffd28a' stroke='%232c3e50' stroke-width='2'/%3E%3Ccircle cx='50' cy='56' r='6' fill='%232c3e50'/%3E%3Ccircle cx='78' cy='56' r='6' fill='%232c3e50'/%3E%3Cpath d='M56 72c4 4 12 4 16 0' stroke='%232c3e50' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3Cpath d='M44 30l6 10M84 30l-6 10' stroke='%232c3e50' stroke-width='3'/%3E%3C/svg%3E" />
                    <button class="toggle" aria-pressed="true" aria-label="Hide cat" title="Hide cat">üò∫</button>
                `;
                const shouldShow = localStorage.getItem('dyna_show_cat') !== 'false';
                wrap.style.display = shouldShow ? 'flex' : 'none';
                
        const SYNC_SETTINGS_STORAGE_KEY = 'dyna_sync_settings';
        const SYNC_EVENTS_STORAGE_KEY = 'dyna_sync_events';
        let cachedSyncSettings = null;
        let cachedSyncEvents = null;
        let lastRealtimeStatusCheck = 0;
        let realtimeStatusSnapshot = {};

        function getDefaultSyncSettings() {
            const origin = window.location.origin || '';
            return {
                frequency: 'realtime',
                autoSync: true,
                syncStockChanges: true,
                syncOrderChanges: true,
                endpoints: {
                    stock: `${API_BASE}/health`,
                    branch: `${origin}/branch-stock-inventory.html`,
                    gm: `${API_BASE}/health?realm=gm`
                },
                updatedAt: null
            };
        }

        function mergeSyncSettings(baseSettings, override = {}) {
            const merged = { ...baseSettings, ...override };
            merged.endpoints = { ...baseSettings.endpoints, ...(override.endpoints || {}) };
            return merged;
        }

        function getSyncSettings(force = false) {
            if (!force && cachedSyncSettings) {
                return mergeSyncSettings(getDefaultSyncSettings(), cachedSyncSettings);
            }
            let stored = null;
            try {
                const raw = localStorage.getItem(SYNC_SETTINGS_STORAGE_KEY);
                stored = raw ? JSON.parse(raw) : null;
            } catch (error) {
                console.debug('Sync settings unavailable', error);
            }
            cachedSyncSettings = mergeSyncSettings(getDefaultSyncSettings(), stored || {});
            return cachedSyncSettings;
        }

        function persistSyncSettings(settings) {
            try {
                localStorage.setItem(SYNC_SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            } catch (error) {
                console.warn('Failed to persist sync settings', error);
            }
            cachedSyncSettings = settings;
        }

        function getSyncEvents(force = false) {
            if (!force && Array.isArray(cachedSyncEvents)) {
                return cachedSyncEvents.slice();
            }
            let events = [];
            try {
                const raw = localStorage.getItem(SYNC_EVENTS_STORAGE_KEY);
                const parsed = raw ? JSON.parse(raw) : [];
                if (Array.isArray(parsed)) {
                    events = parsed;
                }
            } catch (error) {
                console.debug('Sync events unavailable', error);
            }
            cachedSyncEvents = events;
            return events.slice();
        }

        function persistSyncEvents(events) {
            const normalised = (events || []).slice(0, 100);
            try {
                localStorage.setItem(SYNC_EVENTS_STORAGE_KEY, JSON.stringify(normalised));
            } catch (error) {
                console.warn('Failed to persist sync events', error);
            }
            cachedSyncEvents = normalised;
            renderRealtimeSyncEvents(normalised);
        }

        function formatSyncTimestamp(value) {
            try {
                const date = value ? new Date(value) : new Date();
                if (Number.isNaN(date.getTime())) return 'Just now';
                return date.toLocaleString();
            } catch (_) {
                return new Date().toLocaleString();
            }
        }

        function updateRealtimeBanner(settings) {
            const banner = document.getElementById('realtimeStatus');
            if (!banner) return;
            if (!settings?.autoSync) {
                banner.textContent = '‚è∏Ô∏è Real-time sync paused';
                banner.style.display = 'block';
                banner.classList.add('paused');
                banner.classList.remove('active');
                return;
            }
            banner.textContent = 'üîÑ Real-time sync active';
            banner.style.display = 'block';
            banner.classList.add('active');
            banner.classList.remove('paused');
        }

        function setSyncStatusPill(elementId, state, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.classList.remove('good', 'warn', 'bad');
            switch (state) {
                case 'connected':
                    el.classList.add('good');
                    el.textContent = message || 'üü¢ Connected';
                    break;
                case 'degraded':
                    el.classList.add('warn');
                    el.textContent = message || 'üü° Checking';
                    break;
                case 'checking':
                    el.classList.add('warn');
                    el.textContent = message || 'üü° Checking';
                    break;
                default:
                    el.classList.add('bad');
                    el.textContent = message || 'üî¥ Offline';
                    break;
            }
        }

        function renderRealtimeSyncEvents(events = []) {
            const container = document.getElementById('realtimeSyncEvents');
            if (!container) return;
            if (!events.length) {
                container.innerHTML = '<p style="color:#7f8c8d; text-align:center;">No sync activity recorded yet.</p>';
                return;
            }
            const fragments = events.slice(0, 50).map((event) => {
                const success = event.success !== false;
                const border = success ? '#27ae60' : '#e74c3c';
                const badge = success ? 'üü¢' : 'üî¥';
                const when = formatSyncTimestamp(event.timestamp);
                const actor = event.initiatedBy || 'system';
                const target = event.target ? `‚Ä¢ ${event.target.toUpperCase()}` : '';
                const latency = event.latencyMs ? ` ‚Ä¢ ${event.latencyMs}ms` : '';
                return `
                <div class="client-card" style="border-left:4px solid ${border};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${badge} ${event.message || 'Sync event'}</div>
                            <div style="font-size:.85rem; color:#666;">${when} ‚Ä¢ ${actor} ${target}${latency}</div>
                        </div>
                        ${event.type ? `<span style="font-size:.75rem; color:#888;">${event.type.toUpperCase()}</span>` : ''}
                    </div>
                </div>`;
            });
            container.innerHTML = fragments.join('');
        }

        function logSyncEvent(type, message, options = {}) {
            const events = getSyncEvents(true);
            const event = {
                id: `SYNC-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                type: type || 'status',
                message,
                success: options.success !== false,
                target: options.target || null,
                detail: options.detail || null,
                latencyMs: options.latencyMs ?? null,
                initiatedBy: options.initiatedBy || (window.currentUser && window.currentUser.fullName) || 'system',
                timestamp: new Date().toISOString()
            };
            events.unshift(event);
            persistSyncEvents(events);
            return event;
        }

        function applySyncSettings(settings) {
            const current = settings ? mergeSyncSettings(getDefaultSyncSettings(), settings) : getSyncSettings();
            const frequencySelect = document.getElementById('syncFrequency');
            if (frequencySelect) {
                frequencySelect.value = current.frequency || 'realtime';
            }
            const autoSync = document.getElementById('autoSyncEnabled');
            if (autoSync) {
                autoSync.checked = current.autoSync !== false;
            }
            const syncStock = document.getElementById('syncStockChanges');
            if (syncStock) {
                syncStock.checked = current.syncStockChanges !== false;
            }
            const syncOrders = document.getElementById('syncOrderChanges');
            if (syncOrders) {
                syncOrders.checked = current.syncOrderChanges !== false;
            }
            updateRealtimeBanner(current);
            renderRealtimeSyncEvents(getSyncEvents());
            return current;
        }

        async function saveSyncSettings() {
            const settings = getSyncSettings();
            const frequencySelect = document.getElementById('syncFrequency');
            const autoSync = document.getElementById('autoSyncEnabled');
            const syncStock = document.getElementById('syncStockChanges');
            const syncOrders = document.getElementById('syncOrderChanges');
            if (frequencySelect) settings.frequency = frequencySelect.value || settings.frequency;
            if (autoSync) settings.autoSync = !!autoSync.checked;
            if (syncStock) settings.syncStockChanges = !!syncStock.checked;
            if (syncOrders) settings.syncOrderChanges = !!syncOrders.checked;
            settings.updatedAt = new Date().toISOString();
            persistSyncSettings(settings);
            applySyncSettings(settings);
            logSyncEvent('settings', `Sync settings updated (${settings.frequency})`, { success: true, detail: settings });
            if (typeof showToast === 'function') {
                showToast('Realtime sync settings saved ‚úÖ');
            } else {
                console.info('Realtime sync settings saved');
            }
        }

        async function pingSyncEndpoint(url, label) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 8000);
            const started = performance.now();
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    cache: 'no-store',
                    signal: controller.signal
                });
                clearTimeout(timeout);
                const latency = Math.round(performance.now() - started);
                return {
                    ok: response.ok,
                    status: response.status,
                    latency,
                    label
                };
            } catch (error) {
                clearTimeout(timeout);
                const latency = Math.round(performance.now() - started);
                return {
                    ok: false,
                    error: error && error.message ? error.message : 'Network error',
                    latency,
                    label
                };
            }
        }

        async function loadRealtimeSyncStatus(force = false) {
            const now = Date.now();
            if (!force && now - lastRealtimeStatusCheck < 15000) {
                renderRealtimeSyncEvents(getSyncEvents());
                return realtimeStatusSnapshot;
            }
            lastRealtimeStatusCheck = now;
            const settings = getSyncSettings();
            const endpoints = settings.endpoints || {};
            const targets = [
                { id: 'syncStockPortal', key: 'stock', url: endpoints.stock },
                { id: 'syncBranchPortal', key: 'branch', url: endpoints.branch },
                { id: 'syncGMPortal', key: 'gm', url: endpoints.gm }
            ];
            targets.forEach((target) => setSyncStatusPill(target.id, 'checking'));
            const results = await Promise.all(targets.map(async (target) => {
                if (!target.url) {
                    setSyncStatusPill(target.id, 'offline', '‚ö™ Unknown');
                    return { key: target.key, ok: false, error: 'No endpoint configured' };
                }
                const result = await pingSyncEndpoint(target.url, target.key);
                if (result.ok) {
                    setSyncStatusPill(target.id, 'connected', `üü¢ ${result.latency || 0}ms`);
                } else {
                    const isOffline = result.error === 'Network error' || result.error === 'Failed to fetch';
                    const message = isOffline ? 'üî¥ Offline' : 'üü† Issue';
                    const state = isOffline ? 'offline' : 'degraded';
                    setSyncStatusPill(target.id, state, message);
                }
                const previous = realtimeStatusSnapshot[target.key];
                const statusChanged = !previous || previous.ok !== result.ok || previous.error !== result.error;
                if (statusChanged) {
                    logSyncEvent('status', `${target.key.toUpperCase()} portal ${result.ok ? 'responded' : 'failed'}`, {
                        success: result.ok,
                        target: target.key,
                        latencyMs: result.latency,
                        detail: result
                    });
                }
                return { key: target.key, ...result };
            }));
            realtimeStatusSnapshot = results.reduce((acc, entry) => {
                if (entry && entry.key) {
                    acc[entry.key] = entry;
                }
                return acc;
            }, {});
            return realtimeStatusSnapshot;
        }

        async function testSyncConnection() {
            logSyncEvent('diagnostic', 'Manual sync test triggered', { detail: { source: 'manual' } });
            await loadRealtimeSyncStatus(true);
            if (typeof showToast === 'function') {
                showToast('Realtime sync test completed');
            }
        }

        window.addEventListener('cloud-sync:updated', (event) => {
            const detail = event && event.detail ? event.detail : {};
            logSyncEvent('stock', 'Stock data synchronised', {
                success: true,
                target: detail.scope || 'stock',
                detail
            });
        });

        window.addEventListener('orders:updated', (event) => {
            const detail = event && event.detail ? event.detail : {};
            const order = detail.order || {};
            const action = detail.action || 'updated';
            const ref = order.id || order.orderNumber || 'order';
            logSyncEvent('orders', `Order ${ref} ${action}`, {
                success: true,
                target: 'orders',
                detail
            });
        });

        document.addEventListener('DOMContentLoaded', () => { document.body.appendChild(wrap); });
                const btn = wrap.querySelector('.toggle');
                btn.addEventListener('click', () => {
                    const visible = wrap.style.display !== 'none';
                    if (visible) { wrap.style.display = 'none'; localStorage.setItem('dyna_show_cat', 'false'); }
                    else { wrap.style.display = 'flex'; localStorage.setItem('dyna_show_cat', 'true'); }
                });
            } catch(_) {}
        })();

        // Ensure shared datasets exist before dependent features run
        let PACKAGE_DATABASE = window.PACKAGE_DATABASE || {};

        const WalkInCartStore = (() => {
            const STORAGE_KEY = 'dyna_walkin_cart_session';
            const ensureArray = (value) => Array.isArray(value) ? value : [];
            const loadInitialCart = () => {
                const fromWindow = ensureArray(window.walkInCart);
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            return parsed;
                        }
                    }
                } catch (_) {}
                return [...fromWindow];
            };
            let cart = ensureArray(loadInitialCart());
            const sync = () => { window.walkInCart = cart; };
            const persist = () => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
                } catch (_) {}
            };
            sync();
            return {
                get() {
                    cart = ensureArray(cart);
                    sync();
                    return cart;
                },
                replace(nextCart) {
                    cart = ensureArray(nextCart).map(item => ({ ...item }));
                    sync();
                    persist();
                    return cart;
                },
                update(mutator) {
                    cart = ensureArray(cart);
                    try {
                        mutator(cart);
                    } catch (err) {
                        console.error('WalkInCartStore.update error:', err);
                    }
                    sync();
                    persist();
                    return cart;
                },
                clear() {
                    cart = [];
                    sync();
                    persist();
                    return cart;
                },
                persist
            };
        })();
        window.walkInCartStore = WalkInCartStore;
    </script>
    
    <!-- Optional: Backend API base override (set this in deployments) -->
    <!-- Example: <meta name="api-base" content="https://dynapharm-backend-production.up.railway.app/api"> -->
    <!-- For local development with PostgreSQL backend: -->
    <meta name="api-base" content="/api">
    <meta name="rt-base" content="https://web-production-f9aa.up.railway.app">
    <title>Dynapharm International Namibia - v2.0</title>
    <!-- FullCalendar.js -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        (function(){
            const isGitHub = location.hostname.endsWith('github.io');
            const meta = document.querySelector('meta[name="api-base"]');
            const configured = meta && meta.content && meta.content.trim();
            const defaultApiBase = `${location.origin.replace(/\/+$/, '')}/api`;
            const vercelApiBase = (configured || defaultApiBase).replace(/\/+$/, '');
            const originalFetch = window.fetch.bind(window);
            window.fetch = function(input, init){
                try {
                    const reqUrl = typeof input === 'string' ? new URL(input, location.origin) : new URL(input.url, location.origin);
                    if (isGitHub && reqUrl.pathname.startsWith('/api/')) {
                        const path = reqUrl.pathname.replace(/^\/api/, '');
                        const proxied = vercelApiBase + path + (reqUrl.search || '');
                        return originalFetch(proxied, init);
                    }
                } catch(_){}
                return originalFetch(input, init);
            };
        })();
    </script>
    <script>
        // ========== Branch Online Orders ==========
        async function fetchAllOrders(){
            try {
                if (typeof apiRequest === 'function') {
                    const res = await apiRequest('/orders', 'GET');
                    if (Array.isArray(res)) return res;
                }
            } catch(_) {}
            try {
                const endpoints = ['/api/orders', 'http://localhost:8001/api/orders'];
                for (let i=0;i<endpoints.length;i++){
                    try {
                        const r = await fetch(endpoints[i]);
                        if (r.ok) { const j = await r.json(); if (Array.isArray(j)) return j; }
                    } catch (_) {}
                }
            } catch (_) {}
            try { return JSON.parse(localStorage.getItem('dyna_online_orders')||'[]'); } catch(_) { return []; }
        }

        async function displayBranchOnlineOrders(){
            const recvEl = document.getElementById('branchOnlineOrdersReceiving');
            const dispEl = document.getElementById('branchOnlineOrdersDispensing');
            if (!recvEl || !dispEl) return;
            recvEl.innerHTML = '<p style="color:#7f8c8d;">Loading...</p>';
            dispEl.innerHTML = '';
            const branchId = (window.currentUser && window.currentUser.branch) || '';
            const all = await fetchAllOrders();
            const mine = all.filter(o => (o.branch||'').toString().toLowerCase() === (branchId||'').toString().toLowerCase());
            const pending = mine.filter(o => (o.status||'pending') === 'pending' || (o.status||'')==='received');
            const ready = mine.filter(o => (o.status||'')==='paid' || (o.status||'')==='ready');

            const renderCard = (o, area) => `
                <div style="border:1px solid #eee; border-radius:8px; padding:12px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; gap:10px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${o.customerName||'Unknown'} <span style="color:#7f8c8d; font-weight:400;">(${o.customerType||'customer'})</span></div>
                            <div style="color:#7f8c8d; font-size:12px;">${o.id} ‚Ä¢ ${new Date(o.date||Date.now()).toLocaleString()}</div>
                            <div style="color:#2c3e50; margin-top:6px;">N$ ${(Number(o.total||0)).toFixed(2)}</div>
                            <div style="color:#7f8c8d; font-size:12px;">Items: ${(o.items||[]).map(i=>`${i.name} x${i.quantity||1}`).join(', ')}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="margin-bottom:8px;"><span style="background:#f1f5f9; padding:4px 8px; border-radius:999px; font-size:12px;">${o.status||'pending'}</span></div>
                            ${area==='recv' ? `
                                <button class="btn btn-info" onclick="markOrderReceived('${o.id}')">üì• Receive</button>
                                <button class="btn btn-success" style="margin-left:6px;" onclick="markOrderPaid('${o.id}')">‚úÖ Mark Paid</button>
                            ` : `
                                <button class="btn btn-success" onclick="dispenseOnlineOrder('${o.id}')">üì¶ Dispense</button>
                            `}
                        </div>
                    </div>
                </div>`;

            recvEl.innerHTML = pending.length ? pending.map(o=>renderCard(o,'recv')).join('') : '<p style="color:#7f8c8d;">No pending online orders.</p>';
            dispEl.innerHTML = ready.length ? ready.map(o=>renderCard(o,'disp')).join('') : '<p style="color:#7f8c8d;">No paid online orders.</p>';
        }

        async function updateOrderOnServer(order){
            try {
                if (typeof apiRequest === 'function') {
                    const res = await apiRequest('/orders', 'PUT', order);
                    return res;
                }
            } catch(_) {}
            try {
                const r = await fetch('/api/orders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order)});
                if (r.ok) return await r.json();
            } catch(_) {}
            try {
                const r = await fetch('http://localhost:8001/api/orders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order)});
                if (r.ok) return await r.json();
            } catch(_) {}
            return { success: false };
        }

        async function markOrderReceived(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            o.status = 'received';
            o.receivedAt = new Date().toISOString();
            o.receivedBy = (window.currentUser && window.currentUser.fullName) || 'system';
            const res = await updateOrderOnServer(o);
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'received' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'received', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'received', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                displayBranchOnlineOrders();
            } else { alert('Failed to update order'); }
        }

        async function markOrderPaid(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            o.status = 'paid';
            o.payment = Object.assign({}, o.payment||{}, { verified: true, provider: o.payment?.provider||'manual', verifiedAt: new Date().toISOString(), verifiedBy: (window.currentUser && window.currentUser.fullName)||'system' });
            const res = await updateOrderOnServer(o);
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'paid' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'paid', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'paid', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                displayBranchOnlineOrders();
            } else { alert('Failed to mark paid'); }
        }

        async function dispenseOnlineOrder(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            // FEFO mandatory: deduct via barcode/batch FEFO first
            const branchId = (window.currentUser && window.currentUser.branch) || 'unknown_branch';
            const userName = (window.currentUser && window.currentUser.fullName) || 'system';
            try {
                const fefo = await fefoDispenseProducts((o.items||[]).map(i=>({ name:i.name||i.productName, quantity:i.quantity||1 })), branchId, userName, o.id);
                if (!fefo.success) {
                    if (!confirm('FEFO stock issues detected:\n' + fefo.errors.join('\n') + '\n\nDispense anyway?')) return;
                }
            } catch (e) {
                console.warn('FEFO dispense failed, falling back to simple counters:', e);
            }
            // Update legacy counters for dashboards
            const inv = reduceInventoryForProducts(o.items||[], userName, o.id);
            o.status = 'dispensed';
            o.dispensedAt = new Date().toISOString();
            o.dispensedBy = (window.currentUser && window.currentUser.fullName) || 'system';
            const res = await updateOrderOnServer(o);
            try { recordDepartmentEvent && recordDepartmentEvent('online_sale', o); } catch(_) {}
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'dispensed' } }));
                    window.dispatchEvent(new CustomEvent('sale:updated', { detail: { sale: o, type: 'online' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'dispensed', ts: Date.now() } })
                        }).catch(_ => {});
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'sale:updated', sale: o, type: 'online', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'dispensed', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                alert('Order dispensed');
                displayBranchOnlineOrders();
            }
            else { alert('Failed to update order after dispense'); }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .logo {
            text-align: center;
            padding: 20px;
            background: white;
        }
        .logo svg {
            display: block;
            margin: 0 auto;
            max-width: 300px;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .global-alerts {
            margin: 15px auto 0 auto;
            max-width: 1400px;
            display: none;
        }
        .global-alerts .alert {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
            border-left: 6px solid #f39c12;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 20px;
        }
        .global-alerts .alert strong { margin-right: 8px; }

        .branch-selector {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        

        .branch-selector select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            width: 300px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #c41e3a;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }
        .tab-button.active { background: white; color: #c41e3a; font-weight: bold; }
#stockWorkflowNav {
    margin-top: 18px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
}
#stockWorkflowNav .workflow-tab {
    justify-content: flex-start;
    text-align: left;
    background: rgba(196, 30, 58, 0.08);
    color: #0f1830;
    border-radius: 10px;
    border: 1px solid rgba(196, 30, 58, 0.2);
    font-weight: 600;
    transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}
#stockWorkflowNav .workflow-tab:hover {
    background: rgba(196, 30, 58, 0.15);
    border-color: rgba(196, 30, 58, 0.35);
}
#stockWorkflowNav .workflow-tab.active {
    background: #c41e3a;
    color: #ffffff;
    border-color: #c41e3a;
}
#stockContent .stock-hub-shell {
    display: flex;
    flex-direction: column;
    gap: 28px;
    padding-bottom: 48px;
}
#stockContent .stock-hub-hero {
    position: relative;
    overflow: hidden;
    border-radius: 32px;
    padding: 40px;
    background: radial-gradient(140% 180% at 100% 0%, rgba(103, 232, 249, 0.55) 0%, rgba(14, 116, 144, 0.9) 55%, rgba(15, 23, 42, 0.95) 100%);
    color: #ffffff;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: stretch;
    gap: 32px;
    box-shadow: 0 40px 70px rgba(15, 23, 42, 0.22);
}
#stockContent .stock-hub-hero::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(103, 232, 249, 0.18) 100%);
    pointer-events: none;
}
#stockContent .stock-hub-hero__text {
    position: relative;
    z-index: 1;
    max-width: min(520px, 100%);
    display: flex;
    flex-direction: column;
    gap: 18px;
}
#stockContent .stock-hub-hero__eyebrow {
    margin: 0;
    font-size: 0.82rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    font-weight: 700;
    opacity: 0.75;
}
#stockContent .stock-hub-hero__text h2 {
    margin: 0;
    font-size: clamp(2.1rem, 3vw, 2.8rem);
    letter-spacing: -0.015em;
}
#stockContent .stock-hub-hero__text p {
    margin: 0;
    color: rgba(241, 245, 249, 0.86);
    line-height: 1.7;
    font-size: 1.02rem;
}
#stockContent .stock-hub-hero__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}
#stockContent .hub-btn {
    border: none;
    border-radius: 999px;
    padding: 12px 24px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.2);
    backdrop-filter: blur(10px);
}
#stockContent .hub-btn:hover {
    transform: translateY(-2px);
    opacity: 0.95;
}
#stockContent .hub-btn--primary {
    background: linear-gradient(135deg, #38bdf8, #0ea5e9);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.25);
}
#stockContent .hub-btn--ghost {
    background: rgba(15, 23, 42, 0.15);
    color: #e2e8f0;
    border: 1px solid rgba(226, 232, 240, 0.35);
}
#stockContent .stock-hub-hero__profile {
    position: relative;
    z-index: 1;
    min-width: min(260px, 100%);
    flex: 1;
    background: rgba(15, 23, 42, 0.35);
    border: 1px solid rgba(226, 232, 240, 0.2);
    border-radius: 24px;
    padding: 20px;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);
}
#stockContent .stock-hub-mode-toggle {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}
#stockContent .stock-hub-mode-toggle .hub-toggle-btn {
    border: 1px solid rgba(15, 23, 42, 0.15);
    background: #ffffff;
    color: #0f172a;
    border-radius: 16px;
    padding: 12px 18px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
}
#stockContent .stock-hub-mode-toggle .hub-toggle-btn.hub-toggle-btn--active {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #ffffff;
    box-shadow: 0 18px 28px rgba(37, 99, 235, 0.25);
    border-color: transparent;
}
#stockContent .stock-hub-mode-toggle .hub-toggle-btn:hover {
    background: rgba(37, 99, 235, 0.08);
}
#stockContent .stock-hub-shell #stockWorkflowNav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    background: #0f172a;
    border-radius: 24px;
    padding: 18px;
    border: 1px solid rgba(15, 23, 42, 0.5);
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.12);
}
#stockContent .stock-hub-shell #stockWorkflowNav .workflow-tab {
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.24);
    background: rgba(15, 23, 42, 0.35);
    color: #e2e8f0;
    padding: 14px 16px;
    justify-content: flex-start;
    text-align: left;
    font-weight: 600;
    letter-spacing: 0.01em;
    transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
}
#stockContent .stock-hub-shell #stockWorkflowNav .workflow-tab:hover {
    transform: translateY(-1px);
    border-color: rgba(148, 163, 184, 0.45);
    background: rgba(59, 130, 246, 0.18);
}
#stockContent .stock-hub-shell #stockWorkflowNav .workflow-tab.active {
    background: linear-gradient(135deg, #2563eb, #4338ca);
    border-color: transparent;
    color: #ffffff;
    box-shadow: 0 22px 36px rgba(37, 99, 235, 0.2);
}
#stockContent .stock-hub-tabs {
    display: flex;
    flex-direction: column;
    gap: 18px;
}
#stockContent .stock-hub-tab-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    background: #ffffff;
    padding: 12px;
    border-radius: 18px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
}
#stockContent .stock-hub-tab-row--secondary {
    background: #0f172a;
    border: 1px solid rgba(37, 99, 235, 0.35);
    box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.25);
    color: #e2e8f0;
}
#stockContent .stock-hub-tab-row--secondary .stock-hub-tab-label {
    font-size: 0.85rem;
    color: #cbd5f5;
    align-self: center;
    padding-right: 8px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    pointer-events: none;
}
#stockContent .stock-hub-tab-row--secondary .tab-button {
    color: #e2e8f0;
    border-color: rgba(226, 232, 240, 0.22);
    background: rgba(15, 23, 42, 0.35);
}
#stockContent .stock-hub-tab-row .tab-button {
    border-radius: 14px;
    padding: 10px 18px;
    background: rgba(15, 23, 42, 0.05);
    border: 1px solid rgba(15, 23, 42, 0.12);
    color: #0f172a;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease, transform 0.18s ease;
}
#stockContent .stock-hub-tab-row .tab-button:hover {
    transform: translateY(-1px);
    background: rgba(37, 99, 235, 0.12);
    border-color: rgba(37, 99, 235, 0.35);
}
#stockContent .stock-hub-tab-row .tab-button.active {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #ffffff;
    border-color: transparent;
    box-shadow: 0 16px 28px rgba(37, 99, 235, 0.22);
}
#stockContent .stock-hub-tab-row--secondary .tab-button.active {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(99, 102, 241, 0.95));
}
#stockContent .hub-tab-stack {
    display: flex;
    flex-direction: column;
    gap: 24px;
}
#stockContent .hub-section {
    background: #ffffff;
    border-radius: 28px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 28px 46px rgba(15, 23, 42, 0.12);
    padding: 28px 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
#stockContent .hub-section__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 16px;
}
#stockContent .hub-section__title {
    margin: 0;
    font-size: 1.5rem;
    color: #0f172a;
}
#stockContent .hub-section__meta {
    margin: 0;
    color: #64748b;
    max-width: 520px;
    line-height: 1.7;
}
#stockContent .hub-section__actions {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-left: auto;
}
#stockContent .hub-section__actions label {
    font-size: 0.85rem;
    color: #94a3b8;
}
#stockContent .hub-metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 18px;
}
#stockContent .hub-metric-card {
    position: relative;
    border-radius: 24px;
    padding: 24px 26px;
    color: #ffffff;
    display: flex;
    gap: 16px;
    align-items: center;
    overflow: hidden;
}
#stockContent .hub-metric-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.3), transparent 60%);
    opacity: 0.65;
}
#stockContent .hub-metric-card[data-variant="value"] {
    background: linear-gradient(135deg, #0ea5e9, #2563eb);
}
#stockContent .hub-metric-card[data-variant="pending"] {
    background: linear-gradient(135deg, #f97316, #ea580c);
}
#stockContent .hub-metric-card[data-variant="low"] {
    background: linear-gradient(135deg, #facc15, #eab308);
}
#stockContent .hub-metric-card[data-variant="transfers"] {
    background: linear-gradient(135deg, #c084fc, #8b5cf6);
}
#stockContent .hub-metric-card__icon {
    position: relative;
    z-index: 1;
    font-size: 2rem;
}
#stockContent .hub-metric-card__body {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
#stockContent .hub-metric-card__label {
    margin: 0;
    font-size: 0.92rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    opacity: 0.82;
}
#stockContent .hub-metric-card__value {
    margin: 0;
    font-size: 2.1rem;
    font-weight: 700;
    letter-spacing: -0.02em;
}
#stockContent .hub-panel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}
#stockContent .hub-panel {
    background: #0f172a;
    border-radius: 20px;
    border: 1px solid rgba(37, 99, 235, 0.25);
    padding: 18px 20px;
    color: #cbd5f5;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.06);
}
#stockContent .hub-panel__heading {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    opacity: 0.8;
}
#stockContent .hub-panel__value {
    margin: 12px 0 0;
    font-size: 1.8rem;
    font-weight: 700;
    color: #f8fafc;
}
#stockContent .hub-panel__meta {
    margin: 6px 0 0;
    font-size: 0.85rem;
    color: rgba(148, 163, 184, 0.75);
}
#stockContent .hub-flow {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px;
    align-items: stretch;
}
#stockContent .hub-flow__node {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.02), rgba(37, 99, 235, 0.08));
    border-radius: 20px;
    border: 1px solid rgba(37, 99, 235, 0.15);
    padding: 18px;
    text-align: center;
    color: #0f172a;
    box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
}
#stockContent .hub-flow__node strong {
    display: block;
    margin-bottom: 8px;
    font-size: 1rem;
}
#stockContent .hub-flow__value {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2563eb;
}
#stockContent .hub-action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 14px;
}
#stockContent .hub-action {
    border: 1px solid rgba(15, 23, 42, 0.12);
    border-radius: 18px;
    padding: 14px 16px;
    background: #0f172a;
    color: #e2e8f0;
    font-weight: 600;
    letter-spacing: 0.01em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
}
#stockContent .hub-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 28px rgba(15, 23, 42, 0.28);
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    border-color: transparent;
}
#stockContent .hub-activity-feed {
    display: flex;
    flex-direction: column;
    gap: 14px;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 4px;
}
#stockContent .hub-activity-item {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    padding: 16px 18px;
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.16);
    background: #f8fafc;
}
#stockContent .hub-activity-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
}
#stockContent .hub-activity-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
#stockContent .hub-activity-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #0f172a;
}
#stockContent .hub-activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 0.82rem;
    color: #64748b;
}
#stockContent .hub-activity-empty {
    text-align: center;
    padding: 32px 16px;
    border-radius: 16px;
    background: rgba(148, 163, 184, 0.12);
    color: #475569;
    font-weight: 600;
}
#stockContent .hub-card {
    background: #0f172a;
    border-radius: 24px;
    border: 1px solid rgba(37, 99, 235, 0.18);
    padding: 22px 24px;
    color: #e2e8f0;
    box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.12);
}
#stockContent .hub-card--surface {
    background: #ffffff;
    color: #0f172a;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 26px 44px rgba(15, 23, 42, 0.1);
}
#stockContent .hub-card__title {
    margin: 0;
    font-size: 1.2rem;
}
#stockContent .hub-card__meta {
    margin: 6px 0 0;
    color: rgba(226, 232, 240, 0.75);
    font-size: 0.92rem;
}
#stockContent .hub-card--surface .hub-card__meta {
    color: #64748b;
}
#stockContent input, #stockContent select, #stockContent textarea {
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: #f8fafc;
    padding: 10px 14px;
    color: #0f172a;
    font-family: inherit;
    font-size: 0.95rem;
    transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
}
#stockContent input:focus, #stockContent select:focus, #stockContent textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    background: #ffffff;
}
#stockContent table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 18px;
    overflow: hidden;
}
#stockContent table thead tr {
    background: #0f172a;
    color: #e2e8f0;
}
#stockContent table th, #stockContent table td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.18);
    text-align: left;
    font-size: 0.95rem;
}
#stockContent table tbody tr:nth-child(even) {
    background: rgba(148, 163, 184, 0.08);
}
#stockContent .hub-table-wrapper {
    overflow-x: auto;
    border-radius: 18px;
    border: 1px solid rgba(15, 23, 42, 0.08);
}
#stockContent .hub-split {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 18px;
}
#stockContent .hub-highlight {
    border-radius: 20px;
    padding: 18px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.2));
    border: 1px solid rgba(16, 185, 129, 0.35);
    color: #0f172a;
}
#stockContent .hub-highlight--info {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.2));
    border-color: rgba(59, 130, 246, 0.35);
}
#stockContent .hub-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 18px;
}
#stockContent .hub-summary-card {
    background: #ffffff;
    border-radius: 20px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    padding: 20px;
    box-shadow: 0 22px 40px rgba(15, 23, 42, 0.08);
}
#stockContent .hub-summary-card h4 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 1.05rem;
    color: #0f172a;
}
#stockContent .hub-summary-card p {
    margin: 0;
    color: #64748b;
    line-height: 1.6;
}
#stockContent .hub-card-cta {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
#stockContent .hub-card-cta .hub-btn {
    justify-content: center;
}
#stockContent .hub-stack {
    display: flex;
    flex-direction: column;
    gap: 24px;
}
#stockContent .hub-divider {
    height: 1px;
    background: rgba(148, 163, 184, 0.22);
    margin: 12px 0;
}
#stockContent .hub-tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
#stockContent .hub-tag {
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.08);
    font-size: 0.85rem;
    color: #0f172a;
    font-weight: 600;
}
#stockContent .hub-table-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}
#stockContent .hub-scroll {
    max-height: 420px;
    overflow-y: auto;
    padding-right: 4px;
}
#stockContent .hub-scroll::-webkit-scrollbar {
    width: 8px;
}
#stockContent .hub-scroll::-webkit-scrollbar-thumb {
    background: rgba(37, 99, 235, 0.35);
    border-radius: 999px;
}
@media (max-width: 1024px) {
    #stockContent .stock-hub-hero {
        padding: 32px;
    }
    #stockContent .stock-hub-hero__profile {
        min-width: 100%;
    }
    #stockContent .hub-section {
        padding: 24px 22px;
    }
}
@media (max-width: 768px) {
    #stockContent .stock-hub-hero {
        padding: 26px;
    }
    #stockContent .stock-hub-hero__actions {
        width: 100%;
    }
    #stockContent .hub-btn {
        width: 100%;
        justify-content: center;
    }
    #stockContent .hub-section__actions {
        width: 100%;
        justify-content: flex-start;
    }
}

        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .stock-tab-content { padding: 20px; display: none; }
        .stock-tab-content.active { display: block; }
        .distributor-subtab { padding: 20px; display: none; }
        .distributor-subtab.active { display: block; }
        .order-tab-content { padding: 20px; display: none; }
        .order-tab-content.active { display: block; }
        .crm-subtab { padding: 20px; display: none; }
        .crm-subtab.active { display: block; }
        .deposit-inbox-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }
        .deposit-inbox-summary .badge {
            background: #eef2f7;
            color: #334e68;
        }
        .deposit-inbox-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        .deposit-inbox-tab {
            background: #ffffff;
            color: #334e68;
            border: 2px solid #dce3ef;
            border-radius: 10px;
            font-weight: 600;
            padding: 9px 14px;
            cursor: pointer;
            transition: all 0.18s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .deposit-inbox-tab:hover {
            border-color: #667eea;
            color: #4a5fdc;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2);
        }
        .deposit-inbox-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: #ffffff;
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.25);
        }
        .deposit-inbox-count {
            min-width: 26px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(103, 126, 234, 0.12);
            color: inherit;
        }
        .deposit-inbox-tab.active .deposit-inbox-count {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
        .deposit-inbox-pane { display: none; }
        .deposit-inbox-pane.active { display: block; }
        .deposit-pending-pill {
            display: none;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            background: #fef2f2;
            color: #c41e3a;
            border: 1px solid rgba(196, 30, 58, 0.2);
            align-items: center;
            justify-content: center;
        }
        .deposit-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border: 1px solid #e3e9f3;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 6px 18px rgba(13, 39, 80, 0.08);
        }
        .deposit-card-header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: flex-start;
        }
        .deposit-card-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .deposit-card-meta div {
            background: #f6f9ff;
            border-radius: 8px;
            padding: 10px 12px;
            color: #334e68;
            font-size: 0.92rem;
        }
        .deposit-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .deposit-card-notes {
            background: #fef8e7;
            border-left: 4px solid #f5c26b;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.92rem;
            color: #8c6224;
        }
        .deposit-empty-state {
            text-align: center;
            padding: 18px;
            color: #7f8c8d;
            border-radius: 10px;
            border: 1px dashed #d7deee;
            background: #fcfdff;
        }
        .deposit-status {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 4px 10px;
            border-radius: 999px;
        }
        .deposit-status[data-status="pending"] {
            background: #fff6db;
            color: #8a6114;
        }
        .deposit-status[data-status="processing"] {
            background: #e1f0ff;
            color: #0c4a6e;
        }
        .deposit-status[data-status="approved"] {
            background: #e3fcec;
            color: #1a7f4b;
        }
        .deposit-status[data-status="rejected"] {
            background: #ffe7e7;
            color: #c0392b;
        }
        @media (max-width: 768px) {
            .deposit-card {
                padding: 14px;
            }
            .deposit-card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .deposit-card-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .deposit-card-actions .btn,
            .deposit-inbox-tab {
                width: 100%;
                justify-content: center;
            }
        }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-card { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 520px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-card h3 { margin-bottom: 10px; }
        .modal-actions { margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; }
        .form-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #c41e3a;
        }
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #c41e3a;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .required::after { content: ' *'; color: red; font-weight: bold; }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .checkbox-item { display: flex; align-items: center; padding: 5px; }
        .checkbox-item input { margin-right: 8px; width: auto; }
        .communication-list {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            max-height: 320px;
            overflow-y: auto;
        }
        .communication-empty {
            color: #6b7280;
            text-align: center;
            padding: 20px;
            font-size: 0.95rem;
        }
        .communication-message {
            border-left: 4px solid #c41e3a;
            background: #fdf2f2;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .communication-message.outgoing {
            border-left-color: #16a34a;
            background: #ecfdf5;
        }
        .communication-meta {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .communication-body {
            font-size: 0.95rem;
            color: #1f2937;
            white-space: pre-wrap;
        }
        .communication-form {
            margin-top: 15px;
        }
        .staff-subtabs,
        .staff-comm-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .staff-subtab-btn,
        .staff-comm-filter-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: 1px solid #d1d5db;
            background: #f3f4f6;
            color: #1f2937;
            cursor: pointer;
            font-weight: 600;
        }
        .staff-subtab-btn.active,
        .staff-comm-filter-btn.active {
            background: linear-gradient(135deg, #c41e3a, #8b0000);
            color: white;
            border-color: #c41e3a;
        }
        .staff-subtab-content {
            display: none;
        }
        .staff-subtab-content.active {
            display: block;
        }
        .portal-communication-note {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #ddd;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #c41e3a;
            cursor: pointer;
        }
        .slider-value {
            display: inline-block;
            margin-left: 15px;
            font-weight: bold;
            color: #c41e3a;
            font-size: 1.2rem;
        }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .client-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .client-card.low-stock {
            border-left: 4px solid #e74c3c;
            background: #fff5f5;
        }

        .follow-up-card {
            border-left: 4px solid #ddd;
        }

        .follow-up-card.overdue {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .follow-up-card.today {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .follow-up-card.upcoming {
            border-left-color: #3498db;
            background: #f0f8ff;
        }

        .follow-up-card.future {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .follow-up-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .follow-up-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .follow-up-status.overdue {
            background: #e74c3c;
            color: white;
        }

        .follow-up-status.today {
            background: #f39c12;
            color: white;
        }

        .follow-up-status.upcoming {
            background: #3498db;
            color: white;
        }

        .follow-up-status.future {
            background: #27ae60;
            color: white;
        }

        .follow-up-details {
            margin-bottom: 15px;
        }

        .follow-up-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .follow-up-actions {
            display: flex;
            gap: 10px;
        }

        .prescription-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .selected-medicines h4 {
            color: #c41e3a;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .selected-medicines ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .selected-medicines li {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #c41e3a;
            font-weight: 500;
        }

        .notes-display {
            margin-top: 15px;
        }

        .notes-preview {
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }

        .notes-preview h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .notes-content {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: inherit;
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close { 
            float: right; 
            font-size: 28px; 
            cursor: pointer; 
        }
        .user-profile {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .reference-number {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #ffc107;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.3rem;
        }
        .signature-pad {
            border: 2px dashed #c41e3a;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            border-radius: 5px;
            cursor: pointer;
        }
        .na-option {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
            cursor: pointer;
            display: inline-block;
            font-size: 0.9rem;
        }
        .search-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-box input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .search-box input:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .portal-header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c41e3a;
        }
        .medicine-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 2px solid #ddd;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .medicine-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        .medicine-item input {
            margin-right: 8px;
            width: auto;
        }
        .prescription-form {
            background: white;
            padding: 30px;
            margin: 0 auto;
            max-width: 900px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .prescription-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #c41e3a;
            padding-bottom: 20px;
        }
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .symptoms-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .symptom-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        /* Advanced Reporting System Styles */
        .report-builder-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            height: 600px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        .report-data-sources {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            overflow-y: auto;
        }
        .data-source-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #e8f5e9;
            border: 1px solid #27ae60;
            border-radius: 5px;
            cursor: move;
            user-select: none;
        }
        .data-source-item:hover {
            background: #c8e6c9;
        }
        .report-canvas {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #c41e3a;
            overflow-y: auto;
            min-height: 100%;
        }
        .report-field {
            padding: 10px;
            margin: 10px 0;
            background: #f0f8ff;
            border: 1px solid #3498db;
            border-radius: 5px;
            cursor: move;
            position: relative;
        }
        .report-field.dragging {
            opacity: 0.5;
        }
        .report-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .report-field-actions {
            display: flex;
            gap: 5px;
        }
        .field-config-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .report-properties {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            overflow-y: auto;
        }
        .conditional-format-rule {
            padding: 10px;
            margin: 10px 0;
            background: #fff3cd;
            border: 1px solid #f39c12;
            border-radius: 5px;
        }
        .calculated-field-formula {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .report-template-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .report-template-card:hover {
            border-color: #c41e3a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .scheduled-report-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        .scheduled-report-item.active {
            border-left-color: #27ae60;
        }
        .scheduled-report-item.paused {
            border-left-color: #e74c3c;
        }
        .drop-zone {
            min-height: 100px;
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            border: 2px dashed #bbb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .drop-zone.drag-over {
            background: #e8f5e9;
            border-color: #27ae60;
        }
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            
            body { 
                background: white; 
                padding: 0; 
                font-size: 10px;
                line-height: 1.3;
                font-family: Arial, sans-serif;
                max-width: 21cm;
                margin: 0 auto;
            }
            
            /* Hide unnecessary elements */
            .tabs, .btn, .modal, .logo, .search-box, .portal-header, .action-buttons { 
                display: none !important; 
            }
            
            /* Client registration form specific styles */
            #client {
                display: block !important;
            }
            
            .form-section {
                margin-bottom: 15px;
                page-break-inside: avoid;
                padding: 10px; 
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 2px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .form-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 9px;
                font-weight: bold;
                display: block;
                margin-bottom: 3px; 
            }
            
            .form-group input, .form-group select, .form-group textarea {
                width: 100%;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 3px;
                font-size: 9px;
            }
            
            .signature-pad {
                border: 2px solid #c41e3a;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                border-radius: 5px;
                min-height: 60px;
                font-size: 10px;
            }
            
            .reference-number {
                font-size: 14px;
                font-weight: bold;
                color: #c41e3a;
                text-align: center;
                margin-bottom: 20px;
                padding: 10px;
                background: #e8f5e9;
                border: 2px solid #c41e3a;
                border-radius: 5px;
            }
            
            /* Prescription form specific print styles */
            .prescription-form {
                max-width: none !important;
                padding: 15px !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .prescription-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #c41e3a;
                page-break-after: avoid;
            }
            
            .prescription-header h2 {
                font-size: 20px;
                margin-bottom: 8px;
                color: #c41e3a;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            .prescription-header h3 {
                font-size: 16px;
                margin: 8px 0;
                color: #333;
                font-weight: bold;
            }
            
            .prescription-header p {
                font-size: 12px;
                margin: 4px 0;
                color: #666;
            }
            
            .patient-info {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                background: #f8f9fa;
                padding: 12px;
                border-radius: 5px;
                margin-bottom: 15px;
                font-size: 10px;
                page-break-inside: avoid;
            }
            
            .patient-info div {
                margin-bottom: 3px;
            }
            
            .form-section { 
                margin-bottom: 12px;
                page-break-inside: avoid;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 1px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .symptoms-display {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-top: 5px;
            }
            
            .symptom-tag {
                background: #e3f2fd;
                color: #1976d2;
                padding: 3px 8px;
                border-radius: 10px;
                font-size: 9px;
                font-weight: 500;
            }
            
            .medicine-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 3px;
                max-height: none;
                padding: 8px;
                border: 1px solid #ddd;
                background: #f9f9f9;
                border-radius: 3px;
                font-size: 8px;
                page-break-inside: avoid;
            }
            
            .medicine-item {
                padding: 2px;
                background: white;
                border-radius: 2px;
                border: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                min-height: 20px;
            }
            
            .medicine-item input {
                margin-right: 3px;
                width: auto;
                transform: scale(0.8);
            }
            
            .medicine-item label {
                font-size: 8px;
                margin: 0;
                line-height: 1.2;
            }

            .prescription-display {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                margin-top: 15px !important;
                page-break-inside: avoid;
            }

            .selected-medicines h4 {
                font-size: 12px !important;
                color: #c41e3a !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .selected-medicines ul {
                list-style: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .selected-medicines li {
                padding: 4px 8px !important;
                margin: 3px 0 !important;
                background: white !important;
                border-left: 3px solid #c41e3a !important;
                font-size: 9px !important;
                font-weight: 500 !important;
            }

            .notes-display {
                margin-top: 10px !important;
            }

            .notes-preview {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }

            .notes-preview h4 {
                font-size: 12px !important;
                color: #1976d2 !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .notes-content {
                background: white !important;
                padding: 8px !important;
                border: 1px solid #ddd !important;
                font-size: 10px !important;
                white-space: pre-wrap !important;
            }
            
            textarea {
                width: 100%;
                min-height: 60px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 3px;
                font-size: 10px;
                resize: none;
            }
            
            /* Consultant signature and follow-up section */
            .consultant-footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 3px solid #c41e3a;
                page-break-inside: avoid;
            }
            
            .consultant-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 20px;
            }
            
            .signature-section {
                text-align: center;
            }
            
            .signature-line {
                border-bottom: 2px solid #333;
                width: 250px;
                margin: 25px auto 8px;
                height: 40px;
            }
            
            .follow-up-section {
                text-align: center;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                border: 2px solid #c41e3a;
            }
            
            .follow-up-section h4 {
                font-size: 14px;
                margin-bottom: 10px;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .follow-up-date {
                border: 2px solid #c41e3a;
                padding: 8px;
                width: 180px;
                margin: 15px auto;
                text-align: center;
                font-weight: bold;
                font-size: 12px;
                background: white;
            }
            
            .contact-info {
                font-size: 10px;
                color: #666;
                margin-top: 15px;
            }
            
            /* General container adjustments */
            .container { 
                box-shadow: none; 
                border-radius: 0;
                margin: 0;
                max-width: none;
            }
            
            .modal-content {
                position: static !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            
            .modal {
                position: static !important;
                display: block !important;
                background: white !important;
            }
            
            @page { 
                size: A4; 
                margin: 15mm;
            }
        }

        /* Real-time notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Real-time status indicator */
        .realtime-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .realtime-status.offline {
            background: #e74c3c;
        }

        .realtime-status.syncing {
            background: #f39c12;
        }

        /* Appointment Calendar Styles */
        .fc {
            font-family: Arial, sans-serif;
        }
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .fc-daygrid-event {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .appointment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            overflow-y: auto;
        }
        .appointment-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .time-slot {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .time-slot:hover {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .time-slot.selected {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }
        .time-slot.unavailable {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }
        #preferredCalendarWrapper {
            background: #ffffff;
            border: 2px solid #c41e3a;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #preferredCalendarWrapper .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        #preferredCalendarWrapper .calendar-header h4 {
            margin: 0;
            color: #c41e3a;
        }
        .preferred-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 6px;
        }
        .preferred-calendar-grid .weekday {
            text-align: center;
            font-weight: 600;
            color: #1f2937;
            padding: 6px 0;
        }
        .preferred-calendar-day {
            border: none;
            background: #f8f9fa;
            color: #1f2937;
            padding: 10px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .preferred-calendar-day:hover:not(:disabled) {
            background: #c41e3a;
            color: #ffffff;
        }
        .preferred-calendar-day.selected {
            background: #1f2937;
            color: #ffffff;
        }
        .preferred-calendar-day:disabled {
            background: #f0f0f0;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .preferred-calendar-day.today {
            border: 2px solid #1f2937;
        }
        .preferred-calendar-day.placeholder {
            visibility: hidden;
        }
        .resource-selector {
            margin: 15px 0;
        }
        .resource-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .resource-card:hover {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .resource-card.selected {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .recurring-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .client-booking-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .appointment-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #c41e3a;
        }
        .analytics-card h4 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .analytics-card .value {
            color: #c41e3a;
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
    <script>
        // Debounce utility for search/filter inputs
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Export a section to PDF via print
        function exportSectionToPDF(sectionId) {
            try {
                const section = document.getElementById(sectionId);
                if (!section) return alert('Section not found');
                const win = window.open('', '_blank', 'width=1024,height=768');
                if (!win) return alert('Popup blocked. Allow popups to export.');
                const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
                    .map(el => el.outerHTML).join('\n');
                win.document.write(`<!DOCTYPE html><html><head><title>Export</title>${styles}</head><body>`);
                win.document.write(section.outerHTML);
                win.document.write('</body></html>');
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 250);
            } catch (e) {
                console.error('Export error', e);
                alert('Failed to export.');
            }
        }

        // Global alerts: updates banner using available data
        function updateGlobalAlerts(opts = {}) {
            const container = document.getElementById('globalAlerts');
            if (!container) return;
            const alerts = [];
            // Pending approvals from GM
            const pendingCount = (opts.pendingApprovalsCount != null) ? opts.pendingApprovalsCount : (window.gmPendingApprovalsCount || 0);
            if (pendingCount > 0) alerts.push(`<div class="alert"><strong>Pending Approvals:</strong> ${pendingCount} item(s) awaiting GM action.</div>`);
            // Pending orders (if computed elsewhere)
            const pendingOrders = window.pendingOrdersCount || 0;
            if (pendingOrders > 0) alerts.push(`<div class="alert"><strong>Pending Orders:</strong> ${pendingOrders} order(s) require attention.</div>`);
            // Data errors
            if (window.lastDataError) alerts.push(`<div class="alert"><strong>Data Error:</strong> ${window.lastDataError}</div>`);
            container.innerHTML = alerts.join('');
            container.style.display = alerts.length ? 'block' : 'none';
        }
        window.updateGlobalAlerts = updateGlobalAlerts;

        // Lightweight role-based access control
        const ROLE_TABS = {
            gm: ['gm','director','admin'],
            director: ['director','admin'],
            finance: ['finance','director','admin'],
            'hr-portal': ['hr_manager','hr_admin','admin'],
            stock: ['stock_manager','director','admin']
        };

        function setCurrentUserRole(role){ try{ localStorage.setItem('currentUserRole', role); applyRoleGuards(); }catch(_){} }
        function getCurrentUserRole(){ try{ return localStorage.getItem('currentUserRole') || 'guest'; }catch(_){ return 'guest'; } }
        function applyRoleGuards(){
            const tabButtons = document.querySelectorAll('.tabs .tab-button');
            tabButtons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                const match = onclick.match(/openTab\('([^']+)'/);
                const tabId = match ? match[1] : null;
                if (tabId && Array.isArray(ROLE_TABS[tabId])) {
                    btn.dataset.allowedRoles = ROLE_TABS[tabId].join(',');
                }
                btn.style.display = '';
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            applyRoleGuards();
            checkExistingSession(); // Check if user is already logged in
        });
        
        // Role to Portal Access Mapping
        const ROLE_PORTAL_ACCESS = {
            'admin': ['admin', 'client', 'frontdesk', 'consultant', 'dispenser', 'hr-portal', 'finance', 'gm', 'director', 'mis', 'stock'],
            'consultant': ['consultant', 'frontdesk', 'client'],
            'sales_staff': ['consultant', 'frontdesk', 'client'],
            'dispenser': ['dispenser', 'frontdesk', 'client'],
            'branch_manager': ['dispenser', 'mis', 'frontdesk', 'client'],
            'finance': ['finance', 'client'],
            'hr_manager': ['hr-portal', 'client'],
            'hr_admin': ['hr-portal', 'client'],
            'gm': ['gm', 'director', 'client'],
            'director': ['director', 'gm', 'client'],
            'mis': ['mis', 'client'],
            'stock': ['stock', 'client'],
            'guest': ['client'] // Guest can only access shop
        };
        
        function extractArray(data, fallback = []) {
            if (Array.isArray(data)) return data;
            if (data && Array.isArray(data.data)) return data.data;
            if (data && Array.isArray(data.items)) return data.items;
            if (data && Array.isArray(data.results)) return data.results;
            return Array.isArray(fallback) ? fallback : [];
        }
        
        async function checkExistingSession() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const user = data?.user;
                    const role = (user?.role || '').toLowerCase();
                    if (user && role && role !== 'guest') {
                        setAuthenticatedUser(user);
                        hideLandingPage();
                        showAuthorizedPortals(role);
                        updateNavigationForUser(user, role);
                        setTimeout(() => {
                            if (typeof loadShopProducts === 'function' && ROLE_PORTAL_ACCESS[role]?.includes('client')) {
                                loadShopProducts();
                            }
                        }, 500);
                        return;
                    }
                }
            } catch (error) {
                console.warn('Session lookup error:', error);
            }

            const savedUser = localStorage.getItem('currentUser');
            const savedRole = localStorage.getItem('currentUserRole');
            if (savedUser && savedRole) {
                try {
                    const user = JSON.parse(savedUser);
                    const role = savedRole.toLowerCase();
                    if (role !== 'guest') {
                        setAuthenticatedUser(user);
                        hideLandingPage();
                        showAuthorizedPortals(role);
                        updateNavigationForUser(user, role);
                        setTimeout(() => {
                            if (typeof loadShopProducts === 'function' && ROLE_PORTAL_ACCESS[role]?.includes('client')) {
                                loadShopProducts();
                            }
                        }, 500);
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing saved session:', e);
                }
            }

            showLandingPage();
            showLandingTab('shop');
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 500);
        }
        
        function updateNavigationForUser(user, role) {
            const navLoginSection = document.getElementById('navLoginSection');
            const navUserSection = document.getElementById('navUserSection');
            const navUserDisplay = document.getElementById('navUserDisplay');
            
            if (navLoginSection) navLoginSection.style.display = 'none';
            if (navUserSection) navUserSection.style.display = 'flex';
            if (navUserDisplay && user) {
                navUserDisplay.textContent = `${user.fullName || user.username} (${role})`;
            }
        }
        
        // Landing Page Tab Functions
        function showLandingTab(tabName) {
            const shopTab = document.getElementById('landingTabShop');
            const checkupTab = document.getElementById('landingTabCheckup');
            const shopContent = document.getElementById('landingTabShopContent');
            const checkupContent = document.getElementById('landingTabCheckupContent');
            
            if (tabName === 'shop') {
                if (shopTab) {
                    shopTab.style.background = '#c41e3a';
                    shopTab.style.color = 'white';
                }
                if (checkupTab) {
                    checkupTab.style.background = '#f0f0f0';
                    checkupTab.style.color = '#666';
                }
                if (shopContent) shopContent.style.display = 'block';
                if (checkupContent) checkupContent.style.display = 'none';
            } else if (tabName === 'checkup') {
                if (shopTab) {
                    shopTab.style.background = '#f0f0f0';
                    shopTab.style.color = '#666';
                }
                if (checkupTab) {
                    checkupTab.style.background = '#c41e3a';
                    checkupTab.style.color = 'white';
                }
                if (shopContent) shopContent.style.display = 'none';
                if (checkupContent) {
                    checkupContent.style.display = 'block';
                    // Populate branch select when checkup tab is shown
                    populateLandingBranchSelect();
                }
            }
        }
        
        function populateLandingBranchSelect() {
            const branchSelect = document.getElementById('landingCheckupBranchSelect');
            const bindSelectHandler = (select) => {
                if (!select) return;
                select.onchange = function(e) {
                    const value = e.target.value || '';
                    if (value) {
                        currentBranch = value;
                    }
                    const checkSelect = document.getElementById('checkupBranchSelect');
                    if (checkSelect && checkSelect.value !== value) {
                        checkSelect.value = value;
                    }
                    const preferredSelect = document.getElementById('preferredBranchSelect');
                    if (preferredSelect && preferredSelect.value !== value) {
                        preferredSelect.value = value;
                    }
                };
            };
            if (branchSelect && branches && branches.length > 0) {
                branchSelect.innerHTML = '<option value="">Select Branch</option>';
                branchList.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name || branch.id;
                    branchSelect.appendChild(option);
                });
                if (currentBranch && !branchSelect.value) {
                    branchSelect.value = currentBranch;
                }
                bindSelectHandler(branchSelect);
            } else if (branchSelect) {
                // Load branches if not already loaded
                loadData().then(() => {
                    if (branches && branches.length > 0) {
                        branchSelect.innerHTML = '<option value="">Select Branch</option>';
                        branchList.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.id || branch.name;
                            option.textContent = branch.name || branch.id;
                            branchSelect.appendChild(option);
                        });
                        if (currentBranch && !branchSelect.value) {
                            branchSelect.value = currentBranch;
                        }
                        bindSelectHandler(branchSelect);
                    }
                });
            }
        }
        
        // Navigation functions
        function showGuestPortal() {
            showLandingPage();
            // Show shop tab by default
            showLandingTab('shop');
            // Scroll to shop section
            const shopSection = document.getElementById('landingShopProductsGrid');
            if (shopSection) {
                shopSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function showAboutUs() {
            // TODO: Implement About Us section
            alert('About Us section coming soon!');
        }
        
        function showMedia() {
            showLandingPage();
            showLandingTab('shop');
            setTimeout(() => {
                if (typeof loadMediaPreviewWidget === 'function') {
                    loadMediaPreviewWidget().catch(() => {});
                }
                if (typeof openMediaOverlay === 'function') {
                    openMediaOverlay();
                } else {
                    const widget = document.getElementById('mediaPreviewWidget');
                    if (widget) {
                        widget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }, 150);
        }
        
        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const container = document.querySelector('.container');
            const portalTabs = document.getElementById('portalTabs');
            
            if (landingPage) landingPage.style.display = 'block';
            if (container) container.style.display = 'none';
            if (portalTabs) portalTabs.style.display = 'none';
            
            // Load shop products on landing page
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 100);
        }
        
        function hideLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const container = document.querySelector('.container');
            
            if (landingPage) landingPage.style.display = 'none';
            if (container) container.style.display = 'block';
            if (clientRegModalLandingActive) {
                const modal = document.getElementById('clientRegModal');
                if (modal) {
                    restoreClientRegModal(modal);
                }
            }
        }
        
        // Legacy function names for compatibility
        function showWelcomeOverlay() {
            showLandingPage();
        }
        
        function hideWelcomeOverlay() {
            hideLandingPage();
        }
        
        function hideAllPortalTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.display = 'none';
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
        }
        
        function showAuthorizedPortals(role) {
            const authorizedPortals = ROLE_PORTAL_ACCESS[role] || ['client'];
            
            // Show portal tabs container
            const portalTabs = document.getElementById('portalTabs');
            if (portalTabs) portalTabs.style.display = 'flex';
            
            // Show authorized portal tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                const portalId = btn.getAttribute('onclick');
                if (portalId) {
                    const portalName = portalId.match(/openTab\('([^']+)'/);
                    if (portalName && authorizedPortals.includes(portalName[1])) {
                        btn.style.display = 'inline-block';
                    } else if (btn.textContent !== 'Logout') {
                        btn.style.display = 'none';
                    }
                }
            });
            
            // Update user display
            const userDisplay = document.getElementById('currentUserDisplay');
            if (userDisplay && currentUser) {
                userDisplay.textContent = `${currentUser.fullName || currentUser.username} (${role})`;
            }
            
            // Show first authorized portal by default, preferring role-specific portals over client
            const defaultPortal =
                authorizedPortals.find(portal => portal !== 'client') ||
                authorizedPortals[0] ||
                'client';
            openTab(defaultPortal, null);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                window.currentUser = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserRole');
                hideAllPortalTabs();
                const portalTabs = document.getElementById('portalTabs');
                if (portalTabs) portalTabs.style.display = 'none';
                
                // Reset navigation
                const navLoginSection = document.getElementById('navLoginSection');
                const navUserSection = document.getElementById('navUserSection');
                if (navLoginSection) navLoginSection.style.display = 'block';
                if (navUserSection) navUserSection.style.display = 'none';
                
                // Show landing page
                showLandingPage();
                
                // Clear any portal-specific auth states
                document.querySelectorAll('[id$="Auth"]').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('[id$="Content"]').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }
        
        function continueAsGuest() {
            // Guest access - show landing page with shop (already visible)
            setCurrentUserRole('guest');
            currentUser = { role: 'guest', username: 'guest', fullName: 'Guest User' };
            window.currentUser = currentUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('currentUserRole', 'guest');
            // Landing page is already visible, show shop tab and ensure products are loaded
            showLandingPage();
            showLandingTab('shop');
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 100);
        }
        
        function showStaffLogin() {
            const modal = document.getElementById('staffLoginModal');
            if (modal) {
                modal.style.display = 'flex';
            // Focus on username field
            setTimeout(() => {
                const usernameField = document.getElementById('unifiedUsername');
                if (usernameField) usernameField.focus();
            }, 100);
            }
        }
        
        function hideStaffLogin() {
            hideStaffLoginModal();
        }
        
        function hideStaffLoginModal() {
            const modal = document.getElementById('staffLoginModal');
            if (modal) modal.style.display = 'none';
            // Clear fields
            const usernameField = document.getElementById('unifiedUsername');
            const passwordField = document.getElementById('unifiedPassword');
            if (usernameField) usernameField.value = '';
            if (passwordField) passwordField.value = '';
        }
        
        // Allow Enter key to submit login
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('unifiedPassword');
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        unifiedStaffLogin();
                    }
                });
            }
        });
        
        async function unifiedStaffLogin() {
            const username = document.getElementById('unifiedUsername').value.trim();
            const password = document.getElementById('unifiedPassword').value;
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }
            
            // Load users from multiple sources to ensure we have all registered users
            await loadData();
            
            // Ensure users array is populated - try multiple fallbacks
            if (!users || users.length === 0) {
                try {
                    users = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    if (users.length === 0) {
                        users = JSON.parse(DEFAULT_USERS_JSON);
                    }
                } catch (e) {
                    console.error('Error loading users:', e);
                    users = JSON.parse(DEFAULT_USERS_JSON);
                }
            }
            
            // Find user by username and password (case-sensitive for username, case-sensitive for password)
            const user = users.find(u => {
                const usernameMatch = u.username && u.username.trim().toLowerCase() === username.toLowerCase();
                const passwordMatch = u.password === password; // Exact password match
                return usernameMatch && passwordMatch;
            });
            
            if (!user) {
                // Provide helpful error message
                const userExists = users.find(u => u.username && u.username.trim().toLowerCase() === username.toLowerCase());
                if (userExists) {
                    alert('Invalid password. Please check your password and try again.');
                } else {
                    alert('Invalid username or password. Please check your credentials and try again.');
                }
                return;
            }
            
            // Check if user is a distributor
            if (user.role === 'distributor' || username.toLowerCase().includes('distributor')) {
                alert('Distributors should use the Distributor Portal link');
                window.open('distributor-portal.html', '_blank');
                return;
            }
            
            // Login successful
            currentUser = user;
            window.currentUser = user;
            const role = user.role.toLowerCase();
            setCurrentUserRole(role);
            
            // Save session
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('currentUserRole', role);
            
            // For admin role, ensure full access to all portals
            const finalRole = role === 'admin' ? 'admin' : role;
            
            // Hide landing page and login modal, show authorized portals
            hideLandingPage();
            hideStaffLoginModal();
            updateNavigationForUser(user, finalRole);
            showAuthorizedPortals(finalRole);
            
            // Load shop products if client portal is available
            setTimeout(() => {
                if (typeof loadShopProducts === 'function' && ROLE_PORTAL_ACCESS[finalRole]?.includes('client')) {
                    loadShopProducts();
                }
            }, 500);
            
            // Show welcome message with portal count
            const portalCount = ROLE_PORTAL_ACCESS[finalRole]?.length || 0;
            const portalList = ROLE_PORTAL_ACCESS[finalRole]?.join(', ') || 'none';
            console.log(`‚úÖ Login successful: ${user.fullName || user.username} (${finalRole})`);
            console.log(`üìã Accessible portals (${portalCount}): ${portalList}`);
            
            // Show success message
            const welcomeMsg = role === 'admin' 
                ? `Welcome, ${user.fullName || user.username}!\n\nüîë Master Admin Access\nYou have full access to all ${portalCount} portals:\n${portalList}`
                : `Welcome, ${user.fullName || user.username}!\n\nYou have access to ${portalCount} portal(s):\n${portalList}`;
            
            alert(welcomeMsg);
        }

        // Action-level guards
        const ACTION_ROLES = {
            dispense: ['dispenser','pharmacist','branch','branch_manager','admin','supervisor'],
            collect_payment: ['cashier','finance','admin','supervisor'],
            reverse_payment: ['admin','supervisor','finance_manager','finance']
        };
        function getEffectiveRole(){
            try {
                if (window.currentUser && window.currentUser.role) return String(window.currentUser.role).toLowerCase();
            } catch(_){ }
            try {
                if (currentUser && currentUser.role) return String(currentUser.role).toLowerCase();
            } catch(_){ }
            try { return String(getCurrentUserRole()).toLowerCase(); } catch(_){ return 'guest'; }
        }
        function hasActionPermission(action){
            const role = getEffectiveRole();
            // Branch portal users (branch, branch_manager) have full access in their portal
            if ((role === 'branch' || role === 'branch_manager') && 
                (window.currentPortal === 'branch' || window.currentPortal === 'dispenser')) {
                return true;
            }
            const allowed = ACTION_ROLES[action] || [];
            return allowed.includes(role) || role === 'admin';
        }

        // Schedule report helpers
        function openScheduleModal(portal){
            document.getElementById('schedulePortal').value = portal;
            document.getElementById('scheduleModal').style.display = 'flex';
        }
        function closeScheduleModal(){ document.getElementById('scheduleModal').style.display = 'none'; }
        function saveReportSchedule(){
            const portal = document.getElementById('schedulePortal').value;
            const frequency = document.getElementById('scheduleFrequency').value;
            const recipients = (document.getElementById('scheduleRecipients').value||'').trim();
            const schedules = JSON.parse(localStorage.getItem('report_schedules')||'{}');
            schedules[portal] = { frequency, recipients, savedAt: new Date().toISOString() };
            localStorage.setItem('report_schedules', JSON.stringify(schedules));
            alert('Report schedule saved.');
            closeScheduleModal();
        }
        function composeReportEmail(portal){
            const recipients = (JSON.parse(localStorage.getItem('report_schedules')||'{}')[portal]?.recipients)||'';
            const subject = encodeURIComponent(`[Dynapharm] ${portal.toUpperCase()} Report`);
            const summary = gatherPortalSummary(portal);
            const body = encodeURIComponent(summary + '\n\nExport PDF from the portal if needed.');
            const href = `mailto:${encodeURIComponent(recipients)}?subject=${subject}&body=${body}`;
            window.location.href = href;
        }
        
        function openAnalyticsReportingPortal() {
            const modal = document.getElementById('analyticsReportingModal');
            if (modal) {
                modal.style.display = 'flex';
                initializeAnalyticsReporting();
                return;
            }
            
            const analyticsModal = document.createElement('div');
            analyticsModal.id = 'analyticsReportingModal';
            analyticsModal.className = 'modal';
            analyticsModal.style.display = 'flex';
            analyticsModal.innerHTML = `
                <div class="modal-content" style="max-width: 95%; max-height: 95vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #c41e3a; padding-bottom: 15px;">
                        <h2 style="color: #c41e3a; margin: 0;">üìà Analytics & Reporting Portal</h2>
                        <button onclick="closeAnalyticsReportingPortal()" style="background: #c41e3a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">‚úï Close</button>
                    </div>
                    
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchAnalyticsTab('builder')">üìä Custom Report Builder</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('sales')">üí∞ Sales Analytics</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('patients')">üë• Patient Analytics</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('products')">üì¶ Product Performance</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('branches')">üè¢ Branch Comparison</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('trends')">üìà Trend Analysis</button>
                    </div>
                    
                    <div id="analyticsBuilder" class="analytics-tab-content active">
                        <h3>üìä Custom Report Builder</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Report Name</label>
                                    <input type="text" id="reportName" placeholder="e.g., Monthly Sales Report">
                                </div>
                                <div class="form-group">
                                    <label>Date Range</label>
                                    <select id="reportDateRange">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div class="form-group" id="customDateRange" style="display: none; grid-column: span 2;">
                                    <label>Custom Date Range</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="date" id="reportDateFrom" style="flex: 1;">
                                        <input type="date" id="reportDateTo" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Select Data Fields</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <label><input type="checkbox" value="revenue" checked> Revenue</label>
                                    <label><input type="checkbox" value="transactions" checked> Transactions</label>
                                    <label><input type="checkbox" value="clients"> Clients</label>
                                    <label><input type="checkbox" value="products"> Products</label>
                                    <label><input type="checkbox" value="branches"> Branches</label>
                                    <label><input type="checkbox" value="bv"> BV Points</label>
                                    <label><input type="checkbox" value="margin"> Margin</label>
                                    <label><input type="checkbox" value="stock"> Stock Levels</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Filter by Branch</label>
                                <select id="reportBranchFilter" multiple style="min-height: 100px;">
                                    <option value="all">All Branches</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="generateCustomReport()">üìä Generate Report</button>
                                <button class="btn btn-primary" onclick="exportReportToExcel()">üì• Export to Excel</button>
                                <button class="btn btn-info" onclick="exportReportToPDF()">üìÑ Export to PDF</button>
                            </div>
                            <div id="customReportOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsSales" class="analytics-tab-content">
                        <h3>üí∞ Sales Analytics</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Time Period</label>
                                    <select id="salesPeriod" onchange="refreshSalesAnalytics()">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Branch</label>
                                    <select id="salesBranchFilter" onchange="refreshSalesAnalytics()">
                                        <option value="all">All Branches</option>
                                    </select>
                                </div>
                            </div>
                            <div id="salesAnalyticsOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsPatients" class="analytics-tab-content">
                        <h3>üë• Patient Analytics</h3>
                        <div class="form-section">
                            <div id="patientAnalyticsOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsProducts" class="analytics-tab-content">
                        <h3>üì¶ Product Performance</h3>
                        <div class="form-section">
                            <div id="productAnalyticsOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsBranches" class="analytics-tab-content">
                        <h3>üè¢ Branch Comparison</h3>
                        <div class="form-section">
                            <div id="branchComparisonOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsTrends" class="analytics-tab-content">
                        <h3>üìà Trend Analysis</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Metric</label>
                                    <select id="trendMetric">
                                        <option value="revenue">Revenue</option>
                                        <option value="transactions">Transactions</option>
                                        <option value="clients">New Clients</option>
                                        <option value="products">Product Sales</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Time Period</label>
                                    <select id="trendPeriod">
                                        <option value="7">Last 7 Days</option>
                                        <option value="30" selected>Last 30 Days</option>
                                        <option value="90">Last 90 Days</option>
                                        <option value="365">Last Year</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="refreshTrendAnalysis()">üìà Analyze Trends</button>
                            <div id="trendAnalysisOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(analyticsModal);
            initializeAnalyticsReporting();
        }
        
        function closeAnalyticsReportingPortal() {
            const modal = document.getElementById('analyticsReportingModal');
            if (modal) modal.style.display = 'none';
        }
        
        function switchAnalyticsTab(tabName) {
            document.querySelectorAll('.analytics-tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            document.querySelectorAll('#analyticsReportingModal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const tabElement = document.getElementById('analytics' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tabElement) {
                tabElement.classList.add('active');
                tabElement.style.display = 'block';
            }
            
            event.target.classList.add('active');
            
            if (tabName === 'sales') refreshSalesAnalytics();
            else if (tabName === 'patients') refreshPatientAnalytics();
            else if (tabName === 'products') refreshProductAnalytics();
            else if (tabName === 'branches') refreshBranchComparison();
            else if (tabName === 'trends') refreshTrendAnalysis();
        }
        
        function initializeAnalyticsReporting() {
            const dateRange = document.getElementById('reportDateRange');
            if (dateRange) {
                dateRange.addEventListener('change', function() {
                    document.getElementById('customDateRange').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
            }
            
            populateBranchFilters();
            refreshSalesAnalytics();
        }
        
        function populateBranchFilters() {
            const branchList = getCachedBranches();
            const selects = ['reportBranchFilter', 'salesBranchFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="all">All Branches</option>';
                branchList.forEach(branch => {
                    if (!branch) return;
                    const option = document.createElement('option');
                    const value = branch.id || branch.branchId || branch.code || branch.name;
                    option.value = value || '';
                    option.textContent = branch.name || branch.branchName || branch.displayName || branch.code || value || 'Unnamed Branch';
                    select.appendChild(option);
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
        }
        
        function generateCustomReport() {
            const reportName = document.getElementById('reportName')?.value || 'Custom Report';
            const dateRange = document.getElementById('reportDateRange')?.value || 'month';
            const output = document.getElementById('customReportOutput');
            if (!output) return;
            
            output.innerHTML = '<p>Generating report...</p>';
            setTimeout(() => {
                output.innerHTML = `<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4>${reportName}</h4>
                    <p>Report generated successfully. Use Export buttons to download.</p>
                </div>`;
            }, 500);
        }
        
        function refreshSalesAnalytics() {
            const output = document.getElementById('salesAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<p>Loading sales analytics...</p>';
            setTimeout(() => {
                output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Sales Analytics</h4><p>Sales data visualization will appear here.</p></div>';
            }, 500);
        }
        
        function refreshPatientAnalytics() {
            const output = document.getElementById('patientAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Patient Analytics</h4><p>Patient metrics and demographics will appear here.</p></div>';
        }
        
        function refreshProductAnalytics() {
            const output = document.getElementById('productAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Product Performance</h4><p>Top-selling products and performance metrics will appear here.</p></div>';
        }
        
        function refreshBranchComparison() {
            const output = document.getElementById('branchComparisonOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Branch Comparison</h4><p>Branch performance comparison will appear here.</p></div>';
        }
        
        function refreshTrendAnalysis() {
            const output = document.getElementById('trendAnalysisOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Trend Analysis</h4><p>Trend charts and analysis will appear here.</p></div>';
        }
        
        function exportReportToExcel() {
            alert('Excel export functionality will be implemented.');
        }
        
        function exportReportToPDF() {
            alert('PDF export functionality will be implemented.');
        }
        
        function gatherPortalSummary(portal){
            try{
                if (portal==='gm'){
                    const rev = document.getElementById('gmTotalRevenue')?.textContent||'';
                    const cif = document.getElementById('gmCIFDeposits')?.textContent||'';
                    const bv = document.getElementById('gmTotalBV')?.textContent||'';
                    const margin = document.getElementById('gmGrossMargin')?.textContent||'';
                    return `GM Summary\nRevenue: ${rev}\nCIF: ${cif}\nBV: ${bv}\nMargin: ${margin}`;
                }
                if (portal==='director'){
                    const rev = document.getElementById('directorRevenue')?.textContent||'';
                    const cif = document.getElementById('directorCIF')?.textContent||'';
                    const bv = document.getElementById('directorBV')?.textContent||'';
                    const margin = document.getElementById('directorMargin')?.textContent||'';
                    const rem = document.getElementById('directorRemittance')?.textContent||'';
                    return `Director Summary\nRevenue: ${rev}\nCIF: ${cif}\nBV: ${bv}\nMargin: ${margin}\nRemittance: ${rem}`;
                }
            } catch(_){}
            return 'Summary unavailable.';
        }
        async function notifyScheduledReport(portal){
            try {
                await fetch('/api/notifications.js', { method:'POST', headers:{ 'Content-Type':'application/json','x-role': getCurrentUserRole() }, body: JSON.stringify({ type:'report', title:`${portal.toUpperCase()} report sent`, message:new Date().toLocaleString() }) });
            } catch(_){}
        }
        function sendReportNow(){
            const portal = document.getElementById('schedulePortal').value;
            composeReportEmail(portal);
            notifyScheduledReport(portal);
        }
        // naive client-side scheduler (active while page is open)
        setInterval(() => {
            try{
                const schedules = JSON.parse(localStorage.getItem('report_schedules')||'{}');
                const now = new Date();
                Object.entries(schedules).forEach(([portal, cfg]) => {
                    if (!cfg || !cfg.frequency) return;
                    const lastKey = `last_sent_${portal}`;
                    const last = localStorage.getItem(lastKey);
                    const shouldSend =
                        (cfg.frequency==='daily' && (!last || now - new Date(last) > 24*3600*1000)) ||
                        (cfg.frequency==='weekly' && (!last || now - new Date(last) > 7*24*3600*1000)) ||
                        (cfg.frequency==='monthly' && (!last || now - new Date(last) > 30*24*3600*1000));
                    if (shouldSend) {
                        composeReportEmail(portal);
                        notifyScheduledReport(portal);
                        localStorage.setItem(lastKey, new Date().toISOString());
                    }
                });
            } catch(_){}
        }, 60000);
    </script>
    <script>
        // Minimal global error surface to catch early syntax/runtime issues
        window.addEventListener('error', function(e) {
            try {
                const bannerId = 'global-error-banner';
                if (!document.getElementById(bannerId)) {
                    const el = document.createElement('div');
                    el.id = bannerId;
                    el.style.cssText = 'position:fixed;z-index:99999;left:0;right:0;top:0;background:#b00020;color:#fff;padding:8px 12px;font-weight:600;';
                    el.textContent = 'A script error occurred. Check Console for details.';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 6000);
                }
            } catch(_) { /* ignore */ }
        });

        function toggleMISView(view) {
            const mainSection = document.getElementById('misMainSection');
            const staffSection = document.getElementById('misStaffSection');
            const mainBtn = document.getElementById('misMainTabBtn');
            const staffBtn = document.getElementById('misStaffTabBtn');
            if (!mainSection || !staffSection || !mainBtn || !staffBtn) return;

            if (view === 'staff') {
                mainSection.style.display = 'none';
                staffSection.style.display = 'block';
                staffBtn.classList.add('btn-primary');
                mainBtn.classList.remove('btn-primary');
                refreshStaffServices('mis');
            } else {
                mainSection.style.display = 'block';
                staffSection.style.display = 'none';
                mainBtn.classList.add('btn-primary');
                staffBtn.classList.remove('btn-primary');
            }
        }

        function toggleAdminView(view) {
            const mainSection = document.getElementById('adminMainSection');
            const staffSection = document.getElementById('adminStaffSection');
            const mainBtn = document.getElementById('adminMainTabBtn');
            const staffBtn = document.getElementById('adminStaffTabBtn');
            if (!mainSection || !staffSection || !mainBtn || !staffBtn) return;

            if (view === 'staff') {
                mainSection.style.display = 'none';
                staffSection.style.display = 'block';
                staffBtn.classList.add('btn-primary');
                mainBtn.classList.remove('btn-primary');
                refreshStaffServices('admin');
            } else {
                mainSection.style.display = 'block';
                staffSection.style.display = 'none';
                mainBtn.classList.add('btn-primary');
                staffBtn.classList.remove('btn-primary');
            }
        }

        registerStaffServicesContext('mis', {
            leaveStatusId: 'staffLeaveStatus-mis',
            cashStatusId: 'staffCashStatus-mis'
        });

        registerStaffServicesContext('admin', {
            leaveStatusId: 'staffLeaveStatus-admin',
            cashStatusId: 'staffCashStatus-admin'
        });

        registerStaffServicesContext('stock', {
            leaveStatusId: 'staffLeaveStatus-stock',
            cashStatusId: 'staffCashStatus-stock'
        });
    </script>
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" crossorigin="anonymous" onerror="console.warn('‚ö†Ô∏è xlsx library failed to load, Excel export may not work')"></script>
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Predictive analytics libs temporarily disabled due to CDN 404s (re-enable with correct URLs if needed) -->
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- JsBarcode for barcode generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <!-- Unified Login/Welcome Overlay -->
    <!-- Navigation Bar -->
    <nav id="mainNavbar" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 9999; padding: 15px 0;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='50' viewBox='0 0 200 50'%3E%3Crect width='200' height='50' rx='8' fill='%23c41e3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='16' font-weight='bold'%3EDynapharm%3C/text%3E%3C/svg%3E" alt="Dynapharm Logo" style="height: 40px; width: auto;">
            </div>
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <a href="#home" onclick="showLandingPage()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Home</a>
                <a href="#guest-portal" onclick="showGuestPortal()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Guest Portal</a>
                <a href="#about" onclick="showAboutUs()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">About Us</a>
                <a href="#media" onclick="showMedia()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Media</a>
                <span id="navLoginSection">
                    <button onclick="showStaffLogin()" class="btn" style="background: #c41e3a; color: white; padding: 10px 20px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">Login / Register</button>
                </span>
                <span id="navUserSection" style="display: none; display: flex; align-items: center; gap: 10px;">
                    <span id="navUserDisplay" style="color: #666; font-size: 0.9rem;"></span>
                    <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Logout</button>
                </span>
            </div>
        </div>
    </nav>

    <!-- Staff Login Modal -->
    <div id="staffLoginModal" class="modal-overlay" style="display: none; z-index: 10001;">
        <div class="modal-card" style="max-width: 450px;">
            <h2 style="margin-bottom: 20px; color: #c41e3a;">üëî Staff Login</h2>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="unifiedUsername" placeholder="Username" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem;">
                <input type="password" id="unifiedPassword" placeholder="Password" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="unifiedStaffLogin()" class="btn" style="background: #c41e3a; color: white; padding: 12px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Login</button>
                    <button onclick="hideStaffLoginModal()" class="btn" style="background: #f0f0f0; color: #666; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <a href="distributor-portal.html" target="_blank" style="color: #c41e3a; text-decoration: none; font-size: 0.9rem;">üìä Distributor Portal</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page (Visible to All) -->
    <div id="landingPage" style="min-height: 100vh; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
        <!-- Welcome Section -->
        <div style="background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 60px 20px; text-align: center;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1 style="font-size: 3rem; margin-bottom: 15px; color: white;">Welcome to Dynapharm Namibia</h1>
                <p style="font-size: 1.5rem; margin-bottom: 10px; opacity: 0.95;">Your Trusted Wellness Partner</p>
                <p style="font-size: 1rem; opacity: 0.9;">Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
            </div>
        </div>

        <!-- Main Content Section with Tabs -->
        <div style="max-width: 1400px; margin: 0 auto; padding: 40px 20px;">
            <div style="background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 30px;">
                <!-- Landing Page Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 3px solid #c41e3a; flex-wrap: wrap;">
                    <button id="landingTabShop" class="btn" onclick="showLandingTab('shop')" style="background: #c41e3a; color: white; padding: 12px 24px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">üõí Online Shop</button>
                    <button id="landingTabCheckup" class="btn" onclick="showLandingTab('checkup')" style="background: #f0f0f0; color: #666; padding: 12px 24px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">üè• Full Body Check Up</button>
                </div>
                
                <!-- Online Shop Tab Content -->
                <div id="landingTabShopContent" style="display: block;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px; color: #c41e3a;">üõí Online Shop</h2>
                    <p style="margin-bottom: 30px; color: #666; font-size: 1.1rem;">Browse our complete range of health and wellness products</p>
                    
                    <!-- Search Bar -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Search Products</label>
                                <input type="text" id="landingShopSearch" placeholder="Search products..." onkeyup="filterShopProducts()" style="padding: 12px; width: 100%; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>
                        <div id="landingShopCategoryFilters" class="shop-category-bar"></div>
                    </div>
                    
                    <!-- Products Grid -->
                    <div id="landingShopProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Products will be dynamically populated -->
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Loading products...</p>
                        </div>
                    </div>
                    
                    <!-- Shopping Cart -->
                    <div id="landingShopCartSection" style="display: none; margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 2px solid #c41e3a;">
                        <h3 style="color: #c41e3a; margin-bottom: 10px;">üõí Shopping Cart</h3>
                        <p id="landingShopCartCustomerType" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></p>
                        <div id="landingShopCartItems"></div>
                        <div style="text-align: right; margin-top: 20px;">
                            <p style="font-size: 1.5rem; font-weight: bold; color: #c41e3a;">Total: <span id="landingShopCartTotal">N$ 0.00</span></p>
                            <button class="btn btn-success" onclick="checkoutShopOrder()" style="margin-top: 10px; padding: 12px 30px; font-size: 1.1rem;">Proceed to Checkout</button>
                            <button class="btn" onclick="clearShopCart()" style="margin-top: 10px; margin-left: 10px;">Clear Cart</button>
                        </div>
                    </div>
                </div>
                
                <!-- Full Body Check Up Tab Content -->
                <div id="landingTabCheckupContent" style="display: none;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px; color: #c41e3a;">üè• Full Body Check Up</h2>
                    <p style="margin-bottom: 30px; color: #666; font-size: 1.1rem;">Book your comprehensive health checkup appointment with our experienced consultants</p>
                    
                    <div style="margin: 20px 0; display:flex; gap:15px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="openClientReg('appointment')" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600;">üìÖ Book Appointment</button>
                        <button class="btn" onclick="openClientReg('walkin')" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; background: #f0f0f0; color: #333;">üö∂ Walk-in</button>
                    </div>
                    
                    <div class="reference-number" id="landingClientRefNumber" style="display: none;"></div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight:700; margin-right:10px; display: block; margin-bottom: 10px;">Select Branch for Service:</label>
                        <select id="landingCheckupBranchSelect" style="padding:12px; border:2px solid #ddd; border-radius:8px; width: 100%; max-width: 400px; font-size: 1rem;">
                            <option value="">Select Branch</option>
                        </select>
                        <p style="margin-top: 10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</p>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">üìã How to Book:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #856404; line-height: 1.8;">
                            <li>Click "Book Appointment" to open the registration form</li>
                            <li>Fill in all required client information</li>
                            <li>Select your preferred branch, date, and time</li>
                            <li>Submit the form to create your appointment</li>
                            <li>You will receive a reference number for tracking</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Mobile-first responsive enhancements (safe to append) */
        :root { --gap: 10px; }
        html, body { -webkit-text-size-adjust: 100%; }
        /* Touch-friendly buttons */
        .btn { min-height: 44px; min-width: 44px; }
        /* Ensure large interactive areas */
        input, select, textarea { min-height: 44px; font-size: 16px; /* Prevents iOS zoom */ }
        /* Scroll wrappers for wide content on mobile */
        .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .shop-category-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 18px;
        }
        .shop-category-chip {
            border: 1px solid #c41e3a;
            background: white;
            color: #c41e3a;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .shop-category-chip:hover,
        .shop-category-chip.active {
            background: #c41e3a;
            color: white;
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.25);
        }
        .product-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 32px rgba(0,0,0,0.12);
        }
        .product-media {
            position: relative;
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
        }
        .product-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
            transition: transform 0.25s ease;
        }
        .product-card:hover .product-image {
            transform: scale(1.03);
        }
        .product-info {
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        .product-name {
            font-size: 1.05rem;
            font-weight: 600;
            color: #1f2933;
            flex: 1;
        }
        .product-category-pill {
            background: #eef2ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            white-space: nowrap;
            font-weight: 600;
        }
        .product-availability {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #f1f5f9;
            color: #1f2937;
        }
        .product-availability::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .availability-in_stock {
            background: #ecfdf5;
            color: #047857;
        }
        .availability-low_stock {
            background: #fff7ed;
            color: #c2410c;
        }
        .availability-out_of_stock {
            background: #fee2e2;
            color: #b91c1c;
        }
        .availability-unknown {
            background: #f3f4f6;
            color: #4b5563;
        }
        .product-expiry {
            font-size: 0.85rem;
            color: #92400e;
            background: #fff7ed;
            padding: 6px 10px;
            border-radius: 8px;
        }
        .product-price {
            font-size: 1.15rem;
            font-weight: 700;
            color: #c41e3a;
        }
        .product-ribbons {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 2;
        }
        .product-ribbon {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .product-ribbon.new { background: #2563eb; }
        .product-ribbon.trending { background: #7c3aed; }
        .product-ribbon.warning { background: #b91c1c; }
        .product-cart-button {
            width: 100%;
            margin-top: 10px;
            background: var(--brand-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        .product-cart-button:hover {
            background: #a4162d;
            transform: translateY(-1px);
        }
        .media-preview-card {
            display: flex;
            gap: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(4px);
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(255,255,255,0.25);
        }
        .media-preview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }
        .media-preview-thumb {
            width: 72px;
            height: 72px;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.4);
        }
        .media-preview-meta h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
        }
        .media-preview-meta p {
            margin: 6px 0 0 0;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
        }
        .landing-media-modal {
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .landing-media-modal .modal-content.media-gallery-content {
            max-width: 1040px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .media-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 18px;
        }
        .media-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e9f2;
            box-shadow: 0 10px 25px rgba(36,38,43,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .media-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(36,38,43,0.12);
        }
        .media-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        .media-card-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .media-card-body h4 {
            margin: 0;
            font-size: 1rem;
            color: #1f2933;
        }
        .media-card-body p {
            margin: 0;
            color: #52606d;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .media-card-footer {
            padding: 0 15px 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #64748b;
        }
        .media-card-footer button {
            background: #c41e3a;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        .media-card-footer button:hover {
            background: #9f182f;
        }
        .media-gallery-empty {
            padding: 40px;
            text-align: center;
            color: #64748b;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px dashed #cbd5e1;
            margin-top: 20px;
        }
        
        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 10px !important; }
            .container { margin: 10px auto !important; border-radius: 10px !important; }
            .logo { padding: 15px !important; }
            .logo svg { max-width: 100% !important; height: auto !important; }
            .header { padding: 16px !important; }
            .header h1 { font-size: 1.3rem !important; }
            .header p { font-size: 0.85rem !important; }
            .branch-selector { margin-top: 15px !important; padding: 12px !important; }
            .branch-selector select { width: 100% !important; max-width: 100% !important; }
            
            /* Tabs - Stack vertically or scroll horizontally */
            .tabs { 
                flex-wrap: wrap; 
                border-bottom: 2px solid #c41e3a;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
            }
            .tab-button { 
                padding: 12px 10px !important; 
                font-size: 0.85rem !important;
                white-space: nowrap;
                min-width: fit-content;
                flex: 0 0 auto;
            }
            
            /* Forms */
            .form-grid, .grid { display: grid; grid-template-columns: 1fr !important; gap: var(--gap); }
            .form-section { padding: 12px !important; margin-bottom: 15px !important; }
            .form-section h3 { font-size: 1rem !important; }
            .form-group { margin-bottom: 12px !important; }
            .checkbox-group { grid-template-columns: 1fr !important; }
            
            /* Tables */
            table { 
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
            thead { display: table-header-group; }
            tbody { display: table-row-group; }
            
            /* Modals */
            .modal-content { 
                width: 95% !important; 
                max-width: 95% !important;
                margin: 10px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            /* Cards */
            .client-card { padding: 15px !important; }
            .follow-up-card { padding: 15px !important; }
            
            /* Product grids */
            #shopProductsGrid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important; gap: 15px !important; }
            
            /* Reduce padding on content */
            .tab-content { padding: 15px !important; }
            .distributor-subtab, .stock-tab-content, .order-tab-content { padding: 15px !important; }
            
            /* Ensure no horizontal scroll on body */
            body { overflow-x: hidden; }
            
            /* Buttons stack on mobile */
            .btn { 
                width: 100%;
                margin: 5px 0 !important;
                padding: 12px !important;
                font-size: 1rem !important;
            }
            
            /* Adjust sections with flex layouts */
            [style*="display: flex"] { flex-wrap: wrap !important; }
            [style*="grid-template-columns: repeat("] { grid-template-columns: 1fr !important; }
            [style*="max-height: 500px; overflow-y: auto;"] { max-height: 60vh !important; }
            
            /* Admin Portal Specific Mobile Styles */
            #admin h2 { font-size: 1.2rem !important; margin-bottom: 15px !important; }
            #admin .form-section { padding: 12px !important; }
            #admin .form-section h3 { font-size: 1rem !important; margin-bottom: 12px !important; }
            #admin .form-section h4 { font-size: 0.9rem !important; }
            
            /* Admin Portal Buttons - Stack on mobile */
            #admin .form-section .btn,
            #admin button.btn,
            #admin .btn {
                width: 100% !important;
                margin: 5px 0 !important;
                display: block !important;
                box-sizing: border-box;
            }
            
            /* Search boxes in admin portal */
            .search-box {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            .search-box input {
                width: 100% !important;
                margin-bottom: 8px !important;
            }
            .search-box .btn {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* Admin portal input groups */
            #admin input[type="text"],
            #admin input[type="file"],
            #admin select {
                width: 100% !important;
                margin: 5px 0 !important;
                padding: 12px !important;
                font-size: 16px !important;
                min-height: 44px !important;
            }
            
            /* User list, distributor list, inventory list */
            #userList,
            #distributorList,
            #inventoryList,
            #branchList {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: 60vh !important;
            }
            #userList table,
            #distributorList table,
            #inventoryList table,
            #branchList table {
                min-width: 600px;
                width: 100%;
            }
            
            /* Product photos grid */
            #productPhotosGrid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
                gap: 12px !important;
            }
            
            /* Admin portal info boxes */
            #admin .form-section > div[style*="background"] {
                padding: 12px !important;
                margin-bottom: 12px !important;
            }
            
            /* Admin portal form grids */
            #admin .form-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            /* Branch management input + button */
            #admin #newBranchName {
                width: 100% !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important;
            }
            
            /* Admin portal status divs */
            #dataStatus,
            #distributorUploadStatus,
            #photoUploadStatus {
                padding: 10px !important;
                font-size: 0.85rem !important;
                word-wrap: break-word;
            }
            
            /* Photo preview */
            #photoPreview {
                text-align: center !important;
            }
            #photoPreview img {
                max-width: 100% !important;
                height: auto !important;
            }
            #photoPreview .preview-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
                margin-top: 10px;
            }
            
            /* Override inline flex styles in admin portal */
            #admin div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }
            #admin div[style*="justify-content: space-between"] {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            /* Distributor upload section */
            #admin #distributorFile {
                width: 100% !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important;
            }
            
            /* Admin portal inline styles override */
            #admin input[style*="margin-right"] {
                margin-right: 0 !important;
                margin-bottom: 10px !important;
            }
            
            /* Admin portal button groups */
            #admin div[style*="gap: 10px"] > .btn {
                width: 100% !important;
                margin: 5px 0 !important;
            }
            
            /* Admin portal login button */
            #adminAuth .btn {
                width: 100% !important;
                margin: 10px 0 !important;
            }
            #adminAuth p {
                font-size: 0.95rem !important;
                margin-bottom: 15px !important;
            }
            
            /* Admin portal storage info section */
            #admin div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-direction: column !important;
                gap: 10px !important;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.1rem !important; }
            .tab-button { font-size: 0.75rem !important; padding: 10px 8px !important; }
            .form-section { padding: 10px !important; }
            #shopProductsGrid { grid-template-columns: 1fr !important; }
            
            /* Admin Portal - Extra small screens */
            #admin .form-section { padding: 10px !important; }
            #admin .form-section h3 { font-size: 0.95rem !important; }
            #admin .form-section h4 { font-size: 0.85rem !important; }
            #productPhotosGrid { 
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            #userList table,
            #distributorList table,
            #inventoryList table,
            #branchList table {
                min-width: 500px;
                font-size: 0.8rem;
            }
            #admin .form-section p {
                font-size: 0.85rem !important;
            }
        }
        
        /* Landscape mobile optimization */
        @media (max-width: 896px) and (orientation: landscape) {
            .container { max-height: 100vh; overflow-y: auto; }
            .header { padding: 12px !important; }
            .tab-content { padding: 12px !important; }
        }
        
        /* Table cells wrap better on narrow screens */
        table { table-layout: auto; width: 100%; }
        td, th { word-break: break-word; padding: 8px 4px !important; font-size: 0.85rem; }
        
        /* Sticky headers fallback for Safari older versions */
        thead th { position: -webkit-sticky; position: sticky; top: 0; z-index: 1; background: white; }
        
        /* iOS iframe/page background bleed fix with viewport-fit */
        body { background-clip: padding-box; }
        
        /* Touch-friendly interactive elements */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover { opacity: 1; }
            * { -webkit-tap-highlight-color: rgba(196, 30, 58, 0.2); }
        }
    </style>
    <!-- Real-time status indicator -->
    <div id="realtimeStatus" class="realtime-status" style="display: none;">
        üîÑ Real-time sync active
    </div>

    <div class="container" style="display: none;">
        <div class="logo"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='64' viewBox='0 0 300 64'%3E%3Crect width='300' height='64' rx='10' fill='%23c41e3a'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='20'%3EDynapharm Namibia%3C/text%3E%3C/svg%3E" alt="Dynapharm Namibia" style="max-width:300px;height:auto;"></div>

        <div class="header">
            <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
            <p>Comprehensive Health Management System</p>
            <p style="font-size: 0.9rem;">Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
            
            <div class="branch-selector" style="display: none;">
                <label style="color: white; margin-right: 10px;">Select Branch (Optional):</label>
                <select id="branchSelect">
                    <option value="">-- All Branches --</option>
            </select>
            </div>
            <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                <span id="globalDistributorBadge" style="display:none; background: #ffffff; color: #c41e3a; border: 2px solid #c41e3a; padding: 6px 10px; border-radius: 6px; font-weight: 600;"></span>
                <button id="clearGlobalDistributorBtn" class="btn" style="display:none; padding: 6px 10px;" onclick="clearGlobalDistributor()">Change Distributor</button>
            </div>
        </div>
        <div id="globalAlerts" class="global-alerts"></div>

        <!-- Schedule Report Modal -->
        <div id="scheduleModal" class="modal-overlay" onclick="if(event.target.id==='scheduleModal') closeScheduleModal()">
            <div class="modal-card">
                <h3>Schedule Report</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Portal</label>
                        <input id="schedulePortal" type="text" readonly>
                    </div>
                    <div class="form-group">
                        <label>Frequency</label>
                        <select id="scheduleFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Recipients (comma-separated emails)</label>
                        <input id="scheduleRecipients" type="email" placeholder="gm@example.com, director@example.com" multiple>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="sendReportNow()">üì® Send Now</button>
                    <button class="btn btn-success" onclick="saveReportSchedule()">üíæ Save Schedule</button>
                    <button class="btn btn-danger" onclick="closeScheduleModal()">Close</button>
                </div>
            </div>
        </div>

        <div class="tabs" id="portalTabs" style="display: none;">
            <button class="tab-button active" onclick="openTab('client', event)">Distributor / Guest</button>
            <button class="tab-button" onclick="openTab('frontdesk', event)">Front Desk Portal</button>
            <button class="tab-button" onclick="openTab('consultant', event)">Consultant Portal</button>
            <button class="tab-button" onclick="openTab('dispenser', event)">Branch Portal</button>
            <button class="tab-button" onclick="openTab('hr-portal', event)">HR Portal</button>
            <button class="tab-button" onclick="openTab('finance', event)">Finance Portal</button>
            
            <button class="tab-button" onclick="openTab('gm', event)">GM Portal</button>
            <button class="tab-button" onclick="openTab('director', event)">Director Portal</button>
            <button class="tab-button" onclick="openTab('mis', event)">MIS Portal</button>
            <button class="tab-button" onclick="openTab('stock', event)">Stock Management</button>
            <button class="tab-button" onclick="openTab('admin', event)">Admin Portal</button>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                <span id="currentUserDisplay" style="color: #666; font-size: 0.9rem;"></span>
                <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <!-- Distributor Portal -->
        <div id="client" class="tab-content active">
            <!-- Distributor Portal Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-button active" onclick="showDistributorTab('shop')">üõí Shop</button>
                <button class="tab-button" onclick="showDistributorTab('checkup')">üè• Full Body Check Up</button>
                <button class="tab-button" onclick="showDistributorTab('media')">üì∞ Media & News</button>
                <button class="tab-button" onclick="showDistributorTab('testimonials')">üí¨ Testimonials</button>
                <a href="distributor-portal.html" target="_blank" class="tab-button" style="text-decoration: none; display: inline-block; background: #c41e3a; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üìä Distributor Dashboard
                </a>
            </div>
            
            <!-- Shop Tab -->
            <div id="distributor-shop-tab" class="distributor-subtab active">
                <h2>üõí Online Shop</h2>
                <p style="margin-bottom: 20px; color: #666;">Browse our complete range of health products</p>
                
                <!-- Distributor Dashboard Link -->
                <div style="background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(196, 30, 58, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="margin: 0 0 8px; font-size: 20px; color: white;">üìä Distributor Dashboard</h3>
                            <p style="margin: 0; opacity: 0.95; font-size: 14px;">View your referred clients, earnings, BVs, bonuses, and company communications</p>
                        </div>
                        <a href="distributor-portal.html" target="_blank" class="btn" style="background: white; color: #c41e3a; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; white-space: nowrap;">
                            Open Dashboard ‚Üí
                        </a>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 300px;">
                            <label>Search Products</label>
                            <input type="text" id="shopSearch" placeholder="Search products..." onkeyup="filterShopProducts()" style="padding: 10px; width: 100%;">
                        </div>
                    </div>
                    <div id="shopCategoryFilters" class="shop-category-bar"></div>
                </div>
                
                <!-- Media Preview Widget -->
                <div id="mediaPreviewWidget" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick="openMediaTab()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="margin: 0 0 10px; font-size: 22px; color: white; display: flex; align-items: center; gap: 8px;">
                                üì∫ Media Gallery
                            </h3>
                            <p style="margin: 0 0 15px; opacity: 0.95; font-size: 14px;">Watch videos and view slideshows from our latest updates</p>
                            <div id="mediaPreviewContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto;">
                                <!-- Media items will be loaded here -->
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn" style="background: white; color: #667eea; padding: 12px 24px; border-radius: 8px; font-weight: 700; white-space: nowrap; border: none; cursor: pointer;">
                                View All Media ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="shopProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    <!-- Products will be dynamically populated -->
                </div>
                
                <!-- Shopping Cart -->
                <div id="shopCartSection" style="display: none; margin-top: 30px; background: white; padding: 20px; border-radius: 8px; border: 2px solid #c41e3a;">
                    <h3 style="color: #c41e3a; margin-bottom: 5px;">üõí Shopping Cart</h3>
                    <p id="shopCartCustomerType" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></p>
                    <div id="shopCartItems"></div>
                    <div style="text-align: right; margin-top: 20px;">
                        <p style="font-size: 1.5rem; font-weight: bold; color: #c41e3a;">Total: <span id="shopCartTotal">N$ 0.00</span></p>
                        <button class="btn btn-success" onclick="checkoutShopOrder()" style="margin-top: 10px;">Proceed to Checkout</button>
                        <button class="btn" onclick="clearShopCart()">Clear Cart</button>
                    </div>
                </div>
            </div>
            
            <!-- Media & News Tab -->
            <div id="distributor-media-tab" class="distributor-subtab" style="display: none;">
                <h2>üì∞ Media & News</h2>
                <p style="margin-bottom: 20px; color: #666;">Stay updated with the latest news, health tips, and company updates from Dynapharm</p>
                
                <div id="mediaNewsContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Media items will be loaded here -->
                </div>
                
                <!-- Add News Form (Admin only) -->
                <div id="addNewsForm" style="display: none; margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3>Add News/Media</h3>
                    <form onsubmit="addNewsItem(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Title</label>
                                <input type="text" id="newsTitle" required placeholder="News title">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="newsCategory">
                                    <option value="health">Health Tips</option>
                                    <option value="product">Product News</option>
                                    <option value="company">Company Updates</option>
                                    <option value="event">Events</option>
                                    <option value="promotion">Promotions</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label class="required">Content</label>
                                <textarea id="newsContent" rows="5" required placeholder="News content..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Image URL</label>
                                <input type="url" id="newsImageUrl" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="newsDate" value="">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn btn-success">Publish News</button>
                            <button type="button" class="btn" onclick="document.getElementById('addNewsForm').style.display='none'">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="document.getElementById('addNewsForm').style.display='block'" class="btn btn-info" style="display: none;" id="showAddNewsBtn">+ Add News</button>
                </div>
            </div>
            
            <!-- Testimonials Tab -->
            <div id="distributor-testimonials-tab" class="distributor-subtab" style="display: none;">
                <h2>üí¨ Testimonials</h2>
                <p style="margin-bottom: 20px; color: #666;">Read what our customers and members say about Dynapharm products and services</p>
                
                <div id="testimonialsContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Testimonials will be loaded here -->
                </div>
                
                <!-- Add Testimonial Form -->
                <div style="margin-top: 40px; background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 30px; border-radius: 12px;">
                    <h3 style="color: white; margin-bottom: 15px;">Share Your Story</h3>
                    <p style="margin-bottom: 20px; opacity: 0.9;">Have you experienced positive results with Dynapharm products? Share your testimonial with us!</p>
                    <form onsubmit="submitTestimonial(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label style="color: white;">Your Name</label>
                                <input type="text" id="testimonialName" placeholder="Your name" style="padding: 10px; width: 100%; border-radius: 5px; border: none;">
                            </div>
                            <div class="form-group">
                                <label style="color: white;">Location</label>
                                <input type="text" id="testimonialLocation" placeholder="City, Country" style="padding: 10px; width: 100%; border-radius: 5px; border: none;">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label style="color: white;">Your Testimonial</label>
                                <textarea id="testimonialText" rows="4" required placeholder="Share your experience with Dynapharm products..." style="padding: 10px; width: 100%; border-radius: 5px; border: none; font-family: inherit;"></textarea>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn" style="background: white; color: #c41e3a; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Submit Testimonial</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Full Body Check Up Tab -->
            <div id="distributor-checkup-tab" class="distributor-subtab" style="display: none;">
                <h2>üè• Full Body Check Up</h2>
                <div style="margin: 10px 0 16px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-success" onclick="openClientReg('appointment')">üìÖ Book Appointment</button>
                    <button class="btn" onclick="openClientReg('walkin')">üö∂ Walk-in</button>
                </div>
            <div class="reference-number" id="clientRefNumber" style="display: none;"></div>
            
            <div class="form-section" style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px;">
                <label style="font-weight:700; margin-right:10px;">Select Branch for Service:</label>
                <select id="checkupBranchSelect" style="padding:10px; border:2px solid #ddd; border-radius:6px;">
                    <option value="">Select Branch</option>
                </select>
                <span style="margin-left:10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</span>
            </div>
            
            <!-- Network sync test buttons -->
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4 style="color: #c41e3a; margin-bottom: 10px;">üåê Network Synchronization Test</h4>
                <button class="btn btn-info" onclick="refreshAllData()" style="margin: 5px;">üîÑ Refresh Data</button>
                <button class="btn btn-success" onclick="testNetworkSync()" style="margin: 5px;">üåê Test Network Sync</button>
                <button class="btn btn-warning" onclick="checkConnectionStatus()" style="margin: 5px;">üì° Check Connection</button>
            </div>
            
            <div class="modal" id="clientRegModal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeModal('clientRegModal')">&times;</span>
                    <style>
                        /* Show only first two sections (Member/Referral Information and Client Information) */
                        #clientForm .form-section { display: none; }
                        #clientForm .form-section:nth-of-type(1),
                        #clientForm .form-section:nth-of-type(2) { display: block; }
                        /* Referral/Member details are controlled by membership selection logic */
                        /* When booking appointment, also show Appointment Preferences (3rd section) */
                        .mode-appointment #clientForm .form-section:nth-of-type(3) { display: block; }
                    </style>
                    <script>
                        (function(){
                            function simplifyClientForm(){
                                var form = document.getElementById('clientForm');
                                if (!form) return;
                                var sections = form.querySelectorAll('.form-section');
                                sections.forEach(function(sec, idx){
                                    if (idx > 1) {
                                        sec.querySelectorAll('[required]').forEach(function(el){ el.removeAttribute('required'); });
                                    }
                                });
                                // Keep referral/member required handling as-is (controlled by existing logic)
                            }
                            document.addEventListener('DOMContentLoaded', simplifyClientForm);
                        })();
                    </script>
            <form id="clientForm">
                <input type="hidden" name="visitType" id="visitType" value="">
                <!-- Member/Referral Information -->
                <div class="form-section">
                    <h3>Member/Referral Information</h3>
                    <p style="margin-bottom: 15px; color: #666;">Please select your membership status:</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Membership Status *</label>
                            <select name="membershipStatus" id="membershipStatusSelect" required>
                                <option value="">Select</option>
                                <option value="member">I am a registered member</option>
                                <option value="referred">I was referred by a member</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="referralDetails" style="display: none; margin-top: 15px;">
                        <h4>Referral Information</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Search for a distributor by name or NB number</p>
                    <div class="form-grid">
                        <div class="form-group" style="position: relative;">
                            <label class="required">Referral Name *</label>
                            <input type="text" name="referralName" id="clientReferralName" placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                                   onkeyup="searchDistributorsForClientReferral()" autocomplete="off" required>
                            <div id="clientReferralDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                            <small id="clientReferralStatus" style="color: #666; font-size: 0.85rem;"></small>
                        </div>
                        <div class="form-group">
                            <label class="required">Referral NB Number *</label>
                            <input type="text" name="referralNbNumber" id="clientReferralNB" placeholder="e.g., NB12345678 or NB01234567" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                            </div>
                        </div>
                    </div>
                    
                    <div id="memberDetails" style="display: none; margin-top: 15px;">
                        <h4>Member Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Member ID</label>
                                <input type="text" name="memberId" placeholder="Your member ID (if known)">
                            </div>
                            <div class="form-group">
                                <label>Member Since</label>
                                <input type="date" name="memberSince">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Information -->
                <div class="form-section">
                    <h3>Client Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" name="fullName" required autocomplete="name">
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Date</label>
                            <input type="date" name="date" id="currentDate" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Gender</label>
                            <select name="gender" required>
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Date of Birth</label>
                            <input type="date" name="dob" required onchange="calculateAge()">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" name="age" id="age" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Height (cm)</label>
                            <input type="number" name="height" min="0" max="300" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Weight (kg)</label>
                            <input type="number" name="weight" min="0" max="500" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" name="phone" required autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label class="required">Email Address</label>
                            <input type="email" name="email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label class="required">Occupation</label>
                            <input type="text" name="occupation" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Emergency Contact Name & Number</label>
                            <input type="text" name="emergencyContact" placeholder="Name - Phone Number" required>
                        </div>
                    </div>
                </div>

                <!-- Appointment Preferences -->
                <div class="form-section appointment-preferences">
                    <h3>Appointment Preferences</h3>
                    <p style="color: #666; margin-bottom: 12px;">Select your preferred branch, date, and time for the appointment.</p>
                    <input type="hidden" name="preferredDate" id="preferredDate">
                    <div id="preferredCalendarWrapper">
                        <div class="calendar-header">
                            <button type="button" class="btn btn-sm" id="preferredPrevMonth" style="background:#1f2937;color:#ffffff;">‚óÄ Previous</button>
                            <h4 id="preferredCalendarLabel">Month YYYY</h4>
                            <button type="button" class="btn btn-sm" id="preferredNextMonth" style="background:#1f2937;color:#ffffff;">Next ‚ñ∂</button>
                        </div>
                        <div class="preferred-calendar-grid" id="preferredCalendarGrid"></div>
                    </div>
                    <div style="margin-bottom: 15px; font-weight:600; color:#1f2937;">
                        Selected Date: <span id="preferredDateDisplay">‚Äî</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Preferred Time *</label>
                            <input type="time" name="preferredTime" id="preferredTime" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Preferred Branch *</label>
                            <select name="preferredBranch" id="preferredBranchSelect" required>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Health History -->
                <div class="form-section">
                    <h3>Health History</h3>
                    
                    <div class="form-group">
                        <label class="required">1. Primary Reason for Visit</label>
                        <textarea name="primaryReason" required placeholder="Describe your main health concern..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">2. Past Medical History</label>
                        <span class="na-option" onclick="selectNA('medicalHistory')">Select N/A if none</span>
                        <select name="medicalHistory" id="medicalHistorySelect" multiple size="8" style="width: 100%;">
                            <option value="na">N/A - No medical history</option>
                            <option value="highBloodPressure">High Blood Pressure</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="heartDisease">Heart Disease</option>
                            <option value="asthma">Asthma / Breathing Issues</option>
                            <option value="digestiveDisorders">Digestive Disorders (IBS, Crohn's, etc.)</option>
                            <option value="thyroid">Thyroid Disorders (Hyper/Hypo)</option>
                            <option value="kidneyLiver">Kidney or Liver Disease</option>
                            <option value="chronicFatigue">Chronic Fatigue / Fibromyalgia</option>
                            <option value="arthritis">Arthritis (Osteo / Rheumatoid)</option>
                            <option value="skinConditions">Skin Conditions (Eczema, Psoriasis, Acne)</option>
                            <option value="mentalHealth">Anxiety / Depression / Mental Health</option>
                            <option value="autoimmune">Autoimmune Conditions (Lupus, RA, etc.)</option>
                            <option value="cancer">Cancer (current/past)</option>
                        </select>
                        <input type="text" name="medicalHistoryOther" placeholder="Other conditions (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">3. Surgeries/Procedures</label>
                        <textarea name="surgeries" required placeholder="List any surgeries or medical procedures (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">4. Current Medications</label>
                        <textarea name="currentMedications" required placeholder="List all current medications (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">5. Supplements / Herbal Remedies</label>
                        <textarea name="supplements" required placeholder="List all supplements and herbal remedies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">6. Family Medical History</label>
                        <select name="familyHistory" id="familyHistorySelect" multiple size="7" style="width: 100%;">
                            <option value="na">N/A - No family history</option>
                            <option value="heartDisease">Heart Disease</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="stroke">Stroke</option>
                            <option value="cancer">Cancer</option>
                            <option value="mentalHealth">Mental Health Issues</option>
                        </select>
                        <input type="text" name="familyHistoryOther" placeholder="Other family history or cancer type (if applicable)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Lifestyle and Diet -->
                <div class="form-section">
                    <h3>Lifestyle and Diet</h3>
                    
                    <div class="form-group">
                        <label class="required">7. Diet & Nutrition - Do you follow a specific diet?</label>
                        <div class="radio-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="yes" id="dietYes" required onchange="toggleDietOptions()">
                                <label for="dietYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="no" id="dietNo" required onchange="toggleDietOptions()">
                                <label for="dietNo">No</label>
                            </div>
                        </div>
                        <select name="dietType" id="dietOptions" multiple size="4" style="width: 100%; display: none; margin-top: 10px;">
                            <option value="vegetarian">Vegetarian</option>
                            <option value="vegan">Vegan</option>
                            <option value="glutenFree">Gluten-free</option>
                            <option value="keto">Keto</option>
                        </select>
                        <input type="text" name="dietOther" placeholder="Other diet type..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">8. Food Intolerances/Allergies</label>
                        <textarea name="foodAllergies" required placeholder="List any food intolerances or allergies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">9. Water Intake</label>
                        <select name="waterIntake" required>
                            <option value="">Select daily water intake</option>
                            <option value="less1">Less than 1 litre/day</option>
                            <option value="1to2">1-2 litres/day</option>
                            <option value="2to3">2-3 litres/day</option>
                            <option value="more3">More than 3 litres/day</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">10. Caffeine Intake (per day)</label>
                        <div class="form-grid">
                            <div>
                                <label>Coffee (cups)</label>
                                <input type="number" name="coffeeCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Tea (cups)</label>
                                <input type="number" name="teaCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Energy drinks</label>
                                <select name="energyDrinks" required>
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">11. Smoking, Alcohol & Drugs</label>
                        <div class="form-grid">
                            <div>
                                <label>Do you smoke?</label>
                                <select name="smoking" required onchange="toggleSmokingDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="smokingPerDay" id="smokingPerDay" placeholder="How many per day?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you drink alcohol?</label>
                                <select name="alcohol" required onchange="toggleAlcoholDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="drinksPerWeek" id="drinksPerWeek" placeholder="Drinks per week?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you use recreational drugs?</label>
                                <select name="recreationalDrugs" required onchange="toggleDrugDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="text" name="drugDetails" id="drugDetails" placeholder="Specify..." style="display: none; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Activity and Sleep -->
                <div class="form-section">
                    <h3>Physical Activity and Sleep</h3>
                    
                    <div class="form-group">
                        <label class="required">12. Exercise Frequency</label>
                        <select name="exerciseFreq" required>
                            <option value="">Select frequency</option>
                            <option value="never">Never</option>
                            <option value="1-2">1-2 times per week</option>
                            <option value="3-4">3-4 times per week</option>
                            <option value="5+">5+ times per week</option>
                        </select>
                        <input type="text" name="exerciseType" placeholder="Type of exercise (e.g., walking, gym, sports)..." required style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">13. Sleep Patterns</label>
                        <div>
                            <label>Hours per night:</label>
                            <select name="sleepHours" required>
                                <option value="">Select hours</option>
                                <option value="<5">&lt;5 hours</option>
                                <option value="5-6">5-6 hours</option>
                                <option value="7-8">7-8 hours</option>
                                <option value="9+">9+ hours</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>Do you have sleep problems?</label>
                            <select name="sleepProblems" multiple size="4" style="width:100%;">
                                <option value="difficulty_falling">Difficulty falling asleep</option>
                                <option value="waking_night">Waking during the night</option>
                                <option value="waking_early">Waking too early</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Mental and Emotional Health -->
                <div class="form-section">
                    <h3>Mental and Emotional Health</h3>
                    
                    <div class="form-group">
                        <label class="required">14. Stress Level (1-10)</label>
                        <input type="range" name="stressLevel" min="1" max="10" value="5" class="slider" id="stressSlider" required>
                        <span class="slider-value" id="stressValue">5</span>
                    </div>

                    <div class="form-group">
                        <label class="required">15. Mental Health</label>
                        <select name="mentalHealthConcerns" multiple size="6" style="width:100%;">
                            <option value="none">None</option>
                            <option value="anxiety">Anxiety</option>
                            <option value="depression">Depression</option>
                            <option value="panic_attacks">Panic Attacks</option>
                            <option value="mood_swings">Mood Swings</option>
                            <option value="burnout">Burnout/Fatigue</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">16. Chronic Pain</label>
                        <select name="chronicPain" required onchange="togglePainDetails()">
                            <option value="">Select</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                        <div id="painDetails" style="display: none; margin-top: 10px;">
                            <input type="text" name="painLocation" placeholder="Location of pain...">
                            <label style="margin-top: 10px;">Pain severity (0-10)</label>
                            <input type="range" name="painSeverity" min="0" max="10" value="0" class="slider" id="painSlider">
                            <span class="slider-value" id="painValue">0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>17. Trauma/Abuse History (Optional)</label>
                        <select name="traumaHistory">
                            <option value="prefer_not">Prefer not to answer</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>

                <!-- Other Assessments -->
                <div class="form-section">
                    <h3>Other Assessments</h3>
                    
                    <div class="form-group">
                        <label>18. Women's Health (if applicable)</label>
                        <div class="form-grid">
                            <div>
                                <label>Menstrual cycle</label>
                                <select name="menstrualCycle">
                                    <option value="na">N/A</option>
                                    <option value="regular">Regular</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                            <div>
                                <label>Menopause status</label>
                                <select name="menopause">
                                    <option value="na">N/A</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="pmsSymptoms" placeholder="PMS Symptoms (if any)..." style="margin-top: 10px;">
                        <input type="text" name="pregnancyHistory" placeholder="Pregnancy history (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>19. Men's Health (if applicable)</label>
                        <select name="mensHealth" multiple size="4" style="width:100%;">
                            <option value="na">N/A</option>
                            <option value="prostate">Prostate issues</option>
                            <option value="urinary">Urinary issues</option>
                            <option value="libido">Libido/energy concerns</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">20. Digestive Health</label>
                        <div class="form-grid">
                            <div>
                                <label>Appetite</label>
                                <select name="appetite" required>
                                    <option value="">Select</option>
                                    <option value="poor">Poor</option>
                                    <option value="fair">Fair</option>
                                    <option value="good">Good</option>
                                </select>
                            </div>
                            <div>
                                <label>Bowel Movements</label>
                                <select name="bowelMovements" required>
                                    <option value="">Select</option>
                                    <option value="daily">Daily</option>
                                    <option value="constipation">Constipation</option>
                                    <option value="diarrhea">Diarrhea</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="digestiveOther" placeholder="Other digestive issues..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">21. Allergies</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="none" id="allergy0">
                                <label for="allergy0">None</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="food" id="allergy1">
                                <label for="allergy1">Food</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="seasonal" id="allergy2">
                                <label for="allergy2">Seasonal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="chemical" id="allergy3">
                                <label for="allergy3">Chemical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="environmental" id="allergy4">
                                <label for="allergy4">Environmental</label>
                            </div>
                        </div>
                        <input type="text" name="allergiesOther" placeholder="Other allergies (specify)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Consent -->
                <div class="form-section" style="background: #e8f5e9;">
                    <h3>Consent to Treatment</h3>
                    <p style="margin-bottom: 15px;">I consent to naturopathic care and understand all details are kept confidential.</p>
                    <div class="form-group">
                        <input type="checkbox" id="consentCheck" required style="width: auto; margin-right: 10px;" onchange="handleConsentChange()">
                        <label for="consentCheck" style="display: inline;">I agree to the terms of treatment and data usage</label>
                    </div>
                    <div class="form-group">
                        <label class="required">Electronic Signature</label>
                        <div class="signature-pad" id="signaturePad" onclick="signDocument()">
                            Click here to sign electronically
                        </div>
                        <input type="hidden" name="signature" id="signatureField">
                    </div>
                </div>

                <div style="text-align: center; margin: 20px;">
                    <button type="submit" class="btn btn-success">Save Client Information</button>
                    <button type="button" class="btn btn-warning" onclick="clearForm()">Clear Form</button>
                    <button type="button" class="btn" onclick="printClientForm()">Print</button>
                </div>
            </form>
                </div>
            </div>
            </div>
            
        </div>

        <!-- Front Desk Portal -->
        <div id="frontdesk" class="tab-content">
            <h2>üñ•Ô∏è Front Desk Portal - Online Order Management</h2>
            <p style="margin-bottom: 30px; color: #666;">Manage online shop orders, delivery arrangements, and order tracking in real-time</p>
            
            <!-- Order Status Tabs -->
            <div class="tabs" style="margin-bottom: 30px;">
                <button class="tab-button active" onclick="showOrderTab('pending')">üì• Pending Orders</button>
                <button class="tab-button" onclick="showOrderTab('processing')">üîÑ Processing</button>
                <button class="tab-button" onclick="showOrderTab('shipped')">üöö Shipped</button>
                <button class="tab-button" onclick="showOrderTab('delivered')">‚úÖ Delivered</button>
                <button class="tab-button" onclick="showOrderTab('all')">üìã All Orders</button>
                <button class="tab-button" onclick="showOrderTab('appointments')">üè• Appointments</button>
                <button class="tab-button" onclick="showOrderTab('clientRegistration')">üë§ Client Registration</button>
                <button class="tab-button" onclick="showOrderTab('payments')">üí≥ Payment Collection</button>
                <button class="tab-button" onclick="showOrderTab('clientLookup')">üîç Client Lookup</button>
                <button class="tab-button" onclick="showOrderTab('delivery')">üöö Delivery Scheduling</button>
                <button class="tab-button" onclick="showOrderTab('visitors')">üö™ Visitor Management</button>
                <button class="tab-button" onclick="showOrderTab('crm')">üë• CRM</button>
                <button class="tab-button" onclick="showOrderTab('notifications')">üîî Notifications</button>
                <button class="tab-button" onclick="showOrderTab('staffComm')">üí¨ Staff Communication</button>
                <button class="tab-button" onclick="showOrderTab('staffServices')">üë§ Staff</button>
            </div>
            
            <!-- Pending Orders Tab -->
            <div id="pendingOrders" class="order-tab-content active">
                <div class="form-section">
                    <h3>üì• Pending Orders Awaiting Processing</h3>
                    <div class="search-box">
                        <input type="text" id="pendingOrderSearch" placeholder="Search by customer name, order ID..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshPendingOrders()">üîÑ Refresh</button>
                    </div>
                    <div id="pendingOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Appointments Tab -->
            <div id="frontdeskAppointments" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üè• Full Body Checkup Appointments</h3>
                    <p style="margin-bottom: 15px; color: #666;">View and manage Full Body Checkup appointments with complete client forms</p>
                    <div class="search-box">
                        <select id="appointmentBranchFilter" style="padding: 10px; margin-right: 10px;" onchange="refreshFrontdeskAppointments()">
                            <option value="">All Branches</option>
                            <option>Windhoek Main</option>
                            <option>Oshakati</option>
                            <option>Walvis Bay</option>
                            <option>Swakopmund</option>
                            <option>Rundu</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshFrontdeskAppointments()">üîÑ Refresh</button>
                        <a href="/appointments-admin.html" target="_blank" class="btn btn-primary">üìã Appointments Admin</a>
                    </div>
                    <div id="frontdeskAppointmentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Full Body Check Up Tab -->
            <div id="frontdeskFullBodyCheckup" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üè• Full Body Check Up - Book Appointment</h3>
                    <p style="margin-bottom: 20px; color: #666;">Book Full Body Checkup appointments for clients. This form allows front desk staff to assist clients in booking appointments.</p>
                    
                    <div style="margin: 10px 0 16px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="openClientReg('appointment')">üìÖ Book Appointment</button>
                        <button class="btn" onclick="openClientReg('walkin')">üö∂ Walk-in</button>
                    </div>
                    
                    <div class="reference-number" id="frontdeskClientRefNumber" style="display: none;"></div>
                    
                    <div class="form-section" style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px;">
                        <label style="font-weight:700; margin-right:10px;">Select Branch for Service:</label>
                        <select id="frontdeskCheckupBranchSelect" style="padding:10px; border:2px solid #ddd; border-radius:6px;">
                            <option value="">Select Branch</option>
                        </select>
                        <span style="margin-left:10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</span>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">üìã Instructions for Front Desk Staff:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #856404;">
                            <li>Click "Book Appointment" to open the client registration form</li>
                            <li>Fill in all required client information</li>
                            <li>Select preferred branch, date, and time for the appointment</li>
                            <li>Submit the form to create the appointment</li>
                            <li>The client will receive a reference number for tracking</li>
                        </ol>
                    </div>
                    
                    <div id="frontdeskCheckupAppointmentsList" style="margin-top: 30px;">
                        <h4>Recent Appointments Booked</h4>
                        <p style="color: #666; font-size: 0.9rem;">Appointments will appear here after booking.</p>
                    </div>
                </div>
            </div>

            <!-- Client Registration Tab -->
            <div id="frontdeskClientRegistration" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üë§ Client Registration - Walk-in Registration</h3>
                    <p style="margin-bottom: 15px; color: #666;">Register new clients who visit the branch in person</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" id="fdClientName" placeholder="Full Name" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" id="fdClientPhone" placeholder="0812345678" required>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="fdClientEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="fdClientDOB">
                        </div>
                        <div class="form-group">
                            <label>ID Number</label>
                            <input type="text" id="fdClientID" placeholder="ID Number">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="fdClientAddress" rows="2" placeholder="Physical Address"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Distributor Referral (NB Number)</label>
                            <input type="text" id="fdClientReferral" placeholder="NB Number (optional)" style="text-transform: uppercase;">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="registerFrontDeskClient()">‚ûï Register Client</button>
                        <button class="btn btn-info" onclick="checkExistingClient()">üîç Check Existing</button>
                        <button class="btn" onclick="clearFrontDeskClientForm()">üîÑ Clear Form</button>
                    </div>
                    <div id="fdClientRegistrationResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Payment Collection Tab -->
            <div id="frontdeskPayments" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üí≥ Payment Collection</h3>
                    <p style="margin-bottom: 15px; color: #666;">Collect payments for orders, prescriptions, and services</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Order/Prescription ID</label>
                            <input type="text" id="fdPaymentOrderID" placeholder="Enter Order ID or Prescription ID" required>
                            <button class="btn btn-info" style="margin-top: 5px; width: 100%;" onclick="lookupOrderForPayment()">üîç Lookup Order</button>
                        </div>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="fdPaymentCustomer" placeholder="Customer Name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Amount Due</label>
                            <input type="number" id="fdPaymentAmount" placeholder="0.00" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Payment Method</label>
                            <select id="fdPaymentMethod" required>
                                <option value="">Select Payment Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="ewallet">E-Wallet</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="fdPaymentPaid" placeholder="Enter amount paid" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Reference Number</label>
                            <input type="text" id="fdPaymentReference" placeholder="Transaction/Reference Number">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="processFrontDeskPayment()">üí≥ Process Payment</button>
                        <button class="btn" onclick="clearPaymentForm()">üîÑ Clear</button>
                    </div>
                    <div id="fdPaymentResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìã Recent Payments</h3>
                    <div class="search-box">
                        <input type="text" id="fdPaymentSearch" placeholder="Search by customer name, order ID..." style="flex: 1;">
                        <button class="btn btn-info" onclick="refreshFrontDeskPayments()">üîÑ Refresh</button>
                    </div>
                    <div id="fdPaymentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Client Lookup Tab -->
            <div id="frontdeskClientLookup" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üîç Client Lookup & Information</h3>
                    <p style="margin-bottom: 15px; color: #666;">Search for client information, order history, and records</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Search By</label>
                            <select id="fdLookupType" onchange="updateLookupFields()">
                                <option value="name">Name</option>
                                <option value="phone">Phone Number</option>
                                <option value="email">Email</option>
                                <option value="id">ID Number</option>
                                <option value="order">Order ID</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Search Term</label>
                            <input type="text" id="fdLookupTerm" placeholder="Enter search term" required>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="performClientLookup()">üîç Search</button>
                        <button class="btn" onclick="clearLookupResults()">üîÑ Clear</button>
                    </div>
                    <div id="fdLookupResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Delivery Scheduling Tab -->
            <div id="frontdeskDelivery" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üöö Delivery Scheduling</h3>
                    <p style="margin-bottom: 15px; color: #666;">Schedule and manage order deliveries</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Order ID</label>
                            <input type="text" id="fdDeliveryOrderID" placeholder="Enter Order ID" required>
                            <button class="btn btn-info" style="margin-top: 5px; width: 100%;" onclick="lookupOrderForDelivery()">üîç Lookup Order</button>
                        </div>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="fdDeliveryCustomer" placeholder="Customer Name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Delivery Address</label>
                            <textarea id="fdDeliveryAddress" rows="3" placeholder="Delivery Address" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="required">Delivery Date</label>
                            <input type="date" id="fdDeliveryDate" required>
                        </div>
                        <div class="form-group">
                            <label>Delivery Time</label>
                            <input type="time" id="fdDeliveryTime">
                        </div>
                        <div class="form-group">
                            <label>Delivery Method</label>
                            <select id="fdDeliveryMethod">
                                <option value="standard">Standard Delivery</option>
                                <option value="express">Express Delivery</option>
                                <option value="pickup">Customer Pickup</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Delivery Notes</label>
                            <textarea id="fdDeliveryNotes" rows="2" placeholder="Special instructions, landmark, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Contact Phone</label>
                            <input type="tel" id="fdDeliveryPhone" placeholder="Contact number for delivery">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="scheduleDelivery()">üìÖ Schedule Delivery</button>
                        <button class="btn" onclick="clearDeliveryForm()">üîÑ Clear</button>
                    </div>
                    <div id="fdDeliveryResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìã Scheduled Deliveries</h3>
                    <div class="search-box">
                        <select id="fdDeliveryStatusFilter" style="padding: 10px; margin-right: 10px;">
                            <option value="all">All Statuses</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in_transit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn btn-info" onclick="refreshDeliveries()">üîÑ Refresh</button>
                    </div>
                    <div id="fdDeliveriesList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Visitor Management Tab -->
            <div id="frontdeskVisitors" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üö™ Visitor Management</h3>
                    <p style="margin-bottom: 15px; color: #666;">Register and track visitors to the branch</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Visitor Name</label>
                            <input type="text" id="fdVisitorName" placeholder="Full Name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="fdVisitorPhone" placeholder="0812345678">
                        </div>
                        <div class="form-group">
                            <label class="required">Purpose of Visit</label>
                            <select id="fdVisitorPurpose" required>
                                <option value="">Select Purpose</option>
                                <option value="consultation">Consultation</option>
                                <option value="product_purchase">Product Purchase</option>
                                <option value="order_collection">Order Collection</option>
                                <option value="appointment">Appointment</option>
                                <option value="inquiry">Inquiry</option>
                                <option value="meeting">Meeting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Person/Department to Visit</label>
                            <input type="text" id="fdVisitorContact" placeholder="Staff member or department name">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="fdVisitorNotes" rows="2" placeholder="Additional information"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="registerVisitor()">‚úÖ Register Visitor</button>
                        <button class="btn" onclick="clearVisitorForm()">üîÑ Clear</button>
                    </div>
                    <div id="fdVisitorResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìã Today's Visitors</h3>
                    <div class="search-box">
                        <input type="text" id="fdVisitorSearch" placeholder="Search visitors..." style="flex: 1;">
                        <button class="btn btn-info" onclick="refreshVisitors()">üîÑ Refresh</button>
                    </div>
                    <div id="fdVisitorsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Front Desk CRM Tab -->
            <div id="frontdeskCRM" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üë• CRM - Lead Management</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Lead Name</label>
                            <input type="text" id="crmLeadName" placeholder="Full Name">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="crmLeadPhone" placeholder="0812345678">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="crmLeadEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Interest</label>
                            <input type="text" id="crmLeadInterest" placeholder="Product/package of interest">
                        </div>
                        <div class="form-group">
                            <label>Next Follow-up</label>
                            <input type="date" id="crmLeadFollowUp">
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="addCRMLead()">‚ûï Add Lead</button>
                        <button class="btn btn-info" onclick="refreshCRMLeads()">üîÑ Refresh</button>
                        <button class="btn" onclick="openMISFromCRM()">üìä View in MIS</button>
                    </div>
                </div>
                <div class="form-section">
                    <h3>üìã Leads</h3>
                    <div id="crmLeadsList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>

                <!-- Advanced CRM Sub-tabs -->
                <div class="form-section">
                    <div class="tabs" style="margin-bottom: 16px;">
                        <button class="tab-button active" onclick="showFrontdeskCRMTab('comm')">üí¨ Communication</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('segments')">üìä Segmentation</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('workflows')">‚öôÔ∏è Workflows</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('loyalty')">üéÅ Loyalty</button>
                    </div>

                    <!-- Communication -->
                    <div id="fdcrm-comm" class="fdcrm-subtab" style="display:block;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Client</label>
                                <input type="text" id="fdcrmCommClient" placeholder="Name or NB (optional)">
                            </div>
                            <div class="form-group">
                                <label>Channel</label>
                                <select id="fdcrmCommChannel">
                                    <option value="call">Call</option>
                                    <option value="sms">SMS</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="email">Email</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <input type="text" id="fdcrmCommNote" placeholder="Summary...">
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmAddInteraction()">‚ûï Add Interaction</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshInteractions()">üîÑ Refresh</button>
                        </div>
                        <div id="fdcrmCommList" style="max-height: 380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Segmentation -->
                    <div id="fdcrm-segments" class="fdcrm-subtab" style="display:none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Segment Name</label>
                                <input type="text" id="fdcrmSegName" placeholder="e.g., High BV Clients">
                            </div>
                            <div class="form-group">
                                <label>Rule</label>
                                <select id="fdcrmSegRule">
                                    <option value="bv_1000">BV ‚â• 1000 (lifetime)</option>
                                    <option value="purchases_3m">‚â• 3 purchases (last 3 months)</option>
                                    <option value="no_purchase_60d">No purchase in 60 days</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmCreateSegment()">‚ûï Create Segment</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshSegments()">üîÑ Refresh</button>
                        </div>
                        <div id="fdcrmSegList" style="max-height:380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Workflows -->
                    <div id="fdcrm-workflows" class="fdcrm-subtab" style="display:none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Trigger</label>
                                <select id="fdcrmWfTrigger">
                                    <option value="lead_created">When lead is created</option>
                                    <option value="segment_join">When client joins segment</option>
                                    <option value="no_purchase_30d">No purchase in 30 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Action</label>
                                <select id="fdcrmWfAction">
                                    <option value="send_sms">Send SMS</option>
                                    <option value="send_email">Send Email</option>
                                    <option value="create_task">Create Follow-up Task</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmCreateWorkflow()">‚ûï Create Workflow</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshWorkflows()">üîÑ Refresh</button>
                        </div>
                        <div id="fdcrmWfList" style="max-height:380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Loyalty -->
                    <div id="fdcrm-loyalty" class="fdcrm-subtab" style="display:none;">
                        <div style="margin-bottom:10px;">Top clients by BV or purchases (approx.)</div>
                        <div id="fdcrmLoyaltyList" style="max-height:380px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Front Desk Notifications Tab -->
            <div id="frontdeskNotifications" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üîî Notifications</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-info" onclick="renderNotifications()">üîÑ Refresh</button>
                        <button class="btn" onclick="markAllNotificationsRead()">‚úÖ Mark All Read</button>
                        <button class="btn btn-danger" onclick="clearAllNotifications()">üóëÔ∏è Clear All</button>
                    </div>
                    <div id="notificationsList" style="max-height: 420px; overflow-y:auto;"></div>
                </div>
            </div>

            <div id="frontdeskStaffCommunication" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üí¨ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Coordinate front desk actions with branch staff and respond to their announcements.</p>
                    <div id="portalCommunicationList-frontdesk" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'frontdesk')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-frontdesk">Message</label>
                            <textarea id="portalCommunicationMessage-frontdesk" rows="4" placeholder="Share collection reminders, delivery updates or visitor notices..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('frontdesk')">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="frontdeskStaffServices" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üë§ Staff Services</h3>
                    <p style="color:#64748b; margin-bottom:18px;">Submit your own leave and cash requests directly from the front desk portal.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; border: 2px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin-bottom: 12px;">üìÖ Leave Management</h4>
                            <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Request time off and track approvals.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffLeaveRequest('frontdesk')">Request Leave</button>
                                <button class="btn btn-info" onclick="viewMyLeaveRequests('frontdesk')">My Requests</button>
                            </div>
                            <div id="staffLeaveStatus-frontdesk" style="margin-top: 15px;"></div>
                        </div>
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border: 2px solid #2196f3;">
                            <h4 style="color: #1565c0; margin-bottom: 12px;">üíµ Cash Support</h4>
                            <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request petty cash or reimbursements.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffCashRequest('frontdesk')">Request Cash</button>
                                <button class="btn btn-info" onclick="viewMyCashRequests('frontdesk')">My Requests</button>
                            </div>
                            <div id="staffCashStatus-frontdesk" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Processing Orders Tab -->
            <div id="processingOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üîÑ Orders in Process</h3>
                    <div class="search-box">
                        <input type="text" id="processingOrderSearch" placeholder="Search orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshProcessingOrders()">üîÑ Refresh</button>
                    </div>
                    <div id="processingOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Shipped Orders Tab -->
            <div id="shippedOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üöö Shipped Orders</h3>
                    <div class="search-box">
                        <input type="text" id="shippedOrderSearch" placeholder="Search shipped orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshShippedOrders()">üîÑ Refresh</button>
                    </div>
                    <div id="shippedOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Delivered Orders Tab -->
            <div id="deliveredOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>‚úÖ Delivered Orders</h3>
                    <div class="search-box">
                        <input type="text" id="deliveredOrderSearch" placeholder="Search delivered orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshDeliveredOrders()">üîÑ Refresh</button>
                    </div>
                    <div id="deliveredOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- All Orders Tab -->
            <div id="allOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üìã All Orders</h3>
                    <div class="search-box">
                        <input type="text" id="allOrderSearch" placeholder="Search all orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshAllOrders()">üîÑ Refresh</button>
                        <button class="btn btn-primary" onclick="exportOrdersReport()">üì• Export Report</button>
                    </div>
                    <div id="allOrdersList" style="margin-top: 20px;"></div>
                </div>

                <!-- Barcode System Tab -->
                <div id="barcodeTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üì∑ Barcode System</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; align-items: end;">
                            <div>
                                <label>Product</label>
                                <input type="text" id="barcodeProductName" placeholder="Enter product name...">
                            </div>
                            <div>
                                <label>SKU/Code</label>
                                <input type="text" id="barcodeSku" placeholder="e.g., PRD-0001">
                            </div>
                            <div>
                                <button class="btn btn-success" onclick="generateProductBarcode()">üè∑Ô∏è Generate Barcode</button>
                            </div>
                        </div>
                        <div id="barcodePreview" style="margin-top: 15px; display: flex; gap: 20px; align-items: center;"></div>
                    </div>

                    <div class="form-section">
                        <h3>üì• Quick Stock Update (Manual Scan)</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
                            <input type="text" id="scannedCode" placeholder="Scan or enter code...">
                            <input type="number" id="scannedQuantity" placeholder="Quantity" min="1">
                            <select id="scanAction">
                                <option value="add">Add to Stock</option>
                                <option value="remove">Remove from Stock</option>
                            </select>
                            <button class="btn btn-success" onclick="applyScannedUpdate()">‚úÖ Apply</button>
                        </div>
                        <div id="scanUpdateStatus" style="margin-top: 10px; color: #666;"></div>
                    </div>
                </div>

                <!-- Reorder Points Tab -->
                <div id="reorderTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>‚ö†Ô∏è Automated Reorder Points</h3>
                        <div class="search-box" style="margin-bottom: 12px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="displayReorderPoints()">üîÑ Refresh</button>
                            <button class="btn" onclick="exportReorderList()">üì• Export</button>
                            <button class="btn btn-primary" onclick="generatePurchaseOrders()">üßæ Generate Purchase Orders</button>
                        </div>
                        <div id="reorderList" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>
                    <div class="form-section">
                        <h3>üß™ Reorder Scenarios</h3>
                        <form onsubmit="handleReorderScenario(event)" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; background:#f8f9fa; border:1px solid #e1e5ec; padding:10px; border-radius:8px;">
                            <div>
                                <label>Name</label>
                                <input type="text" id="scenarioName" placeholder="e.g., Festive Uplift">
                            </div>
                            <div>
                                <label>Uplift %</label>
                                <input type="number" id="scenarioUplift" value="10" min="0" step="1">
                            </div>
                            <div>
                                <label>Lead Time (days)</label>
                                <input type="number" id="scenarioLeadTime" value="0" min="0">
                            </div>
                            <div>
                                <label>Service Level</label>
                                <select id="scenarioServiceLevel">
                                    <option value="0.9">90%</option>
                                    <option value="0.95" selected>95%</option>
                                    <option value="0.99">99%</option>
                                </select>
                            </div>
                            <div style="grid-column:1 / -1;">
                                <label>Notes</label>
                                <textarea id="scenarioNotes" rows="2" placeholder="Assumptions, constraints..."></textarea>
                            </div>
                            <div style="display:flex; gap:8px; align-items:end;">
                                <button class="btn btn-success" type="submit">Run Scenario</button>
                            </div>
                        </form>
                        <div id="reorderScenarioResults" style="margin-top:10px;"></div>
                    </div>
                </div>

                <!-- Batch Tracking Tab -->
                <div id="batchTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üî¢ Batch Tracking & Expiry Alerts</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <input type="text" id="batchSearch" placeholder="Search by product/batch..." onkeyup="displayBatchTracking()">
                            <select id="batchExpiryFilter" onchange="displayBatchTracking()">
                                <option value="all">All</option>
                                <option value="expiring60">Expiring ‚â§ 60 days</option>
                                <option value="expired">Expired</option>
                                <option value="recalled">Recalled</option>
                            </select>
                            <button class="btn btn-info" onclick="displayBatchTracking()">üîÑ Refresh</button>
                        </div>
                        <div id="batchTrackingList" style="max-height: 600px; overflow-y: auto; margin-top: 10px;"></div>
                    </div>
                    <div class="form-section">
                        <h3>‚Ü©Ô∏è Returns & Recalls</h3>
                        <form onsubmit="handleReturnSubmit(event)" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; background:#f8f9fa; border:1px solid #e1e5ec; padding:10px; border-radius:8px;">
                            <div>
                                <label>Type</label>
                                <select id="returnType">
                                    <option value="customer">Customer Return</option>
                                    <option value="supplier">Supplier Return</option>
                                    <option value="recall">Recall</option>
                                </select>
                            </div>
                            <div>
                                <label>Product</label>
                                <input type="text" id="returnProduct" required>
                            </div>
                            <div>
                                <label>Batch</label>
                                <input type="text" id="returnBatch">
                            </div>
                            <div>
                                <label>Quantity</label>
                                <input type="number" id="returnQuantity" min="1" required>
                            </div>
                            <div>
                                <label>Reason</label>
                                <input type="text" id="returnReason" placeholder="e.g., damage">
                            </div>
                            <div>
                                <label>Disposition</label>
                                <select id="returnDisposition">
                                    <option value="hold">Hold</option>
                                    <option value="destroy">Destroy</option>
                                    <option value="return">Return to Supplier</option>
                                </select>
                            </div>
                            <div style="grid-column:1 / -1;">
                                <label>Notes</label>
                                <textarea id="returnNotes" rows="2"></textarea>
                            </div>
                            <div style="display:flex; gap:8px; align-items:end;">
                                <button class="btn btn-success" type="submit">Save</button>
                            </div>
                        </form>
                        <div id="returnsList" style="margin-top:10px;"></div>
                    </div>
                </div>

                <!-- Stock Valuation Tab -->
                <div id="valuationTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üí∞ Stock Valuation</h3>
                        <div class="search-box" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <label>Method</label>
                            <select id="valuationMethod" onchange="displayStockValuation()">
                                <option value="fifo">FIFO</option>
                                <option value="lifo">LIFO</option>
                            </select>
                            <button class="btn btn-info" onclick="displayStockValuation()">üîÑ Refresh</button>
                            <button class="btn" onclick="exportStockValuation()">üì• Export</button>
                        </div>
                        <div id="stockValuationSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 10px;"></div>
                        <div id="stockValuationDetails" style="max-height: 600px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consultant Portal -->
        <div id="consultant" class="tab-content">
            <div id="consultantAuth">
                <div class="portal-header">
                    <h2>üë®‚Äç‚öïÔ∏è Consultant Portal</h2>
                    <p>Access client records and create medical reports</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">üîÑ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access consultant portal</p>
                    <button class="btn" onclick="showLogin('consultant')">üîê Login</button>
                </div>
            </div>
            <div id="consultantContent" style="display: none;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                    <button id="consultantMainTabBtn" class="btn btn-primary" onclick="toggleConsultantView('main')" style="min-width: 150px;">üóÇÔ∏è Portal Tools</button>
                    <button id="consultantStaffTabBtn" class="btn" onclick="toggleConsultantView('staff')" style="min-width: 150px;">üë§ Staff Services</button>
                </div>

                <div id="consultantMainSection">
                    <div class="user-profile" id="consultantProfile"></div>
                    
                    <div class="portal-header">
                    <h2>üë®‚Äç‚öïÔ∏è Consultant Portal - Client Management</h2>
                    <p>Review client information and create medical reports</p>
                </div>
                
                <div class="search-box">
                    <input type="text" id="consultantSearch" placeholder="Search client by name, phone, or reference number...">
                    <select id="consultantBranchFilter" style="padding: 10px; margin-right: 10px; border: 2px solid #ddd; border-radius: 6px;" onchange="displayClients()">
                        <option value="">All Branches</option>
                    </select>
                    <button class="btn" onclick="searchClients('consultant')">üîç Search</button>
                    <button class="btn btn-info" onclick="showAllClients('consultant')">üìã Show All Clients</button>
                    <button class="btn btn-success" onclick="refreshConsultantData()">üîÑ Refresh Data</button>
                </div>

                <div id="clientList"></div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìã My Created Reports</h3>
                    <div class="search-box">
                        <input type="text" id="reportSearch" placeholder="Search reports by client name or report ID...">
                        <button class="btn" onclick="searchMyReports()">üîç Search</button>
                        <button class="btn btn-info" onclick="showAllMyReports()">üìã Show All</button>
                        <button class="btn btn-success" onclick="refreshMyReports()">üîÑ Refresh</button>
                    </div>
                    <div id="myReportsList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìÖ Upcoming Follow-ups</h3>
                    <div class="search-box">
                        <input type="date" id="followUpSearch" placeholder="Filter by date..." onchange="filterFollowUps()">
                        <button class="btn btn-primary" onclick="showAllFollowUps()">Show All</button>
                        <button class="btn btn-info" onclick="refreshFollowUps()">üîÑ Refresh</button>
                    </div>
                    <div id="followUpList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìä My Performance Analytics</h3>
                    <div class="search-box">
                        <select id="analyticsTimeframe" onchange="refreshAnalytics()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshAnalytics()">üîÑ Refresh Analytics</button>
                        <button class="btn btn-primary" onclick="printAnalytics()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="analyticsDisplay"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìÖ Appointment Calendar</h3>
                    <div class="search-box">
                        <select id="calendarView" onchange="changeCalendarView()" style="padding: 10px; margin-right: 10px;">
                            <option value="dayGridMonth">Monthly</option>
                            <option value="timeGridWeek">Weekly</option>
                            <option value="timeGridDay">Daily</option>
                        </select>
                        <button class="btn btn-success" onclick="initFullCalendar()">üìÖ Open Calendar</button>
                        <button class="btn btn-primary" onclick="showAppointmentBookingModal()">‚ûï Book Appointment</button>
                        <button class="btn btn-info" onclick="showTimeSlotManagement()">‚è∞ Manage Time Slots</button>
                        <button class="btn btn-warning" onclick="showAppointmentAnalytics()">üìä Analytics</button>
                        <a href="/appointments-admin.html" target="_blank" style="background:#ffffff;border:2px solid #1f2937;color:#1f2937;padding:6px 10px;border-radius:6px;text-decoration:none;font-weight:700;">Appointments Admin</a>
                    </div>
                    <div id="appointmentCalendar" style="display: none; margin-top: 20px;"></div>
                    <div id="appointmentsList"></div>
                </div>
                
                <!-- Client Self-Service Booking Page -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üîó Client Booking Page</h3>
                    <button class="btn btn-success" onclick="showClientBookingPage()">üåê Open Client Booking Page</button>
                    <button class="btn btn-info" onclick="copyBookingLink()">üìã Copy Booking Link</button>
                </div>
                </div>

                <div id="consultantStaffSection" style="display: none;">
                    <div class="form-section">
                        <h3>üë§ Staff Services</h3>
                        <p style="color:#64748b; margin-bottom:18px;">Consultants can request leave or cash advances without leaving the portal.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                            <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                                <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                                <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Book time off and check approval status.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffLeaveRequest('consultant')">Request Leave</button>
                                    <button class="btn btn-info" onclick="viewMyLeaveRequests('consultant')">My Requests</button>
                                </div>
                                <div id="staffLeaveStatus-consultant" style="margin-top:15px;"></div>
                            </div>
                            <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                                <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                                <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request petty cash or reimbursements.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffCashRequest('consultant')">Request Cash</button>
                                    <button class="btn btn-info" onclick="viewMyCashRequests('consultant')">My Requests</button>
                                </div>
                                <div id="staffCashStatus-consultant" style="margin-top:15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Portal (formerly Dispenser Portal) -->
        <div id="dispenser" class="tab-content">
            <div id="dispenserAuth">
                <div class="portal-header">
                    <h2>üè¨ Branch Portal</h2>
                    <p>Sales, prescriptions, and branch operations</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">üîÑ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access branch portal</p>
                    <button class="btn" onclick="showLogin('dispenser')">üîê Login</button>
                </div>
            </div>
            <div id="dispenserContent" style="display: none;">
                <div class="user-profile" id="dispenserProfile"></div>
                
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">üè¨ Branch Portal</h2>
                
                <!-- Cash Drawer Status -->
                <div id="cashDrawerStatus" style="background: #f8f9fa; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <!-- Will be populated by displayCashDrawerStatus() -->
                </div>
                
                <!-- Main Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 3px solid #c41e3a; flex-wrap: wrap;">
                    <button class="dispenserTab" id="walkInTab" onclick="showDispenserTab('walkIn')" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold;">
                        üõí Sales
                    </button>
                    <button class="dispenserTab" id="saleTab" onclick="showDispenserTab('sale')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üõí Sale
                    </button>
                    <button class="dispenserTab" id="prescriptionTab" onclick="showDispenserTab('prescription')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üíä Prescriptions
                    </button>
                    <button class="dispenserTab" id="stockTab" onclick="showDispenserTab('stock')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üì¶ Stock
                    </button>
                    <button class="dispenserTab" id="bankingTab" onclick="showDispenserTab('banking')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üè¶ Banking
                    </button>
                    <button class="dispenserTab" id="paymentsTab" onclick="showDispenserTab('payments')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üí≥ Payments
                    </button>
                    <button class="dispenserTab" id="onlineOrdersTab" onclick="showDispenserTab('onlineOrders')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üõçÔ∏è Online Orders
                    </button>
                    <button class="dispenserTab" id="bonusTab" onclick="showDispenserTab('bonus')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üéÅ Bonus
                    </button>
                    <button class="dispenserTab" id="communicationTab" onclick="showDispenserTab('communication')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üí¨ Communication
                    </button>
                    <button class="dispenserTab" id="staffTab" onclick="showDispenserTab('staff')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üë§ Staff
                    </button>
                    <button class="dispenserTab" id="distributorRegistrationTab" onclick="showDispenserTab('distributorRegistration')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üìù Distributor Registration
                    </button>
                    <button class="dispenserTab" id="fieldProgramTab" onclick="showDispenserTab('fieldProgram')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        üöê Field Program
                    </button>
                </div>
                
                <!-- Branch Stock Section (Hidden by default) -->
                <div id="dispenserStockSection" style="display: none;">
                    <style>
                        #dispenserStockSection {
                            background: #f5f7fb;
                            border-radius: 24px;
                            padding: 0;
                        }
                        #dispenserStockSection .stock-portal {
                            display: flex;
                            flex-direction: column;
                            gap: 24px;
                        }
                        #dispenserStockSection .stock-hero {
                            display: flex;
                            flex-wrap: wrap;
                            justify-content: space-between;
                            align-items: center;
                            gap: 18px;
                            padding: 28px 32px;
                            border-radius: 24px;
                            background: radial-gradient(120% 150% at 100% 0%, rgba(99, 102, 241, 0.55) 0%, rgba(30, 64, 175, 0.92) 55%, rgba(17, 24, 39, 0.98) 100%);
                            color: #ffffff;
                            position: relative;
                            overflow: hidden;
                        }
                        #dispenserStockSection .stock-hero::after {
                            content: "";
                            position: absolute;
                            inset: 0;
                            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(99, 102, 241, 0.15) 100%);
                            pointer-events: none;
                        }
                        #dispenserStockSection .stock-hero-content {
                            max-width: 520px;
                            position: relative;
                            z-index: 1;
                        }
                        #dispenserStockSection .stock-hero-eyebrow {
                            margin: 0 0 8px;
                            text-transform: uppercase;
                            letter-spacing: 0.14em;
                            font-size: 0.8rem;
                            font-weight: 700;
                            opacity: 0.7;
                        }
                        #dispenserStockSection .stock-hero h2 {
                            margin: 0;
                            font-size: clamp(1.8rem, 3vw, 2.3rem);
                            letter-spacing: -0.01em;
                        }
                        #dispenserStockSection .stock-hero p {
                            margin: 12px 0 0;
                            color: rgba(255, 255, 255, 0.82);
                            line-height: 1.7;
                            font-size: 0.98rem;
                        }
                        #dispenserStockSection .stock-hero-actions {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 12px;
                            position: relative;
                            z-index: 1;
                        }
                        #dispenserStockSection .stock-action {
                            border: none;
                            border-radius: 999px;
                            padding: 12px 22px;
                            font-weight: 600;
                            font-size: 0.95rem;
                            cursor: pointer;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
                            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.18);
                            background: rgba(255, 255, 255, 0.08);
                            color: #e2e8f0;
                            backdrop-filter: blur(10px);
                        }
                        #dispenserStockSection .stock-action:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 18px 36px rgba(15, 23, 42, 0.22);
                            opacity: 0.95;
                        }
                        #dispenserStockSection .stock-action--refresh {
                            border: 1px solid rgba(255, 255, 255, 0.25);
                        }
                        #dispenserStockSection .stock-action--receive {
                            background: linear-gradient(135deg, #22d3ee, #0ea5e9);
                            color: #ffffff;
                        }
                        #dispenserStockSection .stock-action--transfer {
                            background: linear-gradient(135deg, #a855f7, #6366f1);
                            color: #ffffff;
                        }
                        #dispenserStockSection .stock-action--export {
                            background: linear-gradient(135deg, #f97316, #ea580c);
                            color: #ffffff;
                        }
                        #dispenserStockSection .stock-filters-card {
                            background: #ffffff;
                            border-radius: 24px;
                            padding: 26px 28px;
                            box-shadow: 0 22px 44px rgba(15, 23, 42, 0.08);
                            border: 1px solid rgba(15, 23, 42, 0.05);
                        }
                        #dispenserStockSection .stock-filters-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            gap: 16px;
                            flex-wrap: wrap;
                            margin-bottom: 18px;
                        }
                        #dispenserStockSection .stock-filters-header h3 {
                            margin: 0;
                            font-size: 1.2rem;
                            color: #0f172a;
                        }
                        #dispenserStockSection .stock-filters-header p {
                            margin: 4px 0 0;
                            color: #64748b;
                            font-size: 0.95rem;
                        }
                        #dispenserStockSection .stock-chip {
                            border: none;
                            background: rgba(99, 102, 241, 0.12);
                            color: #312e81;
                            padding: 9px 18px;
                            border-radius: 999px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
                        }
                        #dispenserStockSection .stock-chip:hover {
                            background: rgba(99, 102, 241, 0.18);
                            color: #111827;
                            transform: translateY(-1px);
                        }
                        #dispenserStockSection .stock-filters-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                            gap: 18px;
                        }
                        #dispenserStockSection .stock-field label {
                            display: block;
                            margin-bottom: 6px;
                            font-weight: 600;
                            color: #0f172a;
                            font-size: 0.9rem;
                        }
                        #dispenserStockSection .stock-field input,
                        #dispenserStockSection .stock-field select {
                            width: 100%;
                            border: 1px solid #d1d5db;
                            border-radius: 14px;
                            padding: 12px 14px;
                            font-size: 0.95rem;
                            background: #f8fafc;
                            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
                            color: #1f2937;
                        }
                        #dispenserStockSection .stock-field input:focus,
                        #dispenserStockSection .stock-field select:focus {
                            outline: none;
                            border-color: #6366f1;
                            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
                            background: #ffffff;
                        }
                        #dispenserStockSection .stock-kpi-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                        }
                        #dispenserStockSection .stock-kpi-card {
                            position: relative;
                            border-radius: 22px;
                            padding: 24px 26px;
                            color: #ffffff;
                            overflow: hidden;
                            box-shadow: 0 28px 48px rgba(15, 23, 42, 0.14);
                        }
                        #dispenserStockSection .stock-kpi-card::after {
                            content: "";
                            position: absolute;
                            inset: 0;
                            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.22), transparent 55%);
                            opacity: 0.6;
                        }
                        #dispenserStockSection .stock-kpi-card--total {
                            background: linear-gradient(135deg, #2563eb, #1d4ed8);
                        }
                        #dispenserStockSection .stock-kpi-card--value {
                            background: linear-gradient(135deg, #0f766e, #0d9488);
                        }
                        #dispenserStockSection .stock-kpi-card--low {
                            background: linear-gradient(135deg, #f59e0b, #d97706);
                        }
                        #dispenserStockSection .stock-kpi-card--out {
                            background: linear-gradient(135deg, #dc2626, #b91c1c);
                        }
                        #dispenserStockSection .stock-kpi-label {
                            margin: 0;
                            text-transform: uppercase;
                            letter-spacing: 0.14em;
                            font-size: 0.78rem;
                            opacity: 0.78;
                        }
                        #dispenserStockSection .stock-kpi-value {
                            margin: 12px 0 0;
                            font-size: 2.2rem;
                            font-weight: 700;
                            letter-spacing: -0.02em;
                        }
                        #dispenserStockSection .stock-kpi-subtext {
                            margin: 14px 0 0;
                            font-size: 0.9rem;
                            opacity: 0.85;
                        }
                        #dispenserStockSection .stock-table-card {
                            background: #ffffff;
                            border-radius: 26px;
                            border: 1px solid rgba(15, 23, 42, 0.05);
                            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.12);
                            overflow: hidden;
                        }
                        #dispenserStockSection .stock-section-header {
                            padding: 24px 28px 0;
                            display: flex;
                            justify-content: space-between;
                            gap: 16px;
                            flex-wrap: wrap;
                        }
                        #dispenserStockSection .stock-section-header h3 {
                            margin: 0;
                            font-size: 1.35rem;
                            color: #0f172a;
                        }
                        #dispenserStockSection .stock-section-header p {
                            margin: 6px 0 0;
                            color: #64748b;
                            max-width: 520px;
                            font-size: 0.94rem;
                        }
                        #dispenserStockSection .stock-table-wrapper {
                            padding: 0 28px 28px;
                            overflow-x: auto;
                        }
                        #dispenserStockSection .stock-table {
                            width: 100%;
                            border-collapse: collapse;
                            min-width: 720px;
                            font-size: 0.95rem;
                        }
                        #dispenserStockSection .stock-table thead th {
                            background: #f8fafc;
                            color: #0f172a;
                            padding: 14px 16px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 0.06em;
                            font-size: 0.8rem;
                            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
                        }
                        #dispenserStockSection .stock-table-row:nth-child(even) {
                            background: #fdfdff;
                        }
                        #dispenserStockSection .stock-cell {
                            padding: 16px;
                            border-bottom: 1px solid rgba(148, 163, 184, 0.16);
                            color: #1f2937;
                            vertical-align: middle;
                        }
                        #dispenserStockSection .stock-cell--qty,
                        #dispenserStockSection .stock-cell--price,
                        #dispenserStockSection .stock-cell--value {
                            text-align: right;
                            font-variant-numeric: tabular-nums;
                        }
                        #dispenserStockSection .stock-cell--qty {
                            font-weight: 600;
                        }
                        #dispenserStockSection .stock-cell--expiry,
                        #dispenserStockSection .stock-cell--status,
                        #dispenserStockSection .stock-cell--actions {
                            text-align: center;
                        }
                        #dispenserStockSection .stock-status-badge {
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            padding: 6px 16px;
                            border-radius: 999px;
                            font-weight: 600;
                            font-size: 0.85rem;
                        }
                        #dispenserStockSection .stock-status-badge--good {
                            background: #dcfce7;
                            color: #166534;
                        }
                        #dispenserStockSection .stock-status-badge--warn {
                            background: #fef9c3;
                            color: #92400e;
                        }
                        #dispenserStockSection .stock-status-badge--bad {
                            background: #fee2e2;
                            color: #b91c1c;
                        }
                        #dispenserStockSection .stock-inline-btn {
                            padding: 6px 14px;
                            border-radius: 999px;
                            border: 1px solid rgba(99, 102, 241, 0.35);
                            background: rgba(99, 102, 241, 0.12);
                            color: #312e81;
                            font-size: 0.82rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
                        }
                        #dispenserStockSection .stock-inline-btn:hover {
                            background: rgba(99, 102, 241, 0.18);
                            border-color: rgba(99, 102, 241, 0.55);
                            color: #1e1b4b;
                            transform: translateY(-1px);
                        }
                        #dispenserStockSection .stock-empty-state {
                            padding: 48px 16px;
                            text-align: center;
                            color: #64748b;
                            font-weight: 500;
                            background: #f8fafc;
                            border-radius: 18px;
                        }
                        #dispenserStockSection .stock-activity-card {
                            background: #ffffff;
                            border-radius: 26px;
                            border: 1px solid rgba(15, 23, 42, 0.05);
                            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.12);
                            padding: 24px 28px 28px;
                        }
                        #dispenserStockSection .stock-activity-list {
                            display: flex;
                            flex-direction: column;
                            gap: 14px;
                        }
                        #dispenserStockSection .stock-activity-item {
                            display: flex;
                            gap: 16px;
                            align-items: flex-start;
                            padding: 16px 18px;
                            border: 1px solid rgba(148, 163, 184, 0.14);
                            border-radius: 18px;
                            background: #f8fafc;
                            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
                        }
                        #dispenserStockSection .stock-activity-icon {
                            width: 42px;
                            height: 42px;
                            border-radius: 14px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.2rem;
                            font-weight: 700;
                            flex-shrink: 0;
                        }
                        #dispenserStockSection .stock-activity-icon[data-variant="receive"],
                        #dispenserStockSection .stock-activity-icon[data-variant="transfer_in"] {
                            background: rgba(34, 197, 94, 0.18);
                            color: #166534;
                        }
                        #dispenserStockSection .stock-activity-icon[data-variant="transfer_out"] {
                            background: rgba(59, 130, 246, 0.18);
                            color: #1d4ed8;
                        }
                        #dispenserStockSection .stock-activity-icon[data-variant="adjustment"] {
                            background: rgba(249, 115, 22, 0.18);
                            color: #9a3412;
                        }
                        #dispenserStockSection .stock-activity-icon[data-variant="default"] {
                            background: rgba(148, 163, 184, 0.18);
                            color: #475569;
                        }
                        #dispenserStockSection .stock-activity-body {
                            flex: 1;
                        }
                        #dispenserStockSection .stock-activity-title {
                            margin: 0;
                            font-size: 1.05rem;
                            font-weight: 600;
                            color: #0f172a;
                        }
                        #dispenserStockSection .stock-activity-meta {
                            margin: 6px 0 0;
                            display: flex;
                            flex-wrap: wrap;
                            gap: 12px;
                            font-size: 0.85rem;
                            color: #64748b;
                        }
                        #dispenserStockSection .stock-activity-note {
                            margin: 10px 0 0;
                            font-size: 0.9rem;
                            color: #475569;
                        }
                        #dispenserStockSection .stock-activity-empty {
                            padding: 28px;
                            text-align: center;
                            color: #64748b;
                            background: #f8fafc;
                            border-radius: 18px;
                        }
                        #dispenserStockSection .stock-restricted-notice {
                            margin-top: 20px;
                            padding: 18px 20px;
                            border-radius: 18px;
                            background: #fef3c7;
                            border: 1px solid #facc15;
                            color: #92400e;
                            font-size: 0.95rem;
                            line-height: 1.6;
                        }
                        @media (max-width: 1024px) {
                            #dispenserStockSection .stock-hero {
                                padding: 24px;
                            }
                            #dispenserStockSection .stock-section-header {
                                padding: 20px 20px 0;
                            }
                            #dispenserStockSection .stock-table-wrapper {
                                padding: 0 20px 20px;
                            }
                            #dispenserStockSection .stock-activity-card {
                                padding: 20px;
                            }
                        }
                        @media (max-width: 768px) {
                            #dispenserStockSection .stock-action {
                                width: 100%;
                                justify-content: center;
                            }
                            #dispenserStockSection .stock-filters-card {
                                padding: 22px;
                            }
                            #dispenserStockSection .stock-table {
                                min-width: 100%;
                            }
                        }
                    </style>
                    <section class="stock-portal">
                        <header class="stock-hero">
                            <div class="stock-hero-content">
                                <p class="stock-hero-eyebrow">Branch Operations</p>
                                <h2>Branch Inventory Command Center</h2>
                                <p>Monitor stock levels, respond to expiry risks, and coordinate transfers without leaving the counter.</p>
                            </div>
                            <div class="stock-hero-actions">
                                <button type="button" class="stock-action stock-action--refresh" onclick="refreshBranchInventory()">üîÑ Refresh Data</button>
                                <button type="button" class="stock-action stock-action--receive" onclick="openBranchStockReceiveModal()">‚ûï Receive Stock</button>
                                <button type="button" class="stock-action stock-action--transfer" onclick="openBranchStockTransferModal()">üì§ Transfer Stock</button>
                                <button type="button" class="stock-action stock-action--export" onclick="exportBranchInventoryCSV()">üì• Export CSV</button>
                            </div>
                        </header>

                        <div class="stock-filters-card">
                            <div class="stock-filters-header">
                                <div>
                                    <h3>Smart Filters</h3>
                                    <p>Slice inventory by product, stock health, or expiry focus.</p>
                                </div>
                                <button type="button" class="stock-chip" onclick="refreshBranchInventory()">Refresh data</button>
                            </div>
                            <div class="stock-filters-grid">
                                <div class="stock-field">
                                    <label for="branchInventorySearch">Search product</label>
                                    <input type="text" id="branchInventorySearch" placeholder="Search by name or batch..." onkeyup="filterBranchInventory()">
                                </div>
                                <div class="stock-field">
                                    <label for="branchInventoryCategory">Focus</label>
                                    <select id="branchInventoryCategory" onchange="filterBranchInventory()">
                                        <option value="all">All stock</option>
                                        <option value="low">Low stock</option>
                                        <option value="out">Out of stock</option>
                                        <option value="expiring">Expiring soon</option>
                                    </select>
                                </div>
                                <div class="stock-field">
                                    <label for="branchInventorySort">Sort by</label>
                                    <select id="branchInventorySort" onchange="filterBranchInventory()">
                                        <option value="name">Product name</option>
                                        <option value="stock">Stock level</option>
                                        <option value="expiry">Expiry date</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="stock-kpi-grid">
                            <article class="stock-kpi-card stock-kpi-card--total">
                                <p class="stock-kpi-label">Total products</p>
                                <p class="stock-kpi-value" id="branchInventoryTotalProducts">0</p>
                                <p class="stock-kpi-subtext">Active SKUs in this branch.</p>
                            </article>
                            <article class="stock-kpi-card stock-kpi-card--value">
                                <p class="stock-kpi-label">Stock value</p>
                                <p class="stock-kpi-value" id="branchInventoryTotalValue">N$ 0.00</p>
                                <p class="stock-kpi-subtext">Valuation based on current unit prices.</p>
                            </article>
                            <article class="stock-kpi-card stock-kpi-card--low">
                                <p class="stock-kpi-label">Low stock</p>
                                <p class="stock-kpi-value" id="branchInventoryLowStock">0</p>
                                <p class="stock-kpi-subtext">Flagged items requiring restock.</p>
                            </article>
                            <article class="stock-kpi-card stock-kpi-card--out">
                                <p class="stock-kpi-label">Out of stock</p>
                                <p class="stock-kpi-value" id="branchInventoryOutOfStock">0</p>
                                <p class="stock-kpi-subtext">Items currently unavailable.</p>
                            </article>
                        </div>

                        <div class="stock-table-card">
                            <div class="stock-section-header">
                                <div>
                                    <h3>Live Inventory</h3>
                                    <p>Real-time batch visibility with expiry and valuation insights.</p>
                                </div>
                            </div>
                            <div class="stock-table-wrapper">
                                <table id="branchInventoryTable" class="stock-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Batch No</th>
                                            <th>Quantity</th>
                                            <th>Expiry Date</th>
                                            <th>Unit Price</th>
                                            <th>Total Value</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchInventoryTableBody">
                                        <tr>
                                            <td colspan="8" class="stock-empty-state">Loading inventory...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="stock-activity-card">
                            <div class="stock-section-header">
                                <div>
                                    <h3>Recent Stock Movements</h3>
                                    <p>Track receipts, transfers, adjustments, and approvals as they happen.</p>
                                </div>
                            </div>
                            <div id="branchInventoryMovements" class="stock-activity-list">
                                <div class="stock-activity-empty">Loading movements...</div>
                            </div>
                            <div id="branchInventoryRestrictedNotice" class="stock-restricted-notice" style="display: none;">
                                <strong>‚ö†Ô∏è Restricted Access</strong> Sensitive inventory data (expected stock, losses, and adjustments) requires GM clearance. Contact your General Manager for approval.
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- Branch Stock Receive Modal -->
                <div id="branchStockReceiveModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeBranchStockReceiveModal()">&times;</span>
                        <h2 style="color: #c41e3a;">üì¶ Receive Stock</h2>
                        
                        <form id="branchStockReceiveForm" onsubmit="submitBranchStockReceive(event)">
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="receiveProductSelect" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Batch Number *</label>
                                    <input type="text" id="receiveBatchNo" required placeholder="Enter or scan batch number">
                                </div>
                                <div class="form-group">
                                    <label>Expiry Date *</label>
                                    <input type="month" id="receiveExpiryDate" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" id="receiveQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Unit</label>
                                    <input type="text" id="receiveUnit" placeholder="boxes, units, etc.">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Source</label>
                                <select id="receiveSource" style="width: 100%; padding: 10px;">
                                    <option value="warehouse">Warehouse</option>
                                    <option value="transfer">Transfer from Branch</option>
                                    <option value="return">Return</option>
                                    <option value="adjustment">Adjustment</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="receiveNotes" rows="3" placeholder="Additional notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-success" style="flex: 1;">‚úÖ Receive Stock</button>
                                <button type="button" class="btn btn-secondary" onclick="closeBranchStockReceiveModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Branch Stock Transfer Modal -->
                <div id="branchStockTransferModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeBranchStockTransferModal()">&times;</span>
                        <h2 style="color: #c41e3a;">üì§ Transfer Stock</h2>
                        
                        <form id="branchStockTransferForm" onsubmit="submitBranchStockTransfer(event)">
                            <div class="form-group">
                                <label>From Branch *</label>
                                <input type="text" id="transferFromBranch" readonly style="width: 100%; padding: 10px; background: #f0f0f0;">
                            </div>
                            
                            <div class="form-group">
                                <label>To Branch *</label>
                                <select id="transferToBranch" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Destination Branch</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="transferProductSelect" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Batch Number *</label>
                                    <input type="text" id="transferBatchNo" required placeholder="Enter or scan batch number">
                                </div>
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" id="transferQuantity" min="1" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="transferNotes" rows="3" placeholder="Transfer reason or notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-success" style="flex: 1;">üì§ Transfer Stock</button>
                                <button type="button" class="btn btn-secondary" onclick="closeBranchStockTransferModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Online Orders Section (Hidden by default) -->
                <div id="dispenserOnlineOrdersSection" style="display: none;">
                    <div class="form-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                            <h3 style="color:#2c3e50; margin:0;">üõçÔ∏è Online Orders</h3>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-success" onclick="displayBranchOnlineOrders()">üîÑ Refresh</button>
                            </div>
                        </div>
                        <p style="color:#7f8c8d; margin-top:6px;">Receive and dispense online orders assigned to this branch.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px; margin-top:12px;">
                            <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                                <h4 style="margin:0 0 10px 0;">üì• Receiving</h4>
                                <div id="branchOnlineOrdersReceiving" style="max-height:420px; overflow:auto;"></div>
                            </div>
                            <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                                <h4 style="margin:0 0 10px 0;">üì¶ Dispensing</h4>
                                <div id="branchOnlineOrdersDispensing" style="max-height:420px; overflow:auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Walk-in Section (Default visible) -->
                <div id="dispenserWalkInSection">
                
                <!-- Walk-in Sales Section -->
                <div class="form-section" style="margin-bottom: 30px; padding: 30px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 1.3rem; padding: 25px 50px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="showWalkInSaleModal('customer')">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üõí</div>
                            <div style="font-weight: bold; font-size: 1.2rem;">New Walk-in Sale</div>
                            <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 5px;">Process walk-in customer purchase</div>
                        </button>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üìã Recent Walk-in Sales</h4>
                        <div id="walkInSalesList" style="min-height: 100px;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">No walk-in sales yet</p>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Prescription Section (Hidden by default) -->
                <div id="dispenserPrescriptionSection" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìã Prescription Dispensing</h3>
                
                <div class="search-box">
                    <input type="text" id="dispenserSearch" placeholder="Search prescriptions by client name, report ID, or consultant...">
                    <button class="btn" onclick="searchPrescriptions('dispenser')">üîç Search</button>
                    <button class="btn btn-info" onclick="showAllPrescriptions('dispenser')">üíä Show All Prescriptions</button>
                    <button class="btn btn-warning" onclick="updateExistingReportsPricing()">üí∞ Update Pricing</button>
                    <button class="btn btn-primary" onclick="showDailyStatementModal()">üìä Daily Statement</button>
                    <button class="btn btn-success" onclick="refreshDispenserData()">üîÑ Refresh Data</button>
                </div>

                <!-- Status/Date/Branch Filters -->
                <div class="search-box" style="gap: 10px; align-items: center;">
                    <select id="rxBranchFilter" onchange="displayPrescriptions()" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                        <option value="">All Branches</option>
                    </select>
                    <select id="rxStatusFilter" onchange="displayPrescriptions()" style="padding: 10px;">
                        <option value="all" selected>Status: All</option>
                        <option value="pending">Pending</option>
                        <option value="dispensed">Dispensed</option>
                        <option value="paid">Paid</option>
                        <option value="outstanding">Outstanding</option>
                    </select>
                    <input type="date" id="rxFromDate" onchange="displayPrescriptions()" title="From date" style="padding: 10px;">
                    <input type="date" id="rxToDate" onchange="displayPrescriptions()" title="To date" style="padding: 10px;">
                    <button class="btn" onclick="clearRxFilters()">‚ôªÔ∏è Clear Filters</button>
                </div>

                <div id="prescriptionList"></div>

                <!-- Business Intelligence Dashboard -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üìà Business Intelligence Dashboard</h3>
                    <div class="search-box">
                        <select id="biTimeframe" onchange="refreshBusinessIntelligence()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshBusinessIntelligence()">üîÑ Refresh</button>
                        <button class="btn btn-primary" onclick="printBusinessIntelligence()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="biDisplay"></div>
                </div>
                
                <!-- Unified Sales Dashboard -->
                <div class="form-section" style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">üìä Unified Sales Dashboard</h3>
                    <div class="search-box" style="margin-bottom: 20px;">
                        <select id="salesTimeframe" onchange="refreshUnifiedSales()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshUnifiedSales()">üîÑ Refresh</button>
                        <button class="btn btn-primary" onclick="printUnifiedSales()">üñ®Ô∏è Print Report</button>
                        <button class="btn btn-info" onclick="exportUnifiedSales()">üì• Export Excel</button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 id="totalSales" style="color: #3498db; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total Sales (N$)</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 id="totalBV" style="color: #27ae60; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total BV Points</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 id="walkInCount" style="color: #e74c3c; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Walk-in Sales</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 id="prescriptionCount" style="color: #f39c12; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Prescriptions</p>
                        </div>
                    </div>
                    
                    <!-- Customer Type Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üíº Customer Type Sales</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Distributor Sales:</span>
                                    <strong id="distributorSales" style="color: #27ae60;">N$ 0.00</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div id="distributorBar" style="background: #27ae60; height: 100%; width: 0%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Customer Sales:</span>
                                    <strong id="customerSales" style="color: #f39c12;">N$ 0.00</strong>
                                </div>
                                <div style="background: #fff3cd; height: 10px; border-radius: 5px;">
                                    <div id="customerBar" style="background: #f39c12; height: 100%; width: 0%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üë• Top Distributors</h4>
                            <div id="topDistributors" style="max-height: 200px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Sales Table -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üìã Detailed Sales Breakdown</h4>
                        <div id="unifiedSalesDetail" style="max-height: 400px; overflow-y: auto;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading sales data...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Price List Section -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üí∞ Official Price List - June 2025</h3>
                    <div class="search-box">
                        <input type="text" id="priceSearch" placeholder="Search products by name..." onkeyup="searchPriceList()">
                        <button class="btn btn-info" onclick="showAllPrices()">üìã Show All Prices</button>
                        <button class="btn btn-success" onclick="printPriceList()">üñ®Ô∏è Print Price List</button>
                    </div>
                    <div id="priceList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Banking Section -->
            <div id="dispenserBankingSection" style="display: none;">
                <div class="form-section">
                    <h3>üè¶ Banking Operations</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <button class="btn btn-success" style="padding: 20px; font-size: 1.1rem;" onclick="showBankDepositModal()">
                            üí∞ Make Deposit
                        </button>
                        <button class="btn btn-info" style="padding: 20px; font-size: 1.1rem;" onclick="showCashDrawerModal()">
                            üíµ Cash Drawer
                        </button>
                        <button class="btn btn-warning" style="padding: 20px; font-size: 1.1rem;" onclick="showCashExpenseModal()">
                            üí∏ Record Expense
                        </button>
                        <button class="btn" style="padding: 20px; font-size: 1.1rem;" onclick="displayBankingHistory()">
                            üìã Banking History
                        </button>
                    </div>
                    <div id="bankingOperations" style="background: white; padding: 20px; border-radius: 8px;"></div>
                </div>
            </div>
            
            <!-- Payments Section -->
            <div id="dispenserPaymentsSection" style="display: none;">
                <div class="form-section">
                    <h3>üí≥ Payment Management</h3>
                    <div class="search-box">
                        <input type="text" id="paymentSearch" placeholder="Search by client name or invoice number..." onkeyup="searchPayments()">
                        <button class="btn btn-success" onclick="showRecordPaymentModal()">‚ûï Record Payment</button>
                        <button class="btn btn-info" onclick="displayPaymentHistory()">üîÑ Refresh</button>
                    </div>
                    <div id="paymentsList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Bonus Section -->
            <div id="dispenserBonusSection" style="display: none;">
                <div class="form-section">
                    <h3>üéÅ Bonus Payouts</h3>
                    <div class="search-box" style="margin-bottom: 12px; gap: 10px; flex-wrap: wrap;">
                        <input type="month" id="dispenserBonusMonth" style="max-width: 200px;">
                        <input type="text" id="dispenserBonusSearch" placeholder="Search NB or Name..." onkeyup="renderDispenserPendingBonuses()" style="flex: 1; min-width: 240px;">
                        <button class="btn btn-success" onclick="renderDispenserPendingBonuses()">üîÑ Refresh</button>
                    </div>
                    <div id="dispenserBonusSummary" style="margin: 8px 0; color: #2c3e50;"></div>
                    <div id="dispenserPendingBonusList" class="scroll-x" style="max-height: 460px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No pending bonuses</p>
                    </div>
                </div>
            </div>

            <!-- Communication Section -->
            <div id="dispenserCommunicationSection" style="display: none;">
                <div class="form-section">
                    <h3>üí¨ Staff Communications</h3>
                    <p class="portal-communication-note">Review messages from HR, GM, Director, Finance, Front Desk and MIS, then send updates back to them.</p>
                    <div class="staff-comm-tabs">
                        <button class="staff-comm-filter-btn active" data-filter="all" onclick="setStaffCommFilter('all', event)">All</button>
                        <button class="staff-comm-filter-btn" data-filter="hr" onclick="setStaffCommFilter('hr', event)">üë• HR</button>
                        <button class="staff-comm-filter-btn" data-filter="gm" onclick="setStaffCommFilter('gm', event)">üëî GM</button>
                        <button class="staff-comm-filter-btn" data-filter="director" onclick="setStaffCommFilter('director', event)">üéØ Director</button>
                        <button class="staff-comm-filter-btn" data-filter="finance" onclick="setStaffCommFilter('finance', event)">üí∞ Finance</button>
                        <button class="staff-comm-filter-btn" data-filter="frontdesk" onclick="setStaffCommFilter('frontdesk', event)">üñ•Ô∏è Front Desk</button>
                        <button class="staff-comm-filter-btn" data-filter="mis" onclick="setStaffCommFilter('mis', event)">üìä MIS</button>
                    </div>
                    <div id="staffCommunicationInbox" class="communication-list"></div>
                    <form id="staffCommunicationForm" class="communication-form" onsubmit="submitStaffCommunication(event)">
                        <div class="form-group">
                            <label class="required">Choose recipients</label>
                            <div class="checkbox-group" id="staffCommRecipients">
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="hr">üë• HR</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="gm">üëî GM</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="director">üéØ Director</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="finance">üí∞ Finance</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="frontdesk">üñ•Ô∏è Front Desk</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="mis">üìä MIS</label>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-info btn-sm" onclick="toggleStaffRecipients(true)">Select All</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleStaffRecipients(false)">Clear</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required" for="staffCommMessage">Message</label>
                            <textarea id="staffCommMessage" rows="4" placeholder="Type your update or request..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send Communication</button>
                            <button type="button" class="btn" onclick="resetStaffCommunicationForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Staff Section (Services & Communications) -->
            <div id="dispenserStaffSection" style="display: none;">
                <div class="form-section">
                    <div class="staff-subtabs">
                        <button class="staff-subtab-btn active" data-tab="services" onclick="showStaffSubTab('services', event)">üõ†Ô∏è Services</button>
                    </div>

                    <div id="staffServicesTab" class="staff-subtab-content active">
                        <h3>üë§ Staff Services</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Leave Request -->
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 2px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üìÖ Leave Management</h4>
                                <button class="btn btn-success" onclick="openStaffLeaveRequest('branch')">Request Leave</button>
                                <button class="btn btn-info" onclick="viewMyLeaveRequests('branch')">My Leave Requests</button>
                                <div id="staffLeaveStatus-branch" style="margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Cash Request -->
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border: 2px solid #2196f3;">
                                <h4 style="color: #1565c0; margin-bottom: 15px;">üíµ Cash Requests</h4>
                                <button class="btn btn-success" onclick="openStaffCashRequest('branch')">Request Cash</button>
                                <button class="btn btn-info" onclick="viewMyCashRequests('branch')">My Cash Requests</button>
                                <div id="staffCashStatus-branch" style="margin-top: 15px;"></div>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
            
            <!-- Distributor Registration Section -->
            <div id="dispenserDistributorRegistrationSection" style="display: none;">
                <div class="form-section">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">üìù Distributor Agreement Form</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Register a new distributor by filling out the agreement form below.</p>
                    
                    <form id="distributorAgreementForm" onsubmit="submitDistributorAgreement(event)" style="background: white; padding: 30px; border-radius: 8px; border: 1px solid #ddd;">
                        <!-- Instructions -->
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è PLEASE READ CAREFULLY</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #856404;">
                                <li><strong>This is a legal agreement. FORMS WITH INCOMPLETE INFORMATION WILL NOT BE PROCESSED.</strong></li>
                                <li>Please press firmly and print clearly.</li>
                                <li>Husband and wife are considered as one Distributor only.</li>
                                <li>Corporation may register, but needs to submit SEC/DTI. Authorized Representative will need duly appointed Power of Attorney or Board Resolution.</li>
                            </ol>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Distributor's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label class="required">Full Name (Last name, First name, M.I.)</label>
                                <input type="text" id="distributorName" name="distributorName" required placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label class="required">Birthdate</label>
                                <input type="date" id="distributorBirthdate" name="birthdate" required>
                            </div>
                            
                            <div>
                                <label>Age</label>
                                <input type="number" id="distributorAge" name="age" min="18" readonly>
                            </div>
                            
                            <div>
                                <label class="required">Sex</label>
                                <select id="distributorSex" name="sex" required style="padding: 10px;">
                                    <option value="">Select...</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="required">Nationality</label>
                                <input type="text" id="distributorNationality" name="nationality" required placeholder="e.g., Namibian">
                            </div>
                            
                            <div>
                                <label class="required">Mobile Number</label>
                                <input type="tel" id="distributorMobile" name="mobileNo" required placeholder="0812345678">
                            </div>
                            
                            <div>
                                <label>Residence Phone</label>
                                <input type="tel" id="distributorResidencePhone" name="residencePhone" placeholder="0612345678">
                            </div>
                            
                            <div>
                                <label>Office Phone</label>
                                <input type="tel" id="distributorOfficePhone" name="officePhone" placeholder="0612345678">
                            </div>
                            
                            <div>
                                <label>Email</label>
                                <input type="email" id="distributorEmail" name="email" placeholder="email@example.com">
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <label>Profile Photo (Optional)</label>
                                <input type="file" name="photo" id="distributorPhotoInput" accept="image/*" onchange="previewDistributorPhoto(event)">
                                <div id="distributorPhotoPreview" style="margin-top: 10px; display: none;">
                                    <img id="distributorPhotoPreviewImg" src="" alt="Photo preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                                </div>
                            </div>
                            
                            <div>
                                <label class="required">Mailing Address (House number, Street)</label>
                                <input type="text" id="distributorAddress1" name="address1" required placeholder="House No., Street">
                            </div>
                            
                            <div>
                                <label class="required">Town, City</label>
                                <input type="text" id="distributorCity" name="city" required placeholder="Town, City">
                            </div>
                            
                            <div>
                                <label>Zip/Postal Code</label>
                                <input type="text" id="distributorZipCode" name="zipCode" placeholder="00000">
                            </div>
                            
                            <div>
                                <label>Tax Identification No.</label>
                                <input type="text" id="distributorTaxId" name="taxId" placeholder="Tax ID">
                            </div>
                            
                            <div>
                                <label>SSS No.</label>
                                <input type="text" id="distributorSSS" name="sssNo" placeholder="SSS Number">
                            </div>
                            
                            <div>
                                <label>Beneficiary</label>
                                <input type="text" id="distributorBeneficiary" name="beneficiary" placeholder="Beneficiary Name">
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Direct Upline's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label>Upline Name (Last name, First name, M.I.)</label>
                                <input type="text" id="uplineName" name="uplineName" placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label>Direct Upline's ID No.</label>
                                <input type="text" id="uplineIdNo" name="uplineIdNo" placeholder="e.g., NB001544" onkeyup="searchUplineDistributor()">
                                <div id="uplineSearchResults" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                            </div>
                            
                            <div>
                                <label>Upline Mailing Address</label>
                                <input type="text" id="uplineAddress" name="uplineAddress" placeholder="Address">
                            </div>
                            
                            <div>
                                <label>Upline City</label>
                                <input type="text" id="uplineCity" name="uplineCity" placeholder="City">
                            </div>
                            
                            <div>
                                <label>Upline Mobile</label>
                                <input type="tel" id="uplineMobile" name="uplineMobile" placeholder="Mobile">
                            </div>
                            
                            <div>
                                <label>Upline Zip Code</label>
                                <input type="text" id="uplineZipCode" name="uplineZipCode" placeholder="Zip Code">
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Sponsor's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label>Sponsor Name (Last name, First name, M.I.)</label>
                                <input type="text" id="sponsorName" name="sponsorName" placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label>Sponsor's ID No.</label>
                                <input type="text" id="sponsorIdNo" name="sponsorIdNo" placeholder="e.g., NB001544" onkeyup="searchSponsorDistributor()">
                                <div id="sponsorSearchResults" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Registration Kit Selection</h3>
                        
                        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 5px; padding: 15px; margin-top: 20px; margin-bottom: 20px;">
                            <p style="margin: 0 0 10px 0; color: #1565c0; font-weight: bold;">‚ö†Ô∏è Required: Select a registration kit to be dispensed</p>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="registrationKit" value="fert" required style="margin-right: 8px;">
                                <strong>REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)</strong>
                                <span style="color: #666; margin-left: 10px;">- Price: N$ 1,200.00 (CP: N$ 1,200.00, BV: 150)</span>
                            </label>
                            <label style="display: block;">
                                <input type="radio" name="registrationKit" value="alfalfa" required style="margin-right: 8px;">
                                <strong>REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)</strong>
                                <span style="color: #666; margin-left: 10px;">- Price: N$ 1,200.00 (CP: N$ 1,200.00, BV: 150)</span>
                            </label>
                            <small style="color: #666; display: block; margin-top: 10px;">
                                The selected kit will be automatically dispensed and stock will be reduced from the branch inventory upon registration.
                            </small>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Material Received</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="bag"> Bag
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="products"> Products (Specified)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="brochure"> All in One Product Brochure
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="priceList"> Price List
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="compensationPlan"> Compensation Plan
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="bodySystemsGuide"> Body Systems Guide
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="agreementForms"> Distributor Agreement Forms
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="others"> Others: 
                                <input type="text" id="materialsOthers" placeholder="Specify" style="flex: 1; padding: 5px;">
                            </label>
                        </div>
                        
                        <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 5px; padding: 15px; margin-top: 30px;">
                            <h4 style="margin-top: 0; color: #2e7d32;">Declaration</h4>
                            <p style="color: #1b5e20; margin: 0;">
                                I, the undersigned, prior to becoming a distributor of Dynapharm, have read and understood the Dynapharm Compensation Plan and Distributor Agreement which are deemed to form part of this contract. I have read and am fully aware of the Terms and Conditions, and policies appearing on the reverse of this application form.
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label class="required">Date</label>
                                <input type="date" id="agreementDate" name="agreementDate" required value="" onchange="document.getElementById('agreementDate').value = this.value">
                            </div>
                            <div>
                                <label class="required">Applicant's Signature</label>
                                <input type="text" id="applicantSignature" name="applicantSignature" required placeholder="Full Name">
                            </div>
                        </div>
                        
                        <!-- FOR OFFICIAL USE ONLY -->
                        <div style="background: #7b1fa2; color: white; padding: 15px; border-radius: 5px; margin-top: 30px;">
                            <h3 style="margin-top: 0; color: white;">FOR OFFICIAL USE ONLY</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label>Date Received</label>
                                    <input type="date" id="dateReceived" name="dateReceived" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label>Received by</label>
                                    <input type="text" id="receivedBy" name="receivedBy" placeholder="Staff Name" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label>Processed by</label>
                                    <input type="text" id="processedBy" name="processedBy" placeholder="Staff Name" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label style="font-weight: bold;">Assigned Distributor ID No.</label>
                                    <input type="text" id="assignedDistributorId" name="assignedDistributorId" readonly style="padding: 10px; width: 100%; background: #fff; color: #000; font-weight: bold; font-size: 1.1rem;">
                                    <small style="color: #fff; opacity: 0.9;">Will be auto-generated upon save</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success" style="flex: 1; padding: 15px; font-size: 1.1rem;">
                                üíæ Save & Register Distributor
                            </button>
                            <button type="button" class="btn" onclick="resetDistributorAgreementForm()" style="flex: 1; padding: 15px;">
                                üîÑ Reset Form
                            </button>
                        </div>
                        
                        <div id="distributorAgreementStatus" style="margin-top: 20px;"></div>
                    </form>
                </div>
            </div>
            
            <!-- Field Program Section -->
            <div id="dispenserFieldProgramSection" style="display: none;">
                <div class="form-section">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">üöê Field Program - Stock Requests</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Manage stock requests from distributors for field program activities. All requests require distributor verification and FEFO compliance.</p>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openFieldProgramRequestForm()" style="background: #c41e3a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚ûï New Stock Request
                        </button>
                        <button class="btn btn-secondary" onclick="refreshFieldProgramRequests()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div id="fieldProgramRequestsList" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <p style="text-align: center; color: #7f8c8d;">Loading field program requests...</p>
                    </div>
                </div>
            </div>
            
            <!-- Field Program Request Form Modal -->
            <div id="fieldProgramRequestModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeFieldProgramRequestForm()">&times;</span>
                    <h2 style="color: #c41e3a; margin-bottom: 20px;">üöê Field Program Stock Request Form</h2>
                    
                    <form id="fieldProgramRequestForm" onsubmit="submitFieldProgramRequest(event)">
                        <!-- Distributor Verification -->
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #856404;">Distributor Verification *</h3>
                            <div class="form-group" style="position: relative;">
                                <label>Search Distributor by NB Number or Name *</label>
                                <input type="text" id="fieldProgramDistributorSearch" placeholder="Type NB number (e.g., NB001544) or name" 
                                       onkeyup="searchFieldProgramDistributor()" autocomplete="off" required>
                                <div id="fieldProgramDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                                <input type="hidden" id="fieldProgramDistributorId" required>
                                <small id="fieldProgramDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                            </div>
                            <div id="fieldProgramDistributorInfo" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                <strong>Selected Distributor:</strong> <span id="fieldProgramDistributorName"></span><br>
                                <strong>NB Number:</strong> <span id="fieldProgramDistributorCode"></span><br>
                                <strong>Mobile:</strong> <span id="fieldProgramDistributorMobile"></span>
                            </div>
                        </div>
                        
                        <!-- Request Details -->
                        <div class="form-group">
                            <label>Request Date *</label>
                            <input type="date" id="fieldProgramRequestDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Branch *</label>
                            <select id="fieldProgramBranch" required>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                        
                        <!-- Product Selection -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Requested Products *</h3>
                            <div id="fieldProgramProducts">
                                <div class="field-program-product-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;">
                                    <div class="form-group">
                                        <label>Product *</label>
                                        <select class="field-program-product-select" required>
                                            <option value="">Select Product</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Quantity *</label>
                                        <input type="number" class="field-program-quantity" min="1" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Unit</label>
                                        <input type="text" class="field-program-unit" placeholder="boxes, units, etc.">
                                    </div>
                                    <button type="button" class="btn btn-danger" onclick="removeFieldProgramProductRow(this)" style="padding: 8px 12px;">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addFieldProgramProductRow()" style="margin-top: 10px;">‚ûï Add Product</button>
                        </div>
                        
                        <!-- Notes -->
                        <div class="form-group">
                            <label>Purpose/Notes</label>
                            <textarea id="fieldProgramNotes" rows="3" placeholder="Brief description of field program activity or purpose"></textarea>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div style="background: #f8f9fa; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                            <h3 style="margin-top: 0; color: #c41e3a;">Terms and Conditions of Stock Handling Commitment</h3>
                            <ol style="font-size: 0.9rem; line-height: 1.6;">
                                <li><strong>Stock Accountability:</strong> The distributor is fully responsible for all stock received and must account for every item.</li>
                                <li><strong>FEFO Compliance:</strong> Stock will be issued following First Expired First Out (FEFO) principles. All products must be issued by batch/expiry date using barcode scanning.</li>
                                <li><strong>Storage Requirements:</strong> Stock must be stored in appropriate conditions (temperature, humidity, etc.) as per product specifications.</li>
                                <li><strong>Damage/Loss Reporting:</strong> Any damaged or lost stock must be reported immediately to the branch manager.</li>
                                <li><strong>Return Policy:</strong> Unused stock may be returned within 30 days if in original condition and packaging.</li>
                                <li><strong>Sales Records:</strong> Complete sales records must be maintained and submitted as required.</li>
                                <li><strong>Payment Terms:</strong> Payment for stock must be made according to agreed terms. Late payments may affect future requests.</li>
                                <li><strong>Compliance:</strong> All stock must be used/sold in compliance with Dynapharm policies and local regulations.</li>
                            </ol>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="fieldProgramAgreeTerms" required style="margin-right: 8px; width: 18px; height: 18px;">
                                    <span>I have read and agree to the Terms and Conditions of Stock Handling Commitment *</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Signature -->
                        <div class="form-group">
                            <label>Distributor Signature (Type Full Name) *</label>
                            <input type="text" id="fieldProgramSignature" placeholder="Full name as signature" required>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="closeFieldProgramRequestForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Field Program Stock Issuing Modal (FEFO) -->
            <div id="fieldProgramIssuingModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeFieldProgramIssuing()">&times;</span>
                    <h2 style="color: #c41e3a; margin-bottom: 20px;">üì¶ Issue Stock (FEFO Compliance Required)</h2>
                    
                    <div id="fieldProgramIssuingContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock & Inventory Management Portal -->
        <div id="stock" class="tab-content">
            <div id="stockAuth">
                <div class="portal-header">
                    <h2>üì¶ Stock & Inventory Management</h2>
                    <p>Manage stock receiving, warehouses, and distribution</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access stock management portal</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn" onclick="showLogin('stock')">üîê Login</button>
                    </div>
                </div>
            </div>
            <div id="stockContent" style="display: none;">
            <div class="stock-hub-shell">
                <header class="stock-hub-hero">
                    <div class="stock-hub-hero__text">
                        <p class="stock-hub-hero__eyebrow">National Inventory Network</p>
                        <h2>Stock & Inventory Management Portal</h2>
                        <p>Manage country stock, warehouse inventory, and branch distribution with real-time intelligence.</p>
                        <div class="stock-hub-hero__actions">
                            <button class="hub-btn hub-btn--primary" onclick="refreshAllData()">üîÑ Refresh Data</button>
                            <button class="hub-btn hub-btn--ghost" id="stockHelpBtnGlobal">‚ùì Help & Playbooks</button>
                        </div>
                    </div>
                    <div class="stock-hub-hero__profile user-profile" id="stockProfile"></div>
                </header>

                <nav class="stock-hub-mode-toggle">
                    <button id="stockMainTabBtn" class="btn hub-toggle-btn hub-toggle-btn--active" onclick="toggleStockView('main')">üì¶ Stock Tools</button>
                    <button id="stockStaffTabBtn" class="btn hub-toggle-btn" onclick="toggleStockView('staff')">üë§ Staff Services</button>
                </nav>

                <div id="stockWorkflowNav" class="stock-hub-journey">
                    <button type="button" class="tab-button workflow-tab" data-tab="overview" onclick="showStockTab('overview')">1Ô∏è‚É£ Overview & KPIs</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="countryImport" onclick="showStockTab('countryImport')">2Ô∏è‚É£ Country Import & QA</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="warehouseDistribution" onclick="showStockTab('warehouseDistribution')">3Ô∏è‚É£ Warehouses & Putaway</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="branchDistribution" onclick="showStockTab('branchDistribution')">4Ô∏è‚É£ Branch Distribution</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="transfers" onclick="showStockTab('transfers')">5Ô∏è‚É£ Transfers & Approvals</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="orders" onclick="showStockTab('orders')">6Ô∏è‚É£ Orders & Procurement</button>
                    <button type="button" class="tab-button workflow-tab" data-tab="distribution" onclick="showStockTab('distribution')">7Ô∏è‚É£ Distribution History</button>
                </div>

                <div id="stockTabsContainer" class="stock-hub-tabs">
                <!-- Stock Management Tabs -->
                <nav class="stock-hub-tab-row">
                    <button class="tab-button active" onclick="showStockTab('overview')" id="stockTabOverview">üìä Overview</button>
                    <button class="tab-button" onclick="showStockTab('countryImport')" id="stockTabCountryImport">üì• Country Import</button>
                    <button class="tab-button" onclick="showStockTab('warehouseDistribution')" id="stockTabWarehouseDistribution">üè¢ Warehouse Distribution</button>
                    <button class="tab-button" onclick="showStockTab('branchDistribution')" id="stockTabBranchDistribution">üè¨ Branch Distribution</button>
                    <button class="tab-button" onclick="showStockTab('transfers')" id="stockTabTransfers">üîÑ Transfers</button>
                    <button class="tab-button" onclick="showStockTab('sharing')" id="stockTabSharing">ü§ù Shop & Warehouse Sharing</button>
                    <button class="tab-button" onclick="showStockTab('orders')" id="stockTabOrders">üìã Orders (Auto & Manual)</button>
                    <button class="tab-button" onclick="showStockTab('invoices')" id="stockTabInvoices">üßæ Invoices</button>
                    <button class="tab-button" onclick="showStockTab('countryInventory')" id="stockTabCountryInventory">üåç Country Inventory</button>
                    <button class="tab-button" onclick="showStockTab('realtime')" id="stockTabRealtime">‚ö° Real-time Sync</button>
                </nav>

                <nav class="stock-hub-tab-row stock-hub-tab-row--secondary">
                    <span class="stock-hub-tab-label">Advanced Tools:</span>
                    <button class="tab-button" onclick="showStockTab('barcode')" id="stockTabBarcode">üè∑Ô∏è Barcode &amp; Scans</button>
                    <button class="tab-button" onclick="showStockTab('reorder')" id="stockTabReorder">‚ö†Ô∏è Reorder Plans</button>
                    <button class="tab-button" onclick="showStockTab('batch')" id="stockTabBatch">üî¢ Batch &amp; Returns</button>
                    <button class="tab-button" onclick="showStockTab('valuation')" id="stockTabValuation">üí∞ Valuation</button>
                    <button class="tab-button" onclick="showStockTab('countryStock')" id="stockTabCountryStock">üöö Legacy Country</button>
                    <button class="tab-button" onclick="showStockTab('windhoek')" id="stockTabWindhoek">üè¢ Legacy Windhoek</button>
                    <button class="tab-button" onclick="showStockTab('ondangwa')" id="stockTabOndangwa">üè≠ Legacy Ondangwa</button>
                    <button class="tab-button" onclick="showStockTab('distribution')" id="stockTabDistribution">üöõ Legacy Distribution</button>
                    <button class="tab-button" onclick="showStockTab('inventory')" id="stockTabInventory">üì¶ Inventory Log</button>
                </nav>

                <!-- Overview Tab - Stock Management Dashboard -->
                <div id="overviewTab" class="stock-tab-content" style="display: block;">
                    <!-- KPI Dashboard -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Stock Value</div>
                            <div id="overviewTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Pending Orders</div>
                            <div id="overviewPendingOrders" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Low Stock Items</div>
                            <div id="overviewLowStock" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Active Transfers</div>
                            <div id="overviewActiveTransfers" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                    </div>

                    <!-- Inventory Timely Report -->
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <div>
                                <h3 class="hub-section__title">Inventory Timely Report</h3>
                                <p class="hub-section__meta">Track received stock, sales performance, adjustments, and client activity with quick time-based snapshots.</p>
                            </div>
                            <div class="hub-section__actions">
                                <label for="inventoryTimelyRange">Reporting Period</label>
                                <select id="inventoryTimelyRange" onchange="renderInventoryTimelyReport(this.value)">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                        <div id="inventoryTimelySummary" class="hub-panel-grid">
                            <article class="hub-panel" data-icon="üì•">
                                <div class="hub-panel__heading"><span>Stock Received</span><span>üì•</span></div>
                                <p id="inventoryReportReceived" class="hub-panel__value">0</p>
                                <p id="inventoryReportReceivedMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üõí">
                                <div class="hub-panel__heading"><span>Stock Sold</span><span>üõí</span></div>
                                <p id="inventoryReportSold" class="hub-panel__value">0</p>
                                <p id="inventoryReportSoldMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üöê">
                                <div class="hub-panel__heading"><span>Field Sales</span><span>üöê</span></div>
                                <p id="inventoryReportFieldSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportFieldSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üë©‚Äçüíº">
                                <div class="hub-panel__heading"><span>Consultant Sales</span><span>üë©‚Äçüíº</span></div>
                                <p id="inventoryReportConsultantSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportConsultantSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üíª">
                                <div class="hub-panel__heading"><span>Online Sales</span><span>üíª</span></div>
                                <p id="inventoryReportOnlineSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportOnlineSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üíµ">
                                <div class="hub-panel__heading"><span>Cash Refunds</span><span>üíµ</span></div>
                                <p id="inventoryReportCashRefunds" class="hub-panel__value">0</p>
                                <p id="inventoryReportCashRefundsMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="‚è±Ô∏è">
                                <div class="hub-panel__heading"><span>Expiries</span><span>‚è±Ô∏è</span></div>
                                <p id="inventoryReportExpiries" class="hub-panel__value">0</p>
                                <p id="inventoryReportExpiriesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üßØ">
                                <div class="hub-panel__heading"><span>Damages</span><span>üßØ</span></div>
                                <p id="inventoryReportDamages" class="hub-panel__value">0</p>
                                <p id="inventoryReportDamagesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üö∂">
                                <div class="hub-panel__heading"><span>Walk-in Sales</span><span>üö∂</span></div>
                                <p id="inventoryReportWalkinSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportWalkinSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="ü§ù">
                                <div class="hub-panel__heading"><span>Referred Clients</span><span>ü§ù</span></div>
                                <p id="inventoryReportReferrals" class="hub-panel__value">0</p>
                                <p id="inventoryReportReferralsMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üè∑Ô∏è">
                                <div class="hub-panel__heading"><span>Distributor Sales</span><span>üè∑Ô∏è</span></div>
                                <p id="inventoryReportDistributorSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportDistributorSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                            <article class="hub-panel" data-icon="üõçÔ∏è">
                                <div class="hub-panel__heading"><span>Non-Distributor Sales</span><span>üõçÔ∏è</span></div>
                                <p id="inventoryReportNonDistributorSales" class="hub-panel__value">0</p>
                                <p id="inventoryReportNonDistributorSalesMeta" class="hub-panel__meta">No data</p>
                            </article>
                        </div>
                    </section>
                    <!-- Stock Flow Visualization -->
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Stock Flow Overview</h3>
                            <p class="hub-section__meta">Monitor stock movement from country import through warehouses and branches to sales.</p>
                        </div>
                        <div class="hub-flow">
                            <div class="hub-flow__node">
                                <strong>üì• Country Import</strong>
                                <div id="overviewCountryStock" class="hub-flow__value">0</div>
                            </div>
                            <div class="hub-flow__node">
                                <strong>üè¢ Warehouses</strong>
                                <div id="overviewWarehouseStock" class="hub-flow__value">0</div>
                            </div>
                            <div class="hub-flow__node">
                                <strong>üè¨ Branches</strong>
                                <div id="overviewBranchStock" class="hub-flow__value">0</div>
                            </div>
                            <div class="hub-flow__node">
                                <strong>üõí Shop &amp; Sales</strong>
                                <div id="overviewShopStock" class="hub-flow__value">0</div>
                            </div>
                        </div>
                    </section>
                    <!-- Recent Activity -->
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Recent Stock Movements</h3>
                            <p class="hub-section__meta">Latest receipts, transfers, and adjustments across all locations.</p>
                        </div>
                        <div id="overviewRecentMovements" class="hub-activity-feed">
                            <div class="hub-activity-empty">Loading movements...</div>
                        </div>
                    </section>
                    <!-- Quick Actions -->
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Quick Actions</h3>
                            <p class="hub-section__meta">Jump directly into the flow you need.</p>
                        </div>
                        <div class="hub-action-grid">
                            <button class="hub-action" onclick="handleStockQuickAction('countryImport')">üì• Import Country Stock</button>
                            <button class="hub-action" onclick="handleStockQuickAction('warehouseDistribution')">üè¢ Distribute to Warehouse</button>
                            <button class="hub-action" onclick="handleStockQuickAction('branchDistribution')">üè¨ Distribute to Branch</button>
                            <button class="hub-action" onclick="handleStockQuickAction('orders')">üìã Manage Orders</button>
                            <button class="hub-action" onclick="handleStockQuickAction('countryInventory')">üåç Country Inventory</button>
                        </div>
                    </section>
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Purchase Orders &amp; Supplier Collaboration</h3>
                            <p class="hub-section__meta">Purchase orders mirror the stock import format and sync with supplier scorecards.</p>
                        </div>
                        <div class="hub-stack">
                            <div class="hub-card hub-card--surface">
                                <h4 class="hub-card__title">Create Purchase Order</h4>
                                <p class="hub-card__meta">Table format identical to stock import for quick copy and paste from supplier ASNs.</p>
                                <form id="purchaseOrderForm" onsubmit="handlePurchaseOrderSubmit(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Supplier</label>
                                            <input type="text" id="poSupplier" placeholder="Supplier name" required>
                                        </div>
                                        <div class="form-group">
                                            <label>PO Number</label>
                                            <input type="text" id="poNumber" placeholder="PO-2025-001" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Expected Arrival</label>
                                            <input type="date" id="poEta" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Total Cost (N$)</label>
                                            <input type="number" id="poValue" min="0" step="0.01" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Currency</label>
                                            <input type="text" id="poCurrency" value="NAD" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Status</label>
                                            <select id="poStatus" required>
                                                <option value="Open">Open</option>
                                                <option value="Acknowledged">Acknowledged</option>
                                                <option value="In Transit">In Transit</option>
                                                <option value="Delivered">Delivered</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Notes</label>
                                        <textarea id="poNotes" rows="2" placeholder="Incoterms, lead time commitments..."></textarea>
                                    </div>
                                    <div class="hub-table-wrapper">
                                        <table id="purchaseOrderTable">
                                            <thead>
                                                <tr>
                                                    <th>Cartons No.</th>
                                                    <th>Description</th>
                                                    <th>Batch No.</th>
                                                    <th>Expiry Date</th>
                                                    <th style="text-align:center;">Quantity</th>
                                                    <th style="text-align:center;">Total (CTNS)</th>
                                                    <th style="text-align:center;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchaseOrderTableBody">
                                                <tr>
                                                    <td><input type="text" class="po-carton-no" placeholder="A1-98" required></td>
                                                    <td><input type="text" class="po-description" placeholder="Product description" required></td>
                                                    <td><input type="text" class="po-batch-no" placeholder="DP24265" required></td>
                                                    <td><input type="month" class="po-expiry-date" placeholder="YYYY-MM" required></td>
                                                    <td><input type="number" class="po-quantity" placeholder="Qty" min="1" required></td>
                                                    <td><input type="number" class="po-total-ctns" placeholder="CTNS" min="1" required></td>
                                                    <td style="text-align:center;"><button type="button" class="btn btn-danger" onclick="removePurchaseOrderRow(this)">Remove</button></td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="hub-table-actions">
                                                            <button type="button" class="btn btn-success" onclick="addPurchaseOrderRow()">‚ûï Add Row</button>
                                                            <button type="button" class="btn btn-info" onclick="autoGeneratePurchaseOrdersFromMovements()">üîÑ Auto-Generate from Stock Movements</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="hub-card-cta">
                                        <button type="submit" class="hub-btn hub-btn--primary">üì• Create Purchase Order</button>
                                        <button type="button" class="hub-btn hub-btn--ghost" onclick="clearPurchaseOrderForm()">Clear All</button>
                                    </div>
                                </form>
                            </div>

                            <div class="hub-summary-grid">
                                <article class="hub-card hub-card--surface">
                                    <div class="hub-section__header">
                                        <h4 class="hub-section__title" style="font-size:1.1rem;">Open Orders</h4>
                                        <div class="hub-table-actions">
                                            <button class="btn btn-info" onclick="renderPurchaseOrders()">üîÑ Refresh</button>
                                            <button class="btn" onclick="exportPurchaseOrders()">üì• Export</button>
                                        </div>
                                    </div>
                                    <div id="purchaseOrderList" class="hub-scroll" style="display: grid; gap: 12px;"></div>
                                </article>
                                <article class="hub-card hub-card--surface">
                                    <h4 class="hub-section__title" style="font-size:1.1rem;">Strategic Procurement Signals</h4>
                                    <ul id="planInsights" style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.6;"></ul>
                                </article>
                            </div>
                        </div>
                    </section>

                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Supplier Scorecards</h3>
                            <p class="hub-section__meta">Automatically updated from purchase orders, ASNs, and quality checks to highlight supplier reliability.</p>
                        </div>
                        <div id="supplierScorecard" class="hub-table-wrapper"></div>
                    </section>
                <!-- Stock Help Modal -->
                <div id="stockHelpModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:5000;">
                    <div style="width:min(960px,94vw); max-height:84vh; overflow:auto; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;">
                            <div id="stockHelpTitle" style="font-weight:700;">Stock Workflows</div>
                            <button id="stockHelpClose" class="btn">Close</button>
                        </div>
                        <div id="stockHelpBody" style="padding:14px 16px; font-size:14px; line-height:1.55;"></div>
                    </div>
                </div>
                
                <!-- Country Import Tab -->
                <div id="countryImportTab" class="stock-tab-content hub-tab" style="display: none;">
                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Country Stock Intake &amp; Quality Assurance</h3>
                            <p class="hub-section__meta">Import stock into country inventory with batch tracking, quality checks, and FEFO enforcement.</p>
                        </div>
                        <div class="hub-split">
                            <article class="hub-card hub-card--surface">
                                <h4 class="hub-card__title">üöö Supplier ASNs</h4>
                                <div id="asnList" class="hub-scroll">
                                    <div class="hub-activity-empty">No ASNs pending</div>
                                </div>
                            </article>
                            <article class="hub-card hub-card--surface">
                                <h4 class="hub-card__title">üß™ Quality &amp; Disposition</h4>
                                <div id="qualityList" class="hub-scroll">
                                    <div class="hub-activity-empty">Recent quality inspections</div>
                                </div>
                                <form onsubmit="handleQualitySubmit(event)" class="hub-stack">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Batch</label>
                                            <input type="text" id="qcBatch" required placeholder="Batch No.">
                                        </div>
                                        <div class="form-group">
                                            <label>ASN Ref</label>
                                            <input type="text" id="qcAsn" placeholder="ASN Reference">
                                        </div>
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" id="qcDate">
                                        </div>
                                        <div class="form-group">
                                            <label>Temp Zone</label>
                                            <select id="qcTemperature">
                                                <option value="ambient">Ambient</option>
                                                <option value="cold">Cold-chain</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Visual</label>
                                            <select id="qcVisual">
                                                <option>Pass</option>
                                                <option>Fail</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Docs</label>
                                            <select id="qcDocs">
                                                <option>Complete</option>
                                                <option>Missing</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Disposition</label>
                                            <select id="qcDisposition">
                                                <option value="Released">Released</option>
                                                <option value="Quarantine">Quarantine</option>
                                                <option value="Reject">Reject</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Hold Until</label>
                                            <input type="date" id="qcHold">
                                        </div>
                                        <div class="form-group" style="grid-column:1 / -1;">
                                            <label>Notes</label>
                                            <textarea id="qcNotes" rows="2" placeholder="Inspection notes..."></textarea>
                                        </div>
                                    </div>
                                    <div class="hub-card-cta">
                                        <button class="hub-btn hub-btn--primary" type="submit">Save Inspection</button>
                                    </div>
                                </form>
                            </article>
                        </div>
                    </section>

                    <section class="hub-section">
                        <div class="hub-highlight">
                            <h4 style="margin: 0 0 10px; color: #14532d;">üìã Import Workflow</h4>
                            <p style="margin: 0; color: #134e4a;">
                                <strong>All imported stock is automatically:</strong><br>
                                ‚Ä¢ Allocated with unique barcodes for tracking<br>
                                ‚Ä¢ Enforced with FEFO (First Expired First Out) - batches sorted by expiry date<br>
                                ‚Ä¢ Stored in Country Stock (location: 'country_stock') for distribution to warehouses<br>
                                ‚Ä¢ Tracked for full audit trail from import to sale
                            </p>
                        </div>
                        <div class="hub-card hub-card--surface">
                            <h4 class="hub-card__title">üìã Import Stock (Table Format)</h4>
                            <form id="bulkStockImportForm" class="stock-import-form" onsubmit="handleBulkStockImportSubmit(event)">
                                <div class="hub-table-wrapper">
                                    <table id="stockImportTable">
                                        <thead>
                                            <tr>
                                                <th>Cartons No.</th>
                                                <th>Description</th>
                                                <th>Batch No.</th>
                                                <th>Expiry Date</th>
                                                <th style="text-align:center;">Quantity</th>
                                                <th style="text-align:center;">Total (CTNS)</th>
                                                <th style="text-align:center;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stockImportTableBody" data-stock-import-body="true">
                                            <tr>
                                                <td><input type="text" class="stock-carton-no" placeholder="A1-98"></td>
                                                <td><input type="text" class="stock-description" placeholder="Product description" required></td>
                                                <td><input type="text" class="stock-batch-no" placeholder="DP24265" required></td>
                                                <td><input type="month" class="stock-expiry-date" placeholder="YYYY-MM" required></td>
                                                <td><input type="number" class="stock-quantity" placeholder="Qty" min="1" required></td>
                                                <td><input type="number" class="stock-total-ctns" placeholder="CTNS" min="1"></td>
                                                <td style="text-align:center;"><button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)">Remove</button></td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7">
                                                    <div class="hub-table-actions">
                                                        <button type="button" class="btn btn-success" onclick="addStockImportRow()">‚ûï Add Row</button>
                                                        <button type="button" class="btn btn-info" onclick="importFromCSV()">üìÅ Import from CSV</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="hub-card-cta">
                                    <button type="submit" class="hub-btn hub-btn--primary">üì• Import Stock</button>
                                    <button type="button" class="hub-btn hub-btn--ghost" onclick="clearStockImportForm()">Clear All</button>
                                </div>
                            </form>
                        </div>
                        <div id="importSummaryPanel" class="hub-card hub-card--surface" style="display: none; margin-top: 20px;">
                            <h4 class="hub-card__title" style="margin-bottom: 12px;">üìä Latest Import Summary</h4>
                            <div id="importSummaryContent" style="font-size: 0.9rem; color: #1f2937;">
                                <p style="margin: 0; color: #64748b;">Import stock to see a quick health check for the destination location.</p>
                            </div>
                        </div>
                    </section>

                    <section class="hub-section">
                        <div class="hub-section__header">
                            <h3 class="hub-section__title">Country Stock Inventory</h3>
                            <div class="hub-section__actions">
                                <input type="text" id="countryStockSearch" placeholder="Search products..." onkeyup="searchCountryStock()">
                                <button class="hub-btn hub-btn--ghost" type="button" onclick="displayCountryStock()">üîÑ Refresh</button>
                                <button class="hub-btn hub-btn--ghost" type="button" onclick="exportCountryStock()">üì• Export CSV</button>
                            </div>
                        </div>
                        <div id="countryStockList" class="hub-card hub-card--surface hub-scroll">
                            <div class="hub-activity-empty">Loading country stock...</div>
                        </div>
                    </section>
                </div>

                <!-- Legacy Country Stock Tab (Hidden) -->
                <!-- Legacy Country Stock Tab (Hidden) -->
                <div id="countryStockTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üöö Inbound ASNs & üß™ Quality</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                            <div>
                                <h4 style="margin-bottom:8px;">Supplier ASNs</h4>
                                <div id="asnList"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:8px;">Quality & Disposition</h4>
                                <div id="qualityList"></div>
                                <form onsubmit="handleQualitySubmit(event)" style="margin-top:12px; background:#f8f9fa; border:1px solid #e1e5ec; border-radius:8px; padding:10px;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Batch</label>
                                            <input type="text" id="qcBatch" required placeholder="Batch No.">
                                        </div>
                                        <div class="form-group">
                                            <label>ASN Ref</label>
                                            <input type="text" id="qcAsn" placeholder="ASN Reference">
                                        </div>
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" id="qcDate">
                                        </div>
                                        <div class="form-group">
                                            <label>Temp Zone</label>
                                            <select id="qcTemperature">
                                                <option value="ambient">Ambient</option>
                                                <option value="cold">Cold-chain</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Visual</label>
                                            <select id="qcVisual">
                                                <option>Pass</option>
                                                <option>Fail</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Docs</label>
                                            <select id="qcDocs">
                                                <option>Complete</option>
                                                <option>Missing</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Disposition</label>
                                            <select id="qcDisposition">
                                                <option value="Released">Released</option>
                                                <option value="Quarantine">Quarantine</option>
                                                <option value="Reject">Reject</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Hold Until</label>
                                            <input type="date" id="qcHold">
                                        </div>
                                        <div class="form-group" style="grid-column:1 / -1;">
                                            <label>Notes</label>
                                            <textarea id="qcNotes" rows="2" placeholder="Inspection notes..."></textarea>
                                        </div>
                                    </div>
                                    <div style="text-align:right; margin-top:8px;">
                                        <button class="btn btn-success" type="submit">Save Inspection</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>üì• Receive Country Stock <button class="btn" data-stock-help="country" style="margin-left:8px;">Help</button></h3>
                        <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üìã Import Workflow</h4>
                            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                                <strong>All imported stock is automatically:</strong><br>
                                ‚Ä¢ Allocated with unique barcodes for tracking<br>
                                ‚Ä¢ Enforced with FEFO (First Expired First Out) - batches sorted by expiry date<br>
                                ‚Ä¢ Stored in Country Stock for distribution to warehouses<br>
                                ‚Ä¢ Tracked for full audit trail from import to sale
                            </p>
                        </div>
                        <p style="margin-bottom: 20px; color: #666;">Import stock with batch tracking and FIFO/FEFO enforcement</p>
                        
                        <!-- Bulk Import Form -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">üìã Import Stock (Table Format)</h4>
                            <form id="bulkStockImportFormLegacy" class="stock-import-form" onsubmit="handleBulkStockImportSubmit(event)">
                                <div style="overflow-x: auto;">
                                    <table id="stockImportTable" style="width: 100%; border-collapse: collapse; background: white;">
                                        <thead>
                                            <tr style="background: #c41e3a; color: white;">
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cartons No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Batch No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Expiry Date</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Quantity</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total (CTNS)</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stockImportTableBodyLegacy" data-stock-import-body="true">
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98">
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-description" style="width: 100%; padding: 8px;" placeholder="Product description" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1">
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7" style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-success" onclick="addStockImportRow()">‚ûï Add Row</button>
                                                    <button type="button" class="btn btn-info" onclick="importFromCSV()" style="margin-left: 10px;">üìÅ Import from CSV</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button type="submit" class="btn btn-success" style="padding: 12px 40px; font-size: 1.1rem;">üì• Import Stock</button>
                                    <button type="button" class="btn" onclick="clearStockImportForm()">Clear All</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìä Country Stock Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="countryStockSearch" placeholder="Search products..." onkeyup="searchCountryStock()">
                            <button class="btn btn-success" onclick="displayCountryStock()">Refresh</button>
                        </div>
                        <div id="countryStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Windhoek Warehouse Tab -->
                <div id="windhoekTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">üìã Workflow Information</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock ‚Üí Windhoek Warehouse ‚Üí Branches<br>
                            Stock can only be transferred from Country Stock to this warehouse. From here, stock is distributed to branches.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>üè¢ Windhoek Warehouse - Transfer Stock from Country Stock</h3>
                        <form id="transferToWindhoekForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source</label>
                                    <select id="windhoekSource" required onchange="loadWindhoekProducts()">
                                        <option value="country">Country Stock</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Stock must come from Country Stock</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="windhoekProduct" required onchange="updateWindhoekAvailableQuantity()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="windhoekAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;" placeholder="Select product to view available quantity">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="windhoekQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="windhoekNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üì§ Transfer to Windhoek</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>üì¶ Windhoek Warehouse Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="windhoekSearch" placeholder="Search products..." onkeyup="searchWindhoekStock()">
                            <button class="btn btn-success" onclick="displayWindhoekStock()">Refresh</button>
                            <button class="btn btn-warning" onclick="showLowStockWindhoek()">‚ö†Ô∏è Low Stock Alert</button>
                        </div>
                        <div id="windhoekStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Ondangwa Warehouse Tab -->
                <div id="ondangwaTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üìã Workflow Information</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock ‚Üí Ondangwa Warehouse ‚Üí Branches<br>
                            Stock can only be transferred from Country Stock to this warehouse. From here, stock is distributed to branches.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>üè¢ Ondangwa Warehouse - Transfer Stock from Country Stock</h3>
                        <form id="transferToOndangwaForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source</label>
                                    <select id="ondangwaSource" required onchange="loadOndangwaProducts()">
                                        <option value="country">Country Stock</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Stock must come from Country Stock</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="ondangwaProduct" required onchange="updateOndangwaAvailableQuantity()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="ondangwaAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;" placeholder="Select product to view available quantity">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="ondangwaQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="ondangwaNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üì§ Transfer to Ondangwa</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>üì¶ Ondangwa Warehouse Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="ondangwaSearch" placeholder="Search products..." onkeyup="searchOndangwaStock()">
                            <button class="btn btn-success" onclick="displayOndangwaStock()">Refresh</button>
                            <button class="btn btn-warning" onclick="showLowStockOndangwa()">‚ö†Ô∏è Low Stock Alert</button>
                        </div>
                        <div id="ondangwaStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Distribution Tab -->
                <div id="distributionTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">üìã Distribution Workflow</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock ‚Üí Warehouses (Windhoek/Ondangwa) ‚Üí Branches<br>
                            Branches can only receive stock from warehouses, not directly from Country Stock.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>üöö Distribute Stock to Branches from Warehouses</h3>
                        <form id="distributeStockForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">From Warehouse</label>
                                    <select id="distributionWarehouse" required onchange="loadDistributionProducts()">
                                        <option value="">Select Warehouse</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Only warehouses can distribute to branches</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">To Branch</label>
                                    <select id="distributionBranch" required onchange="updateDistributionGuidance()">
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="distributionProduct" required onchange="updateDistributionGuidance()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="distributionQuantity" min="1" required oninput="updateDistributionGuidance()">
                                    <small id="distributionGuidance" style="display:block; margin-top:6px; font-size:0.8rem; color:#64748b;">
                                        Select warehouse, branch, and product to see suggested quantities.
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="distributionDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Expiry Date</label>
                                    <input type="month" id="distributionExpiryDate" required placeholder="YYYY-MM" title="Enter the expiry date for this stock batch">
                                </div>
                                <div class="form-group">
                                    <label class="required">Dispatch Number</label>
                                    <input type="text" id="distributionDispatchNumber" required placeholder="e.g., DISP-2024-001" title="Enter the dispatch/reference number for this distribution">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="distributionNotes" rows="2" placeholder="Distribution notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üöö Distribute to Branch</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìã Distribution History</h3>
                        <div class="search-box">
                            <input type="text" id="distributionSearch" placeholder="Search distributions..." onkeyup="searchDistribution()">
                            <button class="btn btn-success" onclick="displayDistributionHistory()">Refresh</button>
                        </div>
                        <div id="distributionHistoryList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Inventory Management Tab -->
                <div id="inventoryTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üìä Inventory Management - All Stock Movements</h3>
                        <p style="margin-bottom: 20px; color: #666;">Track all stock movements across country, warehouses, and branches</p>
                        
                        <!-- Filters -->
                        <div class="form-grid" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Location</label>
                                <select id="inventoryLocationFilter" onchange="filterInventoryMovements()">
                                    <option value="all">All Locations</option>
                                    <option value="country">Country Stock</option>
                                    <option value="windhoek">Windhoek Warehouse</option>
                                    <option value="ondangwa">Ondangwa Warehouse</option>
                                    <option value="barcode">Barcode Stock</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Movement Type</label>
                                <select id="inventoryMovementFilter" onchange="filterInventoryMovements()">
                                    <option value="all">All Movements</option>
                                    <option value="import">Import</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="distribution">Distribution</option>
                                    <option value="adjustment">Adjustment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Search Product</label>
                                <input type="text" id="inventoryProductSearch" placeholder="Search by product name..." onkeyup="filterInventoryMovements()">
                            </div>
                            <div class="form-group">
                                <label>Date Range</label>
                                <input type="date" id="inventoryDateFrom" onchange="filterInventoryMovements()">
                                <input type="date" id="inventoryDateTo" onchange="filterInventoryMovements()">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-success" onclick="displayInventoryMovements()">üîÑ Refresh</button>
                            <button class="btn btn-primary" onclick="exportInventoryMovements()">üì• Export</button>
                            <button class="btn btn-warning" onclick="printInventoryReport()">üñ®Ô∏è Print Report</button>
                        </div>
                        
                        <div id="inventoryMovementsList" style="max-height: 600px; overflow-y: auto;">
                            <p style="text-align: center; padding: 20px; color: #666;">Loading inventory movements...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Warehouse Distribution Tab -->
                <div id="warehouseDistributionTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üè¢ Warehouse Distribution - Country Stock to Warehouses</h3>
                        <p style="margin-bottom: 15px; color: #666;">Distribute stock from Country Stock to Windhoek and Ondangwa warehouses</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <!-- Windhoek Warehouse -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #2196f3; margin-bottom: 15px;">üè¢ Windhoek Warehouse</h4>
                                <form id="transferToWindhoekForm" onsubmit="handleTransferToWindhoek(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Product</label>
                                            <select id="windhoekProduct" required onchange="updateWindhoekAvailableQuantity()">
                                                <option value="">Select Product</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Available in Country</label>
                                            <input type="text" id="windhoekAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">Quantity</label>
                                            <input type="number" id="windhoekQuantity" min="1" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Notes</label>
                                            <textarea id="windhoekNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">üì§ Transfer to Windhoek</button>
                                </form>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="displayWindhoekStock()">üîÑ View Windhoek Inventory</button>
                                </div>
                            </div>
                            
                            <!-- Ondangwa Warehouse -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #ff9800; margin-bottom: 15px;">üè¢ Ondangwa Warehouse</h4>
                                <form id="transferToOndangwaFormNew" onsubmit="handleTransferToOndangwa(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Product</label>
                                            <select id="ondangwaProductNew" required onchange="updateOndangwaAvailableQuantity()">
                                                <option value="">Select Product</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Available in Country</label>
                                            <input type="text" id="ondangwaAvailableQtyNew" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">Quantity</label>
                                            <input type="number" id="ondangwaQuantityNew" min="1" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Notes</label>
                                            <textarea id="ondangwaNotesNew" rows="2" placeholder="Transfer notes..."></textarea>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">üì§ Transfer to Ondangwa</button>
                                </form>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="displayOndangwaStock()">üîÑ View Ondangwa Inventory</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üì¶ Warehouse Inventory Summary</h3>
                        <div id="warehouseInventorySummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <div id="windhoekInventorySummary" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4>Windhoek Warehouse</h4>
                                <p style="color: #7f8c8d;">Loading...</p>
                            </div>
                            <div id="ondangwaInventorySummary" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4>Ondangwa Warehouse</h4>
                                <p style="color: #7f8c8d;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Branch Distribution Tab -->
                <div id="branchDistributionTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üè¨ Branch Distribution - Warehouse to Branches</h3>
                        <p style="margin-bottom: 15px; color: #666;">Distribute stock from warehouses to branches based on requests and replenishment needs</p>
                        
                        <form id="branchDistributionForm" onsubmit="handleBranchDistribution(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source Warehouse</label>
                                    <select id="branchDistSourceWarehouse" required>
                                        <option value="">Select Warehouse</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Destination Branch</label>
                                    <select id="branchDistDestination" required>
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="branchDistProduct" required onchange="updateBranchDistAvailableQty()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available in Warehouse</label>
                                    <input type="text" id="branchDistAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="branchDistQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select id="branchDistPriority">
                                        <option value="normal">Normal</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>Notes</label>
                                    <textarea id="branchDistNotes" rows="2" placeholder="Distribution notes..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">üì§ Distribute to Branch</button>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìã Pending Branch Requests</h3>
                        <div id="pendingBranchRequests" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading requests...</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìä Distribution History</h3>
                        <div id="branchDistributionHistory" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading history...</p>
                        </div>
                    </div>
                </div>

                <!-- Invoices Tab -->
                <div id="invoicesTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <h3>üßæ Sales Invoices Centre</h3>
                                <p style="margin: 4px 0 0; color: #666; max-width: 540px;">Generate printable PDFs for all or individual invoices, grouped by branch and sales channel.</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <label for="invoiceReportBranch" style="font-size: 0.85rem; color: #8aa0b5;">Branch</label>
                                <select id="invoiceReportBranch" onchange="renderInvoiceReports()" style="background: #0f1830; color: var(--text); border: 1px solid #1e2a44; border-radius: 8px; padding: 8px 12px; min-width: 160px;">
                                    <option value="all">All Branches</option>
                                </select>
                                <label for="invoiceReportRange" style="font-size: 0.85rem; color: #8aa0b5;">Period</label>
                                <select id="invoiceReportRange" onchange="renderInvoiceReports()" style="background: #0f1830; color: var(--text); border: 1px solid #1e2a44; border-radius: 8px; padding: 8px 12px; min-width: 160px;">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 15px;">
                            <div style="color: #8aa0b5;">Use the search to filter by invoice number, client or channel. Select rows for targeted printing.</div>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input id="invoiceReportSearch" oninput="debounceInvoiceSearch()" placeholder="Search invoice or client..." style="background: #0f1830; color: var(--text); border: 1px solid #1e2a44; border-radius: 8px; padding: 8px 12px; min-width: 220px;" />
                                <button class="btn btn-info" onclick="printInvoices('all')">üñ®Ô∏è Print All</button>
                                <button class="btn btn-success" onclick="printInvoices('selected')">üñ®Ô∏è Print Selected</button>
                            </div>
                        </div>
                        <div id="invoiceReportSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #0f1830; border: 1px solid #1e2a44; border-radius: 12px; padding: 16px;">
                                <div style="color: #8aa0b5; font-size: 0.95rem;">Total Invoices</div>
                                <div id="invoiceReportTotalCount" style="font-size: 1.6rem; font-weight: 700; margin-top: 8px;">0</div>
                            </div>
                            <div style="background: #0f1830; border: 1px solid #1e2a44; border-radius: 12px; padding: 16px;">
                                <div style="color: #8aa0b5; font-size: 0.95rem;">Gross Sales</div>
                                <div id="invoiceReportGrossSales" style="font-size: 1.6rem; font-weight: 700; margin-top: 8px;">N$ 0.00</div>
                            </div>
                            <div style="background: #0f1830; border: 1px solid #1e2a44; border-radius: 12px; padding: 16px;">
                                <div style="color: #8aa0b5; font-size: 0.95rem;">Refunds Processed</div>
                                <div id="invoiceReportRefunds" style="font-size: 1.6rem; font-weight: 700; margin-top: 8px;">N$ 0.00</div>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="table" style="background: #0f1830; border-radius: 12px; overflow: hidden;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="invoiceSelectAll" onclick="toggleSelectAllInvoices(this.checked)"></th>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Branch</th>
                                        <th>Amount</th>
                                        <th>Channel</th>
                                        <th>Date</th>
                                        <th style="width: 120px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceReportTableBody">
                                    <tr>
                                        <td colspan="8" class="muted" style="padding: 16px; text-align: center;">No invoices available for the selected filters.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Transfers Tab -->
                <div id="transfersTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üîÑ Stock Transfers - Inter-Location Transfers</h3>
                        <p style="margin-bottom: 15px; color: #666;">Manage transfers between branches, warehouses, and other locations</p>
                        
                        <form id="stockTransferForm" onsubmit="handleStockTransfer(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">From Location</label>
                                    <select id="transferFromLocation" required onchange="loadTransferFromProducts()">
                                        <option value="">Select Source</option>
                                        <option value="country">Country Stock</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">To Location</label>
                                    <select id="transferToLocation" required>
                                        <option value="">Select Destination</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                        <option value="branch">Branch (select below)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="transferBranchSelect" style="display: none;">
                                    <label>Select Branch</label>
                                    <select id="transferBranch">
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="transferProduct" required onchange="updateTransferAvailableQty()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="transferAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="transferQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Reason</label>
                                    <select id="transferReason">
                                        <option value="replenishment">Replenishment</option>
                                        <option value="adjustment">Stock Adjustment</option>
                                        <option value="emergency">Emergency</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>Notes</label>
                                    <textarea id="transferNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">üîÑ Create Transfer</button>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìã Active Transfers</h3>
                        <div class="search-box" style="margin-bottom: 15px;">
                            <select id="transferStatusFilter" onchange="loadStockTransfers()">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_transit">In Transit</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-info" onclick="loadStockTransfers()">üîÑ Refresh</button>
                        </div>
                        <div id="activeTransfersList" style="max-height: 500px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading transfers...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Shop & Warehouse Sharing Tab -->
                <div id="sharingTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ü§ù Shop & Warehouse Sharing</h3>
                        <p style="margin-bottom: 15px; color: #666;">Enable sharing of stock visibility and cross-location access between shops and warehouses</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border: 1px solid #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">üè¨ Shop Visibility</h4>
                                <p style="margin-bottom: 15px; color: #666;">Configure which shops can view warehouse inventory</p>
                                <div id="shopVisibilityList" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading shop visibility settings...</p>
                                </div>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">üè¢ Warehouse Sharing</h4>
                                <p style="margin-bottom: 15px; color: #666;">Configure cross-warehouse stock visibility and sharing</p>
                                <div id="warehouseSharingList" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading warehouse sharing settings...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>‚ûï Add Sharing Rule</h4>
                            <form id="sharingRuleForm" onsubmit="handleSharingRule(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="required">From Location</label>
                                        <select id="sharingFrom" required>
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">To Location</label>
                                        <select id="sharingTo" required>
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Access Level</label>
                                        <select id="sharingAccessLevel" required>
                                            <option value="view">View Only</option>
                                            <option value="request">Can Request</option>
                                            <option value="transfer">Can Transfer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Status</label>
                                        <select id="sharingStatus">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">‚ûï Add Sharing Rule</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Tab (Auto & Manual) -->
                <div id="ordersTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üìã Orders - Automatic & Manual</h3>
                        <p style="margin-bottom: 15px; color: #666;">Manage automatic reorder triggers and manual purchase orders</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">ü§ñ Automatic Orders</h4>
                                <p style="margin-bottom: 15px; color: #666;">Orders triggered by reorder points and low stock alerts</p>
                                <div id="automaticOrdersList" style="max-height: 400px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading automatic orders...</p>
                                </div>
                                <button class="btn btn-info" onclick="refreshAutomaticOrders()" style="width: 100%; margin-top: 15px;">üîÑ Refresh</button>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">‚úã Manual Orders</h4>
                                <p style="margin-bottom: 15px; color: #666;">Manually created purchase orders and special requests</p>
                                <div id="manualOrdersList" style="max-height: 400px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading manual orders...</p>
                                </div>
                                <button class="btn btn-success" onclick="showCreateManualOrder()" style="width: 100%; margin-top: 15px;">‚ûï Create Manual Order</button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>‚öôÔ∏è Automatic Order Settings</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Enable Auto-Orders</label>
                                        <input type="checkbox" id="autoOrdersEnabled" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Reorder Point Threshold (%)</label>
                                        <input type="number" id="reorderThreshold" value="20" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label>Auto-Order Frequency</label>
                                        <select id="autoOrderFrequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Require Approval</label>
                                        <input type="checkbox" id="requireOrderApproval">
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="saveAutoOrderSettings()">üíæ Save Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Country Inventory Tab -->
                <div id="countryInventoryTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>üåç Country-Wide Inventory Dashboard</h3>
                        <p style="margin-bottom: 15px; color: #666;">Comprehensive view of all inventory across country stock, warehouses, and branches</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Country Stock Value</div>
                                <div id="countryTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Warehouse Stock</div>
                                <div id="warehouseTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Branch Stock</div>
                                <div id="branchTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Products</div>
                                <div id="countryTotalProducts" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>üìä Inventory by Location</h4>
                            <div class="search-box" style="margin-bottom: 15px;">
                                <select id="countryInvLocationFilter" onchange="displayCountryStockInventory()">
                                    <option value="all">All Locations</option>
                                    <option value="country">Country Stock</option>
                                    <option value="windhoek">Windhoek Warehouse</option>
                                    <option value="ondangwa">Ondangwa Warehouse</option>
                                    <option value="branches">All Branches</option>
                                </select>
                                <select id="countryInvProductFilter" onchange="displayCountryStockInventory()">
                                    <option value="all">All Products</option>
                                </select>
                                <button class="btn btn-success" onclick="displayCountryStockInventory()">üîÑ Refresh</button>
                                <button class="btn btn-primary" onclick="exportCountryInventory()">üì• Export Report</button>
                            </div>
                            <div id="countryInventoryTable" style="max-height: 600px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <p style="text-align: center; color: #7f8c8d;">Loading inventory...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Sync Tab -->
                <div id="realtimeTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>‚ö° Real-time Information Sharing</h3>
                        <p style="margin-bottom: 15px; color: #666;">Monitor real-time synchronization between stock, branch, and other portals</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üîÑ Sync Status</h4>
                                <div id="syncStatusCards" style="display: grid; gap: 10px;">
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Stock Portal</span>
                                            <span id="syncStockPortal" class="pill good">üü¢ Connected</span>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Branch Portal</span>
                                            <span id="syncBranchPortal" class="pill good">üü¢ Connected</span>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>GM Portal</span>
                                            <span id="syncGMPortal" class="pill good">üü¢ Connected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">üì° Recent Sync Events</h4>
                                <div id="realtimeSyncEvents" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading sync events...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>‚öôÔ∏è Sync Configuration</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Sync Frequency</label>
                                        <select id="syncFrequency">
                                            <option value="realtime" selected>Real-time</option>
                                            <option value="1min">Every 1 minute</option>
                                            <option value="5min">Every 5 minutes</option>
                                            <option value="15min">Every 15 minutes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Auto-Sync Enabled</label>
                                        <input type="checkbox" id="autoSyncEnabled" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Sync Stock Changes</label>
                                        <input type="checkbox" id="syncStockChanges" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Sync Order Changes</label>
                                        <input type="checkbox" id="syncOrderChanges" checked>
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="saveSyncSettings()">üíæ Save Settings</button>
                                <button class="btn btn-info" onclick="testSyncConnection()" style="margin-left: 10px;">üîç Test Connection</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- /#stockTabsContainer -->

                <div id="stockStaffSection" style="display:none;">
                    <div class="form-section">
                        <h3>üë§ Stock Team Staff Services</h3>
                        <p style="color:#64748b; margin-bottom:18px;">Leave and cash support tools for warehouse and logistics teams.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                            <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                                <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                                <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Request shift swaps or planned leave for stock operations.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffLeaveRequest('stock')">Request Leave</button>
                                    <button class="btn btn-info" onclick="viewMyLeaveRequests('stock')">My Requests</button>
                                </div>
                                <div id="staffLeaveStatus-stock" style="margin-top:15px;"></div>
                            </div>
                            <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                                <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                                <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request petty cash for urgent branch or warehouse deliveries.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffCashRequest('stock')">Request Cash</button>
                                    <button class="btn btn-info" onclick="viewMyCashRequests('stock')">My Requests</button>
                                </div>
                                <div id="staffCashStatus-stock" style="margin-top:15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HR Portal -->
        <div id="hr-portal" class="tab-content">
            <h2>üë• HR Portal</h2>
            
            <!-- HR Sub-tabs -->
            <div class="hr-subtabs">
                <button class="hr-tab-btn active" onclick="showHRSubTab('employee-management')">üë§ Employee Management</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('leave-management')">üìÖ Leave Management</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('warnings')">‚ö†Ô∏è Warnings & Disciplinary</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('terminations')">üö™ Terminations</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('attendance')">üïê Attendance</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('performance')">üìä Performance Review</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('hr-communication')">üí¨ Staff Communication</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('data-collection')">üìã Data Collection</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('staff-self-service')">üë§ Staff Services</button>
            </div>

            <!-- Employee Management Tab -->
            <div id="employee-management" class="hr-tab-content active">
                <div class="form-section">
                    <h3>üë§ Employee Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddEmployee()">‚ûï Add New Employee</button>
                        <button class="btn btn-primary" onclick="refreshEmployeeList()">üîÑ Refresh List</button>
                        <button class="btn btn-warning" onclick="exportEmployeeData()">üì• Export Employee Data</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="employeeSearch" placeholder="Search employees by name, ID, or department..." 
                               style="flex: 1; padding: 10px;">
                    </div>
                    
                    <div id="employeeList"></div>
                </div>

                <!-- Add Employee Modal -->
                <div id="addEmployeeModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
                        <h2>‚ûï Add New Employee</h2>
                        <form id="addEmployeeForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee ID</label>
                                    <input type="text" id="employeeId" required placeholder="e.g., EMP001">
                                </div>
                                <div class="form-group">
                                    <label class="required">Full Name</label>
                                    <input type="text" id="employeeName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Department</label>
                                    <select id="employeeDepartment" required>
                                        <option value="">Select Department</option>
                                        <option value="Administration">Administration</option>
                                        <option value="Health Consultation">Health Consultation</option>
                                        <option value="Pharmacy">Pharmacy</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Management">Management</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Position</label>
                                    <input type="text" id="employeePosition" required placeholder="e.g., Health Consultant">
                                </div>
                                <div class="form-group">
                                    <label class="required">Email</label>
                                    <input type="email" id="employeeEmail" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Phone</label>
                                    <input type="tel" id="employeePhone" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Hire Date</label>
                                    <input type="date" id="employeeHireDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Employment Type</label>
                                    <select id="employmentType" required>
                                        <option value="">Select Type</option>
                                        <option value="Full-time">Full-time</option>
                                        <option value="Part-time">Part-time</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Temporary">Temporary</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Salary</label>
                                    <input type="number" id="employeeSalary" placeholder="Enter salary (N$)">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="employeeAddress" placeholder="Full address">
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth</label>
                                    <input type="date" id="employeeDOB">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" id="emergencyContactName">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" id="emergencyContactPhone">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="employeeNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üíæ Save Employee</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addEmployeeModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div id="leave-management" class="hr-tab-content">
                <div class="form-section">
                    <h3>üìÖ Leave Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showApplyLeave()">‚ûï Apply for Leave</button>
                        <button class="btn btn-primary" onclick="refreshLeaveList()">üîÑ Refresh</button>
                        <button class="btn btn-info" onclick="showLeaveReports()">üìä Leave Reports</button>
                    </div>
                    
                    <!-- Leave Balance Summary -->
                    <div id="leaveBalanceCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="leaveSearch" placeholder="Search leave requests..." style="flex: 1; padding: 10px;">
                        <select id="leaveStatusFilter" style="padding: 10px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div id="leaveList"></div>
                </div>

                <!-- Apply Leave Modal -->
                <div id="applyLeaveModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('applyLeaveModal')">&times;</span>
                        <h2>‚ûï Apply for Leave</h2>
                        <form id="applyLeaveForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="leaveEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Leave Type</label>
                                    <select id="leaveType" required>
                                        <option value="">Select Leave Type</option>
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Maternity">Maternity Leave</option>
                                        <option value="Paternity">Paternity Leave</option>
                                        <option value="Emergency">Emergency Leave</option>
                                        <option value="Unpaid">Unpaid Leave</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Start Date</label>
                                    <input type="date" id="leaveStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">End Date</label>
                                    <input type="date" id="leaveEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Number of Days</label>
                                    <input type="number" id="leaveDays" required readonly>
                                </div>
                                <div class="form-group">
                                    <label>Reason</label>
                                    <textarea id="leaveReason" rows="4" placeholder="Reason for leave..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üì§ Submit Leave Request</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('applyLeaveModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Warnings & Disciplinary Tab -->
            <div id="warnings" class="hr-tab-content">
                <div class="form-section">
                    <h3>‚ö†Ô∏è Warnings & Disciplinary Actions</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="showIssueWarning()">‚ö†Ô∏è Issue Warning</button>
                        <button class="btn btn-primary" onclick="refreshWarningList()">üîÑ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="warningSearch" placeholder="Search warnings..." style="flex: 1; padding: 10px;">
                        <select id="warningTypeFilter" style="padding: 10px;">
                            <option value="all">All Types</option>
                            <option value="Verbal">Verbal Warning</option>
                            <option value="Written">Written Warning</option>
                            <option value="Final">Final Warning</option>
                        </select>
                    </div>
                    
                    <div id="warningList"></div>
                </div>

                <!-- Issue Warning Modal -->
                <div id="issueWarningModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('issueWarningModal')">&times;</span>
                        <h2>‚ö†Ô∏è Issue Warning</h2>
                        <form id="issueWarningForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="warningEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Warning Type</label>
                                    <select id="warningType" required>
                                        <option value="">Select Type</option>
                                        <option value="Verbal">Verbal Warning</option>
                                        <option value="Written">Written Warning</option>
                                        <option value="Final">Final Warning</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="warningDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Issued By</label>
                                    <input type="text" id="warningIssuedBy" required placeholder="Supervisor/Manager name">
                                </div>
                                <div class="form-group full-width">
                                    <label class="required">Reason</label>
                                    <textarea id="warningReason" rows="5" required placeholder="Detailed reason for the warning..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="warningNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-warning">‚ö†Ô∏è Issue Warning</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('issueWarningModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Terminations Tab -->
            <div id="terminations" class="hr-tab-content">
                <div class="form-section">
                    <h3>üö™ Termination Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-danger" onclick="showTerminateEmployee()">üö™ Record Termination</button>
                        <button class="btn btn-primary" onclick="refreshTerminationList()">üîÑ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="terminationSearch" placeholder="Search terminations..." style="flex: 1; padding: 10px;">
                        <select id="terminationReasonFilter" style="padding: 10px;">
                            <option value="all">All Reasons</option>
                            <option value="Resignation">Resignation</option>
                            <option value="Dismissal">Dismissal</option>
                            <option value="Retirement">Retirement</option>
                            <option value="Contract End">Contract End</option>
                            <option value="Mutual Agreement">Mutual Agreement</option>
                        </select>
                    </div>
                    
                    <div id="terminationList"></div>
                </div>

                <!-- Record Termination Modal -->
                <div id="terminateEmployeeModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('terminateEmployeeModal')">&times;</span>
                        <h2>üö™ Record Termination</h2>
                        <form id="terminateEmployeeForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="terminationEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Termination Date</label>
                                    <input type="date" id="terminationDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Termination Type</label>
                                    <select id="terminationType" required>
                                        <option value="">Select Type</option>
                                        <option value="Resignation">Resignation</option>
                                        <option value="Dismissal">Dismissal</option>
                                        <option value="Retirement">Retirement</option>
                                        <option value="Contract End">Contract End</option>
                                        <option value="Mutual Agreement">Mutual Agreement</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Reason</label>
                                    <textarea id="terminationReason" rows="5" required placeholder="Reason for termination..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Notice Period (Days)</label>
                                    <input type="number" id="noticePeriod" placeholder="Number of days">
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="terminationNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-danger">üö™ Record Termination</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('terminateEmployeeModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="hr-tab-content">
                <div class="form-section">
                    <h3>üïê Attendance Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showRecordAttendance()">‚úÖ Record Attendance</button>
                        <button class="btn btn-primary" onclick="refreshAttendanceList()">üîÑ Refresh</button>
                        <button class="btn btn-info" onclick="generateAttendanceReport()">üìä Generate Report</button>
                    </div>
                    
                    <div id="attendanceSummaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="attendanceSearch" placeholder="Search attendance records..." style="flex: 1; padding: 10px;">
                        <input type="date" id="attendanceDateFilter" style="padding: 10px;">
                        <select id="attendanceStatusFilter" style="padding: 10px;">
                            <option value="all">All Status</option>
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Half Day">Half Day</option>
                        </select>
                    </div>
                    
                    <div id="attendanceList"></div>
                </div>

                <!-- Record Attendance Modal -->
                <div id="recordAttendanceModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('recordAttendanceModal')">&times;</span>
                        <h2>‚úÖ Record Attendance</h2>
                        <form id="recordAttendanceForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="attendanceEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="attendanceDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Status</label>
                                    <select id="attendanceStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="Present">Present</option>
                                        <option value="Absent">Absent</option>
                                        <option value="Late">Late</option>
                                        <option value="Half Day">Half Day</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Check In Time</label>
                                    <input type="time" id="checkInTime">
                                </div>
                                <div class="form-group">
                                    <label>Check Out Time</label>
                                    <input type="time" id="checkOutTime">
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="attendanceNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">‚úÖ Record Attendance</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('recordAttendanceModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Performance Review Tab -->
            <div id="performance" class="hr-tab-content">
                <div class="form-section">
                    <h3>üìä Performance Review</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddPerformanceReview()">‚ûï Add Performance Review</button>
                        <button class="btn btn-primary" onclick="refreshPerformanceList()">üîÑ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="performanceSearch" placeholder="Search performance reviews..." style="flex: 1; padding: 10px;">
                    </div>
                    
                    <div id="performanceList"></div>
                </div>

                <!-- Add Performance Review Modal -->
                <div id="addPerformanceReviewModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('addPerformanceReviewModal')">&times;</span>
                        <h2>üìä Add Performance Review</h2>
                        <form id="addPerformanceReviewForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="performanceEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Review Period Start</label>
                                    <input type="date" id="reviewStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Review Period End</label>
                                    <input type="date" id="reviewEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Reviewed By</label>
                                    <input type="text" id="reviewedBy" required placeholder="Reviewer name">
                                </div>
                                <div class="form-group full-width">
                                    <label class="required">Overall Rating</label>
                                    <select id="overallRating" required>
                                        <option value="">Select Rating</option>
                                        <option value="Excellent">Excellent</option>
                                        <option value="Good">Good</option>
                                        <option value="Average">Average</option>
                                        <option value="Below Average">Below Average</option>
                                        <option value="Unsatisfactory">Unsatisfactory</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label>Strengths</label>
                                    <textarea id="strengths" rows="4" placeholder="Employee strengths..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Areas for Improvement</label>
                                    <textarea id="improvements" rows="4" placeholder="Areas for improvement..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Goals for Next Period</label>
                                    <textarea id="goals" rows="4" placeholder="Goals for next review period..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Comments</label>
                                    <textarea id="reviewComments" rows="4" placeholder="Additional comments..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üíæ Save Review</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addPerformanceReviewModal')">‚ùå Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="hr-communication" class="hr-tab-content">
                <div class="form-section">
                    <h3>üí¨ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Send HR updates to branch staff and review their replies.</p>
                    <div id="portalCommunicationList-hr" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'hr')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-hr">Message</label>
                            <textarea id="portalCommunicationMessage-hr" rows="4" placeholder="Share policy changes, approvals or notices..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('hr')">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Data Collection Tab -->
            <div id="data-collection" class="hr-tab-content">
                <div class="form-section">
                    <h3>üìã Staff Data Collection Form</h3>
                    <form id="dataCollectionForm" onsubmit="submitDataCollection(event)">
                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Personal Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Full Name</label>
                                    <input type="text" id="dcFullName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">ID / Passport No.</label>
                                    <input type="text" id="dcIdNumber" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date of Birth</label>
                                    <input type="date" id="dcDob" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Nationality</label>
                                    <input type="text" id="dcNationality" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Gender</label>
                                    <select id="dcGender" required>
                                        <option value="">Select</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Marital Status</label>
                                    <select id="dcMaritalStatus" required>
                                        <option value="">Select</option>
                                        <option>Single</option>
                                        <option>Married</option>
                                        <option>Divorced</option>
                                        <option>Widowed</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Contact & Address Details</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Mobile Number</label>
                                    <input type="tel" id="dcMobile" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Email Address</label>
                                    <input type="email" id="dcEmail" required>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Residential Address</label>
                                    <textarea id="dcResAddress" rows="3" required></textarea>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Postal Address</label>
                                    <textarea id="dcPostAddress" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Educational Background</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Highest Level of Education</label>
                                    <input type="text" id="dcEducation" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Institution Attended</label>
                                    <input type="text" id="dcInstitution" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Year Completed</label>
                                    <input type="number" id="dcYearCompleted" min="1950" max="2050" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Employment Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Branch / DPC Name</label>
                                    <select id="dcBranch" required>
                                        <option value="">Select</option>
                                        <option>townshop</option>
                                        <option>khomasdal</option>
                                        <option>swakopmund</option>
                                        <option>walvisbay</option>
                                        <option>katima</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Employment Start Date</label>
                                    <input type="date" id="dcStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Social Security No.</label>
                                    <input type="text" id="dcSocialSecurity" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Position Appointed</label>
                                    <input type="text" id="dcPosition" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Banking Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Bank Name</label>
                                    <input type="text" id="dcBankName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Account Number</label>
                                    <input type="text" id="dcAccountNumber" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Branch Code</label>
                                    <input type="text" id="dcBranchCode" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Emergency Contact Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Next of Kin Name</label>
                                    <input type="text" id="dcNextOfKin" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Relationship</label>
                                    <input type="text" id="dcRelationship" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Contact Number</label>
                                    <input type="tel" id="dcKinContact" required>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Address</label>
                                    <textarea id="dcKinAddress" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Medical & Background Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Height (cm)</label>
                                    <input type="number" id="dcHeight" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Weight (kg)</label>
                                    <input type="number" id="dcWeight" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label>Chronic Illnesses / Conditions</label>
                                    <input type="text" id="dcChronicIllness">
                                </div>
                                <div class="form-group">
                                    <label>Disabilities (if any)</label>
                                    <input type="text" id="dcDisabilities">
                                </div>
                                <div class="form-group">
                                    <label class="required">Criminal Record</label>
                                    <div style="display:flex; gap:16px; margin-top:8px;">
                                        <label style="display:flex; align-items:center; gap:6px;">
                                            <input type="radio" name="dcCriminal" value="yes" id="dcCriminalYes"> Yes
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px;">
                                            <input type="radio" name="dcCriminal" value="no" id="dcCriminalNo" checked> No
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>If yes, please specify</label>
                                    <input type="text" id="dcCriminalSpecify">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Allergies / Other Medical Notes</label>
                                    <textarea id="dcAllergies" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Declaration & Signature</h4>
                            <div style="margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px;">
                                <p style="margin:0; line-height:1.6;">I confirm that the information provided above is true, complete, and accurate to the best of my knowledge. I authorize Dynapharm Namibia to verify all submitted information where necessary.</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee Signature</label>
                                    <input type="text" id="dcEmpSignature" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">HR Officer / Manager</label>
                                    <input type="text" id="dcHROfficer" required>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb; color:#64748b; font-size:12px; text-align:center;">
                            All information is confidential and handled in accordance with the Social Security Act (Act 34 of 1994).
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">Submit Data Collection</button>
                            <button type="button" class="btn" onclick="clearDataCollectionForm()">Clear Form</button>
                        </div>
                    </form>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>Submitted Forms</h3>
                    <div id="dcTable"><div style="color:#64748b;">Loading...</div></div>
                </div>
            </div>
        </div>

        <!-- GM Portal -->
        <div id="gm" class="tab-content">
            <div id="gmAuth" style="display: block;">
                <div class="portal-header">
                    <h2>üëî GM Portal</h2>
                    <p>General Manager Dashboard - Country Overview & Approvals</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access GM portal</p>
                    <button class="btn" onclick="showLogin('gm')">üîê Login</button>
                </div>
            </div>
            <div id="gmContent" style="display: none;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                    <button id="gmMainTabBtn" class="btn btn-primary" onclick="toggleGMView('main')" style="min-width: 170px;">üìä GM Dashboard</button>
                    <button id="gmStaffTabBtn" class="btn" onclick="toggleGMView('staff')" style="min-width: 170px;">üë§ Staff Services</button>
                </div>

                <div id="gmMainSection">
                    <div class="user-profile" id="gmProfile"></div>
                    
                    <div class="portal-header">
                    <h2>üëî GM Portal - Country Overview</h2>
                    <p>Monitor KPIs, Approve Special Sales, Oversee Operations</p>
                    <button class="btn btn-primary" onclick="refreshGMData()">üîÑ Refresh Data</button>
                    <button class="btn" onclick="exportSectionToPDF('gmContent')">üñ®Ô∏è Export PDF</button>
                    <a class="btn" href="gm-portal-integration.html" target="_blank" rel="noopener" style="margin-left: 10px;">üìä Open GM Business Portal</a>
                    <button class="btn btn-info" onclick="openAnalyticsReportingPortal()" style="margin-left: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">üìà Analytics & Reporting Portal</button>
                    <button class="btn btn-success" onclick="openScheduleModal('gm')" style="margin-left: 10px;">‚è±Ô∏è Schedule Report</button>
                </div>

                <div class="form-section" style="margin-top: 25px;">
                    <div style="display:flex; justify-content: space-between; align-items:flex-start; gap:15px; flex-wrap:wrap;">
                        <div>
                            <h3 style="margin:0;">üíº Finance Oversight</h3>
                            <p style="margin:4px 0 0; color:#64748b; font-size:0.95rem;">
                                Automatically generated from finance records (deposits, bonuses, expenses). Keep executive visibility over branch cash flow.
                            </p>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-info" onclick="showGMBonusHistoryModal()">‚¨áÔ∏è Download Bonus History</button>
                            <button class="btn btn-primary" onclick="refreshGMFinancialReportSection()">üîÅ Refresh Finance Report</button>
                        </div>
                    </div>
                    <div id="gmFinancialReportSummary" style="margin-top:18px;"></div>
                </div>

                <div class="form-section">
                    <h3>üí¨ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Share announcements with branch staff and keep their responses visible to the GM office.</p>
                    <div id="portalCommunicationList-gm" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'gm')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-gm">Message</label>
                            <textarea id="portalCommunicationMessage-gm" rows="4" placeholder="Inform staff about directives, meetings or approvals..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('gm')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <!-- KPI Dashboard -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üí∞</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Revenue</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmTotalRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üì¶</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">CIF Deposits</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmCIFDeposits">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">‚≠ê</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total BV Points</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmTotalBV">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üìä</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Gross Margin</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmGrossMargin">N$ 0.00</div>
                    </div>
                </div>
                
                <!-- Comprehensive Approval System -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>‚è≥ Approval Center</h3>
                        <button class="btn btn-primary" onclick="refreshAllApprovals()">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Approval Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchApprovalTab('all')" id="approvalTabAll">All Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('cash')" id="approvalTabCash">üíµ Cash Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('leave')" id="approvalTabLeave">üìÖ Leave Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('stock')" id="approvalTabStock">üì¶ Stock Movements</button>
                        <button class="tab-button" onclick="switchApprovalTab('other')" id="approvalTabOther">Other Requests</button>
                    </div>
                    
                    <!-- Approval Content -->
                    <div id="approvalContent" style="min-height: 400px;">
                        <div id="allApprovalsList" class="approval-tab-content active"></div>
                        <div id="cashApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="leaveApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="stockApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="otherApprovalsList" class="approval-tab-content" style="display: none;"></div>
                    </div>
                    
                    <script>
                        // update global alert banner with count, if available after GM load
                        (function(){
                            try {
                                const count = window.gmPendingApprovalsCount || 0;
                                if (typeof window.updateGlobalAlerts === 'function') {
                                    window.updateGlobalAlerts({ pendingApprovalsCount: count });
                                }
                            } catch(_){}
                        })();
                    </script>
                </div>
                
                <!-- Campaigns Management -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üéØ Campaigns Management</h3>
                        <button class="btn btn-success" onclick="showCreateCampaignModal()">‚ûï Create Campaign</button>
                    </div>
                    
                    <!-- Campaign Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchCampaignTab('all')" id="campaignTabAll">All Campaigns</button>
                        <button class="tab-button" onclick="switchCampaignTab('sales')" id="campaignTabSales">üí∞ Sales Discounts</button>
                        <button class="tab-button" onclick="switchCampaignTab('recruiting')" id="campaignTabRecruiting">üë• Recruiting</button>
                        <button class="tab-button" onclick="switchCampaignTab('sponsoring')" id="campaignTabSponsoring">ü§ù Sponsoring</button>
                        <button class="tab-button" onclick="switchCampaignTab('gift')" id="campaignTabGift">üéÅ Gift Campaigns</button>
                    </div>
                    
                    <!-- Campaign Content -->
                    <div id="campaignContent" style="min-height: 400px;">
                        <div id="allCampaignsList" class="campaign-tab-content active"></div>
                        <div id="salesCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="recruitingCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="sponsoringCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="giftCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                    </div>
                </div>

                <!-- Inventory Oversight & Management -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üì¶ Inventory Oversight & Management</h3>
                        <button class="btn btn-primary" onclick="refreshGMInventoryData()">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Inventory Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchGMInventoryTab('overview')" id="gmInvTabOverview">üìä Overview</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('expected')" id="gmInvTabExpected">üì• Expected Stock</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('losses')" id="gmInvTabLosses">‚ö†Ô∏è Stock Losses</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('manipulations')" id="gmInvTabManipulations">üîç Manipulations Audit</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('approvals')" id="gmInvTabApprovals">‚úÖ Pending Approvals</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('allbranches')" id="gmInvTabAllBranches">üè¨ All Branches</button>
                    </div>
                    
                    <!-- Inventory Content -->
                    <div id="gmInventoryContent" style="min-height: 400px;">
                        <!-- Overview Tab -->
                        <div id="gmInvOverview" class="gm-inv-tab-content active">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Stock Value (All Branches)</div>
                                    <div id="gmTotalStockValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Pending Expected Stock Requests</div>
                                    <div id="gmPendingExpectedStock" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Stock Losses (This Month)</div>
                                    <div id="gmStockLosses" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Pending Adjustments</div>
                                    <div id="gmPendingAdjustments" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                                </div>
                            </div>
                            <div id="gmInventoryOverviewTable" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="margin-top: 0;">Branch Inventory Summary</h4>
                                <div id="gmBranchInventorySummary"></div>
                            </div>
                        </div>
                        
                        <!-- Expected Stock Tab -->
                        <div id="gmInvExpected" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Expected Stock Requests Requiring Approval</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="gmExpectedBranchFilter" onchange="loadGMExpectedStock()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <select id="gmExpectedStatusFilter" onchange="loadGMExpectedStock()" style="padding: 8px;">
                                            <option value="pending">Pending Approval</option>
                                            <option value="all">All Status</option>
                                            <option value="approved">Approved</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmExpectedStockList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Stock Losses Tab -->
                        <div id="gmInvLosses" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Stock Losses & Discrepancies</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="date" id="gmLossesDateFrom" onchange="loadGMStockLosses()" style="padding: 8px;">
                                        <input type="date" id="gmLossesDateTo" onchange="loadGMStockLosses()" style="padding: 8px;">
                                        <select id="gmLossesBranchFilter" onchange="loadGMStockLosses()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmStockLossesList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Manipulations Audit Tab -->
                        <div id="gmInvManipulations" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Stock Manipulation Audit Trail</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="gmManipSearch" placeholder="Search by user, product, branch..." 
                                               onkeyup="loadGMStockManipulations()" style="padding: 8px; min-width: 250px;">
                                        <select id="gmManipBranchFilter" onchange="loadGMStockManipulations()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <select id="gmManipTypeFilter" onchange="loadGMStockManipulations()" style="padding: 8px;">
                                            <option value="all">All Types</option>
                                            <option value="adjustment">Adjustments</option>
                                            <option value="loss">Losses</option>
                                            <option value="transfer">Transfers</option>
                                            <option value="receive">Receipts</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmStockManipulationsList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Pending Approvals Tab -->
                        <div id="gmInvApprovals" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Pending Inventory Approvals</h4>
                                    <button class="btn btn-success" onclick="loadGMPendingInventoryApprovals()">üîÑ Refresh</button>
                                </div>
                                <div id="gmApprovalAlerts" style="display: none; margin-bottom: 15px;"></div>
                                <div id="gmPendingInventoryApprovalsList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- All Branches Tab -->
                        <div id="gmInvAllBranches" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">All Branch Inventory (Full Access)</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="gmAllBranchesBranchFilter" onchange="loadGMAllBranchInventory()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <button class="btn btn-info" onclick="exportGMInventoryReport()">üì• Export Report</button>
                                    </div>
                                </div>
                                <div id="gmAllBranchInventoryList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Special Sales Management (Legacy) -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üéØ Special Sales Campaigns (Legacy)</h3>
                    <button class="btn btn-success" onclick="showSpecialSalesModal()">‚ûï Create Campaign</button>
                    <div id="specialSalesList" style="margin-top: 20px;"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üì¶ Branch Inventory Breakdown</h3>
                    <div id="gmInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                </div>
                </div>

                <div id="gmStaffSection" style="display: none;">
                    <div class="form-section">
                        <h3>üë§ GM Staff Services</h3>
                        <p style="color:#64748b; margin-bottom:18px;">Submit executive leave or cash requests directly from the GM portal.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                                <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                                <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Plan personal leave while keeping leadership informed.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffLeaveRequest('gm')">Request Leave</button>
                                    <button class="btn btn-info" onclick="viewMyLeaveRequests('gm')">My Requests</button>
                                </div>
                                <div id="staffLeaveStatus-gm" style="margin-top:15px;"></div>
                            </div>
                            <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                                <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                                <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request executive cash advances or reimbursements.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffCashRequest('gm')">Request Cash</button>
                                    <button class="btn btn-info" onclick="viewMyCashRequests('gm')">My Requests</button>
                                </div>
                                <div id="staffCashStatus-gm" style="margin-top:15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Director Portal -->
        <div id="director" class="tab-content">
            <div id="directorAuth" style="display: block;">
                <div class="portal-header">
                    <h2>üéØ Director Portal</h2>
                    <p>Executive Dashboard - Strategic KPIs & Oversight</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access Director portal</p>
                    <button class="btn" onclick="showLogin('director')">üîê Login</button>
                </div>
            </div>
            <div id="directorContent" style="display: none;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                    <button id="directorMainTabBtn" class="btn btn-primary" onclick="toggleDirectorView('main')" style="min-width: 170px;">üè¢ Executive Dashboard</button>
                    <button id="directorStaffTabBtn" class="btn" onclick="toggleDirectorView('staff')" style="min-width: 170px;">üë§ Staff Services</button>
                </div>

                <div id="directorMainSection">
                    <div class="user-profile" id="directorProfile"></div>
                    
                    <div class="portal-header">
                    <h2>üéØ Director Portal - Executive Overview</h2>
                    <p>Monitor Revenue, CIF, BV, Margin, and Stock Management</p>
                    <button class="btn btn-primary" onclick="refreshDirectorData()">üîÑ Refresh Data</button>
                    <button class="btn" onclick="exportSectionToPDF('directorContent')">üñ®Ô∏è Export PDF</button>
                    <button class="btn btn-success" onclick="openScheduleModal('director')" style="margin-left: 10px;">‚è±Ô∏è Schedule Report</button>
                </div>

                <div class="form-section">
                    <h3>üí¨ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Coordinate strategic directives with staff and log their feedback.</p>
                    <div id="portalCommunicationList-director" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'director')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-director">Message</label>
                            <textarea id="portalCommunicationMessage-director" rows="4" placeholder="Share strategic updates, policy changes or acknowledgements..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('director')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <!-- Executive KPIs -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üí∞</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Revenue</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üè¶</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">CIF</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorCIF">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">‚≠ê</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">BV</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorBV">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üìä</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Margin</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorMargin">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üí∏</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Remittance</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorRemittance">N$ 0.00</div>
                    </div>
                </div>
                
                <!-- Stock Depletion Dashboard -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>üì¶ Stock Depletion Overview</h3>
                    <div id="stockDepletionDashboard"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>üì¶ Branch Inventory Breakdown</h3>
                    <div id="directorInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                </div>
                </div>

                <div id="directorStaffSection" style="display: none;">
                    <div class="form-section">
                        <h3>üë§ Director Staff Services</h3>
                        <p style="color:#64748b; margin-bottom:18px;">Submit executive leave or cash requests directly from the director portal.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                            <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                                <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                                <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Plan executive leave while keeping approvals in sync.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffLeaveRequest('director')">Request Leave</button>
                                    <button class="btn btn-info" onclick="viewMyLeaveRequests('director')">My Requests</button>
                                </div>
                                <div id="staffLeaveStatus-director" style="margin-top:15px;"></div>
                            </div>
                            <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                                <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                                <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request executive reimbursements or cash advances.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffCashRequest('director')">Request Cash</button>
                                    <button class="btn btn-info" onclick="viewMyCashRequests('director')">My Requests</button>
                                </div>
                                <div id="staffCashStatus-director" style="margin-top:15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Portal -->
        <div id="admin" class="tab-content">
            <h2>Admin Portal</h2>
            <div id="adminAuth">
                <p>Please login to access admin portal</p>
                <button class="btn" onclick="showLogin('admin')">Login</button>
            </div>
            <div id="adminContent" style="display: none;">
                <div class="form-section">
                    <h3>User Management</h3>
                    <button class="btn btn-success" onclick="showAddUser()">Add User</button>
                    <button class="btn btn-warning" onclick="showChangePassword()">Change Password</button>
                    <button class="btn btn-primary" onclick="refreshAllData()">üîÑ Refresh Data</button>
                    <div id="userList"></div>
                </div>
                
                <div class="form-section">
                    <h3>üíæ Data Management</h3>
                    <button class="btn btn-primary" onclick="exportData()">üì• Export All Data</button>
                    <button class="btn btn-success" onclick="importData()">üì§ Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleFileImport(event)">
                    <div id="dataStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
                </div>
                
                <div class="form-section">
                    <h3>üîß System Maintenance</h3>
                    <button class="btn btn-info" onclick="updateExistingReportsPricing()">üí∞ Fix Package Pricing</button>
                    <button class="btn btn-info" onclick="fixExistingClientNBNumbers()">üÜî Fix NB Numbers</button>
                    <button class="btn btn-success" onclick="runSystemMaintenance()">üîß Run All Fixes</button>
                    <div style="margin-top: 15px; font-size: 0.85rem; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <p><strong>System Maintenance Tools:</strong></p>
                        <p>‚Ä¢ <strong>Fix Package Pricing:</strong> Updates existing reports with correct package pricing and component selection</p>
                        <p>‚Ä¢ <strong>Fix NB Numbers:</strong> Converts old NB number formats to new "NB" format</p>
                        <p>‚Ä¢ <strong>Run All Fixes:</strong> Executes both fixes in sequence</p>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Branch Management</h3>
                    <input type="text" id="newBranchName" placeholder="Branch name" style="padding: 10px; margin-right: 10px;">
                    <button class="btn btn-success" onclick="addBranch()">Add Branch</button>
                    <div id="branchList"></div>
                </div>
                
                <div class="form-section">
                    <h3>üë• Distributor Management</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4>üì§ Upload Distributor Data</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                            Upload CSV or Excel (.xlsx, .xls) files with distributor information.<br>
                            <strong>Supported formats:</strong> CSV (Comma Separated Values) or Excel (.xlsx, .xls)<br>
                            <strong style="color: #c41e3a;">Required columns:</strong> DRN, NAME (DRN contains NB numbers for purchases)<br>
                            <strong>Example format:</strong> DRN[tab]NAME or DRN,NAME<br>
                            <em>Note: Only DRN and NAME are required. Other columns are optional.</em>
                        </p>
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 5px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>üíæ Storage:</strong> <span id="storageInfo">Loading...</span></span>
                            <button onclick="clearAllDistributors()" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.8rem;">üóëÔ∏è Clear All</button>
                        </div>
                        <input type="file" id="distributorFile" accept=".csv,.xlsx,.xls" style="padding: 8px; margin-right: 10px;">
                        <button class="btn btn-success" onclick="uploadDistributorFile()">üì§ Upload CSV/Excel File</button>
                        <div id="distributorUploadStatus" style="margin-top: 10px;"></div>
                    </div>
                    <div class="search-box">
                        <input type="text" id="distributorSearch" placeholder="Search distributors..." onkeyup="searchDistributors()" style="flex: 1;">
                        <button class="btn btn-success" onclick="showAllDistributors()">üìã Show All</button>
                        <button class="btn btn-warning" onclick="exportDistributors()">üì• Export Data</button>
                        <button class="btn btn-danger" onclick="clearAllDistributors()">üóëÔ∏è Clear All</button>
                    </div>
                    <div id="distributorList" style="margin-top: 15px; max-height: 500px; overflow-y: auto;"></div>
                    <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 10px; color: #2c3e50;">üîê Distributor Password Reset</h4>
                        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">
                            Search for a distributor and set a temporary password while they are on the phone. The distributor will be prompted to change it on their next login.
                        </p>
                        <div class="form-grid" style="gap: 15px;">
                            <div class="form-group">
                                <label class="required">Distributor</label>
                                <input list="adminDistributorResetOptions" id="adminDistributorResetInput" placeholder="Start typing distributor code or name" oninput="handleDistributorResetInput(this.value)" autocomplete="off">
                                <datalist id="adminDistributorResetOptions"></datalist>
                                <small id="adminDistributorResetInfo" style="display: block; margin-top: 8px; color: #64748b;">Begin typing to search the central distributor directory.</small>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label class="required">New Password</label>
                                <input type="password" id="adminDistributorResetPassword" placeholder="Enter new password (min 8 characters)" autocomplete="new-password">
                                <button type="button" class="btn" onclick="generateDistributorResetPassword()" style="position: absolute; top: 32px; right: 10px; font-size: 0.75rem; padding: 5px 10px;">üé≤ Generate</button>
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="submitDistributorPasswordReset()">‚úÖ Reset Password</button>
                            <button class="btn btn-secondary" onclick="loadAdminDistributorDirectory(true)" type="button">üîÑ Refresh Directory</button>
                            <button class="btn btn-light" type="button" onclick="clearDistributorResetForm()">üßπ Clear</button>
                        </div>
                        <div id="adminDistributorResetStatus" style="margin-top: 12px; font-size: 0.9rem;"></div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üì∏ Product Photo Management</h3>
                    <p style="margin-bottom: 15px; color: #666;">Upload and manage product photos for the online shop</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Upload Product Photo</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Select Product</label>
                                <select id="photoProductSelect" required style="padding: 10px; width: 100%;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Product Photos</label>
                                <input type="file" id="productPhotoInput" accept="image/*" multiple style="padding: 10px; width: 100%;" onchange="previewProductPhoto(event)">
                                <small style="color: #666;">Supported formats: JPG, PNG, WebP (Max 5MB per file). You can select up to 4 photos at once.</small>
                            </div>
                        </div>
                        <div id="photoPreview" style="margin-top: 15px; text-align: center;"></div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="uploadProductPhoto()">üì§ Upload Photos</button>
                            <button class="btn btn-warning" onclick="clearPhotoForm()">Clear</button>
                        </div>
                        <div id="photoUploadStatus" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Product Photos Gallery</h4>
                        <div class="search-box">
                            <input type="text" id="photoSearch" placeholder="Search products..." style="flex: 1;" onkeyup="filterProductPhotos()">
                            <button class="btn btn-success" onclick="loadProductPhotos()">üîÑ Refresh</button>
                            <button class="btn btn-primary" onclick="startDownloadProductImages()" id="downloadImagesBtn">‚¨áÔ∏è Download All Images</button>
                        </div>
                        <div id="downloadProgress" style="margin-top: 15px; display: none;">
                            <div style="background: #f0f0f0; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span id="downloadStatus">Starting download...</span>
                                    <span id="downloadStats">0/0</span>
                                </div>
                                <div style="background: #ddd; border-radius: 3px; height: 20px; overflow: hidden;">
                                    <div id="downloadProgressBar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div id="downloadLog" style="max-height: 200px; overflow-y: auto; font-size: 12px; color: #666;"></div>
                        </div>
                        <div id="productPhotosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading product photos...</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üì¶ Inventory Management</h3>
                    <div class="search-box">
                        <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="searchInventory()">
                        <button class="btn btn-success" onclick="showAllInventory()">üìã Show All</button>
                        <button class="btn btn-warning" onclick="showLowStockItems()">‚ö†Ô∏è Low Stock Alert</button>
                        <button class="btn btn-primary" onclick="printInventoryReport()">üñ®Ô∏è Print Report</button>
                    </div>
                    <div id="inventoryList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- CRM Portal -->
        <div id="crm" class="tab-content">
            <h2>üë• Client Relationship Management (CRM)</h2>
            
            <!-- CRM Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-button active" onclick="showCRMTab('communication')">üí¨ Communication History</button>
                <button class="tab-button" onclick="showCRMTab('segmentation')">üìä Client Segmentation</button>
                <button class="tab-button" onclick="showCRMTab('workflows')">‚öôÔ∏è Automated Workflows</button>
                <button class="tab-button" onclick="showCRMTab('loyalty')">üéÅ Loyalty Program</button>
            </div>

            <!-- Communication History Tab -->
            <div id="crm-communication" class="crm-subtab active">
                <div class="form-section">
                    <h3>üí¨ Client Communication History</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="crmClientSelect" onchange="loadClientCommunication()" style="padding: 10px; min-width: 250px;">
                            <option value="">Select Client...</option>
                        </select>
                        <button class="btn btn-success" onclick="addClientInteraction()">‚ûï Add Interaction</button>
                        <button class="btn btn-info" onclick="refreshCRMCommunication()">üîÑ Refresh</button>
                        <button class="btn" onclick="exportClientHistory()">üì• Export</button>
                    </div>
                    
                    <!-- Client Overview -->
                    <div id="crmClientOverview" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 id="crmClientName"></h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <strong>Total Interactions:</strong> <span id="crmTotalInteractions">0</span>
                            </div>
                            <div>
                                <strong>Last Contact:</strong> <span id="crmLastContact">Never</span>
                            </div>
                            <div>
                                <strong>Purchase History:</strong> <span id="crmPurchaseCount">0</span> purchases
                            </div>
                            <div>
                                <strong>Total Spent:</strong> <span id="crmTotalSpent">N$ 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Interaction Timeline -->
                    <div id="crmInteractionTimeline" style="max-height: 600px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">Select a client to view communication history</p>
                    </div>
                </div>
            </div>

            <!-- Client Segmentation Tab -->
            <div id="crm-segmentation" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>üìä Client Segmentation</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="refreshSegmentation()">üîÑ Refresh Analysis</button>
                        <button class="btn" onclick="exportSegmentationReport()">üì• Export Report</button>
                    </div>

                    <!-- Segmentation Dashboard -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">‚≠ê VIP Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="vipClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Clients spending N$ 10,000+</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">‚ö†Ô∏è At-Risk Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="atRiskClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">No purchase in 90+ days</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">üîÑ Active Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="activeClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Purchased in last 30 days</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">üÜï New Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="newClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Registered in last 30 days</p>
                        </div>
                    </div>

                    <!-- Client Lists by Segment -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <div class="form-section">
                            <h4>‚≠ê VIP Clients</h4>
                            <div id="vipClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>‚ö†Ô∏è At-Risk Clients</h4>
                            <div id="atRiskClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>üîÑ Active Clients</h4>
                            <div id="activeClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>üìà Purchase Behavior Analysis</h4>
                            <div id="purchaseBehaviorAnalysis" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Automated Workflows Tab -->
            <div id="crm-workflows" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>‚öôÔ∏è Automated Workflows</h3>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="createWorkflow()">‚ûï Create Workflow</button>
                        <button class="btn btn-info" onclick="refreshWorkflows()">üîÑ Refresh</button>
                    </div>

                    <!-- Active Workflows -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-section" style="background: #e8f5e9;">
                            <h4>üìß Welcome Emails</h4>
                            <div id="welcomeEmailStats">
                                <p>Sent today: <strong id="welcomeEmailsToday">0</strong></p>
                                <p>Total sent: <strong id="welcomeEmailsTotal">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureWelcomeEmails()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #fff3e0;">
                            <h4>üéÇ Birthday Greetings</h4>
                            <div id="birthdayStats">
                                <p>Today's birthdays: <strong id="birthdaysToday">0</strong></p>
                                <p>Sent today: <strong id="birthdayGreetingsToday">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureBirthdayGreetings()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #e3f2fd;">
                            <h4>üîÑ Reorder Reminders</h4>
                            <div id="reorderStats">
                                <p>Reminders sent today: <strong id="reorderRemindersToday">0</strong></p>
                                <p>Total active: <strong id="activeReminders">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureReorderReminders()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #fce4ec;">
                            <h4>üìÖ Follow-up Scheduling</h4>
                            <div id="followupStats">
                                <p>Scheduled today: <strong id="followupsToday">0</strong></p>
                                <p>Pending: <strong id="pendingFollowups">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureFollowups()">Configure</button>
                        </div>
                    </div>

                    <!-- Workflow Log -->
                    <div class="form-section">
                        <h4>üìã Workflow Execution Log</h4>
                        <div id="workflowLog" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <p style="text-align: center; color: #7f8c8d;">No workflow executions yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loyalty Program Tab -->
            <div id="crm-loyalty" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>üéÅ Loyalty Program</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showLoyaltyConfig()">‚öôÔ∏è Configure Program</button>
                        <button class="btn btn-info" onclick="refreshLoyaltyData()">üîÑ Refresh</button>
                        <button class="btn" onclick="viewLoyaltyReport()">üìä Reports</button>
                    </div>

                    <!-- Loyalty Tiers -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #cd7f32;">
                            <h4>ü•â Bronze</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #cd7f32;" id="bronzeCount">0</div>
                            <p>0 - N$ 2,499</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #c0c0c0;">
                            <h4>ü•à Silver</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #c0c0c0;" id="silverCount">0</div>
                            <p>N$ 2,500 - N$ 9,999</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #ffd700;">
                            <h4>ü•á Gold</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffd700;" id="goldCount">0</div>
                            <p>N$ 10,000 - N$ 24,999</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #b9f2ff;">
                            <h4>üíé Platinum</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #b9f2ff;" id="platinumCount">0</div>
                            <p>N$ 25,000+</p>
                        </div>
                    </div>

                    <!-- Loyalty Members -->
                    <div class="form-section">
                        <h4>üéÅ Loyalty Program Members</h4>
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="loyaltySearch" placeholder="Search members..." onkeyup="filterLoyaltyMembers()" style="padding: 10px; width: 300px;">
                        </div>
                        <div id="loyaltyMembersList" style="max-height: 500px; overflow-y: auto;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading loyalty members...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finance Portal -->
        <div id="finance" class="tab-content">
            <h2>üí∞ Finance Portal</h2>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                <button id="financeMainTabBtn" class="btn btn-primary" onclick="toggleFinanceView('main')" style="min-width: 180px;">üìä Finance Dashboard</button>
                <button id="financeStaffTabBtn" class="btn" onclick="toggleFinanceView('staff')" style="min-width: 180px;">üë§ Staff Services</button>
            </div>

            <div id="financeMainSection">
            
            <!-- Branch Selector -->
            <div class="form-section" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Select Branch:</label>
                <select id="financeBranchSelect" onchange="refreshFinancialDashboard()" style="padding: 10px; width: 300px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="all">All Branches</option>
                </select>
            </div>

            <div class="form-section">
                <h3>üí¨ Staff Communication Tab</h3>
                <p class="portal-communication-note">Notify staff about finance approvals and review cash office responses.</p>
                <div id="portalCommunicationList-finance" class="communication-list"></div>
                <form class="communication-form" onsubmit="submitPortalCommunication(event, 'finance')">
                    <div class="form-group">
                        <label class="required" for="portalCommunicationMessage-finance">Message</label>
                        <textarea id="portalCommunicationMessage-finance" rows="4" placeholder="Share finance notices, approvals or reminders..." required></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-success">Send to Staff</button>
                        <button type="button" class="btn" onclick="clearPortalCommunication('finance')">Clear</button>
                    </div>
                </form>
            </div>
            
            <!-- Live Per-Branch Metrics Dashboard -->
            <div class="form-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: white; border-bottom: 2px solid white; margin: 0;">üìä Live Financial Metrics (Today)</h3>
                    <select id="financeComparisonPeriod" onchange="refreshFinancialDashboard()" style="padding: 8px 12px; border: 2px solid white; border-radius: 6px; background: rgba(255,255,255,0.2); color: white;">
                        <option value="none">No Comparison</option>
                        <option value="yesterday">vs Yesterday</option>
                        <option value="lastWeek">vs Last Week</option>
                        <option value="lastMonth">vs Last Month</option>
                    </select>
                </div>
                
                <!-- Top Level Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Total Sales</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyTotalSales">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Cash: <span id="dailyCashSales">N$ 0.00</span> | Card: <span id="dailyCardSales">N$ 0.00</span></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash at Hand</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="cashAtHand">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Expected vs Counted</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Bank Deposits</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyDeposits">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Today's Deposits</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash Expenses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyCashExpenses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Approved Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash Bonuses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyBonuses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Paid Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Bank Bonuses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyBankBonuses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Paid Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Variance</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="variance">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;" id="varianceStatus">Status: OK</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Branch Stock (Items)</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="financeBranchStockQty">0</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Low: <span id="financeBranchLowStock">0</span></div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="refreshFinancialDashboard()" style="background: white; color: #667eea;">üîÑ Refresh</button>
                    <button class="btn btn-primary" onclick="showShiftManager()" style="background: white; color: #667eea;">üïê Shift Manager</button>
                    <button class="btn" onclick="showRecordPaymentModal()" style="background: white; color: #667eea;">üí≥ Record Payment</button>
                    <button class="btn" onclick="showBankDeposit()" style="background: white; color: #667eea; display: inline-flex; align-items: center; gap: 6px;">
                        üí∞ Bank Deposit
                        <span id="depositPendingPill" class="deposit-pending-pill">0</span>
                    </button>
                    <button class="btn" onclick="showCashBonus()" style="background: white; color: #667eea;">üéÅ Cash Bonus</button>
                    <button class="btn" onclick="showBankBonus()" style="background: white; color: #667eea;">üè¶ Bank Bonus</button>
                    <button class="btn" onclick="showBonusUpload()" style="background: white; color: #667eea;">üì§ Bonus Upload</button>
                    <button class="btn" onclick="generateZReport()" style="background: white; color: #667eea;">üìä Z-Report</button>
                    <button class="btn" onclick="exportFinancialData()" style="background: white; color: #667eea;">üì• Export</button>
                </div>
            </div>

            <!-- Bank Deposit Slip Inbox -->
            <div class="form-section" id="bankDepositInbox">
                <h3>üì• Bank Deposit Slip Inbox</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">Centralise bank deposit slips sent from branches. Review supporting files, approve compliant deposits, or request corrections immediately.</p>
                <div class="deposit-inbox-summary">
                    <span class="badge" id="depositPendingBadge">Pending: 0</span>
                    <span class="badge" id="depositApprovedBadge">Approved: 0</span>
                    <span class="badge" id="depositRejectedBadge">Rejected: 0</span>
                    <button type="button" class="btn btn-info" style="padding: 10px 16px;" onclick="refreshDepositInbox()">üîÑ Refresh Inbox</button>
                </div>
                <div class="deposit-inbox-tabs" role="tablist" aria-label="Bank deposit slip review">
                    <button type="button" class="deposit-inbox-tab active" data-scope="pending" aria-selected="true">
                        <span>Pending Review</span>
                        <span class="deposit-inbox-count" id="depositTabCount-pending">0</span>
                    </button>
                    <button type="button" class="deposit-inbox-tab" data-scope="reviewed" aria-selected="false">
                        <span>Reviewed History</span>
                        <span class="deposit-inbox-count" id="depositTabCount-reviewed">0</span>
                    </button>
                </div>
                <div class="deposit-inbox-pane active" data-scope="pending">
                    <div id="depositList-pending" style="display: flex; flex-direction: column; gap: 12px;"></div>
                </div>
                <div class="deposit-inbox-pane" data-scope="reviewed">
                    <div id="depositList-reviewed" style="display: flex; flex-direction: column; gap: 12px;"></div>
                </div>
            </div>

            <!-- Bonus Workflow Section -->
            <div class="form-section" id="bonusUploadSection" style="display: none;">
                <style>
                    #bonusUploadSection .bonus-workflow-tabs {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                        margin-bottom: 15px;
                    }
                    #bonusUploadSection .bonus-workflow-tab {
                        border: 2px solid #e3e7ee;
                        background: #f7f9fc;
                        color: #334e68;
                        padding: 10px 16px;
                        border-radius: 999px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    }
                    #bonusUploadSection .bonus-workflow-tab:hover {
                        background: #eef2ff;
                        border-color: #cfd6ff;
                    }
                    #bonusUploadSection .bonus-workflow-tab.active {
                        background: #667eea;
                        color: #fff;
                        border-color: #667eea;
                        box-shadow: 0 6px 14px rgba(102, 126, 234, 0.2);
                    }
                    #bonusUploadSection .bonus-workflow-pane {
                        display: none;
                        gap: 16px;
                        flex-direction: column;
                    }
                    #bonusUploadSection .bonus-workflow-pane.active {
                        display: flex;
                    }
                    #bonusUploadSection .bonus-inline-controls {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 12px;
                        align-items: flex-end;
                    }
                    #bonusUploadSection .bonus-inline-controls label {
                        display: block;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                        color: #7f8c8d;
                        margin-bottom: 4px;
                    }
                    #bonusUploadSection .bonus-inline-controls input,
                    #bonusUploadSection .bonus-inline-controls select,
                    #bonusUploadSection .bonus-inline-controls textarea {
                        padding: 10px 12px;
                        border: 2px solid #e3e7ee;
                        border-radius: 8px;
                        background: #fff;
                        min-width: 200px;
                    }
                    #bonusUploadSection .bonus-inline-controls textarea {
                        min-height: 72px;
                        resize: vertical;
                    }
                    #bonusUploadSection .bonus-pane-actions {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    #bonusUploadSection .bonus-pane-description {
                        font-size: 13px;
                        color: #54748b;
                        background: #f2f5f9;
                        border-radius: 8px;
                        padding: 12px 16px;
                        line-height: 1.5;
                    }
                </style>

                <div style="display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div>
                        <h3>üì§ Bonus Workflow</h3>
                        <p style="color: #7f8c8d; max-width: 560px;">Centralise the entire bonus lifecycle: upload distributor CSVs, route them for approval, export bank batches, and reconcile payouts without leaving this screen.</p>
                    </div>
                    <div id="bonusUploadSummary" style="min-width: 240px; background: #f7f9fc; border: 2px solid #e3e7ee; border-radius: 12px; padding: 12px 16px; color: #334e68;">
                        <strong>Workflow status</strong>
                        <p style="margin: 6px 0 0; font-size: 12px; color: #7f8c8d;">Select a month to begin.</p>
                    </div>
                </div>

                <div class="bonus-workflow-tabs" role="tablist" aria-label="Bonus workflow steps">
                    <button type="button" class="bonus-workflow-tab active" data-bonus-tab="upload" aria-selected="true" onclick="setBonusWorkflowTab('upload')">üì§ Upload</button>
                    <button type="button" class="bonus-workflow-tab" data-bonus-tab="approval" aria-selected="false" onclick="setBonusWorkflowTab('approval')">‚úÖ Approval</button>
                    <button type="button" class="bonus-workflow-tab" data-bonus-tab="export" aria-selected="false" onclick="setBonusWorkflowTab('export')">üè¶ Bank Export</button>
                    <button type="button" class="bonus-workflow-tab" data-bonus-tab="reconciliation" aria-selected="false" onclick="setBonusWorkflowTab('reconciliation')">üßæ Reconciliation</button>
                </div>

                <div class="bonus-workflow-pane active" data-bonus-pane="upload">
                    <div class="bonus-pane-description">
                        Upload the official bonus CSV provided by Finance. Preview totals before publishing so branches see the exact values that will be paid.
                    </div>
                    <div class="bonus-inline-controls">
                        <div>
                            <label for="bonusUploadMonth">Month</label>
                            <input id="bonusUploadMonth" type="month">
                        </div>
                        <div>
                            <label for="bonusUploadFile">Bonus CSV File</label>
                            <input id="bonusUploadFile" type="file" accept=".csv">
                        </div>
                        <div>
                            <label for="bonusUploadBranchFilter">Filter by Area</label>
                            <select id="bonusUploadBranchFilter">
                        <option value="">All Branches</option>
                        <option>NB1</option>
                        <option>NB2</option>
                        <option>NB3</option>
                        <option>NB4</option>
                    </select>
                        </div>
                    </div>
                    <div class="bonus-pane-actions">
                    <button class="btn btn-primary" id="bonusUploadBtn" onclick="uploadBonusCsv()" disabled>Upload Monthly Bonus</button>
                    <button class="btn btn-ghost" onclick="clearBonusUpload()">Clear</button>
                    <button class="btn btn-secondary" onclick="downloadBonusTemplate()">Download Template</button>
                </div>
                    <div id="bonusUploadTotals" class="totals" style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px;"></div>
                <div class="scroll-x" id="bonusUploadTableWrap" style="overflow: auto; border: 1px solid #e3e7ee; border-radius: 8px; display: none; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 920px;">
                        <thead>
                            <tr>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">#</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">DRN</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Name</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Stockist</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Area</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">NAD</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Signature</th>
                            </tr>
                        </thead>
                        <tbody id="bonusUploadBody"></tbody>
                    </table>
                </div>
                <div style="padding: 16px 0; color: #6b7c93; font-size: 13px;">
                        Monthly bonus upload saved to <span style="background: #eef2f7; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #334e68;">/api/bonus</span>. Distributors not included in this CSV for the selected month cannot be paid.
                </div>
            </div>

                <div class="bonus-workflow-pane" data-bonus-pane="approval">
                    <div class="bonus-pane-description">
                        Once the preview looks good, submit the file for approval. Rejections capture context for branches or head office to action.
                    </div>
                    <div class="bonus-inline-controls">
                        <div style="flex: 1; min-width: 220px;">
                            <label for="bonusApprovalMonthDisplay">Selected Month</label>
                            <input type="text" id="bonusApprovalMonthDisplay" readonly style="background: #eef2f7; cursor: not-allowed;">
                        </div>
                        <div style="flex: 1; min-width: 320px;">
                            <label for="bonusRejectionReason">Rejection Reason (optional)</label>
                            <textarea id="bonusRejectionReason" rows="2" placeholder="Capture feedback for finance or branches..."></textarea>
                        </div>
                    </div>
                    <div id="bonusApprovalSummary" class="bonus-pane-description" style="background: #fff7e6; color: #7c5000;">
                        Pick a month to load approval history.
                    </div>
                    <div class="bonus-pane-actions">
                        <button class="btn btn-success" id="approveBonusUploadBtn" onclick="approveBonusUpload()">Approve Upload</button>
                        <button class="btn btn-danger" id="rejectBonusUploadBtn" onclick="rejectBonusUpload()">Reject Upload</button>
                        <button class="btn" onclick="refreshBonusWorkflowSummary()">üîÑ Refresh Status</button>
                    </div>
                </div>

                <div class="bonus-workflow-pane" data-bonus-pane="export">
                    <div class="bonus-pane-description">
                        Generate the artefacts required for payment once the month is approved. Files are stamped with the selected month for easy filing.
                    </div>
                    <div id="bonusExportSummary" class="bonus-pane-description" style="background: #e6f4ff; color: #0b5394;">
                        Exports unlock after approval.
                    </div>
                    <div class="bonus-pane-actions">
                        <button class="btn" onclick="exportBankBatch()">üè¶ Export Bank Batch</button>
                        <button class="btn" onclick="exportPain001()">üìÑ Export PAIN.001</button>
                        <button class="btn" onclick="exportCashSheet()">üíµ Export Cash Sheet</button>
                    </div>
                </div>

                <div class="bonus-workflow-pane" data-bonus-pane="reconciliation">
                    <div class="bonus-pane-description">
                        Reconcile approved uploads against actual payouts. Approve variances so finance can close the month with confidence.
                    </div>
                    <div id="bonusReconciliationSummary" class="bonus-pane-description" style="background: #f2f5f9; color: #334e68;">
                        Run a reconciliation after exports are processed.
                    </div>
                    <div id="financeReconciliation" class="form-section" style="display: none;">
                <h3>üßæ Monthly Reconciliation</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <input id="reconMonth" type="month" style="padding: 10px 12px; border: 2px solid #e3e7ee; border-radius: 8px; background: #fff;" />
                    <button class="btn btn-info" onclick="loadReconciliation()">üîÑ Refresh</button>
                </div>
                <div id="reconSummary" style="margin-bottom: 10px; color: #334e68;"></div>
                <div class="scroll-x" style="max-height: 420px; overflow: auto; border: 1px solid #e3e7ee; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                        <thead>
                            <tr>
                                <th style="padding: 10px; background: #f2f5f9;">DRN</th>
                                <th style="padding: 10px; background: #f2f5f9;">Name</th>
                                <th style="padding: 10px; background: #f2f5f9;">Uploaded NAD</th>
                                <th style="padding: 10px; background: #f2f5f9;">Paid NAD</th>
                                <th style="padding: 10px; background: #f2f5f9;">Method</th>
                                <th style="padding: 10px; background: #f2f5f9;">Status</th>
                                <th style="padding: 10px; background: #f2f5f9;">Variance</th>
                            </tr>
                        </thead>
                        <tbody id="reconBody"></tbody>
                    </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Requests (Approvals) -->
            <div class="form-section">
                <h3>üë§ Staff Requests - Cash Approval</h3>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="displayFinanceCashRequests()">üîÑ Refresh</button>
                </div>
                <div id="financeCashRequests" class="scroll-x" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No cash requests yet.</p>
                </div>
            </div>

            <div class="form-section">
                <h3>üì¶ Branch Inventory Breakdown</h3>
                <div id="financeInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
            </div>

            <!-- Expense Management -->
            <div class="form-section">
                <h3>üí∏ Expense Management</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddExpenseModal()">‚ûï Add Expense</button>
                    <button class="btn btn-info" onclick="refreshExpenses()">üîÑ Refresh</button>
                    <button class="btn btn-warning" onclick="showExpenseSummary()">üìä Summary</button>
                </div>
                
                <!-- Expense Filters -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <select id="expenseCategoryFilter" onchange="filterExpenses()">
                        <option value="all">All Categories</option>
                        <optgroup label="OPERATING EXPENSES">
                            <option value="cleaning-materials">Cleaning Materials & equipment</option>
                            <option value="transportation-taxi">Transportation/Taxi fare</option>
                            <option value="fuel">Fuel</option>
                            <option value="telephone-internet">Telephone & internet</option>
                            <option value="printing-photocopy">Printing & photocopy</option>
                            <option value="meals">Meals</option>
                            <option value="car-repair">Repair & Maintenance (car)</option>
                            <option value="nampost-courier">Nampost courier services</option>
                            <option value="stationary">Stationary</option>
                            <option value="office-equipment">Office equipment</option>
                            <option value="bonus">Bonus</option>
                            <option value="fitness-certificate">Fitness certificate</option>
                            <option value="marketing-expos">Marketing/Expos/Conference halls</option>
                            <option value="bad-debts">Bad debts/Losses and Thefts</option>
                            <option value="miscellaneous">Miscellaneous</option>
                            <option value="advertisement-promotions">Advertisement & promotions</option>
                            <option value="accommodation">Accommodation</option>
                            <option value="company-stock">Stock for company use (NON CASH PRODUCTS)</option>
                            <option value="bank-charges">Bank charges</option>
                            <option value="cash-back">Cash back</option>
                            <option value="field-work">Field work</option>
                            <option value="consistency">Consistency</option>
                            <option value="payroll-processing">Payroll Processing Services</option>
                            <option value="social-security">Social Security</option>
                            <option value="payroll-taxes">Payroll Taxes</option>
                            <option value="website-development">Website development</option>
                            <option value="business-licenses">Business Licenses and permits</option>
                            <option value="labour">Labour</option>
                            <option value="carpenter-plumbing">Carpenter/Plumbing services (fixtures & fittings)</option>
                            <option value="salaries">Salaries</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="periodic-expenses">Periodic Expenses</option>
                            <option value="foreign-affairs-paperwork">Foreign affairs: paperwork</option>
                            <option value="visas">Visas</option>
                            <option value="foreign-affairs-flights">Foreign affairs: flight tickets</option>
                            <option value="gift-promotions">Gift Promotions</option>
                            <option value="management-travel">Management Travel Expenses</option>
                        </optgroup>
                        <optgroup label="VARIABLE EXPENSES">
                            <option value="water-bill">Water Bill</option>
                            <option value="electricity-bill">Electricity Bill</option>
                            <option value="security-services">Security Services</option>
                            <option value="rent">Rent</option>
                            <option value="body-corporate">Body Corporate</option>
                        </optgroup>
                        <optgroup label="INTEREST & TAXES">
                            <option value="interest-income">Interest (income)</option>
                            <option value="interest-expenses">Interest Expenses</option>
                            <option value="interest-expenses-taxes">Interest (income), expenses & Taxes</option>
                        </optgroup>
                    </select>
                    <select id="expenseMonthFilter" onchange="filterExpenses()">
                        <option value="all">All Months</option>
                    </select>
                    <input type="text" id="expenseSearch" placeholder="Search expenses..." onkeyup="filterExpenses()">
                </div>
                
                <div id="expenseList" class="scroll-x" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading expenses...</p>
                </div>
            </div>

            <!-- Revenue Tracking -->
            <div class="form-section">
                <h3>üíµ Revenue Tracking</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="refreshRevenue()">üîÑ Refresh</button>
                    <button class="btn btn-success" onclick="showRevenueBreakdown()">üìä Breakdown</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <h4>Prescription Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;" id="prescriptionRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h4>Walk-in Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2196f3;" id="walkinRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <h4>Total Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;" id="totalSales">N$ 0.00</div>
                    </div>
                </div>
                
                <div id="revenueList" class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Revenue details...</p>
                </div>
            </div>

            <!-- Budget Management -->
            <div class="form-section">
                <h3>üìà Budget Planning</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddBudgetModal()">‚ûï Create Budget</button>
                    <button class="btn btn-info" onclick="refreshBudgets()">üîÑ Refresh</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <select id="budgetMonthFilter" onchange="filterBudgets()">
                        <option value="">Select Month</option>
                    </select>
                    <select id="budgetYearFilter" onchange="filterBudgets()">
                        <option value="">Select Year</option>
                    </select>
                </div>
                
                <div id="budgetList" class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No budgets created yet</p>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="form-section">
                <h3>üìä Monthly Financial Summary</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center;">
                    <select id="summaryMonth" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <input type="number" id="summaryYear" min="2020" max="2030" value="2025" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 100px;">
                    <button class="btn btn-primary" onclick="generateMonthlySummary()">Generate Summary</button>
                    <button class="btn btn-success" onclick="exportMonthlySummaryCSV()">üì• Export CSV</button>
                    <button class="btn btn-info" onclick="printMonthlySummary()">üñ®Ô∏è Print</button>
                </div>
                <div id="monthlySummaryTable" class="scroll-x" style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Select month and year, then click 'Generate Summary'</p>
                </div>
            </div>

            <!-- Financial Reports -->
            <div class="form-section">
                <h3>üìã Financial Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <button class="btn btn-success" onclick="generateProfitLossReport()">üìä Profit & Loss</button>
                    <button class="btn btn-primary" onclick="generateCashFlowReport()">üí∏ Cash Flow Statement</button>
                    <button class="btn btn-warning" onclick="generateBudgetReport()">üìà Budget vs Actual</button>
                    <button class="btn btn-info" onclick="generateExpenseReport()">üí∏ Expense Report</button>
                </div>
                <div id="financeReportDisplay" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d;">Select a report to view</p>
                </div>
            </div>
            </div>

            <div id="financeStaffSection" style="display: none;">
                <div class="form-section">
                    <h3>üë§ Finance Team Self-Service</h3>
                    <p style="color:#64748b; margin-bottom:18px;">Finance users can request leave or cash while staying in this portal.</p>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                            <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                            <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Schedule time off and monitor approval status.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffLeaveRequest('finance')">Request Leave</button>
                                <button class="btn btn-info" onclick="viewMyLeaveRequests('finance')">My Requests</button>
                            </div>
                            <div id="staffLeaveStatus-finance" style="margin-top:15px;"></div>
                        </div>
                        <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                            <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                            <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request cash advances or reimbursements as needed.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffCashRequest('finance')">Request Cash</button>
                                <button class="btn btn-info" onclick="viewMyCashRequests('finance')">My Requests</button>
                            </div>
                            <div id="staffCashStatus-finance" style="margin-top:15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIS Portal -->
        <div id="mis" class="tab-content">
            <div id="misAuth">
                <div class="portal-header">
                    <h2>üìä MIS Portal</h2>
                    <p>Sales Receipt Management & Reporting</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access MIS portal</p>
                    <button class="btn" onclick="showLogin('mis')">üîê Login</button>
                </div>
            </div>
            <div id="misContent" style="display: none;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                    <button id="misMainTabBtn" class="btn btn-primary" onclick="toggleMISView('main')" style="min-width: 160px;">üìë MIS Dashboard</button>
                    <button id="misStaffTabBtn" class="btn" onclick="toggleMISView('staff')" style="min-width: 160px;">üë§ Staff Services</button>
                </div>

                <div id="misStaffSection" style="display: none;">
                    <div class="form-section">
                        <h3>üë§ MIS Staff Services</h3>
                        <p style="color:#64748b; margin-bottom:18px;">Leave and cash requests for MIS analysts and reporting staff.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                            <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                                <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                                <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Request leave for reporting or reconciliation teams.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffLeaveRequest('mis')">Request Leave</button>
                                    <button class="btn btn-info" onclick="viewMyLeaveRequests('mis')">My Requests</button>
                                </div>
                                <div id="staffLeaveStatus-mis" style="margin-top:15px;"></div>
                            </div>
                            <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                                <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                                <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request petty cash for audits, logistics or field checks.</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn-success" onclick="openStaffCashRequest('mis')">Request Cash</button>
                                    <button class="btn btn-info" onclick="viewMyCashRequests('mis')">My Requests</button>
                                </div>
                                <div id="staffCashStatus-mis" style="margin-top:15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="misMainSection">
                    <div class="user-profile" id="misProfile"></div>
                    
                    <div class="portal-header">
                    <h2>üìä MIS Portal - Sales Receipt Management</h2>
                    <p>View and analyze sales receipts across all branches</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="refreshAllData()">üîÑ Refresh Data</button>
                        <button class="btn btn-success" onclick="openDailyReportWindow()">üìÑ Daily Operations Report</button>
                        <button class="btn btn-info" onclick="viewDepartmentEvents()">üìß View Department Events</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üí¨ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Share MIS alerts with staff and log their confirmations or data submissions.</p>
                    <div id="portalCommunicationList-mis" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'mis')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-mis">Message</label>
                            <textarea id="portalCommunicationMessage-mis" rows="4" placeholder="Notify staff about reconciliations, missing reports or KPIs..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('mis')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                <h3>Branch & Search Filters</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Branch</label>
                        <select id="misBranchSelect" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                            <option value="all">All Branches</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Search by Name or NB Number</label>
                        <input type="text" id="misSearchInput" placeholder="Type name or NB number..." onkeyup="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>From (Date & Time)</label>
                        <input type="datetime-local" id="misDateFrom" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>To (Date & Time)</label>
                        <input type="datetime-local" id="misDateTo" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn" onclick="setMISDateToday(); return false;">üìÖ Today</button>
                        <button class="btn btn-info" onclick="clearMISDateFilters(); return false;">üßπ Clear</button>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                    <strong>üìä Summary:</strong>
                    <span id="misTotalCount" style="margin-left: 10px;">Total Records: 0</span>
                    <span id="misBranchSummary" style="margin-left: 20px;">Branch Breakdown: Loading...</span>
                    <span id="misStockSummary" style="margin-left: 20px;">Stock: Loading...</span>
                </div>
            </div>

            <div class="form-section">
                <h3>Sales Receipts List</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="exportMISData()">üì• Export to Excel</button>
                    <button class="btn btn-success" onclick="refreshMISData()">üîÑ Refresh Data</button>
                    <button class="btn btn-primary" onclick="printMISReport()">üñ®Ô∏è Print Report</button>
                </div>
                <div id="misReportsDisplay" class="scroll-x" style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                    <p style="text-align: center; color: #7f8c8d;">Loading sales receipts...</p>
                </div>
            </div>

            <div class="form-section">
                <h3>Daily Receipts Summary by Branch</h3>
                <div id="misBranchDailySummary" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                    <p style="text-align: center; color: #7f8c8d;">Branch summary will appear here.</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Walk-in Sale Modal -->
    <div class="modal" id="walkInSaleModal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('walkInSaleModal')">&times;</span>
            <h2 id="walkInSaleTitle">üõí Walk-in Sale</h2>
            
            <form id="walkInSaleForm">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="position: relative;">
                        <label>Customer Name *</label>
                        <input type="text" id="walkInCustomerName" placeholder="Full Name" required>
                        <input type="hidden" id="walkInCustomerCode">
                        <div id="customerNameDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                        <div id="distributorCustomerHelper" style="display: none; margin-top: 10px;">
                            <div style="padding: 12px; background: #f1f5f9; border: 1px solid #cbd5f5; border-radius: 6px; font-size: 0.85rem; color: #475569;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px;">
                                    <strong style="color: #1d4ed8;">Distributor quick pick</strong>
                                    <span id="distributorHelperStatus" style="font-size: 0.78rem; color: #64748b;">Loading directory...</span>
                                </div>
                                <div id="distributorQuickList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Phone Number (Optional)</label>
                        <input type="tel" id="walkInPhone" placeholder="0812345678">
                    </div>
                    <div class="form-group">
                        <label>Email Address (Optional)</label>
                        <input type="email" id="walkInEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Customer Type *</label>
                        <select id="walkInCustomerType" onchange="onCustomerTypeChange()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;" required>
                            <option value="customer">Customer</option>
                            <option value="distributor">Distributor</option>
                        </select>
                    </div>
                </div>
                
                <!-- Distributor Referral Field for Customers -->
                <div id="customerReferralField" style="display: block; margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 5px;">
                    <h4 style="margin-bottom: 10px; color: #856404;">‚ö†Ô∏è Required: Referred Distributor</h4>
                    <div id="walkInDistributorInsights" style="margin-bottom: 12px; padding: 10px 12px; background: #fff; border-radius: 6px; border: 1px dashed rgba(133,100,4,0.35); color: #5f370e; font-size: 0.85rem;">
                        Loading distributor directory...
                    </div>
                    
                    <!-- Checkbox for "I have no referral" -->
                    <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                            <input type="checkbox" id="noReferralCheckbox" onchange="handleNoReferralCheckbox()" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #856404;">I have no referral (will use Dynapharm Namibia)</span>
                        </label>
                    </div>
                                                      
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">                                                                         
                        <div class="form-group" style="position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="color: #856404;">Search by Name or NB Number *</label>
                                <button type="button" id="changeReferralBtn" onclick="clearSelectedReferral()" style="display: none; padding: 5px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Change Referral</button>
                            </div>
                            <input type="text" id="distributorReferralSearch" placeholder="Type name or NB number (e.g. OTTILIE or NB001544)"                   
                                   onkeyup="searchDistributorsForReferral()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;" required>                                                                          
                            <input type="hidden" id="distributorReferralValue" required>                                                                        
                            <div id="distributorReferralDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div> 
                        </div>
                        <div id="selectedDistributorInfo" style="display: none; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;"> 
                            <div style="font-size: 0.9rem;">
                                <strong>Selected:</strong> <span id="selectedDistributorName"></span><br>                                                       
                                <strong>NB Number:</strong> <span id="selectedDistributorCode"></span> |                                                        
                                <strong>Mobile:</strong> <span id="selectedDistributorMobile"></span>                                                           
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üì¶ Select Products</h4>
                    <div id="walkInPriceListInsights" style="margin: 0 0 12px 0; padding: 10px 12px; background: #e8f4fd; border-radius: 6px; border: 1px solid rgba(52,152,219,0.35); color: #1d4ed8; font-size: 0.85rem;">
                        Preparing product catalogue...
                    </div>
                    <div id="walkInProductsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                        <p style="text-align: center; color: #7f8c8d;">Loading products...</p>
                    </div>
                </div>
                
                <div style="border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üõí Shopping Cart</h4>
                    <div id="walkInCartList" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">Cart is empty</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #666;">
                        üí° <strong>Tip:</strong> Click quantity to edit, or click ‚ùå to remove items
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.2rem;">Total Amount:</strong>
                                <span id="walkInTotalAmount" style="font-size: 1.5rem; color: #27ae60; font-weight: bold;">N$ 0.00</span>
                            </div>
                            <div style="display: none;">
                                <strong>Tax:</strong>
                                <span id="walkInTaxAmount">N$ 0.00</span>
                            </div>
                            <div>
                                <strong>Discount:</strong>
                                <span id="walkInDiscountAmount">N$ 0.00</span>
                            </div>
                            <div>
                                <strong style="font-size: 1.1rem;">Grand Total:</strong>
                                <span id="walkInGrandTotal" style="font-size: 1.3rem; color: #c41e3a; font-weight: bold;">N$ 0.00</span>
                            </div>
                        </div>
                        <div id="walkInDualPricingNotice" style="margin-top: 10px; font-size: 0.82rem; color: #475569;">
                            Dual pricing summary will appear here.
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method Selection -->
                <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üí≥ Payment Method *</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button type="button" id="paymentMethodCash" class="payment-method-btn active" onclick="selectWalkInPaymentMethod('cash')" style="padding: 15px; border: 2px solid #27ae60; border-radius: 8px; background: #e8f5e9; cursor: pointer; font-weight: bold;">
                            üíµ Cash
                        </button>
                        <button type="button" id="paymentMethodCard" class="payment-method-btn" onclick="selectWalkInPaymentMethod('card')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            üí≥ Card
                        </button>
                        <button type="button" id="paymentMethodMobile" class="payment-method-btn" onclick="selectWalkInPaymentMethod('mobile')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            üì± Mobile Money
                        </button>
                        <button type="button" id="paymentMethodBank" class="payment-method-btn" onclick="selectWalkInPaymentMethod('bank')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            üè¶ Bank Transfer
                        </button>
                    </div>
                    <input type="hidden" id="walkInPaymentMethod" value="cash">
                <div id="walkInTenderManager" style="margin-top: 15px; padding: 15px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #92400e;">Mixed Payments (optional)</strong>
                        <span style="font-size: 0.8rem; color: #b45309;">Allocate tenders to balance totals</span>
                    </div>
                    <div id="walkInTenderRows"></div>
                    <div id="walkInTenderSummary" style="margin-top: 10px; font-size: 0.85rem; color: #475569;">No payments recorded yet.</div>
                </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('walkInSaleModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="showWalkInSaleConfirmation()" id="reviewWalkInSaleBtn">üìã Review & Confirm Sale</button>
                </div>
            </form>
        </div>
    </div>

            <div id="staff-self-service" class="hr-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>üë§ Staff Self-Service</h3>
                    <p style="color:#64748b; margin-bottom:18px;">HR team members can still submit their own leave and cash requests here.</p>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:12px; padding:20px;">
                            <h4 style="color:#2e7d32; margin-bottom:12px;">üìÖ Leave Management</h4>
                            <p style="color:#2e7d32; margin-bottom:12px; font-size:0.9rem;">Send a personal leave request for approval.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffLeaveRequest('hr')">Request Leave</button>
                                <button class="btn btn-info" onclick="viewMyLeaveRequests('hr')">My Requests</button>
                            </div>
                            <div id="staffLeaveStatus-hr" style="margin-top:15px;"></div>
                        </div>
                        <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:12px; padding:20px;">
                            <h4 style="color:#1565c0; margin-bottom:12px;">üíµ Cash Support</h4>
                            <p style="color:#1565c0; margin-bottom:12px; font-size:0.9rem;">Request HR petty cash or reimbursements.</p>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="openStaffCashRequest('hr')">Request Cash</button>
                                <button class="btn btn-info" onclick="viewMyCashRequests('hr')">My Requests</button>
                            </div>
                            <div id="staffCashStatus-hr" style="margin-top:15px;"></div>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Walk-in Sale Confirmation Modal -->
    <div class="modal" id="walkInSaleConfirmationModal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('walkInSaleConfirmationModal')">&times;</span>
            <h2>üìã Confirm Sale Details</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #2c3e50;">Customer Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <strong>Name:</strong>
                        <div id="confirmCustomerName" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Type:</strong>
                        <div id="confirmCustomerType" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Phone:</strong>
                        <div id="confirmPhone" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Email:</strong>
                        <div id="confirmEmail" style="color: #666;"></div>
                    </div>
                </div>
                <div id="confirmReferralInfo" style="display: none; padding: 10px; background: white; border-radius: 5px; margin-top: 10px;">
                    <strong>Referred By:</strong>
                    <div id="confirmReferral" style="color: #666;"></div>
                </div>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #856404;">Order Summary</h3>
                <div id="confirmProductsList" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
                <div style="border-top: 2px solid #f39c12; padding-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Subtotal:</strong>
                        <span id="confirmSubtotal" style="font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Total BV:</strong>
                        <span id="confirmTotalBV" style="color: #c41e3a; font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; padding-top: 10px; border-top: 2px solid #f39c12;">
                        <strong>Grand Total:</strong>
                        <span id="confirmGrandTotal" style="color: #c41e3a; font-weight: bold; font-size: 1.3rem;"></span>
                    </div>
                </div>
            </div>

            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #27ae60;">Payment Information</h3>
                <div>
                    <strong>Payment Method:</strong>
                    <div id="confirmPaymentMethod" style="color: #666; font-size: 1.1rem; margin-top: 5px;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn" onclick="closeModal('walkInSaleConfirmationModal')">‚Üê Back to Edit</button>
                <button type="button" class="btn btn-success" onclick="confirmWalkInSale()" style="padding: 12px 30px; font-size: 1.1rem;">
                    ‚úÖ Confirm & Process Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Media Gallery Overlay -->
    <div class="modal landing-media-modal" id="mediaGalleryOverlay" style="display: none;">
        <div class="modal-content media-gallery-content">
            <span class="close" onclick="closeMediaOverlay()">&times;</span>
            <h2 style="margin-bottom: 10px; color: #c41e3a;">üé¨ Media & News</h2>
            <p id="mediaGallerySubtitle" style="color: #64748b; margin-bottom: 20px;">Highlights, updates, and training resources from Dynapharm Namibia.</p>
            <div id="mediaGalleryGrid" class="media-gallery-grid"></div>
            <div id="mediaGalleryEmpty" class="media-gallery-empty" style="display: none;">
                <p>No media items are available yet. Check back soon!</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" aria-describedby="loginModalDescription" aria-hidden="true">
        <div class="modal-content" role="document">
            <button type="button" id="loginCloseButton" aria-label="Close login dialog" style="position:absolute;top:12px;right:12px;border:none;background:transparent;font-size:26px;line-height:1;padding:4px;border-radius:50%;cursor:pointer;">&times;</button>
            <h2 id="loginModalTitle">Portal Login</h2>
            <p id="loginModalDescription" style="margin-bottom: 20px; color: #555;">Sign in to access the selected portal.</p>
            <form id="loginForm" novalidate>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="e.g. admin" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <div class="form-group" style="display:flex; gap: 10px; align-items:center; justify-content:flex-start;">
                    <button type="submit" class="btn btn-success" id="loginSubmitButton">Login</button>
                    <button type="button" class="btn" id="loginCancelButton">Cancel</button>
                </div>
                <p id="loginError" role="alert" aria-live="polite" style="color:#c41e3a; margin-top: 10px; min-height: 1.5em; font-size: 0.9rem;"></p>
                <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">Need help? Contact the system administrator to reset your password.</p>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>Add User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <input type="text" name="fullName" placeholder="Full Name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <input type="text" name="username" placeholder="Username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <input type="password" name="password" placeholder="Password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Email Address" required autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="tel" name="phone" placeholder="Phone Number" required autocomplete="tel">
                </div>
                <div class="form-group">
                    <select name="role" required onchange="toggleAdditionalBranches(); updatePortalAccessByRole();">
                        <option value="">Select Role</option>
                        <option value="consultant">Consultant</option>
                        <option value="sales_staff">Sales Staff</option>
                        <option value="dispenser">Dispenser</option>
                        <option value="stock">Stock Manager</option>
                        <option value="admin">Admin</option>
                        <option value="finance">Finance</option>
                        <option value="hr_manager">HR Manager</option>
                        <option value="gm">General Manager</option>
                        <option value="director">Director</option>
                        <option value="mis">MIS</option>
                        <option value="branch_manager">Branch Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Branch Assignment (Optional):</label>
                    <div id="branchSelection">
                        <select name="branch" id="userBranchSelect">
                            <option value="">-- No Branch Assignment --</option>
                        </select>
                    </div>
                    <div id="additionalBranches" style="display: none; margin-top: 10px;">
                        <label><strong>Additional Branches (for Consultants & Sales Staff):</strong></label>
                        <small style="color: #666; display: block; margin-bottom: 8px;">Select additional branches this user can access. The primary branch is already included.</small>
                        <div id="branchCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        </div>
                    </div>
                    <div id="allBranchesAccess" style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="allBranches" id="allBranchesCheckbox" onchange="toggleAllBranchesAccess()">
                            <span>Access to All Branches</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Portal Access:</label>
                    <div id="portalAccessCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="client">
                            <span>Client Portal (Shop)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="frontdesk">
                            <span>Front Desk</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="consultant">
                            <span>Consultant Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="dispenser">
                            <span>Dispenser Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="hr-portal">
                            <span>HR Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="finance">
                            <span>Finance Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="gm">
                            <span>GM Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="director">
                            <span>Director Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="mis">
                            <span>MIS Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="stock">
                            <span>Stock Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="admin">
                            <span>Admin Portal</span>
                        </label>
                    </div>
                    <small style="color: #666; font-size: 0.9rem; display: block; margin-top: 5px;">Select which portals this user can access. Portal access can be customized based on role.</small>
                </div>
                <div class="form-group">
                    <label>Profile Photo (Optional)</label>
                    <input type="file" name="photo" id="userPhotoInput" accept="image/*" onchange="previewUserPhoto(event)">
                    <div id="userPhotoPreview" style="margin-top: 10px; display: none;">
                        <img id="userPhotoPreviewImg" src="" alt="Photo preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Create User</button>
                <div id="addUserStatus" style="margin-top: 12px; font-size: 0.9rem;"></div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2>Change Password</h2>
            <form id="changePasswordForm">
                <input type="text" name="username" autocomplete="username" style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;" aria-hidden="true" tabindex="-1">
                <div class="form-group">
                    <input type="password" name="currentPassword" placeholder="Current Password" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <input type="password" name="newPassword" placeholder="New Password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <input type="password" name="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-success">Change Password</button>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
            <h2>Reset User Password</h2>
            <form id="resetPasswordForm">
                <input type="hidden" name="userId" id="resetPasswordUserId">
                <div class="form-group">
                    <p><strong>User:</strong> <span id="resetPasswordFullName"></span> (<span id="resetPasswordUsername"></span>)</p>
                </div>
                <div class="form-group">
                    <input type="password" name="newPassword" placeholder="New Password" required autocomplete="new-password" minlength="3">
                </div>
                <div class="form-group">
                    <input type="password" name="confirmPassword" placeholder="Confirm New Password" required autocomplete="new-password" minlength="3">
                </div>
                <button type="submit" class="btn btn-success">Reset Password</button>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            
            <div class="prescription-form">
                <div class="prescription-header">
                    <h2>DYNAPHARM INTERNATIONAL NAMIBIA</h2>
                    <p id="branchInfo"></p>
                    <h3>Summary Analysis Report Card</h3>
            </div>

                <div class="patient-info" id="patientInfo"></div>

                <div class="form-section">
                    <h3>Presenting Symptoms</h3>
                    <div id="patientSymptoms"></div>
            </div>

                <div class="form-section">
                    <h3>Health Assessment</h3>
                    <div id="healthAssessment"></div>
                </div>

                <div class="form-section" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                    <h3 style="color: #2196f3;">ü©∫ ABOUT THE PROBLEMS OF SUB-HEALTH TRENDS</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Select the body system(s) and symptoms affecting the patient to view lifestyle recommendations:</p>
                    
                    <div id="bodySystemsSelector" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <!-- Body systems will be populated here -->
                    </div>
                    
                    <div id="lifestyleRecommendations" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #2196f3; min-height: 100px; display: none;">
                        <!-- Lifestyle recommendations will appear here -->
                    </div>
                </div>

                <div class="form-section" style="background: #e8f5e9; border-left: 5px solid #27ae60;">
                    <h3 style="color: #27ae60;">üéØ AI-Powered Product Recommendations</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Based on symptoms and health conditions, here are suggested products:</p>
                    <div id="recommendationsDisplay" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #27ae60;">
                        <p style="text-align: center; color: #7f8c8d; font-style: italic;">Analyzing patient data...</p>
                    </div>
                    <button type="button" class="btn btn-success" onclick="applyRecommendations()" style="margin-top: 15px; width: 100%;">
                        ‚úÖ Apply All Recommended Products
                    </button>
                </div>

                <div class="form-section">
                    <h3>Consultant's Notes & Diagnosis</h3>
                    <textarea id="consultantNotes" rows="5" style="width: 100%;" placeholder="Enter diagnosis and treatment notes..." oninput="updateNotesDisplay()"></textarea>
                    <div id="notesDisplay" class="notes-display"></div>
                </div>

                <div class="form-section">
                    <h3>Follow-up Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <label for="followUpDate">Recommended Follow-up Date:</label>
                            <input type="date" id="followUpDate" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div>
                            <label for="followUpNotes">Follow-up Notes (Optional):</label>
                            <input type="text" id="followUpNotes" placeholder="e.g., Review progress, adjust dosage..." style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Prescription & Medicine Selection</h3>
                    <div class="medicine-grid" id="medicineGrid"></div>
                    <div id="prescriptionDisplay" class="prescription-display"></div>
                </div>

            <div class="form-group">
                <label>Upload PDF (Optional)</label>
                <input type="file" id="pdfUpload" accept=".pdf" onchange="handlePDF(event)">
                <p id="pdfStatus"></p>
            </div>

                <div class="consultant-footer">
                    <div class="consultant-info">
                        <div class="signature-section">
                            <h4>Consultant Signature</h4>
                            <div class="signature-line"></div>
                            <p id="consultantSignatureName">${currentUser ? currentUser.fullName : 'Consultant Name'}</p>
                            <div class="contact-info" id="consultantContactInfo">
                                <p>Tel: 061-300877</p>
                                <p>Email: info@dynapharm.com.na</p>
                            </div>
                        </div>
                        <div class="follow-up-section">
                            <h4>Follow-up Date</h4>
                            <div class="follow-up-date" id="followUpDateDisplay">________________</div>
                            <p>Next appointment recommended</p>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div id="autosaveStatus" style="display: none; padding: 8px 15px; background: #fff; border-radius: 5px; color: #666; font-size: 0.9rem;">
                        <span style="color: #27ae60;">‚úì</span> Draft saved at <span id="autosaveTime"></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveReport()">üíæ Save Report</button>
                        <button class="btn btn-primary" onclick="finalizeReport()">‚úÖ Finalize & E-Sign</button>
                        <button class="btn btn-warning" onclick="printReport()">üñ®Ô∏è Print</button>
                        <button class="btn" onclick="exportReportPDF()">üìÑ Export PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Template Modal -->
    <div class="modal" id="reportTemplateModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('reportTemplateModal')">&times;</span>
            <h2>üìã Select Report Template</h2>
            <p style="margin-bottom: 20px; color: #666;">Choose a template to quickly fill in common consultation details</p>
            
            <div id="templateList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                <!-- Templates will be populated by JavaScript -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="closeModal('reportTemplateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit User Branches Modal -->
    <div class="modal" id="editBranchesModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editBranchesModal')">&times;</span>
            <h2>Edit User Branches</h2>
            <div id="editUserInfo" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            </div>
            <form id="editBranchesForm">
                <div class="form-group">
                    <label>Primary Branch:</label>
                    <select name="primaryBranch" id="editPrimaryBranch" required>
                        <option value="">Select Primary Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Branches (for Consultants):</label>
                    <div id="editBranchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Branches</button>
            </form>
        </div>
    </div>

    <!-- Daily Statement Modal -->
    <div class="modal" id="dailyStatementModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('dailyStatementModal')">&times;</span>
            <h2 style="text-align: center; color: #c41e3a; margin-bottom: 10px;">üìä Daily Statement Preview</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                Review today's activity, then print or simply close to view only
            </p>
            
            <div id="dailyStatementContent" style="background: white; padding: 20px; border-radius: 8px; max-height: 60vh; overflow-y: auto;">
                <!-- Content will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 2px solid #ddd; background: #f8f9fa; border-radius: 8px;">
                <p style="margin-bottom: 15px; color: #666; font-weight: 500;">Choose an action:</p>
                <button class="btn btn-success" onclick="printDailyStatementA4()" style="margin-right: 10px;">üñ®Ô∏è Print A4 / PDF</button>
                <button class="btn btn-warning" onclick="printDailyStatementThermal()" style="margin-right: 10px;">üßæ Thermal Receipt</button>
                <button class="btn btn-secondary" onclick="closeModal('dailyStatementModal')">üëÅÔ∏è View Only (Close)</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addExpenseModal')">&times;</span>
            <h2>üí∏ Add Expense</h2>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label>Expense Category *</label>
                    <select id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <optgroup label="OPERATING EXPENSES">
                            <option value="cleaning-materials">Cleaning Materials & equipment</option>
                            <option value="transportation-taxi">Transportation/Taxi fare</option>
                            <option value="fuel">Fuel</option>
                            <option value="telephone-internet">Telephone & internet</option>
                            <option value="printing-photocopy">Printing & photocopy</option>
                            <option value="meals">Meals</option>
                            <option value="car-repair">Repair & Maintenance (car)</option>
                            <option value="nampost-courier">Nampost courier services</option>
                            <option value="stationary">Stationary</option>
                            <option value="office-equipment">Office equipment</option>
                            <option value="bonus">Bonus</option>
                            <option value="fitness-certificate">Fitness certificate</option>
                            <option value="marketing-expos">Marketing/Expos/Conference halls</option>
                            <option value="bad-debts">Bad debts/Losses and Thefts</option>
                            <option value="miscellaneous">Miscellaneous</option>
                            <option value="advertisement-promotions">Advertisement & promotions</option>
                            <option value="accommodation">Accommodation</option>
                            <option value="company-stock">Stock for company use (NON CASH PRODUCTS)</option>
                            <option value="bank-charges">Bank charges</option>
                            <option value="cash-back">Cash back</option>
                            <option value="field-work">Field work</option>
                            <option value="consistency">Consistency</option>
                            <option value="payroll-processing">Payroll Processing Services</option>
                            <option value="social-security">Social Security</option>
                            <option value="payroll-taxes">Payroll Taxes</option>
                            <option value="website-development">Website development</option>
                            <option value="business-licenses">Business Licenses and permits</option>
                            <option value="labour">Labour</option>
                            <option value="carpenter-plumbing">Carpenter/Plumbing services (fixtures & fittings)</option>
                            <option value="salaries">Salaries</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="periodic-expenses">Periodic Expenses</option>
                            <option value="foreign-affairs-paperwork">Foreign affairs: paperwork</option>
                            <option value="visas">Visas</option>
                            <option value="foreign-affairs-flights">Foreign affairs: flight tickets</option>
                            <option value="gift-promotions">Gift Promotions</option>
                            <option value="management-travel">Management Travel Expenses</option>
                        </optgroup>
                        <optgroup label="VARIABLE EXPENSES">
                            <option value="water-bill">Water Bill</option>
                            <option value="electricity-bill">Electricity Bill</option>
                            <option value="security-services">Security Services</option>
                            <option value="rent">Rent</option>
                            <option value="body-corporate">Body Corporate</option>
                        </optgroup>
                        <optgroup label="INTEREST & TAXES">
                            <option value="interest-income">Interest (income)</option>
                            <option value="interest-expenses">Interest Expenses</option>
                            <option value="interest-expenses-taxes">Interest (income), expenses & Taxes</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Monthly rent payment" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="expensePaymentMethod">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="expenseNotes" rows="3" placeholder="Additional details..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üíæ Save Expense</button>
                    <button type="button" class="btn" onclick="closeModal('addExpenseModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div class="modal" id="addBudgetModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBudgetModal')">&times;</span>
            <h2>üìà Create Budget</h2>
            <form id="addBudgetForm">
                <div class="form-group">
                    <label>Budget Period *</label>
                    <select id="budgetPeriod" required>
                        <option value="">Select Period</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Month *</label>
                    <select id="budgetMonth" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year *</label>
                    <input type="number" id="budgetYear" min="2024" max="2030" value="2024" required>
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select id="budgetCategory" required>
                        <option value="">Select Category</option>
                        <option value="salaries">Salaries</option>
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="supplies">Supplies</option>
                        <option value="marketing">Marketing</option>
                        <option value="travel">Travel</option>
                        <option value="insurance">Insurance</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Budgeted Amount (N$) *</label>
                    <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="budgetNotes" rows="3" placeholder="Budget details..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üíæ Create Budget</button>
                    <button type="button" class="btn" onclick="closeModal('addBudgetModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Manager Modal -->
    <div class="modal" id="shiftManagerModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('shiftManagerModal')">&times;</span>
            <h2>üïê Shift Manager - Cash Tracking</h2>
            <div id="shiftContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bank Deposit Modal -->
    <div class="modal" id="bankDepositModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankDepositModal')">&times;</span>
            <h2>üí∞ Record Bank Deposit</h2>
            <form id="bankDepositForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="depositBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="depositDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="depositAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Deposit Slip Number *</label>
                    <input type="text" id="depositSlipNo" required placeholder="Bank slip reference">
                </div>
                <div class="form-group">
                    <label>Bank Name *</label>
                    <select id="depositBank" required>
                        <option value="">Select Bank</option>
                        <option value="FNB">First National Bank (FNB)</option>
                        <option value="Nedbank">Nedbank</option>
                        <option value="Bank Windhoek">Bank Windhoek</option>
                        <option value="Standard Bank">Standard Bank</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bank Branch *</label>
                    <input type="text" id="depositBankBranch" required placeholder="e.g., Windhoek Main">
                </div>
                <div class="form-group">
                    <label>Account Number *</label>
                    <input type="text" id="depositAccountNumber" required placeholder="e.g., 1234567890">
                </div>
                <div class="form-group">
                    <label>Account Type *</label>
                    <select id="depositAccountType" required>
                        <option value="">Select Type</option>
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deposited By *</label>
                    <input type="text" id="depositedBy" required placeholder="Name of person making deposit">
                </div>
                <div class="form-group">
                    <label>Upload Deposit Slip (Optional)</label>
                    <input type="file" id="depositPhoto" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="depositNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üí∞ Record Deposit</button>
                    <button type="button" class="btn" onclick="closeModal('bankDepositModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cash Bonus Modal -->
    <div class="modal" id="cashBonusModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cashBonusModal')">&times;</span>
            <h2>üéÅ Record Cash Bonus Payment</h2>
            <form id="cashBonusForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="bonusBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group" style="position: relative;">
                    <label>Distributor NB Number *</label>
                    <input type="text" id="bonusDistributorNB" required placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                           onkeyup="searchDistributorsForBonus('bonus')" autocomplete="off">
                    <div id="bonusDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                    <small id="bonusDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="bonusDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="bonusAmount" step="0.01" min="0" required onchange="checkBonusLimit()">
                </div>
                <div id="bonusLimitWarning" style="display: none; padding: 10px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 5px; margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è Warning:</strong> This bonus exceeds the branch limit or available cash. GM approval may be required.
                </div>
                <div class="form-group">
                    <label>Reason *</label>
                    <textarea id="bonusReason" rows="3" required placeholder="Reason for bonus payment..."></textarea>
                </div>
                <div class="form-group">
                    <label>Approved By *</label>
                    <input type="text" id="bonusApprovedBy" required placeholder="Manager name">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üéÅ Record Bonus</button>
                    <button type="button" class="btn" onclick="closeModal('cashBonusModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bank Bonus Modal -->
    <div class="modal" id="bankBonusModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankBonusModal')">&times;</span>
            <h2>üè¶ Record Bank Bonus Payment</h2>
            <form id="bankBonusForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="bankBonusBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group" style="position: relative;">
                    <label>Distributor NB Number *</label>
                    <input type="text" id="bankBonusDistributorNB" required placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                           onkeyup="searchDistributorsForBonus('bank')" autocomplete="off">
                    <div id="bankBonusDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                    <small id="bankBonusDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="bankBonusDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="bankBonusAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Reason *</label>
                    <textarea id="bankBonusReason" rows="3" required placeholder="Reason for bank bonus payment..."></textarea>
                </div>
                <div class="form-group">
                    <label>Approved By *</label>
                    <input type="text" id="bankBonusApprovedBy" required placeholder="Manager name">
                </div>
                <div class="form-group">
                    <label>Bank Name *</label>
                    <select id="bankBonusBank" required>
                        <option value="">Select Bank</option>
                        <option value="FNB">First National Bank (FNB)</option>
                        <option value="Nedbank">Nedbank</option>
                        <option value="Bank Windhoek">Bank Windhoek</option>
                        <option value="Standard Bank">Standard Bank</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bank Branch *</label>
                    <input type="text" id="bankBonusBankBranch" required placeholder="e.g., Windhoek Main">
                </div>
                <div class="form-group">
                    <label>Account Number *</label>
                    <input type="text" id="bankBonusAccountNumber" required placeholder="e.g., 1234567890">
                </div>
                <div class="form-group">
                    <label>Account Type *</label>
                    <select id="bankBonusAccountType" required>
                        <option value="">Select Type</option>
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üè¶ Record Bank Bonus</button>
                    <button type="button" class="btn" onclick="closeModal('bankBonusModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Z-Report Modal -->
    <div class="modal" id="zReportModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('zReportModal')">&times;</span>
            <h2>üìä Daily Z-Report</h2>
            <div id="zReportContent">
                <!-- Will be populated by JavaScript -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="printZReport()">üñ®Ô∏è Print Z-Report</button>
                <button class="btn btn-success" onclick="exportZReportCSV()">üì• Export CSV</button>
                <button class="btn" onclick="closeModal('zReportModal')">Close</button>
            </div>
        </div>

        <!-- GM Bonus History Modal -->
        <div class="modal" id="gmBonusHistoryModal">
            <div class="modal-content" style="max-width: 520px;">
                <span class="close" onclick="closeModal('gmBonusHistoryModal')">&times;</span>
                <h2>‚¨áÔ∏è Download Individual Bonus History</h2>
                <p style="color:#64748b; font-size:0.95rem; line-height:1.5;">
                    Generate a distributor-specific bonus audit trail. GM approval is required before exporting sensitive finance data.
                </p>
                <form id="gmBonusHistoryForm" onsubmit="return false;" style="display:grid; gap:15px; margin-top:20px;">
                    <div class="form-group">
                        <label class="required">Distributor NB / Name</label>
                        <input type="text" id="gmBonusHistoryNB" list="gmBonusHistoryDistributorList" placeholder="e.g. NB001234 or distributor name" autocomplete="off" required>
                        <datalist id="gmBonusHistoryDistributorList"></datalist>
                    </div>
                    <div class="form-group" style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        <div>
                            <label>Date From</label>
                            <input type="date" id="gmBonusHistoryFrom">
                        </div>
                        <div>
                            <label>Date To</label>
                            <input type="date" id="gmBonusHistoryTo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Purpose / Notes</label>
                        <textarea id="gmBonusHistoryNote" rows="2" placeholder="Document reason for GM approval (optional)"></textarea>
                    </div>
                    <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="gmBonusHistoryApproval" onchange="handleGMBonusApprovalToggle()">
                        <label for="gmBonusHistoryApproval" style="margin:0;">I confirm this export is authorised and compliant with GM policy.</label>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-success" id="gmBonusHistoryDownloadBtn" onclick="downloadGMBonusHistory()" disabled>‚¨áÔ∏è Download CSV</button>
                        <button type="button" class="btn" onclick="closeModal('gmBonusHistoryModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let users = [];
        let branches = [];
        const BRANCH_STORAGE_KEY = 'dyna_branches';
        const DISTRIBUTOR_CACHE_KEY = 'dyna_distributors_cache';
        let distributors = [];
        let distributorsLoadedAt = 0;
        let distributorsLoadInFlight = null;
        
        function getCachedBranches() {
            if (Array.isArray(branches) && branches.length > 0) {
                return branches;
            }
            try {
                const raw = localStorage.getItem(BRANCH_STORAGE_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed)) {
                        return parsed;
                    }
                }
            } catch (error) {
                console.debug('getCachedBranches: failed to read cache', error);
            }
            return [];
        }
        
        const MEDIA_LIBRARY_STORAGE_KEY = 'dyna_media_library';
        const DEFAULT_MEDIA_ITEMS = [
            {
                id: 'media-wellness-summit',
                title: 'Wellness Summit Highlights',
                summary: 'Key takeaways and announcements from the 2025 Wellness Summit.',
                category: 'Events',
                type: 'video',
                url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                thumbnailColor: '#c41e3a',
                publishedAt: '2025-06-10T08:00:00.000Z'
            },
            {
                id: 'media-product-training',
                title: 'Product Training: Immune Support',
                summary: 'Consultant-led session on immune support packages for winter.',
                category: 'Training',
                type: 'article',
                url: 'https://dynapharm.com.na/training/immune-support',
                thumbnailColor: '#2563eb',
                publishedAt: '2025-05-28T10:30:00.000Z'
            },
            {
                id: 'media-field-outreach',
                title: 'Field Outreach Success Stories',
                summary: 'Stories from the Ondangwa and Windhoek outreach programmes.',
                category: 'Community',
                type: 'article',
                url: 'https://dynapharm.com.na/blog/outreach-success',
                thumbnailColor: '#16a34a',
                publishedAt: '2025-05-15T09:00:00.000Z'
            },
            {
                id: 'media-product-launch',
                title: 'New Product Launch: Herbal Nutrition Pack',
                summary: 'Introducing the latest additions to the Herbal Nutrition range.',
                category: 'Product',
                type: 'article',
                url: 'https://dynapharm.com.na/products/herbal-nutrition-pack',
                thumbnailColor: '#7c3aed',
                publishedAt: '2025-04-30T14:00:00.000Z'
            },
            {
                id: 'media-consultant-spotlight',
                title: 'Consultant Spotlight: Maria Johannes',
                summary: 'Celebrating top-performing consultant Maria Johannes and her team.',
                category: 'People',
                type: 'video',
                url: 'https://dynapharm.com.na/news/consultant-spotlight-maria',
                thumbnailColor: '#0ea5e9',
                publishedAt: '2025-04-18T07:30:00.000Z'
            }
        ];
        let mediaLibraryCache = [];
        let mediaLibraryLoadedAt = 0;
        
        function isLandingPageActive() {
            const landingPage = document.getElementById('landingPage');
            return landingPage && landingPage.style.display !== 'none';
        }
        
        async function ensureBranchesHydrated(force = false) {
            if (!force && Array.isArray(branches) && branches.length > 0) {
                return branches;
            }
            if (typeof syncBranchesFromBackend === 'function') {
                try {
                    await syncBranchesFromBackend(force);
                } catch (error) {
                    console.debug('ensureBranchesHydrated: sync failed', error);
                }
            }
            branches = getCachedBranches();
            return branches;
        }
        
        function populateCheckupBranchSelectors(preferredValue) {
            const branchList = getCachedBranches();
            if (!Array.isArray(branchList)) return;
            const selects = [
                document.getElementById('landingCheckupBranchSelect'),
                document.getElementById('checkupBranchSelect'),
                document.getElementById('preferredBranchSelect'),
                document.getElementById('branchSelect')
            ];
            const resolvedValue = preferredValue || currentBranch || '';
            selects.forEach(select => {
                if (!select) return;
                const existingValue = select.value;
                const placeholder = select.getAttribute('data-placeholder') || select.querySelector('option')?.value || '';
                const isPreferredSelect = select.id === 'preferredBranchSelect';
                const allowBlank = !isPreferredSelect;
                const defaultOption = allowBlank ? (placeholder || '') : '';
                const label = allowBlank ? (placeholder ? 'Select Branch' : '') : '';
                select.innerHTML = allowBlank ? `<option value="${defaultOption}">${label || 'Select Branch'}</option>` : '';
                branchList.forEach(branch => {
                    if (!branch) return;
                    const option = document.createElement('option');
                    const value = branch.id || branch.branchId || branch.code || branch.name || '';
                    option.value = value;
                    option.textContent = branch.name || branch.branchName || branch.displayName || branch.code || value || 'Unnamed Branch';
                    select.appendChild(option);
                });
                const targetValue = resolvedValue && select.querySelector(`option[value="${resolvedValue}"]`) ? resolvedValue : existingValue;
                if (targetValue && select.querySelector(`option[value="${targetValue}"]`)) {
                    select.value = targetValue;
                } else if (!allowBlank && select.options.length > 0) {
                    select.value = select.options[0].value;
                }
            });
        }
        
        function generateMediaPlaceholder(title, accent = '#c41e3a') {
            const safeTitle = (title || 'Dynapharm').slice(0, 26);
            const escapedTitle = safeTitle.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='225' viewBox='0 0 400 225'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='${accent}'/><stop offset='100%' stop-color='#111827'/></linearGradient></defs><rect width='400' height='225' rx='18' fill='url(#g)'/><text x='50%' y='50%' fill='white' font-size='26' font-family='Arial, sans-serif' font-weight='600' dominant-baseline='middle' text-anchor='middle'>${escapedTitle}</text></svg>`;
            return `data:image/svg+xml,${encodeURIComponent(svg)}`;
        }
        
        function normalizeMediaItem(raw = {}, index = 0) {
            const fallback = DEFAULT_MEDIA_ITEMS[index % DEFAULT_MEDIA_ITEMS.length];
            const source = raw || fallback;
            const id = source.id || fallback.id || `media-${Date.now()}-${index}`;
            const title = source.title || fallback.title || 'Dynapharm Media';
            const summary = source.summary || source.description || fallback.summary || '';
            const category = source.category || fallback.category || 'Updates';
            const url = source.url || fallback.url || '#';
            const thumbnail = source.thumbnail || source.image || generateMediaPlaceholder(title, source.thumbnailColor || fallback.thumbnailColor || '#c41e3a');
            const type = source.type || fallback.type || 'article';
            const publishedAt = source.publishedAt || source.createdAt || fallback.publishedAt || new Date().toISOString();
            return {
                id,
                title,
                summary,
                category,
                url,
                thumbnail,
                type,
                publishedAt
            };
        }
        
        async function loadMediaLibrary(force = false) {
            if (!force && mediaLibraryCache.length > 0) {
                return mediaLibraryCache;
            }
            if (!force) {
                try {
                    const cached = localStorage.getItem(MEDIA_LIBRARY_STORAGE_KEY);
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            mediaLibraryCache = parsed.map(normalizeMediaItem);
                            mediaLibraryLoadedAt = Date.now();
                            return mediaLibraryCache;
                        }
                    }
                } catch (storageError) {
                    console.debug('loadMediaLibrary: unable to read cache', storageError);
                }
            }
            
            let fetchedItems = [];
            try {
                const response = await fetch('/api/media');
                if (response.ok) {
                    const payload = await response.json();
                    if (Array.isArray(payload)) {
                        fetchedItems = payload;
                    } else if (Array.isArray(payload?.items)) {
                        fetchedItems = payload.items;
                    }
                }
            } catch (apiError) {
                console.debug('loadMediaLibrary: API fetch failed', apiError);
            }
            
            if (!fetchedItems.length && Array.isArray(window.MEDIA_LIBRARY)) {
                fetchedItems = window.MEDIA_LIBRARY;
            }
            if (!fetchedItems.length) {
                fetchedItems = DEFAULT_MEDIA_ITEMS;
            }
            mediaLibraryCache = fetchedItems.map(normalizeMediaItem);
            mediaLibraryLoadedAt = Date.now();
            try {
                localStorage.setItem(MEDIA_LIBRARY_STORAGE_KEY, JSON.stringify(mediaLibraryCache));
            } catch (cacheError) {
                console.debug('loadMediaLibrary: unable to cache media', cacheError);
            }
            return mediaLibraryCache;
        }
        
        function detachClientRegModalToBody() {
            const modal = document.getElementById('clientRegModal');
            if (!modal) return null;
            if (!clientRegModalLandingActive) {
                if (!clientRegModalOriginalParent) {
                    clientRegModalOriginalParent = modal.parentElement;
                }
                if (!clientRegModalPlaceholder) {
                    clientRegModalPlaceholder = document.createElement('div');
                    clientRegModalPlaceholder.style.display = 'none';
                    clientRegModalPlaceholder.id = 'clientRegModalPlaceholder';
                    if (modal.parentElement) {
                        modal.parentElement.insertBefore(clientRegModalPlaceholder, modal);
                    }
                }
                document.body.appendChild(modal);
                clientRegModalLandingActive = true;
            }
            return modal;
        }
        
        function restoreClientRegModal(modal) {
            const target = modal || document.getElementById('clientRegModal');
            if (!target) return;
            if (clientRegModalLandingActive && clientRegModalOriginalParent && clientRegModalPlaceholder) {
                clientRegModalOriginalParent.insertBefore(target, clientRegModalPlaceholder);
                clientRegModalLandingActive = false;
            }
        }
        
        function softResetClientForm(mode) {
            const form = document.getElementById('clientForm');
            if (!form) return;
            form.reset();
            const signaturePad = document.getElementById('signaturePad');
            const signatureField = document.getElementById('signatureField');
            if (signatureField) signatureField.value = '';
            if (signaturePad) {
                signaturePad.innerHTML = 'Tap to sign electronically';
                signaturePad.style.background = '#fff6f8';
            }
            const memberDetails = document.getElementById('memberDetails');
            const referralDetails = document.getElementById('referralDetails');
            if (memberDetails) memberDetails.style.display = 'none';
            if (referralDetails) referralDetails.style.display = 'none';
            document.querySelectorAll('.membership-option').forEach(option => option.classList.remove('active'));
            const visitBadge = document.getElementById('visitTypeBadge');
            if (visitBadge) {
                visitBadge.textContent = '‚Äî';
            }
            const referencePreview = document.getElementById('referencePreview');
            if (referencePreview) referencePreview.textContent = 'Generated on save';
            const refNumberDisplay = document.getElementById('clientRefNumber');
            if (refNumberDisplay) refNumberDisplay.style.display = 'none';
            const landingRef = document.getElementById('landingClientRefNumber');
            if (landingRef) landingRef.style.display = 'none';
            const preferredTime = document.getElementById('preferredTime');
            if (preferredTime && !preferredTime.value) {
                preferredTime.value = '09:00';
            }
            initializeAppointmentPreferences();
            form.dataset.activeMode = mode;
        }
        
        const appointmentCalendarState = {
            year: null,
            month: null,
            selected: null
        };
        
        function initializeAppointmentPreferences(baseDate) {
            const dateInput = document.getElementById('preferredDate');
            const display = document.getElementById('preferredDateDisplay');
            const grid = document.getElementById('preferredCalendarGrid');
            const label = document.getElementById('preferredCalendarLabel');
            const prevBtn = document.getElementById('preferredPrevMonth');
            const nextBtn = document.getElementById('preferredNextMonth');
            if (!dateInput || !display || !grid || !label || !prevBtn || !nextBtn) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let initial = baseDate ? new Date(baseDate) : (dateInput.value ? new Date(dateInput.value) : new Date());
            if (Number.isNaN(initial.getTime())) {
                initial = new Date();
            }
            initial.setHours(0, 0, 0, 0);
            appointmentCalendarState.year = initial.getFullYear();
            appointmentCalendarState.month = initial.getMonth();
            appointmentCalendarState.selected = new Date(initial);
            prevBtn.onclick = () => {
                appointmentCalendarState.month -= 1;
                if (appointmentCalendarState.month < 0) {
                    appointmentCalendarState.month = 11;
                    appointmentCalendarState.year -= 1;
                }
                renderAppointmentCalendar();
            };
            nextBtn.onclick = () => {
                appointmentCalendarState.month += 1;
                if (appointmentCalendarState.month > 11) {
                    appointmentCalendarState.month = 0;
                    appointmentCalendarState.year += 1;
                }
                renderAppointmentCalendar();
            };
            renderAppointmentCalendar();
            selectAppointmentDate(initial);
        }
        
        function renderAppointmentCalendar() {
            const dateInput = document.getElementById('preferredDate');
            const display = document.getElementById('preferredDateDisplay');
            const grid = document.getElementById('preferredCalendarGrid');
            const label = document.getElementById('preferredCalendarLabel');
            if (!dateInput || !display || !grid || !label) return;
            const year = appointmentCalendarState.year ?? new Date().getFullYear();
            const month = appointmentCalendarState.month ?? new Date().getMonth();
            const selectedDate = appointmentCalendarState.selected ? new Date(appointmentCalendarState.selected) : null;
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[month]} ${year}`;
            grid.innerHTML = '';
            const startOfMonth = new Date(year, month, 1);
            const paddingDays = startOfMonth.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < paddingDays; i++) {
                const placeholder = document.createElement('button');
                placeholder.type = 'button';
                placeholder.className = 'preferred-calendar-day placeholder';
                placeholder.disabled = true;
                placeholder.style.visibility = 'hidden';
                grid.appendChild(placeholder);
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            for (let day = 1; day <= daysInMonth; day++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'preferred-calendar-day';
                btn.textContent = day;
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                if (selectedDate && currentDate.toDateString() === selectedDate.toDateString()) {
                    btn.classList.add('selected');
                }
                if (currentDate.toDateString() === today.toDateString()) {
                    btn.classList.add('today');
                }
                if (currentDate < today) {
                    btn.disabled = true;
                }
                btn.addEventListener('click', () => selectAppointmentDate(currentDate));
                grid.appendChild(btn);
            }
            if (dateInput.value) {
                const formatted = new Date(dateInput.value);
                if (!Number.isNaN(formatted.getTime())) {
                    display.textContent = formatted.toLocaleDateString(undefined, {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }
            }
        }
        
        function selectAppointmentDate(date) {
            const normalized = new Date(date);
            if (Number.isNaN(normalized.getTime())) return;
            normalized.setHours(0, 0, 0, 0);
            appointmentCalendarState.selected = normalized;
            const dateInput = document.getElementById('preferredDate');
            const display = document.getElementById('preferredDateDisplay');
            if (dateInput) {
                dateInput.value = normalized.toISOString().slice(0, 10);
            }
            if (display) {
                display.textContent = normalized.toLocaleDateString(undefined, {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            const grid = document.getElementById('preferredCalendarGrid');
            if (grid) {
                grid.querySelectorAll('.preferred-calendar-day').forEach(btn => {
                    const day = Number(btn.textContent);
                    const isSelected = !btn.disabled && !btn.classList.contains('placeholder') && day === normalized.getDate();
                    btn.classList.toggle('selected', isSelected);
                });
            }
        }
        
        async function loadMediaPreviewWidget(force = false) {
            const container = document.getElementById('mediaPreviewContent');
            if (!container) return;
            container.innerHTML = '<p style="grid-column: 1 / -1; color: rgba(255,255,255,0.85); text-align: center;">Loading highlights...</p>';
            try {
                const items = await loadMediaLibrary(force);
                if (!items.length) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; color: rgba(255,255,255,0.85); text-align: center;">Media updates will appear here soon.</p>';
                    return;
                }
                container.innerHTML = items
                    .slice(0, 6)
                    .map(item => {
                        const published = item.publishedAt ? new Date(item.publishedAt).toLocaleDateString() : '';
                        return `
                            <div class="media-preview-card" onclick="openMediaOverlay('${item.id}')">
                                <div class="media-preview-thumb" style="background-image: url('${item.thumbnail}');"></div>
                                <div class="media-preview-meta">
                                    <h4>${item.title}</h4>
                                    <p>${item.category} ‚Ä¢ ${published}</p>
                                </div>
                            </div>
                        `;
                    })
                    .join('');
            } catch (error) {
                console.error('loadMediaPreviewWidget error:', error);
                container.innerHTML = '<p style="grid-column: 1 / -1; color: rgba(255,255,255,0.85); text-align: center;">Unable to load media highlights.</p>';
            }
        }
        
        function renderMediaGallery(items, selectedId) {
            const grid = document.getElementById('mediaGalleryGrid');
            const emptyState = document.getElementById('mediaGalleryEmpty');
            if (!grid || !emptyState) return;
            if (!Array.isArray(items) || items.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';
            grid.innerHTML = items
                .map(item => {
                    const published = item.publishedAt ? new Date(item.publishedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                    return `
                        <div class="media-card" data-media-id="${item.id}">
                            <img src="${item.thumbnail}" alt="${item.title}">
                            <div class="media-card-body">
                                <span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#c41e3a;">${item.category || 'Update'}</span>
                                <h4>${item.title}</h4>
                                <p>${item.summary || ''}</p>
                            </div>
                            <div class="media-card-footer">
                                <span>${published}</span>
                                <button type="button" onclick="window.open('${item.url}', '_blank')">View</button>
                            </div>
                        </div>
                    `;
                })
                .join('');
            if (selectedId) {
                const selectedCard = grid.querySelector(`[data-media-id="${selectedId}"]`);
                if (selectedCard) {
                    selectedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        async function openMediaOverlay(mediaId) {
            const overlay = document.getElementById('mediaGalleryOverlay');
            if (!overlay) return;
            try {
                const items = await loadMediaLibrary();
                renderMediaGallery(items, mediaId);
                overlay.style.display = 'flex';
                document.body.classList.add('modal-open');
            } catch (error) {
                console.error('openMediaOverlay error:', error);
            }
        }
        
        function closeMediaOverlay() {
            const overlay = document.getElementById('mediaGalleryOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            document.body.classList.remove('modal-open');
        }
        
        async function openClientReg(mode = 'appointment', options = {}) {
            const normalizedMode = (mode || 'appointment').toString().toLowerCase() === 'walkin' ? 'walkin' : 'appointment';
            const isLandingContext = options?.landing !== undefined ? !!options.landing : isLandingPageActive();
            const modal = isLandingContext ? detachClientRegModalToBody() : document.getElementById('clientRegModal');
            if (!modal) return;
            if (!isLandingContext) {
                restoreClientRegModal(modal);
            }
            const form = document.getElementById('clientForm');
            if (!form) {
                modal.style.display = 'flex';
                return;
            }
            const previousMode = form.dataset.activeMode;
            const shouldReset = options?.reset !== false && previousMode !== normalizedMode;
            if (shouldReset) {
                softResetClientForm(normalizedMode);
            }
            const branchList = await ensureBranchesHydrated(options?.forceBranchRefresh);
            const landingBranchSelect = document.getElementById('landingCheckupBranchSelect');
            let selectedBranch = options?.branch || (landingBranchSelect && landingBranchSelect.value) || currentBranch;
            if (!selectedBranch && Array.isArray(branchList) && branchList.length > 0) {
                const firstBranch = branchList[0];
                selectedBranch = firstBranch.id || firstBranch.branchId || firstBranch.code || firstBranch.name;
            }
            populateCheckupBranchSelectors(selectedBranch);
            if (selectedBranch) {
                currentBranch = selectedBranch;
            }
            const visitInput = document.getElementById('visitType');
            if (visitInput) {
                visitInput.value = normalizedMode;
            }
            form.dataset.activeMode = normalizedMode;
            modal.classList.toggle('mode-appointment', normalizedMode === 'appointment');
            modal.classList.toggle('mode-walkin', normalizedMode === 'walkin');
            const appointmentSection = modal.querySelector('.appointment-preferences');
            const preferredTime = document.getElementById('preferredTime');
            if (normalizedMode === 'walkin') {
                if (appointmentSection) appointmentSection.style.display = 'none';
                if (preferredTime) preferredTime.required = false;
            } else {
                if (appointmentSection) appointmentSection.style.display = 'block';
                if (preferredTime) preferredTime.required = true;
                initializeAppointmentPreferences();
            }
            const badge = document.getElementById('visitTypeBadge');
            if (badge) {
                badge.textContent = normalizedMode === 'walkin' ? 'Walk-in Visit' : 'Scheduled Appointment';
            }
            modal.style.display = 'flex';
            setTimeout(() => {
                const focusTarget = form.querySelector('input[name="fullName"]');
                if (focusTarget) focusTarget.focus();
            }, 120);
        }
        
        function openMediaTab(mediaId) {
            showLandingPage();
            showLandingTab('shop');
            loadMediaPreviewWidget().catch(() => {});
            openMediaOverlay(mediaId);
        }
        
        window.openClientReg = openClientReg;
        window.openMediaTab = openMediaTab;
        window.openMediaOverlay = openMediaOverlay;
        window.closeMediaOverlay = closeMediaOverlay;
        window.loadMediaPreviewWidget = loadMediaPreviewWidget;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadMediaPreviewWidget().catch(() => {});
        });
        
        function normalizeDistributorRecord(raw) {
            if (!raw) return null;
            const id = raw.id || raw.distributor_id || raw.uuid || raw.code || raw.distributor_code || `DIST-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
            const code = (raw.distributor_code || raw.distributorCode || raw.code || '').toString().trim().toUpperCase();
            const name = raw.distributor_name || raw.distributorName || raw.name || '';
            const phone = raw.mobile_no || raw.mobile || raw.phone || raw.telephone || null;
            const email = raw.email || raw.mail || null;
            return {
                id,
                distributorCode: code || id,
                distributorName: name || code || 'Distributor',
                mobileNo: phone,
                email,
                status: raw.status || 'active',
                branch: raw.branch || raw.branch_id || raw.branchId || null,
                metadata: raw.metadata || null,
                agreementData: raw.agreement_data || raw.agreementData || null,
            };
        }
        
        function readCachedDistributors() {
            try {
                const candidates = [
                    localStorage.getItem(DISTRIBUTOR_CACHE_KEY),
                    localStorage.getItem('dyna_distributors'),
                    localStorage.getItem('dyna_distributors_cache'),
                ];
                for (const candidate of candidates) {
                    if (!candidate) continue;
                    const parsed = JSON.parse(candidate);
                    const list = Array.isArray(parsed) ? parsed : parsed?.data;
                    if (Array.isArray(list) && list.length > 0) {
                        return list.map(normalizeDistributorRecord).filter(Boolean);
                    }
                }
            } catch (error) {
                console.debug('readCachedDistributors: failed', error);
            }
            return [];
        }
        
        function persistDistributorsToCache(list) {
            try {
                localStorage.setItem(DISTRIBUTOR_CACHE_KEY, JSON.stringify(list));
            } catch (error) {
                console.debug('persistDistributorsToCache: failed', error);
            }
        }
        
        function filterDistributorsByQuery(list, query) {
            const needle = query.toUpperCase();
            return list.filter((record) => {
                if (!record) return false;
                const code = (record.distributorCode || '').toUpperCase();
                const name = (record.distributorName || '').toUpperCase();
                const phone = (record.mobileNo || '').toUpperCase();
                return code.includes(needle) || name.includes(needle) || phone.includes(needle);
            });
        }
        
        async function loadDistributors(options = {}) {
            const { skipBackend = false, forceRefresh = false, search = '' } = options || {};
            const now = Date.now();
            if (!forceRefresh && distributors.length > 0 && !skipBackend && now - distributorsLoadedAt < 30000) {
                return distributors;
            }
            if (distributorsLoadInFlight && !forceRefresh) {
                try {
                    return await distributorsLoadInFlight;
                } catch (_) {
                    /* ignore */
                }
            }
            distributorsLoadInFlight = (async () => {
                let list = [];
                if (!skipBackend) {
                    try {
                        const params = new URLSearchParams();
                        if (forceRefresh) params.set('ts', String(Date.now()));
                        if (search) params.set('search', search);
                        const url = params.toString() ? `/api/distributors?${params}` : '/api/distributors';
                        const response = await fetch(url, { credentials: 'include' });
                        if (response.ok) {
                            const payload = await response.json();
                            const rawList = Array.isArray(payload) ? payload : payload?.distributors;
                            if (Array.isArray(rawList)) {
                                list = rawList.map(normalizeDistributorRecord).filter(Boolean);
                            }
                        } else {
                            console.debug('loadDistributors: backend responded with', response.status);
                        }
                    } catch (error) {
                        console.debug('loadDistributors: backend unavailable', error);
                    }
                }
                if (!list.length) {
                    list = readCachedDistributors();
                }
                distributors = list;
                distributorsLoadedAt = Date.now();
                window.distributors = distributors;
                persistDistributorsToCache(distributors);
                return distributors;
            })();
            try {
                return await distributorsLoadInFlight;
            } finally {
                distributorsLoadInFlight = null;
            }
        }
        
        async function saveDistributors(list) {
            const next = Array.isArray(list) ? list.map(normalizeDistributorRecord).filter(Boolean) : distributors;
            distributors = next;
            distributorsLoadedAt = Date.now();
            window.distributors = distributors;
            persistDistributorsToCache(distributors);
            return distributors;
        }

        async function renderDistributorSearchResults(inputEl, dropdownEl, { limit = 5, onSelect, emptyMessage = 'No distributors found' } = {}) {
            if (!inputEl || !dropdownEl) return;
            const query = (inputEl.value || '').trim().toUpperCase();
            if (query.length < 2) {
                dropdownEl.style.display = 'none';
                dropdownEl.innerHTML = '';
                return;
            }

            const snapshot = query;
            dropdownEl.style.display = 'block';
            dropdownEl.innerHTML = '<div style="padding: 10px; color: #666;">Searching...</div>';

            try {
                const list = await loadDistributors({ search: snapshot, forceRefresh: false });
                if ((inputEl.value || '').trim().toUpperCase() !== snapshot) {
                    return;
                }
                const matches = filterDistributorsByQuery(list, snapshot).slice(0, limit);
                if (!matches.length) {
                    dropdownEl.innerHTML = `<div style="padding: 10px; color: #666;">${emptyMessage}</div>`;
                    return;
                }

                dropdownEl.innerHTML = '';
                matches.forEach((record) => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding:10px; cursor:pointer; border-bottom:1px solid #eee; background:#fff;';
                    const code = record.distributorCode || record.id || '';
                    const name = record.distributorName || record.name || code;
                    item.innerHTML = `<strong>${code}</strong> ‚Äî ${name}`;
                    item.addEventListener('click', () => {
                        if (typeof onSelect === 'function') {
                            onSelect(record);
                        }
                        dropdownEl.style.display = 'none';
                    });
                    dropdownEl.appendChild(item);
                });
            } catch (error) {
                console.error('Distributor search failed:', error);
                dropdownEl.innerHTML = '<div style="padding: 10px; color: #e74c3c;">Unable to load distributors. Please try again.</div>';
            }
        }
        
        // HR Portal Data
        let employees = [];
        let walkInSales = [];
        let hasSyncedWalkInSales = false;
        let walkInSalesSyncInProgress = false;
        let leaveRequests = [];
        let warnings = [];
        let terminations = [];
        let attendanceRecords = [];
        let performanceReviews = [];
        let reports = [];
        let expenses = [];
        let budgets = [];
        // Finance Portal Enhanced Data
        let bankDeposits = [];
        let cashBonuses = [];
        let bankBonuses = [];
        let cashShifts = [];
        let currentShift = null;
        let currentUser = null;
        let currentPortal = null;
        let currentClientId = null;
        let currentBranch = '';
        let uploadedPDF = null;
        let autoRefreshInterval = null;
        
        // Global Distributor selection (name + NB number) shared across portals
        let globalDistributor = null;
        // Client registration modal placement helpers for landing page workflow
        let clientRegModalOriginalParent = null;
        let clientRegModalPlaceholder = null;
        let clientRegModalLandingActive = false;
        // Walk-in sale modal placement helpers
        let walkInSaleModalOriginalParent = null;
        let walkInSaleModalPlaceholder = null;
        let walkInSaleModalDetached = false;

        const HR_STORAGE_KEYS = {
            warnings: 'hr_warnings',
            terminations: 'hr_terminations',
            attendance: 'hr_attendance',
            performance: 'hr_performance_reviews',
            cachedEmployees: 'hr_cached_employees'
        };

        const HR_PORTAL_STATE = {
            initialized: false,
            employees: [],
            employeesLoading: false,
            leaveRecords: [],
            warnings: [],
            terminations: [],
            attendance: [],
            performance: []
        };

        if (typeof window.closeModal !== 'function') {
            window.closeModal = function(modalId) {
                const modalEl = document.getElementById(modalId);
                if (modalEl) modalEl.style.display = 'none';
                if (modalId === 'clientRegModal' && clientRegModalLandingActive) {
                    restoreClientRegModal(modalEl);
                }
                if (modalId === 'mediaGalleryOverlay') {
                    closeMediaOverlay();
                }
            };
        } else {
            const previousCloseModal = window.closeModal;
            window.closeModal = function(modalId) {
                previousCloseModal(modalId);
                if (modalId === 'clientRegModal' && clientRegModalLandingActive) {
                    restoreClientRegModal(document.getElementById('clientRegModal'));
                }
                if (modalId === 'mediaGalleryOverlay') {
                    closeMediaOverlay();
                }
            };
        }

        if (typeof window.escapeHtml !== 'function') {
            window.escapeHtml = function(value) {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };
        }

        function initHRPortal() {
            if (HR_PORTAL_STATE.initialized) return;
            HR_PORTAL_STATE.initialized = true;

            const employeeSearchInput = document.getElementById('employeeSearch');
            if (employeeSearchInput) {
                employeeSearchInput.addEventListener('input', () => renderEmployeeList());
            }

            const addEmployeeForm = document.getElementById('addEmployeeForm');
            if (addEmployeeForm) {
                addEmployeeForm.addEventListener('submit', handleAddEmployeeSubmit);
            }

            const applyLeaveForm = document.getElementById('applyLeaveForm');
            if (applyLeaveForm) {
                applyLeaveForm.addEventListener('submit', handleApplyLeaveSubmit);
            }

            const leaveSearchInput = document.getElementById('leaveSearch');
            if (leaveSearchInput) {
                leaveSearchInput.addEventListener('input', renderLeaveList);
            }

            const leaveStatusFilter = document.getElementById('leaveStatusFilter');
            if (leaveStatusFilter) {
                leaveStatusFilter.addEventListener('change', renderLeaveList);
            }

            const warningSearchInput = document.getElementById('warningSearch');
            if (warningSearchInput) {
                warningSearchInput.addEventListener('input', refreshWarningList);
            }

            const warningTypeFilter = document.getElementById('warningTypeFilter');
            if (warningTypeFilter) {
                warningTypeFilter.addEventListener('change', refreshWarningList);
            }

            const issueWarningForm = document.getElementById('issueWarningForm');
            if (issueWarningForm) {
                issueWarningForm.addEventListener('submit', handleIssueWarningSubmit);
            }

            const terminationSearchInput = document.getElementById('terminationSearch');
            if (terminationSearchInput) {
                terminationSearchInput.addEventListener('input', refreshTerminationList);
            }

            const terminationReasonFilter = document.getElementById('terminationReasonFilter');
            if (terminationReasonFilter) {
                terminationReasonFilter.addEventListener('change', refreshTerminationList);
            }

            const terminateEmployeeForm = document.getElementById('terminateEmployeeForm');
            if (terminateEmployeeForm) {
                terminateEmployeeForm.addEventListener('submit', handleTerminateEmployeeSubmit);
            }

            const attendanceSearchInput = document.getElementById('attendanceSearch');
            if (attendanceSearchInput) {
                attendanceSearchInput.addEventListener('input', refreshAttendanceList);
            }

            const attendanceDateFilter = document.getElementById('attendanceDateFilter');
            if (attendanceDateFilter) {
                attendanceDateFilter.addEventListener('change', refreshAttendanceList);
            }

            const attendanceStatusFilter = document.getElementById('attendanceStatusFilter');
            if (attendanceStatusFilter) {
                attendanceStatusFilter.addEventListener('change', refreshAttendanceList);
            }

            const recordAttendanceForm = document.getElementById('recordAttendanceForm');
            if (recordAttendanceForm) {
                recordAttendanceForm.addEventListener('submit', handleAttendanceSubmit);
            }

            const performanceSearchInput = document.getElementById('performanceSearch');
            if (performanceSearchInput) {
                performanceSearchInput.addEventListener('input', refreshPerformanceList);
            }

            const addPerformanceReviewForm = document.getElementById('addPerformanceReviewForm');
            if (addPerformanceReviewForm) {
                addPerformanceReviewForm.addEventListener('submit', handlePerformanceReviewSubmit);
            }

            loadEmployees({ showSpinner: true }).catch(() => {});
            refreshLeaveList();
            refreshWarningList();
            refreshTerminationList();
            refreshAttendanceList();
            refreshPerformanceList();
            showHRSubTab('employee-management');
        }

        function showHRSubTab(tabId) {
            const contents = document.querySelectorAll('#hr-portal .hr-tab-content');
            contents.forEach((section) => {
                if (section.id === tabId) {
                    section.classList.add('active');
                    section.style.display = 'block';
                } else {
                    section.classList.remove('active');
                    section.style.display = 'none';
                }
            });

            const buttons = document.querySelectorAll('#hr-portal .hr-tab-btn');
            buttons.forEach((btn) => {
                const isActive = (btn.getAttribute('onclick') || '').includes(tabId);
                btn.classList.toggle('active', isActive);
            });

            switch (tabId) {
                case 'employee-management':
                    loadEmployees().catch(() => {});
                    break;
                case 'leave-management':
                    refreshLeaveList();
                    break;
                case 'warnings':
                    refreshWarningList();
                    break;
                case 'terminations':
                    refreshTerminationList();
                    break;
                case 'attendance':
                    refreshAttendanceList();
                    break;
                case 'performance':
                    refreshPerformanceList();
                    break;
                default:
                    break;
            }
        }

        async function loadEmployees(options = {}) {
            if (HR_PORTAL_STATE.employeesLoading) return;
            const container = document.getElementById('employeeList');
            if (container && options.showSpinner) {
                container.innerHTML = '<div class="loading" style="padding: 20px; text-align: center; color: #64748b;">Loading employees‚Ä¶</div>';
            }

            HR_PORTAL_STATE.employeesLoading = true;
            try {
                const response = await apiRequest('/employees', 'GET');
                const list = Array.isArray(response)
                    ? response
                    : Array.isArray(response?.employees)
                    ? response.employees
                    : [];
                HR_PORTAL_STATE.employees = list.map((emp) => ({
                    id: emp.id || emp.employeeId || emp.employee_id,
                    employeeId: emp.employeeId || emp.employee_id || emp.user_id || '',
                    name: emp.name || emp.fullName || emp.full_name || 'Team Member',
                    department: emp.department || '',
                    role: emp.role || '',
                    branch: emp.branch || '',
                    email: emp.email || '',
                    phone: emp.phone || '',
                    hireDate: emp.hireDate || emp.hire_date || '',
                    employmentType: emp.employmentType || emp.employment_type || '',
                    position: emp.position || '',
                    notes: emp.notes || '',
                    salary: emp.salary ?? null
                }));
                try {
                    localStorage.setItem(HR_STORAGE_KEYS.cachedEmployees, JSON.stringify(HR_PORTAL_STATE.employees));
                } catch (_) {}
            } catch (error) {
                console.warn('Unable to load employees from API:', error?.message || error);
                try {
                    const cached = JSON.parse(localStorage.getItem(HR_STORAGE_KEYS.cachedEmployees) || '[]');
                    if (Array.isArray(cached) && cached.length) {
                        HR_PORTAL_STATE.employees = cached;
                    }
                } catch (_) {}
                if (container && !HR_PORTAL_STATE.employees.length) {
                    container.innerHTML =
                        '<p style="padding: 20px; text-align: center; color: #b91c1c;">Unable to load employees. Please try again.</p>';
                }
            } finally {
                HR_PORTAL_STATE.employeesLoading = false;
                populateEmployeeSelects();
                renderEmployeeList();
            }
        }

        function renderEmployeeList() {
            const container = document.getElementById('employeeList');
            if (!container) return;

            const searchValue = (document.getElementById('employeeSearch')?.value || '').trim().toLowerCase();
            const rows = HR_PORTAL_STATE.employees.filter((emp) => {
                if (!searchValue) return true;
                const haystack = [
                    emp.name,
                    emp.employeeId,
                    emp.department,
                    emp.role,
                    emp.branch,
                    emp.email,
                    emp.phone
                ]
                    .join(' ')
                    .toLowerCase();
                return haystack.includes(searchValue);
            });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #f8fafc; border: 1px dashed #cbd5f5; border-radius: 8px; color: #64748b;">No employees found. Add a new employee to get started.</div>';
                return;
            }

            const tableRows = rows
                .map(
                    (emp) => `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #0f172a;">${escapeHtml(emp.name)}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">${escapeHtml(emp.employeeId || '')}</div>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${escapeHtml(emp.department || '')}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${escapeHtml(emp.role || '')}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${escapeHtml(emp.branch || '')}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-size: 0.85rem; color: #1e293b;">${escapeHtml(emp.email || '‚Äî')}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">${escapeHtml(emp.phone || '')}</div>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 0.8rem; color: #475569;">
                            ${emp.hireDate ? new Date(emp.hireDate).toLocaleDateString() : '‚Äî'}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn" data-action="view-employee" data-id="${encodeURIComponent(emp.id)}">View</button>
                                <button class="btn btn-danger" data-action="delete-employee" data-id="${encodeURIComponent(emp.id)}">Delete</button>
                            </div>
                        </td>
                    </tr>
                `
                )
                .join('');

            container.innerHTML = `
                <div class="scroll-x" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; color: #1e293b;">
                                <th style="padding: 10px; text-align: left;">Employee</th>
                                <th style="padding: 10px; text-align: left;">Department</th>
                                <th style="padding: 10px; text-align: left;">Role</th>
                                <th style="padding: 10px; text-align: left;">Branch</th>
                                <th style="padding: 10px; text-align: left;">Contact</th>
                                <th style="padding: 10px; text-align: left;">Hire Date</th>
                                <th style="padding: 10px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;

            container.querySelectorAll('button[data-action]').forEach((btn) => {
                const action = btn.getAttribute('data-action');
                const id = decodeURIComponent(btn.getAttribute('data-id') || '');
                if (action === 'delete-employee') {
                    btn.addEventListener('click', () => handleEmployeeDelete(id));
                }
                if (action === 'view-employee') {
                    btn.addEventListener('click', () => handleEmployeeView(id));
                }
            });
        }

        function showAddEmployee() {
            const modal = document.getElementById('addEmployeeModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('addEmployeeForm');
            if (form) form.reset();
            const focusField = document.getElementById('employeeName');
            if (focusField) setTimeout(() => focusField.focus(), 150);
        }

        function populateEmployeeSelects() {
            const options = HR_PORTAL_STATE.employees
                .map(
                    (emp) =>
                        `<option value="${escapeHtml(emp.employeeId || emp.id || '')}">${escapeHtml(emp.name)}${emp.branch ? ` (${escapeHtml(emp.branch)})` : ''}</option>`
                )
                .join('');

            const selects = [
                document.getElementById('leaveEmployeeSelect'),
                document.getElementById('warningEmployeeSelect'),
                document.getElementById('terminationEmployeeSelect'),
                document.getElementById('attendanceEmployeeSelect'),
                document.getElementById('performanceEmployeeSelect')
            ];

            selects.forEach((select) => {
                if (!select) return;
                const placeholder = select.getAttribute('data-placeholder') || 'Select Employee';
                select.innerHTML = `<option value="">${placeholder}</option>${options}`;
            });
        }

        async function handleAddEmployeeSubmit(event) {
            event.preventDefault();
            const btn = event.submitter;
            if (btn) btn.disabled = true;
            try {
                const payload = {
                    name: document.getElementById('employeeName')?.value.trim(),
                    employeeId: document.getElementById('employeeId')?.value.trim(),
                    department: document.getElementById('employeeDepartment')?.value || '',
                    position: document.getElementById('employeePosition')?.value || '',
                    email: document.getElementById('employeeEmail')?.value.trim(),
                    phone: document.getElementById('employeePhone')?.value.trim(),
                    hireDate: document.getElementById('employeeHireDate')?.value || null,
                    employmentType: document.getElementById('employmentType')?.value || '',
                    salary: document.getElementById('employeeSalary')?.value || null,
                    address: document.getElementById('employeeAddress')?.value || '',
                    dob: document.getElementById('employeeDOB')?.value || null,
                    emergencyContactName: document.getElementById('emergencyContactName')?.value || '',
                    emergencyContactPhone: document.getElementById('emergencyContactPhone')?.value || '',
                    notes: document.getElementById('employeeNotes')?.value || ''
                };

                if (!payload.name) {
                    alert('Employee name is required.');
                    return;
                }

                const response = await apiRequest('/employees', 'POST', payload);
                if (response?.success && response.employee) {
                    HR_PORTAL_STATE.employees.unshift({
                        id: response.employee.id || response.employee.employeeId,
                        employeeId: response.employee.employeeId || response.employee.id,
                        name: response.employee.name || response.employee.fullName || payload.name,
                        department: response.employee.department || payload.department,
                        role: response.employee.role || payload.position,
                        branch: response.employee.branch || '',
                        email: response.employee.email || payload.email,
                        phone: response.employee.phone || payload.phone,
                        hireDate: response.employee.hireDate || payload.hireDate,
                        employmentType: response.employee.employmentType || payload.employmentType,
                        position: response.employee.position || payload.position,
                        notes: response.employee.notes || payload.notes,
                        salary: response.employee.salary ?? payload.salary
                    });
                    try {
                        localStorage.setItem(HR_STORAGE_KEYS.cachedEmployees, JSON.stringify(HR_PORTAL_STATE.employees));
                    } catch (_) {}
                    renderEmployeeList();
                    populateEmployeeSelects();
                    closeModal('addEmployeeModal');
                } else {
                    throw new Error(response?.message || 'Unable to save employee.');
                }
            } catch (error) {
                console.error('Add employee failed:', error);
                alert(error?.message || 'Unable to save employee.');
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function handleEmployeeView(id) {
            const employee = HR_PORTAL_STATE.employees.find((emp) => String(emp.id) === String(id));
            if (!employee) {
                alert('Employee not found.');
                return;
            }
            alert(
                `Employee Details\n\nName: ${employee.name}\nEmployee ID: ${employee.employeeId || '‚Äî'}\nDepartment: ${employee.department || '‚Äî'}\nRole: ${employee.role || '‚Äî'}\nBranch: ${employee.branch || '‚Äî'}\nEmail: ${employee.email || '‚Äî'}\nPhone: ${employee.phone || '‚Äî'}\nHire Date: ${
                    employee.hireDate ? new Date(employee.hireDate).toLocaleDateString() : '‚Äî'
                }\nEmployment Type: ${employee.employmentType || '‚Äî'}\nPosition: ${employee.position || '‚Äî'}\nNotes: ${employee.notes || '‚Äî'}`
            );
        }

        async function handleEmployeeDelete(id) {
            if (!id) return;
            if (!confirm('Are you sure you want to remove this employee?')) return;
            try {
                await apiRequest(`/employees?id=${encodeURIComponent(id)}`, 'DELETE');
                HR_PORTAL_STATE.employees = HR_PORTAL_STATE.employees.filter((emp) => String(emp.id) !== String(id));
                try {
                    localStorage.setItem(HR_STORAGE_KEYS.cachedEmployees, JSON.stringify(HR_PORTAL_STATE.employees));
                } catch (_) {}
                renderEmployeeList();
                populateEmployeeSelects();
            } catch (error) {
                console.error('Delete employee failed:', error);
                alert(error?.message || 'Unable to delete employee.');
            }
        }

        function showApplyLeave() {
            populateEmployeeSelects();
            const modal = document.getElementById('applyLeaveModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('applyLeaveForm');
            if (form) form.reset();
            const employeeSelect = document.getElementById('leaveEmployeeSelect');
            if (employeeSelect) setTimeout(() => employeeSelect.focus(), 150);
        }

        async function handleApplyLeaveSubmit(event) {
            event.preventDefault();
            const submitBtn = event.submitter;
            if (submitBtn) submitBtn.disabled = true;

            const employeeId = document.getElementById('leaveEmployeeSelect')?.value || '';
            const leaveType = document.getElementById('leaveType')?.value || '';
            const startDate = document.getElementById('leaveStartDate')?.value || '';
            const endDate = document.getElementById('leaveEndDate')?.value || '';
            const reason = document.getElementById('leaveReason')?.value || '';

            if (!employeeId || !leaveType || !startDate || !endDate) {
                alert('Please complete all required fields.');
                if (submitBtn) submitBtn.disabled = false;
                return;
            }

            const employee = HR_PORTAL_STATE.employees.find(
                (emp) => String(emp.employeeId || emp.id) === String(employeeId)
            );

            const payload = {
                employeeId,
                employeeName: employee?.name || employeeId,
                leaveType,
                startDate,
                endDate,
                reason,
                status: 'pending'
            };

            try {
                const response = await apiRequest(LEAVE_API_ENDPOINT, 'POST', payload);
                if (!response || response?.success === false) {
                    throw new Error(response?.message || 'Unable to submit leave request.');
                }
                alert('Leave request submitted successfully.');
            } catch (error) {
                console.warn('Leave API unavailable, saving offline.', error?.message || error);
                const normalized = normalizeLeaveRecord(payload, {
                    defaultStaff: employeeId,
                    defaultStaffName: employee?.name || employeeId,
                    defaultBranch: employee?.branch || null,
                    pendingSync: true,
                    source: 'offline'
                });
                upsertLeaveCacheRecord(normalized);
                enqueuePendingRequest(LEAVE_PENDING_QUEUE_KEY, {
                    id: normalized.id,
                    payload
                });
                alert('Leave request stored locally and will sync when back online.');
            } finally {
                if (submitBtn) submitBtn.disabled = false;
                closeModal('applyLeaveModal');
                refreshLeaveList();
            }
        }

        async function refreshLeaveList() {
            const container = document.getElementById('leaveList');
            if (!container) return;
            container.innerHTML =
                '<div class="loading" style="padding: 20px; text-align: center; color: #64748b;">Loading leave records‚Ä¶</div>';
            try {
                const records = await fetchLeaveRecordsIncludingOffline();
                HR_PORTAL_STATE.leaveRecords = records;
                renderLeaveList();
            } catch (error) {
                console.error('Unable to load leave records:', error);
                container.innerHTML =
                    '<p style="padding: 20px; text-align: center; color: #b91c1c;">Unable to load leave records. Please try again.</p>';
            }
        }

        function renderLeaveList() {
            const container = document.getElementById('leaveList');
            if (!container) return;
            const search = (document.getElementById('leaveSearch')?.value || '').trim().toLowerCase();
            const statusFilter = (document.getElementById('leaveStatusFilter')?.value || 'all').toLowerCase();

            const rows = HR_PORTAL_STATE.leaveRecords.filter((record) => {
                const matchesStatus =
                    statusFilter === 'all' ||
                    statusFilter === (record.statusRaw || record.status || '').toLowerCase();
                const haystack = [
                    record.employee,
                    record.staff,
                    record.branch,
                    record.reason,
                    record.type
                ]
                    .filter(Boolean)
                    .join(' ')
                    .toLowerCase();
                const matchesSearch = search ? haystack.includes(search) : true;
                return matchesStatus && matchesSearch;
            });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #f8fafc; border: 1px dashed #cbd5f5; border-radius: 8px; color: #64748b;">No leave records found.</div>';
                return;
            }

            const htmlRows = rows
                .map((record) => {
                    const start = record.startDate ? new Date(record.startDate).toLocaleDateString() : '‚Äî';
                    const end = record.endDate ? new Date(record.endDate).toLocaleDateString() : '‚Äî';
                    const status = (record.status || record.statusRaw || 'pending').toLowerCase();
                    const statusColor =
                        status === 'approved'
                            ? '#16a34a'
                            : status === 'rejected'
                            ? '#dc2626'
                            : '#f59e0b';
                    return `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #0f172a;">${escapeHtml(record.employee || record.staff || 'Unknown')}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(record.branch || '‚Äî')}</div>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${escapeHtml(record.type || 'General Leave')}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${start}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${end}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <span style="display: inline-block; padding: 6px 12px; border-radius: 999px; background: ${statusColor}; color: white; font-size: 0.75rem; text-transform: uppercase;">${escapeHtml(record.status || 'Pending')}</span>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 0.8rem; color: #475569;">${escapeHtml(record.reason || '‚Äî')}</td>
                    </tr>
                `;
                })
                .join('');

            container.innerHTML = `
                <div class="scroll-x" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; color: #1e293b;">
                                <th style="padding: 10px; text-align: left;">Employee</th>
                                <th style="padding: 10px; text-align: left;">Leave Type</th>
                                <th style="padding: 10px; text-align: left;">Start</th>
                                <th style="padding: 10px; text-align: left;">End</th>
                                <th style="padding: 10px; text-align: left;">Status</th>
                                <th style="padding: 10px; text-align: left;">Reason</th>
                            </tr>
                        </thead>
                        <tbody>${htmlRows}</tbody>
                    </table>
                </div>
            `;
        }

        function loadWarningsFromStorage() {
            try {
                const raw = localStorage.getItem(HR_STORAGE_KEYS.warnings);
                return Array.isArray(JSON.parse(raw || '[]')) ? JSON.parse(raw || '[]') : [];
            } catch (_) {
                return [];
            }
        }

        function saveWarningsToStorage(list) {
            try {
                localStorage.setItem(HR_STORAGE_KEYS.warnings, JSON.stringify(Array.isArray(list) ? list : []));
            } catch (_) {}
        }

        function refreshWarningList() {
            HR_PORTAL_STATE.warnings = loadWarningsFromStorage();
            const container = document.getElementById('warningList');
            if (!container) return;

            const search = (document.getElementById('warningSearch')?.value || '').trim().toLowerCase();
            const typeFilter = (document.getElementById('warningTypeFilter')?.value || '').toLowerCase();

            const rows = HR_PORTAL_STATE.warnings
                .slice()
                .sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0))
                .filter((warning) => {
                    const matchesType = !typeFilter || (warning.type || '').toLowerCase() === typeFilter;
                    const haystack = `${warning.employee || ''} ${warning.reason || ''} ${warning.issuedBy || ''}`.toLowerCase();
                    const matchesSearch = search ? haystack.includes(search) : true;
                    return matchesType && matchesSearch;
                });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #fefce8; border: 1px dashed #facc15; border-radius: 8px; color: #ca8a04;">No warnings recorded yet.</div>';
                return;
            }

            const htmlRows = rows
                .map((warning) => {
                    const type = warning.type || 'General';
                    const color =
                        type === 'Final' ? '#ef4444' : type === 'Written' ? '#f59e0b' : '#3b82f6';
                    return `
                        <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; margin-bottom: 12px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #0f172a;">${escapeHtml(warning.employee || 'Unknown')}</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Issued by ${escapeHtml(warning.issuedBy || '‚Äî')} ‚Ä¢ ${
                        warning.date ? new Date(warning.date).toLocaleDateString() : 'Date not set'
                    }</div>
                                </div>
                                <span style="display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; background: ${color}; color: white; font-size: 0.75rem; text-transform: uppercase;">${escapeHtml(type)}</span>
                            </div>
                            <p style="margin: 12px 0 0; color: #475569;">${escapeHtml(warning.reason || '')}</p>
                            ${warning.notes ? `<p style="margin: 8px 0 0; color: #64748b; font-size: 0.85rem;">${escapeHtml(warning.notes)}</p>` : ''}
                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn" data-warning-action="view" data-warning-id="${escapeHtml(warning.id)}">View</button>
                                <button class="btn btn-danger" data-warning-action="delete" data-warning-id="${escapeHtml(warning.id)}">Delete</button>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = htmlRows;
            container.querySelectorAll('[data-warning-action]').forEach((btn) => {
                const action = btn.getAttribute('data-warning-action');
                const id = btn.getAttribute('data-warning-id');
                if (action === 'view') {
                    btn.addEventListener('click', () => viewWarning(id));
                } else if (action === 'delete') {
                    btn.addEventListener('click', () => deleteWarning(id));
                }
            });
        }

        function showIssueWarning() {
            populateEmployeeSelects();
            const modal = document.getElementById('issueWarningModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('issueWarningForm');
            if (form) form.reset();
            const issuedBy = document.getElementById('warningIssuedBy');
            if (issuedBy && currentUser?.fullName) {
                issuedBy.value = currentUser.fullName;
            }
            const select = document.getElementById('warningEmployeeSelect');
            if (select) setTimeout(() => select.focus(), 150);
        }

        function handleIssueWarningSubmit(event) {
            event.preventDefault();
            const employeeId = document.getElementById('warningEmployeeSelect')?.value || '';
            const employee = HR_PORTAL_STATE.employees.find(
                (emp) => String(emp.employeeId || emp.id) === String(employeeId)
            );
            const warning = {
                id: `WARN-${Date.now()}`,
                employeeId,
                employee: employee?.name || employeeId,
                type: document.getElementById('warningType')?.value || 'General',
                date: document.getElementById('warningDate')?.value || new Date().toISOString().slice(0, 10),
                issuedBy: document.getElementById('warningIssuedBy')?.value || currentUser?.fullName || 'HR',
                reason: document.getElementById('warningReason')?.value || '',
                notes: document.getElementById('warningNotes')?.value || '',
                createdAt: new Date().toISOString()
            };
            HR_PORTAL_STATE.warnings = loadWarningsFromStorage();
            HR_PORTAL_STATE.warnings.push(warning);
            saveWarningsToStorage(HR_PORTAL_STATE.warnings);
            closeModal('issueWarningModal');
            refreshWarningList();
            alert('Warning recorded successfully.');
        }

        function viewWarning(id) {
            const warning = HR_PORTAL_STATE.warnings.find((item) => String(item.id) === String(id));
            if (!warning) {
                alert('Warning not found.');
                return;
            }
            alert(
                `Warning Details\n\nEmployee: ${warning.employee}\nType: ${warning.type}\nDate: ${
                    warning.date ? new Date(warning.date).toLocaleDateString() : '‚Äî'
                }\nIssued By: ${warning.issuedBy || '‚Äî'}\n\nReason:\n${warning.reason || '‚Äî'}\n\nNotes:\n${warning.notes || 'None'}`
            );
        }

        function deleteWarning(id) {
            if (!confirm('Delete this warning?')) return;
            HR_PORTAL_STATE.warnings = HR_PORTAL_STATE.warnings.filter((item) => String(item.id) !== String(id));
            saveWarningsToStorage(HR_PORTAL_STATE.warnings);
            refreshWarningList();
        }

        function loadTerminationsFromStorage() {
            try {
                return JSON.parse(localStorage.getItem(HR_STORAGE_KEYS.terminations) || '[]');
            } catch (_) {
                return [];
            }
        }

        function saveTerminationsToStorage(list) {
            try {
                localStorage.setItem(HR_STORAGE_KEYS.terminations, JSON.stringify(Array.isArray(list) ? list : []));
            } catch (_) {}
        }

        function showTerminateEmployee() {
            populateEmployeeSelects();
            const modal = document.getElementById('terminateEmployeeModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('terminateEmployeeForm');
            if (form) form.reset();
            const select = document.getElementById('terminationEmployeeSelect');
            if (select) setTimeout(() => select.focus(), 150);
        }

        function handleTerminateEmployeeSubmit(event) {
            event.preventDefault();
            HR_PORTAL_STATE.terminations = loadTerminationsFromStorage();
            const employeeId = document.getElementById('terminationEmployeeSelect')?.value || '';
            const employee = HR_PORTAL_STATE.employees.find(
                (emp) => String(emp.employeeId || emp.id) === String(employeeId)
            );
            const termination = {
                id: `TERM-${Date.now()}`,
                employeeId,
                employee: employee?.name || employeeId,
                date: document.getElementById('terminationDate')?.value || new Date().toISOString().slice(0, 10),
                type: document.getElementById('terminationType')?.value || 'Resignation',
                reason: document.getElementById('terminationReason')?.value || '',
                noticePeriod: document.getElementById('noticePeriod')?.value || '',
                notes: document.getElementById('terminationNotes')?.value || '',
                createdAt: new Date().toISOString()
            };
            HR_PORTAL_STATE.terminations.push(termination);
            saveTerminationsToStorage(HR_PORTAL_STATE.terminations);
            closeModal('terminateEmployeeModal');
            refreshTerminationList();
            alert('Termination recorded successfully.');
        }

        function refreshTerminationList() {
            HR_PORTAL_STATE.terminations = loadTerminationsFromStorage();
            const container = document.getElementById('terminationList');
            if (!container) return;

            const search = (document.getElementById('terminationSearch')?.value || '').trim().toLowerCase();
            const typeFilter = (document.getElementById('terminationReasonFilter')?.value || '').toLowerCase();

            const rows = HR_PORTAL_STATE.terminations
                .slice()
                .sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0))
                .filter((record) => {
                    const matchesType = !typeFilter || (record.type || '').toLowerCase() === typeFilter;
                    const haystack = `${record.employee || ''} ${record.reason || ''}`.toLowerCase();
                    const matchesSearch = search ? haystack.includes(search) : true;
                    return matchesType && matchesSearch;
                });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #fef2f2; border: 1px dashed #fca5a5; border-radius: 8px; color: #b91c1c;">No terminations recorded.</div>';
                return;
            }

            container.innerHTML = rows
                .map(
                    (record) => `
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; margin-bottom: 12px; background: white;">
                        <div style="display:flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div>
                                <div style="font-weight: 600; color: #0f172a;">${escapeHtml(record.employee || 'Unknown')}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${record.date ? new Date(record.date).toLocaleDateString() : '‚Äî'} ‚Ä¢ ${escapeHtml(record.type || 'Termination')}</div>
                            </div>
                            <button class="btn btn-danger" data-termination-id="${escapeHtml(record.id)}">Delete</button>
                        </div>
                        <p style="margin: 12px 0 0; color: #475569;">${escapeHtml(record.reason || '')}</p>
                        ${record.notes ? `<p style="margin: 8px 0 0; color: #64748b; font-size: 0.85rem;">${escapeHtml(record.notes)}</p>` : ''}
                    </div>
                `
                )
                .join('');

            container.querySelectorAll('button[data-termination-id]').forEach((btn) => {
                const id = btn.getAttribute('data-termination-id');
                btn.addEventListener('click', () => deleteTermination(id));
            });
        }

        function deleteTermination(id) {
            if (!confirm('Delete this termination record?')) return;
            HR_PORTAL_STATE.terminations = HR_PORTAL_STATE.terminations.filter((item) => String(item.id) !== String(id));
            saveTerminationsToStorage(HR_PORTAL_STATE.terminations);
            refreshTerminationList();
        }

        function loadAttendanceFromStorage() {
            try {
                return JSON.parse(localStorage.getItem(HR_STORAGE_KEYS.attendance) || '[]');
            } catch (_) {
                return [];
            }
        }

        function saveAttendanceToStorage(list) {
            try {
                localStorage.setItem(HR_STORAGE_KEYS.attendance, JSON.stringify(Array.isArray(list) ? list : []));
            } catch (_) {}
        }

        function showRecordAttendance() {
            populateEmployeeSelects();
            const modal = document.getElementById('recordAttendanceModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('recordAttendanceForm');
            if (form) form.reset();
            const select = document.getElementById('attendanceEmployeeSelect');
            if (select) setTimeout(() => select.focus(), 150);
        }

        function handleAttendanceSubmit(event) {
            event.preventDefault();
            HR_PORTAL_STATE.attendance = loadAttendanceFromStorage();

            const employeeId = document.getElementById('attendanceEmployeeSelect')?.value || '';
            const employee = HR_PORTAL_STATE.employees.find(
                (emp) => String(emp.employeeId || emp.id) === String(employeeId)
            );
            const attendance = {
                id: `ATT-${Date.now()}`,
                employeeId,
                employee: employee?.name || employeeId,
                date: document.getElementById('attendanceDate')?.value || new Date().toISOString().slice(0, 10),
                status: document.getElementById('attendanceStatus')?.value || 'Present',
                checkIn: document.getElementById('checkInTime')?.value || '',
                checkOut: document.getElementById('checkOutTime')?.value || '',
                notes: document.getElementById('attendanceNotes')?.value || '',
                createdAt: new Date().toISOString()
            };

            HR_PORTAL_STATE.attendance.push(attendance);
            saveAttendanceToStorage(HR_PORTAL_STATE.attendance);
            closeModal('recordAttendanceModal');
            refreshAttendanceList();
            alert('Attendance recorded.');
        }

        function refreshAttendanceList() {
            HR_PORTAL_STATE.attendance = loadAttendanceFromStorage();
            const container = document.getElementById('attendanceList');
            if (!container) return;

            const search = (document.getElementById('attendanceSearch')?.value || '').trim().toLowerCase();
            const dateFilter = document.getElementById('attendanceDateFilter')?.value || '';
            const statusFilter = (document.getElementById('attendanceStatusFilter')?.value || 'all').toLowerCase();

            const rows = HR_PORTAL_STATE.attendance
                .slice()
                .sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0))
                .filter((record) => {
                    const matchesStatus =
                        statusFilter === 'all' || (record.status || '').toLowerCase() === statusFilter;
                    const matchesDate = !dateFilter || record.date === dateFilter;
                    const haystack = `${record.employee || ''} ${record.notes || ''}`.toLowerCase();
                    const matchesSearch = search ? haystack.includes(search) : true;
                    return matchesStatus && matchesDate && matchesSearch;
                });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #eff6ff; border: 1px dashed #93c5fd; border-radius: 8px; color: #2563eb;">No attendance records.</div>';
                return;
            }

            container.innerHTML = rows
                .map(
                    (record) => `
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; margin-bottom: 12px; background: white;">
                        <div style="display:flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div>
                                <div style="font-weight: 600; color: #0f172a;">${escapeHtml(record.employee || 'Unknown')}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${record.date ? new Date(record.date).toLocaleDateString() : '‚Äî'}</div>
                            </div>
                            <span style="display: inline-flex; padding: 6px 10px; border-radius: 999px; background: #0ea5e9; color: white; font-size: 0.75rem;">${escapeHtml(record.status || 'present')}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #475569; margin-top: 6px;">${record.checkIn ? `In: ${escapeHtml(record.checkIn)}` : ''} ${record.checkOut ? `‚Ä¢ Out: ${escapeHtml(record.checkOut)}` : ''}</div>
                        ${record.notes ? `<p style="margin-top: 8px; color: #64748b; font-size: 0.85rem;">${escapeHtml(record.notes)}</p>` : ''}
                        <div style="margin-top: 10px;">
                            <button class="btn btn-danger" data-attendance-id="${escapeHtml(record.id)}">Delete</button>
                        </div>
                    </div>
                `
                )
                .join('');

            container.querySelectorAll('button[data-attendance-id]').forEach((btn) => {
                const id = btn.getAttribute('data-attendance-id');
                btn.addEventListener('click', () => deleteAttendanceRecord(id));
            });
        }

        function deleteAttendanceRecord(id) {
            if (!confirm('Delete this attendance record?')) return;
            HR_PORTAL_STATE.attendance = HR_PORTAL_STATE.attendance.filter((item) => String(item.id) !== String(id));
            saveAttendanceToStorage(HR_PORTAL_STATE.attendance);
            refreshAttendanceList();
        }

        function loadPerformanceFromStorage() {
            try {
                return JSON.parse(localStorage.getItem(HR_STORAGE_KEYS.performance) || '[]');
            } catch (_) {
                return [];
            }
        }

        function savePerformanceToStorage(list) {
            try {
                localStorage.setItem(HR_STORAGE_KEYS.performance, JSON.stringify(Array.isArray(list) ? list : []));
            } catch (_) {}
        }

        function showAddPerformanceReview() {
            populateEmployeeSelects();
            const modal = document.getElementById('addPerformanceReviewModal');
            if (!modal) return;
            modal.style.display = 'block';
            const form = document.getElementById('addPerformanceReviewForm');
            if (form) form.reset();
            const select = document.getElementById('performanceEmployeeSelect');
            if (select) setTimeout(() => select.focus(), 150);
        }

        function handlePerformanceReviewSubmit(event) {
            event.preventDefault();
            HR_PORTAL_STATE.performance = loadPerformanceFromStorage();
            const employeeId = document.getElementById('performanceEmployeeSelect')?.value || '';
            const employee = HR_PORTAL_STATE.employees.find(
                (emp) => String(emp.employeeId || emp.id) === String(employeeId)
            );

            const review = {
                id: `PERF-${Date.now()}`,
                employeeId,
                employee: employee?.name || employeeId,
                reviewStart: document.getElementById('reviewStartDate')?.value || null,
                reviewEnd: document.getElementById('reviewEndDate')?.value || null,
                reviewedBy: document.getElementById('reviewedBy')?.value || currentUser?.fullName || 'Supervisor',
                rating: document.getElementById('overallRating')?.value || 'Average',
                strengths: document.getElementById('strengths')?.value || '',
                improvements: document.getElementById('improvements')?.value || '',
                goals: document.getElementById('goals')?.value || '',
                comments: document.getElementById('reviewComments')?.value || '',
                createdAt: new Date().toISOString()
            };

            HR_PORTAL_STATE.performance.push(review);
            savePerformanceToStorage(HR_PORTAL_STATE.performance);
            closeModal('addPerformanceReviewModal');
            refreshPerformanceList();
            alert('Performance review saved.');
        }

        function refreshPerformanceList() {
            HR_PORTAL_STATE.performance = loadPerformanceFromStorage();
            const container = document.getElementById('performanceList');
            if (!container) return;
            const search = (document.getElementById('performanceSearch')?.value || '').trim().toLowerCase();

            const rows = HR_PORTAL_STATE.performance
                .slice()
                .sort((a, b) => new Date(b.reviewEnd || b.createdAt || 0) - new Date(a.reviewEnd || a.createdAt || 0))
                .filter((record) => {
                    const haystack = `${record.employee || ''} ${record.reviewedBy || ''} ${record.comments || ''}`.toLowerCase();
                    return search ? haystack.includes(search) : true;
                });

            if (!rows.length) {
                container.innerHTML =
                    '<div style="padding: 18px; background: #f8fafc; border: 1px dashed #cbd5f5; border-radius: 8px; color: #64748b;">No performance reviews logged.</div>';
                return;
            }

            container.innerHTML = rows
                .map(
                    (record) => `
                        <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; margin-bottom: 12px; background: white;">
                            <div style="display:flex; justify-content: space-between; align-items: start; gap: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #0f172a;">${escapeHtml(record.employee || 'Unknown')}</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Reviewed by ${escapeHtml(record.reviewedBy || '‚Äî')}</div>
                                </div>
                                <span style="display:inline-flex; padding:6px 10px; border-radius: 999px; background:#6366f1; color:white; font-size:0.75rem;">${escapeHtml(record.rating || 'Average')}</span>
                            </div>
                            <p style="margin: 10px 0 0; color: #475569;">
                                ${record.reviewStart ? new Date(record.reviewStart).toLocaleDateString() : '‚Äî'} to
                                ${record.reviewEnd ? new Date(record.reviewEnd).toLocaleDateString() : '‚Äî'}
                            </p>
                            ${record.comments ? `<p style="margin: 8px 0 0; color: #64748b; font-size: 0.85rem;">${escapeHtml(record.comments)}</p>` : ''}
                        </div>
                    `
                )
                .join('');
        }

        window.showAddEmployee = showAddEmployee;
        window.refreshEmployeeList = () => loadEmployees({ force: true });
        window.showApplyLeave = showApplyLeave;
        window.showIssueWarning = showIssueWarning;
        window.showTerminateEmployee = showTerminateEmployee;
        window.showRecordAttendance = showRecordAttendance;
        window.showAddPerformanceReview = showAddPerformanceReview;
        window.initHRPortal = initHRPortal;
        window.showHRSubTab = showHRSubTab;

        function setGlobalDistributor(info) {
            try {
                globalDistributor = {
                    name: (info && (info.name || info.distributorName)) || '',
                    nbNumber: (info && (info.nbNumber || info.code)) || '',
                    phone: (info && (info.phone || info.mobile || info.mobileNo)) || ''
                };
                try { localStorage.setItem('globalDistributor', JSON.stringify(globalDistributor)); } catch (_) {}
                renderGlobalDistributorBadge();
            } catch (_) {}
        }

        function getGlobalDistributor() {
            try {
                if (globalDistributor && (globalDistributor.name || globalDistributor.nbNumber)) return globalDistributor;
                const saved = localStorage.getItem('globalDistributor');
                if (saved) {
                    globalDistributor = JSON.parse(saved);
                    return globalDistributor;
                }
            } catch (_) {}
            return null;
        }

        function clearGlobalDistributor() {
            try {
                globalDistributor = null;
                try { localStorage.removeItem('globalDistributor'); } catch (_) {}
                renderGlobalDistributorBadge();
                try { if (typeof clearSelectedReferral === 'function') clearSelectedReferral(); } catch (_) {}
            } catch (_) {}
        }

        function renderGlobalDistributorBadge() {
            const badge = document.getElementById('globalDistributorBadge');
            const clearBtn = document.getElementById('clearGlobalDistributorBtn');
            const gd = getGlobalDistributor();
            if (badge) {
                if (gd && gd.name && gd.nbNumber) {
                    badge.textContent = `Distributor: ${gd.name} | NB: ${gd.nbNumber}`;
                    badge.style.display = 'inline-block';
                    if (clearBtn) clearBtn.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'none';
                }
            }
            // Also update cart header if visible
            try { if (typeof updateShopCart === 'function') updateShopCart(); } catch (_) {}
        }

        // Initialize from saved selection on load
        (function initGlobalDistributor(){ try { getGlobalDistributor(); renderGlobalDistributorBadge(); } catch(_){} })();

        // Cash management
        let cashDrawer = {
            openingBalance: 0,
            currentBalance: 0,
            isOpen: false,
            openedBy: null,
            openedAt: null,
            drops: [],
            expenses: [],
            sessionId: null,
            metadata: {}
        };
        let branchCashSession = null;
        let branchCashMovements = [];
        let branchDeposits = [];
        let branchExpensesRecords = [];
        let branchPaymentsRecords = [];
        let hasSyncedBranchFinance = false;
        let branchFinanceSyncInProgress = false;
		let crmPortalInteractions = [];
		let crmPortalWorkflows = [];
		let crmPortalWorkflowLog = [];
		let crmLoyaltyMembers = [];
        
        // Inventory tracking
        let inventory = {};
        
        // Initialize inventory from price list (called on login)
        function initializeInventory() {
            if (Object.keys(inventory).length === 0) {
                // Initialize from PRICE_LIST
                PRICE_LIST.forEach(product => {
                    inventory[product.description] = {
                        currentStock: 0,
                        reorderLevel: 5,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
                
                // Initialize packages
                Object.keys(PACKAGE_DATABASE).forEach(packageName => {
                    inventory[packageName] = {
                        currentStock: 0,
                        reorderLevel: 2,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
            }
        }

        // Reduce inventory programmatically for a list of products [{name, quantity}]
        function reduceInventoryForProducts(products, userFullName, reference) {
            if (!Array.isArray(products) || products.length === 0) return { success: true };
            initializeInventory();
            const errors = [];
            products.forEach(prod => {
                const productName = prod.name || prod.productName;
                const qty = parseInt(prod.quantity || 1);
                if (!productName || !qty) return;
                if (!inventory[productName]) {
                    errors.push(`Product not found in inventory: ${productName}`);
                    return;
                }
                const previousStock = inventory[productName].currentStock;
                if (previousStock < qty) {
                    errors.push(`Insufficient stock for ${productName} (have ${previousStock}, need ${qty})`);
                }
                const newStock = Math.max(0, previousStock - qty);
                inventory[productName].currentStock = newStock;
                inventory[productName].lastUpdated = new Date().toISOString();
                if (!inventory[productName].history) inventory[productName].history = [];
                inventory[productName].history.push({
                    action: 'remove',
                    quantity: qty,
                    previousStock: previousStock,
                    newStock: newStock,
                    user: userFullName || 'system',
                    timestamp: new Date().toISOString(),
                    reference: reference || ('SALE-' + Date.now())
                });
            });
            try {
                localStorage.setItem('dynapharm_inventory', JSON.stringify(inventory));
                // Broadcast stock update event for real-time sync across portals
                try {
                    const branchId = (currentUser && currentUser.branch) || 'unknown';
                    window.dispatchEvent(new CustomEvent('stock:updated', { 
                        detail: { branch: branchId, products: products, user: userFullName, reference } 
                    }));
                    // Publish to Railway gateway
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products, ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    // Also publish to Vercel SSE
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products, ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
            } catch (e) {
                console.warn('Inventory persistence warning:', e);
            }
            return { success: errors.length === 0, errors };
        }

        // Append a stock audit entry compatible with dyna_stock_audit used by stock APIs
        function appendStockAudit(action, details) {
            try {
                const key = 'dyna_stock_audit';
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                list.push({
                    id: 'AUD' + Date.now(),
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                });
                if (list.length > 5000) list.shift();
                localStorage.setItem(key, JSON.stringify(list));
            } catch (e) {
                console.warn('Audit append failed:', e);
            }
        }

        // FEFO-based deduction for prescription items using barcode/batch stock
        // products: [{ name, quantity }]
        async function fefoDispenseProducts(products, branchId, userFullName, reference) {
            const errors = [];
            const successes = [];
            try {
                if (!Array.isArray(products) || products.length === 0) return { success: true, errors: [], successes: [] };
                // Dynamic import ensures we don't hard-couple this file to modules at parse time
                const mod = await import('/web-modules/barcode-stock.js');
                for (const prod of products) {
                    const productName = (prod && (prod.name || prod.productName)) || '';
                    let needed = Number(prod && prod.quantity) || 0;
                    if (!productName || needed <= 0) continue;

                    // Get FEFO-ordered batches and enforce not expired
                    const fefo = mod.getFEFOStock(productName, needed);
                    if (!fefo || !fefo.success) {
                        errors.push(`No stock available for ${productName}`);
                        continue;
                    }
                    const batches = (fefo.data || []).filter(b => {
                        try {
                            const expiry = new Date((b.expiryDate || '') + '-01');
                            return expiry >= new Date();
                        } catch (_) {
                            return true; // if bad date, allow but module also guards quantity
                        }
                    });

                    for (const batch of batches) {
                        if (needed <= 0) break;
                        const available = Number(batch.remainingQuantity) || 0;
                        if (available <= 0) continue;
                        const take = Math.min(available, needed);
                        // Use sellStockByBarcode to model dispense (retail) and update batch
                        const sale = mod.sellStockByBarcode(batch.barcode, take, 'retail', branchId);
                        if (!sale || !sale.success) {
                            errors.push(`Failed to deduct ${take} of ${productName} from batch ${batch.batchNo || ''}`);
                            continue;
                        }
                        needed -= take;
                        successes.push({ product: productName, quantity: take, batchNo: batch.batchNo, barcode: batch.barcode });
                        appendStockAudit('dispense_fefo', {
                            reference: reference,
                            branch: branchId,
                            product: productName,
                            quantity: take,
                            batchNo: batch.batchNo,
                            barcode: batch.barcode,
                            user: userFullName || 'system'
                        });
                        try {
                            await recordStockMovement({
                                type: 'dispense',
                                product: productName,
                                quantity: take,
                                batchNo: batch.batchNo,
                                branchId: branchId,
                                reference: reference,
                                createdBy: userFullName || 'system'
                            });
                        } catch(_){}
                    }

                    if (needed > 0) {
                        errors.push(`Insufficient FEFO stock for ${productName} (short ${needed})`);
                    }
                }
            } catch (e) {
                errors.push('FEFO dispense error: ' + (e && e.message ? e.message : String(e)));
            }
            // Broadcast stock update event for real-time sync across portals
            if (products.length > 0) {
                try {
                    window.dispatchEvent(new CustomEvent('stock:updated', { 
                        detail: { branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), user: userFullName, reference } 
                    }));
                    // Publish to Railway gateway
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    // Also publish to Vercel SSE
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
            }
            return { success: errors.length === 0, errors, successes };
        }

        // Record a department notification event for MIS/Finance/Stock/GM/Director
        function recordDepartmentEvent(eventType, payload) {
            const recipients = ['MIS', 'Finance', 'Stock', 'GM', 'Director'];
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            events.push({
                id: 'EVT-' + Date.now(),
                type: eventType,
                recipients: recipients,
                payload: payload,
                createdAt: new Date().toISOString(),
                createdBy: (window.currentUser && window.currentUser.fullName) || 'system'
            });
            localStorage.setItem('dyna_department_events', JSON.stringify(events));
        }
        
        // Generate and display daily operations report
        function openDailyReportWindow() {
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayEvents = events.filter(e => e.createdAt.startsWith(today));
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]').filter(s => s.timestamp && s.timestamp.startsWith(today));
            const dispensedPrescriptions = (reports || []).filter(r => r.dispensed && r.dispensedAt && r.dispensedAt.startsWith(today));
            const onlineOrdersLocal = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]').filter(o => (o.dispensedAt && o.dispensedAt.startsWith(today)) || ((o.date||'').startsWith(today) && (o.status==='paid' || o.status==='dispensed')));
            const allClients = clients || [];
            const totalSalesAmount = walkInSales.reduce((sum, s) => sum + (s.total || 0), 0) + dispensedPrescriptions.reduce((sum, r) => sum + (r.medicines || []).reduce((medsum, m) => medsum + (m.amountPaid || 0), 0), 0) + onlineOrdersLocal.reduce((sum, o) => sum + (o.total || 0), 0);

            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Operations Report - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                        .header { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
                        .header h1 { color: #c41e3a; margin: 0 0 10px 0; }
                        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
                        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #c41e3a; }
                        .kpi-card h3 { color: #666; font-size: 0.9rem; margin: 0 0 10px 0; text-transform: uppercase; }
                        .kpi-card .value { color: #c41e3a; font-size: 2rem; font-weight: bold; margin: 10px 0; }
                        .section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .section h2 { color: #c41e3a; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; color: #c41e3a; font-weight: bold; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 0.9rem; }
                        @media print { body { background: white; } .section { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä DAILY OPERATIONS REPORT</h1>
                        <p>Dynapharm International Namibia</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')} | Generated: ${new Date().toLocaleString('en-GB')}</p>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <h3>Today's Sales</h3>
                            <div class="value">N$${totalSalesAmount.toFixed(2)}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Walk-in Sales</h3>
                            <div class="value">${walkInSales.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Online Sales</h3>
                            <div class="value">${onlineOrdersLocal.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Prescriptions Dispensed</h3>
                            <div class="value">${dispensedPrescriptions.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>New Clients</h3>
                            <div class="value">${allClients.filter(c => c.timestamp && c.timestamp.startsWith(today)).length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Department Events</h3>
                            <div class="value">${todayEvents.length}</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>üìß Department Events (Last 20)</h2>
                        <table>
                            <thead><tr><th>Time</th><th>Type</th><th>Details</th><th>Created By</th></tr></thead>
                            <tbody>
                                ${events.slice(-20).reverse().map(e => `<tr>
                                    <td>${new Date(e.createdAt).toLocaleString()}</td>
                                    <td>${e.type}</td>
                                    <td>${JSON.stringify(e.payload).substring(0, 50)}...</td>
                                    <td>${e.createdBy}</td>
                                </tr>`).join('') || '<tr><td colspan="4" style="text-align: center;">No events today</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>üõí Recent Walk-in Sales</h2>
                        <table>
                            <thead><tr><th>Time</th><th>Customer</th><th>Branch</th><th>Amount</th></tr></thead>
                            <tbody>
                                ${walkInSales.slice(-10).reverse().map(s => `<tr>
                                    <td>${new Date(s.timestamp).toLocaleString()}</td>
                                    <td>${s.customerName}</td>
                                    <td>${s.branch}</td>
                                    <td>N$${(s.total || 0).toFixed(2)}</td>
                                </tr>`).join('') || '<tr><td colspan="4" style="text-align: center;">No sales today</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div class="footer">
                        <p>Report generated for: MIS, Finance, Stock, GM, Director</p>
                        <p style="margin-top: 10px;"><strong>HEALTH | WEALTH | FREEDOM</strong></p>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            win.document.write(reportHTML);
            win.document.close();
        }

        // View department events in a modal
        function viewDepartmentEvents() {
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            if (events.length === 0) {
                alert('No department events recorded yet.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>üìß Department Events Log</h2>
                    <div style="margin: 20px 0;">
                        <input type="text" id="eventsSearch" placeholder="Search events..." style="padding: 10px; width: 100%; margin-bottom: 10px;" onkeyup="filterEvents(this.value)">
                        <select id="eventsFilter" style="padding: 10px; width: 100%;" onchange="filterEvents(document.getElementById('eventsSearch').value)">
                            <option value="all">All Event Types</option>
                            <option value="walkin_sale">Walk-in Sales</option>
                            <option value="prescription_dispensed">Prescription Dispensed</option>
                        </select>
                    </div>
                    <div id="eventsList">${renderEventsList(events)}</div>
                </div>
            `;
            document.body.appendChild(modal);

            window.filterEvents = function(searchTerm) {
                const filterType = document.getElementById('eventsFilter').value;
                let filtered = events;
                if (filterType !== 'all') filtered = filtered.filter(e => e.type === filterType);
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    filtered = filtered.filter(e => JSON.stringify(e).toLowerCase().includes(search));
                }
                document.getElementById('eventsList').innerHTML = renderEventsList(filtered);
            };
        }

        function renderEventsList(events) {
            return events.reverse().map(e => `
                <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #c41e3a;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong style="color: #c41e3a;">${e.type}</strong>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">${new Date(e.createdAt).toLocaleString()}</p>
                            <p style="margin: 5px 0; color: #666;">By: ${e.createdBy}</p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #3498db;">View Details</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(e.payload, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Appointments tracking
        let appointments = [];
        
        // Visits tracking (created at check-in)
        let visits = [];
        
        // Time slots configuration
        let timeSlots = {
            morning: { start: '08:00', end: '12:00', interval: 30 },
            afternoon: { start: '13:00', end: '17:00', interval: 30 }
        };
		(function restoreTimeSlotsFromStorage() {
			try {
				const saved = JSON.parse(localStorage.getItem('dyna_time_slots') || 'null');
				if (saved && typeof saved === 'object') {
					timeSlots = {
						morning: { ...timeSlots.morning, ...(saved.morning || {}) },
						afternoon: { ...timeSlots.afternoon, ...(saved.afternoon || {}) }
					};
				}
			} catch (_) {}
		})();
        
        // Resources (consultants, dispensers, rooms)
        let resources = [];
        
        // Appointment reminders queue
        let reminderQueue = [];
        
        let lastDataHash = null;
        
        // API Configuration
        // IMPORTANT: Set your actual Railway/backend URL here
        // For now, this is commented out. Uncomment and update when you have a deployed backend.
        function normaliseApiBase(input) {
            if (!input) return null;
            let base = String(input).trim();
            if (!base) return null;
            if (base.startsWith('http://') || base.startsWith('https://')) {
                return base.replace(/\/+$/, '');
            }
            if (base.startsWith('//')) {
                const protocol = window.location?.protocol || 'https:';
                return `${protocol}${base}`.replace(/\/+$/, '');
            }
            if (base.startsWith('/')) {
                if (window.location?.origin && window.location.origin !== 'null') {
                    return `${window.location.origin}${base}`.replace(/\/+$/, '');
                }
                return `http://localhost:8001${base}`.replace(/\/+$/, '');
            }
            try {
                const url = new URL(base);
                return url.origin.replace(/\/+$/, '') + url.pathname.replace(/\/+$/, '');
            } catch (_) {
                return null;
            }
        }

        function resolveApiBase() {
            const candidates = [];
            const metaTag = document.querySelector('meta[name="api-base"]');
            if (metaTag?.content) candidates.push(metaTag.content);
            if (window.API_BASE_OVERRIDE) candidates.push(window.API_BASE_OVERRIDE);
            try {
                const stored = localStorage.getItem('dynapharm_api_base');
                if (stored) candidates.push(stored);
            } catch (_) {}

            const hostname = window.location?.hostname || '';
            const port = window.location?.port || '';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            const isStaticDev = isLocalhost && (port === '8000' || port === '4173');

            if (isStaticDev) {
                candidates.push('http://localhost:8001/api');
            }

            if (window.location?.origin && window.location.origin !== 'null') {
                candidates.push(`${window.location.origin.replace(/\/$/, '')}/api`);
            }

            if (isLocalhost && !isStaticDev) {
                candidates.push('http://localhost:8001/api');
            }

            candidates.push('https://dynapharm-backend-production.up.railway.app/api');

            for (const candidate of candidates) {
                const resolved = normaliseApiBase(candidate);
                if (resolved) return resolved;
            }
            return '/api';
        }

        const API_BASE = resolveApiBase();
        const API_BASE_LOCAL = (() => {
            const overrides = [
                window.API_BASE_LOCAL_OVERRIDE,
                (() => { try { return localStorage.getItem('dynapharm_api_base_local'); } catch (_) { return null; } })()
            ];

            const hostname = window.location?.hostname || '';
            const port = window.location?.port || '';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            const isStaticDev = isLocalhost && (port === '8000' || port === '4173');

            if (isStaticDev) {
                overrides.push('http://localhost:8001/api');
            }

            overrides.push(API_BASE);

            if (isLocalhost && !isStaticDev) {
                overrides.push('http://localhost:8001/api');
            }

            for (const candidate of overrides) {
                const resolved = normaliseApiBase(candidate);
                if (resolved) return resolved;
            }
            return API_BASE;
        })();
        const USE_OFFLINE_MODE = false; // Prefer online API; only fallback if truly offline

        (function patchFetchForApiRouting(){
            if (typeof window === 'undefined' || typeof window.fetch !== 'function') return;
            const nativeFetch = window.fetch.bind(window);
            const apiBase = API_BASE;

            function normaliseEndpoint(endpoint) {
                const base = apiBase.replace(/\/+$/, '');
                const suffix = endpoint.replace(/^\/api/, '');
                return `${base}${suffix}`;
            }

            window.fetch = function patchedFetch(input, init) {
                try {
                    if (typeof input === 'string' && input.startsWith('/api/')) {
                        return nativeFetch(normaliseEndpoint(input), init);
                    }

                    if (typeof Request !== 'undefined' && input instanceof Request) {
                        const url = input.url;
                        const isRelativeApi = url.startsWith('/api/');
                        if (isRelativeApi) {
                            const rewritten = normaliseEndpoint(url);
                            const cloned = new Request(rewritten, input);
                            return nativeFetch(cloned, init);
                        }
                    }
                } catch (err) {
                    console.warn('API fetch patch failed; falling back to native fetch', err);
                }
                return nativeFetch(input, init);
            };
        })();

        const LEAVE_CACHE_PRIMARY_KEY = 'hr_leave_requests';
        const LEAVE_CACHE_LEGACY_KEYS = ['leaveRequests', 'branch_leave_requests'];
        const LEAVE_PENDING_QUEUE_KEY = 'hr_leave_requests_pending';
        const LEAVE_API_ENDPOINT = '/leave';

        const CASH_CACHE_PRIMARY_KEY = 'finance_cash_requests';
        const CASH_CACHE_LEGACY_KEYS = ['cashRequests', 'branch_cash_requests'];
        const CASH_PENDING_QUEUE_KEY = 'finance_cash_requests_pending';
        const CASH_API_ENDPOINT = '/branch/cash-requests';

        // Safe JSON parse with default fallback
        function safeParseFromStorage(key, defaultJsonString) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return JSON.parse(defaultJsonString);
                const parsed = JSON.parse(raw);
                if (parsed === null || parsed === undefined) return JSON.parse(defaultJsonString);
                return parsed;
            } catch (e) {
                return JSON.parse(defaultJsonString);
            }
        }

        let lastBranchSyncTs = 0;
        let lastProductSyncTs = 0;
        let lastBarcodeSyncTs = 0;

        function createSlugId(input, fallbackPrefix = 'item') {
            if (!input) return `${fallbackPrefix}-${Date.now().toString(36)}`;
            return String(input)
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                || `${fallbackPrefix}-${Date.now().toString(36)}`;
        }

        async function fetchJsonFromApi(endpoint, fallbackData = null) {
            try {
                const response = await fetch(endpoint, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.warn(`Request failed for ${endpoint}:`, error);
                return fallbackData;
            }
        }

        async function syncBranchesFromBackend(force = false) {
            try {
                if (!force && Date.now() - lastBranchSyncTs < 60000) return;
                lastBranchSyncTs = Date.now();
                const apiEndpoint = `${API_BASE}/branches`;
                const apiData = await fetchJsonFromApi(apiEndpoint, null);
                const list = Array.isArray(apiData) ? apiData : (apiData && Array.isArray(apiData.branches) ? apiData.branches : []);
                if (!list.length) return;
                branches = list.map(item => {
                    const name = item.name || item.branch || item.branch_name || item.title || 'Branch';
                    const id = item.id || item.branch_id || createSlugId(name, 'branch');
                    return {
                        id,
                        name,
                        location: item.location || item.address || item.city || '',
                        phone: item.phone || item.telephone || item.mobile || item.contact_number || ''
                    };
                });
                try { localStorage.setItem('dyna_branches', JSON.stringify(branches)); } catch (_) {}
                if (typeof loadBranches === 'function') loadBranches();
                if (typeof loadBranchesForDistribution === 'function') loadBranchesForDistribution();
                if (typeof populateSharingLocations === 'function') populateSharingLocations();
                if (typeof populateTransferBranchOptions === 'function') populateTransferBranchOptions();
                if (typeof loadTransferFromProducts === 'function') loadTransferFromProducts();
                if (typeof loadShopWarehouseSharing === 'function') loadShopWarehouseSharing();
                if (typeof populateInvoiceBranchFilter === 'function') populateInvoiceBranchFilter();
                if (typeof refreshBranchDirectory === 'function') {
                    try { refreshBranchDirectory(branches); } catch (_) {}
                }
            } catch (error) {
                console.warn('Branch synchronisation failed:', error);
            }
        }

        async function syncProductsFromBackend(force = false) {
            try {
                if (!force && Date.now() - lastProductSyncTs < 60000) return;
                lastProductSyncTs = Date.now();
                const apiEndpoint = `${API_BASE}/products`;
                const apiData = await fetchJsonFromApi(apiEndpoint, null);
                const list = Array.isArray(apiData) ? apiData : [];
                if (!list.length) return;
                const normalized = list.map(item => {
                    const description = item.description || item.name || item.productName || item.title || 'Product';
                    const id = item.id || item.sku || createSlugId(description, 'prod');
                    return {
                        id,
                        sku: item.sku || null,
                        name: item.name || description,
                        description,
                        category: item.category || null,
                        unit: item.unit || 'units',
                        dp: Number(item.dp ?? item.price ?? item.retailPrice ?? 0),
                        cp: Number(item.cp ?? item.costPrice ?? item.purchasePrice ?? item.dp ?? 0),
                        bv: Number(item.bv ?? item.businessVolume ?? 0),
                        tax_rate: Number(item.tax_rate ?? item.taxRate ?? 0),
                        is_active: item.is_active !== undefined ? item.is_active : true
                    };
                });
                try { localStorage.setItem('dyna_products', JSON.stringify(normalized)); } catch (_) {}
                window.PRICE_LIST = normalized.map(prod => ({
                    description: prod.description || prod.name,
                    dp: Number(prod.dp || 0),
                    cp: Number(prod.cp || 0),
                    bv: Number(prod.bv || 0)
                }));
                if (typeof loadShopProducts === 'function') {
                    try { loadShopProducts(); } catch (_) {}
                }
                if (typeof refreshRetailCatalogue === 'function') {
                    try { refreshRetailCatalogue(); } catch (_) {}
                }
            } catch (error) {
                console.warn('Product synchronisation failed:', error);
            }
        }

        function mapBatchToPortalStock(batch, overrides = {}) {
            const description = batch.description || batch.product_name || batch.productName || 'Product';
            const barcode = batch.barcode || overrides.barcode || '';
            const remaining = Number(batch.remainingQuantity ?? batch.remaining_quantity ?? batch.quantity ?? 0) || 0;
            const expiryRaw = batch.expiryDate || batch.expiry_date || batch.expiry || '';
            const normalizedExpiry = typeof normalizeExpiryInput === 'function'
                ? normalizeExpiryInput(expiryRaw || '')
                : (expiryRaw ? String(expiryRaw).slice(0, 7) : '');
            return {
                id: batch.id || createSlugId(description, 'batch'),
                productName: description,
                productCode: barcode || batch.product_id || batch.productId || '',
                category: overrides.category || 'Stock',
                quantity: remaining,
                unit: overrides.unit || batch.unit || 'units',
                batchNumber: batch.batchNo || batch.batch_no || '',
                expiryDate: normalizedExpiry || '',
                supplier: batch.cartonNo || batch.carton_no || overrides.supplier || 'N/A',
                cost: Number(overrides.cost || batch.unitCost || batch.cost || 0),
                receivedDate: batch.importDate || batch.import_date || batch.created_at || new Date().toISOString(),
                barcode,
                notes: overrides.notes || ''
            };
        }

        function applyBarcodeBatchesToState(batches, options = {}) {
            if (!Array.isArray(batches)) return;
            const persist = options.persist !== false;
            const normalized = batches.map((batch) => ({ ...batch }));

            if (persist) {
                try { localStorage.setItem('dyna_barcode_stock', JSON.stringify(normalized)); } catch (_) {}
            }

            const countryBatches = normalized.filter(b => (b.location || '').includes('country'));
            const windhoekBatches = normalized.filter(b => (b.location || '').includes('windhoek'));
            const ondangwaBatches = normalized.filter(b => (b.location || '').includes('ondangwa'));

            countryStock = countryBatches.map(batch => mapBatchToPortalStock(batch, { category: 'Country Stock' }));
            windhoekStock = windhoekBatches.map(batch => mapBatchToPortalStock(batch, { category: 'Windhoek Warehouse' }));
            ondangwaStock = ondangwaBatches.map(batch => mapBatchToPortalStock(batch, { category: 'Ondangwa Warehouse' }));

            try {
                localStorage.setItem('dyna_countryStock', JSON.stringify(countryStock));
                localStorage.setItem('dyna_windhoekStock', JSON.stringify(windhoekStock));
                localStorage.setItem('dyna_ondangwaStock', JSON.stringify(ondangwaStock));
            } catch (_) {}

            saveStockData();
            displayCountryStock();
            displayWindhoekStock();
            displayOndangwaStock();
            displayDistributionHistory();
            loadWindhoekProducts();
            loadOndangwaProducts();
            populateBranchDistributionProducts();
            updateWindhoekAvailableQuantity();
            updateOndangwaAvailableQuantity();
            updateBranchDistAvailableQty();
        }

        function getBarcodeStockList() {
            try {
                const raw = localStorage.getItem('dyna_barcode_stock');
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (_) {
                return [];
            }
        }

        function calculateAvailableQuantity(productName, locationMatch) {
            if (!productName) return 0;
            const name = String(productName).toLowerCase();
            const locationKey = String(locationMatch || '').toLowerCase();
            const batches = getBarcodeStockList().filter(batch => {
                const desc = (batch.description || batch.productName || '').toLowerCase();
                const loc = String(batch.location || '').toLowerCase();
                if (!desc || !loc) return false;
                return desc === name && (locationKey ? loc.includes(locationKey) : true);
            });
            return batches.reduce((sum, batch) => {
                const available = Number(batch.remainingQuantity ?? batch.remaining_quantity ?? batch.quantity ?? 0);
                return sum + (Number.isFinite(available) ? available : 0);
            }, 0);
        }

        function moveBarcodeStock(productName, quantity, fromLocation, toLocation, meta = {}) {
            const normalizedName = String(productName || '').toLowerCase();
            if (!normalizedName) return { success: false, message: 'Product required' };
            const qty = Number(quantity || 0);
            if (!Number.isFinite(qty) || qty <= 0) {
                return { success: false, message: 'Quantity must be greater than zero' };
            }
            const sourceKey = String(fromLocation || '').toLowerCase();
            const targetKey = String(toLocation || '').toLowerCase();
            const list = getBarcodeStockList();
            const eligible = list
                .filter(batch => {
                    const desc = (batch.description || batch.productName || '').toLowerCase();
                    const loc = String(batch.location || '').toLowerCase();
                    const status = (batch.status || 'available').toLowerCase();
                    return desc === normalizedName && loc.includes(sourceKey) && status === 'available';
                })
                .sort((a, b) => (a.expiryTimestamp || Infinity) - (b.expiryTimestamp || Infinity));

            let remaining = qty;
            const createdBatches = [];
            const now = new Date().toISOString();

            for (const batch of eligible) {
                if (remaining <= 0) break;
                const available = Number(batch.remainingQuantity ?? batch.remaining_quantity ?? batch.quantity ?? 0);
                if (!Number.isFinite(available) || available <= 0) continue;
                const take = Math.min(remaining, available);
                if (take <= 0) continue;

                const newBatch = {
                    ...batch,
                    id: `BATCH-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    barcode: batch.barcode || `BC${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6).toUpperCase()}`,
                    quantity: take,
                    remainingQuantity: take,
                    remaining_quantity: take,
                    location: targetKey,
                    status: 'available',
                    dispatchedQuantity: 0,
                    dispatched_quantity: 0,
                    importDate: batch.importDate || batch.import_date || now,
                    updatedAt: now,
                    transferReference: meta.reference || '',
                    transferNotes: meta.notes || '',
                    movementType: meta.movementType || 'transfer'
                };
                createdBatches.push(newBatch);
                list.push(newBatch);

                const newRemaining = available - take;
                batch.remainingQuantity = newRemaining < 0 ? 0 : newRemaining;
                batch.remaining_quantity = batch.remainingQuantity;
                batch.quantity = Math.max(Number(batch.quantity || 0) - take, 0);
                batch.dispatchedQuantity = Number(batch.dispatchedQuantity || 0) + take;
                batch.dispatched_quantity = batch.dispatchedQuantity;
                batch.updatedAt = now;
                batch.status = batch.remainingQuantity > 0 ? 'available' : 'dispatched';

                remaining -= take;
            }

            if (remaining > 0) {
                return { success: false, message: 'Insufficient stock available', shortfall: remaining };
            }

            applyBarcodeBatchesToState(list);
            return { success: true, batches: createdBatches };
        }

        function getWarehouseProductSummary(locationMatch) {
            const key = String(locationMatch || '').toLowerCase();
            const result = new Map();
            getBarcodeStockList().forEach(batch => {
                const loc = String(batch.location || '').toLowerCase();
                if (!loc.includes(key)) return;
                const name = batch.description || batch.productName || 'Product';
                const qty = Number(batch.remainingQuantity ?? batch.remaining_quantity ?? batch.quantity ?? 0);
                if (!Number.isFinite(qty) || qty <= 0) return;
                result.set(name, (result.get(name) || 0) + qty);
            });
            return result;
        }

        async function syncBarcodeStockFromBackend(force = false) {
            try {
                if (!force && Date.now() - lastBarcodeSyncTs < 20000) return;
                lastBarcodeSyncTs = Date.now();
                const apiEndpoint = `${API_BASE}/stock-batches`;
                const apiData = await fetchJsonFromApi(apiEndpoint, null);
                const list = Array.isArray(apiData) ? apiData : [];
                if (!list.length) {
                    const cached = safeParseFromStorage('dyna_barcode_stock', '[]');
                    if (cached.length) {
                        applyBarcodeBatchesToState(cached, { persist: false });
                    }
                    return;
                }

                const normalizedBatches = list.map(batch => {
                    const expiryRaw = batch.expiryDate || batch.expiry_date || batch.expiry || '';
                    const normalizedExpiry = typeof normalizeExpiryInput === 'function'
                        ? normalizeExpiryInput(expiryRaw || '')
                        : (expiryRaw ? String(expiryRaw).slice(0, 7) : '');
                    const expiryTimestamp = normalizedExpiry ? new Date(`${normalizedExpiry}-01T00:00:00`).getTime() : null;
                    const quantity = Number(batch.quantity ?? batch.totalQuantity ?? 0) || 0;
                    const dispatched = Number(batch.dispatchedQuantity ?? batch.dispatched_quantity ?? 0) || 0;
                    let remaining = Number(batch.remainingQuantity ?? batch.remaining_quantity ?? (quantity - dispatched)) || 0;
                    if (remaining < 0) remaining = 0;
                    const locationRaw = batch.location || batch.warehouse_id || batch.warehouseId || '';
                    const location = String(locationRaw || 'country_stock').toLowerCase();
                    return {
                        id: batch.id || createSlugId(`${batch.description || 'batch'}-${Math.random()}`, 'batch'),
                        barcode: batch.barcode || '',
                        cartonNo: batch.cartonNo || batch.carton_no || '',
                        description: batch.description || batch.product_name || batch.productName || 'Product',
                        batchNo: batch.batchNo || batch.batch_no || '',
                        expiryDate: normalizedExpiry || '',
                        expiryTimestamp,
                        quantity,
                        totalCtns: Number(batch.totalCtns ?? batch.total_ctns ?? quantity) || quantity,
                        importDate: batch.importDate || batch.import_date || batch.created_at || new Date().toISOString(),
                        location,
                        status: batch.status || 'available',
                        dispatchedQuantity: dispatched,
                        remainingQuantity: remaining,
                        productId: batch.productId || batch.product_id || null,
                        metadata: batch.metadata || null
                    };
                });
                applyBarcodeBatchesToState(normalizedBatches);
            } catch (error) {
                console.warn('Barcode stock synchronisation failed:', error);
            }
        }

    document.addEventListener('DOMContentLoaded', () => {
        syncBranchesFromBackend().catch(err => console.debug('Branch sync (startup) error', err));
        syncProductsFromBackend().catch(err => console.debug('Product sync (startup) error', err));
        syncBarcodeStockFromBackend().catch(err => console.debug('Barcode stock sync (startup) error', err));

        loadBranchesForDistribution();
        populateTransferBranchOptions();
        loadWindhoekProducts();
        loadOndangwaProducts();
        populateBranchDistributionProducts();
        populateSharingLocations();
        applyAutoOrderSettings();
        applySyncSettings();
        loadStockOrders();
        loadShopWarehouseSharing();
        loadTransferFromProducts();
        loadStockTransfers();
        loadRealtimeSyncStatus();

        const windhoekProductSelect = document.getElementById('windhoekProduct');
        if (windhoekProductSelect) {
            windhoekProductSelect.addEventListener('change', updateWindhoekAvailableQuantity);
        }
        const ondangwaProductSelectNew = document.getElementById('ondangwaProductNew');
        if (ondangwaProductSelectNew) {
            ondangwaProductSelectNew.addEventListener('change', updateOndangwaAvailableQuantity);
        }
        const ondangwaProductSelectLegacy = document.getElementById('ondangwaProduct');
        if (ondangwaProductSelectLegacy) {
            ondangwaProductSelectLegacy.addEventListener('change', updateOndangwaAvailableQuantity);
        }
        const branchSource = document.getElementById('branchDistSourceWarehouse');
        if (branchSource) {
            branchSource.addEventListener('change', () => {
                populateBranchDistributionProducts();
            });
        }
        const branchProductSelect = document.getElementById('branchDistProduct');
        if (branchProductSelect) {
            branchProductSelect.addEventListener('change', updateBranchDistAvailableQty);
        }
        const transferFrom = document.getElementById('transferFromLocation');
        if (transferFrom) {
            transferFrom.addEventListener('change', () => {
                loadTransferFromProducts();
            });
        }
        const transferTo = document.getElementById('transferToLocation');
        if (transferTo) {
            transferTo.addEventListener('change', () => {
                const wrapper = document.getElementById('transferBranchSelect');
                if (wrapper) {
                    const showBranch = transferTo.value === 'branch';
                    wrapper.style.display = showBranch ? 'block' : 'none';
                    if (showBranch) populateTransferBranchOptions();
                }
                loadTransferFromProducts();
            });
        }
        const transferProduct = document.getElementById('transferProduct');
        if (transferProduct) {
            transferProduct.addEventListener('change', updateTransferAvailableQty);
        }
        const transferBranchWrapper = document.getElementById('transferBranchSelect');
        if (transferBranchWrapper) {
            transferBranchWrapper.style.display = transferTo && transferTo.value === 'branch' ? 'block' : 'none';
        }
        const manualOrderClose = document.getElementById('manualOrderModal');
        if (manualOrderClose) {
            manualOrderClose.addEventListener('click', (event) => {
                if (event.target && event.target.id === 'manualOrderModal') {
                    closeManualOrderModal();
                }
            });
        }
        stockApiReady.then(async (module) => {
            if (!module || typeof module.refreshStockData !== 'function') return;
            try {
                await module.refreshStockData();
            } catch (error) {
                console.debug('Stock API refresh failed during bootstrap', error);
            } finally {
                try { loadGMPendingInventoryApprovals(); } catch (_) {}
            }
        });
        updateTransferAvailableQty();
    });

        window.addEventListener('stock:updated', (event) => {
            logSyncEvent('stock', 'Stock portal broadcast update', { success: true, target: 'stock', detail: event && event.detail ? event.detail : null });
            syncBarcodeStockFromBackend(true).catch(err => console.debug('Barcode stock sync (event) error', err));
        });

        function getRecordCacheKey(record) {
            if (!record || typeof record !== 'object') return null;
            if (record.id) return String(record.id);
            if (record.offlineId) return String(record.offlineId);
            const staff = record.staff || record.employeeId || record.employee || record.fullName || '';
            const created =
                record.submittedAt ||
                record.createdAt ||
                record.created_at ||
                record.timestamp ||
                record.created ||
                '';
            const discriminator = record.type || record.purpose || record.reason || record.category || '';
            const fallback = `${staff}|${created}|${discriminator}`;
            return fallback || null;
        }

        function aggregateRecordsByKeys(keys) {
            const list = [];
            const seen = new Set();
            const targets = Array.isArray(keys) ? keys : keys ? [keys] : [];
            targets.forEach((key) => {
                if (!key) return;
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw || raw === 'null' || raw === 'undefined') return;
                    const parsed = JSON.parse(raw);
                    if (!Array.isArray(parsed)) return;
                    parsed.forEach((item) => {
                        if (!item || typeof item !== 'object') return;
                        const cacheKey = getRecordCacheKey(item);
                        if (cacheKey && seen.has(cacheKey)) return;
                        if (cacheKey) seen.add(cacheKey);
                        list.push(item);
                    });
                } catch (_) {
                    /* ignore parse failures */
                }
            });
            return list;
        }

        function writeRecordsToKeys(primaryKey, legacyKeys, records) {
            const serialised = JSON.stringify(Array.isArray(records) ? records : []);
            const targets = [primaryKey].concat(Array.isArray(legacyKeys) ? legacyKeys : []);
            targets.forEach((key, index) => {
                if (!key) return;
                try {
                    localStorage.setItem(key, serialised);
                } catch (error) {
                    if (index === 0) {
                        console.warn('Failed to persist cache record', key, error);
                    }
                }
            });
        }

        function loadPendingQueue(queueKey) {
            if (!queueKey) return [];
            try {
                const raw = localStorage.getItem(queueKey);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (_) {
                return [];
            }
        }

        function savePendingQueue(queueKey, queue) {
            if (!queueKey) return;
            try {
                localStorage.setItem(queueKey, JSON.stringify(Array.isArray(queue) ? queue : []));
            } catch (error) {
                console.warn('Failed to persist pending queue', queueKey, error);
            }
        }

        function enqueuePendingRequest(queueKey, entry) {
            if (!queueKey || !entry) return;
            const queue = loadPendingQueue(queueKey).filter((item) => item && item.id !== entry.id);
            queue.push(entry);
            savePendingQueue(queueKey, queue);
        }

        function removePendingRequest(queueKey, recordId) {
            if (!queueKey || !recordId) return;
            const queue = loadPendingQueue(queueKey).filter((item) => item && item.id !== recordId);
            savePendingQueue(queueKey, queue);
        }

        function sortRecordsNewest(records, primaryField, secondaryField) {
            return (records || []).slice().sort((a, b) => {
                const aDate =
                    new Date(a?.[primaryField] || a?.[secondaryField] || a?.createdAt || a?.created_at || 0).getTime() || 0;
                const bDate =
                    new Date(b?.[primaryField] || b?.[secondaryField] || b?.createdAt || b?.created_at || 0).getTime() || 0;
                return bDate - aDate;
            });
        }

        function getLeaveCacheRecords() {
            return aggregateRecordsByKeys([LEAVE_CACHE_PRIMARY_KEY].concat(LEAVE_CACHE_LEGACY_KEYS));
        }

        function setLeaveCacheRecords(records) {
            const sorted = sortRecordsNewest(records, 'submittedAt', 'createdAt');
            writeRecordsToKeys(LEAVE_CACHE_PRIMARY_KEY, LEAVE_CACHE_LEGACY_KEYS, sorted);
        }

        function upsertLeaveCacheRecord(record) {
            if (!record) return getLeaveCacheRecords();
            const key = getRecordCacheKey(record);
            const next = getLeaveCacheRecords().filter((item) => getRecordCacheKey(item) !== key);
            next.push(record);
            setLeaveCacheRecords(next);
            return next;
        }

        function removeLeaveCacheRecord(recordId) {
            if (!recordId) return;
            const next = getLeaveCacheRecords().filter((item) => getRecordCacheKey(item) !== String(recordId));
            setLeaveCacheRecords(next);
        }

        function getCashCacheRecords() {
            return aggregateRecordsByKeys([CASH_CACHE_PRIMARY_KEY].concat(CASH_CACHE_LEGACY_KEYS));
        }

        function setCashCacheRecords(records) {
            const sorted = sortRecordsNewest(records, 'createdAt', 'submittedAt');
            writeRecordsToKeys(CASH_CACHE_PRIMARY_KEY, CASH_CACHE_LEGACY_KEYS, sorted);
        }

        function upsertCashCacheRecord(record) {
            if (!record) return getCashCacheRecords();
            const key = getRecordCacheKey(record);
            const next = getCashCacheRecords().filter((item) => getRecordCacheKey(item) !== key);
            next.push(record);
            setCashCacheRecords(next);
            return next;
        }

        function removeCashCacheRecord(recordId) {
            if (!recordId) return;
            const next = getCashCacheRecords().filter((item) => getRecordCacheKey(item) !== String(recordId));
            setCashCacheRecords(next);
        }

        function normalizeLeaveRecord(raw, context) {
            const ctx = context || {};
            const seed = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
            const candidateId =
                (raw &&
                    (raw.id ||
                        raw.leaveId ||
                        raw.leave_id ||
                        raw.requestId ||
                        raw.request_id ||
                        raw.reference ||
                        raw.uuid)) ||
                ctx.id;
            const id = candidateId ? String(candidateId) : `LV${seed}`.toUpperCase();
            const staff =
                raw?.staff ||
                raw?.staffUsername ||
                raw?.username ||
                raw?.userId ||
                raw?.user_id ||
                raw?.employeeId ||
                raw?.employee_id ||
                raw?.employeeCode ||
                ctx.defaultStaff ||
                null;
            const employeeName =
                raw?.employee ||
                raw?.employeeName ||
                raw?.employee_name ||
                raw?.fullName ||
                raw?.full_name ||
                raw?.staffName ||
                raw?.submittedBy ||
                raw?.requestedBy ||
                ctx.defaultStaffName ||
                staff ||
                'Unknown';
            const branch =
                raw?.branch ||
                raw?.branchId ||
                raw?.branch_id ||
                raw?.location ||
                ctx.defaultBranch ||
                null;
            const startDate =
                raw?.startDate || raw?.start_date || raw?.fromDate || raw?.from || raw?.start || ctx.startDate || null;
            const endDate = raw?.endDate || raw?.end_date || raw?.toDate || raw?.to || raw?.end || ctx.endDate || null;
            const reason = raw?.reason || raw?.comments || raw?.description || raw?.notes || raw?.note || ctx.reason || '';
            const urgent = Boolean(
                raw?.urgent ||
                raw?.isUrgent ||
                (typeof raw?.priority === 'string' && raw.priority.toLowerCase() === 'urgent') ||
                ctx.urgent
            );
            let statusValue = raw?.status || raw?.requestStatus || raw?.state || raw?.currentStatus || ctx.status || 'pending';
            statusValue = typeof statusValue === 'string' ? statusValue.trim().toLowerCase() : 'pending';
            let statusLabel = 'Pending';
            if (statusValue === 'approved') statusLabel = 'Approved';
            else if (statusValue === 'rejected') statusLabel = 'Rejected';
            else if (statusValue === 'cancelled') statusLabel = 'Cancelled';
            const submittedAt =
                raw?.submittedAt ||
                raw?.submitted_at ||
                raw?.createdAt ||
                raw?.created_at ||
                raw?.timestamp ||
                raw?.requestedAt ||
                ctx.submittedAt ||
                new Date().toISOString();
            const createdAt =
                raw?.createdAt ||
                raw?.created_at ||
                raw?.timestamp ||
                raw?.created ||
                submittedAt;
            let days = Number(raw?.days ?? raw?.duration ?? raw?.totalDays ?? raw?.total_days ?? ctx.days ?? 0);
            if (!Number.isFinite(days) || days <= 0) {
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    if (!Number.isNaN(start.valueOf()) && !Number.isNaN(end.valueOf())) {
                        const millis = end.setHours(12, 0, 0, 0) - start.setHours(12, 0, 0, 0);
                        if (Number.isFinite(millis) && millis >= 0) {
                            days = Math.floor(millis / (1000 * 60 * 60 * 24)) + 1;
                        }
                    }
                }
            }
            if (!Number.isFinite(days) || days <= 0) days = null;
            return {
                id,
                staff: staff || ctx.defaultStaff || null,
                employee: employeeName,
                fullName: employeeName,
                branch,
                type: raw?.type || raw?.leaveType || raw?.category || ctx.type || 'General Leave',
                startDate: startDate || null,
                endDate: endDate || null,
                reason: reason || '',
                urgent,
                status: statusLabel,
                statusRaw: statusValue,
                submittedAt,
                createdAt,
                days,
                pendingSync: Boolean(ctx.pendingSync || raw?.pendingSync),
                offlineId: ctx.offlineId || raw?.offlineId || null,
                source: ctx.source || raw?.source || 'api'
            };
        }

        function normalizeCashRecord(raw, context) {
            const ctx = context || {};
            const seed = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
            const candidateId =
                (raw && (raw.id || raw.requestId || raw.request_id || raw.reference || raw.uuid)) || ctx.id;
            const id = candidateId ? String(candidateId) : `CASH${seed}`.toUpperCase();
            const employeeId =
                raw?.employeeId ||
                raw?.employee_id ||
                raw?.userId ||
                raw?.user_id ||
                raw?.staff ||
                raw?.staffId ||
                ctx.defaultEmployeeId ||
                null;
            const employeeName =
                raw?.employee ||
                raw?.employeeName ||
                raw?.employee_name ||
                raw?.fullName ||
                raw?.full_name ||
                raw?.requestedBy ||
                ctx.defaultEmployeeName ||
                employeeId ||
                'Unknown';
            const branch =
                raw?.branch ||
                raw?.branchId ||
                raw?.branch_id ||
                raw?.location ||
                ctx.defaultBranch ||
                null;
            const amountCandidate = Number(
                raw?.amount ?? raw?.requestAmount ?? raw?.value ?? raw?.total ?? raw?.cash ?? ctx.amount ?? 0
            );
            const amount = Number.isFinite(amountCandidate) ? amountCandidate : 0;
            let statusValue = raw?.status || raw?.requestStatus || raw?.state || ctx.status || 'pending';
            statusValue = typeof statusValue === 'string' ? statusValue.trim().toLowerCase() : 'pending';
            const status = statusValue === 'approved' ? 'approved' : statusValue === 'rejected' ? 'rejected' : 'pending';
            const createdAt =
                raw?.createdAt ||
                raw?.created_at ||
                raw?.timestamp ||
                raw?.requestedAt ||
                raw?.created ||
                ctx.createdAt ||
                new Date().toISOString();
            return {
                id,
                employeeId: employeeId || ctx.defaultEmployeeId || null,
                employee: employeeName,
                branch,
                amount,
                purpose: raw?.purpose || raw?.reason || raw?.description || raw?.notes || ctx.purpose || '',
                urgent: Boolean(
                    raw?.urgent ||
                    raw?.isUrgent ||
                    (typeof raw?.priority === 'string' && raw.priority.toLowerCase() === 'urgent') ||
                    ctx.urgent
                ),
                status,
                createdAt,
                pendingSync: Boolean(ctx.pendingSync || raw?.pendingSync),
                offlineId: ctx.offlineId || raw?.offlineId || null,
                source: ctx.source || raw?.source || 'api'
            };
        }

        async function fetchLeaveRecordsIncludingOffline(options = {}) {
            const opts = options || {};
            let records = [];
            try {
                const response = await apiRequest(LEAVE_API_ENDPOINT, 'GET');
                const fetched = extractArray(response, []);
                const normalized = fetched
                    .map((item) =>
                        normalizeLeaveRecord(item, {
                            defaultStaff: currentUser?.username || null,
                            defaultStaffName: currentUser?.fullName || null,
                            defaultBranch: currentBranch || null,
                            source: 'api'
                        })
                    )
                    .filter(Boolean);
                setLeaveCacheRecords(normalized);
                records = normalized;
            } catch (error) {
                console.debug('fetchLeaveRecordsIncludingOffline fallback', error?.message || error);
                records = getLeaveCacheRecords();
            }
            const offlineQueue = loadPendingQueue(LEAVE_PENDING_QUEUE_KEY).map((entry) =>
                normalizeLeaveRecord(
                    Object.assign({ id: entry?.id }, entry?.payload || {}),
                    {
                        defaultStaff: currentUser?.username || null,
                        defaultStaffName: currentUser?.fullName || null,
                        defaultBranch: currentBranch || null,
                        pendingSync: true,
                        source: 'offline'
                    }
                )
            );
            const combined = [];
            const seen = new Set();
            records.concat(offlineQueue).forEach((record) => {
                if (!record) return;
                const key = getRecordCacheKey(record);
                if (key && seen.has(key)) return;
                if (key) seen.add(key);
                combined.push(record);
            });
            if (opts.onlyPending) {
                return combined.filter((record) => (record.statusRaw || record.status || '').toLowerCase() === 'pending');
            }
            return combined;
        }

        async function fetchCashRecordsIncludingOffline(options = {}) {
            const opts = options || {};
            let records = [];
            try {
                const response = await apiRequest(CASH_API_ENDPOINT, 'GET');
                const fetched = extractArray(response, []);
                const normalized = fetched
                    .map((item) =>
                        normalizeCashRecord(item, {
                            defaultEmployeeId: currentUser?.username || null,
                            defaultEmployeeName: currentUser?.fullName || null,
                            defaultBranch: currentBranch || null,
                            source: 'api'
                        })
                    )
                    .filter(Boolean);
                setCashCacheRecords(normalized);
                records = normalized;
            } catch (error) {
                console.debug('fetchCashRecordsIncludingOffline fallback', error?.message || error);
                records = getCashCacheRecords();
            }
            const offlineQueue = loadPendingQueue(CASH_PENDING_QUEUE_KEY).map((entry) =>
                normalizeCashRecord(
                    Object.assign({ id: entry?.id }, entry?.payload || {}),
                    {
                        defaultEmployeeId: currentUser?.username || null,
                        defaultEmployeeName: currentUser?.fullName || null,
                        defaultBranch: currentBranch || null,
                        pendingSync: true,
                        source: 'offline'
                    }
                )
            );
            const combined = [];
            const seen = new Set();
            records.concat(offlineQueue).forEach((record) => {
                if (!record) return;
                const key = getRecordCacheKey(record);
                if (key && seen.has(key)) return;
                if (key) seen.add(key);
                combined.push(record);
            });
            if (opts.onlyPending) {
                return combined.filter((record) => (record.status || '').toLowerCase() === 'pending');
            }
            return combined;
        }

		const CRM_STORAGE_KEYS = {
			interactions: 'crm_portal_interactions',
			workflows: 'crm_portal_workflows',
			workflowLog: 'crm_portal_workflow_log',
			loyalty: 'crm_portal_loyalty'
		};

		(function bootstrapCRMPortalData() {
			crmPortalInteractions = safeParseFromStorage(CRM_STORAGE_KEYS.interactions, '[]');
			if (!Array.isArray(crmPortalInteractions)) crmPortalInteractions = [];
			crmPortalWorkflows = safeParseFromStorage(CRM_STORAGE_KEYS.workflows, '[]');
			if (!Array.isArray(crmPortalWorkflows)) crmPortalWorkflows = [];
			crmPortalWorkflowLog = safeParseFromStorage(CRM_STORAGE_KEYS.workflowLog, '[]');
			if (!Array.isArray(crmPortalWorkflowLog)) crmPortalWorkflowLog = [];
			crmLoyaltyMembers = safeParseFromStorage(CRM_STORAGE_KEYS.loyalty, '[]');
			if (!Array.isArray(crmLoyaltyMembers)) crmLoyaltyMembers = [];
		})();

        // Unified storage adapter (IndexedDB-first with localStorage fallback)
        const DYN_DB_NAME = 'DynapharmDB';
        const DYN_DB_VERSION = 3; // v3 adds 'stockMovements' store
        const DYN_CLIENTS_STORE = 'clients';
        const DYN_MOVEMENTS_STORE = 'stockMovements';

        let dynDb = null;

        (function wrapFetchWithApiBase(){
            if (typeof window === 'undefined') return;
            if (window.__dynapharmFetchWrapped) return;
            const nativeFetch = window.fetch ? window.fetch.bind(window) : null;
            if (!nativeFetch) return;
            const normalisedBase = API_BASE ? API_BASE.replace(/\/+$/, '') : '';
            const toApiUrl = (url) => {
                if (!url || !normalisedBase) return url;
                if (url.startsWith('/api')) {
                    return `${normalisedBase}${url.slice(4)}`;
                }
                return url;
            };
            window.fetch = function(input, init) {
                try {
                    if (typeof input === 'string') {
                        return nativeFetch(toApiUrl(input), init);
                    }
                    if (typeof Request !== 'undefined' && input instanceof Request) {
                        const newUrl = toApiUrl(input.url);
                        if (newUrl !== input.url) {
                            const rebuilt = new Request(newUrl, input);
                            return nativeFetch(rebuilt, init);
                        }
                    }
                } catch (err) {
                    console.warn('API fetch wrapper error', err);
                }
                return nativeFetch(input, init);
            };
            window.__dynapharmFetchWrapped = true;
        })();

        function openDynDb() {
            if (dynDb) return Promise.resolve(dynDb);
            return new Promise((resolve, reject) => {
                let request;
                try {
                    request = indexedDB.open(DYN_DB_NAME, DYN_DB_VERSION);
                } catch (e) {
                    return reject(e);
                }
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { dynDb = request.result; resolve(dynDb); };
                request.onupgradeneeded = (event) => {
                    const dbu = event.target.result;
                    // Ensure clients store exists
                    if (!dbu.objectStoreNames.contains(DYN_CLIENTS_STORE)) {
                        const store = dbu.createObjectStore(DYN_CLIENTS_STORE, { keyPath: 'referenceNumber' });
                        try { store.createIndex('fullName', 'fullName', { unique: false }); } catch(_){}
                        try { store.createIndex('phone', 'phone', { unique: false }); } catch(_){}
                        try { store.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                    }
                    // Ensure stock movements store exists
                    if (!dbu.objectStoreNames.contains(DYN_MOVEMENTS_STORE)) {
                        const m = dbu.createObjectStore(DYN_MOVEMENTS_STORE, { keyPath: 'id' });
                        try { m.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                        try { m.createIndex('branchId', 'branchId', { unique: false }); } catch(_){}
                        try { m.createIndex('type', 'type', { unique: false }); } catch(_){}
                    }
                };
            });
        }

        async function dbGetAll(storeName) {
            try {
                const dbu = await openDynDb();
                return await new Promise((resolve, reject) => {
                    const tx = dbu.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            } catch (e) {
                return null;
            }
        }

        async function dbBulkPut(storeName, items) {
            const dbu = await openDynDb();
            await new Promise((resolve, reject) => {
                const tx = dbu.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                // Clear before bulk put to mirror current behavior
                const clearReq = store.clear();
                clearReq.onsuccess = () => {
                    (items || []).forEach((item) => { try { store.put(item); } catch(_){} });
                };
                clearReq.onerror = () => reject(clearReq.error);
            });
        }

        async function dbAdd(storeName, item) {
            const dbu = await openDynDb();
            await new Promise((resolve, reject) => {
                const tx = dbu.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                try { store.put(item); } catch (e) { reject(e); }
            });
        }

        // --- Stock Movements: record locally in IDB and attempt cloud sync ---
        function getGitHubTokenForWrites(){
            try { return (window.cloudStorage && window.cloudStorage.getStoredToken && window.cloudStorage.getStoredToken()) || ''; } catch(_){ return ''; }
        }

        function getPendingMovements(){
            try { return JSON.parse(localStorage.getItem('dyna_pending_movements')||'[]'); } catch(_){ return []; }
        }
        function setPendingMovements(list){
            try { localStorage.setItem('dyna_pending_movements', JSON.stringify(list||[])); } catch(_){ }
        }

        async function recordStockMovement(movement){
            const normalized = Object.assign({
                id: movement.id || ('MOV-' + Date.now() + '-' + Math.random().toString(36).slice(2,8)),
                createdAt: new Date().toISOString()
            }, movement);
            try { await dbAdd(DYN_MOVEMENTS_STORE, normalized); } catch(_){ }
            // queue for server write
            const pending = getPendingMovements(); pending.push(normalized); setPendingMovements(pending);
            // try sync in background
            try { trySyncPendingMovements(); } catch(_){ }
            return normalized;
        }

        async function trySyncPendingMovements(){
            const token = getGitHubTokenForWrites();
            if (!token) return false;
            let pending = getPendingMovements();
            if (!Array.isArray(pending) || pending.length === 0) return true;
            const keep = [];
            for (const mov of pending){
                try {
                    const resp = await fetch('/api/stock-movements', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'x-github-token': token },
                        body: JSON.stringify({ movement: mov })
                    });
                    if (!resp.ok) { keep.push(mov); }
                } catch(_){ keep.push(mov); }
            }
            setPendingMovements(keep);
            return keep.length === 0;
        }

        async function rebuildBranchStockFromMovements(){
            try {
                // Comprehensive stock calculation from ALL sources
                
                // 1. Fetch cloud movements
                let cloud = [];
                try {
                    const r = await fetch('/api/stock-movements');
                    if (r.ok) cloud = await r.json();
                } catch(_){ cloud = []; }
                
                // 2. Local queued movements
                const localPending = getPendingMovements();
                
                // 3. Local IDB movements
                let localDb = [];
                try { localDb = await dbGetAll(DYN_MOVEMENTS_STORE) || []; } catch(_){ localDb = []; }
                
                // 4. Barcode stock batches (by location)
                const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                
                // 5. Distribution history (warehouse ‚Üí branch)
                const distributionHistory = JSON.parse(localStorage.getItem('dyna_distribution_history') || '[]');
                
                // 6. Stock transfers (country ‚Üí warehouse ‚Üí branch)
                const stockTransfers = JSON.parse(localStorage.getItem('dyna_stock_transfers') || '[]');
                
                // Combine all movement records
                const all = ([]).concat(
                    Array.isArray(cloud)?cloud:[],
                    Array.isArray(localDb)?localDb:[],
                    Array.isArray(localPending)?localPending:[]
                );
                
                // Initialize branch stock object
                const branchStock = {};
                
                // Process movement records
                for (const m of all){
                    const type = (m && m.type) || '';
                    const product = (m && m.product) || m.description || '';
                    const qty = Number(m && m.quantity || 0);
                    if (!product || !qty) continue;
                    
                    if (type === 'receive' || type === 'distribution'){
                        const dest = m.destination || m.branchId || m.toBranch || 'unknown';
                        branchStock[dest] = branchStock[dest] || {};
                        branchStock[dest][product] = (branchStock[dest][product] || 0) + qty;
                    } else if (type === 'transfer'){
                        const from = m.source || m.branchId || m.fromWarehouse || 'unknown';
                        const to = m.destination || m.toBranch || 'unknown';
                        branchStock[from] = branchStock[from] || {};
                        branchStock[to] = branchStock[to] || {};
                        branchStock[from][product] = (branchStock[from][product] || 0) - qty;
                        branchStock[to][product] = (branchStock[to][product] || 0) + qty;
                    } else if (type === 'adjust'){
                        const b = m.branchId || m.location || 'unknown';
                        branchStock[b] = branchStock[b] || {};
                        branchStock[b][product] = (branchStock[b][product] || 0) + qty; // qty can be negative
                    } else if (type === 'dispense' || type === 'sale'){
                        const b = m.branchId || m.branch || 'unknown';
                        branchStock[b] = branchStock[b] || {};
                        branchStock[b][product] = (branchStock[b][product] || 0) - qty;
                    }
                }
                
                // Process barcode stock batches by location (for branches)
                const branchNames = ['windhoek', 'ondangwa', 'oshakati', 'rundu', 'walvis bay', 'swakopmund'];
                barcodeStock.forEach(batch => {
                    if (!batch.location || !batch.description) return;
                    const location = batch.location.toLowerCase();
                    
                    // Check if location is a branch
                    const isBranch = branchNames.some(branch => location.includes(branch));
                    if (isBranch) {
                        const branchId = branchNames.find(b => location.includes(b)) || location;
                        branchStock[branchId] = branchStock[branchId] || {};
                        branchStock[branchId][batch.description] = (branchStock[branchId][batch.description] || 0) + (batch.remainingQuantity || 0);
                    }
                });
                
                // Process distribution history (warehouse ‚Üí branch)
                distributionHistory.forEach(dist => {
                    if (!dist.branch || !dist.product || !dist.quantity) return;
                    const branchId = dist.branch.toLowerCase();
                    branchStock[branchId] = branchStock[branchId] || {};
                    branchStock[branchId][dist.product] = (branchStock[branchId][dist.product] || 0) + Number(dist.quantity || 0);
                });
                
                // Process stock transfers (warehouse ‚Üí branch)
                stockTransfers.forEach(transfer => {
                    if (!transfer.toBranch || !transfer.items) return;
                    const branchId = transfer.toBranch.toLowerCase();
                    branchStock[branchId] = branchStock[branchId] || {};
                    
                    if (Array.isArray(transfer.items)) {
                        transfer.items.forEach(item => {
                            const product = item.product || item.name || item.description || '';
                            const qty = Number(item.quantity || 0);
                            if (product && qty > 0) {
                                branchStock[branchId][product] = (branchStock[branchId][product] || 0) + qty;
                            }
                        });
                    }
                });
                
                // Save calculated branch stock
                localStorage.setItem('dyna_branch_stock', JSON.stringify(branchStock));
                
                // Trigger event for real-time updates
                window.dispatchEvent(new CustomEvent('branch_stock:updated', { 
                    detail: { branchStock, timestamp: new Date().toISOString() } 
                }));
                
            } catch(error){ 
                console.error('Error rebuilding branch stock from movements:', error);
            }
        }

        // background timers
        setInterval(() => { try { trySyncPendingMovements(); } catch(_){} }, 15000);
        setInterval(() => { try { rebuildBranchStockFromMovements(); } catch(_){} }, 20000);
        // initial kick
        setTimeout(() => { try { trySyncPendingMovements(); rebuildBranchStockFromMovements(); } catch(_){} }, 1200);

        // Adapter: Clients
        async function loadClientsAdapter() {
            // PRIMARY: Load from backend database
            try {
                const response = await fetch('/api/clients');
                if (response.ok) {
                    const backendClients = await response.json();
                    // Transform backend format to local format
                    const clients = backendClients.map(client => ({
                        id: client.id,
                        referenceNumber: client.reference_number,
                        fullName: client.full_name,
                        phone: client.phone,
                        email: client.email,
                        gender: client.gender,
                        dateOfBirth: client.date_of_birth,
                        address: client.address,
                        city: client.city,
                        branch: client.branch,
                        ...(client.data ? (typeof client.data === 'string' ? JSON.parse(client.data) : client.data) : {}),
                        createdAt: client.created_at
                    }));
                    
                    // Update local cache
                    try {
                        await dbBulkPut(DYN_CLIENTS_STORE, clients);
                        localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    } catch(_) {}
                    
                    console.log(`‚úÖ Loaded ${clients.length} clients from backend database`);
                    return clients;
                }
            } catch (apiError) {
                console.warn('Backend load failed, using local cache:', apiError);
            }
            
            // FALLBACK: Try DB first
            const fromDb = await dbGetAll(DYN_CLIENTS_STORE);
            if (Array.isArray(fromDb)) return fromDb;
            // Fallback to localStorage
            return safeParseFromStorage('dyna_clients', '[]');
        }

        async function saveAllClientsAdapter(list) {
            // PRIMARY: Save to backend database
            try {
                if (Array.isArray(list) && list.length > 0) {
                    const response = await fetch('/api/clients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(list.map(client => ({
                            id: client.id || client.referenceNumber,
                            reference_number: client.referenceNumber || client.reference_number,
                            full_name: client.fullName || client.full_name,
                            phone: client.phone,
                            email: client.email,
                            gender: client.gender,
                            date_of_birth: client.dateOfBirth || client.date_of_birth,
                            address: client.address,
                            city: client.city,
                            branch: client.branch,
                            data: JSON.stringify(client)
                        })))
                    });
                    
                    if (response.ok) {
                        console.log(`‚úÖ Saved ${list.length} clients to backend database`);
                    }
                }
            } catch (apiError) {
                console.warn('Backend save failed, using local storage:', apiError);
            }
            
            // FALLBACK: Also save to local storage as cache
            try {
                if (Array.isArray(list)) {
                    await dbBulkPut(DYN_CLIENTS_STORE, list);
                }
            } catch(_) {}
            try { localStorage.setItem('dyna_clients', JSON.stringify(list || [])); } catch(_) {}
        }

        async function addClientAdapter(client) {
            const now = new Date().toISOString();
            const record = { createdAt: now, ...client };
            
            // PRIMARY: Save to backend database
            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: record.id || record.referenceNumber,
                        reference_number: record.referenceNumber || record.reference_number,
                        full_name: record.fullName || record.full_name,
                        phone: record.phone,
                        email: record.email,
                        gender: record.gender,
                        date_of_birth: record.dateOfBirth || record.date_of_birth,
                        address: record.address,
                        city: record.city,
                        branch: record.branch,
                        data: JSON.stringify(record)
                    })
                });
                
                if (response.ok) {
                    const saved = await response.json();
                    console.log('‚úÖ Client saved to backend database');
                    // Update record with saved data
                    Object.assign(record, saved);
                }
            } catch (apiError) {
                console.warn('Backend save failed, using local storage:', apiError);
            }
            
            // FALLBACK: Also save to local storage as cache
            try { await dbAdd(DYN_CLIENTS_STORE, record); } catch(_) {}
            try {
                const ls = safeParseFromStorage('dyna_clients', '[]');
                ls.push(record);
                localStorage.setItem('dyna_clients', JSON.stringify(ls));
            } catch(_) {}
            return { success: true };
        }

        // One-time migration from localStorage to IndexedDB for clients
        async function migrateClientsToIndexedDBIfNeeded() {
            try {
                const flagKey = 'migrated_clients_to_idb_v2';
                if (localStorage.getItem(flagKey) === 'true') return;
                const lsClients = safeParseFromStorage('dyna_clients', '[]');
                const dbClients = await dbGetAll(DYN_CLIENTS_STORE);
                if ((dbClients || []).length === 0 && (lsClients || []).length > 0) {
                    await dbBulkPut(DYN_CLIENTS_STORE, lsClients);
                    localStorage.setItem(flagKey, 'true');
                } else {
                    localStorage.setItem(flagKey, 'true');
                }
            } catch(_) {}
        }

        // Load persisted appointments/visits on startup (if present)
        try {
            const storedAppointments = localStorage.getItem('dyna_appointments');
            if (storedAppointments) { appointments = JSON.parse(storedAppointments) || []; }
        } catch(e) {}
        try {
            const storedVisits = localStorage.getItem('dyna_visits');
            if (storedVisits) { visits = JSON.parse(storedVisits) || []; }
        } catch(e) {}

        const DEFAULT_USERS_JSON = '[{"id":"USR001","username":"admin","password":"walker33","fullName":"Administrator","email":"admin@dynapharm.com.na","phone":"061-300877","role":"admin","branch":"townshop","branches":["townshop"]},{"id":"USR1759829667953","username":"moses","password":"walker33","fullName":"MOSES MUKISA","email":"mosesmukisa1@gmail.com","phone":"0817317160","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-07T09:34:27.953Z"},{"id":"USR1759829814781","username":"Geneva","password":"Pearl_11","fullName":"Jennifer Joseph","email":"shange1124@gmail.com","phone":"0852803618","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-07T09:36:54.781Z"},{"id":"USR1759830625722","username":"NAEM","password":"PASSWORD","fullName":"NAEM HANGULA","email":"naemhangula4@gmail.com","phone":"0817499757","role":"dispenser","branch":"townshop","branches":["townshop"],"createdAt":"2025-10-07T09:50:25.722Z"},{"id":"USR1759928153488","username":"GEINGOS","password":"ALBERTO99","fullName":"HILMA C","email":"geingoshilma@gmail","phone":"0814137106","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-08T12:55:53.488Z"},{"id":"USR2000000000001","username":"stock","password":"stock123","fullName":"Stock Manager","email":"stock@dynapharm.com.na","phone":"0812000000","role":"stock","branch":"townshop","branches":["townshop"],"createdAt":"2025-01-20T10:00:00.000Z"},{"id":"USR2000000000002","username":"mis","password":"mis123","fullName":"MIS Manager","email":"mis@dynapharm.com.na","phone":"0813000000","role":"mis","branch":"townshop","branches":["townshop"],"createdAt":"2025-01-20T10:00:00.000Z"}]';

        const DEFAULT_BRANCHES_JSON = '[{"id":"townshop","name":"TOWNSHOP (Head Office)","location":"Shop No.1 Continental Building Independence Avenue - Windhoek","phone":"814683999"},{"id":"khomasdal","name":"KHOMASDAL DPC","location":"Shop No.2 Khomasdal Funky Town - Windhoek","phone":"814682991"},{"id":"katima","name":"KATIMA DPC","location":"Opposite Open Market Hospital Road, Katima","phone":"817375818"},{"id":"outapi","name":"OUTAPI DPC","location":"Okasilili Location in Christmas Building, Next Tolemeka Garage Main Road Oshakati - Outapi","phone":"814685886"},{"id":"ondangwa","name":"ONDANGWA DPC","location":"Shop No.3 Woerman Block Oluno, Opposite Fresco, Cash and Carry Entrance Ondangwa","phone":"814685882"},{"id":"okongo","name":"OKONGO DPC","location":"Handongo Festus Erf 333 Okongo Village Council","phone":"814684935"},{"id":"okahao","name":"OKAHAO DPC","location":"Iteka complex opposite Pep store Okahao - Oshakati main road","phone":"814683963"},{"id":"nkurenkuru","name":"NKURENKURU DPC","location":"Total Service Station, Next to Oluno Bar - Nkurenkuru","phone":"814684939"},{"id":"swakopmund","name":"SWAKOPMUND DPC","location":"Opposite Mondesa Usave Swakopmund","phone":"814686806"},{"id":"hochland-park","name":"HOCHLAND PARK","location":"House No.2 Robin Road, Taubern Glain Street, Next to OK Food Windhoek","phone":"813207195"},{"id":"rundu","name":"RUNDU DPC","location":"Shop No.6 Fish Building opposite, Dr. Romanus Kampungi Stadium","phone":"814050125"},{"id":"gobabis","name":"GOBABIS","location":"Shop No. Church Street Woerman Complex Gobabis","phone":"814685905"},{"id":"walvisbay","name":"WALVISBAY","location":"Shop No.6 Pelican Mall Shop Sam Nujoma Avenue","phone":"814685894"},{"id":"eenhana","name":"EENHANA","location":"Shop No.3 Tangi Complex, Next to Namibia Funeral Supply, Dimo Amaambo Street Eenhana","phone":"814682049"},{"id":"otjiwarongo","name":"OTJIWARONGO DPC","location":"Erindi Complex next to Spar","phone":"814681997"}]';

        // Official Price List - June 2025
        const PRICE_LIST = [
            {description: "ARABICA COFFEE MIX W/GOAT'S AND GANO 25gx20's", dp: 260, cp: 320, bv: 43},
            {description: "BEE POLEN CAPSULE (30's)", dp: 182, cp: 237, bv: 32},
            {description: "BEE POLLEN CAPSULE (100's)", dp: 320, cp: 390, bv: 75},
            {description: "BODY CONTOUR CREAM", dp: 290, cp: 377, bv: 75},
            {description: "COMPACT POWDER 12g", dp: 190, cp: 247, bv: 55},
            {description: "D.I GROW (GREEN) (1 LITER)", dp: 300, cp: 390, bv: 38},
            {description: "D.I GROW (GREEN) (4LITERS)", dp: 650, cp: 780, bv: 115},
            {description: "D.I GROW (RED) (1 LITER)", dp: 240, cp: 312, bv: 38},
            {description: "D.I GROW (RED) (4LITERS)", dp: 560, cp: 728, bv: 115},
            {description: "D.I GROW BIO-8 1 LTR", dp: 220, cp: 286, bv: 27},
            {description: "D.I GROW K 1 LTR", dp: 220, cp: 286, bv: 30},
            {description: "D.I. INSTANT GOAT'S MILK POWDER PREMIX 20's x 21g", dp: 325, cp: 400, bv: 43},
            {description: "D.I. INSTANT SOYBEAN MIXTURE WITH GINGER 25g x 20'", dp: 221, cp: 287, bv: 38},
            {description: "DI LIQUID ALFALFA PLUS GUARANA (500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI LIQUID ALFALFAPLUS GUARANA (150ml)", dp: 200, cp: 260, bv: 21},
            {description: "DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml", dp: 430, cp: 530, bv: 75},
            {description: "Di Liquid Alpha Alpha 500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI NONI 500ml", dp: 350, cp: 455, bv: 110},
            {description: "DI NONI JUICE 1 L", dp: 750, cp: 950, bv: 175},
            {description: "DYNA C- 100 TABLET 150's", dp: 140, cp: 182, bv: 32},
            {description: "DYNA C- 250 TABLET 90's", dp: 140, cp: 182, bv: 27},
            {description: "DYNA 'S' TABLET 120's", dp: 290, cp: 360, bv: 65},
            {description: "DYNA SERENOA TABLET 100's", dp: 520, cp: 620, bv: 115},
            {description: "DYNA SERENOA TABLET 30's", dp: 195, cp: 254, bv: 38},
            {description: "DYNA TONIC (150ml)", dp: 208, cp: 270, bv: 27},
            {description: "DYNA TONIC (780ml)", dp: 600, cp: 710, bv: 120},
            {description: "DYNA TOOTHBRUSH (SET 3 OF 3)", dp: 70, cp: 91, bv: 15},
            {description: "DYNA-RH CAPSULE 100's", dp: 300, cp: 390, bv: 60},
            {description: "E-VITA CREAM (50g)", dp: 610, cp: 700, bv: 165},
            {description: "GANODERMA LOTION 150ML", dp: 182, cp: 237, bv: 38},
            {description: "GANODERMA SHOWER GEL 150ml(GANODERMA BODY SCRUB)", dp: 220, cp: 285, bv: 38},
            {description: "GANODERMA SOAP 2 x 100g", dp: 140, cp: 182, bv: 30},
            {description: "GANODERMA TOOTHPASTE (150g)", dp: 150, cp: 194, bv: 20},
            {description: "GINALI CAPSULE 100's", dp: 403, cp: 493, bv: 80},
            {description: "GINALI CAPSULE 30's", dp: 195, cp: 254, bv: 38},
            {description: "GINSENG CAPSULE 9 x 10's", dp: 546, cp: 655, bv: 115},
            {description: "GOAT'S MILK SOAP (100g)", dp: 70, cp: 91, bv: 15},
            {description: "GOAT'S MILK TABLET 150's", dp: 286, cp: 372, bv: 48},
            {description: "GOAT'S MILK TABLET 75's", dp: 170, cp: 221, bv: 27},
            {description: "GREEN TEA CAPSULE 30's", dp: 195, cp: 254, bv: 43},
            {description: "GREEN TEA CAPSULE 60's", dp: 344, cp: 430, bv: 85},
            {description: "HERBA WARISAN MAHARANI 6 x 10g", dp: 520, cp: 620, bv: 110},
            {description: "HIGH FIBER NUTRITION FOOD 30'sx25g", dp: 660, cp: 790, bv: 120},
            {description: "INSTANT CAPPUCCINO W/ GANO 15's x 35g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT CEREAL 15's x 32g", dp: 325, cp: 423, bv: 48},
            {description: "INSTANT CEREAL 30's x 32g", dp: 510, cp: 610, bv: 95},
            {description: "INSTANT CHOC W/ GANO 30's x 30g", dp: 325, cp: 423, bv: 43},
            {description: "INSTANT COFFEE MIX W/GANODERMA, COLLAGEN & KACIP", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE MIX W/TONGKAT & MACA POWDER(15'sx21g)", dp: 250, cp: 300, bv: 38},
            {description: "Tongkat Ali & Maca - C", dp: 250, cp: 300, bv: 38},
            {description: "INSTANT COFFEE MIX WITH GANODERMA 4-IN-1(SACHET) (20's x 21g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GANO, GREEN TEA 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GINKGO & GINSENG 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ TONGKAT ALI 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/GANO & TONGKAT ALI BLACK 30's x 5g", dp: 276, cp: 359, bv: 59},
            {description: "INSTANT GINSENG HONEY GINGER 500g", dp: 350, cp: 420, bv: 43},
            {description: "INSTANT PEGAGA CAF√â 25G x 15s", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT PREMIX COFFEE WITH MANGOSTEEN(25'sx15g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT WHEATGRASS W/ CHLOROPHYLL 20's x 10g", dp: 286, cp: 372, bv: 43},
            {description: "MILK TEA WITH TONGKAT ALI 21g x 20's", dp: 230, cp: 290, bv: 43},
            {description: "MILK THISTLE TABLET 120's", dp: 500, cp: 592, bv: 125},
            {description: "MILK THISTLE TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "MINERAL POT", dp: 1250, cp: 1625, bv: 265},
            {description: "Nano Home Feminine Wash Antiseptic w/ Sirih 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "Nano Home Feminine Wash Kacip Fatimah 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME FEMININE WASH with GAMAT 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME GAMAT SOAP 100g", dp: 70, cp: 91, bv: 15},
            {description: "NANO HOME PEGAGA SOAP 100g", dp: 70, cp: 91, bv: 8},
            {description: "NONI PLUS TEA 30's x 3g", dp: 299, cp: 360, bv: 65},
            {description: "NUTMEG OINTMENT (2's x 20g)", dp: 180, cp: 234, bv: 19.5},
            {description: "PRESIDENT'S CHOICE 4 IN 1 AND CHOCOLATE COFFEE 20'", dp: 288, cp: 374, bv: 43},
            {description: "PRO- LSB TABLET 150's", dp: 455, cp: 573, bv: 100},
            {description: "PROLINK 20's x 20g", dp: 588, cp: 688, bv: 135},
            {description: "PROLINK 30's x 20g", dp: 600, cp: 719, bv: 170},
            {description: "RED COFFEE W/ GINSENG (12's x 25g)", dp: 260, cp: 320, bv: 38},
            {description: "REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "SEA CUCUMBER JELLY (250ml)", dp: 312, cp: 406, bv: 55},
            {description: "SEA CUCUMBER JELLY (500ml)", dp: 533, cp: 633, bv: 110},
            {description: "SEA WATER SPIRULINA POWDER 500g", dp: 340, cp: 420, bv: 48},
            {description: "SOYBEAN POWDER 454g", dp: 260, cp: 338, bv: 38},
            {description: "SPIRULINA TABLET (1,000's)", dp: 750, cp: 900, bv: 150},
            {description: "SPIRULINA TABLET (100's)", dp: 208, cp: 270, bv: 27},
            {description: "SPIRULINA TABLET (300's)", dp: 351, cp: 456, bv: 64},
            {description: "TEA TREE OIL FEMININE WASH (250ml)", dp: 190, cp: 247, bv: 43},
            {description: "TEA TREE OIL LOTION (250ml)", dp: 180, cp: 234, bv: 19.5},
            {description: "TEA TREE OIL TOOTHPASTE (175g)", dp: 150, cp: 194, bv: 20},
            {description: "TONGKAT ALI CAPSULE 100's", dp: 400, cp: 490, bv: 80},
            {description: "TONGKAT ALI CAPSULE 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEGANO CAPSULE 30's", dp: 195, cp: 254, bv: 27},
            {description: "YEEGANO CAPSULE 90's", dp: 364, cp: 454, bv: 75},
            {description: "Yeeginako Tabs 90's , 30's", dp: 364, cp: 454, bv: 75},
            {description: "YEEGARLIC CAPSULE 90's", dp: 300, cp: 390, bv: 64},
            {description: "YEEGINKGO TABLET (30's)", dp: 234, cp: 304, bv: 27},
            {description: "YEEGINKGO TABLETS 90's", dp: 420, cp: 500, bv: 80},
            {description: "YEEYANGYEN TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEYANGYEN TABLET 90's", dp: 370, cp: 455, bv: 90}
        ];
        
        // Make PRICE_LIST globally accessible
        if (typeof window !== 'undefined') {
            window.PRICE_LIST = PRICE_LIST;
        }

        // Price lookup function with package support
        function findProductPrice(productName) {
            if (!productName) return {description: productName, dp: 0, cp: 0, bv: 0};
            
            // First check if it's a package - exact match
            if (PACKAGE_DATABASE.hasOwnProperty(productName)) {
                const packageData = PACKAGE_DATABASE[productName];
                return {
                    description: productName,
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            // Try fuzzy matching for packages (e.g., "Blood Circulation Package" -> "Blood Circulation Pack")
            const normalizedProductName = productName.toLowerCase().trim();
            const packageMatch = Object.keys(PACKAGE_DATABASE).find(key => {
                const normalizedKey = key.toLowerCase().trim();
                return normalizedKey === normalizedProductName ||
                       normalizedKey.replace(/pack/g, 'package') === normalizedProductName ||
                       normalizedProductName.replace(/pack/g, 'package') === normalizedKey ||
                       normalizedKey.replace(/\s+/g, '') === normalizedProductName.replace(/\s+/g, '');
            });
            
            if (packageMatch) {
                const packageData = PACKAGE_DATABASE[packageMatch];
                return {
                    description: packageMatch, // Return the correct package name
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            const searchName = productName.toLowerCase().trim();
            
            // Normalize the search name (remove special chars, extra spaces)
            const normalizedSearch = searchName.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
            
            // First try exact match
            let product = PRICE_LIST.find(p => 
                p.description.toLowerCase() === searchName
            );
            
            // Try normalized exact match
            if (!product) {
                product = PRICE_LIST.find(p => {
                    const normalizedDesc = p.description.toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
                    return normalizedDesc === normalizedSearch;
                });
            }
            
            // Try keyword matching (all keywords must be present)
            if (!product) {
                const keywords = normalizedSearch.split(' ').filter(w => w.length > 2);
                product = PRICE_LIST.find(p => {
                    const desc = p.description.toLowerCase();
                    return keywords.every(keyword => desc.includes(keyword));
                });
            }
            
            // Try partial match (most similar)
            if (!product) {
                const matches = PRICE_LIST.filter(p => {
                    const desc = p.description.toLowerCase();
                    return desc.includes(normalizedSearch) || normalizedSearch.includes(desc);
                });
                
                if (matches.length > 0) {
                    // Return the best match (shortest description usually more specific)
                    product = matches.reduce((best, current) => 
                        current.description.length < best.description.length ? current : best
                    );
                }
            }
            
            // Log if product not found for debugging (only once per product name)
            if (!product && typeof window !== 'undefined') {
                if (!window._missingProducts) window._missingProducts = new Set();
                if (!window._missingProducts.has(productName)) {
                    window._missingProducts.add(productName);
                    console.debug(`Product not found in price list: "${productName}"`);
                }
            }
            
            return product || {description: productName, dp: 0, cp: 0, bv: 0};
        }

        // Calculate prescription totals with member/referral pricing and consultation fees
        function calculatePrescriptionTotals(medicines, clientMembershipStatus = 'referred') {
            // Get consultation fee based on membership status
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            
            // Initialize totals with consultation fee
            let totalDP = clientMembershipStatus === 'member' ? consultationFee : 0;
            let totalCP = clientMembershipStatus === 'member' ? 0 : consultationFee;
            let totalBV = 0;
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let pendingDP = 0, pendingCP = 0, pendingBV = 0;
            let paidDP = 0, paidCP = 0, paidBV = 0;
            let outstandingDP = 0, outstandingCP = 0, outstandingBV = 0;

            medicines.forEach(med => {
                const price = findProductPrice(med.name);
                const quantity = med.quantity || 1; // Get quantity, default to 1
                
                // Check if it's a package and calculate based on dispensed items
                let effectivePrice;
                let packageFullPrice = { dp: 0, cp: 0, bv: 0 };
                let packageDispensedPrice = { dp: 0, cp: 0, bv: 0 };
                let packagePendingPrice = { dp: 0, cp: 0, bv: 0 };
                
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                    
                    // Get full package price
                if (clientMembershipStatus === 'member') {
                        packageFullPrice = { 
                            dp: packagePricing.packageTotal.dp * quantity, 
                            cp: packagePricing.packageTotal.cp * quantity, 
                            bv: packagePricing.packageTotal.bv * quantity 
                        };
                        packageDispensedPrice = { 
                            dp: packagePricing.dp * quantity, 
                            cp: packagePricing.cp * quantity, 
                            bv: packagePricing.bv * quantity 
                        };
                    } else {
                        packageFullPrice = { 
                            dp: 0, 
                            cp: packagePricing.packageTotal.cp * quantity, 
                            bv: 0 
                        };
                        packageDispensedPrice = { 
                            dp: 0, 
                            cp: packagePricing.cp * quantity, 
                            bv: 0 
                        };
                    }
                    
                    // Calculate pending price (full package - dispensed items)
                    packagePendingPrice.dp = packageFullPrice.dp - packageDispensedPrice.dp;
                    packagePendingPrice.cp = packageFullPrice.cp - packageDispensedPrice.cp;
                    packagePendingPrice.bv = packageFullPrice.bv - packageDispensedPrice.bv;
                    
                    effectivePrice = packageDispensedPrice; // For dispensed calculation
                } else {
                    // Individual product pricing
                    if (clientMembershipStatus === 'member') {
                    effectivePrice = { 
                        dp: price.dp * quantity, 
                        cp: price.cp * quantity, 
                        bv: price.bv * quantity 
                    };
                } else {
                    effectivePrice = { 
                        dp: 0, 
                        cp: price.cp * quantity, 
                        bv: 0 
                    };
                    }
                }
                
                // Add to totals
                if (price.isPackage) {
                    totalDP += packageFullPrice.dp;
                    totalCP += packageFullPrice.cp;
                    totalBV += packageFullPrice.bv;
                    
                    // Add dispensed items
                    dispensedDP += packageDispensedPrice.dp;
                    dispensedCP += packageDispensedPrice.cp;
                    dispensedBV += packageDispensedPrice.bv;
                    
                    // Add pending items
                    pendingDP += packagePendingPrice.dp;
                    pendingCP += packagePendingPrice.cp;
                    pendingBV += packagePendingPrice.bv;
                    
                    // For packages, check payment on dispensed items
                    if (med.paid) {
                        paidDP += packageDispensedPrice.dp;
                        paidCP += packageDispensedPrice.cp;
                        paidBV += packageDispensedPrice.bv;
                    } else {
                        outstandingDP += packageDispensedPrice.dp;
                        outstandingCP += packageDispensedPrice.cp;
                        outstandingBV += packageDispensedPrice.bv;
                    }
                } else {
                totalDP += effectivePrice.dp;
                totalCP += effectivePrice.cp;
                totalBV += effectivePrice.bv;

                if (med.dispensed) {
                    dispensedDP += effectivePrice.dp;
                    dispensedCP += effectivePrice.cp;
                    dispensedBV += effectivePrice.bv;
                    
                    // Check if payment is recorded
                    if (med.paid) {
                        paidDP += effectivePrice.dp;
                        paidCP += effectivePrice.cp;
                        paidBV += effectivePrice.bv;
                    } else {
                        outstandingDP += effectivePrice.dp;
                        outstandingCP += effectivePrice.cp;
                        outstandingBV += effectivePrice.bv;
                    }
                } else {
                    pendingDP += effectivePrice.dp;
                    pendingCP += effectivePrice.cp;
                    pendingBV += effectivePrice.bv;
                    }
                }
            });
            
            // Add consultation fee to appropriate categories
            const hasDispensedItems = medicines.some(m => {
                if (m.dispensed) return true;
                const price = findProductPrice(m.name);
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(m, clientMembershipStatus);
                    return packagePricing.dispensedCount > 0;
                }
                return false;
            });
            
            if (hasDispensedItems) {
                // At least one medicine or package item dispensed, add consultation fee to dispensed and paid
                if (clientMembershipStatus === 'member') {
                    dispensedDP += consultationFee;
                    paidDP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                } else {
                    dispensedCP += consultationFee;
                    paidCP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                }
            } else {
                // No medicines dispensed yet, add consultation fee to pending
                if (clientMembershipStatus === 'member') {
                    pendingDP += consultationFee;
                } else {
                    pendingCP += consultationFee;
                }
            }

            return {
                total: { dp: totalDP, cp: totalCP, bv: totalBV },
                dispensed: { dp: dispensedDP, cp: dispensedCP, bv: dispensedBV },
                pending: { dp: pendingDP, cp: pendingCP, bv: pendingBV },
                paid: { dp: paidDP, cp: paidCP, bv: paidBV },
                outstanding: { dp: outstandingDP, cp: outstandingCP, bv: outstandingBV }
            };
        }

        // Update existing reports with new pricing
        async function updateExistingReportsPricing() {
            try {
                console.log('Updating existing reports with new pricing...');
                
                // Get all reports
                await loadData();
                
                let updatedCount = 0;
                
                // Update each report
                for (let report of reports) {
                    if (report.medicines && report.medicines.length > 0) {
                        let reportUpdated = false;
                        
                        // Update pricing for each medicine in the report
                        report.medicines.forEach(med => {
                            // First, try to match package names for existing reports
                            let medicineName = med.name;
                            let matchedPackage = null;
                            
                            // Check if this is a package that needs name matching
                            const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                                key.toLowerCase().includes(medicineName.toLowerCase()) || 
                                medicineName.toLowerCase().includes(key.toLowerCase()) ||
                                medicineName.toLowerCase().replace(/\s+/g, '') === key.toLowerCase().replace(/\s+/g, '')
                            );
                            
                            if (possibleMatch && PACKAGE_DATABASE[possibleMatch]) {
                                console.log(`Found package match: "${medicineName}" -> "${possibleMatch}"`);
                                medicineName = possibleMatch;
                                med.name = possibleMatch; // Update the medicine name
                                matchedPackage = PACKAGE_DATABASE[possibleMatch];
                                reportUpdated = true;
                            }
                            
                            const newPrice = findProductPrice(medicineName);
                            
                            // Update the medicine with current pricing
                            if (newPrice && (newPrice.dp !== 0 || newPrice.cp !== 0)) {
                                med.currentPrice = {
                                    dp: newPrice.dp,
                                    cp: newPrice.cp,
                                    bv: newPrice.bv,
                                    isPackage: newPrice.isPackage || false,
                                    updatedAt: new Date().toISOString()
                                };
                                
                                // Initialize packageStatus for package medicines if it doesn't exist
                                if (newPrice.isPackage && !med.packageStatus) {
                                    med.packageStatus = {};
                                    console.log(`Initialized packageStatus for ${medicineName} in report ${report.id}`);
                                    reportUpdated = true;
                                }
                                
                                reportUpdated = true;
                            }
                        });
                        
                        if (reportUpdated) {
                            // Update the report in backend
                            try {
                                const result = await apiRequest('/reports', 'PUT', report);
                                if (result.success) {
                                    updatedCount++;
                                    console.log(`Updated pricing for report: ${report.id}`);
                                }
                            } catch (error) {
                                console.error(`Error updating report ${report.id}:`, error);
                            }
                        }
                    }
                }
                
                console.log(`Successfully updated pricing for ${updatedCount} reports`);
                
                // Refresh the display
                if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'consultant') {
                    await displayMyReports();
                }
                
                alert(`‚úÖ Successfully updated ${updatedCount} reports with new pricing and package functionality!`);
                
                return updatedCount;
            } catch (error) {
                console.error('Error updating existing reports pricing:', error);
                alert('‚ùå Error updating reports. Please try again.');
                return 0;
            }
        }

        // Fix existing client NB numbers to follow new format
        async function fixExistingClientNBNumbers() {
            try {
                console.log('Fixing existing client NB numbers...');
                
                // Get all clients
                await loadData();
                
                let fixedCount = 0;
                
                // Fix each client's referral NB number if needed
                for (let client of clients) {
                    if (client.membershipStatus === 'referred' && client.referralNbNumber) {
                        // Check if the referral NB number needs fixing
                        if (!/^NB[0-9]+$/.test(client.referralNbNumber)) {
                            // Try to fix common patterns
                            let fixedNB = client.referralNbNumber;
                            
                            // If it's just digits, add NB prefix
                            if (/^[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB;
                            }
                            // If it starts with 'Nb' (lowercase), capitalize it
                            else if (/^Nb[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB.substring(2);
                            }
                            
                            // If we made a change, update the client
                            if (fixedNB !== client.referralNbNumber) {
                                client.referralNbNumber = fixedNB;
                                client.lastUpdated = new Date().toISOString();
                                client.updatedBy = currentUser ? currentUser.fullName : 'System';
                                
                                // Update in backend
                                try {
                                    const result = await apiRequest('/clients', 'PUT', client);
                                    if (result.success) {
                                        fixedCount++;
                                        console.log(`Fixed NB number for client: ${client.fullName} - ${client.referralNbNumber}`);
                                    }
                                } catch (error) {
                                    console.error(`Error updating client ${client.referenceNumber}:`, error);
                                }
                            }
                        }
                    }
                }
                
                if (fixedCount > 0) {
                    alert(`‚úÖ Successfully fixed ${fixedCount} client NB numbers to follow the new format!`);
                } else {
                    alert('‚úÖ All client NB numbers are already in the correct format!');
                }
                
                return fixedCount;
            } catch (error) {
                console.error('Error fixing client NB numbers:', error);
                alert('‚ùå Error fixing client NB numbers. Please try again.');
                return 0;
            }
        }

        // Run all system maintenance fixes
        async function runSystemMaintenance() {
            try {
                if (!confirm('This will fix all existing data to work with the new system. Continue?')) {
                    return;
                }
                
                console.log('Running system maintenance...');
                
                // Fix NB numbers first
                const nbFixed = await fixExistingClientNBNumbers();
                
                // Then fix package pricing
                const pricingFixed = await updateExistingReportsPricing();
                
                alert(`‚úÖ System maintenance completed!\n\n‚Ä¢ Fixed ${nbFixed} client NB numbers\n‚Ä¢ Fixed ${pricingFixed} reports with package pricing\n\nAll existing data is now compatible with the new system!`);
                
            } catch (error) {
                console.error('Error running system maintenance:', error);
                alert('‚ùå Error running system maintenance. Please try again.');
            }
        }

        // Function to ensure all new reports use updated pricing
        function validateReportPricing(report) {
            if (!report.medicines || report.medicines.length === 0) return report;
            
            // Update each medicine with current pricing
            report.medicines.forEach(med => {
                const currentPrice = findProductPrice(med.name);
                if (currentPrice && (currentPrice.dp !== 0 || currentPrice.cp !== 0)) {
                    med.currentPrice = {
                        dp: currentPrice.dp,
                        cp: currentPrice.cp,
                        bv: currentPrice.bv,
                        isPackage: currentPrice.isPackage || false,
                        updatedAt: new Date().toISOString()
                    };
                }
            });
            
            return report;
        }

        // Handle membership status change
        function handleMembershipStatusChange() {
            const membershipSelect = document.getElementById('membershipStatusSelect');
            const referralDetails = document.getElementById('referralDetails');
            const memberDetails = document.getElementById('memberDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');

            function updateVisibility(value) {
                if (value === 'member') {
                    if (referralDetails) referralDetails.style.display = 'none';
                    if (memberDetails) memberDetails.style.display = 'block';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                } else if (value === 'referred') {
                    if (referralDetails) referralDetails.style.display = 'block';
                    if (memberDetails) memberDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = true;
                    if (referralNbInput) referralNbInput.required = true;
                } else {
                    if (referralDetails) referralDetails.style.display = 'none';
                    if (memberDetails) memberDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                }
            }

            if (membershipSelect) {
                membershipSelect.addEventListener('change', function() { updateVisibility(this.value); });
                updateVisibility(membershipSelect.value);
            }
        }

        // Real-time data synchronization
        function createDataHash() {
            const dataString = JSON.stringify({
                clients: clients.length,
                users: users.length,
                branches: branches.length,
                reports: reports.length,
                lastUpdate: new Date().toISOString()
            });
            return btoa(dataString).substring(0, 16);
        }

        function hasDataChanged() {
            const currentHash = createDataHash();
            if (lastDataHash && lastDataHash !== currentHash) {
                lastDataHash = currentHash;
                return true;
            }
            lastDataHash = currentHash;
            return false;
        }

        // Consultation fees
        const CONSULTATION_FEES = {
            member: 150,    // N$150 for registered members
            referred: 200   // N$200 for referred clients
        };

        async         function init() {
            await loadData();
            loadBranches();
            handleMembershipStatusChange();
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('stressSlider').addEventListener('input', function() {
                document.getElementById('stressValue').textContent = this.value;
            });
            document.getElementById('branchSelect').addEventListener('change', e => {
                currentBranch = e.target.value;
            });
            const checkupSelect = document.getElementById('checkupBranchSelect');
            if (checkupSelect) {
                checkupSelect.addEventListener('change', e => {
                    currentBranch = e.target.value;
                    const globalSelect = document.getElementById('branchSelect');
                    if (globalSelect && globalSelect.value !== currentBranch) {
                        globalSelect.value = currentBranch;
                    }
                });
            }
            
            // Add event listener for full name field to update signature
            document.querySelector('input[name="fullName"]').addEventListener('input', function() {
                const consentCheck = document.getElementById('consentCheck');
                if (consentCheck && consentCheck.checked) {
                    handleConsentChange();
                }
            });
            
            // Update storage info display
            updateStorageInfo();
        }
        
        function updateStorageInfo() {
            const storageEl = document.getElementById('storageInfo');
            if (!storageEl) return;
            
            const info = checkStorageSpace();
            const color = parseFloat(info.percent) > 80 ? '#e74c3c' : parseFloat(info.percent) > 60 ? '#f39c12' : '#27ae60';
            storageEl.innerHTML = `<span style="color: ${color};">${info.used} MB / ${info.max} MB (${info.percent}%)</span>`;
        }

        // API Functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                updateRealtimeStatus('syncing');
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                

                // Try primary API
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, options);
                    
                    // Check if response is OK before parsing JSON
                    if (!response.ok) {
                        // Don't try to parse HTML error pages as JSON
                        if (response.status === 404) {
                            throw new Error(`404_NOT_FOUND`);
                        }
                        const errorText = await response.text();
                        throw new Error(`API error ${response.status}: ${errorText.substring(0, 100)}`);
                    }
                    
                    // Check if response is actually JSON
                    const contentType = response.headers.get('content-type') || '';
                    if (!contentType.includes('application/json')) {
                        // If 404 or HTML response, don't parse as JSON
                        if (response.status === 404 || contentType.includes('text/html')) {
                            throw new Error(`404_NOT_FOUND`);
                        }
                        const text = await response.text();
                        throw new Error(`Expected JSON but got ${contentType || 'unknown'}`);
                    }
                    
                    // Safely parse JSON with error handling
                    let result;
                    try {
                        const text = await response.text();
                        result = JSON.parse(text);
                    } catch (parseError) {
                        // If JSON parse fails, it's likely HTML or invalid response
                        throw new Error(`404_NOT_FOUND`);
                    }
                    
                    updateRealtimeStatus('online');
                    return result;
                } catch (primaryError) {
                    // Try secondary local API as fallback
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            const response = await fetch(`${API_BASE_LOCAL}${endpoint}`, options);
                            
                            if (!response.ok) {
                                throw new Error(`Secondary API returned ${response.status}`);
                            }
                            
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error(`Secondary API returned non-JSON`);
                            }
                            
                            const result = await response.json();
                            updateRealtimeStatus('online');
                            console.log('Using secondary local API as fallback');
                            return result;
                        } catch (localError) {
                            console.error('Both APIs failed, using localStorage');
                            throw localError;
                        }
                    } else {
                        throw primaryError;
                    }
                }
            } catch (error) {
                // Silently handle 404s (expected when APIs aren't deployed)
                const is404 = error.message && (
                    error.message.includes('404') || 
                    error.message.includes('404_NOT_FOUND') ||
                    (error.message.includes('Unexpected token') && error.message.includes('The page c'))
                );
                
                if (!is404) {
                    // Only log non-404 errors in debug mode
                    console.debug('API Error:', error.message || error);
                }
                
                updateRealtimeStatus('offline');
                // Fallback to localStorage if API is not available
                return await fallbackToLocalStorage(endpoint, method, data);
            }
        }

        async function fallbackToLocalStorage(endpoint, method, data) {
            console.log('API unavailable, using localStorage fallback');
            if (endpoint === LEAVE_API_ENDPOINT) {
                if (method === 'GET') {
                    return getLeaveCacheRecords();
                }
                if (method === 'POST') {
                    const normalized = normalizeLeaveRecord(
                        Object.assign({}, data || {}, {
                            status: (data && data.status) || 'pending'
                        }),
                        {
                            defaultStaff: currentUser?.username || null,
                            defaultStaffName: currentUser?.fullName || null,
                            defaultBranch: currentBranch || null,
                            pendingSync: true,
                            source: 'offline'
                        }
                    );
                    normalized.pendingSync = true;
                    normalized.source = 'offline';
                    upsertLeaveCacheRecord(normalized);
                    enqueuePendingRequest(LEAVE_PENDING_QUEUE_KEY, {
                        id: normalized.id,
                        payload: Object.assign({}, data || {}),
                        createdAt: normalized.createdAt,
                        staff: normalized.staff,
                        branch: normalized.branch
                    });
                    return { success: true, offline: true, data: normalized };
                }
            }
            if (endpoint === CASH_API_ENDPOINT) {
                if (method === 'GET') {
                    return getCashCacheRecords();
                }
                if (method === 'POST') {
                    const normalized = normalizeCashRecord(
                        Object.assign({}, data || {}, {
                            status: (data && data.status) || 'pending'
                        }),
                        {
                            defaultEmployeeId: currentUser?.username || null,
                            defaultEmployeeName: currentUser?.fullName || null,
                            defaultBranch: currentBranch || null,
                            pendingSync: true,
                            source: 'offline'
                        }
                    );
                    normalized.pendingSync = true;
                    normalized.source = 'offline';
                    upsertCashCacheRecord(normalized);
                    enqueuePendingRequest(CASH_PENDING_QUEUE_KEY, {
                        id: normalized.id,
                        payload: Object.assign({}, data || {}),
                        createdAt: normalized.createdAt,
                        employeeId: normalized.employeeId,
                        branch: normalized.branch
                    });
                    return { success: true, offline: true, data: normalized };
                }
            }
            if (endpoint === '/clients') {
                if (method === 'GET') {
                    return JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                } else if (method === 'POST') {
                    const clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                    clients.push(data);
            localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    return { success: true, message: 'Client saved (offline)' };
                }
            }
            if (endpoint === '/users') {
                if (method === 'GET') {
                    const parsed = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        localStorage.setItem('dyna_users', DEFAULT_USERS_JSON);
                        return JSON.parse(DEFAULT_USERS_JSON);
                    }
                    return parsed;
                } else if (method === 'POST') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    usersLocal.push(data);
                    localStorage.setItem('dyna_users', JSON.stringify(usersLocal));
                    return { success: true, message: 'User saved (offline)' };
                } else if (method === 'PUT') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    const idx = usersLocal.findIndex(u => u.id === data.id);
                    if (idx !== -1) {
                        usersLocal[idx] = data;
                        localStorage.setItem('dyna_users', JSON.stringify(usersLocal));
                        return { success: true, message: 'User updated (offline)' };
                    }
                    return { success: false, message: 'User not found (offline)' };
                } else if (method === 'DELETE') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    const url = new URL(window.location.origin + endpoint + (endpoint.includes('?') ? '' : ''));
                    // Expect id via query in caller; fallback: data.id
                    const id = (data && data.id) || (typeof endpoint === 'string' && endpoint.includes('?') ? new URLSearchParams(endpoint.split('?')[1]).get('id') : null);
                    if (!id) return { success: false, message: 'No user id provided (offline)' };
                    const next = usersLocal.filter(u => u.id !== id);
                    localStorage.setItem('dyna_users', JSON.stringify(next));
                    return { success: true, message: 'User deleted (offline)' };
                }
            }
            if (endpoint === '/branches') {
                if (method === 'GET') {
                    const parsed = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        localStorage.setItem('dyna_branches', DEFAULT_BRANCHES_JSON);
                        return JSON.parse(DEFAULT_BRANCHES_JSON);
                    }
                    return parsed;
                } else if (method === 'POST') {
                    const branchesLocal = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                    branchesLocal.push(data);
                    localStorage.setItem('dyna_branches', JSON.stringify(branchesLocal));
                    return { success: true, message: 'Branch saved (offline)' };
                }
            }
            if (endpoint === '/reports') {
                if (method === 'GET') {
                    // Try to load reports from localStorage, default to empty array
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    return reportsLocal;
                } else if (method === 'POST') {
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    reportsLocal.push(data);
                    localStorage.setItem('dyna_reports', JSON.stringify(reportsLocal));
                    return { success: true, message: 'Report saved (offline)' };
                } else if (method === 'PUT') {
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    const idx = reportsLocal.findIndex(r => r.id === data.id);
                    if (idx !== -1) {
                        reportsLocal[idx] = data;
                        localStorage.setItem('dyna_reports', JSON.stringify(reportsLocal));
                        return { success: true, message: 'Report updated (offline)' };
                    }
                    return { success: false, message: 'Report not found (offline)' };
                }
            }
            return { error: 'Offline mode - limited functionality' };
        }

        function ensureBranchDirectory() {
            const ensureArray = (value) => (Array.isArray(value) ? value : []);
            if (!Array.isArray(branches) || branches.length === 0) {
                try {
                    branches = ensureArray(safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON));
                } catch (_) {
                    branches = [];
                }
                if (!Array.isArray(branches) || branches.length === 0) {
                    try {
                        branches = ensureArray(JSON.parse(DEFAULT_BRANCHES_JSON));
                    } catch (_) {
                        branches = [];
                    }
                }
            }
            if (!Array.isArray(branches)) {
                branches = [];
            }
            if (branches.length > 0) {
                const unique = [];
                const seen = new Set();
                branches.forEach(branch => {
                    if (!branch) return;
                    const key = (branch.id || branch.name || '').trim();
                    if (!key || seen.has(key)) return;
                    seen.add(key);
                    unique.push(branch);
                });
                branches = unique;
            }
            return branches;
        }
        
        async function loadData() {
            try {
                const clientResponse = await apiRequest('/clients');
                const userResponse = await apiRequest('/users');
                const branchResponse = await apiRequest('/branches');
                const reportResponse = await apiRequest('/reports');

                clients = extractArray(clientResponse, []);
                users = extractArray(userResponse, []);
                branches = extractArray(branchResponse, []);
                reports = extractArray(reportResponse, []);
                
                // If API returns empty arrays, initialize with defaults
                if (users.length === 0) {
                    users = JSON.parse(DEFAULT_USERS_JSON);
                }
                
                if (branches.length === 0) {
                    branches = JSON.parse(DEFAULT_BRANCHES_JSON);
                }
                
                // Load reports from localStorage or keep the existing ones
                if (reports.length === 0) {
                    const storedReports = localStorage.getItem('dyna_reports');
                    if (storedReports && storedReports !== '[]' && storedReports !== 'null') {
                        reports = JSON.parse(storedReports);
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback to localStorage using safe parsing
                clients = safeParseFromStorage('dyna_clients', '[]');
                users = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                branches = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                reports = safeParseFromStorage('dyna_reports', '[]');
                
                // Ensure users and branches are not empty
                if (users.length === 0) {
                    users = JSON.parse(DEFAULT_USERS_JSON);
                    localStorage.setItem('dyna_users', DEFAULT_USERS_JSON);
                }
                if (branches.length === 0) {
                    branches = JSON.parse(DEFAULT_BRANCHES_JSON);
                    localStorage.setItem('dyna_branches', DEFAULT_BRANCHES_JSON);
                }
                
                // Auto-extract clients from reports if clients array is empty
                if (clients.length === 0 && reports.length > 0) {
                    console.log('üìã No clients found, extracting from reports...');
                    const extractedClients = [];
                    
                    reports.forEach(report => {
                        if (!report.clientInfo || !report.clientId) return;
                        
                        const exists = extractedClients.find(c => c.referenceNumber === report.clientId);
                        if (!exists) {
                            extractedClients.push({
                                referenceNumber: report.clientId,
                                fullName: report.clientInfo.fullName,
                                phone: report.clientInfo.phone || '',
                                email: report.clientInfo.email || '',
                                nbNumber: report.clientInfo.nbNumber || ''
                            });
                        }
                    });
                    
                    clients = extractedClients;
                    localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    console.log(`‚úÖ Extracted ${clients.length} clients from reports`);
                }
            }
            ensureBranchDirectory();
            try {
                if (typeof populateBranchSelects === 'function') {
                    populateBranchSelects();
                }
            } catch (e) {
                console.debug('Unable to populate branch selectors after data load:', e);
            }
        }
        window.loadData = loadData;

        async function saveData() {
            // This function is kept for compatibility but data is now saved via API calls
            console.log('Data saved via API calls');
        }

        // Global refresh function to update all portals
        // GM Portal data refresh
        async function refreshGMData() {
            try {
                await loadData();
            } catch (e) {
                console.debug('refreshGMData: loadData error', e);
            }
            if (typeof loadEnhancedFinanceData === 'function') {
                try {
                    await loadEnhancedFinanceData();
                } catch (e) {
                    console.debug('refreshGMData: loadEnhancedFinanceData error', e);
                }
            }
            try {
                calculateGMMetrics();
            } catch (e) {
                console.debug('refreshGMData: calculateGMMetrics error', e);
            }
            try {
                renderGMFinancialReport();
            } catch (e) {
                console.debug('refreshGMData: renderGMFinancialReport error', e);
            }
            refreshAllApprovals();
            loadSpecialSales();
            displayGMInventoryBreakdown();
        }
        
        // Director Portal data refresh
        function refreshDirectorData() {
            loadData();
            calculateDirectorMetrics();
            loadStockDepletion();
            displayDirectorInventoryBreakdown();
        }
        
        // Calculate GM metrics
        function calculateGMMetrics() {
            let totalRevenue = 0;
            let totalBV = 0;
            let totalCIF = 0;
            
            // Calculate from reports
            reports.forEach(report => {
                const total = calculateReportTotal(report);
                totalRevenue += total;
                
                // Calculate BV from medicines
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        if (price && price.bv) {
                            totalBV += price.bv;
                        }
                    });
                }
                
                // Add CIF if present
                if (report.cif) {
                    totalCIF += parseFloat(report.cif);
                }
            });
            
            const grossMargin = totalRevenue * 0.20; // Assume 20% margin
            
            document.getElementById('gmTotalRevenue').textContent = `N$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('gmTotalBV').textContent = totalBV.toFixed(0);
            document.getElementById('gmCIFDeposits').textContent = `N$ ${totalCIF.toFixed(2)}`;
            document.getElementById('gmGrossMargin').textContent = `N$ ${grossMargin.toFixed(2)}`;
        }

        function buildBranchDirectoryMap() {
            ensureBranchDirectory();
            const directory = {};
            (Array.isArray(branches) ? branches : []).forEach(branch => {
                if (!branch) return;
                const name = branch.name || branch.displayName || branch.id || branch.code || '';
                const identifiers = [
                    branch.id,
                    branch.code,
                    branch.name,
                    branch.displayName,
                    branch.shortcode,
                    branch.branchCode
                ];
                identifiers.forEach(id => {
                    if (!id) return;
                    directory[String(id)] = name;
                    directory[String(id).toLowerCase()] = name;
                });
            });
            return directory;
        }

        function getBranchNameById(branchId) {
            if (!branchId) return 'Unassigned / Head Office';
            const directory = buildBranchDirectoryMap();
            const exact = directory[String(branchId)];
            if (exact) return exact;
            const lowerMatch = directory[String(branchId).toLowerCase()];
            return lowerMatch || String(branchId);
        }

        function getAllBonusPayments() {
            const cash = Array.isArray(cashBonuses) ? cashBonuses : [];
            const bank = Array.isArray(bankBonuses) ? bankBonuses : [];
            return [
                ...cash.map(item => ({ ...item, method: item.method || 'cash' })),
                ...bank.map(item => ({ ...item, method: item.method || 'bank' }))
            ];
        }

        function renderGMFinancialReport() {
            const container = document.getElementById('gmFinancialReportSummary');
            if (!container) return;
            const directory = buildBranchDirectoryMap();

            const deposits = Array.isArray(bankDeposits) ? bankDeposits : [];
            const allBonuses = getAllBonusPayments();
            const expenseRecords = Array.isArray(expenses) ? expenses : [];

            const totals = {
                deposits: 0,
                cashBonuses: 0,
                bankBonuses: 0,
                expenses: 0
            };

            const branchTotals = {};
            const ensureBranchBucket = (details) => {
                const key = (details?.id || details?.name || 'unassigned').toLowerCase();
                if (!branchTotals[key]) {
                    branchTotals[key] = {
                        id: details?.id || null,
                        name: details?.name || details?.id || 'Unassigned / Head Office',
                        deposits: 0,
                        cashBonuses: 0,
                        bankBonuses: 0,
                        expenses: 0
                    };
                }
                return branchTotals[key];
            };

            const addAmount = (bucket, key, amount) => {
                const value = Number(amount || 0);
                if (!bucket || !Number.isFinite(value)) return;
                bucket[key] += value;
                totals[key] += value;
            };

            deposits.forEach(entry => {
                const details = resolveBranchDetails(entry, directory);
                const bucket = ensureBranchBucket(details);
                addAmount(bucket, 'deposits', entry.amount);
            });

            allBonuses.forEach(entry => {
                const details = resolveBranchDetails(entry, directory);
                const bucket = ensureBranchBucket(details);
                const key = (entry.method || '').toLowerCase() === 'bank' ? 'bankBonuses' : 'cashBonuses';
                addAmount(bucket, key, entry.amount);
            });

            expenseRecords.forEach(entry => {
                const details = resolveBranchDetails(entry, directory);
                const bucket = ensureBranchBucket(details);
                addAmount(bucket, 'expenses', entry.amount);
            });

            const netTotal = totals.deposits - totals.cashBonuses - totals.bankBonuses - totals.expenses;

            const branchRows = Object.values(branchTotals).map(row => {
                const net = row.deposits - row.cashBonuses - row.bankBonuses - row.expenses;
                return { ...row, net };
            }).sort((a, b) => b.deposits - a.deposits);

            const auditLog = (() => {
                try {
                    const raw = localStorage.getItem('gm_bonus_history_audit');
                    const parsed = raw ? JSON.parse(raw) : [];
                    if (Array.isArray(parsed)) {
                        return parsed.sort((a, b) => new Date(b.approvedAt || 0) - new Date(a.approvedAt || 0));
                    }
                    return [];
                } catch (_) {
                    return [];
                }
            })();

            const metricsHtml = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;">
                    <div style="background:#0c4a6e;color:white;padding:18px;border-radius:12px;">
                        <div style="opacity:0.8;font-size:0.85rem;">Total Deposits</div>
                        <div style="font-size:1.6rem;font-weight:700;margin-top:6px;">${formatCurrencyNAD(totals.deposits)}</div>
                    </div>
                    <div style="background:#155e75;color:white;padding:18px;border-radius:12px;">
                        <div style="opacity:0.8;font-size:0.85rem;">Cash Bonuses</div>
                        <div style="font-size:1.6rem;font-weight:700;margin-top:6px;">${formatCurrencyNAD(totals.cashBonuses)}</div>
                    </div>
                    <div style="background:#1d4ed8;color:white;padding:18px;border-radius:12px;">
                        <div style="opacity:0.8;font-size:0.85rem;">Bank Bonuses</div>
                        <div style="font-size:1.6rem;font-weight:700;margin-top:6px;">${formatCurrencyNAD(totals.bankBonuses)}</div>
                    </div>
                    <div style="background:#7c2d12;color:white;padding:18px;border-radius:12px;">
                        <div style="opacity:0.8;font-size:0.85rem;">Recorded Expenses</div>
                        <div style="font-size:1.6rem;font-weight:700;margin-top:6px;">${formatCurrencyNAD(totals.expenses)}</div>
                    </div>
                    <div style="background:${netTotal >= 0 ? '#166534' : '#b91c1c'};color:white;padding:18px;border-radius:12px;">
                        <div style="opacity:0.8;font-size:0.85rem;">Net Position</div>
                        <div style="font-size:1.6rem;font-weight:700;margin-top:6px;">${formatCurrencyNAD(netTotal)}</div>
                    </div>
                </div>
            `;

            const branchTableHtml = branchRows.length === 0
                ? '<p style="text-align:center;color:#64748b;padding:20px;">No finance activity recorded yet.</p>'
                : `
                    <div style="margin-top:20px;overflow:auto;border:1px solid #e2e8f0;border-radius:10px;">
                        <table style="width:100%;border-collapse:collapse;min-width:620px;">
                            <thead>
                                <tr style="background:#f1f5f9;color:#1e293b;">
                                    <th style="padding:12px;text-align:left;">Branch</th>
                                    <th style="padding:12px;text-align:right;">Deposits</th>
                                    <th style="padding:12px;text-align:right;">Cash Bonuses</th>
                                    <th style="padding:12px;text-align:right;">Bank Bonuses</th>
                                    <th style="padding:12px;text-align:right;">Expenses</th>
                                    <th style="padding:12px;text-align:right;">Net</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${branchRows.map(row => `
                                    <tr>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;">${row.name}</td>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;">${formatCurrencyNAD(row.deposits)}</td>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;">${formatCurrencyNAD(row.cashBonuses)}</td>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;">${formatCurrencyNAD(row.bankBonuses)}</td>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;">${formatCurrencyNAD(row.expenses)}</td>
                                        <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;font-weight:600;color:${row.net >= 0 ? '#166534' : '#b91c1c'};">${formatCurrencyNAD(row.net)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            const auditHtml = auditLog.length === 0
                ? ''
                : `
                    <div style="margin-top:25px;">
                        <h4 style="margin:0 0 10px 0;color:#1e293b;">Recent Bonus History Downloads</h4>
                        <div style="border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;">
                            <table style="width:100%;border-collapse:collapse;min-width:520px;">
                                <thead style="background:#f8fafc;color:#475569;">
                                    <tr>
                                        <th style="padding:10px;text-align:left;">Distributor</th>
                                        <th style="padding:10px;text-align:left;">Approved By</th>
                                        <th style="padding:10px;text-align:left;">Date Range</th>
                                        <th style="padding:10px;text-align:right;">Records</th>
                                        <th style="padding:10px;text-align:left;">Approved At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${auditLog.slice(0, 6).map(entry => `
                                        <tr>
                                            <td style="padding:10px;border-top:1px solid #e2e8f0;">${(entry.distributorName ? `${entry.distributorName} (${entry.distributor || entry.distributorNB})` : (entry.distributor || entry.distributorNB || 'N/A'))}</td>
                                            <td style="padding:10px;border-top:1px solid #e2e8f0;">${entry.approvedBy || 'GM'}</td>
                                            <td style="padding:10px;border-top:1px solid #e2e8f0;">${entry.fromDate || entry.toDate ? `${entry.fromDate || 'Start'} ‚Üí ${entry.toDate || 'Current'}` : 'All time'}</td>
                                            <td style="padding:10px;border-top:1px solid #e2e8f0;text-align:right;">${entry.recordCount || 0}</td>
                                            <td style="padding:10px;border-top:1px solid #e2e8f0;">${entry.approvedAt ? new Date(entry.approvedAt).toLocaleString() : ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

            container.innerHTML = `
                ${metricsHtml}
                ${branchTableHtml}
                ${auditHtml}
                <p style="margin-top:15px;color:#94a3b8;font-size:12px;">Report refreshed ${new Date().toLocaleString()}.</p>
            `;
        }

        async function refreshGMFinancialReportSection() {
            if (typeof loadEnhancedFinanceData === 'function') {
                try {
                    await loadEnhancedFinanceData();
                } catch (e) {
                    console.debug('refreshGMFinancialReportSection: loadEnhancedFinanceData error', e);
                }
            }
            renderGMFinancialReport();
        }

        function populateGMBonusHistoryDistributorList() {
            const dataList = document.getElementById('gmBonusHistoryDistributorList');
            if (!dataList) return;
            const unique = new Map();

            const sourceDistributors = Array.isArray(distributors) ? distributors : [];
            sourceDistributors.forEach(dist => {
                if (!dist) return;
                const nb = (dist.distributorNB || dist.distributorCode || dist.code || dist.referenceNumber || '').toString().trim().toUpperCase();
                const name = (dist.distributorName || dist.name || dist.fullName || '').toString().trim();
                const key = nb || name;
                if (!key || unique.has(key)) return;
                unique.set(key, { nb, name });
            });

            getAllBonusPayments().forEach(entry => {
                if (!entry) return;
                const nb = (entry.distributorNB || entry.distributor || entry.drn || entry.code || '').toString().trim().toUpperCase();
                const name = (entry.name || entry.distributorName || entry.stockist || '').toString().trim();
                const key = nb || name;
                if (!key || unique.has(key)) return;
                unique.set(key, { nb, name });
            });

            dataList.innerHTML = '';
            unique.forEach(({ nb, name }, key) => {
                const option = document.createElement('option');
                option.value = nb || key;
                if (name && nb) {
                    option.label = `${name} (${nb})`;
                } else if (name) {
                    option.label = name;
                }
                dataList.appendChild(option);
            });
        }

        async function showGMBonusHistoryModal() {
            if (typeof loadDistributors === 'function') {
                try {
                    await loadDistributors({ skipBackend: true });
                } catch (e) {
                    console.debug('showGMBonusHistoryModal: loadDistributors error', e);
                }
            }
            populateGMBonusHistoryDistributorList();
            const modal = document.getElementById('gmBonusHistoryModal');
            if (!modal) return;
            const nbInput = document.getElementById('gmBonusHistoryNB');
            const fromInput = document.getElementById('gmBonusHistoryFrom');
            const toInput = document.getElementById('gmBonusHistoryTo');
            const noteInput = document.getElementById('gmBonusHistoryNote');
            const approval = document.getElementById('gmBonusHistoryApproval');
            const downloadBtn = document.getElementById('gmBonusHistoryDownloadBtn');

            if (nbInput) nbInput.value = '';
            if (fromInput) fromInput.value = '';
            if (toInput) toInput.value = '';
            if (noteInput) noteInput.value = '';
            if (approval) {
                approval.checked = false;
            }
            if (downloadBtn) downloadBtn.disabled = true;

            modal.style.display = 'block';
            setTimeout(() => {
                if (nbInput) nbInput.focus();
            }, 100);
        }

        function handleGMBonusApprovalToggle() {
            const approval = document.getElementById('gmBonusHistoryApproval');
            const downloadBtn = document.getElementById('gmBonusHistoryDownloadBtn');
            if (downloadBtn) {
                downloadBtn.disabled = !(approval && approval.checked);
            }
        }

        function csvEscape(value) {
            if (value == null) return '';
            const str = String(value).replace(/\r?\n|\r/g, ' ');
            if (/[",]/.test(str)) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function compileGMBonusHistoryRow(entry) {
            const branchName = getBranchNameById(entry.branch || entry.branchId || entry.branch_code || entry.branchName);
            const method = (entry.method || (entry.bankName ? 'bank' : 'cash')).toUpperCase();
            const reason = entry.reason || entry.notes || entry.note || '';
            const approvedBy = entry.approvedBy || entry.approved || entry.approved_user || '';
            const createdBy = entry.createdBy || entry.generatedBy || entry.recordedBy || '';
            const amount = Number(entry.amount || entry.total || 0);
            const rawDate = entry.date || entry.createdAt || entry.approvedAt || entry.timestamp;
            const formattedDate = rawDate ? new Date(rawDate).toLocaleString() : '';
            const distributorNB = (entry.distributorNB || entry.distributor || entry.drn || entry.code || '').toString().toUpperCase();
            const distributorName = entry.name || entry.distributorName || entry.stockist || '';
            return {
                formattedDate,
                distributorNB,
                distributorName,
                branchName,
                amount,
                method,
                reason,
                approvedBy,
                createdBy
            };
        }

        function matchesBonusHistorySearch(entry, identifier) {
            const normalized = identifier.trim();
            if (!normalized) return false;
            const upperId = normalized.toUpperCase();
            const lowerId = normalized.toLowerCase();
            const entryNB = (entry.distributorNB || entry.distributor || entry.drn || entry.code || '').toString().trim().toUpperCase();
            const entryName = (entry.name || entry.distributorName || entry.stockist || '').toString().trim().toLowerCase();
            return (entryNB && entryNB === upperId) || (entryName && entryName.includes(lowerId));
        }

        function downloadGMBonusHistory() {
            const approval = document.getElementById('gmBonusHistoryApproval');
            if (!(approval && approval.checked)) {
                alert('Please confirm GM approval before exporting bonus history.');
                return;
            }

            const identifierInput = document.getElementById('gmBonusHistoryNB');
            const fromInput = document.getElementById('gmBonusHistoryFrom');
            const toInput = document.getElementById('gmBonusHistoryTo');
            const noteInput = document.getElementById('gmBonusHistoryNote');

            const identifierRaw = identifierInput ? identifierInput.value.trim() : '';
            if (!identifierRaw) {
                alert('Enter a distributor NB or name.');
                return;
            }

            const fromDateValue = fromInput && fromInput.value ? new Date(`${fromInput.value}T00:00:00`) : null;
            const toDateValue = toInput && toInput.value ? new Date(`${toInput.value}T23:59:59`) : null;
            if (fromDateValue && toDateValue && fromDateValue > toDateValue) {
                alert('The "Date From" must be earlier than "Date To".');
                return;
            }

            const allBonuses = getAllBonusPayments();
            const filtered = allBonuses.filter(entry => {
                if (!matchesBonusHistorySearch(entry, identifierRaw)) return false;
                if (!fromDateValue && !toDateValue) return true;
                const rawDate = entry.date || entry.createdAt || entry.approvedAt || entry.timestamp;
                const entryDate = rawDate ? new Date(rawDate) : null;
                if (!entryDate || Number.isNaN(entryDate.getTime())) return false;
                if (fromDateValue && entryDate < fromDateValue) return false;
                if (toDateValue && entryDate > toDateValue) return false;
                return true;
            });

            if (filtered.length === 0) {
                alert('No bonus records found for the supplied filters.');
                return;
            }

            const rows = [['Date', 'Distributor NB', 'Distributor Name', 'Branch', 'Amount (N$)', 'Method', 'Reason', 'Approved By', 'Created By']];
            const compiled = filtered.map(compileGMBonusHistoryRow);
            compiled.forEach(row => {
                rows.push([
                    row.formattedDate,
                    row.distributorNB,
                    row.distributorName,
                    row.branchName,
                    Number(row.amount || 0).toFixed(2),
                    row.method,
                    row.reason || '',
                    row.approvedBy || '',
                    row.createdBy || ''
                ]);
            });

            const csv = rows.map(line => line.map(csvEscape).join(',')).join('\n');
            const filename = `bonus_history_${identifierRaw.replace(/\s+/g, '_').toUpperCase()}_${Date.now()}.csv`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(link.href), 500);

            const auditEntry = {
                id: `GMBD-${Date.now()}`,
                distributor: compiled[0]?.distributorNB || identifierRaw.toUpperCase(),
                distributorName: compiled[0]?.distributorName || '',
                fromDate: fromInput && fromInput.value ? fromInput.value : null,
                toDate: toInput && toInput.value ? toInput.value : null,
                recordCount: compiled.length,
                note: noteInput ? noteInput.value.trim() : '',
                approvedBy: currentUser?.username || 'gm',
                approvedAt: new Date().toISOString()
            };
            try {
                const auditLog = JSON.parse(localStorage.getItem('gm_bonus_history_audit') || '[]');
                if (Array.isArray(auditLog)) {
                    auditLog.push(auditEntry);
                    while (auditLog.length > 250) auditLog.shift();
                    localStorage.setItem('gm_bonus_history_audit', JSON.stringify(auditLog));
                } else {
                    localStorage.setItem('gm_bonus_history_audit', JSON.stringify([auditEntry]));
                }
            } catch (_) {
                localStorage.setItem('gm_bonus_history_audit', JSON.stringify([auditEntry]));
            }

            closeModal('gmBonusHistoryModal');
            renderGMFinancialReport();
            alert(`Bonus history export generated (${compiled.length} record${compiled.length === 1 ? '' : 's'}).`);
        }
        
        // Calculate Director metrics
        function calculateDirectorMetrics() {
            let revenue = 0;
            let cif = 0;
            let bv = 0;
            
            reports.forEach(report => {
                revenue += calculateReportTotal(report);
                
                if (report.cif) cif += parseFloat(report.cif);
                
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        if (price && price.bv) bv += price.bv;
                    });
                }
            });
            
            const margin = revenue * 0.20;
            const remittance = revenue - cif;
            
            document.getElementById('directorRevenue').textContent = `N$ ${revenue.toFixed(2)}`;
            document.getElementById('directorCIF').textContent = `N$ ${cif.toFixed(2)}`;
            document.getElementById('directorBV').textContent = bv.toFixed(0);
            document.getElementById('directorMargin').textContent = `N$ ${margin.toFixed(2)}`;
            document.getElementById('directorRemittance').textContent = `N$ ${remittance.toFixed(2)}`;
        }
        
        // Approval tab switching
        function switchApprovalTab(tabType) {
            // Hide all tabs
            document.querySelectorAll('.approval-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#gm .tabs .tab-button').forEach(btn => {
                if (btn.id && btn.id.startsWith('approvalTab')) {
                    btn.classList.remove('active');
                }
            });
            
            // Show selected tab
            const activeTab = document.getElementById(`${tabType}ApprovalsList`);
            const activeButton = document.getElementById(`approvalTab${tabType.charAt(0).toUpperCase() + tabType.slice(1)}`);
            
            if (activeTab) {
                activeTab.style.display = 'block';
                activeTab.classList.add('active');
            }
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data for the selected tab
            refreshAllApprovals(tabType);
        }
        
        // Refresh all approvals or specific type
        function refreshAllApprovals(type = null) {
            if (!type || type === 'all') {
                loadAllApprovals();
            }
            if (!type || type === 'cash') {
                loadCashApprovals();
            }
            if (!type || type === 'leave') {
                loadLeaveApprovals();
            }
            if (!type || type === 'stock') {
                loadStockApprovals();
            }
            if (!type || type === 'other') {
                loadOtherApprovals();
            }
            
            // Update global count
            updateApprovalCount();
        }
        
        // Load all approvals (combined view)
        async function loadAllApprovals() {
            const container = document.getElementById('allApprovalsList');
            if (!container) return;
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Loading approvals...</p>';
            let cashRequests = [];
            let leaveRequests = [];
            try {
                cashRequests = await fetchCashRecordsIncludingOffline({ onlyPending: true });
            } catch (error) {
                const cachedCash = getCashCacheRecords();
                cashRequests = cachedCash.filter((r) => (r.status || '').toLowerCase() === 'pending');
            }
            try {
                leaveRequests = await fetchLeaveRecordsIncludingOffline({ onlyPending: true });
            } catch (error) {
                const cachedLeave = getLeaveCacheRecords();
                leaveRequests = cachedLeave.filter(
                    (r) => (r.statusRaw || r.status || '').toLowerCase() === 'pending'
                );
            }
            const stockRequests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(
                (r) => r.status === 'pending_gm' || r.status === 'pending'
            );
            const otherRequests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(
                (r) => r.status === 'pending'
            );

            const allRequests = [
                ...cashRequests.map((r) => ({
                    ...r,
                    requestType: 'cash',
                    type: 'cash',
                    typeLabel: 'Cash Request',
                    icon: 'üíµ'
                })),
                ...leaveRequests.map((r) => ({
                    ...r,
                    leaveType: r.type,
                    requestType: 'leave',
                    type: 'leave',
                    typeLabel: 'Leave Request',
                    icon: 'üìÖ'
                })),
                ...stockRequests.map((r) => ({
                    ...r,
                    requestType: 'stock',
                    type: 'stock',
                    typeLabel: 'Stock Movement',
                    icon: 'üì¶'
                })),
                ...otherRequests.map((r) => ({
                    ...r,
                    requestType: 'other',
                    type: 'other',
                    typeLabel: r.category || 'Other Request',
                    icon: 'üìã'
                }))
            ];

            if (allRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‚úÖ No pending approvals at this time.</p>';
                return;
            }
            
            // Sort by date (newest first)
            allRequests.sort((a, b) => new Date(b.createdAt || b.submittedAt) - new Date(a.createdAt || a.submittedAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            allRequests.forEach(request => {
                const date = new Date(request.createdAt || request.submittedAt || Date.now());
                html += renderApprovalCard(request, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load cash approvals
        async function loadCashApprovals() {
            const container = document.getElementById('cashApprovalsList');
            if (!container) return;
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Loading cash requests...</p>';
            let requests = [];
            try {
                requests = await fetchCashRecordsIncludingOffline({ onlyPending: true });
            } catch (error) {
                const cached = getCashCacheRecords();
                requests = cached.filter((r) => (r.status || '').toLowerCase() === 'pending');
            }
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‚úÖ No pending cash requests.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach((request) => {
                const date = new Date(request.createdAt || Date.now());
                html += renderApprovalCard(
                    {
                        ...request,
                        requestType: 'cash',
                        type: 'cash',
                        typeLabel: 'Cash Request',
                        icon: 'üíµ'
                    },
                    date
                );
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load leave approvals
        async function loadLeaveApprovals() {
            const container = document.getElementById('leaveApprovalsList');
            if (!container) return;
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Loading leave requests...</p>';
            let requests = [];
            try {
                requests = await fetchLeaveRecordsIncludingOffline({ onlyPending: true });
            } catch (error) {
                const cached = getLeaveCacheRecords();
                requests = cached.filter((r) => (r.statusRaw || r.status || '').toLowerCase() === 'pending');
            }
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‚úÖ No pending leave requests.</p>';
                return;
            }
            
            requests.sort(
                (a, b) => new Date(b.submittedAt || b.createdAt || 0) - new Date(a.submittedAt || a.createdAt || 0)
            );
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach((request) => {
                const date = new Date(request.submittedAt || request.createdAt || Date.now());
                html += renderApprovalCard(
                    {
                        ...request,
                        leaveType: request.type,
                        type: 'leave',
                        typeLabel: 'Leave Request',
                        icon: 'üìÖ'
                    },
                    date
                );
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load stock approvals
        function loadStockApprovals() {
            const container = document.getElementById('stockApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(r => 
                r.status === 'pending_gm' || (r.status === 'pending' && r.priority === 'urgent')
            );
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‚úÖ No pending stock movement approvals.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.createdAt || request.date || Date.now());
                html += renderApprovalCard({ ...request, requestType: 'stock', type: 'stock', typeLabel: 'Stock Movement', icon: 'üì¶' }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load other approvals
        function loadOtherApprovals() {
            const container = document.getElementById('otherApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(r => r.status === 'pending');
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‚úÖ No other pending requests.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.createdAt);
                html += renderApprovalCard({ ...request, requestType: 'other', type: 'other', typeLabel: request.category || 'Other Request', icon: 'üìã' }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render approval card
        function renderApprovalCard(request, date) {
            const urgent = request.urgent || request.priority === 'urgent';
            const borderColor = urgent ? '#e74c3c' : '#3498db';
            
            let details = '';
            if (request.type === 'cash') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Amount:</strong> N$ ${request.amount?.toFixed(2) || '0.00'}<br>
                        <strong>Purpose:</strong> ${request.purpose || 'N/A'}<br>
                        <strong>Branch:</strong> ${request.branch || 'N/A'}
                    </div>
                `;
            } else if (request.type === 'leave') {
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Employee:</strong> ${request.staff || 'Unknown'}<br>
                        <strong>Leave Type:</strong> ${request.leaveType || 'N/A'}<br>
                        <strong>Period:</strong> ${startDate} to ${endDate}<br>
                        <strong>Reason:</strong> ${request.reason || 'N/A'}
                    </div>
                `;
            } else if (request.type === 'stock') {
                const itemsCount = request.items?.length || 0;
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Request Number:</strong> ${request.requestNumber || request.id || 'N/A'}<br>
                        <strong>From Branch:</strong> ${request.requestingBranch || 'N/A'}<br>
                        <strong>Items:</strong> ${itemsCount} item(s)<br>
                        <strong>Priority:</strong> ${request.priority || 'Normal'}
                    </div>
                `;
            } else {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Description:</strong> ${request.description || request.purpose || 'N/A'}<br>
                        <strong>Category:</strong> ${request.category || 'General'}
                    </div>
                `;
            }
            
            return `
                <div style="background: white; border-left: 4px solid ${borderColor}; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${request.icon || 'üìã'}</span>
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50;">${request.typeLabel || 'Request'}</h4>
                                    <div style="color: #7f8c8d; font-size: 0.9rem;">${date.toLocaleString()}</div>
                                </div>
                            </div>
                            ${urgent ? '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px;">URGENT</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="approveRequest('${request.id}', '${request.type}')" style="padding: 8px 16px; font-size: 0.9rem;">‚úÖ Approve</button>
                            <button class="btn btn-danger" onclick="rejectRequest('${request.id}', '${request.type}')" style="padding: 8px 16px; font-size: 0.9rem;">‚ùå Reject</button>
                        </div>
                    </div>
                    ${details}
                </div>
            `;
        }
        
        // Approve a request
        async function approveRequest(requestId, requestType) {
            const reason = prompt('Enter approval notes (optional):');
            if (reason === null) return; // User cancelled
            
            try {
                if (requestType === 'cash') {
                    const requests = getCashCacheRecords();
                    const idx = requests.findIndex((r) => (r.id || r.offlineId) === requestId);
                    if (idx !== -1) {
                        const updated = {
                            ...requests[idx],
                            status: 'approved',
                            statusRaw: 'approved',
                            approvedBy: window.currentUser?.fullName || 'GM',
                            approvedAt: new Date().toISOString(),
                            approvalNotes: reason || ''
                        };
                        requests[idx] = updated;
                        setCashCacheRecords(requests);
                        removePendingRequest(CASH_PENDING_QUEUE_KEY, requestId);

                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('cash_request', 'approved', updated);
                        }
                    }
                } else if (requestType === 'leave') {
                    const requests = getLeaveCacheRecords();
                    const idx = requests.findIndex((r) => (r.id || r.offlineId) === requestId);
                    if (idx !== -1) {
                        const updated = {
                            ...requests[idx],
                            status: 'Approved',
                            statusRaw: 'approved',
                            approvedBy: window.currentUser?.fullName || 'GM',
                            approvedAt: new Date().toISOString(),
                            approvalNotes: reason || ''
                        };
                        requests[idx] = updated;
                        setLeaveCacheRecords(requests);
                        removePendingRequest(LEAVE_PENDING_QUEUE_KEY, requestId);

                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('leave_request', 'approved', updated);
                        }
                    }
                } else if (requestType === 'stock') {
                    const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'approved';
                        request.approvals = request.approvals || [];
                        request.approvals.push({
                            level: 'gm',
                            approvedBy: window.currentUser?.fullName || 'GM',
                            approvedAt: new Date().toISOString(),
                            notes: reason || ''
                        });
                        localStorage.setItem('dyna_stock_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('stock_request', 'approved', request);
                        }
                    }
                } else {
                    const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'approved';
                        request.approvedBy = window.currentUser?.fullName || 'GM';
                        request.approvedAt = new Date().toISOString();
                        request.approvalNotes = reason || '';
                        localStorage.setItem('gm_pending_requests', JSON.stringify(requests));
                    }
                }
                
                alert('‚úÖ Request approved successfully!');
                refreshAllApprovals();
                updateApprovalCount();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('‚ùå Error approving request. Please try again.');
            }
        }
        
        // Reject a request
        async function rejectRequest(requestId, requestType) {
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || reason.trim() === '') {
                alert('Rejection reason is required.');
                return;
            }
            
            try {
                if (requestType === 'cash') {
                    const requests = getCashCacheRecords();
                    const idx = requests.findIndex((r) => (r.id || r.offlineId) === requestId);
                    if (idx !== -1) {
                        const updated = {
                            ...requests[idx],
                            status: 'rejected',
                            statusRaw: 'rejected',
                            rejectedBy: window.currentUser?.fullName || 'GM',
                            rejectedAt: new Date().toISOString(),
                            rejectionReason: reason
                        };
                        requests[idx] = updated;
                        setCashCacheRecords(requests);
                        removePendingRequest(CASH_PENDING_QUEUE_KEY, requestId);

                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('cash_request', 'rejected', updated);
                        }
                    }
                } else if (requestType === 'leave') {
                    const requests = getLeaveCacheRecords();
                    const idx = requests.findIndex((r) => (r.id || r.offlineId) === requestId);
                    if (idx !== -1) {
                        const updated = {
                            ...requests[idx],
                            status: 'Rejected',
                            statusRaw: 'rejected',
                            rejectedBy: window.currentUser?.fullName || 'GM',
                            rejectedAt: new Date().toISOString(),
                            rejectionReason: reason
                        };
                        requests[idx] = updated;
                        setLeaveCacheRecords(requests);
                        removePendingRequest(LEAVE_PENDING_QUEUE_KEY, requestId);

                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('leave_request', 'rejected', updated);
                        }
                    }
                } else if (requestType === 'stock') {
                    const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('dyna_stock_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('stock_request', 'rejected', request);
                        }
                    }
                } else {
                    const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('gm_pending_requests', JSON.stringify(requests));
                    }
                }
                
                alert('‚ùå Request rejected.');
                refreshAllApprovals();
                updateApprovalCount();
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('‚ùå Error rejecting request. Please try again.');
            }
        }
        
        // Update approval count
        async function updateApprovalCount() {
            let cashCount = 0;
            let leaveCount = 0;
            try {
                const cashRequests = await fetchCashRecordsIncludingOffline({ onlyPending: true });
                cashCount = Array.isArray(cashRequests) ? cashRequests.length : 0;
            } catch (error) {
                const cachedCash = getCashCacheRecords();
                cashCount = cachedCash.filter((r) => (r.status || '').toLowerCase() === 'pending').length;
            }
            try {
                const leaveRequests = await fetchLeaveRecordsIncludingOffline({ onlyPending: true });
                leaveCount = Array.isArray(leaveRequests) ? leaveRequests.length : 0;
            } catch (error) {
                const cachedLeave = getLeaveCacheRecords();
                leaveCount = cachedLeave.filter(
                    (r) => (r.statusRaw || r.status || '').toLowerCase() === 'pending'
                ).length;
            }
            const stockRequests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(
                (r) => r.status === 'pending_gm' || (r.status === 'pending' && r.priority === 'urgent')
            );
            const otherRequests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(
                (r) => r.status === 'pending'
            );

            const totalCount = cashCount + leaveCount + stockRequests.length + otherRequests.length;
            window.gmPendingApprovalsCount = totalCount;

            if (typeof window.updateGlobalAlerts === 'function') {
                window.updateGlobalAlerts({ pendingApprovalsCount: totalCount });
            }
        }
        
        // Load pending approvals (legacy function for backward compatibility)
        function loadPendingApprovals() {
            refreshAllApprovals('all');
        }
        
        // Load special sales
        function loadSpecialSales() {
            const container = document.getElementById('specialSalesList');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; color: #666;">No active special sales campaigns.</p>';
        }
        
        // Load stock depletion
        function loadStockDepletion() {
            const container = document.getElementById('stockDepletionDashboard');
            if (!container) return;
            
            const batches = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const byProduct = {};
            
            batches.forEach(b => {
                if (!byProduct[b.description]) {
                    byProduct[b.description] = { total: 0, remaining: 0 };
                }
                byProduct[b.description].total += b.quantity;
                byProduct[b.description].remaining += b.remainingQuantity;
            });
            
            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #c41e3a; color: white;"><th style="padding: 10px;">Product</th><th style="padding: 10px;">Total</th><th style="padding: 10px;">Remaining</th><th style="padding: 10px;">Depleted</th></tr></thead><tbody>';
            
            Object.entries(byProduct).forEach(([product, stats]) => {
                const depleted = stats.total - stats.remaining;
                const percent = (depleted / stats.total * 100).toFixed(0);
                html += `<tr><td style="padding: 10px; border: 1px solid #ddd;">${product}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.total}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.remaining}</td><td style="padding: 10px; border: 1px solid #ddd;">${percent}%</td></tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Show special sales modal
        function showSpecialSalesModal() {
            alert('Special Sales creation will be available soon!');
        }
        
        // Campaign Management Functions
        function switchCampaignTab(tabType) {
            // Hide all tabs
            document.querySelectorAll('.campaign-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#gm .tabs .tab-button').forEach(btn => {
                if (btn.id && btn.id.startsWith('campaignTab')) {
                    btn.classList.remove('active');
                }
            });
            
            // Show selected tab
            const activeTab = document.getElementById(`${tabType}CampaignsList`);
            const activeButton = document.getElementById(`campaignTab${tabType.charAt(0).toUpperCase() + tabType.slice(1)}`);
            
            if (activeTab) {
                activeTab.style.display = 'block';
                activeTab.classList.add('active');
            }
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data for the selected tab
            refreshCampaigns(tabType);
        }
        
        function refreshCampaigns(type = null) {
            if (!type || type === 'all') {
                loadAllCampaigns();
            }
            if (!type || type === 'sales') {
                loadSalesCampaigns();
            }
            if (!type || type === 'recruiting') {
                loadRecruitingCampaigns();
            }
            if (!type || type === 'sponsoring') {
                loadSponsoringCampaigns();
            }
            if (!type || type === 'gift') {
                loadGiftCampaigns();
            }
        }
        
        function loadAllCampaigns() {
            const container = document.getElementById('allCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No campaigns created yet.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadSalesCampaigns() {
            const container = document.getElementById('salesCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'sales');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No sales discount campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadRecruitingCampaigns() {
            const container = document.getElementById('recruitingCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'recruiting');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No recruiting campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadSponsoringCampaigns() {
            const container = document.getElementById('sponsoringCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'sponsoring');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No sponsoring campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadGiftCampaigns() {
            const container = document.getElementById('giftCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'gift');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No gift campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderCampaignCard(campaign) {
            const isActive = campaign.status === 'active';
            const isExpired = new Date(campaign.endDate) < new Date();
            const borderColor = isExpired ? '#95a5a6' : isActive ? '#27ae60' : '#e74c3c';
            
            const typeIcons = {
                'sales': 'üí∞',
                'recruiting': 'üë•',
                'sponsoring': 'ü§ù',
                'gift': 'üéÅ'
            };
            
            const typeLabels = {
                'sales': 'Sales Discount',
                'recruiting': 'Recruiting',
                'sponsoring': 'Sponsoring',
                'gift': 'Gift Campaign'
            };
            
            let details = '';
            if (campaign.type === 'sales') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Discount:</strong> ${campaign.discount || 0}%<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                        ${campaign.products?.length > 0 ? `<strong>Products:</strong> ${campaign.products.length} product(s)<br>` : ''}
                        ${campaign.minPurchaseAmount ? `<strong>Min Purchase:</strong> N$ ${campaign.minPurchaseAmount}<br>` : ''}
                    </div>
                `;
            } else if (campaign.type === 'recruiting') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Reward:</strong> ${campaign.reward || 'N/A'}<br>
                        <strong>Target:</strong> ${campaign.target || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            } else if (campaign.type === 'sponsoring') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Incentive:</strong> ${campaign.incentive || 'N/A'}<br>
                        <strong>Target:</strong> ${campaign.target || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            } else if (campaign.type === 'gift') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Gift:</strong> ${campaign.giftDescription || 'N/A'}<br>
                        <strong>Condition:</strong> ${campaign.condition || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            }
            
            return `
                <div style="background: white; border-left: 4px solid ${borderColor}; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${typeIcons[campaign.type] || 'üìã'}</span>
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50;">${campaign.name || 'Unnamed Campaign'}</h4>
                                    <div style="color: #7f8c8d; font-size: 0.9rem;">${typeLabels[campaign.type] || campaign.type} ‚Ä¢ ${new Date(campaign.startDate).toLocaleDateString()} - ${new Date(campaign.endDate).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <span style="background: ${borderColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px;">
                                ${campaign.status?.toUpperCase() || 'INACTIVE'}${isExpired ? ' (EXPIRED)' : ''}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="editCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="deleteCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">üóëÔ∏è Delete</button>
                            ${!isActive && !isExpired ? `<button class="btn btn-success" onclick="activateCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">‚úÖ Activate</button>` : ''}
                            ${isActive ? `<button class="btn btn-warning" onclick="deactivateCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">‚è∏Ô∏è Deactivate</button>` : ''}
                        </div>
                    </div>
                    ${campaign.description ? `<p style="color: #555; margin-top: 10px;">${campaign.description}</p>` : ''}
                    ${details}
                </div>
            `;
        }
        
        function showCreateCampaignModal() {
            const modal = document.createElement('div');
            modal.id = 'createCampaignModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeModal('createCampaignModal')">&times;</span>
                    <h2>üéØ Create Campaign</h2>
                    <form id="createCampaignForm" onsubmit="submitCampaign(event)">
                        <div class="form-group">
                            <label class="required">Campaign Name</label>
                            <input type="text" id="campaignName" required placeholder="e.g., Summer Sales 2025">
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Campaign Type</label>
                            <select id="campaignType" required onchange="updateCampaignForm()">
                                <option value="">Select Type</option>
                                <option value="sales">üí∞ Sales Discount</option>
                                <option value="recruiting">üë• Recruiting</option>
                                <option value="sponsoring">ü§ù Sponsoring</option>
                                <option value="gift">üéÅ Gift Campaign</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="campaignDescription" rows="3" placeholder="Campaign description..."></textarea>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Start Date</label>
                                <input type="date" id="campaignStartDate" required>
                            </div>
                            <div class="form-group">
                                <label class="required">End Date</label>
                                <input type="date" id="campaignEndDate" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Apply To</label>
                            <select id="campaignApplyTo" required onchange="updateBranchSelection()">
                                <option value="all">All Branches</option>
                                <option value="selected">Selected Branches</option>
                            </select>
                        </div>
                        
                        <div id="branchSelectionDiv" class="form-group" style="display: none;">
                            <label>Select Branches</label>
                            <div id="branchCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <!-- Branches will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Sales Discount Specific Fields -->
                        <div id="salesFields" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Discount Percentage</label>
                                    <input type="number" id="campaignDiscount" min="0" max="100" step="0.01" placeholder="e.g., 15">
                                </div>
                                <div class="form-group">
                                    <label>Minimum Purchase Amount (N$)</label>
                                    <input type="number" id="campaignMinPurchase" min="0" step="0.01" placeholder="Optional">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Apply to Specific Products (Optional)</label>
                                <input type="text" id="campaignProducts" placeholder="Comma-separated product names or leave empty for all products">
                            </div>
                        </div>
                        
                        <!-- Recruiting Specific Fields -->
                        <div id="recruitingFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Reward Description</label>
                                <textarea id="campaignReward" rows="2" placeholder="e.g., N$ 500 bonus for each new distributor"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target</label>
                                <input type="text" id="campaignTarget" placeholder="e.g., 10 new distributors">
                            </div>
                        </div>
                        
                        <!-- Sponsoring Specific Fields -->
                        <div id="sponsoringFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Incentive Description</label>
                                <textarea id="campaignIncentive" rows="2" placeholder="e.g., Extra 5% commission for sponsors"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target</label>
                                <input type="text" id="campaignSponsorTarget" placeholder="e.g., 5 sponsored members">
                            </div>
                        </div>
                        
                        <!-- Gift Specific Fields -->
                        <div id="giftFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Gift Description</label>
                                <textarea id="campaignGift" rows="2" placeholder="e.g., Free product sample kit"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="required">Condition</label>
                                <textarea id="campaignGiftCondition" rows="2" placeholder="e.g., For purchases above N$ 500" required></textarea>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">‚úÖ Create Campaign</button>
                            <button type="button" class="btn" onclick="closeModal('createCampaignModal')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load branches
            loadBranchesForCampaign();
            
            // Set default dates
            const today = new Date();
            document.getElementById('campaignStartDate').value = today.toISOString().split('T')[0];
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('campaignEndDate').value = nextMonth.toISOString().split('T')[0];
        }
        
        function loadBranchesForCampaign() {
            const branchList = getCachedBranches();
            const container = document.getElementById('branchCheckboxes');
            if (!container) return;

            container.innerHTML = '';
            branchList.forEach(branch => {
                if (!branch) return;
                const value = branch.id || branch.branchId || branch.code || branch.name;
                const label = branch.name || branch.branchName || branch.displayName || branch.code || value || 'Unnamed Branch';
                const div = document.createElement('div');
                div.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="campaignBranches" value="${value || ''}" style="width: auto;">
                        <span>${label}</span>
                    </label>
                `;
                container.appendChild(div);
            });
        }
        
        function updateCampaignForm() {
            const type = document.getElementById('campaignType')?.value;
            
            // Hide all type-specific fields
            document.getElementById('salesFields').style.display = 'none';
            document.getElementById('recruitingFields').style.display = 'none';
            document.getElementById('sponsoringFields').style.display = 'none';
            document.getElementById('giftFields').style.display = 'none';
            
            // Show relevant fields
            if (type === 'sales') {
                document.getElementById('salesFields').style.display = 'block';
            } else if (type === 'recruiting') {
                document.getElementById('recruitingFields').style.display = 'block';
            } else if (type === 'sponsoring') {
                document.getElementById('sponsoringFields').style.display = 'block';
            } else if (type === 'gift') {
                document.getElementById('giftFields').style.display = 'block';
            }
        }
        
        function updateBranchSelection() {
            const applyTo = document.getElementById('campaignApplyTo')?.value;
            const branchDiv = document.getElementById('branchSelectionDiv');
            if (branchDiv) {
                branchDiv.style.display = applyTo === 'selected' ? 'block' : 'none';
            }
        }
        
        function submitCampaign(event) {
            event.preventDefault();
            
            try {
                const type = document.getElementById('campaignType').value;
                const applyTo = document.getElementById('campaignApplyTo').value;
                
                let branches = [];
                if (applyTo === 'selected') {
                    const checkboxes = document.querySelectorAll('input[name="campaignBranches"]:checked');
                    branches = Array.from(checkboxes).map(cb => cb.value);
                }
                
                const campaign = {
                    id: 'CAMP-' + Date.now(),
                    name: document.getElementById('campaignName').value,
                    type: type,
                    description: document.getElementById('campaignDescription').value || '',
                    startDate: document.getElementById('campaignStartDate').value,
                    endDate: document.getElementById('campaignEndDate').value,
                    branches: branches,
                    status: 'inactive',
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser?.fullName || 'GM'
                };
                
                // Add type-specific fields
                if (type === 'sales') {
                    campaign.discount = parseFloat(document.getElementById('campaignDiscount').value) || 0;
                    campaign.minPurchaseAmount = parseFloat(document.getElementById('campaignMinPurchase').value) || null;
                    const productsStr = document.getElementById('campaignProducts').value;
                    campaign.products = productsStr ? productsStr.split(',').map(p => p.trim()).filter(p => p) : [];
                } else if (type === 'recruiting') {
                    campaign.reward = document.getElementById('campaignReward').value;
                    campaign.target = document.getElementById('campaignTarget').value || '';
                } else if (type === 'sponsoring') {
                    campaign.incentive = document.getElementById('campaignIncentive').value;
                    campaign.target = document.getElementById('campaignSponsorTarget').value || '';
                } else if (type === 'gift') {
                    campaign.giftDescription = document.getElementById('campaignGift').value;
                    campaign.condition = document.getElementById('campaignGiftCondition').value;
                }
                
                // Save campaign
                const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
                campaigns.push(campaign);
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'created', campaign);
                }
                
                alert('‚úÖ Campaign created successfully!');
                closeModal('createCampaignModal');
                refreshCampaigns();
                
            } catch (error) {
                console.error('Error creating campaign:', error);
                alert('‚ùå Error creating campaign: ' + error.message);
            }
        }
        
        function editCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) {
                alert('Campaign not found');
                return;
            }
            
            // Similar to create modal but pre-filled
            showCreateCampaignModal();
            // TODO: Pre-fill form with campaign data
            alert('Edit functionality coming soon. For now, delete and recreate the campaign.');
        }
        
        function deleteCampaign(campaignId) {
            if (!confirm('Are you sure you want to delete this campaign?')) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const filtered = campaigns.filter(c => c.id !== campaignId);
            localStorage.setItem('gm_campaigns', JSON.stringify(filtered));
            
            // Broadcast event
            if (typeof publishRealtimeEvent === 'function') {
                publishRealtimeEvent('campaign', 'deleted', { id: campaignId });
            }
            
            alert('‚úÖ Campaign deleted');
            refreshCampaigns();
        }
        
        function activateCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                campaign.status = 'active';
                campaign.activatedAt = new Date().toISOString();
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'activated', campaign);
                }
                
                alert('‚úÖ Campaign activated');
                refreshCampaigns();
            }
        }
        
        function deactivateCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                campaign.status = 'inactive';
                campaign.deactivatedAt = new Date().toISOString();
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'deactivated', campaign);
                }
                
                alert('‚è∏Ô∏è Campaign deactivated');
                refreshCampaigns();
            }
        }
        
        // Display GM Inventory Breakdown
        function displayGMInventoryBreakdown() {
            const container = document.getElementById('gmInventoryBreakdown');
            if (!container) return;
            try {
                if (typeof getInventorySummary !== 'function') {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Inventory reporting module loading...</p>';
                    return;
                }
                const summary = getInventorySummary({ branchId: null });
                if (!summary.success) {
                    container.innerHTML = `<p style="color: #e74c3c;">Error: ${summary.error}</p>`;
                    return;
                }
                const data = summary.data;
                let html = '<div style="margin-bottom: 15px;"><strong>üìä Inventory Overview</strong></div>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<thead><tr style="background: #667eea; color: white;"><th style="padding: 8px;">Metric</th><th style="padding: 8px; text-align: right;">Value</th></tr></thead><tbody>';
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Products</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalProducts}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Quantity</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalQuantity}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Low Stock Items</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e74c3c;">${data.totals.lowStockItems}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Expiring Soon (30 days)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f39c12;">${data.totals.expiringSoon}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Requests</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingRequests}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Transfers</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingTransfers}</td></tr>`;
                html += '</tbody></table>';
                if (data.alerts && data.alerts.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong>‚ö†Ô∏è Alerts</strong></div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    data.alerts.slice(0, 5).forEach(alert => {
                        html += `<li style="color: #f39c12;">${alert.message}</li>`;
                    });
                    html += '</ul>';
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p style="color: #e74c3c;">Error displaying inventory: ${error.message}</p>`;
            }
        }
        
        // Display Director Inventory Breakdown
        function displayDirectorInventoryBreakdown() {
            const container = document.getElementById('directorInventoryBreakdown');
            if (!container) return;
            try {
                if (typeof getInventorySummary !== 'function') {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Inventory reporting module loading...</p>';
                    return;
                }
                const summary = getInventorySummary({ branchId: null });
                if (!summary.success) {
                    container.innerHTML = `<p style="color: #e74c3c;">Error: ${summary.error}</p>`;
                    return;
                }
                const data = summary.data;
                let html = '<div style="margin-bottom: 15px;"><strong>üìä Inventory Overview</strong></div>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<thead><tr style="background: #667eea; color: white;"><th style="padding: 8px;">Metric</th><th style="padding: 8px; text-align: right;">Value</th></tr></thead><tbody>';
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Products</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalProducts}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Quantity</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalQuantity}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Low Stock Items</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e74c3c;">${data.totals.lowStockItems}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Expiring Soon (30 days)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f39c12;">${data.totals.expiringSoon}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Requests</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingRequests}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Transfers</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingTransfers}</td></tr>`;
                html += '</tbody></table>';
                if (data.alerts && data.alerts.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong>‚ö†Ô∏è Alerts</strong></div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    data.alerts.slice(0, 5).forEach(alert => {
                        html += `<li style="color: #f39c12;">${alert.message}</li>`;
                    });
                    html += '</ul>';
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p style="color: #e74c3c;">Error displaying inventory: ${error.message}</p>`;
            }
        }
        
        async function refreshAllData() {
            const previousHash = lastDataHash;
            await loadData();
            loadBranches();
            
            // Check if data has changed and show notification
            if (previousHash && hasDataChanged()) {
                showDataUpdateNotification();
            }
            
            // Refresh current portal data if user is logged in
            if (currentUser) {
                if (currentPortal === 'consultant') {
                    await displayClients();
                    await displayFollowUps();
                } else if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'stock') {
                    renderForecastList();
                    renderPurchaseOrders();
                    renderSupplierScorecard();
                    renderPlanInsights();
                    renderASNList();
                    renderQualityList();
                    renderPutawayQueue();
                    renderWarehouseCapacity();
                    renderReplenishmentSuggestions();
                    renderBranchRequestList();
                    updateBranchMetrics();
                    renderReturnsList();
                    renderRouteBoard();
                    renderInventoryAlerts();
                    renderReorderScenarioResults();
                    displayCountryStock();
                    displayWindhoekStock();
                    displayOndangwaStock();
                    displayDistributionHistory();
                } else if (currentPortal === 'mis') {
                    loadMISBranches();
                    displayMISReports();
                } else if (currentPortal === 'admin') {
                    loadUserList();
                    loadBranchListAdmin();
                    loadAdminDistributorDirectory();
                }
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh every 30 seconds when user is logged in (reduced from 5s to prevent API spam)
            // Real-time updates should come from WebSocket/SSE, not polling
            autoRefreshInterval = setInterval(async () => {
                if (currentUser) {
                    try {
                        await refreshAllData();
                    } catch (error) {
                        // Silently handle errors to prevent console spam
                        console.debug('Auto-refresh error (using localStorage):', error.message);
                    }
                }
            }, 30000); // 30 seconds instead of 5 seconds
            
            console.log('üîÑ Auto-refresh started (30 second intervals)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚èπÔ∏è Auto-refresh stopped');
            }
        }

        // Show notification when data is updated
        function showDataUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = 'üîÑ Data updated from another device';
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Show/hide real-time status indicator
        function showRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'block';
                status.className = 'realtime-status';
                status.innerHTML = 'üîÑ Real-time sync active';
            }
        }

        function hideRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'none';
            }
        }

        function updateRealtimeStatus(status) {
            const statusElement = document.getElementById('realtimeStatus');
            if (statusElement) {
                statusElement.className = `realtime-status ${status}`;
                switch(status) {
                    case 'offline':
                        statusElement.innerHTML = '‚ùå Connection lost';
                        break;
                    case 'syncing':
                        statusElement.innerHTML = 'üîÑ Syncing...';
                        break;
                    default:
                        statusElement.innerHTML = 'üîÑ Real-time sync active';
                }
            }
        }

        // Network synchronization test functions
        async function testNetworkSync() {
            try {
                updateRealtimeStatus('syncing');
                
                // Test API connectivity with fallback
                let response;
                let data;
                let connectedTo = 'Unknown';
                
                // Try primary API
                try {
                    response = await fetch(`${API_BASE}/clients`);
                    data = await response.json();
                    connectedTo = 'Primary Server';
                } catch (e1) {
                    // Try secondary local API if different
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            response = await fetch(`${API_BASE_LOCAL}/clients`);
                            data = await response.json();
                            connectedTo = 'Secondary Local Server';
                        } catch (e2) {
                            // Fall back to local storage
                            data = clients;
                            connectedTo = 'Offline Mode (Local Storage)';
                        }
                    } else {
                        // Fall back to local storage
                        data = clients;
                        connectedTo = 'Offline Mode (Local Storage)';
                    }
                }
                
                updateRealtimeStatus('online');
                
                alert(`‚úÖ Network sync test successful!\n\nConnected to: ${connectedTo}\nTotal clients in system: ${data.length}\n\nLatest clients:\n${data.slice(-3).map(c => `- ${c.fullName} (${c.referenceNumber})`).join('\n')}`);
                
            } catch (error) {
                updateRealtimeStatus('offline');
                const localClients = safeParseFromStorage('clients', '[]');
                alert(`‚ö†Ô∏è Network connection failed!\n\nError: ${error.message}\n\nüì¶ Current Status:\n- ${localClients.length} clients in local storage\n- Working in OFFLINE MODE\n\nNote: The app will continue working with local data. Sync will resume when connection is restored.`);
            }
        }

        async function checkConnectionStatus() {
            try {
                const startTime = Date.now();
                let response;
                let data;
                let endpoint = 'Unknown';
                let connectionStatus = '‚ùå Disconnected';
                
                // Try primary API
                try {
                    response = await fetch(`${API_BASE}/clients`);
                    data = await response.json();
                    endpoint = 'Primary Server';
                    connectionStatus = '‚úÖ Connected';
                } catch (e1) {
                    // Try secondary local API if different
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            response = await fetch(`${API_BASE_LOCAL}/clients`);
                            data = await response.json();
                            endpoint = 'Secondary Local Server';
                            connectionStatus = '‚úÖ Connected';
                        } catch (e2) {
                            // Fall back to local storage
                            data = clients;
                            endpoint = 'Offline Mode';
                            connectionStatus = '‚ö†Ô∏è Offline (Using Local Storage)';
                        }
                    } else {
                        // Fall back to local storage
                        data = clients;
                        endpoint = 'Offline Mode';
                        connectionStatus = '‚ö†Ô∏è Offline (Using Local Storage)';
                    }
                }
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const localData = safeParseFromStorage('clients', '[]');
                
                alert(`üì° Connection Status Report\n\n${connectionStatus}\nüåê Endpoint: ${endpoint}\n‚è±Ô∏è Response Time: ${responseTime}ms\nüìä Total Clients: ${data.length}\nüíæ Local Storage: ${localData.length} records\nüîÑ Auto-refresh: ${autoRefreshInterval ? 'Active (5s intervals)' : 'Inactive'}\nüë§ Current User: ${currentUser ? currentUser.fullName : 'Not logged in'}`);
                
            } catch (error) {
                const localClients = safeParseFromStorage('clients', '[]');
                alert(`‚ùå Connection Status Report\n\n‚ùå API Server: Disconnected\nüåê Primary: ${API_BASE}\nüåê Local: ${API_BASE_LOCAL}\n‚ö†Ô∏è Error: ${error.message}\n\nüíæ Local Storage: ${localClients.length} records available\n\nThe app will continue working with local data until connection is restored.`);
            }
        }

        function loadBranches() {
            console.log('Loading branches:', branches);
            const selects = [document.getElementById('branchSelect'), document.getElementById('userBranchSelect'), document.getElementById('checkupBranchSelect')];
            selects.forEach(select => {
                if(select) {
                    select.innerHTML = '<option value="">Select Branch</option>';
                    branches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    });
                    console.log('Populated select:', select.id, 'with', branches.length, 'branches');
                }
            });
        }

        function openTab(tabName, event) {
            // Set currentPortal for portal tabs
            const portalTabs = ['consultant', 'dispenser', 'admin', 'mis', 'stock', 'gm', 'director', 'finance', 'hr-portal'];
            if (portalTabs.includes(tabName)) {
                currentPortal = tabName;
                window.currentPortal = tabName; // Set global for permission checks
            }
            
            // Branch selection is now optional - portals can open without it
            // Branch selection will be requested only when needed for specific operations inside portals
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const btn = document.querySelector(`[onclick="openTab('${tabName}', event)"]`) || document.querySelector(`[onclick="openTab('${tabName}')"]`);
                if (btn) btn.classList.add('active');
            }
            
            // Auto-login for stock portal if not already logged in
            if (tabName === 'stock' && !currentUser) {
                // Give a small delay to let the tab load
                setTimeout(() => {
                    autoLoginStock();
                }, 100);
            }
            
            // MIS Portal now requires login - initialize if already logged in
            if (tabName === 'mis' && currentUser && currentUser.role === 'mis') {
                initializeMISPortal();
            }
            
            if (tabName === 'admin' && currentUser && currentUser.role === 'admin') {
                setTimeout(() => {
                    loadAdminDistributorDirectory();
                }, 200);
            }
            
            // Finance Portal - ensure data is loaded when tab is opened
            if (tabName === 'finance') {
                setTimeout(async () => {
                    try {
                        if (typeof loadEnhancedFinanceData === 'function') {
                            await loadEnhancedFinanceData();
                        }
                        if (typeof populateBranchSelects === 'function') {
                            populateBranchSelects();
                        }
                        if (typeof refreshFinancialDashboard === 'function') {
                            refreshFinancialDashboard();
                        }
                        if (typeof refreshFinancialOverview === 'function') {
                            refreshFinancialOverview();
                        }
                        if (typeof refreshRevenue === 'function') {
                            refreshRevenue();
                        }
                        if (typeof refreshExpenses === 'function') {
                            refreshExpenses();
                        }
                    } catch (e) {
                        console.debug('Finance portal initialization error:', e);
                    }
                }, 100);
            }
            
            // HR Portal - ensure data is loaded when tab is opened
            if (tabName === 'hr-portal') {
                // Reload employees when HR portal is opened to ensure fresh data
                if (typeof initHRPortal === 'function') {
                    initHRPortal();
                }
                // Also ensure employee list is loaded if employee-management tab is visible
                setTimeout(() => {
                    const empTab = document.querySelector('[onclick*="employee-management"]');
                    if (empTab && empTab.classList.contains('active')) {
                        if (typeof loadEmployees === 'function') {
                            loadEmployees();
                        }
                    }
                }, 100);
            }
            
            // Client/Distributor Portal - ensure shop products load when tab is opened
            if (tabName === 'client') {
                setTimeout(() => {
                    // Ensure shop tab is shown and products are loaded
                    const shopTab = document.getElementById('distributor-shop-tab');
                    if (shopTab && shopTab.classList.contains('active') || shopTab.style.display !== 'none') {
                        if (typeof loadShopProducts === 'function') {
                            loadShopProducts();
                        }
                    }
                    // Load media preview widget
                    if (typeof loadMediaPreviewWidget === 'function') {
                        loadMediaPreviewWidget();
                    }
                }, 200);
            }
            
            // Front Desk Portal - ensure internal tabs are visible
            if (tabName === 'frontdesk') {
                setTimeout(() => {
                    // Show all internal tabs within the front desk portal
                    const frontdeskTabsContainer = document.querySelector('#frontdesk .tabs');
                    if (frontdeskTabsContainer) {
                        const internalTabButtons = frontdeskTabsContainer.querySelectorAll('.tab-button');
                        internalTabButtons.forEach(btn => {
                            btn.style.display = 'inline-block';
                        });
                    }
                    // Ensure the default pending orders tab is shown
                    const pendingTab = document.getElementById('pendingOrders');
                    if (pendingTab) {
                        pendingTab.style.display = 'block';
                        pendingTab.classList.add('active');
                    }
                }, 100);
            }
        }

        // Ensure openTab is accessible from inline onclick handlers
        if (typeof window !== 'undefined') {
            window.openTab = openTab;
        }

        // MIS Portal Functions
        function initializeMISPortal() {
            loadMISBranches();
            displayMISReports();
        }

        function loadMISBranches() {
            const branchSelect = document.getElementById('misBranchSelect');
            if (!branchSelect) return;
            
            // Clear existing options except "All Branches"
            branchSelect.innerHTML = '<option value="all">All Branches</option>';
            
            // Add branches
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                branchSelect.appendChild(option);
            });
        }

        function filterMISReports() {
            const branchId = document.getElementById('misBranchSelect')?.value || 'all';
            const searchTerm = document.getElementById('misSearchInput')?.value?.toLowerCase() || '';
            const fromInput = document.getElementById('misDateFrom')?.value || '';
            const toInput = document.getElementById('misDateTo')?.value || '';
            const fromTs = fromInput ? new Date(fromInput).getTime() : null;
            const toTs = toInput ? new Date(toInput).getTime() : null;
            
            let filteredReports = reports.filter(report => {
                // Branch filter (only applies if report has branch info)
                if (branchId !== 'all') {
                    const rptBranch = report.branch || report.clientInfo?.branch || null;
                    if (!rptBranch || rptBranch !== branchId) {
                        return false;
                    }
                }
                
                // Time filter
                if (fromTs || toTs) {
                    const rptTs = report.timestamp ? new Date(report.timestamp).getTime() : null;
                    if (!rptTs) return false;
                    if (fromTs && rptTs < fromTs) return false;
                    if (toTs && rptTs > toTs) return false;
                }
                
                // Filter by search term (name or NB number)
                if (searchTerm) {
                    const name = report.clientInfo?.fullName?.toLowerCase() || '';
                    const nbNumber = report.clientInfo?.nbNumber?.toLowerCase() || '';
                    const receiptId = report.id?.toLowerCase() || '';
                    const consultant = (report.consultant || '').toLowerCase();
                    
                    return name.includes(searchTerm) || nbNumber.includes(searchTerm) || receiptId.includes(searchTerm) || consultant.includes(searchTerm);
                }
                
                return true;
            });
            
            displayMISReportsTable(filteredReports);
            updateMISSummary(filteredReports);
        }

        function displayMISReports() {
            // Default to today's receipts if no date range selected
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            if (fromInput && toInput && !fromInput.value && !toInput.value) {
                setMISDateToday();
            } else {
                filterMISReports();
            }
        }

        function displayMISReportsTable(reportsToDisplay) {
            const displayDiv = document.getElementById('misReportsDisplay');
            if (!displayDiv) return;
            
            if (reportsToDisplay.length === 0) {
                displayDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No sales receipts found.</p>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #c41e3a; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Invoice No.</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Client</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Items Purchased</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Time</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Dispenser</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            reportsToDisplay.forEach((report, index) => {
                const dt = report.timestamp ? new Date(report.timestamp) : null;
                const date = dt ? dt.toLocaleDateString('en-GB') : '‚Äî';
                const time = dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '‚Äî';
                const totalAmount = calculateReportTotal(report);
                const itemsPurchased = getItemsPurchased(report).join('; ');
                const dispenser = getReportDispenser(report) || '‚Äî';
                
                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                html += `
                    <tr style="background: ${rowColor};">
                        <td style="padding: 10px; border: 1px solid #ddd;">${report.id}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${report.clientInfo?.fullName || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${itemsPurchased || '‚Äî'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${time}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${dispenser}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">N$${totalAmount.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            displayDiv.innerHTML = html;
        }

        function getItemsPurchased(report) {
            if (Array.isArray(report.medicines) && report.medicines.length > 0) {
                return report.medicines.map(m => m.name).filter(Boolean);
            }
            if (Array.isArray(report.products) && report.products.length > 0) {
                return report.products.map(p => p.name || p.product || p.description).filter(Boolean);
            }
            return [];
        }

        function getReportDispenser(report) {
            // Prefer dispenser from any dispensed medicine
            if (Array.isArray(report.medicines)) {
                const dispensed = report.medicines.find(m => m.dispensedBy);
                if (dispensed && dispensed.dispensedBy) return dispensed.dispensedBy;
                const paidBy = report.medicines.find(m => m.paidBy);
                if (paidBy && paidBy.paidBy) return paidBy.paidBy;
            }
            // Fallbacks: consultant or explicit cashier fields if present
            return report.dispensedBy || report.cashier || report.consultant || null;
        }

        function setMISDateToday() {
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            const toLocal = (d) => {
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };
            if (fromInput) fromInput.value = toLocal(start);
            if (toInput) toInput.value = toLocal(end);
            filterMISReports();
        }

        function clearMISDateFilters() {
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            if (fromInput) fromInput.value = '';
            if (toInput) toInput.value = '';
            filterMISReports();
        }

        function calculateReportTotal(report) {
            if (!report || !report.medicines || report.medicines.length === 0) return 0;

            try {
                // Derive client membership status if available
                let membership = report.clientInfo?.membershipStatus;
                if (!membership && typeof clients !== 'undefined' && Array.isArray(clients)) {
                    const clientRef = report.clientId || report.clientInfo?.referenceNumber || report.clientInfo?.nbNumber;
                    const client = clients.find(c => c.referenceNumber === clientRef);
                    membership = client?.membershipStatus;
                }

                if (membership === 'member' || membership === 'referred') {
                    const totals = calculatePrescriptionTotals(report.medicines, membership);
                    return membership === 'member' ? (totals.total?.dp || 0) : (totals.total?.cp || 0);
                }
            } catch (e) {}

            // Fallback: sum CP from currentPrice when membership is unknown
            return report.medicines.reduce((total, med) => {
                if (med.currentPrice) {
                    const quantity = med.quantity || 1;
                    return total + ((med.currentPrice.cp || 0) * quantity);
                }
                return total;
            }, 0);
        }

        function updateMISSummary(reportsToDisplay) {
            const totalCount = document.getElementById('misTotalCount');
            const branchSummary = document.getElementById('misBranchSummary');
            const stockSummary = document.getElementById('misStockSummary');
            
            if (totalCount) {
                totalCount.textContent = `Total Records: ${reportsToDisplay.length}`;
            }
            
            if (branchSummary) {
                const byBranch = {};
                reportsToDisplay.forEach(r => {
                    const key = r.branch || r.clientInfo?.branch || 'Unknown';
                    byBranch[key] = (byBranch[key] || 0) + 1;
                });
                const parts = Object.entries(byBranch).map(([k, v]) => `${k}: ${v}`);
                branchSummary.textContent = parts.length ? `By Branch: ${parts.join(' | ')}` : `Showing ${reportsToDisplay.length} receipt(s)`;
            }

            // Stock summary (company-wide quick view)
            if (stockSummary) {
                try {
                    const inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}');
                    const totals = Object.keys(inv).reduce((acc, k) => {
                        const q = parseFloat(inv[k]?.currentStock || 0);
                        const ro = inv[k]?.reorderLevel ?? 5;
                        acc.qty += q;
                        if (q <= ro) acc.low += 1;
                        return acc;
                    }, { qty: 0, low: 0 });
                    stockSummary.textContent = `Stock: Qty ${totals.qty} | Low ${totals.low}`;
                } catch (e) {
                    stockSummary.textContent = 'Stock: N/A';
                }
            }

            renderMISBranchDailySummary(reportsToDisplay);

            // Render inventory breakdown table (uses consolidated inventory for now)
            try {
                const branchId = document.getElementById('misBranchSelect')?.value || 'all';
                renderInventoryBreakdown('misInventoryBreakdown', branchId);
            } catch (e) {}
        }

        function refreshMISData() {
            refreshAllData().then(() => {
                displayMISReports();
                alert('MIS data refreshed successfully!');
                try {
                    const branchId = document.getElementById('misBranchSelect')?.value || 'all';
                    renderInventoryBreakdown('misInventoryBreakdown', branchId);
                } catch (e) {}
            });
        }

        function exportMISData() {
            const csv = convertReportsToCSV(reports);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MIS_Sales_Receipts_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function convertReportsToCSV(reportsData) {
            let csv = 'Receipt ID,Date,Client Name,NB Number,Phone,Email,Consultant,Total Amount,Medicines\n';
            
            reportsData.forEach(report => {
                const date = new Date(report.timestamp).toLocaleDateString('en-GB');
                const totalAmount = calculateReportTotal(report);
                const medicinesList = report.medicines?.map(m => m.name).join('; ') || 'N/A';
                
                csv += `"${report.id}",`;
                csv += `"${date}",`;
                csv += `"${report.clientInfo?.fullName || 'N/A'}",`;
                csv += `"${report.clientInfo?.nbNumber || 'N/A'}",`;
                csv += `"${report.clientInfo?.phone || 'N/A'}",`;
                csv += `"${report.clientInfo?.email || 'N/A'}",`;
                csv += `"${report.consultant || 'N/A'}",`;
                csv += `"N$${totalAmount.toFixed(2)}",`;
                csv += `"${medicinesList}"\n`;
            });
            
            return csv;
        }

        // Generic renderer for inventory breakdown tables using dynapharm_inventory
        function renderInventoryBreakdown(targetId, branchId = 'all') {
            const el = document.getElementById(targetId);
            if (!el) return;
            let inv = {};
            try { inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}'); } catch (e) { inv = {}; }
            const entries = Object.keys(inv).map(name => ({
                name,
                qty: parseFloat(inv[name]?.currentStock || 0),
                reorder: inv[name]?.reorderLevel ?? 5
            }));
            if (entries.length === 0) {
                el.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:20px;">No inventory records found.</p>';
                return;
            }
            const rows = entries.map(e => {
                const low = e.qty <= e.reorder;
                return `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${e.name}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right; font-weight:700; color:${low ? '#e74c3c' : '#27ae60'};">${e.qty}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${e.reorder}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${low ? '‚ö†Ô∏è Low' : '‚úÖ OK'}</td>
                    </tr>`;
            }).join('');
            el.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Product</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Qty</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Reorder</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }

        function printMISReport() {
            window.print();
        }

        function renderMISBranchDailySummary(reportsToDisplay) {
            const container = document.getElementById('misBranchDailySummary');
            if (!container) return;
            if (!reportsToDisplay || reportsToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No data for selected range.</p>';
                return;
            }
            const groups = {};
            reportsToDisplay.forEach(r => {
                const branch = r.branch || r.clientInfo?.branch || 'Unknown';
                if (!groups[branch]) {
                    groups[branch] = { count: 0, total: 0 };
                }
                groups[branch].count += 1;
                groups[branch].total += calculateReportTotal(r);
            });
            let html = '<table style="width: 100%; border-collapse: collapse;">\n<thead>\n<tr style="background: #2c3e50; color: white;">\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Branch</th>\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Receipts</th>\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Total Amount</th>\n</tr>\n</thead><tbody>';
            Object.entries(groups).forEach(([branch, stats], i) => {
                const rowColor = i % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${rowColor};"><td style="padding: 10px; border: 1px solid #ddd;">${branch}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.count}</td><td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">N$${stats.total.toFixed(2)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function calculateAge() {
            const dob = document.querySelector('[name="dob"]').value;
            if (dob) {
                const age = Math.floor((new Date() - new Date(dob)) / 31536000000);
                document.getElementById('age').value = age;
            }
        }

        function selectNA(fieldName) {
            const checkboxes = document.querySelectorAll(`[name="${fieldName}"]`);
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('mh_na').checked = true;
        }

        // Toggle diet options visibility based on user selection
        function toggleDietOptions() {
            try {
                const dietYes = document.getElementById('dietYes');
                const dietNo = document.getElementById('dietNo');
                const dietOptions = document.getElementById('dietOptions');
                const dietOther = document.querySelector('input[name="dietOther"]');
                
                if (!dietOptions) {
                    console.warn('‚ö†Ô∏è Diet options element not found');
                    return;
                }
                
                // Show diet options if "Yes" is selected, hide if "No" is selected
                if (dietYes && dietYes.checked) {
                    dietOptions.style.display = 'block';
                    if (dietOther) {
                        dietOther.style.display = 'block';
                        dietOther.style.marginTop = '10px';
                    }
                    // Make selection required when visible
                    dietOptions.setAttribute('required', 'required');
                } else if (dietNo && dietNo.checked) {
                    dietOptions.style.display = 'none';
                    if (dietOther) {
                        dietOther.style.display = 'none';
                        dietOther.value = '';
                    }
                    // Clear selections when hidden
                    const options = dietOptions.querySelectorAll('option');
                    options.forEach(opt => opt.selected = false);
                    dietOptions.removeAttribute('required');
                }
            } catch (error) {
                console.error('‚ùå Error in toggleDietOptions:', error);
            }
        }
        
        // Make function globally accessible for inline event handlers
        if (typeof window !== 'undefined') {
            window.toggleDietOptions = toggleDietOptions;
        }

        // Enhanced signature with camera support
        function signDocument() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Check if user wants to use camera or enter text
                const useCamera = confirm('Would you like to capture signature using camera? (Click OK for camera, Cancel for text input)');
                if (useCamera) {
                    captureSignatureWithCamera();
                } else {
            const name = prompt('Enter your full name for signature:');
            if (name) {
                document.getElementById('signatureField').value = name;
                document.getElementById('signaturePad').innerHTML = `Signed: ${name}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
                    }
                }
            } else {
                const name = prompt('Enter your full name for signature:');
                if (name) {
                    document.getElementById('signatureField').value = name;
                    document.getElementById('signaturePad').innerHTML = `Signed: ${name}<br>${new Date().toLocaleString()}`;
                    document.getElementById('signaturePad').style.background = '#e8f5e9';
                }
            }
        }

        function captureSignatureWithCamera() {
            const video = document.createElement('video');
            video.style.width = '100%';
            video.style.maxWidth = '400px';
            video.autoplay = true;
            video.playsInline = true;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;';
            
            const container = document.createElement('div');
            container.style.cssText = 'background: white; padding: 20px; border-radius: 10px; max-width: 90%;';

            const controls = document.createElement('div');
            controls.style.cssText = 'margin-top: 15px; display: flex; gap: 10px; justify-content: center;';

            const captureBtn = document.createElement('button');
            captureBtn.className = 'btn btn-success';
            captureBtn.textContent = 'üì∑ Capture';
            captureBtn.onclick = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                const dataURL = canvas.toDataURL('image/png');
                document.getElementById('signatureField').value = 'Signature captured';
                document.getElementById('signaturePad').innerHTML = `<img src="${dataURL}" style="max-width: 100%; border-radius: 5px;" alt="Signature"><br>Captured: ${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
                // Store signature image
                localStorage.setItem('lastSignature', dataURL);
                stopCamera();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = stopCamera;

            controls.appendChild(captureBtn);
            controls.appendChild(cancelBtn);
            container.appendChild(video);
            container.appendChild(controls);
            modal.appendChild(container);
            document.body.appendChild(modal);

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    window.captureStream = stream;
                })
                .catch(err => {
                    alert('Camera access denied. Please enter signature manually.');
                    document.body.removeChild(modal);
                });

            function stopCamera() {
                if (window.captureStream) {
                    window.captureStream.getTracks().forEach(track => track.stop());
                }
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }
        }

        function handleConsentChange() {
            const consentCheck = document.getElementById('consentCheck');
            const fullName = document.querySelector('input[name="fullName"]').value.trim();
            
            if (consentCheck.checked && fullName) {
                // Auto-fill signature with client's name
                document.getElementById('signatureField').value = fullName;
                document.getElementById('signaturePad').innerHTML = `Signed: ${fullName}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
            } else if (!consentCheck.checked) {
                // Clear signature if consent is unchecked
                document.getElementById('signatureField').value = '';
                document.getElementById('signaturePad').innerHTML = 'Click here to sign electronically';
                document.getElementById('signaturePad').style.background = '#f0f8ff';
            }
        }

        function printClientForm() {
            // Get form data
            const formData = new FormData(document.getElementById('clientForm'));
            const branchSelect = document.getElementById('branchSelect');
            const branchName = branchSelect.options[branchSelect.selectedIndex]?.text || 'Select Branch';
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Client Registration Form</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 8mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 8pt;
                            line-height: 1.2;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 6px 10px;
                            text-align: center;
                            border-radius: 3px;
                            margin-bottom: 6px;
                        }
                        
                        .header h1 {
                            font-size: 14pt;
                            margin-bottom: 2px;
                        }
                        
                        .header p {
                            font-size: 7pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin-bottom: 5px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 3px 6px;
                            font-size: 9pt;
                            font-weight: bold;
                            border-radius: 2px;
                            margin-bottom: 3px;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 3px 8px;
                            background: #f8f9fa;
                            padding: 5px;
                            border-radius: 2px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 7pt;
                            line-height: 1.1;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 60px;
                            font-size: 7pt;
                        }
                        
                        .info-item[style*="grid-column: span 2"] {
                            grid-column: span 2;
                        }
                        
                        .info-item[style*="grid-column: span 3"] {
                            grid-column: span 3;
                        }
                        
                        .footer {
                            margin-top: 6px;
                            padding-top: 5px;
                            border-top: 1px solid #c41e3a;
                            font-size: 6pt;
                            text-align: center;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè• DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>CLIENT REGISTRATION FORM</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üë§ PERSONAL INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${formData.get('fullName') || ''}</div>
                            
                            <div class="info-item"><strong>Gender:</strong> ${formData.get('gender') || ''}</div>
                            <div class="info-item"><strong>DOB:</strong> ${formData.get('dob') || ''}</div>
                            <div class="info-item"><strong>Age:</strong> ${formData.get('age') || ''}y</div>
                            <div class="info-item"><strong>Height:</strong> ${formData.get('height') || ''}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${formData.get('weight') || ''}kg</div>
                            <div class="info-item"><strong>Phone:</strong> ${formData.get('phone') || ''}</div>
                            <div class="info-item"><strong>Email:</strong> ${formData.get('email') || ''}</div>
                            <div class="info-item"><strong>Occupation:</strong> ${formData.get('occupation') || ''}</div>
                            <div class="info-item" style="grid-column: span 2;"><strong>Emergency:</strong> ${formData.get('emergencyContact') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üë• MEMBERSHIP/REFERRAL</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Status:</strong> ${formData.get('membershipStatus') === 'member' ? 'Member' : 'Referred'}</div>
                            ${formData.get('membershipStatus') === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${formData.get('memberId') || 'N/A'}</div>
                                <div class="info-item"><strong>Since:</strong> ${formData.get('memberSince') || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${formData.get('referralName') || 'N/A'}</div>
                                <div class="info-item"><strong>NB:</strong> ${formData.get('referralNbNumber') || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üè• HEALTH INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;"><strong>Primary Reason:</strong> ${formData.get('primaryReason') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Surgeries:</strong> ${formData.get('surgeries') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Current Medications:</strong> ${formData.get('currentMedications') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Supplements:</strong> ${formData.get('supplements') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">üçé LIFESTYLE</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Water:</strong> ${formData.get('waterIntake') || ''}</div>
                            <div class="info-item"><strong>Exercise:</strong> ${formData.get('exerciseFreq') || ''}</div>
                            <div class="info-item"><strong>Sleep:</strong> ${formData.get('sleepHours') || ''}h</div>
                            <div class="info-item"><strong>Stress:</strong> ${formData.get('stressLevel') || ''}/10</div>
                            <div class="info-item"><strong>Smoking:</strong> ${formData.get('smoking') || ''}</div>
                            <div class="info-item"><strong>Alcohol:</strong> ${formData.get('alcohol') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">‚úÖ CONSENT & SIGNATURE</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;">
                                <strong>Consent:</strong> I consent to naturopathic care and understand all details are kept confidential.
                            </div>
                            <div class="info-item"><strong>Signature:</strong> ${formData.get('signature') || 'Not signed'}</div>
                            <div class="info-item"><strong>Date:</strong> ${new Date().toLocaleString()}</div>
                            <div class="info-item"></div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Confidential Registration Form</strong> - For inquiries: info@dynapharm.com.na | www.dynapharm.com.na</p>
                        <p>‚úì 2-Page Maximum Format | This information is confidential and for internal use only</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const visitType = formData.get('visitType') || '';
            const preferredBranch = formData.get('preferredBranch') || currentBranch || (function(){
                const checkSel = document.getElementById('checkupBranchSelect');
                return checkSel ? checkSel.value : '';
            })();
            if (!preferredBranch) {
                alert('Please select a branch.');
                return;
            }

            const preferredDate = formData.get('preferredDate');
            const preferredTime = formData.get('preferredTime');
            // Appointment preferences required only when booking appointment

            currentBranch = preferredBranch;
            const checkSel = document.getElementById('checkupBranchSelect');
            if (checkSel) checkSel.value = preferredBranch;

            const fullName = (formData.get('fullName') || '').trim();
            if (!fullName) {
                alert('Full Name is required');
                return;
            }
            const membershipStatus = formData.get('membershipStatus');
            const referralName = formData.get('referralName')?.trim();
            const referralNbNumber = formData.get('referralNbNumber')?.trim();
            
            // Referral details not required for simplified registration
            if (false && membershipStatus === 'referred') {
                if (!referralName) {
                    alert('‚ùå Referral Name is required for referred clients');
                    return;
                }
                
                if (!referralNbNumber) {
                    alert('‚ùå Referral NB Number is required for referred clients');
                    return;
                }
                
                // Validate NB number format (NB followed by any digits including 0)
                if (!/^NB[0-9]+$/.test(referralNbNumber)) {
                    alert('‚ùå Please enter a valid Referral NB Number (NB followed by any digits, e.g., NB12345678 or NB01234567)');
                    return;
                }
            }
            
            const firstName = fullName.split(' ')[0].toUpperCase();
            const referenceNumber = `CLT-${firstName}-${Date.now()}`;
            
            // Get NB number if it exists in form (may be optional)
            const nbNumber = formData.get('nbNumber')?.trim() || '';
            
            const client = {
                referenceNumber: referenceNumber,
                fullName: fullName,
                nbNumber: nbNumber, // Include NB number if provided
                email: formData.get('email') || '',
                phone: formData.get('phone') || '',
                membershipStatus: membershipStatus,
                referralName: referralName || '',
                referralNbNumber: referralNbNumber || '',
                memberId: formData.get('memberId') || '',
                memberSince: formData.get('memberSince') || '',
                gender: formData.get('gender') || '',
                dob: formData.get('dob') || '',
                age: formData.get('age') || '',
                height: formData.get('height') || '',
                weight: formData.get('weight') || '',
                occupation: formData.get('occupation') || '',
                emergencyContact: formData.get('emergencyContact') || '',
                primaryReason: formData.get('primaryReason') || '',
                medicalHistory: formData.getAll('medicalHistory') || [],
                currentMedications: formData.get('currentMedications') || '',
                supplements: formData.get('supplements') || '',
                familyHistory: formData.getAll('familyHistory') || [],
                waterIntake: formData.get('waterIntake') || '',
                exerciseFreq: formData.get('exerciseFreq') || '',
                sleepHours: formData.get('sleepHours') || '',
                stressLevel: formData.get('stressLevel') || '',
                symptoms: formData.getAll('symptoms') || [],
                signature: formData.get('signature') || '',
                preferredAppointment: (visitType === 'walkin') ? null : {
                    date: preferredDate,
                    time: preferredTime,
                    branch: preferredBranch
                },
                branch: preferredBranch,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Validate required fields before submitting
                if (!client.fullName || !client.phone || !client.email || !client.branch) {
                    alert('‚ùå Missing required fields. Please check:\n- Full Name\n- Phone Number\n- Email Address\n- Branch selection');
                    return;
                }
                
                // STEP 1: Save to backend database FIRST
                console.log('üíæ Saving client to backend database...');
                const result = await apiRequest('/clients', 'POST', client);
                
                // Handle different response formats
                const success = result?.success || (result?.client && result?.total !== undefined) || (result?.id && !result?.error);
                
                // STEP 2: Only proceed if backend save was successful
                if (!success) {
                    const errorMsg = result?.message || result?.error || 'Unknown error';
                    console.error('‚ùå Backend save failed:', errorMsg);
                    alert('‚ùå Error saving client to database: ' + errorMsg + '\n\nPlease try again or contact support.');
                    return; // Stop here - don't add to local arrays or trigger updates
                }
                
                console.log('‚úÖ Client saved to backend database successfully');
                
                // STEP 3: Now make it available to all users (add to local arrays and trigger real-time updates)
                // Add to clients array only after successful backend save
                    clients.push(client);
                    
                // Save to localStorage as cache/backup (backend is source of truth)
                    try {
                        localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    console.log(`‚úÖ Client cached to localStorage: ${referenceNumber}`);
                    } catch (storageError) {
                    console.error('‚ùå Error caching client to localStorage:', storageError);
                    // Continue anyway - backend save was successful
                    }
                    
                // STEP 4: Notify all users via real-time updates (only after successful backend save)
                    try {
                        // Publish via Vercel SSE channel "clients"
                        fetch('/api/realtime_publish', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                channel: 'clients',
                            event: { type: 'clients:updated', referenceNumber, action: 'created', ts: Date.now(), data: client }
                            })
                        }).catch(_ => {});
                    } catch(_) {}
                    try {
                        // Publish via Railway WebSocket gateway if configured
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'clients:updated', referenceNumber, action: 'created', ts: Date.now(), data: client } })
                            }).catch(_ => {});
                        }
                    } catch(_) {}
                
                // Dispatch window event for local listeners
                try {
                    window.dispatchEvent(new CustomEvent('clients:updated', { 
                        detail: { referenceNumber, action: 'created', client, ts: Date.now() } 
                    }));
                } catch(_) {}
            
                    const refEl = document.getElementById('clientRefNumber');
                    if (refEl) {
                        refEl.textContent = 'Reference Number: ' + referenceNumber;
                        refEl.style.display = 'block';
                    }
                    const landingRef = document.getElementById('landingClientRefNumber');
                    if (landingRef) {
                        landingRef.textContent = 'Reference Number: ' + referenceNumber;
                        landingRef.style.display = 'block';
                    }
            
                    alert(`‚úÖ Client saved successfully!\n\nReference: ${referenceNumber}\n${client.referralName ? `Referred by: ${client.referralName}\n\n` : ''}Save this reference number for future visits.`);

            // If appointment flow, create a simple appointment record
            try {
                if (visitType === 'appointment') {
                    const preferredDate = formData.get('preferredDate');
                    const preferredTime = formData.get('preferredTime');
                    if (!preferredDate || !preferredTime) {
                        alert('Please select a preferred appointment date and time.');
                    } else {
                        const appointment = {
                            id: 'APT' + Date.now(),
                            date: preferredDate,
                            time: preferredTime,
                            clientName: fullName,
                            branch: preferredBranch,
                            serviceType: 'Full Body Check-Up',
                            status: 'requested',
                            createdAt: new Date().toISOString(),
                            clientReference: referenceNumber,
                            clientForm: client
                        };
                        
                        // PRIMARY: Save to backend database
                        try {
                            const response = await fetch('/api/appointments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    id: appointment.id,
                                    client_reference: referenceNumber,
                                    full_name: fullName,
                                    phone: client.phone,
                                    email: client.email,
                                    date: preferredDate,
                                    time: preferredTime,
                                    branch: preferredBranch,
                                    type: 'Full Body Check-Up',
                                    status: 'pending',
                                    data: JSON.stringify({ clientForm: client })
                                })
                            });
                            
                            if (response.ok) {
                                console.log('‚úÖ Appointment saved to backend database');
                            }
                        } catch (apiError) {
                            console.warn('Backend save failed, using local storage:', apiError);
                        }
                        
                        // FALLBACK: Also save to local storage as cache
                        try {
                            appointments.push(appointment);
                            localStorage.setItem('dyna_appointments', JSON.stringify(appointments));
                        } catch(_){ }
                        
                        // Also save to dyna_consult_appointments for appointments-admin.html
                        try {
                            const consultAppts = JSON.parse(localStorage.getItem('dyna_consult_appointments') || '[]');
                            const consultAppt = {
                                id: 'appt_' + Date.now(),
                                fullName: fullName,
                                phone: client.phone,
                                email: client.email,
                                date: preferredDate,
                                time: preferredTime,
                                branch: preferredBranch,
                                type: 'Full Body Check-Up',
                                status: 'pending',
                                createdAt: new Date().toISOString(),
                                clientReference: referenceNumber,
                                clientForm: client
                            };
                            consultAppts.push(consultAppt);
                            localStorage.setItem('dyna_consult_appointments', JSON.stringify(consultAppts));
                        } catch(_){ }
                        
                        (function(msg){
                            const el = document.createElement('div');
                            el.style.cssText = 'position:fixed;top:20px;right:20px;background:#111827;color:#fff;border-left:4px solid #16a34a;padding:12px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:9999;';
                            el.textContent = msg;
                            document.body.appendChild(el);
                            setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity 300ms'; setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); }, 320); }, 2500);
                        })(`‚úÖ Appointment request sent. Ref: ${referenceNumber} (${preferredDate} @ ${preferredTime})`);
                    }
                }
            } catch (e) { console.warn('Appointment creation step skipped:', e); }
            
            if (confirm('Print form?')) {
                window.print();
                }
            } catch (error) {
                console.error('‚ùå Error saving client:', error);
                console.error('Error details:', {
                    message: error?.message,
                    stack: error?.stack,
                    client: client
                });
                
                // Show user-friendly error message
                let errorMsg = '‚ùå Error saving client form:\n\n';
                if (error?.message) {
                    errorMsg += `Error: ${error.message}\n\n`;
                }
                errorMsg += 'Please check:\n';
                errorMsg += '1. All required fields are filled\n';
                errorMsg += '2. Internet connection is active\n';
                errorMsg += '3. Browser console for details (F12)\n\n';
                errorMsg += 'Attempting to save locally as backup...';
                
                // Fallback: Save directly to localStorage if API fails
                try {
                    clients.push(client);
                    localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    
                    const refEl = document.getElementById('clientRefNumber');
                    if (refEl) {
                        refEl.textContent = 'Reference Number: ' + referenceNumber;
                        refEl.style.display = 'block';
                    }
                    
                    alert(`‚ö†Ô∏è API unavailable, but client saved locally!\n\nReference: ${referenceNumber}\n${client.referralName ? `Referred by: ${client.referralName}\n\n` : ''}Save this reference number. Data will sync when API is available.`);
                    
                    // Broadcast client update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('clients:updated', { 
                            detail: { client: referenceNumber, action: 'created', ts: Date.now() } 
                        }));
                    } catch(_) {}
                    
                } catch (fallbackError) {
                    console.error('‚ùå Critical: Failed to save client even to localStorage:', fallbackError);
                    alert('‚ùå Critical Error: Failed to save client.\n\nError: ' + (fallbackError?.message || 'Unknown error') + '\n\nPlease:\n1. Take a screenshot of this error\n2. Contact support\n3. Copy your form data before refreshing');
                }
            }
        });

        function clearForm() {
            if (confirm('Are you sure you want to clear the entire form? All data will be lost.')) {
                const form = document.getElementById('clientForm');
                if (!form) return;
                form.reset();

                const signatureField = document.getElementById('signatureField');
                if (signatureField) signatureField.value = '';
                const signaturePad = document.getElementById('signaturePad');
                if (signaturePad) {
                    signaturePad.innerHTML = 'Tap to sign electronically';
                    signaturePad.style.background = '#fff6f8';
                }

                const memberDetails = document.getElementById('memberDetails');
                const referralDetails = document.getElementById('referralDetails');
                if (memberDetails) memberDetails.style.display = 'none';
                if (referralDetails) referralDetails.style.display = 'none';
                document.querySelectorAll('.membership-option').forEach(option => option.classList.remove('active'));

                const visitBadge = document.getElementById('visitTypeBadge');
                if (visitBadge) visitBadge.textContent = '‚Äî';
                const referencePreview = document.getElementById('referencePreview');
                if (referencePreview) referencePreview.textContent = 'Generated on save';
                const preferredDateDisplay = document.getElementById('preferredDateDisplay');
                if (preferredDateDisplay) preferredDateDisplay.textContent = '‚Äî';
                const refNumberDisplay = document.getElementById('clientRefNumber');
                if (refNumberDisplay) refNumberDisplay.style.display = 'none';

                initializeAppointmentPreferences();
            }
        }

        function printClientForm() {
            // Ensure we're on the client tab
            openTab('client');
            
            // Add a small delay to ensure the tab is active
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function showLogin(portal) {
    const targetPortal = portal;
    if (currentUser && isPortalAllowedForRole(currentUser.role, targetPortal)) {
        currentPortal = targetPortal;
        window.currentPortal = targetPortal;
        handlePortalLoginSuccess(currentUser, { silent: true });
        return;
    }
    openLoginModal(targetPortal);
}

const PORTAL_LABELS = {
    frontdesk: 'Front Desk',
    consultant: 'Consultant',
    dispenser: 'Branch',
    admin: 'Admin',
    finance: 'Finance',
    stock: 'Stock',
    mis: 'MIS',
    gm: 'General Manager',
    director: 'Director',
    'hr-portal': 'HR',
    client: 'Client'
};
const loginModal = document.getElementById('loginModal');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const loginSubmitButton = document.getElementById('loginSubmitButton');
const loginCancelButton = document.getElementById('loginCancelButton');
const loginCloseButton = document.getElementById('loginCloseButton');
let loginModalPreviousFocus = null;
let loginTrapHandler = null;

function getPortalLabel(portal) {
    if (!portal) return 'Portal';
    return PORTAL_LABELS[portal] || portal.charAt(0).toUpperCase() + portal.slice(1);
}

function trapFocus(event, container) {
    if (event.key !== 'Tab') return;
    const focusable = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey) {
        if (document.activeElement === first) {
            event.preventDefault();
            last.focus();
        }
    } else if (document.activeElement === last) {
        event.preventDefault();
        first.focus();
    }
}

function handleLoginEscape(event) {
    if (event.key === 'Escape') {
        event.preventDefault();
        closeLoginModal();
    }
}

function openLoginModal(portal) {
    currentPortal = portal;
    window.currentPortal = portal;
    const label = getPortalLabel(portal);
    const modalTitle = document.getElementById('loginModalTitle');
    if (modalTitle) modalTitle.textContent = `${label} Portal Login`;
    const modalDescription = document.getElementById('loginModalDescription');
    if (modalDescription) modalDescription.textContent = `Sign in to access the ${label.toLowerCase()} portal.`;
    if (loginError) loginError.textContent = '';
    if (loginForm) loginForm.reset();
    loginModalPreviousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
    if (loginModal) {
        loginModal.style.display = 'block';
        loginModal.setAttribute('aria-hidden', 'false');
        loginTrapHandler = (event) => trapFocus(event, loginModal);
        loginModal.addEventListener('keydown', loginTrapHandler);
    }
    document.addEventListener('keydown', handleLoginEscape);
    const usernameField = document.getElementById('username');
    if (usernameField) usernameField.focus();
}

function closeLoginModal() {
    if (loginModal) {
        loginModal.style.display = 'none';
        loginModal.setAttribute('aria-hidden', 'true');
        if (loginTrapHandler) {
            loginModal.removeEventListener('keydown', loginTrapHandler);
            loginTrapHandler = null;
        }
    }
    document.removeEventListener('keydown', handleLoginEscape);
    if (loginError) loginError.textContent = '';
    if (loginForm) loginForm.reset();
    if (loginModalPreviousFocus && typeof loginModalPreviousFocus.focus === 'function') {
        loginModalPreviousFocus.focus();
    }
    loginModalPreviousFocus = null;
}

async function loginPortalRequest(username, password) {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
        credentials: 'include'
    });
    let data = null;
    try {
        data = await response.json();
    } catch (_) {}
    if (!response.ok) {
        throw new Error(data?.error || 'Invalid username or password');
    }
    return data;
}

async function logoutRequest() {
    try {
        await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        });
    } catch (_) {}
}

function isPortalAllowedForRole(role, portal) {
    const normalizedRole = (role || '').toLowerCase();
    if (!normalizedRole) return false;
    if (normalizedRole === 'admin') return true;
    const allowed = ROLE_PORTAL_ACCESS[normalizedRole] || [];
    return allowed.includes(portal);
}

function setAuthenticatedUser(user) {
    currentUser = { ...user };
    window.currentUser = currentUser;
    if (Array.isArray(users)) {
        const existingIndex = users.findIndex(u => u.id === currentUser.id);
        if (existingIndex >= 0) {
            users[existingIndex] = { ...users[existingIndex], ...currentUser };
                } else {
            users.push({ ...currentUser });
        }
    }
    try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch (_) {}
    const normalizedRole = (user.role || 'guest').toLowerCase();
    setCurrentUserRole(normalizedRole);
}

function handlePortalLoginSuccess(user, options = {}) {
    setAuthenticatedUser(user);
    const role = (user.role || '').toLowerCase();
    hideLandingPage();
    showAuthorizedPortals(role);
    updateNavigationForUser(user, role);

    const portal = currentPortal;
    if (portal) {
        const authElement = document.getElementById(portal + 'Auth');
        const contentElement = document.getElementById(portal + 'Content');
        if (authElement) authElement.style.display = 'none';
        if (contentElement) contentElement.style.display = 'block';
    }

    try {
        if ((portal === 'consultant' || portal === 'dispenser')) {
                    if (!currentBranch || currentBranch === '') {
                        if (user.branch) {
                            currentBranch = user.branch;
                        } else if (Array.isArray(user.branches) && user.branches.length > 0) {
                            currentBranch = user.branches[0];
                }
                const branchSelect = document.getElementById('branchSelect');
                if (branchSelect && currentBranch) branchSelect.value = currentBranch;
                const checkupBranchSelect = document.getElementById('checkupBranchSelect');
                if (checkupBranchSelect && currentBranch) checkupBranchSelect.value = currentBranch;
            }
        }
    } catch (_) {}

            setTimeout(() => {
        try {
                startAutoRefresh();
                showRealtimeStatus();
        } catch (_) {}
    }, 1000);

    const branchName = branches.find(b => b.id === user.branch)?.name || user.branch || 'Unknown';
    if (portal) {
        const profile = document.getElementById(portal + 'Profile');
        if (profile) {
                profile.innerHTML = `
                <h4>Welcome, ${user.fullName || user.username}</h4>
                    <p>Role: ${user.role} | Branch: ${branchName}</p>
                    <button class="btn btn-warning" onclick="showChangePassword()">Change Password</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
        }
            }
            
    if (portal === 'consultant') {
                displayClients();
                displayMyReports();
                displayFollowUps();
    } else if (portal === 'dispenser') {
                displayPrescriptions();
                displayPriceList();
                showDispenserTab('stock');
    } else if (portal === 'mis') {
                loadMISBranches();
                displayMISReports();
    } else if (portal === 'admin') {
                loadUserList();
                loadBranchListAdmin();
            }
            
    if (!options.silent) {
        try {
            alert(`Welcome, ${user.fullName || user.username}! Real-time sync activated.`);
        } catch (_) {}
    }
}

if (loginCancelButton) {
    loginCancelButton.addEventListener('click', () => {
        closeLoginModal();
    });
}
if (loginCloseButton) {
    loginCloseButton.addEventListener('click', () => {
        closeLoginModal();
    });
}
if (loginModal) {
    loginModal.addEventListener('click', (event) => {
        if (event.target === loginModal) {
            closeLoginModal();
        }
    });
}

if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!currentPortal) {
            if (loginError) loginError.textContent = 'Please select a portal to continue.';
            return;
        }
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('password');
        const username = usernameField ? usernameField.value.trim() : '';
        const password = passwordField ? passwordField.value || '' : '';
        if (!username || !password) {
            if (loginError) loginError.textContent = 'Username and password are required.';
            if (!username && usernameField) usernameField.focus();
            else if (passwordField) passwordField.focus();
            return;
        }
        if (loginError) loginError.textContent = '';
        const originalButtonText = loginSubmitButton ? loginSubmitButton.textContent : 'Login';
        if (loginSubmitButton) {
            loginSubmitButton.disabled = true;
            loginSubmitButton.textContent = 'Signing in...';
        }
        try {
            const data = await loginPortalRequest(username, password);
            const user = data?.user;
            if (!user) {
                throw new Error('Unexpected response from server.');
            }
            if (!isPortalAllowedForRole(user.role, currentPortal)) {
                await logoutRequest();
                if (loginError) loginError.textContent = `The ${getPortalLabel(currentPortal)} portal is not available for the ${user.role} role.`;
                if (passwordField) {
                    passwordField.value = '';
                    passwordField.focus();
                }
                return;
            }
            handlePortalLoginSuccess(user);
            closeLoginModal();
        } catch (error) {
            if (loginError) loginError.textContent = error.message || 'Unable to login. Please try again.';
            if (passwordField) {
                passwordField.value = '';
                passwordField.focus();
            }
        } finally {
            if (loginSubmitButton) {
                loginSubmitButton.disabled = false;
                loginSubmitButton.textContent = originalButtonText;
            }
        }
    });
}

async function logout() {
    const portal = currentPortal;
    await logoutRequest();
            currentUser = null;
    window.currentUser = null;
    currentPortal = null;
    window.currentPortal = null;
    try { localStorage.removeItem('currentUser'); } catch (_) {}
    setCurrentUserRole('guest');
            stopAutoRefresh();
            hideRealtimeStatus();
    closeLoginModal();
    if (portal) {
        const authElement = document.getElementById(portal + 'Auth');
        const contentElement = document.getElementById(portal + 'Content');
        if (authElement) authElement.style.display = 'block';
        if (contentElement) contentElement.style.display = 'none';
    }
            openTab('client');
    showLandingPage();
    showLandingTab('shop');
    setTimeout(() => {
        if (typeof loadShopProducts === 'function') {
            loadShopProducts();
        }
    }, 500);
        }

        async function displayClients() {
            // Refresh data from API
            await loadData();
            
            const list = document.getElementById('clientList');
            
            // Get branch filter value
            const branchFilter = document.getElementById('consultantBranchFilter')?.value || '';
            
            // Populate branch filter dropdown if not already populated
            const branchFilterSelect = document.getElementById('consultantBranchFilter');
            if (branchFilterSelect && branchFilterSelect.options.length <= 1) {
                branchFilterSelect.innerHTML = '<option value="">All Branches</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name || branch.id;
                    branchFilterSelect.appendChild(option);
                });
                // Restore selected value
                if (branchFilter) branchFilterSelect.value = branchFilter;
            }
            
            // Filter clients by branch if filter is selected
            let filteredClients = clients;
            if (branchFilter) {
                filteredClients = clients.filter(client => {
                    const clientBranch = client.branch;
                    // Match by branch ID or name
                    return clientBranch === branchFilter || 
                           branches.find(b => (b.id === branchFilter || b.name === branchFilter) && (b.id === clientBranch || b.name === clientBranch));
                });
            }
            
            if (filteredClients.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìã No clients found</h3><p>${branchFilter ? 'No clients registered for the selected branch.' : 'Clients will appear here once they register through the client portal.'}</p></div>`;
                return;
            }
            
            // Sort clients by timestamp - latest first
            const sortedClients = [...filteredClients].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            sortedClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'üë§ Member' : 'ü§ù Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üìû Phone:</strong> ${client.phone}</p>
                        <p><strong>üéÇ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>üë§ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>üÜî Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>üìÖ Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üéØ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">üìù Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Search functionality for consultant portal
        function searchClients(portal) {
            const searchTerm = document.getElementById('consultantSearch').value.toLowerCase();
            const list = document.getElementById('clientList');
            const branchFilter = document.getElementById('consultantBranchFilter')?.value || '';
            
            if (!searchTerm) {
                displayClients();
                return;
            }
            
            // First filter by branch if selected
            let filteredClients = clients;
            if (branchFilter) {
                filteredClients = clients.filter(client => {
                    const clientBranch = client.branch;
                    return clientBranch === branchFilter || 
                           branches.find(b => (b.id === branchFilter || b.name === branchFilter) && (b.id === clientBranch || b.name === clientBranch));
                });
            }
            
            // Then filter by search term
            filteredClients = filteredClients.filter(client => 
                client.fullName.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                client.referenceNumber.toLowerCase().includes(searchTerm) ||
                client.nbNumber.includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No clients found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Sort search results by timestamp - latest first
            filteredClients.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            filteredClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'üë§ Member' : 'ü§ù Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üìû Phone:</strong> ${client.phone}</p>
                        <p><strong>üéÇ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>üë§ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>üÜî Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>üìÖ Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üéØ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">üìù Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllClients(portal) {
            document.getElementById('consultantSearch').value = '';
            const branchFilter = document.getElementById('consultantBranchFilter');
            if (branchFilter) branchFilter.value = '';
            displayClients();
        }

        function toggleConsultantView(view) {
            const mainSection = document.getElementById('consultantMainSection');
            const staffSection = document.getElementById('consultantStaffSection');
            const mainBtn = document.getElementById('consultantMainTabBtn');
            const staffBtn = document.getElementById('consultantStaffTabBtn');
            if (!mainSection || !staffSection || !mainBtn || !staffBtn) return;

            if (view === 'staff') {
                mainSection.style.display = 'none';
                staffSection.style.display = 'block';
                staffBtn.classList.add('btn-primary');
                mainBtn.classList.remove('btn-primary');
                refreshStaffServices('consultant');
            } else {
                mainSection.style.display = 'block';
                staffSection.style.display = 'none';
                mainBtn.classList.add('btn-primary');
                staffBtn.classList.remove('btn-primary');
            }
        }

        registerStaffServicesContext('consultant', {
            leaveStatusId: 'staffLeaveStatus-consultant',
            cashStatusId: 'staffCashStatus-consultant'
        });

        async function refreshConsultantData() {
            await loadData();
            await displayClients();
            await displayMyReports();
            await displayFollowUps();
            await refreshAnalytics();
        }

        async function refreshAnalytics() {
            await loadData();
            
            const display = document.getElementById('analyticsDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Performance Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalClients}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total Clients</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalReports}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Reports Created</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 28pt; margin-bottom: 5px;">${analyticsData.followUpsDue}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Follow-ups Due</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 28pt; margin-bottom: 5px;">${analyticsData.conversionRate}%</h3>
                            <p style="color: #666; font-size: 0.9rem;">Member Conversion</p>
                        </div>
                    </div>

                    <!-- Client Type Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üë• Client Distribution</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Registered Members:</span>
                                    <strong style="color: #27ae60;">${analyticsData.memberClients}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.memberPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Referred Clients:</span>
                                    <strong style="color: #f39c12;">${analyticsData.referredClients}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 10px; border-radius: 5px;">
                                    <div style="background: #f39c12; height: 100%; width: ${analyticsData.referredPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Follow-up Compliance</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Completed Follow-ups:</span>
                                    <strong style="color: #27ae60;">${analyticsData.completedFollowUps}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.followUpCompleteRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Missed Follow-ups:</span>
                                    <strong style="color: #e74c3c;">${analyticsData.missedFollowUps}</strong>
                                </div>
                                <div style="background: #ffebee; height: 10px; border-radius: 5px;">
                                    <div style="background: #e74c3c; height: 100%; width: ${analyticsData.followUpMissedRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                Compliance Rate: <strong style="color: #2196f3;">${analyticsData.followUpCompleteRate}%</strong>
                            </p>
                        </div>
                    </div>

                    <!-- Top Prescribed Products -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üíä Top Prescribed Products</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Times Prescribed</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">% of Scripts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analyticsData.topProducts.slice(0, 10).map((product, idx) => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                        <td style="padding: 8px;">${product.name}</td>
                                        <td style="padding: 8px; text-align: center;">${product.count}</td>
                                        <td style="padding: 8px; text-align: right;">
                                            <div style="display: inline-block; width: 60px; background: #e8f5e9; height: 8px; border-radius: 4px; vertical-align: middle;">
                                                <div style="background: #27ae60; height: 100%; width: ${product.percentage}%; border-radius: 4px;"></div>
                                            </div>
                                            <span style="margin-left: 5px;">${product.percentage}%</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Common Symptoms Treated -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ü©∫ Common Symptoms Treated</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            ${analyticsData.topSymptoms.slice(0, 8).map(symptom => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.9rem;">${symptom.name}</span>
                                        <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                            ${symptom.count}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateConsultantAnalytics(timeframe) {
            // Safety check for currentUser
            if (!currentUser || !currentUser.fullName) {
                console.warn('‚ö†Ô∏è currentUser not set, cannot calculate consultant analytics');
                return { totalReports: 0, totalClients: 0, totalRevenue: 0 };
            }
            const userFullName = currentUser.fullName; // Capture to prevent race conditions
            const myReports = reports.filter(r => r && r.consultant === userFullName);
            const myClients = clients.filter(c => {
                return myReports.some(r => r.clientId === c.referenceNumber);
            });
            
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = myReports.filter(r => new Date(r.timestamp) >= startDate);
            const filteredClients = myClients.filter(c => new Date(c.timestamp) >= startDate);
            
            // Calculate metrics
            const memberClients = filteredClients.filter(c => c.membershipStatus === 'member').length;
            const referredClients = filteredClients.filter(c => c.membershipStatus === 'referred').length;
            const totalClients = filteredClients.length;
            
            // Follow-up tracking
            const reportsWithFollowUp = filteredReports.filter(r => r.followUpDate);
            const followUpsDue = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                return followUpDate < new Date();
            }).length;
            
            // Check for completed follow-ups (client has another report after follow-up date)
            const completedFollowUps = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                const hasReturnVisit = myReports.some(r2 => 
                    r2.clientId === r.clientId && 
                    new Date(r2.timestamp) > followUpDate &&
                    r2.id !== r.id
                );
                return hasReturnVisit;
            }).length;
            
            const missedFollowUps = followUpsDue - completedFollowUps;
            const followUpCompleteRate = followUpsDue > 0 ? Math.round((completedFollowUps / followUpsDue) * 100) : 0;
            const followUpMissedRate = followUpsDue > 0 ? Math.round((missedFollowUps / followUpsDue) * 100) : 0;
            
            // Product prescription trends
            const productCounts = {};
            let totalPrescriptions = 0;
            
            filteredReports.forEach(r => {
                if (r.medicines) {
                    r.medicines.forEach(med => {
                        productCounts[med.name] = (productCounts[med.name] || 0) + 1;
                        totalPrescriptions++;
                    });
                }
            });
            
            const topProducts = Object.entries(productCounts)
                .map(([name, count]) => ({
                    name,
                    count,
                    percentage: Math.round((count / totalPrescriptions) * 100)
                }))
                .sort((a, b) => b.count - a.count);
            
            // Symptom tracking
            const symptomCounts = {};
            
            filteredReports.forEach(r => {
                if (r.symptoms) {
                    r.symptoms.forEach(s => {
                        symptomCounts[s.symptom] = (symptomCounts[s.symptom] || 0) + 1;
                    });
                }
            });
            
            const topSymptoms = Object.entries(symptomCounts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
            
            // Conversion rate (referred ‚Üí member)
            const referredCount = myClients.filter(c => c.membershipStatus === 'referred').length;
            const conversionRate = referredCount > 0 ? Math.round((memberClients / (memberClients + referredCount)) * 100) : 0;
            
            return {
                totalClients: totalClients,
                totalReports: filteredReports.length,
                memberClients,
                referredClients,
                memberPercentage: totalClients > 0 ? Math.round((memberClients / totalClients) * 100) : 0,
                referredPercentage: totalClients > 0 ? Math.round((referredClients / totalClients) * 100) : 0,
                followUpsDue,
                completedFollowUps,
                missedFollowUps,
                followUpCompleteRate,
                followUpMissedRate,
                topProducts,
                topSymptoms,
                conversionRate
            };
        }

        function showAppointmentCalendar() {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const isVisible = calendarDiv.style.display !== 'none';
            calendarDiv.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                renderCalendar(new Date());
            }
        }

        function renderCalendar(currentDate) {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get appointments for this month
            const monthAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getMonth() === month && aptDate.getFullYear() === year;
            });
            
            let calendarHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #c41e3a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-sm" onclick="changeMonth(-1)">‚óÄ Previous</button>
                        <h3 style="color: #c41e3a;">${monthNames[month]} ${year}</h3>
                        <button class="btn btn-sm" onclick="changeMonth(1)">Next ‚ñ∂</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                            <div style="background: #c41e3a; color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px;">
                                ${day}
                            </div>
                        `).join('')}
                        
                        ${Array(startingDayOfWeek).fill(null).map(() => 
                            '<div style="background: #f8f9fa; padding: 20px; border-radius: 5px;"></div>'
                        ).join('')}
                        
                        ${Array(daysInMonth).fill(null).map((_, i) => {
                            const day = i + 1;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const today = new Date();
                            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                            
                            const dayAppointments = monthAppointments.filter(apt => 
                                apt.date.startsWith(dateStr)
                            );
                            
                            return `
                                <div onclick="selectCalendarDate('${dateStr}')" 
                                     style="background: ${isToday ? '#e3f2fd' : 'white'}; 
                                            border: 2px solid ${dayAppointments.length > 0 ? '#27ae60' : '#ddd'}; 
                                            padding: 10px; 
                                            border-radius: 5px; 
                                            cursor: pointer; 
                                            text-align: center;
                                            transition: all 0.3s;
                                            position: relative;">
                                    <div style="font-weight: bold; font-size: 14pt; color: ${isToday ? '#2196f3' : '#2c3e50'};">
                                        ${day}
                                    </div>
                                    ${dayAppointments.length > 0 ? `
                                        <div style="background: #27ae60; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; margin-top: 5px;">
                                            ${dayAppointments.length} apt${dayAppointments.length > 1 ? 's' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div id="selectedDateAppointments" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <!-- Appointments for selected date will appear here -->
                    </div>
                </div>
            `;
            
            calendarDiv.innerHTML = calendarHTML;
            window.currentCalendarDate = currentDate;
        }

        function changeMonth(delta) {
            if (!window.currentCalendarDate) {
                window.currentCalendarDate = new Date();
            }
            
            window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
            renderCalendar(window.currentCalendarDate);
        }

        function selectCalendarDate(dateStr) {
            const selectedDiv = document.getElementById('selectedDateAppointments');
            if (!selectedDiv) return;
            
            const dayAppointments = appointments.filter(apt => apt.date.startsWith(dateStr));
            
            if (dayAppointments.length === 0) {
                selectedDiv.style.display = 'block';
                selectedDiv.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p style="margin-bottom: 15px;"><strong>No appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</strong></p>
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">‚ûï Book Appointment for This Date</button>
                    </div>
                `;
                return;
            }
            
            selectedDiv.style.display = 'block';
            selectedDiv.innerHTML = `
                <div>
                    <h4 style="color: #c41e3a; margin-bottom: 15px;">üìÖ Appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</h4>
                    ${dayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${apt.clientName}</strong>
                                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ‚è∞ ${apt.time} | üë®‚Äç‚öïÔ∏è ${apt.consultant}
                                    </p>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #888; margin-top: 5px;">üìù ${apt.notes}</p>` : ''}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="cancelAppointment('${apt.id}')">‚ùå Cancel</button>
                            </div>
                        </div>
                    `).join('')}
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">‚ûï Add Another Appointment</button>
                    </div>
                </div>
            `;
        }

		function initFullCalendar() {
			const calendar = document.getElementById('appointmentCalendar');
			if (!calendar) return;
			calendar.style.display = 'block';
			renderCalendar(window.currentCalendarDate || new Date());
			try { calendar.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) {}
		}

		function renderGMApprovalAlerts(pending = []) {
			const alertEl = document.getElementById('gmApprovalAlerts');
			if (!alertEl) return;

			if (!Array.isArray(pending) || pending.length === 0) {
				alertEl.style.display = 'none';
				alertEl.innerHTML = '';
				return;
			}

			const now = Date.now();
			const hourMs = 60 * 60 * 1000;
			const warningThreshold = 24;
			const staleThreshold = 48;

			const stale = [];
			const nearing = [];

			pending.forEach(transfer => {
				const gmMeta = transfer?.metadata?.gmApproval || {};
				const createdRaw = transfer?.createdAt || gmMeta.requestedAt || transfer?.updatedAt || null;
				if (!createdRaw) return;
				const createdDate = new Date(createdRaw);
				if (Number.isNaN(createdDate.getTime())) return;
				const ageHours = (now - createdDate.getTime()) / hourMs;
				if (ageHours >= staleThreshold) {
					stale.push({ transfer, ageHours: Math.floor(ageHours) });
				} else if (ageHours >= warningThreshold) {
					nearing.push({ transfer, ageHours: Math.floor(ageHours) });
				}
			});

			if (!stale.length && !nearing.length) {
				alertEl.style.display = 'none';
				alertEl.innerHTML = '';
				return;
			}

			const summaryParts = [];
			if (stale.length) {
				summaryParts.push(`<strong>${stale.length}</strong> request${stale.length === 1 ? '' : 's'} over 48h pending`);
			}
			if (nearing.length) {
				summaryParts.push(`${nearing.length} approaching 48h`);
			}

			const previewEntries = [...stale.slice(0, 2), ...nearing.slice(0, Math.max(0, 3 - stale.length))];
			const previewList = previewEntries.map(({ transfer, ageHours }) => {
				const gmMeta = transfer?.metadata?.gmApproval || {};
				const branch = gmMeta.branch || transfer?.toBranch || 'Branch';
				const product = gmMeta.product || transfer?.items?.[0]?.productName || 'Item';
				return `<li style="margin:4px 0; font-size:.78rem; color:#1f2937;">${escapeHtml(branch)} ‚Ä¢ ${escapeHtml(product)} <span style="color:#b91c1c; font-weight:600;">${ageHours}h</span></li>`;
			}).join('');

			alertEl.innerHTML = `
				<div style="background:#fff7ed; border:1px solid #fb923c; border-radius:8px; padding:12px 14px;">
					<div style="font-weight:700; color:#b45309; margin-bottom:6px;">‚è∞ ${summaryParts.join(' ‚Ä¢ ')}</div>
					${previewList ? `<ul style="margin:0; padding-left:16px; list-style:disc;">${previewList}</ul>` : ''}
				</div>
			`;
			alertEl.style.display = 'block';
		}

		function formatImportQuantity(value) {
			const num = Number(value ?? 0);
			return Number.isFinite(num) ? num.toLocaleString() : '0';
		}

		function formatImportExpiry(days) {
			if (days === null || days === undefined) return 'Unknown expiry';
			if (days < 0) return `${Math.abs(days)} day${Math.abs(days) === 1 ? '' : 's'} past expiry`;
			if (days === 0) return 'Expires today';
			if (days === 1) return '1 day remaining';
			return `${days} days remaining`;
		}

		function renderImportSummaryPanel(detail) {
			const panel = document.getElementById('importSummaryPanel');
			const content = document.getElementById('importSummaryContent');
			if (!panel || !content) return;

			if (!detail || !detail.entry) {
				panel.style.display = 'none';
				content.innerHTML = '';
				return;
			}

			const entry = detail.entry;
			const summary = detail.summary || {};
			const locationSummary = summary.location || {};
			const networkSummary = summary.network || {};
			const locationName = escapeHtml(locationSummary.location || entry.location || 'country_stock');
			const expiringSoon = Array.isArray(locationSummary.topExpiring) ? locationSummary.topExpiring : [];
			const horizon = locationSummary.horizonDays || 60;

			const expiringHtml = expiringSoon.length
				? `<ul style="margin:0; padding-left:18px;">
					${expiringSoon.map(item => {
						const days = item.daysUntil ?? null;
						const highlight = days !== null && days <= 14 ? '#dc2626' : '#b45309';
						return `<li style="margin:4px 0; font-size:.85rem; color:#334155;">
							${escapeHtml(item.product || 'Item')} ‚Ä¢ Batch ${escapeHtml(item.batchNo || '')}
							<span style="color:${highlight}; font-weight:600; margin-left:6px;">${formatImportExpiry(days)}</span>
							<span style="color:#475569; margin-left:6px;">${formatImportQuantity(item.remainingQuantity)} units</span>
						</li>`;
					}).join('')}
				</ul>`
				: `<p style="margin:0; font-size:.85rem; color:#64748b;">No batches approaching expiry in the next ${horizon} days.</p>`;

			content.innerHTML = `
				<div style="display:flex; flex-wrap:wrap; gap:16px;">
					<div style="flex:1 1 240px; background:#f8fafc; border-radius:8px; padding:14px;">
						<div style="font-weight:700; color:#0f172a;">${escapeHtml(entry.description || 'New batch')}</div>
						<div style="font-size:.85rem; color:#475569;">Batch ${escapeHtml(entry.batchNo || 'N/A')}</div>
						<div style="margin-top:10px; font-size:.9rem; color:#1f2937;">
							<strong>${formatImportQuantity(entry.remainingQuantity ?? entry.quantity)}</strong> units now available in <strong>${locationName}</strong>.
						</div>
					</div>
					<div style="flex:1 1 200px; background:#f8fafc; border-radius:8px; padding:14px;">
						<div style="font-size:.75rem; color:#475569; text-transform:uppercase; font-weight:600;">Location totals</div>
						<div style="font-size:1.25rem; font-weight:700; color:#0f172a; margin-top:6px;">${formatImportQuantity(locationSummary.totalQuantity)}</div>
						<div style="font-size:.8rem; color:#64748b;">${locationSummary.uniqueProducts || 0} products ‚Ä¢ ${locationSummary.totalBatches || 0} batches</div>
					</div>
					<div style="flex:1 1 200px; background:#f8fafc; border-radius:8px; padding:14px;">
						<div style="font-size:.75rem; color:#475569; text-transform:uppercase; font-weight:600;">Network snapshot</div>
						<div style="font-size:1.25rem; font-weight:700; color:#0f172a; margin-top:6px;">${formatImportQuantity(networkSummary.totalQuantity)}</div>
						<div style="font-size:.8rem; color:#64748b;">${networkSummary.uniqueProducts || 0} products ‚Ä¢ ${networkSummary.totalBatches || 0} batches</div>
					</div>
				</div>
				<div style="margin-top:16px;">
					<h5 style="margin:0 0 8px 0; font-size:.95rem; color:#0f172a;">Expiring within ${horizon} days</h5>
					${expiringHtml}
				</div>
			`;

			panel.style.display = 'block';
		}

		window.addEventListener('barcode-stock:imported', (event) => {
			renderImportSummaryPanel(event.detail);
		});

		function showAppointmentBookingModal() {
			if (typeof openClientReg === 'function') {
				openClientReg('appointment');
			} else {
				bookAppointment();
			}
		}

		const GM_INVENTORY_TAB_MAP = {
			overview: 'Overview',
			expected: 'Expected',
			losses: 'Losses',
			manipulations: 'Manipulations',
			approvals: 'Approvals',
			allbranches: 'AllBranches'
		};

		function getGMBranches() {
			try {
				const list = (Array.isArray(branches) && branches.length)
					? branches
					: safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
				return (Array.isArray(list) ? list : []).map(entry => {
					if (typeof entry === 'string') {
						return { id: entry.toLowerCase(), name: entry };
					}
					return {
						id: (entry.id || entry.branch || entry.name || '').toLowerCase() || `branch-${Math.random().toString(36).slice(2, 7)}`,
						name: entry.name || entry.branch || entry.id || 'Branch'
					};
				});
			} catch (_) {
				return [];
			}
		}

		function populateSelectWithBranches(selectOrId) {
			const select = typeof selectOrId === 'string' ? document.getElementById(selectOrId) : selectOrId;
			if (!select) return;
			const existing = Array.from(select.options).map(opt => opt.value);
			getGMBranches().forEach(branch => {
				if (!branch || !branch.id || existing.includes(branch.id)) return;
				const option = document.createElement('option');
				option.value = branch.id;
				option.textContent = branch.name;
				select.appendChild(option);
			});
		}

		function refreshGMInventoryData() {
			loadStockData();
			calculateGMMetrics();
			renderPlanInsights();
			displayGMInventoryBreakdown();
			loadGMExpectedStock();
			loadGMStockLosses();
			loadGMStockManipulations();
			loadGMPendingInventoryApprovals();
			loadGMAllBranchInventory();
		}

		function switchGMInventoryTab(view) {
			const key = (view || 'overview').toLowerCase();
			const suffix = GM_INVENTORY_TAB_MAP[key] || GM_INVENTORY_TAB_MAP.overview;
			const tabs = document.querySelectorAll('#gmInventoryContent .gm-inv-tab-content');
			tabs.forEach(tab => {
				tab.style.display = 'none';
				tab.classList.remove('active');
			});
			const buttons = document.querySelectorAll('#gm .form-section .tabs .tab-button');
			buttons.forEach(btn => {
				if (btn.id && btn.id.startsWith('gmInvTab')) {
					btn.classList.remove('active');
				}
			});
			const target = document.getElementById(`gmInv${suffix}`);
			const button = document.getElementById(`gmInvTab${suffix}`);
			if (target) {
				target.style.display = 'block';
				target.classList.add('active');
			}
			if (button) button.classList.add('active');
			switch (key) {
				case 'expected':
					loadGMExpectedStock();
					break;
				case 'losses':
					loadGMStockLosses();
					break;
				case 'manipulations':
					loadGMStockManipulations();
					break;
				case 'approvals':
					loadGMPendingInventoryApprovals();
					break;
				case 'allbranches':
					loadGMAllBranchInventory();
					break;
				default:
					displayGMInventoryBreakdown();
			}
		}

		function loadGMExpectedStock() {
			const listEl = document.getElementById('gmExpectedStockList');
			if (!listEl) return;
			const branchSelect = document.getElementById('gmExpectedBranchFilter');
			populateSelectWithBranches(branchSelect);
			const statusSelect = document.getElementById('gmExpectedStatusFilter');
			const branchFilter = (branchSelect?.value || 'all').toLowerCase();
			const statusFilter = (statusSelect?.value || 'pending').toLowerCase();
			let requests = safeParseFromStorage('dyna_stock_requests', '[]');
			if (!Array.isArray(requests)) requests = [];
			const filtered = requests.filter(req => {
				const status = (req.status || '').toLowerCase();
				const branch = (req.branch || req.branchId || '').toLowerCase();
				const matchesBranch = branchFilter === 'all' || branch === branchFilter;
				const matchesStatus = statusFilter === 'all'
					|| (statusFilter === 'pending' && (status === 'pending' || status === 'pending_gm'))
					|| status === statusFilter;
				return matchesBranch && matchesStatus;
			}).sort((a, b) => new Date(b.createdAt || b.date || 0) - new Date(a.createdAt || a.date || 0));
			const pendingCount = requests.filter(req => {
				const status = (req.status || '').toLowerCase();
				return status === 'pending' || status === 'pending_gm';
			}).length;
			const badge = document.getElementById('gmPendingExpectedStock');
			if (badge) badge.textContent = `${pendingCount}`;
			if (!filtered.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No expected stock requests found for the selected filters.</p>';
				return;
			}
			listEl.innerHTML = filtered.slice(0, 20).map(req => {
				const status = (req.status || 'Pending').toUpperCase();
				const created = new Date(req.createdAt || req.date || Date.now()).toLocaleString();
				const itemSummary = formatPurchaseOrderItemSummary(req.items || [], 4);
				return `
					<div class="client-card" style="border-left:4px solid #2980b9;">
						<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
							<div>
								<div style="font-weight:700; color:#2c3e50;">${req.branch || 'Unknown Branch'}</div>
								<div style="font-size:.8rem; color:#999;">${req.reference || req.id || ''}</div>
							</div>
							<div style="text-align:right;">
								<span style="display:inline-block; padding:4px 8px; border-radius:10px; background:#f0f4ff; color:#1f2937; font-size:.75rem;">${status}</span>
								<div style="font-size:.75rem; color:#999; margin-top:4px;">${created}</div>
							</div>
						</div>
						${itemSummary ? `<div style="font-size:.85rem; color:#555; margin-top:8px;">${itemSummary}${Array.isArray(req.items) && req.items.length > 4 ? '‚Ä¶' : ''}</div>` : ''}
						${req.notes ? `<p style="font-size:.8rem; color:#777; margin-top:6px;">${req.notes}</p>` : ''}
					</div>
				`;
			}).join('');
		}

		function loadGMStockLosses() {
			const listEl = document.getElementById('gmStockLossesList');
			if (!listEl) return;
			const branchSelect = document.getElementById('gmLossesBranchFilter');
			populateSelectWithBranches(branchSelect);
			const branchFilter = (branchSelect?.value || 'all').toLowerCase();
			const from = document.getElementById('gmLossesDateFrom')?.value;
			const to = document.getElementById('gmLossesDateTo')?.value;
			const startDate = from ? new Date(from) : null;
			const endDate = to ? new Date(to + 'T23:59:59') : null;
			let records = [];
			const damages = safeParseFromStorage('dyna_stock_damages', '[]');
			if (Array.isArray(damages)) {
				damages.forEach(entry => records.push({
					branch: (entry.branch || entry.location || '').toLowerCase(),
					product: entry.product || entry.description || 'Item',
					quantity: Number(entry.quantity || entry.qty || 0),
					reason: entry.reason || entry.notes || 'Damage',
					createdAt: entry.createdAt || entry.date || entry.timestamp,
					source: 'Damage Report'
				}));
			}
			if (Array.isArray(returnsLog) && returnsLog.length) {
				returnsLog.filter(ret => (ret.disposition || '').toLowerCase() !== 'released').forEach(ret => {
					records.push({
						branch: (ret.branch || ret.location || '').toLowerCase(),
						product: ret.product || ret.description || 'Item',
						quantity: Number(ret.quantity || 0),
						reason: ret.disposition || ret.reason || 'Disposition',
						createdAt: ret.createdAt || ret.timestamp,
						source: 'Return'
					});
				});
			}
			records = records.filter(record => {
				const branch = record.branch || 'all';
				if (branchFilter !== 'all' && branch !== branchFilter) return false;
				if (startDate || endDate) {
					const created = record.createdAt ? new Date(record.createdAt) : null;
					if (startDate && created && created < startDate) return false;
					if (endDate && created && created > endDate) return false;
				}
				return true;
			}).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
			const lossQuantity = records.reduce((sum, record) => sum + Number(record.quantity || 0), 0);
			const metric = document.getElementById('gmStockLosses');
			if (metric) metric.textContent = `${lossQuantity} units`;
			if (!records.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No stock losses recorded for the selected filters.</p>';
				return;
			}
			listEl.innerHTML = records.slice(0, 20).map(record => `
				<div class="client-card" style="border-left:4px solid #e74c3c;">
					<div style="display:flex; justify-content:space-between; align-items:flex-start;">
						<div>
							<div style="font-weight:700; color:#2c3e50;">${record.product}</div>
							<div style="font-size:.8rem; color:#999;">${record.source}</div>
						</div>
						<div style="text-align:right;">
							<div style="font-weight:700; color:#c41e3a;">-${Number(record.quantity || 0)}</div>
							<div style="font-size:.75rem; color:#999;">${record.createdAt ? new Date(record.createdAt).toLocaleString() : ''}</div>
						</div>
					</div>
					${record.reason ? `<p style="font-size:.8rem; color:#777; margin-top:6px;">${record.reason}</p>` : ''}
				</div>
			`).join('');
		}

		function loadGMStockManipulations() {
			const listEl = document.getElementById('gmStockManipulationsList');
			if (!listEl) return;
			const branchSelect = document.getElementById('gmManipBranchFilter');
			populateSelectWithBranches(branchSelect);
			const branchFilter = (branchSelect?.value || 'all').toLowerCase();
			const typeFilter = (document.getElementById('gmManipTypeFilter')?.value || 'all').toLowerCase();
			const search = (document.getElementById('gmManipSearch')?.value || '').toLowerCase();
			let audit = [];
			try {
				audit = JSON.parse(localStorage.getItem('dyna_stock_audit') || '[]');
			} catch (_) {
				audit = [];
			}
			if (!Array.isArray(audit)) audit = [];
			const filtered = audit.filter(entry => {
				const action = (entry.action || '').toLowerCase();
				const details = entry.details || {};
				const branch = (details.branch || details.branchId || '').toLowerCase();
				if (branchFilter !== 'all' && branch !== branchFilter) return false;
				if (typeFilter !== 'all') {
					if (typeFilter === 'adjustment' && !action.includes('adjust')) return false;
					if (typeFilter === 'loss' && !(action.includes('loss') || action.includes('damage'))) return false;
					if (typeFilter === 'transfer' && !action.includes('transfer')) return false;
					if (typeFilter === 'receive' && !(action.includes('receive') || action.includes('distribution'))) return false;
				}
				if (search && !JSON.stringify(entry).toLowerCase().includes(search)) return false;
				return true;
			}).sort((a, b) => new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0));
			if (!filtered.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No stock manipulation records found.</p>';
				return;
			}
			listEl.innerHTML = filtered.slice(0, 25).map(entry => {
				const details = entry.details || {};
				const product = details.product || details.description || 'Item';
				const quantity = Number(details.quantity || details.qty || 0);
				const branch = details.branch || details.branchId || 'Unknown';
				const user = details.user || entry.user || 'System';
				return `
					<div class="client-card" style="border-left:4px solid #5c6bc0;">
						<div style="display:flex; justify-content:space-between; align-items:flex-start;">
							<div>
								<div style="font-weight:700; color:#2c3e50;">${product}</div>
								<div style="font-size:.8rem; color:#999;">${branch}</div>
							</div>
							<div style="text-align:right;">
								<div style="font-weight:700; color:#1f2937;">${entry.action || 'Action'}</div>
								<div style="font-size:.75rem; color:#999;">${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : ''}</div>
							</div>
						</div>
						<div style="font-size:.8rem; color:#555; margin-top:6px;">Quantity: ${quantity}</div>
						<div style="font-size:.75rem; color:#999;">By: ${user}</div>
					</div>
				`;
			}).join('');
		}

		async function loadGMPendingInventoryApprovals() {
			const listEl = document.getElementById('gmPendingInventoryApprovalsList');
			if (!listEl) return;

			let pending = [];
			const stockApiModule = await stockApiReady.catch(() => null);
			if (stockApiModule && typeof stockApiModule.refreshStockData === 'function') {
				try {
					await stockApiModule.refreshStockData();
					const result = stockApiModule.getStockTransfers({ status: 'pending_gm' });
					if (result && Array.isArray(result.data)) {
						pending = result.data.slice();
					}
				} catch (error) {
					console.debug('loadGMPendingInventoryApprovals: backend fetch failed', error);
				}
			}

			if (!pending.length) {
				const localFallback = safeParseFromStorage('gm_inventory_approvals', '[]');
				if (Array.isArray(localFallback) && localFallback.length) {
					pending = localFallback
						.filter(entry => (entry.status || 'pending').toLowerCase() === 'pending')
						.map(entry => ({
							id: entry.transferId || entry.id,
							fromWarehouse: entry.warehouse,
							toBranch: entry.branch,
							status: 'pending_gm',
							items: [{
								productName: entry.product || entry.productName || 'Item',
								quantity: Number(entry.quantityRequested || entry.quantity || 0)
							}],
							dispatchNotes: entry.notes || '',
							createdAt: entry.createdAt || new Date().toISOString(),
							metadata: {
								gmApproval: entry.gmApprovalMeta || {
									required: true,
									status: 'pending',
									requestedBy: entry.requestedBy || 'System',
									requestedQuantity: Number(entry.quantityRequested || entry.quantity || 0),
									autoReleaseLimit: entry.autoReleaseLimit ?? null,
									expectedSupply: entry.expectedSupply ?? null,
									recentDemand: entry.recentDemand ?? null,
									openRequests: entry.openRequests ?? null,
									inTransit: entry.inTransit ?? null,
									notes: entry.notes || '',
									dispatchNumber: entry.dispatchNumber || ''
								}
							}
						}));
				}
			}

			renderGMApprovalAlerts(pending);

			if (!pending.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No pending inventory approvals.</p>';
				return;
			}

			pending.sort((a, b) => new Date(b.createdAt || b.updatedAt || 0) - new Date(a.createdAt || a.updatedAt || 0));

			listEl.innerHTML = pending.slice(0, 20).map(renderGMDispatchApprovalCard).join('');
		}

		function renderGMDispatchApprovalCard(transfer) {
			const gmMeta = transfer?.metadata?.gmApproval || {};
			const items = Array.isArray(transfer?.items) ? transfer.items : [];
			const primaryItem = items[0] || {};
			const productName = primaryItem.productName || primaryItem.description || gmMeta.product || 'Item';
			const requestedQuantity = Number(primaryItem.quantity || gmMeta.requestedQuantity || 0);
			const autoReleaseLimit = gmMeta.autoReleaseLimit ?? null;
			const expectedSupply = gmMeta.expectedSupply ?? null;
			const branchName = transfer?.toBranch || gmMeta.branch || 'Unknown Branch';
			const warehouseName = transfer?.fromWarehouse || gmMeta.warehouse || 'Warehouse';
			const dispatchNumber = gmMeta.dispatchNumber || transfer?.dispatchNotes || transfer?.dispatchReference || '';
			const createdAtRaw = transfer?.createdAt || gmMeta.requestedAt || transfer?.updatedAt || Date.now();
			const createdAtDate = new Date(createdAtRaw);
			const createdAt = Number.isNaN(createdAtDate.getTime()) ? 'Pending' : createdAtDate.toLocaleString();
			const ageMs = Number.isNaN(createdAtDate.getTime()) ? null : Date.now() - createdAtDate.getTime();
			const ageHours = ageMs !== null ? Math.max(0, ageMs / (60 * 60 * 1000)) : null;
			const staleThresholdHours = 48;
			const warningThresholdHours = 24;
			let ageBadge = '';
			if (ageHours !== null) {
				const roundedHours = Math.floor(ageHours);
				if (roundedHours >= staleThresholdHours) {
					ageBadge = `<span style="display:inline-flex; align-items:center; gap:4px; background:#fee2e2; color:#b91c1c; border-radius:999px; padding:2px 8px; font-size:.7rem; font-weight:600;">‚è∞ ${roundedHours}h pending</span>`;
				} else if (roundedHours >= warningThresholdHours) {
					ageBadge = `<span style="display:inline-flex; align-items:center; gap:4px; background:#fef3c7; color:#b45309; border-radius:999px; padding:2px 8px; font-size:.7rem; font-weight:600;">‚è∞ ${roundedHours}h pending</span>`;
				}
			}
			const notes = gmMeta.notes || transfer?.dispatchNotes || '';
			const guidance = transfer?.metadata?.guidanceSnapshot || {};

			const limitInfo = autoReleaseLimit != null
				? `Auto-limit: ${autoReleaseLimit}`
				: '';
			const expectedInfo = expectedSupply != null
				? `Expected supply: ${expectedSupply}`
				: '';
			const demandInfo = guidance.recentDemand != null
				? `Recent demand: ${guidance.recentDemand}`
				: '';

				return `
				<div class="client-card" style="border-left:4px solid #f59e0b;">
						<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
							<div>
							<div style="font-weight:700; color:#2c3e50;">${escapeHtml(productName)}</div>
							<div style="font-size:.8rem; color:#999;">${escapeHtml(warehouseName)} ‚ûú ${escapeHtml(branchName)}</div>
							</div>
							<div style="text-align:right;">
							${ageBadge ? `<div style="margin-bottom:6px;">${ageBadge}</div>` : ''}
							<div style="font-weight:700; color:#1f2937;">${requestedQuantity} units</div>
							<div style="font-size:.75rem; color:#999;">${escapeHtml(createdAt)}</div>
							</div>
						</div>
					<div style="font-size:.8rem; color:#555; margin-top:8px;">
						${limitInfo ? `<span>${escapeHtml(limitInfo)}</span>` : ''}
						${expectedInfo ? ` ‚Ä¢ <span>${escapeHtml(expectedInfo)}</span>` : ''}
						${demandInfo ? ` ‚Ä¢ <span>${escapeHtml(demandInfo)}</span>` : ''}
					</div>
					${notes ? `<p style="font-size:.8rem; color:#777; margin-top:6px;">${escapeHtml(notes)}</p>` : ''}
					${dispatchNumber ? `<div style="font-size:.75rem; color:#94a3b8; margin-top:4px;">Dispatch #: ${escapeHtml(dispatchNumber)}</div>` : ''}
					<div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
						<button class="btn btn-success" style="flex:1; min-width:120px;" onclick="handleGMDispatchDecision('${escapeHtml(transfer.id)}', true)">‚úÖ Approve</button>
						<button class="btn btn-danger" style="flex:1; min-width:120px;" onclick="handleGMDispatchDecision('${escapeHtml(transfer.id)}', false)">‚úñ Reject</button>
					</div>
					</div>
				`;
		}

		async function handleGMDispatchDecision(transferId, approve) {
			if (!transferId) return;
			const confirmMessage = approve ? 'Approve this dispatch request?' : 'Reject this dispatch request?';
			if (!window.confirm(confirmMessage)) return;
			let notes = '';
			if (!approve) {
				notes = window.prompt('Enter rejection notes (optional):', '') || '';
			}

			const stockApiModule = await stockApiReady.catch(() => null);
			if (!stockApiModule) {
				alert('Shared stock API unavailable. Please try again.');
				return;
			}

			let transferRecord = null;
			try {
				const response = await stockApiModule.getTransferById(transferId);
				transferRecord = response?.data || null;
			} catch (error) {
				console.error('handleGMDispatchDecision: getTransferById failed', error);
			}

			if (!transferRecord) {
				alert('Unable to load dispatch request. Please refresh and try again.');
				return;
			}

			const metadata = { ...(transferRecord.metadata || {}) };
			const gmMeta = { ...(metadata.gmApproval || {}) };
			gmMeta.status = approve ? 'approved' : 'rejected';
			gmMeta.decisionNotes = notes;
			gmMeta.decidedBy = (window.currentUser && (window.currentUser.fullName || window.currentUser.username)) || 'GM';
			gmMeta.decidedAt = new Date().toISOString();
			metadata.gmApproval = gmMeta;

			const nextStatus = approve ? 'pending' : 'rejected';

			try {
				const response = await stockApiModule.updateTransferStatus(transferId, nextStatus, {
					metadata,
					user: window.currentUser,
					dispatchNotes: transferRecord.dispatchNotes || null,
				});
				if (!response?.success) {
					alert('Unable to update dispatch request. Please try again.');
					return;
				}
			} catch (error) {
				console.error('handleGMDispatchDecision: updateTransferStatus failed', error);
				alert('Unable to update dispatch request. Please try again.');
				return;
			}

			try {
				const localPending = safeParseFromStorage('gm_inventory_approvals', '[]');
				if (Array.isArray(localPending)) {
					const filtered = localPending.filter(entry => entry.transferId !== transferId && entry.id !== transferId);
					localStorage.setItem('gm_inventory_approvals', JSON.stringify(filtered));
				}
			} catch (_) {}

			showToast(approve ? '‚úÖ Dispatch approved.' : 'üö´ Dispatch rejected.');

			try {
				await stockApiModule.refreshStockData();
			} catch (_) {}
			loadGMPendingInventoryApprovals();
		}

		function normaliseBranchInventoryData(data) {
			if (Array.isArray(data)) {
				return data.reduce((acc, item) => {
					const branch = (item.branch || item.branchId || 'unknown').toLowerCase();
					acc[branch] = acc[branch] || [];
					acc[branch].push(item);
					return acc;
				}, {});
			}
			if (data && typeof data === 'object') return data;
			return {};
		}

		function loadGMAllBranchInventory() {
			const listEl = document.getElementById('gmAllBranchInventoryList');
			if (!listEl) return;
			const branchSelect = document.getElementById('gmAllBranchesBranchFilter');
			populateSelectWithBranches(branchSelect);
			const branchFilter = (branchSelect?.value || 'all').toLowerCase();
			let branchStock = normaliseBranchInventoryData(safeParseFromStorage('dyna_branch_stock', '{}'));
			if (!Object.keys(branchStock).length) {
				const legacy = safeParseFromStorage('branchInventory', '[]');
				branchStock = normaliseBranchInventoryData(legacy);
			}
			const entries = Object.entries(branchStock).filter(([branch]) => branchFilter === 'all' || branch === branchFilter);
			if (!entries.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No branch inventory data available.</p>';
				return;
			}
			listEl.innerHTML = entries.map(([branch, items]) => {
				const safeItems = Array.isArray(items) ? items : Object.entries(items).map(([product, qty]) => ({ description: product, quantity: qty }));
				const totalQty = safeItems.reduce((sum, item) => sum + Number(item.quantity || item.currentStock || 0), 0);
				const lowStock = safeItems.filter(item => Number(item.quantity || item.currentStock || 0) <= Number(item.reorderLevel || 5)).length;
				const branchName = (getGMBranches().find(b => b.id === branch)?.name) || branch;
				return `
					<div class="client-card" style="border-left:4px solid #009688;">
						<div style="display:flex; justify-content:space-between; align-items:flex-start;">
							<div>
								<div style="font-weight:700; color:#2c3e50;">${branchName}</div>
								<div style="font-size:.8rem; color:#999;">Total Items: ${safeItems.length}</div>
							</div>
							<div style="text-align:right;">
								<div style="font-weight:700; color:#27ae60;">${totalQty} units</div>
								<div style="font-size:.75rem; color:#999;">Low stock: ${lowStock}</div>
							</div>
						</div>
						${safeItems.slice(0, 5).map(item => {
							const name = item.description || item.product || 'Item';
							const qty = Number(item.quantity || item.currentStock || 0);
							return `<div style="display:flex; justify-content:space-between; font-size:.8rem; color:#555; margin-top:6px;">
								<span>${name}</span>
								<span>${qty}</span>
							</div>`;
						}).join('')}
						${safeItems.length > 5 ? '<div style="font-size:.75rem; color:#999; margin-top:6px;">‚Ä¶ more items</div>' : ''}
					</div>
				`;
			}).join('');
		}

		function exportGMInventoryReport() {
			let branchStock = normaliseBranchInventoryData(safeParseFromStorage('dyna_branch_stock', '{}'));
			if (!Object.keys(branchStock).length) {
				const legacy = safeParseFromStorage('branchInventory', '[]');
				branchStock = normaliseBranchInventoryData(legacy);
			}
			const entries = Object.entries(branchStock);
			if (!entries.length) {
				alert('No branch inventory data available to export.');
				return;
			}
			const rows = [['Branch', 'Product', 'Quantity', 'Reorder Level']];
			entries.forEach(([branch, items]) => {
				const safeItems = Array.isArray(items) ? items : Object.entries(items).map(([product, qty]) => ({ description: product, quantity: qty }));
				safeItems.forEach(item => {
					rows.push([
						branch,
						item.description || item.product || 'Item',
						Number(item.quantity || item.currentStock || 0),
						Number(item.reorderLevel || 0)
					]);
				});
			});
			const csv = rows.map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
			const blob = new Blob([csv], { type: 'text/csv' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = 'gm-branch-inventory.csv';
			link.click();
			URL.revokeObjectURL(link.href);
		}

        var countryStock = Array.isArray(window.countryStock) ? window.countryStock : [];
        window.countryStock = countryStock;

		function exportCountryStock() {
			loadStockData();
			const data = Array.isArray(countryStock) ? countryStock : [];
			if (!data.length) {
				alert('No country stock data available to export.');
				return;
			}
			const rows = [['Carton', 'Description', 'Batch', 'Expiry', 'Quantity']];
			data.forEach(item => {
				rows.push([
					item.carton || item.cartonNo || item.cartons || '',
					item.description || item.product || 'Item',
					item.batch || item.batchNo || '',
					item.expiry || item.expiryDate || '',
					Number(item.quantity || item.totalCtns || item.count || 0)
				]);
			});
			const csv = rows.map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
			const blob = new Blob([csv], { type: 'text/csv' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = 'country-stock.csv';
			link.click();
			URL.revokeObjectURL(link.href);
		}

		const CRM_TAB_KEYS = {
			communication: 'communication',
			segmentation: 'segmentation',
			workflows: 'workflows',
			loyalty: 'loyalty'
		};

		function showCRMTab(tabName) {
			const key = (tabName || 'communication').toLowerCase();
			document.querySelectorAll('#crm .crm-subtab').forEach(subtab => {
				subtab.style.display = 'none';
				subtab.classList.remove('active');
			});
			document.querySelectorAll('#crm .tabs .tab-button').forEach(button => {
				if (!button) return;
				const label = (button.textContent || '').toLowerCase();
				if (label.includes(key)) {
					button.classList.add('active');
				} else {
					button.classList.remove('active');
				}
			});
			const target = document.getElementById(`crm-${CRM_TAB_KEYS[key] || 'communication'}`);
			if (target) {
				target.style.display = 'block';
				target.classList.add('active');
			}
			switch (key) {
				case 'segmentation':
					refreshSegmentation();
					break;
				case 'workflows':
					refreshWorkflows();
					break;
				case 'loyalty':
					refreshLoyaltyData();
					break;
				default:
					refreshCRMCommunication();
			}
		}

		function persistCRMData(key, value) {
			try {
				localStorage.setItem(key, JSON.stringify(value));
			} catch (_) {}
		}

		function getCRMClientsList() {
			let list = (Array.isArray(clients) && clients.length) ? clients : safeParseFromStorage('dyna_clients', '[]');
			if (!Array.isArray(list)) list = [];
			return list.map(client => {
				const identifier = (client.referenceNumber || client.id || client.nbNumber || client.fullName || '').toString();
				return {
					id: identifier || `client-${Math.random().toString(36).slice(2, 8)}`,
					referenceNumber: client.referenceNumber || client.id || '',
					fullName: client.fullName || client.name || 'Client',
					phone: client.phone || '',
					email: client.email || '',
					membershipStatus: client.membershipStatus || 'referred',
					createdAt: client.createdAt || client.timestamp || client.firstVisit || null,
					dateOfBirth: client.dateOfBirth || client.dob || null
				};
			});
		}

		function populateCRMClientSelect(force = false) {
			const select = document.getElementById('crmClientSelect');
			if (!select) return;
			if (!force && select.dataset.populated === 'true') return;
			const currentValue = select.value;
			select.innerHTML = '<option value="">Select Client...</option>';
			const clients = getCRMClientsList().sort((a, b) => a.fullName.localeCompare(b.fullName));
			clients.forEach(client => {
				const option = document.createElement('option');
				option.value = client.id;
				option.textContent = client.fullName;
				option.dataset.reference = client.referenceNumber || '';
				select.appendChild(option);
			});
			if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
				select.value = currentValue;
			}
			select.dataset.populated = 'true';
		}

		function buildCRMCustomerInsights() {
			const insights = new Map();
			const clientList = getCRMClientsList();
			clientList.forEach(client => {
				insights.set(client.id, {
					client,
					totalSpent: 0,
					purchaseCount: 0,
					lastPurchase: null,
					createdAt: client.createdAt
				});
			});
			const reportList = Array.isArray(reports) ? reports : [];
			reportList.forEach(report => {
				const reference = report.clientId || report.clientReferenceNumber || report.referenceNumber || (report.clientInfo && report.clientInfo.referenceNumber);
				if (!reference) return;
				let key = reference;
				if (!insights.has(key)) {
					const matchingClient = clientList.find(c => c.referenceNumber === reference || c.fullName === (report.clientName || report.clientInfo?.fullName));
					if (matchingClient) key = matchingClient.id;
				}
				const bucket = insights.get(key);
				if (!bucket) return;
				const total = typeof calculateReportTotal === 'function' ? calculateReportTotal(report) : Number(report.total || 0);
				bucket.totalSpent += Number(total || 0);
				bucket.purchaseCount += 1;
				const purchaseDate = report.date || report.createdAt || report.timestamp;
				if (purchaseDate) {
					const date = new Date(purchaseDate);
					if (!bucket.lastPurchase || date > new Date(bucket.lastPurchase)) {
						bucket.lastPurchase = date.toISOString();
					}
				}
			});
			return insights;
		}

		function loadClientCommunication(clientId) {
			populateCRMClientSelect();
			const select = document.getElementById('crmClientSelect');
			const targetId = clientId || select?.value || '';
			if (select && targetId && select.value !== targetId) {
				select.value = targetId;
			}
			const overview = document.getElementById('crmClientOverview');
			const timeline = document.getElementById('crmInteractionTimeline');
			if (!targetId) {
				if (overview) overview.style.display = 'none';
				if (timeline) timeline.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Select a client to view communication history</p>';
				return;
			}
			const clientList = getCRMClientsList();
			const client = clientList.find(c => c.id === targetId) || clientList.find(c => c.referenceNumber === targetId);
			const insights = buildCRMCustomerInsights();
			const insight = insights.get(targetId) || { totalSpent: 0, purchaseCount: 0, lastPurchase: null, client: client || {} };
			const interactions = crmPortalInteractions
				.filter(interaction => interaction.clientId === targetId)
				.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
			if (overview) {
				overview.style.display = 'block';
				const nameEl = document.getElementById('crmClientName');
				if (nameEl) nameEl.textContent = (client && client.fullName) || 'Client';
				const totalInteractionsEl = document.getElementById('crmTotalInteractions');
				if (totalInteractionsEl) totalInteractionsEl.textContent = interactions.length.toString();
				const lastContactEl = document.getElementById('crmLastContact');
				if (lastContactEl) lastContactEl.textContent = interactions.length ? new Date(interactions[0].createdAt).toLocaleString() : 'Never';
				const purchaseCountEl = document.getElementById('crmPurchaseCount');
				if (purchaseCountEl) purchaseCountEl.textContent = (insight.purchaseCount || 0).toString();
				const totalSpentEl = document.getElementById('crmTotalSpent');
				if (totalSpentEl) totalSpentEl.textContent = `N$ ${(insight.totalSpent || 0).toFixed(2)}`;
			}
			if (timeline) {
				if (!interactions.length) {
					timeline.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No interactions logged yet.</p>';
				} else {
					timeline.innerHTML = interactions.map(interaction => `
						<div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 12px;">
							<div style="display:flex; justify-content:space-between; align-items:flex-start;">
								<div>
									<strong>${(interaction.channel || 'interaction').toUpperCase()}</strong>
									<p style="margin:6px 0;color:#555;">${interaction.notes || ''}</p>
								</div>
								<div style="text-align:right; font-size:0.8rem; color:#999;">
									<div>${interaction.createdAt ? new Date(interaction.createdAt).toLocaleString() : ''}</div>
									<div>${interaction.createdBy || 'CRM Portal'}</div>
								</div>
							</div>
						</div>
					`).join('');
				}
			}
		}

		function refreshCRMCommunication(force = false) {
			populateCRMClientSelect(force);
			const select = document.getElementById('crmClientSelect');
			const targetId = select?.value || '';
			loadClientCommunication(targetId);
		}

		function addClientInteraction() {
			populateCRMClientSelect(true);
			const select = document.getElementById('crmClientSelect');
			if (!select || !select.value) {
				alert('Please select a client before logging an interaction.');
				return;
			}
			const channel = prompt('Interaction channel (call/email/whatsapp/visit)', 'call');
			if (channel === null) return;
			const notes = prompt('Interaction summary / notes:');
			if (!notes) return;
			const interaction = {
				id: 'CRM-INT-' + Date.now(),
				clientId: select.value,
				clientName: select.options[select.selectedIndex]?.textContent || 'Client',
				channel: (channel || 'call').toLowerCase(),
				notes: notes.trim(),
				createdAt: new Date().toISOString(),
				createdBy: currentUser?.fullName || 'CRM Portal'
			};
			crmPortalInteractions.push(interaction);
			persistCRMData(CRM_STORAGE_KEYS.interactions, crmPortalInteractions);
			logCRMWorkflowEvent('interaction_logged', { clientId: interaction.clientId, channel: interaction.channel });
			loadClientCommunication(interaction.clientId);
			refreshWorkflows();
		}

		function exportClientHistory() {
			const select = document.getElementById('crmClientSelect');
			const targetId = select?.value || '';
			const interactions = targetId
				? crmPortalInteractions.filter(interaction => interaction.clientId === targetId)
				: crmPortalInteractions;
			if (!interactions.length) {
				alert('No client interactions available to export.');
				return;
			}
			const rows = [['Client', 'Channel', 'Notes', 'Created', 'Logged By']];
			interactions.forEach(interaction => {
				rows.push([
					interaction.clientName || 'Client',
					interaction.channel || 'interaction',
					interaction.notes || '',
					interaction.createdAt ? new Date(interaction.createdAt).toLocaleString() : '',
					interaction.createdBy || 'CRM Portal'
				]);
			});
			const csv = rows.map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
			const blob = new Blob([csv], { type: 'text/csv' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = targetId ? `client-${targetId}-history.csv` : 'crm-client-history.csv';
			link.click();
			URL.revokeObjectURL(link.href);
		}

		function renderSegmentList(elementId, members, emptyMessage) {
			const container = document.getElementById(elementId);
			if (!container) return;
			if (!members.length) {
				container.innerHTML = `<p style="text-align: center; color: #7f8c8d; padding: 20px;">${emptyMessage}</p>`;
				return;
			}
			container.innerHTML = members.slice(0, 30).map(member => {
				const lastPurchase = member.lastPurchase ? new Date(member.lastPurchase).toLocaleDateString() : 'N/A';
				return `
					<div class="client-card">
						<div style="display:flex; justify-content:space-between; align-items:flex-start;">
							<div>
								<strong>${member.client.fullName}</strong>
								<div style="font-size:0.85rem; color:#666;">Spent N$ ${(member.totalSpent || 0).toFixed(2)}</div>
							</div>
							<div style="text-align:right; font-size:0.75rem; color:#999;">Last purchase: ${lastPurchase}</div>
						</div>
					</div>
				`;
			}).join('');
		}

		function refreshSegmentation() {
			const insights = Array.from(buildCRMCustomerInsights().values());
			const vip = insights.filter(item => item.totalSpent >= 10000);
			const atRisk = insights.filter(item => {
				if (!item.lastPurchase) return false;
				const days = (Date.now() - new Date(item.lastPurchase).getTime()) / 86400000;
				return days > 90;
			});
			const active = insights.filter(item => {
				if (!item.lastPurchase) return false;
				const days = (Date.now() - new Date(item.lastPurchase).getTime()) / 86400000;
				return days <= 30;
			});
			const newClients = insights.filter(item => {
				if (!item.createdAt) return false;
				const days = (Date.now() - new Date(item.createdAt).getTime()) / 86400000;
				return days <= 30;
			});
			const setText = (id, value) => {
				const el = document.getElementById(id);
				if (el) el.textContent = value.toString();
			};
			setText('vipClientCount', vip.length);
			setText('atRiskClientCount', atRisk.length);
			setText('activeClientCount', active.length);
			setText('newClientCount', newClients.length);
			renderSegmentList('vipClientsList', vip, 'No VIP clients identified yet.');
			renderSegmentList('atRiskClientsList', atRisk, 'No at-risk clients at the moment.');
			renderSegmentList('activeClientsList', active, 'No active clients in the last 30 days.');
			renderSegmentList('purchaseBehaviorAnalysis', insights.slice(0, 20), 'No purchase behavior data yet.');
		}

		function exportSegmentationReport() {
			const insights = Array.from(buildCRMCustomerInsights().values());
			if (!insights.length) {
				alert('No segmentation data available to export.');
				return;
			}
			const rows = [['Client', 'Total Spent', 'Purchase Count', 'Last Purchase']];
			insights.forEach(item => {
				rows.push([
					item.client.fullName,
					item.totalSpent.toFixed(2),
					item.purchaseCount,
					item.lastPurchase ? new Date(item.lastPurchase).toLocaleDateString() : 'N/A'
				]);
			});
			const csv = rows.map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
			const blob = new Blob([csv], { type: 'text/csv' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = 'crm-segmentation-report.csv';
			link.click();
			URL.revokeObjectURL(link.href);
		}

		function logCRMWorkflowEvent(type, context = {}) {
			const entry = {
				id: 'CRM-WF-LOG-' + Date.now(),
				type,
				context,
				createdAt: new Date().toISOString(),
				runBy: currentUser?.fullName || 'CRM Portal'
			};
			crmPortalWorkflowLog.push(entry);
			persistCRMData(CRM_STORAGE_KEYS.workflowLog, crmPortalWorkflowLog.slice(-200));
		}

		function createWorkflow() {
			const type = prompt('Workflow type (welcome_email/birthday/reorder/followup)', 'welcome_email');
			if (!type) return;
			const description = prompt('Workflow description or target audience:', 'Automated workflow');
			const workflow = {
				id: 'CRM-WF-' + Date.now(),
				type: type.toLowerCase(),
				description: description || '',
				active: true,
				createdAt: new Date().toISOString()
			};
			crmPortalWorkflows.push(workflow);
			persistCRMData(CRM_STORAGE_KEYS.workflows, crmPortalWorkflows);
			logCRMWorkflowEvent('workflow_created', { type: workflow.type });
			refreshWorkflows();
			alert('‚úÖ Workflow created. Configure channel-specific settings via the buttons below.');
		}

		function refreshWorkflows() {
			const interactions = crmPortalInteractions || [];
			const todayIso = new Date().toISOString().split('T')[0];
			const emailsToday = interactions.filter(i => i.channel === 'email' && i.createdAt?.startsWith(todayIso)).length;
			const emailsTotal = interactions.filter(i => i.channel === 'email').length;
			const clients = getCRMClientsList();
			const today = new Date();
			const birthdayCount = clients.filter(client => {
				if (!client.dateOfBirth) return false;
				const dob = new Date(client.dateOfBirth);
				return dob.getMonth() === today.getMonth() && dob.getDate() === today.getDate();
			}).length;
			const birthdayGreetingsToday = interactions.filter(i => i.notes && /birthday/i.test(i.notes) && i.createdAt?.startsWith(todayIso)).length;
			const reorderRemindersToday = interactions.filter(i => i.channel === 'whatsapp' && /reorder/i.test(i.notes || '') && i.createdAt?.startsWith(todayIso)).length;
			const reorderWorkflows = crmPortalWorkflows.filter(w => w.type === 'reorder' && w.active).length;
			const followupsToday = interactions.filter(i => i.channel === 'call' && /follow/i.test(i.notes || '') && i.createdAt?.startsWith(todayIso)).length;
			const followupWorkflows = crmPortalWorkflows.filter(w => w.type === 'followup' && w.active).length;
			const setText = (id, value) => {
				const el = document.getElementById(id);
				if (el) el.textContent = value.toString();
			};
			setText('welcomeEmailsToday', emailsToday);
			setText('welcomeEmailsTotal', emailsTotal);
			setText('birthdaysToday', birthdayCount);
			setText('birthdayGreetingsToday', birthdayGreetingsToday);
			setText('reorderRemindersToday', reorderRemindersToday);
			setText('activeReminders', reorderWorkflows);
			setText('followupsToday', followupsToday);
			setText('pendingFollowups', followupWorkflows);
			const logContainer = document.getElementById('workflowLog');
			if (logContainer) {
				if (!crmPortalWorkflowLog.length) {
					logContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No workflow executions yet</p>';
				} else {
					logContainer.innerHTML = crmPortalWorkflowLog.slice(-25).reverse().map(entry => `
						<div style="background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:10px; margin-bottom:8px;">
							<div style="font-weight:600; color:#1f2937;">${entry.type}</div>
							<div style="font-size:0.8rem; color:#666;">${entry.createdAt ? new Date(entry.createdAt).toLocaleString() : ''} ‚Ä¢ ${entry.runBy || 'CRM Portal'}</div>
							${entry.context && Object.keys(entry.context).length ? `<pre style="background:#f9fafb; padding:6px; border-radius:4px; font-size:0.75rem; color:#4b5563;">${JSON.stringify(entry.context, null, 2)}</pre>` : ''}
						</div>
					`).join('');
				}
			}
		}

		function configureWelcomeEmails() {
			const message = prompt('Enter welcome email message template:', 'Welcome to Dynapharm Namibia!');
			if (message === null) return;
			logCRMWorkflowEvent('configure_welcome_email', { message });
			alert('‚úÖ Welcome email settings saved locally.');
		}

		function configureBirthdayGreetings() {
			const template = prompt('Enter birthday greeting template:', 'Happy Birthday from Dynapharm Namibia!');
			if (template === null) return;
			logCRMWorkflowEvent('configure_birthday_greeting', { template });
			alert('‚úÖ Birthday greeting configuration saved locally.');
		}

		function configureReorderReminders() {
			const cadence = prompt('How many days after purchase should reorder reminders be sent?', '30');
			if (cadence === null) return;
			logCRMWorkflowEvent('configure_reorder_reminder', { cadence });
			alert('‚úÖ Reorder reminder cadence saved locally.');
		}

		function configureFollowups() {
			const message = prompt('Enter follow-up prompt template:', 'Checking in after your recent consultation.');
			if (message === null) return;
			logCRMWorkflowEvent('configure_followup', { message });
			alert('‚úÖ Follow-up configuration saved locally.');
		}

		function determineLoyaltyTier(totalSpent) {
			const value = Number(totalSpent || 0);
			if (value >= 25000) return 'Platinum';
			if (value >= 10000) return 'Gold';
			if (value >= 2500) return 'Silver';
			if (value > 0) return 'Bronze';
			return 'Visitor';
		}

		function ensureLoyaltyMembersSeeded() {
			if (Array.isArray(crmLoyaltyMembers) && crmLoyaltyMembers.length) return;
			const insights = Array.from(buildCRMCustomerInsights().values()).filter(item => item.totalSpent > 0);
			crmLoyaltyMembers = insights
				.map(item => ({
					id: item.client.id,
					clientId: item.client.id,
					name: item.client.fullName,
					totalSpent: item.totalSpent,
					lastPurchase: item.lastPurchase,
					tier: determineLoyaltyTier(item.totalSpent)
				}))
				.sort((a, b) => b.totalSpent - a.totalSpent);
			persistCRMData(CRM_STORAGE_KEYS.loyalty, crmLoyaltyMembers);
		}

		function renderLoyaltyMembersList(members) {
			const listEl = document.getElementById('loyaltyMembersList');
			if (!listEl) return;
			if (!members.length) {
				listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No loyalty members yet.</p>';
				return;
			}
			listEl.innerHTML = members.slice(0, 100).map(member => {
				const last = member.lastPurchase ? new Date(member.lastPurchase).toLocaleDateString() : 'N/A';
				return `
					<div class="client-card">
						<div style="display:flex; justify-content:space-between; align-items:flex-start;">
							<div>
								<strong>${member.name}</strong>
								<div style="font-size:0.8rem; color:#999;">Tier: ${member.tier}</div>
							</div>
							<div style="text-align:right;">
								<div style="font-weight:600; color:#27ae60;">N$ ${Number(member.totalSpent || 0).toFixed(2)}</div>
								<div style="font-size:0.75rem; color:#999;">Last purchase: ${last}</div>
							</div>
						</div>
					</div>
				`;
			}).join('');
		}

		function refreshLoyaltyData() {
			ensureLoyaltyMembersSeeded();
			const tierCounts = { Bronze: 0, Silver: 0, Gold: 0, Platinum: 0 };
			crmLoyaltyMembers.forEach(member => {
				const tier = determineLoyaltyTier(member.totalSpent);
				member.tier = tier;
				if (tierCounts[tier] !== undefined) tierCounts[tier] += 1;
			});
			const setText = (id, value) => {
				const el = document.getElementById(id);
				if (el) el.textContent = value.toString();
			};
			setText('bronzeCount', tierCounts.Bronze);
			setText('silverCount', tierCounts.Silver);
			setText('goldCount', tierCounts.Gold);
			setText('platinumCount', tierCounts.Platinum);
			renderLoyaltyMembersList(crmLoyaltyMembers);
		}

		function showLoyaltyConfig() {
			alert('Configure loyalty program tiers and rewards via the CRM portal configuration. Current thresholds: Bronze 0-2,499, Silver 2,500-9,999, Gold 10,000-24,999, Platinum 25,000+. Update "crm_portal_loyalty" in localStorage to persist custom tiers.');
		}

		function viewLoyaltyReport() {
			ensureLoyaltyMembersSeeded();
			const rows = crmLoyaltyMembers.slice(0, 50).map(member => `
				<tr>
					<td style="padding:6px; border:1px solid #e5e7eb;">${member.name}</td>
					<td style="padding:6px; border:1px solid #e5e7eb;">${member.tier}</td>
					<td style="padding:6px; border:1px solid #e5e7eb; text-align:right;">N$ ${Number(member.totalSpent || 0).toFixed(2)}</td>
					<td style="padding:6px; border:1px solid #e5e7eb; text-align:right;">${member.lastPurchase ? new Date(member.lastPurchase).toLocaleDateString() : 'N/A'}</td>
				</tr>
			`).join('');
			openPrintWindow('Loyalty Program Report', `
				<h1 style="margin-bottom:16px;">Loyalty Program Report</h1>
				<table style="width:100%; border-collapse:collapse; font-size:12px;">
					<thead>
						<tr style="background:#f3f4f6;">
							<th style="padding:6px; border:1px solid #e5e7eb; text-align:left;">Member</th>
							<th style="padding:6px; border:1px solid #e5e7eb; text-align:left;">Tier</th>
							<th style="padding:6px; border:1px solid #e5e7eb; text-align:right;">Total Spent</th>
							<th style="padding:6px; border:1px solid #e5e7eb; text-align:right;">Last Purchase</th>
						</tr>
					</thead>
					<tbody>${rows}</tbody>
				</table>
			`, { pageSize: 'A4', fontSize: '11pt' });
		}

		function filterLoyaltyMembers() {
			const query = document.getElementById('loyaltySearch')?.value?.toLowerCase() || '';
			if (!Array.isArray(crmLoyaltyMembers)) return;
			if (!query) {
				renderLoyaltyMembersList(crmLoyaltyMembers);
				return;
			}
			const filtered = crmLoyaltyMembers.filter(member => {
				const name = (member.name || '').toLowerCase();
				const tier = (member.tier || '').toLowerCase();
				return name.includes(query) || tier.includes(query);
			});
			renderLoyaltyMembersList(filtered);
		}

		function showTimeSlotManagement() {
			const currentMorning = timeSlots.morning || {};
			const currentAfternoon = timeSlots.afternoon || {};
			const morningStart = prompt('Morning session start (HH:MM)', currentMorning.start || '08:00');
			if (!morningStart) return;
			const morningEnd = prompt('Morning session end (HH:MM)', currentMorning.end || '12:00') || currentMorning.end || '12:00';
			const morningInterval = parseInt(prompt('Morning interval (minutes)', String(currentMorning.interval || 30)), 10) || 30;
			const afternoonStart = prompt('Afternoon session start (HH:MM)', currentAfternoon.start || '13:00') || currentAfternoon.start || '13:00';
			const afternoonEnd = prompt('Afternoon session end (HH:MM)', currentAfternoon.end || '17:00') || currentAfternoon.end || '17:00';
			const afternoonInterval = parseInt(prompt('Afternoon interval (minutes)', String(currentAfternoon.interval || 30)), 10) || 30;
			timeSlots = {
				morning: { start: morningStart, end: morningEnd, interval: morningInterval },
				afternoon: { start: afternoonStart, end: afternoonEnd, interval: afternoonInterval }
			};
			try { localStorage.setItem('dyna_time_slots', JSON.stringify(timeSlots)); } catch (_) {}
			const calendar = document.getElementById('appointmentCalendar');
			if (calendar && calendar.style.display !== 'none') {
				renderCalendar(window.currentCalendarDate || new Date());
			}
			alert('‚úÖ Time slots updated for consultants.');
		}

		function showAppointmentAnalytics() {
			const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
			const stats = calculateConsultantAnalytics(timeframe);
			const message = [
				`üìä Appointment Analytics (${timeframe})`,
				`Total Clients: ${stats.totalClients}`,
				`Reports Created: ${stats.totalReports}`,
				`Member Clients: ${stats.memberClients} (${stats.memberPercentage}% of clients)`,
				`Referred Clients: ${stats.referredClients} (${stats.referredPercentage}% of clients)`,
				`Follow-ups Due: ${stats.followUpsDue}`,
				`Completed Follow-ups: ${stats.completedFollowUps}`,
				`Conversion Rate: ${stats.conversionRate}%`
			].join('\n');
			alert(message);
		}

		function showClientBookingPage() {
			const bookingUrl = (location && location.origin && location.origin !== 'null')
				? `${location.origin}/landing-page-preview.html#booking`
				: 'landing-page-preview.html#booking';
			window.open(bookingUrl, '_blank', 'noopener');
		}

		function copyBookingLink() {
			const bookingUrl = (location && location.origin && location.origin !== 'null')
				? `${location.origin}/landing-page-preview.html#booking`
				: 'landing-page-preview.html#booking';
			if (navigator.clipboard && navigator.clipboard.writeText) {
				navigator.clipboard.writeText(bookingUrl).then(() => {
					alert('‚úÖ Booking link copied to clipboard.');
				}).catch(() => {
					prompt('Copy booking link:', bookingUrl);
				});
			} else {
				prompt('Copy booking link:', bookingUrl);
			}
		}

        function bookAppointment() {
            const date = prompt('Enter appointment date (YYYY-MM-DD or leave blank for today):');
            const appointmentDate = date || new Date().toISOString().split('T')[0];
            
            const time = prompt('Enter appointment time (HH:MM in 24-hour format):');
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: appointmentDate,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                serviceType: 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`‚úÖ Appointment booked\nDate: ${new Date(appointmentDate).toLocaleDateString('en-GB')}\nTime: ${time}\nClient: ${clientName}`);
            
            if (document.getElementById('appointmentCalendar').style.display !== 'none') {
                renderCalendar(window.currentCalendarDate || new Date());
            }
            viewTodayAppointments();
        }

        function quickBookAppointment(dateStr) {
            const time = prompt(`Book appointment for ${new Date(dateStr).toLocaleDateString('en-GB')}\n\nEnter time (HH:MM in 24-hour format):`);
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: dateStr,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                serviceType: 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`‚úÖ Appointment booked\nTime: ${time}\nClient: ${clientName}`);
            renderCalendar(window.currentCalendarDate || new Date());
            selectCalendarDate(dateStr);
        }

        function cancelAppointment(aptId) {
            if (!confirm('Cancel this appointment?')) return;
            
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments.splice(index, 1);
                alert('‚úÖ Appointment cancelled');
                renderCalendar(window.currentCalendarDate || new Date());
                viewTodayAppointments();
            }
        }

        function viewTodayAppointments() {
            const listDiv = document.getElementById('appointmentsList');
            if (!listDiv) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = appointments.filter(apt => 
                apt.date === today && apt.consultant === currentUser.fullName
            ).sort((a, b) => a.time.localeCompare(b.time));
            
            if (todayAppointments.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;"><p>No appointments scheduled for today</p></div>';
                return;
            }
            
            listDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">Today's Appointments (${todayAppointments.length})</h4>
                    ${todayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="font-size: 1.1rem;">‚è∞ ${apt.time}</strong> - <strong>${apt.clientName}</strong>
                                    <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 4px;">Service: ${apt.serviceType || 'Full Body Check-Up'} | Status: <span style="background:${apt.status==='scheduled'?'#e3f2fd':apt.status==='checked_in'?'#fff3e0':apt.status==='in_progress'?'#e8f5e9':'#ecf0f1'}; padding:2px 6px; border-radius:4px;">${apt.status || 'scheduled'}</span></div>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #666; margin-top: 5px;">üìù ${apt.notes}</p>` : ''}
                                </div>
                                <div>
                                    ${apt.status === 'scheduled' ? `<button class=\"btn btn-sm\" onclick=\"checkInAppointment('${apt.id}')\" style=\"margin-right: 5px; background:#3498db;color:white;\">üßæ Check-in</button>` : ''}
                                    ${apt.status === 'checked_in' ? `<button class=\"btn btn-sm\" onclick=\"startFullBodyCheckup('${apt.id}')\" style=\"margin-right: 5px; background:#f39c12;color:white;\">‚ñ∂ Start</button>` : ''}
                                    <button class=\"btn btn-sm btn-success\" onclick=\"markAppointmentComplete('${apt.id}')\" style=\"margin-right: 5px;\">‚úÖ Complete</button>
                                    ${apt.status === 'completed' ? `<button class=\"btn btn-sm\" onclick=\"createFollowUpAppointment('${apt.id}')\" style=\"margin-right: 5px; background:#27ae60;color:white;\">‚ûï Follow-up</button>` : ''}
                                    <button class=\"btn btn-sm btn-danger\" onclick=\"cancelAppointment('${apt.id}')\">‚ùå Cancel</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function markAppointmentComplete(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'completed';
                appointments[index].completedAt = new Date().toISOString();
                // If a visit exists, close it
                try {
                    if (appointments[index].visitId) {
                        const vIdx = (visits || []).findIndex(v => v.id === appointments[index].visitId);
                        if (vIdx !== -1) {
                            visits[vIdx].status = 'completed';
                            visits[vIdx].completedAt = new Date().toISOString();
                        }
                        localStorage.setItem('dyna_visits', JSON.stringify(visits));
                    }
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_completed', appointments[index]); } catch(e){}
                alert('‚úÖ Appointment marked as complete');
                viewTodayAppointments();
                // Optional quick follow-up prompt
                if (confirm('Create a follow-up appointment?')) {
                    createFollowUpAppointment(appointments[index].id);
                }
            }
        }

        function checkInAppointment(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'checked_in';
                appointments[index].checkInAt = new Date().toISOString();
                appointments[index].serviceType = appointments[index].serviceType || 'Full Body Check-Up';
                // Create Visit record
                const visit = {
                    id: 'VIS' + Date.now(),
                    appointmentId: appointments[index].id,
                    clientName: appointments[index].clientName,
                    consultant: appointments[index].consultant || (currentUser && currentUser.fullName) || 'Unknown',
                    serviceType: appointments[index].serviceType,
                    branch: appointments[index].branch || (currentUser && currentUser.branch) || 'unknown',
                    status: 'checked_in',
                    createdAt: new Date().toISOString(),
                    checkInAt: appointments[index].checkInAt
                };
                try {
                    visits.push(visit);
                    appointments[index].visitId = visit.id;
                    localStorage.setItem('dyna_visits', JSON.stringify(visits));
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_checkin', appointments[index]); } catch(e){}
                viewTodayAppointments();
            }
        }

        function startFullBodyCheckup(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'in_progress';
                appointments[index].startedAt = new Date().toISOString();
                appointments[index].serviceType = appointments[index].serviceType || 'Full Body Check-Up';
                // Update related visit
                try {
                    if (appointments[index].visitId) {
                        const vIdx = (visits || []).findIndex(v => v.id === appointments[index].visitId);
                        if (vIdx !== -1) {
                            visits[vIdx].status = 'in_progress';
                            visits[vIdx].startedAt = appointments[index].startedAt;
                        }
                        localStorage.setItem('dyna_visits', JSON.stringify(visits));
                    }
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_started', appointments[index]); } catch(e){}
                viewTodayAppointments();
            }
        }

        function createFollowUpAppointment(sourceAptId) {
            const source = appointments.find(a => a.id === sourceAptId);
            const date = prompt('Enter follow-up date (YYYY-MM-DD):', new Date(Date.now()+7*24*60*60*1000).toISOString().split('T')[0]);
            if (!date) return;
            const time = prompt('Enter follow-up time (HH:MM in 24-hour format):', '09:00');
            if (!time) return;
            const followUp = {
                id: 'APT' + Date.now(),
                date: date,
                time: time,
                clientName: source ? source.clientName : 'Client',
                consultant: (source && source.consultant) || (currentUser && currentUser.fullName) || 'Consultant',
                notes: 'Follow-up appointment',
                serviceType: (source && source.serviceType) || 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString(),
                followUpOf: sourceAptId
            };
            appointments.push(followUp);
            try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
            try { recordDepartmentEvent('appointment_followup_created', followUp); } catch(e){}
            alert('‚úÖ Follow-up appointment scheduled');
            viewTodayAppointments();
        }

        function printAnalytics() {
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Performance Analytics - ${currentUser.fullName}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Consultant Performance Analytics - ${timeframeText}</p>
                        <p>Consultant: ${currentUser.fullName}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('analyticsDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function displayMyReports() {
            try {
                await loadData();
                
                const list = document.getElementById('myReportsList');
                if (!list) return;
                
                // Safety check for currentUser
                if (!currentUser || !currentUser.fullName) {
                    console.warn('‚ö†Ô∏è currentUser not set, cannot display reports');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view your reports.</p>';
                    return;
                }
                
                // Capture to prevent race conditions
                const userFullName = currentUser.fullName;
                if (!userFullName) {
                    console.warn('‚ö†Ô∏è currentUser.fullName is empty');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view your reports.</p>';
                    return;
                }
                
                console.log('üîç Displaying reports for:', userFullName);
                console.log('üìä Total reports available:', reports.length);
                console.log('üë• Consultants in reports:', [...new Set(reports.map(r => r && r.consultant).filter(Boolean))]);
                
                // Get all reports created by this consultant
                const myReports = reports.filter(r => r && r.id && r.consultant === userFullName);
                
                console.log('‚úÖ Reports found for', userFullName + ':', myReports.length);
                
                if (myReports.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìã No reports created yet</h3><p>Reports you create will appear here for review and editing.</p></div>';
                    return;
                }
                
                // Sort by timestamp - latest first
                myReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                list.innerHTML = '';
                console.log('üìã Displaying', myReports.length, 'reports');
                console.log('üë• Available clients:', clients.length);
                
                myReports.forEach(report => {
                    const client = clients.find(c => c.referenceNumber === report.clientId);
                    if (!client) {
                        console.warn('‚ö†Ô∏è No client found for report:', report.id, 'clientId:', report.clientId);
                        return;
                    }
                    
                    const dispensedCount = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;
                    const totalMedicines = report.medicines ? report.medicines.length : 0;
                    const isFullyDispensed = dispensedCount === totalMedicines && totalMedicines > 0;
                    
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.style.borderLeft = isFullyDispensed ? '5px solid #27ae60' : '5px solid #f39c12';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                                <p style="color: #7f8c8d; font-size: 0.9rem;">Report ID: ${report.id}</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${isFullyDispensed ? '#e8f5e9' : '#fff3cd'}; color: ${isFullyDispensed ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">
                                    ${isFullyDispensed ? '‚úÖ Fully Dispensed' : `‚è≥ ${dispensedCount}/${totalMedicines} Dispensed`}
                                </span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <p><strong>üìÖ Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                            <p><strong>üìû Client Phone:</strong> ${client.phone}</p>
                            <p><strong>üíä Medicines:</strong> ${totalMedicines} items</p>
                            ${report.followUpDate ? `<p><strong>üìÖ Follow-up:</strong> ${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
                        </div>
                        ${report.notes ? `
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #f39c12;">
                            <p style="font-size: 0.9rem;"><strong>üìù Notes:</strong> ${report.notes.substring(0, 100)}${report.notes.length > 100 ? '...' : ''}</p>
                        </div>
                        ` : ''}
                        <div style="text-align: center;">
                            <button class="btn btn-warning" onclick="editReport('${report.id}')" ${isFullyDispensed ? 'disabled title="Cannot edit fully dispensed report"' : ''}>
                                ‚úèÔ∏è Edit Report
                            </button>
                            <button class="btn btn-info" onclick="viewReportDetails('${report.id}')">üëÅÔ∏è View Details</button>
                            <button class="btn" onclick="printReportById('${report.id}')">üñ®Ô∏è Print</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('‚ùå Error in displayMyReports:', error);
                const list = document.getElementById('myReportsList');
                if (list) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #e74c3c;">Error loading reports. Please try again.</p>';
                }
            }
        }

        function searchMyReports() {
            const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
            if (!searchTerm) {
                displayMyReports();
                return;
            }
            
            const list = document.getElementById('myReportsList');
            const myReports = reports.filter(r => {
                if (!r.id || r.consultant !== currentUser.fullName) return false;
                const client = clients.find(c => c.referenceNumber === r.clientId);
                return r.id.toLowerCase().includes(searchTerm) || 
                       (client && client.fullName.toLowerCase().includes(searchTerm));
            });
            
            if (myReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No reports found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Use same display logic (will need to extract into reusable function)
            displayMyReports();
        }

        function showAllMyReports() {
            document.getElementById('reportSearch').value = '';
            displayMyReports();
        }

        async function refreshMyReports() {
            await loadData();
            await displayMyReports();
        }

        function editReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) {
                alert('Report not found');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Set current client ID for editing
            currentClientId = report.clientId;
            
            // Fill the report modal with existing data
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list and pre-select medicines from report
            loadMedicineList();
            
            // Pre-select medicines after a brief delay to ensure checkboxes are rendered
            setTimeout(() => {
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            if (cb.value === med.name) {
                                cb.checked = true;
                            }
                        });
                    });
                }
                updatePrescriptionDisplay();
            }, 100);
            
            // Pre-fill consultant notes
            document.getElementById('consultantNotes').value = report.notes || '';
            
            // Pre-fill follow-up date and notes
            if (report.followUpDate) {
                document.getElementById('followUpDate').value = report.followUpDate.split('T')[0];
            }
            if (report.followUpNotes) {
                document.getElementById('followUpNotes').value = report.followUpNotes;
            }
            
            // Initialize body systems
            initializeBodySystems();
            
            // Restore symptom selections from saved report
            setTimeout(() => {
                if (report.symptoms && report.symptoms.length > 0) {
                    report.symptoms.forEach(symptomData => {
                        const systemId = symptomData.system.replace(/[^a-zA-Z0-9]/g, '_');
                        const symptomCheckboxes = document.querySelectorAll('.symptom-checkbox');
                        
                        symptomCheckboxes.forEach(cb => {
                            if (cb.dataset.system === systemId && cb.dataset.symptom === symptomData.symptom) {
                                cb.checked = true;
                            }
                        });
                    });
                    // Trigger the symptom selection handler to update the display
                    handleSymptomSelection();
                }
            }, 200);
            
            // Set consultant signature
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            updateFollowUpDisplay();
            setupFollowUpListener();
            updateNotesDisplay();
            generateRecommendations(client);
            
            // Store report ID for updating instead of creating new
            window.editingReportId = reportId;
            
            // Show modal
            document.getElementById('reportModal').style.display = 'block';
        }

        function viewReportDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            let detailsHTML = `
                <h3>Report Details</h3>
                <p><strong>Report ID:</strong> ${report.id}</p>
                <p><strong>Client:</strong> ${client ? client.fullName : 'Unknown'}</p>
                <p><strong>Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                <p><strong>Consultant:</strong> ${report.consultant}</p>
                
                <h4 style="margin-top: 20px;">Prescribed Medicines:</h4>
                <ul>
                    ${report.medicines ? report.medicines.map(m => `<li>${m.name} ${m.dispensed ? '‚úÖ' : '‚è≥'}</li>`).join('') : '<li>None</li>'}
                </ul>
                
                ${report.notes ? `<h4>Notes:</h4><p>${report.notes}</p>` : ''}
                ${report.followUpDate ? `<h4>Follow-up:</h4><p>${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
            `;
            
            alert(detailsHTML.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n'));
        }

        function printReportById(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // Set current client ID and simulate printing
            currentClientId = report.clientId;
            
            // We need to reload the report modal to print
            // For now, use simplified print
            alert('Opening print preview...');
            editReport(reportId);
            setTimeout(() => {
                printReport();
            }, 1000);
        }

        async function displayFollowUps() {
            try {
                const list = document.getElementById('followUpList');
                if (!list) return;

                // Safety check for currentUser
                if (!currentUser || !currentUser.fullName) {
                    console.warn('‚ö†Ô∏è currentUser not set, cannot display follow-ups');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view follow-ups.</p>';
                    return;
                }

                // Capture to prevent race conditions
                const userFullName = currentUser.fullName;
                if (!userFullName) {
                    console.warn('‚ö†Ô∏è currentUser.fullName is empty');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view follow-ups.</p>';
                    return;
                }

                // Get all reports with follow-up dates
                const reportsWithFollowUp = reports.filter(r => r && r.followUpDate && r.consultant === userFullName);
                
                if (reportsWithFollowUp.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üìÖ No follow-ups scheduled</h3><p>Follow-ups will appear here once you create reports with follow-up dates.</p></div>';
                    return;
                }

                // Sort by follow-up date
                reportsWithFollowUp.sort((a, b) => new Date(a.followUpDate) - new Date(b.followUpDate));

                list.innerHTML = '';
                reportsWithFollowUp.forEach(report => {
                    const client = clients.find(c => c.referenceNumber === report.clientId);
                    if (!client) return;

                    const followUpDate = new Date(report.followUpDate);
                    const today = new Date();
                    const daysUntil = Math.ceil((followUpDate - today) / (1000 * 60 * 60 * 24));
                    
                    let statusClass = '';
                    let statusText = '';
                    if (daysUntil < 0) {
                        statusClass = 'overdue';
                        statusText = `Overdue by ${Math.abs(daysUntil)} days`;
                    } else if (daysUntil === 0) {
                        statusClass = 'today';
                        statusText = 'Today';
                    } else if (daysUntil <= 7) {
                        statusClass = 'upcoming';
                        statusText = `In ${daysUntil} days`;
                    } else {
                        statusClass = 'future';
                        statusText = `In ${daysUntil} days`;
                    }

                    const card = document.createElement('div');
                    card.className = `client-card follow-up-card ${statusClass}`;
                    card.innerHTML = `
                        <div class="follow-up-header">
                            <h4>${client.fullName}</h4>
                            <span class="follow-up-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="follow-up-details">
                            <p><strong>Follow-up Date:</strong> ${followUpDate.toLocaleDateString('en-GB')}</p>
                            <p><strong>Client:</strong> ${client.fullName} (${client.referenceNumber})</p>
                            <p><strong>Phone:</strong> ${client.phone}</p>
                            <p><strong>Last Visit:</strong> ${new Date(report.timestamp).toLocaleDateString('en-GB')}</p>
                            ${report.followUpNotes ? `<p><strong>Notes:</strong> ${report.followUpNotes}</p>` : ''}
                            <p><strong>Prescription:</strong> ${report.prescription || 'No prescription'}</p>
                        </div>
                        <div class="follow-up-actions">
                            <button class="btn btn-primary" onclick="viewClientDetails('${client.referenceNumber}')">View Client</button>
                            <button class="btn btn-success" onclick="createReport('${client.referenceNumber}')">Create New Report</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('‚ùå Error in displayFollowUps:', error);
                const list = document.getElementById('followUpList');
                if (list) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #e74c3c;">Error loading follow-ups. Please try again.</p>';
                }
            }
        }

        function filterFollowUps() {
            const searchDate = document.getElementById('followUpSearch').value;
            if (!searchDate) {
                displayFollowUps();
                return;
            }

            const list = document.getElementById('followUpList');
            const cards = list.querySelectorAll('.follow-up-card');
            
            cards.forEach(card => {
                const dateText = card.querySelector('.follow-up-details p').textContent;
                const cardDate = new Date(dateText.split(': ')[1]).toISOString().split('T')[0];
                card.style.display = cardDate === searchDate ? 'block' : 'none';
            });
        }

        function showAllFollowUps() {
            document.getElementById('followUpSearch').value = '';
            displayFollowUps();
        }

        async function refreshFollowUps() {
            await loadData();
            await displayFollowUps();
        }

        function viewClientDetails(referenceNumber, editMode = false) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a detailed view modal with edit functionality
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.id = 'clientDetailsModal';
            
            const editForm = editMode ? createClientEditForm(client) : createClientViewForm(client);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>${editMode ? 'Edit Client Details' : 'Client Details'} - ${client.referenceNumber}</h2>
                    ${editForm}
                    <div style="text-align: center; margin-top: 20px;">
                        ${editMode ? `
                            <button class="btn btn-success" onclick="saveClientChanges('${client.referenceNumber}')">üíæ Save Changes</button>
                            <button class="btn btn-secondary" onclick="viewClientDetails('${client.referenceNumber}', false)">‚ùå Cancel</button>
                        ` : `
                            <button class="btn btn-warning" onclick="viewClientDetails('${client.referenceNumber}', true)">‚úèÔ∏è Edit Details</button>
                            <button class="btn btn-primary" onclick="printClientDetails('${client.referenceNumber}')">üñ®Ô∏è Print Details</button>
                            <button class="btn" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function createClientViewForm(client) {
            return `
                <div class="client-details-print">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'} years</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Height:</strong> ${client.height || 'Not provided'} cm</div>
                            <div><strong>Weight:</strong> ${client.weight || 'Not provided'} kg</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || 'None')}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branches.find(b => b.id === client.branch)?.name || client.branch}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createClientEditForm(client) {
            return `
                <form id="clientEditForm" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Full Name</label>
                                <input type="text" name="fullName" value="${client.fullName}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Namibian ID Number</label>
                                <input type="text" name="nbNumber" value="${client.nbNumber}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Date of Birth</label>
                                <input type="date" name="dob" value="${client.dob || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" name="age" value="${client.age || ''}" min="1" max="120" readonly>
                            </div>
                            <div class="form-group">
                                <label class="required">Gender</label>
                                <select name="gender" required>
                                    <option value="Male" ${client.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${client.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${client.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Phone</label>
                                <input type="tel" name="phone" value="${client.phone}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" name="email" value="${client.email || ''}">
                            </div>
                            <div class="form-group">
                                <label class="required">Height (cm)</label>
                                <input type="number" name="height" value="${client.height || ''}" min="0" max="300" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Weight (kg)</label>
                                <input type="number" name="weight" value="${client.weight || ''}" min="0" max="500" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-group">
                            <label>Membership Status</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="member" ${client.membershipStatus === 'member' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Registered Member</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="referred" ${client.membershipStatus === 'referred' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Referred by Member</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="memberEditDetails" style="display: ${client.membershipStatus === 'member' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Member ID</label>
                                    <input type="text" name="memberId" value="${client.memberId || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Member Since</label>
                                    <input type="date" name="memberSince" value="${client.memberSince || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div id="referralEditDetails" style="display: ${client.membershipStatus === 'referred' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Referral Name *</label>
                                    <input type="text" name="referralName" value="${client.referralName || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Referral NB Number *</label>
                                    <input type="text" name="referralNbNumber" value="${client.referralNbNumber || ''}" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Primary Reason for Visit</label>
                                <input type="text" name="primaryReason" value="${client.primaryReason}" required>
                            </div>
                            <div class="form-group">
                                <label>Current Medications</label>
                                <textarea name="currentMedications" rows="3">${client.currentMedications || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Allergies</label>
                                <textarea name="allergies" rows="3">${client.allergies || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Medical History</label>
                                <textarea name="medicalHistory" rows="3">${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || '')}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Water Intake</label>
                                <select name="waterIntake">
                                    <option value="">Select...</option>
                                    <option value="Less than 1 liter" ${client.waterIntake === 'Less than 1 liter' ? 'selected' : ''}>Less than 1 liter</option>
                                    <option value="1-2 liters" ${client.waterIntake === '1-2 liters' ? 'selected' : ''}>1-2 liters</option>
                                    <option value="2-3 liters" ${client.waterIntake === '2-3 liters' ? 'selected' : ''}>2-3 liters</option>
                                    <option value="More than 3 liters" ${client.waterIntake === 'More than 3 liters' ? 'selected' : ''}>More than 3 liters</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Exercise Frequency</label>
                                <select name="exerciseFreq">
                                    <option value="">Select...</option>
                                    <option value="Never" ${client.exerciseFreq === 'Never' ? 'selected' : ''}>Never</option>
                                    <option value="1-2 times per week" ${client.exerciseFreq === '1-2 times per week' ? 'selected' : ''}>1-2 times per week</option>
                                    <option value="3-4 times per week" ${client.exerciseFreq === '3-4 times per week' ? 'selected' : ''}>3-4 times per week</option>
                                    <option value="Daily" ${client.exerciseFreq === 'Daily' ? 'selected' : ''}>Daily</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sleep Hours</label>
                                <select name="sleepHours">
                                    <option value="">Select...</option>
                                    <option value="Less than 5 hours" ${client.sleepHours === 'Less than 5 hours' ? 'selected' : ''}>Less than 5 hours</option>
                                    <option value="5-6 hours" ${client.sleepHours === '5-6 hours' ? 'selected' : ''}>5-6 hours</option>
                                    <option value="6-7 hours" ${client.sleepHours === '6-7 hours' ? 'selected' : ''}>6-7 hours</option>
                                    <option value="7-8 hours" ${client.sleepHours === '7-8 hours' ? 'selected' : ''}>7-8 hours</option>
                                    <option value="More than 8 hours" ${client.sleepHours === 'More than 8 hours' ? 'selected' : ''}>More than 8 hours</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stress Level</label>
                                <select name="stressLevel">
                                    <option value="">Select...</option>
                                    <option value="Low" ${client.stressLevel === 'Low' ? 'selected' : ''}>Low</option>
                                    <option value="Moderate" ${client.stressLevel === 'Moderate' ? 'selected' : ''}>Moderate</option>
                                    <option value="High" ${client.stressLevel === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Very High" ${client.stressLevel === 'Very High' ? 'selected' : ''}>Very High</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="form-group">
                            <label>Select Symptoms (Hold Ctrl/Cmd to select multiple)</label>
                            <select name="symptoms" multiple size="6" style="width: 100%;">
                                <option value="Fatigue" ${client.symptoms && client.symptoms.includes('Fatigue') ? 'selected' : ''}>Fatigue</option>
                                <option value="Headaches" ${client.symptoms && client.symptoms.includes('Headaches') ? 'selected' : ''}>Headaches</option>
                                <option value="Digestive Issues" ${client.symptoms && client.symptoms.includes('Digestive Issues') ? 'selected' : ''}>Digestive Issues</option>
                                <option value="Sleep Problems" ${client.symptoms && client.symptoms.includes('Sleep Problems') ? 'selected' : ''}>Sleep Problems</option>
                                <option value="Joint Pain" ${client.symptoms && client.symptoms.includes('Joint Pain') ? 'selected' : ''}>Joint Pain</option>
                                <option value="Skin Issues" ${client.symptoms && client.symptoms.includes('Skin Issues') ? 'selected' : ''}>Skin Issues</option>
                                <option value="Weight Issues" ${client.symptoms && client.symptoms.includes('Weight Issues') ? 'selected' : ''}>Weight Issues</option>
                                <option value="Mood Changes" ${client.symptoms && client.symptoms.includes('Mood Changes') ? 'selected' : ''}>Mood Changes</option>
                                <option value="None" ${client.symptoms && client.symptoms.includes('None') ? 'selected' : ''}>None</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
        }

        function toggleEditMembershipStatus() {
            const memberRadio = document.querySelector('input[name="membershipStatus"][value="member"]');
            const referredRadio = document.querySelector('input[name="membershipStatus"][value="referred"]');
            const memberDetails = document.getElementById('memberEditDetails');
            const referralDetails = document.getElementById('referralEditDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');
            
            if (memberRadio && referredRadio && memberDetails && referralDetails) {
                if (memberRadio.checked) {
                    memberDetails.style.display = 'block';
                    referralDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                } else if (referredRadio.checked) {
                    memberDetails.style.display = 'none';
                    referralDetails.style.display = 'block';
                    if (referralNameInput) referralNameInput.required = true;
                    if (referralNbInput) referralNbInput.required = true;
                }
            }
        }

        async function saveClientChanges(referenceNumber) {
            const form = document.getElementById('clientEditForm');
            if (!form) return;

            const formData = new FormData(form);
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Update client data
            const updatedClient = {
                ...client,
                fullName: formData.get('fullName').trim(),
                nbNumber: formData.get('nbNumber').trim(),
                email: formData.get('email'),
                phone: formData.get('phone'),
                age: formData.get('age'),
                gender: formData.get('gender'),
                membershipStatus: formData.get('membershipStatus'),
                memberId: formData.get('memberId'),
                memberSince: formData.get('memberSince'),
                referralName: formData.get('referralName'),
                referralNbNumber: formData.get('referralNbNumber'),
                primaryReason: formData.get('primaryReason'),
                currentMedications: formData.get('currentMedications'),
                allergies: formData.get('allergies'),
                medicalHistory: formData.get('medicalHistory'),
                waterIntake: formData.get('waterIntake'),
                exerciseFreq: formData.get('exerciseFreq'),
                sleepHours: formData.get('sleepHours'),
                stressLevel: formData.get('stressLevel'),
                symptoms: Array.from(formData.getAll('symptoms')),
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser ? currentUser.fullName : 'Unknown'
            };

            try {
                const result = await apiRequest('/clients', 'PUT', updatedClient);
                if (result.success) {
                    // Update local data
                    const index = clients.findIndex(c => c.referenceNumber === referenceNumber);
                    if (index !== -1) {
                        clients[index] = updatedClient;
                    }
                    
                    // Refresh the display
                    if (currentPortal === 'consultant') {
                        await displayClients();
                    }
                    
                    // Close modal and show success
                    document.getElementById('clientDetailsModal').remove();
                    alert('‚úÖ Client details updated successfully!');
                } else {
                    alert('Error updating client: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating client:', error);
                alert('Error updating client. Please try again.');
            }
        }

        function printClientDetails(referenceNumber) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a print-friendly window
            const printWindow = window.open('', '_blank');
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Client Details - ${client.referenceNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.3;
                            max-width: 21cm;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #c41e3a;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                            background: linear-gradient(135deg, rgba(196,30,58,0.05) 0%, rgba(139,0,0,0.05) 100%);
                            border-radius: 8px;
                            padding: 15px;
                        }
                        .header h1 {
                            font-size: 22px;
                            color: #c41e3a;
                            margin-bottom: 5px;
                            font-weight: 900;
                        }
                        .header h2 {
                            font-size: 14px;
                            color: #333;
                            margin: 5px 0;
                        }
                        .section {
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .section h3 {
                            font-size: 12px;
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid #c41e3a;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        .form-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                        }
                        .symptoms-display {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 5px;
                            margin-top: 5px;
                        }
                        .symptom-tag {
                            background: #e3f2fd;
                            color: #1976d2;
                            padding: 3px 8px;
                            border-radius: 10px;
                            font-size: 9px;
                            font-weight: 500;
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        ${generateLogoSVG(200, 120)}
                    </div>
                    
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Client Registration Details</h2>
                        <p>Branch: ${branchName} | Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Reference Number:</strong> ${client.referenceNumber}</div>
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'}</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${client.medicalHistory || 'None'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branchName}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function createReport(refNum) {
            currentClientId = refNum;
            const client = clients.find(c => c.referenceNumber === refNum);
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Clear editing flag (we're creating a new report, not editing)
            window.editingReportId = null;
            
            // Fill prescription modal
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            // Display symptoms
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            // Health Assessment
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list
            loadMedicineList();
            
            // Set consultant signature name and contact info
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            // Set default follow-up date (2 weeks from now)
            const followUpDate = new Date();
            followUpDate.setDate(followUpDate.getDate() + 14);
            document.getElementById('followUpDate').value = followUpDate.toISOString().split('T')[0];
            
            // Update follow-up date display
            updateFollowUpDisplay();
            
            // Setup event listener for follow-up date
            setupFollowUpListener();
            
            // Update prescription display
            updatePrescriptionDisplay();
            
            // Update notes display
            updateNotesDisplay();
            
            // Generate recommendations based on symptoms and health data
            generateRecommendations(client);
            
            // Initialize body systems selector
            initializeBodySystems();
            
            document.getElementById('reportModal').style.display = 'block';
        }

        // Body Systems and Lifestyle Recommendations Database
        const BODY_SYSTEMS_DATABASE = {
            'Nervous System': {
                symptoms: {
                    'Headaches and dizziness': 'Practice stress-management techniques like meditation, prayer, or deep breathing.',
                    'Insomnia or restless sleep': 'Maintain a regular sleep routine (7‚Äì8 hours daily).',
                    'Poor concentration and memory loss': 'Take short breaks from screens to rest the mind and eat foods rich in B-vitamins, omega-3, and magnesium (e.g., fish, nuts, leafy greens).'
                }
            },
            'Cardiovascular System': {
                symptoms: {
                    'Palpitations or irregular heartbeat': 'Practice relaxation techniques to reduce stress-induced hypertension and engage in light aerobic exercise.',
                    'Shortness of breath': 'Engage in aerobic exercise (walking, swimming, cycling) for at least 30 minutes, 4‚Äì5 times weekly.',
                    'Cold hands and feet or fatigue': 'Eat a balanced diet rich in fruits, vegetables, and healthy fats (olive oil, avocados) to improve circulation.'
                }
            },
            'Digestive System': {
                symptoms: {
                    'Bloating and indigestion': 'Eat meals on time and chew slowly to aid digestion.',
                    'Constipation or diarrhea': 'Increase fiber and water intake; reduce processed foods.',
                    'Loss of appetite or heartburn': 'Avoid late-night eating and use probiotic-rich foods (yogurt, fermented vegetables) to maintain gut health.'
                }
            },
            'Respiratory System': {
                symptoms: {
                    'Frequent cough or shortness of breath': 'Practice deep breathing exercises and outdoor walks in clean air.',
                    'Chest tightness': 'Avoid smoking and dusty environments; keep indoor air fresh with plants or ventilation.',
                    'Low lung endurance': 'Strengthen lungs through light aerobic activity or yoga.'
                }
            },
            'Immune System': {
                symptoms: {
                    'Frequent colds or infections': 'Eat immune-boosting foods (citrus fruits, garlic, mushrooms) and sleep adequately.',
                    'Slow wound healing': 'Maintain personal hygiene, stay hydrated, and ensure adequate rest.',
                    'Allergic reactions or fatigue': 'Exercise moderately to stimulate immune response and avoid chronic stress.'
                }
            },
            'Endocrine System': {
                symptoms: {
                    'Weight fluctuations': 'Keep consistent sleep and meal times to stabilize hormones and engage in regular moderate exercise.',
                    'Mood swings or irritability': 'Reduce sugar, alcohol, and processed food intake to balance hormones.',
                    'Irregular menstruation or libido changes': 'Consume hormone-supportive foods like soy, flaxseed, and whole grains.'
                }
            },
            'Musculoskeletal System': {
                symptoms: {
                    'Muscle stiffness or pain': 'Stretch daily and maintain good posture throughout the day.',
                    'Joint aches': 'Engage in strength and flexibility training with adequate calcium, magnesium, and vitamin D intake.',
                    'Back or neck discomfort': 'Avoid prolonged sitting ‚Äî stand or walk every hour and maintain proper posture.'
                }
            },
            'Urinary System': {
                symptoms: {
                    'Frequent urination or urgency': 'Limit salt and caffeine intake; avoid holding urine for long periods.',
                    'Lower back pain': 'Drink 1.5‚Äì2 liters of water daily to flush toxins and maintain kidney health.',
                    'Swelling in legs or feet': 'Limit salt intake, stay hydrated, and elevate legs when resting.'
                }
            },
            'Reproductive System': {
                symptoms: {
                    'Reduced sexual desire': 'Eat zinc- and vitamin E-rich foods (nuts, seeds, eggs) and manage stress through proper rest.',
                    'Irregular cycles or erectile issues': 'Exercise to improve circulation and avoid excessive alcohol, smoking, and processed fats.',
                    'Hormonal imbalances': 'Ensure proper rest, eat hormone-supportive foods, and maintain a regular exercise routine.'
                }
            },
            'Integumentary System (Skin, Hair, Nails)': {
                symptoms: {
                    'Dry or dull skin': 'Drink plenty of water and consume antioxidant-rich foods (berries, green tea).',
                    'Hair loss or brittleness': 'Get enough sleep to support skin and hair repair, and ensure adequate protein intake.',
                    'Acne or skin sensitivity': 'Keep the skin clean and moisturized; avoid excessive sun exposure and use natural skincare.'
                }
            },
            'Lymphatic System': {
                symptoms: {
                    'Swollen lymph nodes': 'Engage in light exercise and massage to improve lymph circulation.',
                    'Puffy face or limbs': 'Stay hydrated, avoid heavy oily foods, and include detoxifying foods like lemon and ginger.',
                    'Chronic fatigue': 'Maintain proper posture, avoid tight clothing that blocks flow, and get adequate rest.'
                }
            },
            'Sensory System (Eyes, Ears, Nose)': {
                symptoms: {
                    'Eye fatigue or blurred vision': 'Take screen breaks every 30‚Äì40 minutes and do simple eye relaxation exercises (palming, distant focusing).',
                    'Ringing in the ears (tinnitus)': 'Avoid loud noise exposure, maintain ear hygiene, and ensure adequate magnesium intake.',
                    'Sensitivity to light or sound': 'Maintain good lighting while working or reading and eat foods rich in vitamin A and lutein (carrots, spinach).'
                }
            }
        };

        function initializeBodySystems() {
            const container = document.getElementById('bodySystemsSelector');
            let html = '';
            
            Object.keys(BODY_SYSTEMS_DATABASE).forEach((systemName, index) => {
                const system = BODY_SYSTEMS_DATABASE[systemName];
                const systemId = systemName.replace(/[^a-zA-Z0-9]/g, '_');
                
                html += `
                    <div class="body-system-card" style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleSystemSymptoms('${systemId}')">
                            <input type="checkbox" id="system_${systemId}" onchange="handleSystemSelection('${systemId}')" 
                                   style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                            <h4 style="color: #2196f3; margin: 0; flex: 1; font-size: 1.1rem;">${systemName}</h4>
                            <span id="toggle_${systemId}" style="font-size: 1.2rem; color: #2196f3;">‚ñº</span>
                        </div>
                        
                        <div id="symptoms_${systemId}" style="display: none; margin-top: 10px; padding-left: 30px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 8px; font-weight: 600;">Common Symptoms:</p>
                            ${Object.keys(system.symptoms).map((symptom, i) => `
                                <label style="display: block; padding: 5px 0; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" class="symptom-checkbox" data-system="${systemId}" data-symptom="${symptom.replace(/"/g, '&quot;')}"
                                           onchange="handleSymptomSelection()" style="margin-right: 8px;">
                                    ${symptom}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleSystemSymptoms(systemId) {
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const toggleIcon = document.getElementById(`toggle_${systemId}`);
            
            if (symptomsDiv.style.display === 'none') {
                symptomsDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                symptomsDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function handleSystemSelection(systemId) {
            const checkbox = document.getElementById(`system_${systemId}`);
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const symptomCheckboxes = symptomsDiv.querySelectorAll('.symptom-checkbox');
            
            if (checkbox.checked) {
                // Expand symptoms
                symptomsDiv.style.display = 'block';
                document.getElementById(`toggle_${systemId}`).textContent = '‚ñ≤';
            } else {
                // Uncheck all symptoms
                symptomCheckboxes.forEach(cb => cb.checked = false);
            }
            
            handleSymptomSelection();
        }

        function handleSymptomSelection() {
            const selectedSymptoms = [];
            const recommendationsDiv = document.getElementById('lifestyleRecommendations');
            
            // Find all checked symptoms with their data
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const systemId = checkbox.dataset.system;
                const symptomName = checkbox.dataset.symptom;
                
                // Find the original system name
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName) {
                    const system = BODY_SYSTEMS_DATABASE[systemName];
                    const recommendation = system.symptoms[symptomName];
                    
                    if (recommendation) {
                        selectedSymptoms.push({
                            system: systemName,
                            symptom: symptomName,
                            recommendation: recommendation
                        });
                    }
                }
            });
            
            if (selectedSymptoms.length === 0) {
                recommendationsDiv.style.display = 'none';
                return;
            }
            
            // Display recommendations - one per symptom
            let html = '<h4 style="color: #2196f3; margin-bottom: 20px; font-size: 1.2rem;">üìã Healthy Lifestyle Recommendations</h4>';
            html += '<div style="display: grid; gap: 12px;">';
            
            selectedSymptoms.forEach((item, index) => {
                html += `
                    <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 1.2rem; color: #2196f3;">‚úì</span>
                            <div style="flex: 1;">
                                <strong style="color: #1976d2; font-size: 0.95rem;">${item.symptom}</strong>
                                <span style="color: #666; font-size: 0.85rem; margin-left: 8px;">(${item.system})</span>
                                <p style="margin: 5px 0 0 0; color: #555; line-height: 1.5; font-size: 0.9rem;">${item.recommendation}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            recommendationsDiv.innerHTML = html;
            recommendationsDiv.style.display = 'block';
        }

        // Symptom-to-Medicine Recommendation Database
        const RECOMMENDATION_DATABASE = {
            // Symptoms mapping
            symptoms: {
                fatigue: ['Spirulina Tabs', 'Dyna Tonic 780ml', 'Bee Pollen Capsule 100\'s', 'Ginseng Capsule', 'Yeeginako Tabs'],
                headache: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Nutmeg Ointment'],
                nausea: ['Ginger capsule', 'Soybean & Ginger', 'Noni 1 Ltr', 'Spirulina Tabs'],
                dizziness: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                shortness_breath: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Ginkgo & Ginseng - C'],
                blurred_vision: ['Ginkgo & Ginseng - C', 'Dyna C- 150\'s', 'Spirulina Tabs'],
                joint_pain: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Dyna \'S\' Tablet 120\'s', 'Sea Cucumber 500ml'],
                cough: ['Dyna Tonic 780ml', 'Noni 1 Ltr', 'Spirulina Tabs'],
                digestive_issues: ['Spirulina Tabs', 'Pro LSB', 'Gastritus Package', 'High Fiber'],
                loss_appetite: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml'],
                fever: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Noni 1 Ltr'],
                sore_throat: ['Ganoderma Toothpaste', 'Noni 1 Ltr', 'Dyna C- 150\'s'],
                skin_rash: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s'],
                chest_pain: ['Ginkgo & Ginseng - C', 'Blood Circulation Package', 'Noni 1 Ltr'],
                lower_back: ['Nutmeg Ointment', 'Healthy Joints Pack', 'Sea Cucumber 500ml'],
                weight_changes: ['Diet & Weight Management Pack', 'Spirulina Tabs', 'High Fiber'],
                insomnia: ['Gano & Green Tea - C', 'Spirulina Tabs', 'Maharani'],
                confusion: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                foot_edema: ['Blood Circulation Package', 'Spirulina Tabs'],
                swelling: ['Blood Circulation Package', 'Spirulina Tabs', 'Sea Cucumber 500ml']
            },
            // Medical history mapping
            medicalHistory: {
                highBloodPressure: ['Blood Circulation Package', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Noni 1 Ltr'],
                diabetes: ['Spirulina Tabs', 'Noni 1 Ltr', 'Bitter Gourd Tea', 'Balanced Body System Package'],
                heartDisease: ['Blood Circulation Package', 'Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Noni 1 Ltr'],
                asthma: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Noni 1 Ltr'],
                digestiveDisorders: ['Gastritus Package', 'Spirulina Tabs', 'Pro LSB', 'High Fiber'],
                thyroid: ['Spirulina Tabs', 'Balanced Body System Package', 'Sea Cucumber 500ml'],
                kidneyLiver: ['Cleansing & Detoxification Package', 'Spirulina Tabs', 'Milk Thistle Tablet 120\'s'],
                chronicFatigue: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml', 'Ginseng Capsule'],
                arthritis: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Sea Cucumber 500ml', 'Spirulina Tabs'],
                skinConditions: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s', 'Cleansing & Detoxification Package'],
                mentalHealth: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                autoimmune: ['Spirulina Tabs', 'Balanced Body System Package', 'Noni 1 Ltr'],
                cancer: ['Spirulina Tabs', 'Noni 1 Ltr', 'Total Health Pack']
            },
            // Gender-specific
            gender: {
                female: ['Women\'s Package', 'Kacip Fatimah', 'Collagen & Kacip- C', 'Maharani'],
                male: ['Men\'s Package', 'Tongkat Ali & Maca - C', 'Dyna Serenoa Tablet 100\'s']
            },
            // Lifestyle factors
            lifestyle: {
                poorSleep: ['Gano & Green Tea - C', 'Maharani', 'Spirulina Tabs'],
                highStress: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                lowExercise: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Total Health Pack'],
                poorWater: ['High Fiber', 'Spirulina Tabs']
            },
            // Age-based
            age: {
                elderly: ['Elderly Package (Female)', 'Elderly Package (Male)', 'Spirulina Tabs', 'Ginkgo & Ginseng - C']
            },
            // General wellness
            general: ['Spirulina Tabs', 'Dyna C- 150\'s', 'Bee Pollen Capsule 100\'s']
        };

        function generateRecommendations(client) {
            const recommendations = new Set();
            const reasonsMap = new Map();
            
            // Helper function to add recommendation with reason
            const addRecommendation = (medicine, reason) => {
                recommendations.add(medicine);
                if (!reasonsMap.has(medicine)) {
                    reasonsMap.set(medicine, []);
                }
                reasonsMap.get(medicine).push(reason);
            };
            
            // Check symptoms
            if (client.symptoms && client.symptoms.length > 0) {
                client.symptoms.forEach(symptom => {
                    if (symptom !== 'none' && RECOMMENDATION_DATABASE.symptoms[symptom]) {
                        RECOMMENDATION_DATABASE.symptoms[symptom].forEach(med => {
                            addRecommendation(med, `Symptom: ${symptom.replace(/_/g, ' ')}`);
                        });
                    }
                });
            }
            
            // Check medical history
            if (client.medicalHistory && Array.isArray(client.medicalHistory)) {
                client.medicalHistory.forEach(condition => {
                    if (condition !== 'na' && RECOMMENDATION_DATABASE.medicalHistory[condition]) {
                        RECOMMENDATION_DATABASE.medicalHistory[condition].forEach(med => {
                            addRecommendation(med, `Medical History: ${condition.replace(/([A-Z])/g, ' $1').trim()}`);
                        });
                    }
                });
            }
            
            // Check gender-specific
            const gender = client.gender ? client.gender.toLowerCase() : '';
            if (gender && RECOMMENDATION_DATABASE.gender[gender]) {
                RECOMMENDATION_DATABASE.gender[gender].forEach(med => {
                    addRecommendation(med, `Gender-specific (${gender})`);
                });
            }
            
            // Check lifestyle factors
            if (client.sleepHours === '<5' || client.sleepHours === '5-6') {
                RECOMMENDATION_DATABASE.lifestyle.poorSleep.forEach(med => {
                    addRecommendation(med, 'Poor sleep quality');
                });
            }
            
            if (parseInt(client.stressLevel) >= 7) {
                RECOMMENDATION_DATABASE.lifestyle.highStress.forEach(med => {
                    addRecommendation(med, 'High stress level');
                });
            }
            
            if (client.exerciseFreq === 'never' || client.exerciseFreq === '1-2') {
                RECOMMENDATION_DATABASE.lifestyle.lowExercise.forEach(med => {
                    addRecommendation(med, 'Low physical activity');
                });
            }
            
            if (client.waterIntake === 'less1') {
                RECOMMENDATION_DATABASE.lifestyle.poorWater.forEach(med => {
                    addRecommendation(med, 'Low water intake');
                });
            }
            
            // Check age (elderly 60+)
            if (client.age && parseInt(client.age) >= 60) {
                const elderlyPackage = gender === 'female' ? 'Elderly Package (Female)' : 'Elderly Package (Male)';
                addRecommendation(elderlyPackage, 'Age 60+');
                RECOMMENDATION_DATABASE.age.elderly.forEach(med => {
                    if (med !== elderlyPackage) {
                        addRecommendation(med, 'Age-appropriate');
                    }
                });
            }
            
            // If no specific recommendations, add general wellness
            if (recommendations.size === 0) {
                RECOMMENDATION_DATABASE.general.forEach(med => {
                    addRecommendation(med, 'General wellness');
                });
            }
            
            // Display recommendations
            displayRecommendations(Array.from(recommendations), reasonsMap);
        }

        function displayRecommendations(recommendations, reasonsMap) {
            const display = document.getElementById('recommendationsDisplay');
            
            if (recommendations.length === 0) {
                display.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">No specific recommendations available.</p>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üìã Recommended Products (${recommendations.length})</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                        Click on any product to select it, or use "Apply All" button below to select all recommendations.
                    </p>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            recommendations.forEach((medicine, index) => {
                const reasons = reasonsMap.get(medicine) || [];
                const uniqueReasons = [...new Set(reasons)];
                
                html += `
                    <div class="recommendation-item" style="background: #f0fff4; border: 2px solid #27ae60; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;" 
                         onclick="selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')"
                         onmouseover="this.style.background='#d4edda'; this.style.transform='scale(1.02)'"
                         onmouseout="this.style.background='#f0fff4'; this.style.transform='scale(1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: #27ae60; font-size: 1.05rem;">‚úì ${medicine}</strong>
                                <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                    ${uniqueReasons.map(reason => `<span style="background: #fff; padding: 2px 8px; border-radius: 10px; margin-right: 5px; display: inline-block; margin-top: 3px; border: 1px solid #ddd;">üéØ ${reason}</span>`).join('')}
                                </div>
                            </div>
                            <button class="btn btn-success" style="padding: 5px 15px; font-size: 0.85rem; margin-left: 10px;" 
                                    onclick="event.stopPropagation(); selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')">
                                Add
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            display.innerHTML = html;
            
            // Store recommendations for "Apply All" functionality
            window.currentRecommendations = recommendations;
        }

        function selectRecommendedMedicine(medicineName) {
            // Find the checkbox for this medicine in the medicine grid
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === medicineName && !cb.checked) {
                    cb.checked = true;
                }
            });
            updatePrescriptionDisplay();
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Added';
            btn.style.background = '#2ecc71';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function applyRecommendations() {
            if (!window.currentRecommendations || window.currentRecommendations.length === 0) {
                alert('No recommendations available.');
                return;
            }
            
            // Select all recommended medicines
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            let appliedCount = 0;
            
            window.currentRecommendations.forEach(medicine => {
                checkboxes.forEach(cb => {
                    if (cb.value === medicine && !cb.checked) {
                        cb.checked = true;
                        appliedCount++;
                    }
                });
            });
            
            updatePrescriptionDisplay();
            alert(`‚úÖ Applied ${appliedCount} recommended products to prescription!`);
        }

        // DYNAPHARM NAMIBIA SPECIAL PACKAGE 2025 - Official Package Database
        PACKAGE_DATABASE = window.PACKAGE_DATABASE = {
            'Gastric Package': {
                price: { dp: 2054, cp: 2432, bv: 381 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'PRO-LSB TABLET 150\'s', quantity: 1, dp: 455, cp: 573, bv: 100 },
                    { name: 'INSTANT GINSENG HONEY GINGER 500g', quantity: 1, dp: 350, cp: 455, bv: 43 },
                    { name: 'GOAT\'S MILK TABLET 150\'s', quantity: 1, dp: 286, cp: 372, bv: 48 }
                ]
            },
            'Womens Package': {
                price: { dp: 2543, cp: 2950, bv: 481 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'HERBA WARISAN MAHARANI 6 x 10g', quantity: 1, dp: 520, cp: 620, bv: 110 },
                    { name: 'INSTANT COFFEE MIX W/GANO, COLLAGEN & KACIP 15\'s', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'GAMAT FEMININE WASH (2)', quantity: 1, dp: 200, cp: 260, bv: 23 }
                ]
            },
            'Mens Health Package': {
                price: { dp: 2033, cp: 2362, bv: 388 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Blood Circulation Pack': {
                price: { dp: 3290, cp: 3854, bv: 657 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 }
                ]
            },
            'Elderly Package (Female)': {
                price: { dp: 3801, cp: 4475, bv: 779.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'PROLINK 20\'s x20g', quantity: 1, dp: 588, cp: 688, bv: 135 }
                ]
            },
            'Elderly Package (Male)': {
                price: { dp: 3263, cp: 3883, bv: 663 },
                products: [
                    { name: 'INSTANT COFFEE MIX W/GINKGO & GINSENG 20\'s x21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 }
                ]
            },
            'Total Health Pack': {
                price: { dp: 2570, cp: 2985, bv: 515 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 }
                ]
            },
            'Balanced Body System Pack': {
                price: { dp: 3846, cp: 4446, bv: 835 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'PROLINK 30\'s x20g', quantity: 1, dp: 600, cp: 719, bv: 170 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 }
                ]
            },
            'Cleansing And Detoxification Package': {
                price: { dp: 2183, cp: 2596, bv: 447 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 43 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 }
                ]
            },
            'Weight Management Pack': {
                price: { dp: 2283, cp: 2680, bv: 448 },
                products: [
                    { name: 'GREEN TEA EXTRACT CAPSULE 60\'s', quantity: 1, dp: 344, cp: 430, bv: 85 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 65 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'HIGH FIBER NUTRION FOOD 30\'s x25g', quantity: 1, dp: 660, cp: 780, bv: 120 },
                    { name: 'INSTANT COFFEE MIX W/ GANO & GREEN TEA 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Healthy Joints Package': {
                price: { dp: 3538, cp: 4177, bv: 687.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'D I INSTANT GOAT MILK POWDER PREMIX 20\'s x 21g', quantity: 1, dp: 325, cp: 400, bv: 43 }
                ]
            }
        };

        // Individual product prices (for when sold separately)
        // Get individual products from PRICE_LIST
        const INDIVIDUAL_PRODUCTS = PRICE_LIST.map(item => item.description);

        function loadMedicineList() {
            const packages = Object.keys(PACKAGE_DATABASE);
            const grid = document.getElementById('medicineGrid');
            
            let html = '';
            let itemIndex = 0;
            
            // First, add packages
            packages.forEach(packageName => {
                const packageInfo = PACKAGE_DATABASE[packageName];
                html += `
                    <div class="medicine-item package-item" style="background: #e8f5e9; border-left: 4px solid #27ae60; padding: 12px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${packageName}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}" style="font-weight: bold; color: #27ae60;">
                            üì¶ ${packageName}
                            <br><small style="color: #666; font-weight: normal;">
                                Package (${packageInfo.products.length} products) - DP: N$${packageInfo.price.dp} | CP: N$${packageInfo.price.cp} | BV: ${packageInfo.price.bv}
                                <br><span style="font-size: 0.75rem; color: #888;">Contains: ${packageInfo.products.map(p => `${p.name} (Qty: ${p.quantity})`).join(', ')}</span>
                            </small>
                        </label>
                </div>
                `;
                itemIndex++;
            });
            
            // Then, add individual products from PRICE_LIST
            PRICE_LIST.forEach(product => {
                html += `
                    <div class="medicine-item individual-item" style="padding: 10px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${product.description}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}">
                            ${product.description}
                            <br><small style="color: #666; font-size: 0.85rem;">
                                DP: N$${product.dp} | CP: N$${product.cp} | BV: ${product.bv}
                            </small>
                        </label>
                    </div>
                `;
                itemIndex++;
            });
            
            grid.innerHTML = html;
        };
        window.PACKAGE_DATABASE = PACKAGE_DATABASE;

        function handlePDF(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPDF = {
                        name: file.name,
                        data: e.target.result
                    };
                    document.getElementById('pdfStatus').textContent = `Ready: ${file.name}`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveReport() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push({ name: cb.value, dispensed: false });
            });
            
            if (selectedMeds.length === 0) {
                alert('Please select at least one medicine!');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === currentClientId);
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Check if we're editing an existing report
            const isEditing = window.editingReportId;
            const existingReport = isEditing ? reports.find(r => r.id === window.editingReportId) : null;
            
            // If editing, preserve dispensed status and payment info for existing medicines
            let finalMedicines = selectedMeds;
            if (isEditing && existingReport && existingReport.medicines) {
                finalMedicines = selectedMeds.map(newMed => {
                    const existingMed = existingReport.medicines.find(m => m.name === newMed.name);
                    if (existingMed) {
                        // Preserve dispensed and payment status
                        return {
                            name: newMed.name,
                            dispensed: existingMed.dispensed || false,
                            paid: existingMed.paid || false,
                            dispensedBy: existingMed.dispensedBy,
                            dispensedAt: existingMed.dispensedAt,
                            paidBy: existingMed.paidBy,
                            paidAt: existingMed.paidAt
                        };
                    }
                    return newMed;
                });
            }
            
            const report = {
                id: isEditing ? window.editingReportId : 'RPT' + Date.now(),
                clientId: currentClientId,
                clientInfo: {
                    fullName: client.fullName,
                    phone: client.phone,
                    email: client.email,
                    nbNumber: client.nbNumber
                },
                consultant: currentUser.fullName,
                consultantInfo: {
                    fullName: currentUser.fullName,
                    email: currentUser.email,
                    phone: currentUser.phone
                },
                notes: document.getElementById('consultantNotes').value,
                prescription: finalMedicines.map(med => med.name).join(', '),
                medicines: finalMedicines,
                symptoms: selectedSymptoms,
                followUpDate: document.getElementById('followUpDate').value,
                followUpNotes: document.getElementById('followUpNotes').value,
                pdf: uploadedPDF,
                timestamp: isEditing ? (existingReport.timestamp || new Date().toISOString()) : new Date().toISOString(),
                createdAt: isEditing ? (existingReport.createdAt || existingReport.timestamp || new Date().toISOString()) : new Date().toISOString(),
                lastModified: isEditing ? new Date().toISOString() : undefined,
                dispensed: isEditing ? existingReport.dispensed : false
            };
            
            // Validate and update pricing for the report
            const validatedReport = validateReportPricing(report);
            
            try {
                // STEP 1: Save to backend database FIRST
                // Use PUT for editing, POST for new reports
                const method = isEditing ? 'PUT' : 'POST';
                console.log(`üíæ Saving report to backend database (${method})...`);
                const result = await apiRequest('/reports', method, validatedReport);
                
                // STEP 2: Only proceed if backend save was successful
                if (!result.success) {
                    const errorMsg = result?.message || result?.error || 'Unknown error';
                    console.error('‚ùå Backend save failed:', errorMsg);
                    alert('‚ùå Error saving report to database: ' + errorMsg + '\n\nPlease try again or contact support.');
                    return; // Stop here - don't add to local arrays or trigger updates
                }
                
                console.log('‚úÖ Report saved to backend database successfully');
                
                // STEP 3: Now make it available to all users (add to local arrays and trigger real-time updates)
                    if (isEditing) {
                    // Update existing report in local array only after successful backend save
                        const index = reports.findIndex(r => r.id === validatedReport.id);
                        if (index !== -1) {
                            reports[index] = validatedReport;
                        }
                        alert('‚úÖ Report updated successfully! ID: ' + validatedReport.id);
                    } else {
                    // Add new report to local array only after successful backend save
                        reports.push(validatedReport);
                        alert('‚úÖ Report created successfully! ID: ' + validatedReport.id);
                    }
                    
                    // Clear editing flag
                    window.editingReportId = null;
                    
            closeModal('reportModal');
            document.getElementById('consultantNotes').value = '';
                    document.getElementById('followUpDate').value = '';
                    document.getElementById('followUpNotes').value = '';
            uploadedPDF = null;
            document.getElementById('pdfStatus').textContent = '';
                    
                    // Clear medicine selections
                    document.querySelectorAll('#medicineGrid input:checked').forEach(cb => cb.checked = false);
                    
                    // Persist to localStorage as cache/backup (backend is source of truth)
                    try { 
                        localStorage.setItem('dyna_reports', JSON.stringify(reports));
                        console.log(`‚úÖ Report cached to localStorage: ${validatedReport.id} for client ${validatedReport.clientId}`);
                    } catch(storageError) {
                        console.error('‚ùå Error caching report to localStorage:', storageError);
                    }
                    
                    // STEP 4: Notify all users via real-time updates (only after successful backend save)
                    try { 
                        window.dispatchEvent(new CustomEvent('reports:updated', { 
                            detail: { id: validatedReport.id, action: isEditing ? 'updated' : 'created', report: validatedReport, ts: Date.now() } 
                        })); 
                    } catch(_) {}
                    
                    // Global notify via API (best-effort)
                    try { 
                        fetch('/api/realtime_publish', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ 
                                channel: 'reports', 
                                event: { 
                                    id: validatedReport.id, 
                                    action: isEditing ? 'updated' : 'created', 
                                    ts: Date.now(),
                                    data: validatedReport
                                } 
                            }) 
                        }); 
                    } catch(_) {}
                    try {
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    event: { 
                                        id: validatedReport.id, 
                                        action: isEditing ? 'updated' : 'created', 
                                        ts: Date.now(),
                                        data: validatedReport
                                    } 
                                })
                            });
                        }
                    } catch(_) {}
                    
                    // Refresh consultant and dispenser views
                    await refreshConsultantData();
                    try { if (typeof displayPrescriptions === 'function') await displayPrescriptions(); } catch(_) {}
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Error saving report. Please try again.');
            }
        }

        function updateFollowUpDisplay() {
            const followUpDate = document.getElementById('followUpDate').value;
            const displayElement = document.getElementById('followUpDateDisplay');
            if (followUpDate) {
                const date = new Date(followUpDate);
                displayElement.textContent = date.toLocaleDateString('en-GB');
            } else {
                displayElement.textContent = '________________';
            }
        }

        // Add event listener for follow-up date changes when modal opens
        function setupFollowUpListener() {
            const followUpDateInput = document.getElementById('followUpDate');
            if (followUpDateInput) {
                followUpDateInput.addEventListener('change', updateFollowUpDisplay);
            }
        }

        // Generate Logo SVG - Reusable function for all documents
        function generateLogoSVG(width = 200, height = 120) {
            const viewBoxWidth = 400;
            const viewBoxHeight = 220;
            const scaleX = width / viewBoxWidth;
            const scaleY = height / viewBoxHeight;
            
            return `
                <svg width="${width}" height="${height}" viewBox="0 0 ${viewBoxWidth} ${viewBoxHeight}" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: 0 auto;">
                    <!-- Red Arc with Text -->
                    <path d="M 40 40 Q 200 20 360 40" fill="none" stroke="#c41e3a" stroke-width="4" stroke-linecap="round"/>
                    <text x="200" y="40" text-anchor="middle" fill="#c41e3a" font-size="14" font-weight="bold" font-family="Arial, sans-serif">HEALTH | WEALTH | FREEDOM</text>
                    
                    <!-- Central Geometric Design - Abstract structure with depth -->
                    <g transform="translate(200, 110)">
                        <!-- Left pillar/structure -->
                        <path d="M -60 30 L -50 -20 L -40 30 L -40 40 L -60 40 Z" fill="#c41e3a" opacity="0.9"/>
                        <path d="M -50 -20 L -35 -25 L -25 30 L -40 30 Z" fill="#c41e3a" opacity="0.7"/>
                        <path d="M -35 -25 L -20 -20 L -15 30 L -25 30 Z" fill="#c41e3a" opacity="0.5"/>
                        
                        <!-- Right pillar/structure (mirrored) -->
                        <path d="M 60 30 L 50 -20 L 40 30 L 40 40 L 60 40 Z" fill="#c41e3a" opacity="0.9"/>
                        <path d="M 50 -20 L 35 -25 L 25 30 L 40 30 Z" fill="#c41e3a" opacity="0.7"/>
                        <path d="M 35 -25 L 20 -20 L 15 30 L 25 30 Z" fill="#c41e3a" opacity="0.5"/>
                        
                        <!-- Central connecting elements -->
                        <rect x="-25" y="25" width="50" height="8" fill="#c41e3a" opacity="0.8"/>
                        <rect x="-15" y="15" width="30" height="6" fill="#c41e3a" opacity="0.6"/>
                    </g>
                    
                    <!-- Company Name -->
                    <text x="200" y="170" text-anchor="middle" fill="#c41e3a" font-size="32" font-weight="bold" font-family="Georgia, serif">DYNAPHARM</text>
                    <text x="200" y="195" text-anchor="middle" fill="#c41e3a" font-size="20" font-weight="bold" font-family="Arial, sans-serif">NAMIBIA</text>
                </svg>
            `;
        }

        function printReport() {
            const client = clients.find(c => c.referenceNumber === currentClientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Get consultant notes and follow-up
            const consultantNotes = document.getElementById('consultantNotes').value;
            const followUpDate = document.getElementById('followUpDate').value;
            const followUpNotes = document.getElementById('followUpNotes').value;
            
            // Get branch name and address
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            const branchAddress = branches.find(b => b.id === client.branch)?.address || 'Namibia';
            
            // Create professional print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Summary Analytic Report Card - ${client.fullName}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 9pt;
                            line-height: 1.3;
                            color: #333;
                            padding: 12mm 15mm;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 12px 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 12px;
                        }
                        
                        .header h1 {
                            font-size: 18pt;
                            margin-bottom: 5px;
                            font-weight: 900;
                            letter-spacing: 1px;
                        }
                        
                        .header .subtitle {
                            font-size: 12pt;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .header .branch-info {
                            font-size: 10pt;
                            margin: 2px 0;
                            opacity: 0.95;
                        }
                        
                        .header .report-date {
                            font-size: 9pt;
                            margin-top: 8px;
                            opacity: 0.9;
                        }
                        
                        .section {
                            margin-bottom: 8px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .section.allow-break {
                            page-break-inside: auto;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 6px 12px;
                            font-size: 11pt;
                            font-weight: bold;
                            border-radius: 4px;
                            margin-bottom: 6px;
                            text-align: center;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 6px 15px;
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 9pt;
                            line-height: 1.3;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 80px;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item {
                            background: #e3f2fd;
                            padding: 6px 10px;
                            border-radius: 4px;
                            margin-bottom: 5px;
                            border-left: 4px solid #2196f3;
                            font-size: 9pt;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .symptom-item strong {
                            color: #1976d2;
                            display: inline;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item p {
                            color: #555;
                            line-height: 1.4;
                            display: inline;
                            margin-left: 8px;
                        }
                        
                        .recommendation-item {
                            background: white;
                            padding: 5px 8px;
                            border-radius: 3px;
                            border-left: 3px solid #4caf50;
                            margin-bottom: 6px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .medicine-list {
                            background: #e8f5e9;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #27ae60;
                        }
                        
                        .medicine-list ul {
                            list-style: none;
                            padding: 0;
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 4px;
                        }
                        
                        .medicine-list li {
                            padding: 4px 8px;
                            background: white;
                            border-radius: 3px;
                            font-size: 9pt;
                            border-left: 3px solid #27ae60;
                            line-height: 1.3;
                            font-weight: 500;
                        }
                        
                        .notes-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #ffc107;
                            font-size: 9pt;
                            line-height: 1.4;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .footer {
                            margin-top: 12px;
                            padding-top: 10px;
                            border-top: 3px solid #c41e3a;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            page-break-inside: avoid;
                        }
                        
                        .signature-box {
                            text-align: center;
                            font-size: 9pt;
                        }
                        
                        .signature-line {
                            border-bottom: 2px solid #333;
                            margin: 25px 0 6px 0;
                        }
                        
                        .signature-box strong {
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #2196f3;
                            font-size: 9pt;
                        }
                        
                        .follow-up-box strong {
                            color: #1976d2;
                            display: block;
                            margin-bottom: 5px;
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box p {
                            margin: 3px 0;
                            line-height: 1.4;
                        }
                        
                        .summary-footer {
                            text-align: center;
                            margin-top: 15px;
                            padding: 12px;
                            background: #f0f0f0;
                            border-radius: 6px;
                            border: 2px solid #c41e3a;
                            font-size: 9pt;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        .page-limit-warning {
                            text-align: center;
                            margin-top: 10px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            font-size: 8pt;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                            
                            .page-limit-warning {
                                page-break-before: avoid;
                            }
                            
                            .section.allow-break {
                                page-break-inside: auto;
                            }
                            
                            .recommendation-item {
                                page-break-inside: avoid;
                                orphans: 2;
                                widows: 2;
                            }
                            
                            h1, h2, h3, h4, .section-title {
                                page-break-after: avoid;
                                orphans: 3;
                                widows: 3;
                            }
                            
                            * {
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        ${generateLogoSVG(180, 110)}
                    </div>
                    
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <div class="subtitle">SUMMARY ANALYTIC REPORT CARD</div>
                        <div class="branch-info">${branchName}</div>
                        <div class="branch-info">${branchAddress}</div>
                        <div class="report-date">Report Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="section">
                        <div class="section-title">üìã CLIENT INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${client.fullName}</div>
                            <div class="info-item"><strong>Reference:</strong> ${client.referenceNumber}</div>
                            <div class="info-item"><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div class="info-item"><strong>Age:</strong> ${client.age || 'N/A'} years</div>
                            <div class="info-item"><strong>Gender:</strong> ${client.gender}</div>
                            <div class="info-item"><strong>Phone:</strong> ${client.phone}</div>
                            <div class="info-item"><strong>Height:</strong> ${client.height}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${client.weight}kg</div>
                            <div class="info-item"><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${client.memberId || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${client.referralName || 'N/A'}</div>
                                <div class="info-item"><strong>Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Symptoms & Recommendations -->
                    ${selectedSymptoms.length > 0 ? `
                    <div class="section">
                        <div class="section-title">ü©∫ SUB-HEALTH TRENDS</div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 2px solid #2196f3; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.map(item => `
                                <div style="margin-bottom: 5px; padding: 3px 6px; background: white; border-radius: 3px; border-left: 3px solid #2196f3; display: inline-block; margin-right: 5px;">
                                    <strong>${item.symptom}</strong> (${item.system})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Lifestyle Recommendations -->
                    <div class="section allow-break">
                        <div class="section-title">üåø LIFESTYLE RECOMMENDATIONS</div>
                        <div style="background: #f0f8f0; padding: 10px; border-radius: 4px; border: 2px solid #4caf50; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.length > 0 ? `
                                ${selectedSymptoms.map(item => `
                                    <div class="recommendation-item">
                                        <strong style="color: #2e7d32;">‚úì ${item.symptom}:</strong>
                                        <span style="color: #555;">${item.recommendation}</span>
                                    </div>
                                `).join('')}
                            ` : `
                                <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                    <p>üìã <strong>No specific symptoms selected</strong></p>
                                    <p style="font-size: 8pt; margin-top: 5px;">To view personalized lifestyle recommendations, please select symptoms from the body systems above before printing this report.</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Prescribed Products -->
                    ${selectedMeds.length > 0 ? `
                    <div class="section">
                        <div class="section-title">üíä PRESCRIBED PRODUCTS</div>
                        <div class="medicine-list">
                            <ul>
                                ${selectedMeds.map(med => `<li>‚úì ${med}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Consultant Notes -->
                    ${consultantNotes.trim() ? `
                    <div class="section">
                        <div class="section-title">üìù CONSULTANT'S DIAGNOSIS & NOTES</div>
                        <div class="notes-box">${consultantNotes}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Follow-up & Signature -->
                    <div class="footer">
                        <div>
                            ${followUpDate ? `
                            <div class="follow-up-box">
                                <strong>üìÖ FOLLOW-UP APPOINTMENT</strong>
                                <p><strong>Date:</strong> ${new Date(followUpDate).toLocaleDateString('en-GB')}</p>
                                ${followUpNotes ? `<p><strong>Notes:</strong> ${followUpNotes}</p>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <strong>${currentUser.fullName}</strong>
                            <p>Certified Consultant</p>
                            <p style="font-size: 8pt;">Tel: ${currentUser.phone || '061-300877'}</p>
                            <p style="font-size: 8pt;">Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
                        </div>
                    </div>
                    
                    <!-- Summary Report Card Disclaimer -->
                    <div class="summary-footer">
                        <p>üìã THIS IS A SUMMARY REPORT CARD</p>
                        <p>For detailed analysis and comprehensive information, please refer to the complete Analysis Report Card</p>
                    </div>
                    
                    <!-- Dynapharm Motto -->
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 2px solid #c41e3a;">
                        <div style="font-size: 12pt; color: #c41e3a; font-weight: bold; letter-spacing: 1px;">
                            HEALTH | WEALTH | FREEDOM
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function updatePrescriptionDisplay() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Update the prescription display
            const prescriptionDisplay = document.getElementById('prescriptionDisplay');
            if (prescriptionDisplay) {
                if (selectedMeds.length > 0) {
                    prescriptionDisplay.innerHTML = `
                        <div class="selected-medicines">
                            <h4>Prescribed Medicines:</h4>
                            <ul>
                                ${selectedMeds.map(med => `<li>${med}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    prescriptionDisplay.innerHTML = '<p>No medicines selected</p>';
                }
            }
        }

        function updateNotesDisplay() {
            const notes = document.getElementById('consultantNotes').value;
            const notesDisplay = document.getElementById('notesDisplay');
            if (notesDisplay) {
                if (notes.trim()) {
                    notesDisplay.innerHTML = `
                        <div class="notes-preview">
                            <h4>Diagnosis & Treatment Notes:</h4>
                            <div class="notes-content">${notes}</div>
                        </div>
                    `;
                } else {
                    notesDisplay.innerHTML = '';
                }
            }
        }

        // Autosave functionality
        let autosaveInterval;
        let autosaveTimeout;
        
        function startAutosave() {
            // Clear any existing autosave
            clearInterval(autosaveInterval);
            
            // Autosave every 30 seconds
            autosaveInterval = setInterval(() => {
                autosaveDraft();
            }, 30000);
        }
        
        function stopAutosave() {
            clearInterval(autosaveInterval);
        }
        
        function autosaveDraft() {
            if (!currentClientId) return;
            
            const reportData = {
                clientId: currentClientId,
                consultant: currentUser.fullName,
                consultantNotes: document.getElementById('consultantNotes')?.value || '',
                followUpDate: document.getElementById('followUpDate')?.value || '',
                followUpNotes: document.getElementById('followUpNotes')?.value || '',
                timestamp: new Date().toISOString(),
                status: 'draft'
            };
            
            // Save to localStorage as draft
            const drafts = JSON.parse(localStorage.getItem('consultant_drafts') || '[]');
            const existingIndex = drafts.findIndex(d => d.clientId === currentClientId);
            
            if (existingIndex >= 0) {
                drafts[existingIndex] = reportData;
            } else {
                drafts.push(reportData);
            }
            
            localStorage.setItem('consultant_drafts', JSON.stringify(drafts));
            
            // Show autosave indicator
            const status = document.getElementById('autosaveStatus');
            const time = document.getElementById('autosaveTime');
            if (status && time) {
                time.textContent = new Date().toLocaleTimeString();
                status.style.display = 'block';
                
                // Hide after 5 seconds
                clearTimeout(autosaveTimeout);
                autosaveTimeout = setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Template functions
        function openReportTemplateSelector() {
            displayReportTemplates();
            document.getElementById('reportTemplateModal').style.display = 'block';
        }
        
        function displayReportTemplates() {
            const templates = [
                {
                    name: 'General Consultation',
                    icon: 'ü©∫',
                    description: 'Basic consultation template',
                    data: {
                        notes: 'Patient presents for general consultation.\n\nAssessment: General health evaluation.\n\nPlan: Continue healthy lifestyle, regular follow-up as needed.'
                    }
                },
                {
                    name: 'Respiratory Issues',
                    icon: 'ü´Å',
                    description: 'Cough, cold, asthma',
                    data: {
                        notes: 'Patient presents with respiratory concerns.\n\nAssessment: Respiratory symptoms noted.\n\nPlan: Rest, hydration, monitor symptoms. Follow-up if symptoms persist.'
                    }
                },
                {
                    name: 'Digestive Health',
                    icon: 'üíä',
                    description: 'Stomach, digestion issues',
                    data: {
                        notes: 'Patient presents with digestive concerns.\n\nAssessment: Digestive symptoms evaluated.\n\nPlan: Dietary modifications, hydration. Follow-up as needed.'
                    }
                },
                {
                    name: 'Pain Management',
                    icon: 'ü§ï',
                    description: 'Headache, body pain',
                    data: {
                        notes: 'Patient presents with pain concerns.\n\nAssessment: Pain symptoms assessed.\n\nPlan: Pain management, rest, monitoring. Review progress.'
                    }
                },
                {
                    name: 'Wellness Check',
                    icon: '‚ú®',
                    description: 'General wellness, vitamins',
                    data: {
                        notes: 'Patient presents for wellness consultation.\n\nAssessment: General wellness evaluation.\n\nPlan: Continue health maintenance, consider supplementation if needed.'
                    }
                }
            ];
            
            const list = document.getElementById('templateList');
            list.innerHTML = templates.map(t => `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #ddd; cursor: pointer;" onclick="applyTemplate('${t.name}')">
                    <div style="font-size: 3rem; margin-bottom: 10px;">${t.icon}</div>
                    <h4 style="color: #2c3e50; margin-bottom: 5px;">${t.name}</h4>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">${t.description}</p>
                </div>
            `).join('');
        }
        
        function applyTemplate(templateName) {
            const templates = {
                'General Consultation': { notes: 'Patient presents for general consultation.\n\nAssessment: General health evaluation.\n\nPlan: Continue healthy lifestyle, regular follow-up as needed.' },
                'Respiratory Issues': { notes: 'Patient presents with respiratory concerns.\n\nAssessment: Respiratory symptoms noted.\n\nPlan: Rest, hydration, monitor symptoms. Follow-up if symptoms persist.' },
                'Digestive Health': { notes: 'Patient presents with digestive concerns.\n\nAssessment: Digestive symptoms evaluated.\n\nPlan: Dietary modifications, hydration. Follow-up as needed.' },
                'Pain Management': { notes: 'Patient presents with pain concerns.\n\nAssessment: Pain symptoms assessed.\n\nPlan: Pain management, rest, monitoring. Review progress.' },
                'Wellness Check': { notes: 'Patient presents for wellness consultation.\n\nAssessment: General wellness evaluation.\n\nPlan: Continue health maintenance, consider supplementation if needed.' }
            };
            
            const template = templates[templateName];
            if (template) {
                const notesField = document.getElementById('consultantNotes');
                if (notesField) {
                    notesField.value = template.notes;
                    updateNotesDisplay();
                }
            }
            
            closeModal('reportTemplateModal');
        }

        // Finalize and e-sign
        function finalizeReport() {
            if (!currentClientId) {
                alert('Please select a client first');
                return;
            }
            
            const consultantNotes = document.getElementById('consultantNotes')?.value.trim();
            if (!consultantNotes) {
                alert('Please add diagnosis and treatment notes before finalizing');
                return;
            }
            
            if (confirm('Are you sure you want to finalize and e-sign this report? This action cannot be undone.')) {
                // Mark as finalized with e-signature
                const report = reports.find(r => r.clientId === currentClientId);
                if (report) {
                    report.status = 'finalized';
                    report.finalizedDate = new Date().toISOString();
                    report.eSignedBy = currentUser.fullName;
                    report.eSignedDate = new Date().toISOString();
                    
                    saveData();
                    alert('Report finalized and e-signed successfully!');
                    closeModal('reportModal');
                    stopAutosave();
                }
            }
        }

        // PDF Export
        function exportReportPDF() {
            printReport(); // Reuse print functionality
        }

        // Show drafts
        function showMyDrafts() {
            const drafts = JSON.parse(localStorage.getItem('consultant_drafts') || '[]');
            if (drafts.length === 0) {
                alert('No draft reports found');
                return;
            }
            
            let list = 'Available Drafts:\n\n';
            drafts.forEach((draft, idx) => {
                const client = clients.find(c => c.referenceNumber === draft.clientId);
                list += `${idx + 1}. ${client ? client.fullName : draft.clientId} (${new Date(draft.timestamp).toLocaleDateString()})\n`;
            });
            
            const selection = prompt(list + '\nEnter draft number to open:');
            if (selection) {
                const idx = parseInt(selection) - 1;
                if (idx >= 0 && idx < drafts.length) {
                    const draft = drafts[idx];
                    createReport(draft.clientId);
                    
                    // Restore draft data after a short delay
                    setTimeout(() => {
                        const notesField = document.getElementById('consultantNotes');
                        const followUpDateField = document.getElementById('followUpDate');
                        const followUpNotesField = document.getElementById('followUpNotes');
                        
                        if (notesField) notesField.value = draft.consultantNotes;
                        if (followUpDateField) followUpDateField.value = draft.followUpDate;
                        if (followUpNotesField) followUpNotesField.value = draft.followUpNotes;
                        
                        updateNotesDisplay();
                    }, 500);
                }
            }
        }

        // Show today's appointments
        function showTodaysAppointments() {
            const today = new Date().toISOString().split('T')[0];
            const todaysAppts = appointments.filter(a => 
                a.consultant === currentUser.fullName && 
                a.date === today &&
                a.status !== 'cancelled'
            );
            
            if (todaysAppts.length === 0) {
                alert('No appointments scheduled for today');
                return;
            }
            
            // Scroll to appointments section and filter
            const followUpSearch = document.getElementById('followUpSearch');
            if (followUpSearch) {
                followUpSearch.value = today;
                filterFollowUps();
                
                // Scroll to appointments
                followUpSearch.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function displayPrescriptions() {
            // Refresh data from API and localStorage to ensure fresh data
            await loadData();
            
            // Verify clients are loaded
            if (!clients || clients.length === 0) {
                console.warn('‚ö†Ô∏è No clients found when displaying prescriptions. Reloading...');
                try {
                    const clientsData = localStorage.getItem('dyna_clients');
                    if (clientsData) {
                        clients = JSON.parse(clientsData);
                        console.log(`‚úÖ Loaded ${clients.length} clients from localStorage for prescriptions`);
                    }
                } catch(error) {
                    console.error('‚ùå Error loading clients for prescriptions:', error);
                }
            }
            
            // Verify reports are loaded
            if (!reports || reports.length === 0) {
                console.warn('‚ö†Ô∏è No reports found when displaying prescriptions. Reloading...');
                try {
                    const reportsData = localStorage.getItem('dyna_reports');
                    if (reportsData) {
                        reports = JSON.parse(reportsData);
                        console.log(`‚úÖ Loaded ${reports.length} reports from localStorage for prescriptions`);
                    }
                } catch(error) {
                    console.error('‚ùå Error loading reports for prescriptions:', error);
                }
            }
            
            // Populate branch filter dropdown dynamically
            const branchFilterSelect = document.getElementById('rxBranchFilter');
            if (branchFilterSelect && branchFilterSelect.options.length <= 1) {
                branchFilterSelect.innerHTML = '<option value="">All Branches</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name || branch.id;
                    branchFilterSelect.appendChild(option);
                });
            }
            
            // Get branch filter value
            const branchFilter = branchFilterSelect?.value || '';
            
            const list = document.getElementById('prescriptionList');
            // Filter only actual reports (with id field) that have prescriptions
    let pendingReports = reports.filter(r => r.id && r.prescription && r.medicines);
    
    // Filter by branch if selected
    if (branchFilter) {
        pendingReports = pendingReports.filter(report => {
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (!client) return false;
            const clientBranch = client.branch;
            // Match by branch ID or name
            return clientBranch === branchFilter || 
                   branches.find(b => (b.id === branchFilter || b.name === branchFilter) && 
                                    (b.id === clientBranch || b.name === clientBranch));
        });
    }

    // Apply status/date filters if present
    try {
        const statusSel = document.getElementById('rxStatusFilter');
        const fromEl = document.getElementById('rxFromDate');
        const toEl = document.getElementById('rxToDate');
        const status = statusSel ? statusSel.value : 'all';
        const fromDate = fromEl && fromEl.value ? new Date(fromEl.value + 'T00:00:00') : null;
        const toDate = toEl && toEl.value ? new Date(toEl.value + 'T23:59:59') : null;

        if (fromDate || toDate) {
            pendingReports = pendingReports.filter(r => {
                const t = r.timestamp ? new Date(r.timestamp) : null;
                if (!t) return true;
                if (fromDate && t < fromDate) return false;
                if (toDate && t > toDate) return false;
                return true;
            });
        }

        // By default, hide fully dispensed prescriptions to keep display clean
        // Only show them if explicitly filtered
        if (status && status !== 'all') {
            pendingReports = pendingReports.filter(r => {
                const meds = Array.isArray(r.medicines) ? r.medicines : [];
                if (status === 'pending') return meds.some(m => !m.dispensed);
                if (status === 'dispensed') return meds.length > 0 && meds.every(m => m.dispensed);
                if (status === 'paid') return meds.filter(m => m.dispensed).every(m => m.paid);
                if (status === 'outstanding') return meds.some(m => m.dispensed && !m.paid);
                return true;
            });
        } else {
            // Default: only show prescriptions with at least one pending item (not fully dispensed)
            pendingReports = pendingReports.filter(r => {
                const meds = Array.isArray(r.medicines) ? r.medicines : [];
                return meds.some(m => !m.dispensed); // Show only if there's at least one pending item
            });
        }
    } catch(_){ /* ignore filter errors */ }
            
    // Sort by latest first (prefer lastModified then timestamp) - newest prescriptions appear first
    pendingReports.sort((a, b) => {
        const dateA = new Date(a.lastModified || a.timestamp || 0);
        const dateB = new Date(b.lastModified || b.timestamp || 0);
        return dateB - dateA; // Latest first
    });

    if (pendingReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üíä No prescriptions to dispense</h3><p>Prescriptions will appear here once consultants create reports.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            pendingReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                
                // Calculate medicine status
                const pending = report.medicines ? report.medicines.filter(m => !m.dispensed).length : 0;                                                       
                const dispensed = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;                                                      
                const total = report.medicines ? report.medicines.length : 0;
                
                // Calculate totals and membership status outside IIFE for use in buttons section                                                               
                const clientMembershipStatus = client ? client.membershipStatus : 'referred';                                                                   
                // Ensure totals is always defined, even if medicines array is empty or undefined
                const totals = (report.medicines && report.medicines.length > 0) 
                    ? calculatePrescriptionTotals(report.medicines, clientMembershipStatus)                                                                     
                    : { total: { dp: 0, cp: 0, bv: 0 }, dispensed: { dp: 0, cp: 0, bv: 0 }, paid: { dp: 0, cp: 0, bv: 0 }, outstanding: { dp: 0, cp: 0, bv: 0 }, pending: { dp: 0, cp: 0, bv: 0 } };
                
                                card.innerHTML = `
                    <div style="background: linear-gradient(135deg, #c41e3a 0%, #a0172e 100%); padding: 16px; border-radius: 8px 8px 0 0; color: white; margin: -15px -15px 15px -15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px;">PRESCRIPTION</div>
                                <h4 style="color: white; margin: 0; font-size: 1.3rem; font-weight: 700;">${report.id}</h4>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${pending > 0 ? 'rgba(255,255,255,0.25)' : 'rgba(255,255,255,0.3)'}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; backdrop-filter: blur(10px);">
                                    ${pending} pending${dispensed > 0 ? ` ‚Ä¢ ${dispensed} dispensed` : ''}
                                </span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px;">${client ? client.fullName : 'Unknown Client'}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">${report.clientId}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">               
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üë®‚Äç‚öïÔ∏è</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Consultant</div>
                                <div style="font-weight: 600; color: #2c3e50;">${report.consultant}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üìÖ</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Date</div>
                                <div style="font-weight: 600; color: #2c3e50;">${new Date(report.timestamp).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üìû</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Phone</div>
                                <div style="font-weight: 600; color: #2c3e50;">${client ? client.phone : 'N/A'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üè¢</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Branch</div>
                                <div style="font-weight: 600; color: #2c3e50;">${client ? client.branch : 'Unknown'}</div>
                            </div>
                        </div>
                        ${client ? (client.membershipStatus === 'member' ? `
                            <p><strong>üÜî NB Number:</strong> ${client.nbNumber || 'N/A'}</p>
                            <p><strong>üë§ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>üë§ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>üÜî Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `) : ''}
                    </div>
                    ${report.medicines && report.medicines.length > 0 ? (() => {
                        const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
                        return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #c41e3a;">
                        <!-- Consultation Fee -->
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 2px solid #2196f3;">
                            <p style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">üë®‚Äç‚öïÔ∏è CONSULTATION FEE</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Consultant Medical Examination</span>
                                <span style="font-weight: bold; color: #1976d2; font-size: 1.1rem;">
                                    ${clientMembershipStatus === 'member' ? `N$${consultationFee} (DP)` : `N$${consultationFee} (CP)`}
                                </span>
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${clientMembershipStatus === 'member' ? '‚úì Member Rate: N$150' : '‚úì Client Rate: N$200'}
                            </p>
                        </div>
                        
                        <p><strong>üíä Prescription Medicines:</strong></p>
                        <div style="margin-top: 10px;">
                            ${report.medicines.map((med, i) => {
                                const price = findProductPrice(med.name);
                                const isPackage = price.isPackage;
                                
                                // Calculate pricing based on package status
                                let effectivePrice;
                                let packageInfo = null;
                                
                                if (isPackage) {
                                    // Initialize packageStatus if it doesn't exist for existing reports
                                    if (!med.packageStatus) {
                                        med.packageStatus = {};
                                        // Update the report in backend to persist the change
                                        updateReportInBackend(report);
                                    }
                                    
                                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                    if (clientMembershipStatus === 'member') {
                                        effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                    } else {
                                        effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                    }
                                    packageInfo = packagePricing;
                                } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                    }
                                }
                                
                                return `
                                <div style="padding: 12px; margin: 8px 0; background: ${med.dispensed ? '#e8f5e9' : '#fff3cd'}; border-radius: 5px; border-left: 4px solid ${med.dispensed ? '#27ae60' : '#f39c12'};">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="disp_${report.id}_${i}" ${med.dispensed ? 'checked' : ''}
                                            onchange="toggleDispense('${report.id}', ${i})" style="margin-right: 8px;">
                                        <label for="disp_${report.id}_${i}" style="font-weight: 600; flex: 1; font-size: 1.05rem;">
                                            ${med.name} ${med.dispensed ? '‚úÖ Dispensed' : '‚è≥ Pending'}
                                            ${isPackage ? ' üì¶' : ''}
                                        </label>
                                    </div>
                                    
                                    ${isPackage ? `
                                    <div style="background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #b3d9ff;">
                                        <p style="font-weight: 600; color: #1976d2; margin-bottom: 8px; font-size: 0.9rem;">üì¶ Package Contents:</p>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px;">
                                            ${(() => {
                                                const packageData = PACKAGE_DATABASE[med.name];
                                                if (!packageData || !packageData.products) {
                                                    return `<div style="padding: 10px; background: #ffebee; border-radius: 3px; color: #c62828; font-size: 0.8rem;">
                                                        ‚ö†Ô∏è Package data not found. Click "Update Pricing" to refresh.
                                                    </div>`;
                                                }
                                                return packageData.products.map((product, pIndex) => {
                                                    const productStatus = med.packageStatus && med.packageStatus[product.name] ? med.packageStatus[product.name] : 'not_given';
                                                    const escapedProductName = product.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                    return `
                                                    <div style="background: white; padding: 8px; border-radius: 3px; border-left: 3px solid ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                                            <span style="font-weight: 500; flex: 1; font-size: 0.85rem;">${product.name}</span>
                                                            <span style="font-size: 0.75rem; color: ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                                ${productStatus === 'given' ? '‚úÖ' : '‚è≥'}
                                                            </span>
                                                        </div>
                                                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
                                                            Qty: ${product.quantity} | 
                                                            ${clientMembershipStatus === 'member' ? 
                                                                `DP: N$${product.dp} | BV: ${product.bv}` : 
                                                                `CP: N$${product.cp}`}
                                                        </div>
                                                        <select id="package_select_${report.id}_${i}_${pIndex}" 
                                                                onchange="updatePackageStatus('${report.id}', ${i}, '${escapedProductName}', this.value)"
                                                                data-product-name="${escapedProductName}"
                                                                style="width: 100%; padding: 2px 4px; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 3px;">
                                                            <option value="not_given" ${productStatus === 'not_given' ? 'selected' : ''}>Not Given</option>
                                                            <option value="given" ${productStatus === 'given' ? 'selected' : ''}>Given</option>
                                                            <option value="out_of_stock" ${productStatus === 'out_of_stock' ? 'selected' : ''}>Out of Stock</option>
                                                        </select>
                                                    </div>
                                                    `;
                                                }).join('');
                                            })()}
                                        </div>
                                        <div style="background: #e8f5e9; padding: 8px; border-radius: 3px; margin-top: 8px; border: 1px solid #27ae60;">
                                            <div style="font-size: 0.8rem; color: #27ae60; text-align: center;">
                                                <div style="margin-bottom: 4px;">
                                                    <strong>üì¶ Dispensed:</strong> ${packageInfo.dispensedCount}/${packageInfo.totalCount} items
                                                    ${clientMembershipStatus === 'member' ? 
                                                        ` | DP: N$${effectivePrice.dp} | BV: ${effectivePrice.bv}` : 
                                                        ` | CP: N$${effectivePrice.cp}`}
                                                </div>
                                                <div style="font-size: 0.75rem; color: #666;">
                                                    ${packageInfo.dispensedCount < packageInfo.totalCount ? 
                                                        `Remaining: ${packageInfo.totalCount - packageInfo.dispensedCount} items` : 
                                                        '‚úÖ All items dispensed'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ` : `
                                    <div style="font-size: 0.9rem; color: #666; margin-left: 24px;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <span style="margin-right: 15px;"><strong>DP:</strong> N$${effectivePrice.dp}</span>
                                            <span><strong>BV:</strong> ${effectivePrice.bv}</span>
                                        ` : `
                                            <span><strong>CP:</strong> N$${effectivePrice.cp}</span>
                                        `}
                                    </div>
                                    `}
                                    
                                    ${med.dispensed ? `
                                    <div style="margin-left: 24px; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="paid_${report.id}_${i}" ${med.paid ? 'checked' : ''}
                                                onchange="togglePayment('${report.id}', ${i})" style="margin-right: 8px;">
                                            <span style="font-size: 0.85rem; color: #27ae60; font-weight: 500;">üí∞ Payment Received</span>
                                        </label>
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Price Totals -->
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">                  
                            <h4 style="color: white; margin-bottom: 12px; text-align: center; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">üí∞ Prescription Summary</h4>                                
                            <p style="text-align: center; font-size: 0.85rem; color: rgba(255,255,255,0.9); margin-bottom: 18px;">    
                                Includes N$${consultationFee} consultation fee                                     
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">      
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">                                     
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Total</div>                       
                                    <div style="font-size: 1rem; font-weight: 700; color: #c41e3a;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.total.dp}</div>                     
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.total.bv}</div>                       
                                        ` : `                                 
                                            <div>N$${totals.total.cp}</div>                     
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #27ae60;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Dispensed</div>                   
                                    <div style="font-size: 1rem; font-weight: 700; color: #27ae60;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.dispensed.dp}</div>                 
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.dispensed.bv}</div>                   
                                        ` : `                                 
                                            <div>N$${totals.dispensed.cp}</div>                 
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #155724;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Paid</div>                        
                                    <div style="font-size: 1rem; font-weight: 700; color: #155724;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.paid.dp}</div>                      
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.paid.bv}</div>                        
                                        ` : `                                 
                                            <div>N$${totals.paid.cp}</div>                      
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Outstanding</div>                 
                                    <div style="font-size: 1rem; font-weight: 700; color: ${Number(totals.outstanding[clientMembershipStatus === 'member' ? 'dp' : 'cp']) > 0 ? '#f39c12' : '#27ae60'};">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.outstanding.dp}</div>               
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.outstanding.bv}</div>                 
                                        ` : `                                 
                                            <div>N$${totals.outstanding.cp}</div>               
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ff9800;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Pending</div>                     
                                    <div style="font-size: 1rem; font-weight: 700; color: #ff9800;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.pending.dp}</div>                   
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.pending.bv}</div>                     
                                        ` : `                                 
                                            <div>N$${totals.pending.cp}</div>                   
                                        `}                                    
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    })() : ''}
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üìù Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid #e0e0e0; margin-top: 15px;">                         
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">üëÅÔ∏è View Details</button>                              
                        <button class="btn btn-warning" onclick="printPrescription('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">üñ®Ô∏è Print Full</button>                                   
                        <button class="btn btn-success" onclick="printThermalReceipt('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">üßæ Thermal Receipt</button>                           
                        ${pending > 0 ? `<button class="btn" onclick="dispenseAll('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; background: #27ae60; color: white; transition: all 0.3s;">‚úÖ Mark All Dispensed</button>` : ''}                                           
                        ${(totals && totals.outstanding && totals.outstanding[clientMembershipStatus === 'member' ? 'dp' : 'cp'] > 0) ? `<button class="btn btn-primary" onclick="openPaymentModal('${report.id}')" style="min-width: 160px; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 1.05rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">üí≥ Collect Payment</button>` : ''}
                        <button class="btn" onclick="viewPrescriptionPaymentHistory('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">üìú Payment History</button>                            
                        <button class="btn btn-warning" onclick="reverseLastPrescriptionPayment('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">‚Ü©Ô∏è Reverse Payment</button>            
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Function to calculate package pricing based on dispensed items
        function calculatePackagePricing(medicine, clientMembershipStatus) {
            const packageData = PACKAGE_DATABASE[medicine.name];
            if (!packageData || !packageData.products) {
                // For existing reports with old package names, try to find a match
                const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                    key.toLowerCase().includes(medicine.name.toLowerCase()) || 
                    medicine.name.toLowerCase().includes(key.toLowerCase())
                );
                
                if (possibleMatch) {
                    console.log(`Found package match: "${medicine.name}" -> "${possibleMatch}"`);
                    const matchedPackage = PACKAGE_DATABASE[possibleMatch];
                    
                    // Initialize packageStatus for the matched package
                    if (!medicine.packageStatus) {
                        medicine.packageStatus = {};
                    }
                    
                    // Update the medicine name to the correct package name
                    medicine.name = possibleMatch;
                    
                    // Return pricing for the matched package
                    return {
                        dp: matchedPackage.price.dp,
                        cp: matchedPackage.price.cp,
                        bv: matchedPackage.price.bv,
                        dispensedCount: 0,
                        totalCount: matchedPackage.products.length,
                        packageTotal: matchedPackage.price
                    };
                }
                
                return { dp: 0, cp: 0, bv: 0, dispensedCount: 0, totalCount: 0 };
            }
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let dispensedCount = 0;
            const totalCount = packageData.products.length;
            
            packageData.products.forEach(product => {
                const productStatus = medicine.packageStatus && medicine.packageStatus[product.name] 
                    ? medicine.packageStatus[product.name] : 'not_given';
                
                if (productStatus === 'given') {
                    dispensedDP += product.dp;
                    dispensedCP += product.cp;
                    dispensedBV += product.bv;
                    dispensedCount++;
                }
            });
            
            return {
                dp: dispensedDP,
                cp: dispensedCP,
                bv: dispensedBV,
                dispensedCount,
                totalCount,
                packageTotal: packageData.price
            };
        }

        // Function to update package status for individual products
        function updatePackageStatus(reportId, medicineIndex, productName, status) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medicineIndex]) return;
            
            const medicine = report.medicines[medicineIndex];
            
            // Initialize packageStatus if it doesn't exist
            if (!medicine.packageStatus) {
                medicine.packageStatus = {};
            }
            
            // Update the specific product status
            medicine.packageStatus[productName] = status;
            
            // Update local reports array immediately
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex !== -1) {
                reports[reportIndex] = report;
            }
            
            // Update the report in the backend asynchronously
            updateReportInBackend(report);
            
            // Show status update feedback
            const statusEmoji = status === 'given' ? '‚úÖ' : status === 'out_of_stock' ? '‚ö†Ô∏è' : '‚è≥';
            const statusText = status === 'given' ? 'Given' : status === 'out_of_stock' ? 'Out of Stock' : 'Not Given';
            
            // Show brief feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                padding: 10px 15px; border-radius: 5px; z-index: 10000; font-size: 0.9rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            feedback.textContent = `${statusEmoji} ${productName}: ${statusText}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    document.body.removeChild(feedback);
                }
            }, 2000);
            
            // Refresh the display to show updated totals
            displayPrescriptions();
        }

        // Function to update report in backend
        async function updateReportInBackend(report) {
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    // Update local reports array
                    const index = reports.findIndex(r => r.id === report.id);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                } else {
                    console.error('Failed to update report:', result.message);
                }
            } catch (error) {
                console.error('Error updating report:', error);
            }
        }

        // Search functionality for dispenser portal
        function searchPrescriptions(portal) {
            const searchTerm = document.getElementById('dispenserSearch').value.toLowerCase();
            const list = document.getElementById('prescriptionList');
            const branchFilter = document.getElementById('rxBranchFilter')?.value || '';
            
            if (!searchTerm) {
                displayPrescriptions();
                return;
            }
            
            // First filter by branch if selected
            let pendingReports = reports.filter(r => r.id && r.prescription && r.medicines);
            if (branchFilter) {
                pendingReports = pendingReports.filter(report => {
                    const client = clients.find(c => c.referenceNumber === report.clientId);
                    if (!client) return false;
                    const clientBranch = client.branch;
                    return clientBranch === branchFilter || 
                           branches.find(b => (b.id === branchFilter || b.name === branchFilter) && 
                                            (b.id === clientBranch || b.name === clientBranch));
                });
            }
            
            // Then filter by search term
            let filteredReports = pendingReports.filter(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                return (
                    report.id.toLowerCase().includes(searchTerm) ||
                    (client && client.fullName.toLowerCase().includes(searchTerm)) ||
                    report.consultant.toLowerCase().includes(searchTerm) ||
                    report.prescription.toLowerCase().includes(searchTerm)
                );
            });
            // Latest first
            filteredReports.sort((a, b) => new Date(b.lastModified || b.timestamp) - new Date(a.lastModified || a.timestamp));
            
            if (filteredReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>üîç No prescriptions found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">Report ${report.id}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Client: ${client ? client.fullName : 'Unknown'}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: #fff3cd; color: #f39c12; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">Pending</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>üë®‚Äç‚öïÔ∏è Consultant:</strong> ${report.consultant}</p>
                        <p><strong>üìÖ Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                        <p><strong>üìû Client Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>üÜî Reference:</strong> ${report.clientId}</p>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
                        <p><strong>üíä Prescription:</strong></p>
                        <p style="margin-top: 8px; white-space: pre-wrap;">${report.prescription}</p>
                    </div>
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üìù Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="markDispensed('${report.id}')">‚úÖ Mark Dispensed</button>
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')">üëÅÔ∏è View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllPrescriptions(portal) {
            document.getElementById('dispenserSearch').value = '';
            displayPrescriptions();
        }

function clearRxFilters() {
    const b = document.getElementById('rxBranchFilter');
    const s = document.getElementById('rxStatusFilter');
    const f = document.getElementById('rxFromDate');
    const t = document.getElementById('rxToDate');
    if (b) b.value = '';
    if (s) s.value = 'all';
    if (f) f.value = '';
    if (t) t.value = '';
    displayPrescriptions();
}

// -----------------------
// Prescription Payment Modal Handlers
// -----------------------
let rxPaymentContext = null;

function rxFormat(n){ const v = Number(n||0); return 'N$ ' + v.toFixed(2); }

function openPaymentModal(reportId){
    if (!hasActionPermission('collect_payment')) { alert('You do not have permission to collect payments.'); return; }
    const modal = document.getElementById('rxPaymentModal');
    if (!modal) return;
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    const client = clients.find(c => c.referenceNumber === report.clientId);
    const memberStatus = client && client.membershipStatus ? client.membershipStatus : 'referred';
    const totals = calculatePrescriptionTotals(report.medicines||[], memberStatus);
    const consultation = memberStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
    const amountDue = memberStatus === 'member' ? Number(totals.outstanding.dp||0) : Number(totals.outstanding.cp||0);

    rxPaymentContext = { reportId, memberStatus, totals, consultation, amountDue };

        const summary = document.getElementById('paymentSummary');                
    if (summary){
        const totalVal = memberStatus === 'member' ? totals.total.dp : totals.total.cp;                              
        const dispVal = memberStatus === 'member' ? totals.dispensed.dp : totals.dispensed.cp;                       
        const paidVal = memberStatus === 'member' ? totals.paid.dp : totals.paid.cp;                                 
        const outVal = memberStatus === 'member' ? totals.outstanding.dp : totals.outstanding.cp;                    
        summary.innerHTML = `
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #c41e3a; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Total</div>          
                <div style="font-weight:700; color:#c41e3a; font-size:1.2rem;">${rxFormat(totalVal)}</div>                             
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #27ae60; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Dispensed</div>      
                <div style="font-weight:700; color:#27ae60; font-size:1.2rem;">${rxFormat(dispVal)}</div>                              
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #155724; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Paid</div>           
                <div style="font-weight:700; color:#155724; font-size:1.2rem;">${rxFormat(paidVal)}</div>                              
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #f39c12; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Outstanding</div>    
                <div style="font-weight:700; color:#f39c12; font-size:1.2rem;">${rxFormat(outVal)}</div>                               
            </div>`;
    }

    const consult = document.getElementById('paymentConsultation');
    if (consult) consult.textContent = rxFormat(consultation);

        const tenderRows = document.getElementById('tenderRows');                 
    if (tenderRows){
        tenderRows.innerHTML = '';
        const row = document.createElement('div');                            
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 150px 1fr';
        row.style.gap = '12px';
        row.style.marginBottom = '12px';
                row.innerHTML = `
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Payment Method</label>
                <select class="tender-method" onchange="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                 
                    <option value="Cash">üí∞ Cash</option>                            
                    <option value="Card">üí≥ Card</option>                            
                    <option value="Mobile Money">üì± Mobile Money</option>            
                    <option value="Bank Transfer">üè¶ Bank Transfer</option>          
                </select>
            </div>
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Reference</label>
                <input class="tender-ref" placeholder="Optional" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                         
            </div>
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Amount (N$)</label>
                <input class="tender-amount" type="number" min="0" step="0.01" value="${amountDue.toFixed(2)}" oninput="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; font-weight:600; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                               
            </div>
        `;
        tenderRows.appendChild(row);
    }

    const disc = document.getElementById('paymentDiscount');
    if (disc) disc.value = '0';
    recalcPaymentTotals();
    modal.style.display = 'flex';
}

function closePaymentModal(){
    const modal = document.getElementById('rxPaymentModal');
    if (modal) modal.style.display = 'none';
    rxPaymentContext = null;
}

function addTenderRow(){
    const tenderRows = document.getElementById('tenderRows');                 
    if (!tenderRows) return;
    const row = document.createElement('div');                                
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 150px 1fr';
    row.style.gap = '12px';
    row.style.marginBottom = '12px';
        row.innerHTML = `
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Payment Method</label>
            <select class="tender-method" onchange="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                     
                <option value="Cash">üí∞ Cash</option>                                
                <option value="Card">üí≥ Card</option>                                
                <option value="Mobile Money">üì± Mobile Money</option>                
                <option value="Bank Transfer">üè¶ Bank Transfer</option>              
            </select>
        </div>
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Reference</label>
            <input class="tender-ref" placeholder="Optional" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                             
        </div>
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Amount (N$)</label>
            <input class="tender-amount" type="number" min="0" step="0.01" value="0" oninput="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; font-weight:600; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                  
        </div>
    `;
    tenderRows.appendChild(row);
    recalcPaymentTotals();
}

function recalcPaymentTotals(){
    if (!rxPaymentContext) return;
    const discount = Number(document.getElementById('paymentDiscount')?.value||0);
    const amountDue = Math.max(0, Number(rxPaymentContext.amountDue||0) - discount);
    const tenderInputs = Array.from(document.querySelectorAll('#tenderRows .tender-amount'));
    const tenderTotal = tenderInputs.reduce((sum, el) => sum + (Number(el.value)||0), 0);
    const changeOrBalance = tenderTotal - amountDue;
    const amountDueEl = document.getElementById('amountDue');
    const tenderTotalEl = document.getElementById('tenderTotal');
    const changeBalanceEl = document.getElementById('changeBalance');
    if (amountDueEl) amountDueEl.textContent = rxFormat(amountDue);
    if (tenderTotalEl) tenderTotalEl.textContent = rxFormat(tenderTotal);
    if (changeBalanceEl) changeBalanceEl.textContent = rxFormat(changeOrBalance);
}

function generateReceiptNumber(reportId){
    try {
        const report = reports.find(r => r.id === reportId);
        const client = report ? clients.find(c => c.referenceNumber === report.clientId) : null;
        const branch = client ? (client.branch||'BR') : 'BR';
        const dt = new Date();
        const ymd = dt.toISOString().slice(0,10).replaceAll('-','');
        const seq = (''+Date.now()).slice(-6);
        return `${branch}-${ymd}-${seq}`;
    } catch(_) { return 'RX-'+Date.now(); }
}

async function confirmPayment(){
    if (!rxPaymentContext) return;
    const { reportId } = rxPaymentContext;
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    const discount = Number(document.getElementById('paymentDiscount')?.value||0);
    const methods = Array.from(document.querySelectorAll('#tenderRows .tender-method'));
    const refs = Array.from(document.querySelectorAll('#tenderRows .tender-ref'));
    const amts = Array.from(document.querySelectorAll('#tenderRows .tender-amount'));
    const tenders = methods.map((m, i) => ({ method: m.value, reference: refs[i]?.value || '', amount: Number(amts[i]?.value||0) }));
    const receipt = generateReceiptNumber(reportId);

    if (!report.payments) report.payments = [];
    report.payments.push({
        receipt,
        discount,
        tenders,
        memberStatus: rxPaymentContext.memberStatus,
        collectedBy: (currentUser && currentUser.fullName) ? currentUser.fullName : 'system',
        collectedAt: new Date().toISOString()
    });

    if (Array.isArray(report.medicines)) {
        report.medicines.forEach(m => {
            if (m.dispensed) {
                if (!m.paymentHistory) m.paymentHistory = [];
                m.paid = true;
                m.paidBy = (currentUser && currentUser.fullName) ? currentUser.fullName : 'system';
                m.paidAt = new Date().toISOString();
                m.paymentMethod = 'Multiple';
                m.amountPaid = tenders.reduce((s, t) => s + (Number(t.amount)||0), 0);
                m.paymentHistory.push({ amount: m.amountPaid, method: 'Multiple', paidBy: m.paidBy, paidAt: m.paidAt, reference: receipt });
            }
        });
    }

    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success) {
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            closePaymentModal();
            displayPrescriptions();
            alert(`‚úÖ Payment recorded. Receipt: ${receipt}`);
        } else {
            alert('Error saving payment');
        }
    } catch(e){ alert('Error saving payment'); }
}

function viewPrescriptionPaymentHistory(reportId){
    const report = reports.find(r => r.id === reportId);
    if (!report || !report.payments || report.payments.length === 0){
        alert('No prescription-level payments recorded');
        return;
    }
    const lines = report.payments.map(p => {
        const sum = (p.tenders||[]).reduce((s,t)=> s+(Number(t.amount)||0),0);
        const methods = (p.tenders||[]).map(t=> `${t.method}:${(Number(t.amount)||0).toFixed(2)}`).join(', ');
        return `${new Date(p.collectedAt).toLocaleString('en-GB')} | ${p.receipt} | ${methods} | Total: ${sum.toFixed(2)}`;
    }).join('\n');
    alert(`Payment History for ${reportId}:\n\n${lines}`);
}

// FEFO helper: choose earliest-expiring lot with enough qty (or first available)
function pickFefoLot(productName, qty){
    try {
        const inv = (window.inventory && window.inventory[productName]) ? window.inventory[productName] : null;
        const lots = Array.isArray(inv?.lots) ? inv.lots.slice() : [];
        if (lots.length === 0) return null;
        lots.sort((a,b) => new Date(a.expiry) - new Date(b.expiry));
        let chosen = null;
        for (const lot of lots){
            if (Number(lot.qty||0) >= Number(qty||1)) { chosen = lot; break; }
            if (!chosen) chosen = lot; // fallback to first
        }
        if (!chosen) chosen = lots[0];
        // decrement lot qty if tracked
        if (inv && inv.lots) {
            const idx = inv.lots.findIndex(l => l.batch === chosen.batch && l.expiry === chosen.expiry);
            if (idx >= 0) inv.lots[idx].qty = Math.max(0, Number(inv.lots[idx].qty||0) - Number(qty||1));
        }
        return { batch: chosen.batch, expiry: chosen.expiry };
    } catch(_){ return null; }
}

async function dispenseAll(reportId){
    if (!hasActionPermission('dispense')) { alert('You do not have permission to dispense.'); return; }
    const report = reports.find(r => r.id === reportId);
    if (!report || !Array.isArray(report.medicines)) return;
    const confirmAll = confirm('Mark all items as dispensed? This will update package items as given and adjust inventory.');
    if (!confirmAll) return;
    report.medicines.forEach(med => {
        const price = findProductPrice(med.name);
        const isPackage = !!price.isPackage;
        if (isPackage){
            const products = price.products || [];
            med.packageStatus = med.packageStatus || {};
            products.forEach(p => med.packageStatus[p] = 'given');
        }
        try {
            const inv = (window.inventory && window.inventory[med.name]) ? window.inventory[med.name] : null;
            const neededQty = Number(med.quantity || 1);
            const available = inv ? Number(inv.currentStock || 0) : Infinity;
            if (available < neededQty) {
                med.dueOut = Math.max(0, neededQty - available);
                med.dispensed = false;
                return;
            }
        } catch(_){ }
        med.dispensed = true;
        med.dispensedBy = (currentUser && currentUser.fullName) ? currentUser.fullName : 'system';
        med.dispensedAt = new Date().toISOString();
        try { const lot = pickFefoLot(med.name, Number(med.quantity||1)); if (lot) { med.lotBatch = lot.batch; med.lotExpiry = lot.expiry; } } catch(_){ }
        try { adjustInventoryForDispense(report, med, Number(med.quantity||1)); } catch(_){ }
    });
    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success){
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            displayPrescriptions();
            alert('‚úÖ All eligible items marked as dispensed. Due-outs recorded where stock was insufficient.');
        } else {
            alert('Error updating prescription');
        }
    } catch(e){ alert('Error updating prescription'); }
}

async function reverseLastPrescriptionPayment(reportId){
    const report = reports.find(r => r.id === reportId);
    if (!report || !report.payments || report.payments.length === 0){
        alert('No payments to reverse');
        return;
    }
    const reason = prompt('Enter reversal reason:');
    if (!reason) return;
    const last = report.payments[report.payments.length - 1];
    const reversingTenders = (last.tenders||[]).map(t => ({ method: t.method, reference: (t.reference||'') + ' (REV)', amount: -Math.abs(Number(t.amount)||0) }));
    report.payments.push({
        receipt: last.receipt + '-REV',
        discount: 0,
        tenders: reversingTenders,
        memberStatus: last.memberStatus,
        collectedBy: (currentUser && currentUser.fullName) ? currentUser.fullName : 'system',
        collectedAt: new Date().toISOString(),
        reversalOf: last.receipt,
        reason
    });
    if (Array.isArray(report.medicines)) {
        report.medicines.forEach(m => { if (m.dispensed) { m.paid = false; delete m.paidAt; delete m.paidBy; delete m.paymentMethod; delete m.amountPaid; } });
    }
    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success){
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            displayPrescriptions();
            alert('‚úÖ Payment reversed');
        } else {
            alert('Error reversing payment');
        }
    } catch(e){ alert('Error reversing payment'); }
}

        async function ensureWalkInDataHydrated(options = {}) {
            const { force = false } = options || {};
            let priceListLoaded = false;
            let distributorsLoadedNow = false;

            if (typeof ensurePriceListHydrated === 'function') {
                try {
                    await ensurePriceListHydrated(force);
                    priceListLoaded = Array.isArray(window.PRICE_LIST) && window.PRICE_LIST.length > 0;
                } catch (err) {
                    console.warn('ensureWalkInDataHydrated: price list hydration failed', err);
                }
            }

            if (typeof loadDistributors === 'function') {
                try {
                    const list = await loadDistributors({ forceRefresh: force });
                    distributorsLoadedNow = Array.isArray(list) && list.length > 0;
                } catch (err) {
                    console.warn('ensureWalkInDataHydrated: distributor load failed', err);
                }
            }

            if (priceListLoaded && typeof updateWalkInPriceListInsights === 'function') {
                try { updateWalkInPriceListInsights(); } catch (err) { console.debug('updateWalkInPriceListInsights failed', err); }
            }
            if ((distributorsLoadedNow || (Array.isArray(window.distributors) && window.distributors.length > 0)) && typeof updateWalkInDistributorInsights === 'function') {
                try { updateWalkInDistributorInsights(); } catch (err) { console.debug('updateWalkInDistributorInsights failed', err); }
            }
            if (typeof refreshDistributorCustomerHelper === 'function') {
                try { refreshDistributorCustomerHelper(); } catch (_) {}
            }
        }

        function showDispenserTab(tab) {
            // Hide all sections
            const sections = ['dispenserWalkInSection', 'dispenserPrescriptionSection', 'dispenserStockSection', 'dispenserBankingSection', 'dispenserPaymentsSection', 'dispenserOnlineOrdersSection', 'dispenserBonusSection', 'dispenserCommunicationSection', 'dispenserStaffSection', 'dispenserDistributorRegistrationSection', 'dispenserFieldProgramSection'];
            sections.forEach(sec => {
                const el = document.getElementById(sec);
                if (el) el.style.display = 'none';
            });
            
            // Reset all tab buttons
            const tabs = ['walkInTab', 'saleTab', 'prescriptionTab', 'stockTab', 'bankingTab', 'paymentsTab', 'onlineOrdersTab', 'bonusTab', 'communicationTab', 'staffTab', 'distributorRegistrationTab', 'fieldProgramTab'];
            tabs.forEach(tabBtn => {
                const el = document.getElementById(tabBtn);
                if (el) {
                    el.style.background = '#ecf0f1';
                    el.style.color = '#2c3e50';
                    el.style.fontWeight = 'normal';
                }
            });
            
            // Show selected section and activate tab
            let activeSection = null;
            let activeTab = null;
            let gradient = '';
            
            switch(tab) {
                case 'walkIn':
                    activeSection = 'dispenserWalkInSection';
                    activeTab = 'walkInTab';
                    gradient = 'linear-gradient(135deg, #3498db, #2980b9)';
                    if (typeof ensureWalkInDataHydrated === 'function') {
                        ensureWalkInDataHydrated().catch(err => console.warn('walkIn tab hydration issue', err));
                    }
                    if (!hasSyncedWalkInSales) {
                        syncWalkInSalesFromApi().catch(() => {});
                    } else {
                        refreshWalkInSalesList();
                    }
                    break;
                case 'sale':
                    activeSection = 'dispenserWalkInSection';
                    activeTab = 'saleTab';
                    gradient = 'linear-gradient(135deg, #3498db, #2980b9)';
                    if (typeof ensureWalkInDataHydrated === 'function') {
                        ensureWalkInDataHydrated().catch(err => console.warn('sale tab hydration issue', err));
                    }
                    if (!hasSyncedWalkInSales) {
                        syncWalkInSalesFromApi().catch(() => {});
                    } else {
                        refreshWalkInSalesList();
                    }
                    break;
                case 'prescription':
                    activeSection = 'dispenserPrescriptionSection';
                    activeTab = 'prescriptionTab';
                    gradient = 'linear-gradient(135deg, #27ae60, #229954)';
                    // Ensure data is loaded before displaying prescriptions
                    (async () => {
                        await loadData();
                        await displayPrescriptions();
                    })();
                    break;
                case 'stock':
                    activeSection = 'dispenserStockSection';
                    activeTab = 'stockTab';
                    gradient = 'linear-gradient(135deg, #34495e, #2c3e50)';
                    // Load branch inventory
                    if (typeof refreshBranchInventory === 'function') {
                        refreshBranchInventory();
                    }
                    break;
                case 'banking':
                    activeSection = 'dispenserBankingSection';
                    activeTab = 'bankingTab';
                    gradient = 'linear-gradient(135deg, #f39c12, #e67e22)';
                    syncBranchFinanceData({ notify: true })
                        .then(() => {
                            displayCashDrawerStatus();
                    displayBankingHistory();
                        })
                        .catch(() => {
                            displayCashDrawerStatus();
                            displayBankingHistory();
                        });
                    break;
                case 'payments':
                    activeSection = 'dispenserPaymentsSection';
                    activeTab = 'paymentsTab';
                    gradient = 'linear-gradient(135deg, #9b59b6, #8e44ad)';
                    syncBranchFinanceData({ notify: false })
                        .then(() => displayPaymentHistory())
                        .catch(() => displayPaymentHistory());
                    break;
                case 'onlineOrders':
                    activeSection = 'dispenserOnlineOrdersSection';
                    activeTab = 'onlineOrdersTab';
                    gradient = 'linear-gradient(135deg, #6c5ce7, #5f27cd)';
                    displayBranchOnlineOrders();
                    break;
                case 'bonus':
                    activeSection = 'dispenserBonusSection';
                    activeTab = 'bonusTab';
                    gradient = 'linear-gradient(135deg, #e84393, #d63031)';
                    initializeDispenserBonusTab();
                    break;
                case 'communication':
                    activeSection = 'dispenserCommunicationSection';
                    activeTab = 'communicationTab';
                    gradient = 'linear-gradient(135deg, #16a34a, #0d9488)';
                    try { renderStaffCommunications(); } catch(_) {}
                    break;
                case 'fieldProgram':
                    activeSection = 'dispenserFieldProgramSection';
                    activeTab = 'fieldProgramTab';
                    gradient = 'linear-gradient(135deg, #e17055, #d63031)';
                    try { displayFieldProgramRequests(); } catch(_) {}
                    break;
                case 'staff':
                    activeSection = 'dispenserStaffSection';
                    activeTab = 'staffTab';
                    gradient = 'linear-gradient(135deg, #16a085, #138d75)';
                    loadMyStaffStatus();
                    break;
                case 'distributorRegistration':
                    activeSection = 'dispenserDistributorRegistrationSection';
                    activeTab = 'distributorRegistrationTab';
                    gradient = 'linear-gradient(135deg, #7b1fa2, #6a1b9a)';
                    initializeDistributorAgreementForm();
                    break;
            }
            
            if (activeSection && activeTab) {
                const sectionEl = document.getElementById(activeSection);
                const tabEl = document.getElementById(activeTab);
                
                if (sectionEl) sectionEl.style.display = 'block';
                if (tabEl) {
                    tabEl.style.background = gradient;
                    tabEl.style.color = 'white';
                    tabEl.style.fontWeight = 'bold';
                }
            }
        }

        // ========== Distributor Agreement Form ==========
        async function initializeDistributorAgreementForm() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('agreementDate');
            const dateReceivedInput = document.getElementById('dateReceived');
            if (dateInput) dateInput.value = today;
            if (dateReceivedInput) dateReceivedInput.value = today;
            
            // Auto-calculate age when birthdate changes
            const birthdateInput = document.getElementById('distributorBirthdate');
            if (birthdateInput) {
                birthdateInput.addEventListener('change', function() {
                    calculateAge(this.value);
                });
            }
            
            // Load current user info for "Received by" and "Processed by"
            if (window.currentUser) {
                const receivedBy = document.getElementById('receivedBy');
                const processedBy = document.getElementById('processedBy');
                if (receivedBy) receivedBy.value = window.currentUser.fullName || '';
                if (processedBy) processedBy.value = window.currentUser.fullName || '';
            }
        }
        
        function calculateAge(birthdate) {
            if (!birthdate) return;
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            const ageInput = document.getElementById('distributorAge');
            if (ageInput) ageInput.value = age;
        }
        
        async function getNextNBNumber() {
            try {
                // Fetch all distributors from database
                const response = await fetch('/api/distributors');
                if (!response.ok) throw new Error('Failed to fetch distributors');
                
                const distributors = await response.json();
                
                // Find the highest NB number
                let maxNB = 0;
                distributors.forEach(dist => {
                    const code = dist.distributor_code || dist.distributorCode || '';
                    const match = code.match(/^NB(\d+)$/i);
                    if (match) {
                        const num = parseInt(match[1], 10);
                        if (num > maxNB) maxNB = num;
                    }
                });
                
                // Generate next NB number
                const nextNB = maxNB + 1;
                return `NB${String(nextNB).padStart(6, '0')}`;
            } catch (error) {
                console.error('Error getting next NB number:', error);
                // Fallback: generate based on timestamp
                return `NB${String(Date.now()).slice(-6)}`;
            }
        }
        
        async function searchUplineDistributor() {
            const input = document.getElementById('uplineIdNo');
            const resultsDiv = document.getElementById('uplineSearchResults');
            if (!input || !resultsDiv) return;

            const searchTerm = (input.value || '').trim();
            if (typeof renderDistributorSearchResults === 'function') {
                await renderDistributorSearchResults(input, resultsDiv, {
                    limit: 5,
                    onSelect: (record) => {
                        const code = record.distributorCode || record.id || '';
                        const name = record.distributorName || record.name || code;
                        const phone =
                            record.mobileNo || record.mobile_no || record.mobile || '';
                        selectUplineDistributor(code, name, phone, record.id || code);
                        resultsDiv.style.display = 'none';
                    }
                });
                return;
            }

            const normalizedTerm = searchTerm.toUpperCase();
            if (normalizedTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(
                    `/api/distributors?search=${encodeURIComponent(searchTerm)}`
                );
                if (!response.ok) throw new Error('Search failed');

                const distributors = await response.json();
                const filtered = distributors
                    .filter((d) => {
                        const code = (d.distributor_code || d.distributorCode || '').toUpperCase();
                        const name = (d.distributor_name || d.distributorName || '').toUpperCase();
                        return code.includes(normalizedTerm) || name.includes(normalizedTerm);
                    })
                    .slice(0, 5);

                if (filtered.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                resultsDiv.innerHTML = filtered
                    .map((dist) => {
                        const code = dist.distributor_code || dist.distributorCode || '';
                        const name = dist.distributor_name || dist.distributorName || '';
                        return `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectUplineDistributor('${code}', '${name.replace(/'/g, "\\'")}')">${code} - ${name}</div>`;
                    })
                    .join('');
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Error searching upline:', error);
                resultsDiv.style.display = 'none';
            }
        }
        
        function selectUplineDistributor(code, name, mobile = '', id = '') {
            const idInput = document.getElementById('uplineIdNo');
            const nameInput = document.getElementById('uplineName');
            const phoneInput = document.getElementById('uplineMobile');
            const resultsDiv = document.getElementById('uplineSearchResults');
            if (idInput) idInput.value = code || '';
            if (nameInput) nameInput.value = name || '';
            if (phoneInput && mobile) phoneInput.value = mobile;
            if (resultsDiv) resultsDiv.style.display = 'none';
        }
        
        
        async function searchSponsorDistributor() {
            const input = document.getElementById('sponsorIdNo');
            const resultsDiv = document.getElementById('sponsorSearchResults');
            if (!input || !resultsDiv) return;

            const searchTerm = (input.value || '').trim();
            if (typeof renderDistributorSearchResults === 'function') {
                await renderDistributorSearchResults(input, resultsDiv, {
                    limit: 5,
                    onSelect: (record) => {
                        const code = record.distributorCode || record.id || '';
                        const name = record.distributorName || record.name || code;
                        const phone =
                            record.mobileNo || record.mobile_no || record.mobile || '';
                        selectSponsorDistributor(code, name, phone, record.id || code);
                        resultsDiv.style.display = 'none';
                    }
                });
                return;
            }

            const normalizedTerm = searchTerm.toUpperCase();
            if (normalizedTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(
                    `/api/distributors?search=${encodeURIComponent(searchTerm)}`
                );
                if (!response.ok) throw new Error('Search failed');

                const distributors = await response.json();
                const filtered = distributors
                    .filter((d) => {
                        const code = (d.distributor_code || d.distributorCode || '').toUpperCase();
                        const name = (d.distributor_name || d.distributorName || '').toUpperCase();
                        return code.includes(normalizedTerm) || name.includes(normalizedTerm);
                    })
                    .slice(0, 5);

                if (filtered.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                resultsDiv.innerHTML = filtered
                    .map((dist) => {
                        const code = dist.distributor_code || dist.distributorCode || '';
                        const name = dist.distributor_name || dist.distributorName || '';
                        return `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectSponsorDistributor('${code}', '${name.replace(/'/g, "\\'")}')">${code} - ${name}</div>`;
                    })
                    .join('');
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Error searching sponsor:', error);
                resultsDiv.style.display = 'none';
            }
        }
        
        function selectSponsorDistributor(code, name, mobile = '', id = '') {
            const idInput = document.getElementById('sponsorIdNo');
            const nameInput = document.getElementById('sponsorName');
            const phoneInput = document.getElementById('sponsorMobile');
            const resultsDiv = document.getElementById('sponsorSearchResults');
            if (idInput) idInput.value = code || '';
            if (nameInput) nameInput.value = name || '';
            if (phoneInput && mobile) phoneInput.value = mobile;
            if (resultsDiv) resultsDiv.style.display = 'none';
        }
        
        async function submitDistributorAgreement(event) {
            event.preventDefault();
            const statusDiv = document.getElementById('distributorAgreementStatus');
            statusDiv.innerHTML = '<p style="color: #f39c12;">‚è≥ Processing registration...</p>';
            
            try {
                // Get form data
                const formData = {
                    distributor_name: document.getElementById('distributorName').value.trim(),
                    birthdate: document.getElementById('distributorBirthdate').value,
                    age: parseInt(document.getElementById('distributorAge').value) || null,
                    sex: document.getElementById('distributorSex').value,
                    nationality: document.getElementById('distributorNationality').value.trim(),
                    mobile_no: document.getElementById('distributorMobile').value.trim(),
                    residence_phone: document.getElementById('distributorResidencePhone').value.trim() || null,
                    office_phone: document.getElementById('distributorOfficePhone').value.trim() || null,
                    email: document.getElementById('distributorEmail').value.trim() || null,
                    address1: document.getElementById('distributorAddress1').value.trim(),
                    city: document.getElementById('distributorCity').value.trim(),
                    zip_code: document.getElementById('distributorZipCode').value.trim() || null,
                    tax_id: document.getElementById('distributorTaxId').value.trim() || null,
                    sss_no: document.getElementById('distributorSSS').value.trim() || null,
                    beneficiary: document.getElementById('distributorBeneficiary').value.trim() || null,
                    upline_name: document.getElementById('uplineName').value.trim() || null,
                    upline_id_no: document.getElementById('uplineIdNo').value.trim() || null,
                    upline_address: document.getElementById('uplineAddress').value.trim() || null,
                    upline_city: document.getElementById('uplineCity').value.trim() || null,
                    upline_mobile: document.getElementById('uplineMobile').value.trim() || null,
                    upline_zip_code: document.getElementById('uplineZipCode').value.trim() || null,
                    sponsor_name: document.getElementById('sponsorName').value.trim() || null,
                    sponsor_id_no: document.getElementById('sponsorIdNo').value.trim() || null,
                    agreement_date: document.getElementById('agreementDate').value,
                    applicant_signature: document.getElementById('applicantSignature').value.trim(),
                    date_received: document.getElementById('dateReceived').value || null,
                    received_by: document.getElementById('receivedBy').value.trim() || null,
                    processed_by: document.getElementById('processedBy').value.trim() || null
                };
                
                // Get materials received
                const materials = [];
                document.querySelectorAll('input[name="materials"]:checked').forEach(cb => {
                    if (cb.value === 'others') {
                        const othersText = document.getElementById('materialsOthers').value.trim();
                        if (othersText) materials.push(`Others: ${othersText}`);
                    } else {
                        materials.push(cb.value);
                    }
                });
                
                // Generate next NB number
                const nbNumber = await getNextNBNumber();
                formData.distributor_code = nbNumber;
                
                // Set assigned distributor ID
                document.getElementById('assignedDistributorId').value = nbNumber;
                
                // Get selected registration kit
                const selectedKit = document.querySelector('input[name="registrationKit"]:checked');
                if (!selectedKit) {
                    throw new Error('Please select a registration kit');
                }
                
                const kitType = selectedKit.value;
                const kitProduct = kitType === 'fert' 
                    ? { description: "REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150 }
                    : { description: "REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150 };
                
                // Upload photo if provided (PRIMARY: Save to backend)
                let photoUrl = null;
                const photoInput = document.getElementById('distributorPhotoInput');
                if (photoInput && photoInput.files && photoInput.files.length > 0) {
                    try {
                        const photoFile = photoInput.files[0];
                        const uploadFormData = new FormData();
                        uploadFormData.append('file', photoFile);
                        uploadFormData.append('type', 'distributor');
                        uploadFormData.append('entityId', nbNumber);
                        uploadFormData.append('entityName', formData.distributor_name);
                        
                        const photoResponse = await fetch('/api/upload', {
                            method: 'POST',
                            body: uploadFormData
                        });
                        
                        if (photoResponse.ok) {
                            const photoResult = await photoResponse.json();
                            photoUrl = photoResult.file.url;
                            console.log('‚úÖ Distributor photo uploaded to backend');
                        } else {
                            console.warn('Photo upload failed, continuing without photo');
                        }
                    } catch (photoError) {
                        console.warn('Photo upload error:', photoError);
                        // Continue without photo
                    }
                }
                
                // Save to database via API
                const response = await fetch('/api/distributors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        distributor_code: nbNumber,
                        distributor_name: formData.distributor_name,
                        mobile_no: formData.mobile_no,
                        email: formData.email,
                        commission_rate: 0,
                        status: 'active',
                        branch: window.currentUser?.branch || null,
                        agreement_data: JSON.stringify({
                            birthdate: formData.birthdate,
                            age: formData.age,
                            sex: formData.sex,
                            nationality: formData.nationality,
                            residence_phone: formData.residence_phone,
                            office_phone: formData.office_phone,
                            address1: formData.address1,
                            city: formData.city,
                            zip_code: formData.zip_code,
                            tax_id: formData.tax_id,
                            sss_no: formData.sss_no,
                            beneficiary: formData.beneficiary,
                            upline_name: formData.upline_name,
                            upline_id_no: formData.upline_id_no,
                            upline_address: formData.upline_address,
                            upline_city: formData.upline_city,
                            upline_mobile: formData.upline_mobile,
                            upline_zip_code: formData.upline_zip_code,
                            sponsor_name: formData.sponsor_name,
                            sponsor_id_no: formData.sponsor_id_no,
                            agreement_date: formData.agreement_date,
                            applicant_signature: formData.applicant_signature,
                            date_received: formData.date_received,
                            received_by: formData.received_by,
                            processed_by: formData.processed_by,
                            materials: materials,
                            photo_url: photoUrl,
                            uploaded_at: new Date().toISOString(),
                            uploaded_by: window.currentUser?.fullName || 'Admin'
                        })
                    })
                });
                
                if (!response.ok) {
                    // Check if response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    let errorMessage = 'Failed to register distributor';
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const error = await response.json();
                            errorMessage = error.error || error.message || errorMessage;
                        } catch (e) {
                            // If JSON parsing fails, use status text
                            errorMessage = response.statusText || errorMessage;
                        }
                    } else {
                        // Non-JSON response (likely HTML error page)
                        const text = await response.text();
                        errorMessage = `Server error (${response.status}): ${text.substring(0, 100)}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                let newDistributor;
                try {
                    newDistributor = await response.json();
                } catch (e) {
                    throw new Error('Invalid response from server. Please try again.');
                }
                
                // Also save to local storage for immediate access
                if (typeof loadDistributors === 'function') {
                    await loadDistributors();
                    if (typeof distributors !== 'undefined') {
                        distributors.push({
                            id: newDistributor.id || `DIST-${Date.now()}`,
                            distributorCode: nbNumber,
                            distributorName: formData.distributor_name,
                            mobileNo: formData.mobile_no,
                            email: formData.email
                        });
                        if (typeof saveDistributors === 'function') {
                            await saveDistributors();
                        }
                    }
                }
                
                // Create registration kit sale and deduct stock
                try {
                    await createRegistrationKitSale(nbNumber, formData.distributor_name, formData.mobile_no, kitProduct);
                } catch (saleError) {
                    console.error('Error creating registration kit sale:', saleError);
                    // Continue even if sale creation fails - distributor is already registered
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; color: #856404; margin-bottom: 15px;">
                            <p><strong>‚ö†Ô∏è Warning:</strong> Distributor registered but registration kit sale failed. Please manually process the kit sale.</p>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; color: #155724;">
                        <h4 style="margin-top: 0; color: #155724;">‚úÖ Distributor Registered Successfully!</h4>
                        <p><strong>Distributor ID:</strong> ${nbNumber}</p>
                        <p><strong>Name:</strong> ${formData.distributor_name}</p>
                        <p style="margin-top: 10px;">The distributor has been added to the system and can now be used in sales and other operations.</p>
                    </div>
                `;
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    resetDistributorAgreementForm();
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting distributor agreement:', error);
                statusDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                        <h4 style="margin-top: 0; color: #721c24;">‚ùå Registration Failed</h4>
                        <p>${error.message || 'An error occurred while registering the distributor. Please try again.'}</p>
                    </div>
                `;
            }
        }
        
        function resetDistributorAgreementForm() {
            document.getElementById('distributorAgreementForm').reset();
            document.getElementById('distributorAgreementStatus').innerHTML = '';
            initializeDistributorAgreementForm();
        }
        
        async function generateAndEmailDistributorPDF(formData, nbNumber, materials, kitProduct) {
            try {
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font and colors
                doc.setFontSize(16);
                doc.setTextColor(196, 30, 58); // Dynapharm red
                doc.text('DYNAPHARM INTERNATIONAL NAMIBIA', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Distributor Agreement Form', 105, 30, { align: 'center' });
                
                let yPos = 45;
                doc.setFontSize(10);
                
                // Distributor's Data Section
                doc.setFontSize(12);
                doc.setTextColor(196, 30, 58);
                doc.text('Distributor\'s Data', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Distributor ID: ${nbNumber}`, 14, yPos);
                yPos += 6;
                doc.text(`Name: ${formData.distributor_name}`, 14, yPos);
                yPos += 6;
                doc.text(`Birthdate: ${formData.birthdate || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Age: ${formData.age || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Sex: ${formData.sex || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Nationality: ${formData.nationality || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Mobile: ${formData.mobile_no || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.residence_phone) {
                    doc.text(`Residence Phone: ${formData.residence_phone}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.office_phone) {
                    doc.text(`Office Phone: ${formData.office_phone}`, 14, yPos);
                    yPos += 6;
                }
                doc.text(`Email: ${formData.email || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Address: ${formData.address1 || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`City: ${formData.city || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.zip_code) {
                    doc.text(`Zip Code: ${formData.zip_code}`, 14, yPos);
                    yPos += 6;
                }
                
                // Check if we need a new page
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Upline and Sponsor Data
                if (formData.upline_name || formData.sponsor_name) {
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Upline & Sponsor Information', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    if (formData.upline_name) {
                        doc.text(`Upline: ${formData.upline_name} (${formData.upline_id_no || 'N/A'})`, 14, yPos);
                        yPos += 6;
                    }
                    if (formData.sponsor_name) {
                        doc.text(`Sponsor: ${formData.sponsor_name} (${formData.sponsor_id_no || 'N/A'})`, 14, yPos);
                        yPos += 6;
                    }
                }
                
                // Registration Kit
                if (kitProduct) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Registration Kit', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Kit: ${kitProduct.description}`, 14, yPos);
                    yPos += 6;
                    doc.text(`Price: N$ ${kitProduct.cp.toFixed(2)}`, 14, yPos);
                    yPos += 6;
                }
                
                // Materials Received
                if (materials && materials.length > 0) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Materials Received', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    materials.forEach(mat => {
                        doc.text(`‚Ä¢ ${mat}`, 14, yPos);
                        yPos += 6;
                    });
                }
                
                // Agreement Date and Signature
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFontSize(12);
                doc.setTextColor(196, 30, 58);
                doc.text('Agreement Details', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Agreement Date: ${formData.agreement_date || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Applicant Signature: ${formData.applicant_signature || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.date_received) {
                    doc.text(`Date Received: ${formData.date_received}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.received_by) {
                    doc.text(`Received By: ${formData.received_by}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.processed_by) {
                    doc.text(`Processed By: ${formData.processed_by}`, 14, yPos);
                }
                
                // Save PDF
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Download PDF
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = `Distributor_Agreement_${nbNumber}_${Date.now()}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Send email via API or mailto link
                const openEmailClient = (formData, nbNumber) => {
                    const subject = encodeURIComponent(`Distributor Registration Confirmation - ${nbNumber}`);
                    const body = encodeURIComponent(`Dear ${formData.distributor_name},\n\nYour distributor registration has been successfully processed.\n\nDistributor ID: ${nbNumber}\n\nPlease find attached your Distributor Agreement Form (downloaded automatically).\n\nThank you for joining Dynapharm International Namibia.\n\nBest regards,\nDynapharm Team`);
                    const mailtoLink = `mailto:${formData.email}?subject=${subject}&body=${body}`;
                    window.open(mailtoLink);
                    alert(`‚úÖ PDF generated and downloaded. Email client opened. Please attach the PDF file to the email.`);
                };
                
                try {
                    // Convert PDF blob to base64 for API
                    const reader = new FileReader();
                    reader.onloadend = async function() {
                        const base64Pdf = reader.result.split(',')[1];
                        
                        try {
                            // Try to send via API if available
                            const emailResponse = await fetch('/api/send-email', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    to: formData.email,
                                    subject: `Distributor Registration Confirmation - ${nbNumber}`,
                                    body: `Dear ${formData.distributor_name},\n\nYour distributor registration has been successfully processed.\n\nDistributor ID: ${nbNumber}\n\nPlease find attached your Distributor Agreement Form.\n\nThank you for joining Dynapharm International Namibia.\n\nBest regards,\nDynapharm Team`,
                                    attachment: base64Pdf,
                                    attachmentName: `Distributor_Agreement_${nbNumber}.pdf`
                                })
                            });
                            
                            if (emailResponse.ok) {
                                alert(`‚úÖ PDF generated and email sent to ${formData.email}`);
                            } else {
                                // Fallback to mailto link
                                openEmailClient(formData, nbNumber);
                            }
                        } catch (apiError) {
                            // Fallback to mailto link
                            openEmailClient(formData, nbNumber);
                        }
                    };
                    reader.readAsDataURL(pdfBlob);
                } catch (emailError) {
                    // Fallback: Open email client with mailto link
                    openEmailClient(formData, nbNumber);
                }
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }
        
        async function createRegistrationKitSale(distributorId, distributorName, mobileNo, kitProduct) {
            const now = new Date();
            const saleDate = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Create cart item for the kit
            const cartItem = {
                name: kitProduct.description,
                quantity: 1,
                dp: kitProduct.dp,
                cp: kitProduct.cp,
                bv: kitProduct.bv,
                price: kitProduct.cp // Use CP for distributor registration
            };
            
            // Create sale record
            const sale = {
                id: 'REG-' + Date.now(),
                clientId: distributorId,
                clientReferenceNumber: distributorId,
                customerName: distributorName,
                phone: mobileNo || '',
                email: '',
                customerType: 'distributor',
                distributorReferral: {
                    name: distributorName,
                    id: distributorId
                },
                products: [cartItem],
                subtotal: kitProduct.cp,
                tax: 0,
                total: kitProduct.cp,
                totalAmount: kitProduct.cp,
                totalBV: kitProduct.bv,
                date: saleDate,
                timestamp: now.toISOString(),
                soldBy: window.currentUser ? window.currentUser.fullName : 'System',
                branch: window.currentUser ? window.currentUser.branch : 'unknown',
                paymentMethod: 'registration',
                saleType: 'registration',
                registrationSale: true
            };
            
            // Deduct stock using FEFO or legacy method
            try {
                const branchId = (window.currentUser && window.currentUser.branch) || 'unknown_branch';
                const userName = (window.currentUser && window.currentUser.fullName) || 'system';
                
                // Try FEFO first
                if (typeof fefoDispenseProducts === 'function') {
                    const fefo = await fefoDispenseProducts(
                        [{ name: kitProduct.description, quantity: 1 }], 
                        branchId, 
                        userName, 
                        sale.id
                    );
                    if (!fefo.success) {
                        console.warn('FEFO stock issues:', fefo.errors);
                        // Fall back to legacy method
                        if (typeof reduceInventoryForProducts === 'function') {
                            const invReduction = reduceInventoryForProducts([cartItem], userName, sale.id);
                            if (!invReduction.success) {
                                throw new Error('Stock deduction failed: ' + invReduction.errors.join(', '));
                            }
                        }
                    }
                } else if (typeof reduceInventoryForProducts === 'function') {
                    // Use legacy method
                    const invReduction = reduceInventoryForProducts([cartItem], userName, sale.id);
                    if (!invReduction.success) {
                        throw new Error('Stock deduction failed: ' + invReduction.errors.join(', '));
                    }
                }
            } catch (stockError) {
                console.error('Error deducting stock:', stockError);
                throw new Error('Failed to deduct registration kit from stock: ' + stockError.message);
            }
            
            // Record department event
            if (typeof recordDepartmentEvent === 'function') {
                recordDepartmentEvent('registration_sale', sale);
            }
            
            // Broadcast stock update event
            try {
                const branchId = (window.currentUser && window.currentUser.branch) || 'unknown';
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: branchId, products: [cartItem], user: (window.currentUser && window.currentUser.fullName) || 'system', reference: sale.id } 
                }));
                window.dispatchEvent(new CustomEvent('sale:updated', { detail: { sale, type: 'registration' } }));
                
                // Publish to Railway gateway if available
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products: [cartItem], sale: sale.id, ts: Date.now() } })
                    }).catch(_ => {});
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'sale:updated', sale, type: 'registration', ts: Date.now() } })
                    }).catch(_ => {});
                }
                
                // Publish to Vercel SSE
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products: [cartItem], ts: Date.now() } }) 
                }).catch(_ => {});
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'sales', event: { sale, type: 'registration', ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}
            
            // Save sale to localStorage
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            walkInSales.push(sale);
            localStorage.setItem('dyna_walkin_sales', JSON.stringify(walkInSales));
            
            // Also save to finance portal key
            const financeSales = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            financeSales.push(sale);
            localStorage.setItem('dynapharm_walkin_sales', JSON.stringify(financeSales));
            
            // Update cash drawer
            const cashDrawer = JSON.parse(localStorage.getItem('dyna_cash_drawer') || '{}');
            if (!cashDrawer.totalSales) cashDrawer.totalSales = [];
            cashDrawer.totalSales.push({
                type: 'registration',
                amount: kitProduct.cp,
                timestamp: sale.timestamp
            });
            localStorage.setItem('dyna_cash_drawer', JSON.stringify(cashDrawer));
            
            // Try to save via API
            try {
                if (typeof apiRequest === 'function') {
                    await apiRequest('/orders', 'POST', sale);
                } else {
                    await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sale)
                    });
                }
            } catch (apiError) {
                console.warn('Failed to save registration sale via API:', apiError);
                // Continue - sale is saved locally
            }
            
            console.log('‚úÖ Registration kit sale created:', sale.id);
            return sale;
        }

        // ========== Dispenser Bonus Tab ==========
        function initializeDispenserBonusTab() {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const m = document.getElementById('dispenserBonusMonth');
            if (m && !m.value) {
                const today = new Date();
                m.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            renderDispenserPendingBonuses();
        }

        // Field Program Functions
        async function displayFieldProgramRequests() {
            const listEl = document.getElementById('fieldProgramRequestsList');
            if (!listEl) return;
            
            try {
                const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
                if (requests.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No stock requests yet. Click "New Stock Request" to create one.</p>';
                    return;
                }
                
                // Sort by date (newest first)
                requests.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                
                listEl.innerHTML = requests.map((req, idx) => `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0;">Request #${req.id || req.requestNumber || idx + 1}</h4>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;"><strong>Distributor:</strong> ${req.distributorName || 'N/A'} (${req.distributorCode || 'N/A'})</p>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;"><strong>Branch:</strong> ${req.branch || 'N/A'} | <strong>Date:</strong> ${new Date(req.date || Date.now()).toLocaleDateString()}</p>
                                ${req.signature ? `<p style="margin: 0; color: #666; font-size: 0.85rem;"><strong>Signed:</strong> ${req.signature}</p>` : ''}
                            </div>
                            <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; background: ${req.status === 'approved' ? '#d4edda' : req.status === 'rejected' ? '#f8d7da' : req.status === 'issued' ? '#cfe2ff' : '#fff3cd'}; color: ${req.status === 'approved' ? '#155724' : req.status === 'rejected' ? '#721c24' : req.status === 'issued' ? '#084298' : '#856404'};">${(req.status || 'pending').toUpperCase()}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <p><strong>Requested Items:</strong></p>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${(req.items || []).map(item => `<li>${item.product || 'N/A'}: ${item.quantity || 0} ${item.unit || 'units'}</li>`).join('')}
                            </ul>
                            ${req.notes ? `<p style="margin-top: 10px;"><strong>Notes:</strong> ${req.notes}</p>` : ''}
                            ${req.approvedBy ? `<p style="margin-top: 5px; color: #0f5132; font-size: 0.85rem;"><strong>Approved by:</strong> ${req.approvedBy} on ${new Date(req.approvedAt).toLocaleDateString()}</p>` : ''}
                            ${req.issuedBy ? `<p style="margin-top: 5px; color: #084298; font-size: 0.85rem;"><strong>Issued by:</strong> ${req.issuedBy} on ${new Date(req.issuedAt).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="printFieldProgramRequestPDF('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">üñ®Ô∏è Print PDF</button>
                            ${req.status === 'pending' ? `
                                <button class="btn btn-success" onclick="approveFieldProgramRequest('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">Approve</button>
                                <button class="btn btn-danger" onclick="rejectFieldProgramRequest('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">Reject</button>
                            ` : req.status === 'approved' ? `
                                <button class="btn btn-primary" onclick="issueFieldProgramStock('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">üì¶ Issue Stock (FEFO)</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading field program requests:', error);
                listEl.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading requests. Please try again.</p>';
            }
        }

        async function openFieldProgramRequestForm() {
            const modal = document.getElementById('fieldProgramRequestModal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('fieldProgramRequestForm').reset();
            document.getElementById('fieldProgramDistributorInfo').style.display = 'none';
            document.getElementById('fieldProgramDistributorDropdown').style.display = 'none';
            
            // Set default date to today
            document.getElementById('fieldProgramRequestDate').value = new Date().toISOString().split('T')[0];
            
            // Load branches
            const branchSelect = document.getElementById('fieldProgramBranch');
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            if (typeof branches !== 'undefined' && Array.isArray(branches)) {
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name;
                    branchSelect.appendChild(option);
                });
            }
            
            // Load products
            const productSelects = document.querySelectorAll('.field-program-product-select');
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Product</option>';
                if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                    PRICE_LIST.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.description;
                        option.textContent = product.description;
                        select.appendChild(option);
                    });
                }
            });
            
            modal.style.display = 'block';
        }

        function closeFieldProgramRequestForm() {
            document.getElementById('fieldProgramRequestModal').style.display = 'none';
        }

        function addFieldProgramProductRow() {
            const container = document.getElementById('fieldProgramProducts');
            const row = document.createElement('div');
            row.className = 'field-program-product-row';
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            row.innerHTML = `
                <div class="form-group">
                    <label>Product *</label>
                    <select class="field-program-product-select" required>
                        <option value="">Select Product</option>
                        ${typeof PRICE_LIST !== 'undefined' ? PRICE_LIST.map(p => `<option value="${p.description}">${p.description}</option>`).join('') : ''}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" class="field-program-quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" class="field-program-unit" placeholder="boxes, units, etc.">
                </div>
                <button type="button" class="btn btn-danger" onclick="removeFieldProgramProductRow(this)" style="padding: 8px 12px;">Remove</button>
            `;
            container.appendChild(row);
        }

        function removeFieldProgramProductRow(button) {
            const rows = document.querySelectorAll('.field-program-product-row');
            if (rows.length > 1) {
                button.closest('.field-program-product-row').remove();
            } else {
                alert('At least one product row is required.');
            }
        }

        async function searchFieldProgramDistributor() {
            const searchInput = document.getElementById('fieldProgramDistributorSearch');
            const dropdown = document.getElementById('fieldProgramDistributorDropdown');
            if (!searchInput || !dropdown) return;

            await renderDistributorSearchResults(searchInput, dropdown, {
                limit: 8,
                onSelect: (record) => {
                    const code = record.distributorCode || record.id || '';
                    const name = record.distributorName || record.name || code;
                    const phone = record.mobileNo || record.mobile_no || record.mobile || '';
                    if (typeof selectFieldProgramDistributor === 'function') {
                        selectFieldProgramDistributor(code, name, phone, record.id || code);
                    }
                    dropdown.style.display = 'none';
                }
            });
        }

function selectFieldProgramDistributor(code, name, mobile = '', id = '') {
            const searchInput = document.getElementById('fieldProgramDistributorSearch');
            const idInput = document.getElementById('fieldProgramDistributorId');
            const codeField = document.getElementById('fieldProgramDistributorCode');
            const nameField = document.getElementById('fieldProgramDistributorName');
            const mobileField = document.getElementById('fieldProgramDistributorMobile');
            const infoPanel = document.getElementById('fieldProgramDistributorInfo');
            const dropdown = document.getElementById('fieldProgramDistributorDropdown');

            if (searchInput) searchInput.value = code && name ? `${code} - ${name}` : (code || name || '');
            if (idInput) idInput.value = id || code || '';
            if (codeField) codeField.textContent = code || 'N/A';
            if (nameField) nameField.textContent = name || 'N/A';
            if (mobileField) mobileField.textContent = mobile || 'N/A';
            if (infoPanel) infoPanel.style.display = 'block';
            if (dropdown) dropdown.style.display = 'none';
        }

        function submitFieldProgramRequest(event) {
            event.preventDefault();
            
            const distributorId = document.getElementById('fieldProgramDistributorId').value;
            if (!distributorId) {
                alert('Please select a distributor');
                return;
            }
            
            // Collect product items
            const productRows = document.querySelectorAll('.field-program-product-row');
            const items = [];
            let hasError = false;
            
            productRows.forEach(row => {
                const product = row.querySelector('.field-program-product-select').value;
                const quantity = parseInt(row.querySelector('.field-program-quantity').value);
                const unit = row.querySelector('.field-program-unit').value || 'units';
                
                if (!product || !quantity) {
                    hasError = true;
                    return;
                }
                
                items.push({ product, quantity, unit });
            });
            
            if (hasError || items.length === 0) {
                alert('Please add at least one product with quantity');
                return;
            }
            
            // Create request object
            const request = {
                id: 'FPR' + Date.now(),
                requestNumber: 'FPR-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6),
                distributorId: distributorId,
                distributorCode: document.getElementById('fieldProgramDistributorCode').textContent,
                distributorName: document.getElementById('fieldProgramDistributorName').textContent,
                distributorMobile: document.getElementById('fieldProgramDistributorMobile').textContent,
                date: document.getElementById('fieldProgramRequestDate').value,
                branch: document.getElementById('fieldProgramBranch').value,
                items: items,
                notes: document.getElementById('fieldProgramNotes').value,
                signature: document.getElementById('fieldProgramSignature').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage
            try {
                const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
                requests.push(request);
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                
                // Also save to API if available
                try {
                    fetch('/api/field_program_requests', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    }).catch(e => console.debug('API save failed:', e));
                } catch (e) {}
                
                alert('‚úÖ Stock request submitted successfully!');
                closeFieldProgramRequestForm();
                displayFieldProgramRequests();
            } catch (error) {
                console.error('Error saving request:', error);
                alert('‚ùå Error saving request. Please try again.');
            }
        }

        function refreshFieldProgramRequests() {
            displayFieldProgramRequests();
        }

        function approveFieldProgramRequest(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (request && request.status === 'pending') {
                request.status = 'approved';
                request.approvedBy = (window.currentUser && window.currentUser.fullName) || 'System';
                request.approvedAt = new Date().toISOString();
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                displayFieldProgramRequests();
                alert('‚úÖ Request approved! You can now issue stock using FEFO.');
            }
        }

        function rejectFieldProgramRequest(requestId) {
            if (!confirm('Are you sure you want to reject this request?')) return;
            
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (request) {
                request.status = 'rejected';
                request.rejectedBy = (window.currentUser && window.currentUser.fullName) || 'System';
                request.rejectedAt = new Date().toISOString();
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                displayFieldProgramRequests();
            }
        }

        function issueFieldProgramStock(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (!request || request.status !== 'approved') {
                alert('Request not found or not approved');
                return;
            }
            
            // Open issuing modal with FEFO interface
            openFieldProgramIssuingModal(request);
        }

        function openFieldProgramIssuingModal(request) {
            const modal = document.getElementById('fieldProgramIssuingModal');
            const content = document.getElementById('fieldProgramIssuingContent');
            
            if (!modal || !content) return;
            
            content.innerHTML = `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è FEFO Compliance Required</h3>
                    <p style="margin: 0; color: #856404;">Stock must be issued following First Expired First Out (FEFO) principles. Scan barcode for each item to record batch/expiry data.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Request Details</h4>
                    <p><strong>Distributor:</strong> ${request.distributorName} (${request.distributorCode})</p>
                    <p><strong>Branch:</strong> ${request.branch}</p>
                    <p><strong>Request Date:</strong> ${new Date(request.date).toLocaleDateString()}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Items to Issue (Scan Barcode for Each)</h4>
                    <div id="fieldProgramIssuingItems">
                        ${request.items.map((item, idx) => `
                            <div class="issuing-item" data-product="${item.product}" data-requested-qty="${item.quantity}" style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0;">${item.product}</h5>
                                <p><strong>Requested:</strong> ${item.quantity} ${item.unit || 'units'}</p>
                                <div style="margin-top: 10px;">
                                    <label>Scan Barcode or Enter Batch Number:</label>
                                    <input type="text" class="barcode-input" placeholder="Scan barcode or enter batch" 
                                           onchange="handleFieldProgramBarcodeScan(this, '${item.product}', ${item.quantity})" 
                                           style="width: 100%; padding: 8px; margin-top: 5px;">
                                </div>
                                <div class="scanned-items" style="margin-top: 10px;">
                                    <p><strong>Scanned Items:</strong> <span class="scanned-count">0</span> / ${item.quantity}</p>
                                    <div class="scanned-list" style="max-height: 150px; overflow-y: auto; margin-top: 5px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="completeFieldProgramIssuing('${request.id}')" style="flex: 1;">‚úÖ Complete Issuing</button>
                    <button class="btn btn-secondary" onclick="closeFieldProgramIssuing()">Cancel</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function handleFieldProgramBarcodeScan(input, productName, requestedQty) {
            const barcode = input.value.trim();
            if (!barcode) return;
            
            const itemDiv = input.closest('.issuing-item');
            const scannedList = itemDiv.querySelector('.scanned-list');
            const scannedCount = itemDiv.querySelector('.scanned-count');
            const currentScanned = parseInt(scannedCount.textContent) || 0;
            
            if (currentScanned >= requestedQty) {
                alert('Requested quantity already scanned');
                input.value = '';
                return;
            }
            
            // Try to get stock data (this would typically come from stock management system)
            // For now, create a record with barcode data
            const scannedItem = {
                barcode: barcode,
                product: productName,
                scannedAt: new Date().toISOString(),
                scannedBy: (window.currentUser && window.currentUser.fullName) || 'System'
            };
            
            // Add to scanned list
            const itemElement = document.createElement('div');
            itemElement.style.cssText = 'padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem;';
            itemElement.innerHTML = `
                <strong>Barcode:</strong> ${barcode}<br>
                <small>Scanned: ${new Date().toLocaleString()}</small>
                <button onclick="removeScannedItem(this)" style="float: right; padding: 2px 8px; font-size: 0.8rem;">Remove</button>
            `;
            itemElement.dataset.barcode = barcode;
            scannedList.appendChild(itemElement);
            
            scannedCount.textContent = currentScanned + 1;
            input.value = '';
            
            // Store scanned items in data attribute
            if (!itemDiv.dataset.scannedItems) {
                itemDiv.dataset.scannedItems = JSON.stringify([]);
            }
            const scannedItems = JSON.parse(itemDiv.dataset.scannedItems);
            scannedItems.push(scannedItem);
            itemDiv.dataset.scannedItems = JSON.stringify(scannedItems);
        }

        function removeScannedItem(button) {
            const itemElement = button.closest('div');
            const itemDiv = itemElement.closest('.issuing-item');
            const scannedCount = itemDiv.querySelector('.scanned-count');
            const currentCount = parseInt(scannedCount.textContent) || 0;
            
            // Remove from data
            const scannedItems = JSON.parse(itemDiv.dataset.scannedItems || '[]');
            const barcode = itemElement.dataset.barcode;
            const filtered = scannedItems.filter(item => item.barcode !== barcode);
            itemDiv.dataset.scannedItems = JSON.stringify(filtered);
            
            itemElement.remove();
            scannedCount.textContent = Math.max(0, currentCount - 1);
        }

        function completeFieldProgramIssuing(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                alert('Request not found');
                return;
            }
            
            // Collect all scanned items
            const issuingItems = document.querySelectorAll('.issuing-item');
            const issuedItems = [];
            let allComplete = true;
            
            issuingItems.forEach(itemDiv => {
                const product = itemDiv.dataset.product;
                const requestedQty = parseInt(itemDiv.dataset.requestedQty);
                const scannedCount = parseInt(itemDiv.querySelector('.scanned-count').textContent) || 0;
                const scannedItems = JSON.parse(itemDiv.dataset.scannedItems || '[]');
                
                if (scannedCount < requestedQty) {
                    allComplete = false;
                }
                
                issuedItems.push({
                    product: product,
                    requestedQty: requestedQty,
                    issuedQty: scannedCount,
                    scannedItems: scannedItems
                });
            });
            
            if (!allComplete) {
                if (!confirm('Not all items have been fully scanned. Continue anyway?')) {
                    return;
                }
            }
            
            // Update request
            request.status = 'issued';
            request.issuedBy = (window.currentUser && window.currentUser.fullName) || 'System';
            request.issuedAt = new Date().toISOString();
            request.issuedItems = issuedItems;
            
            // Save
            localStorage.setItem('field_program_requests', JSON.stringify(requests));
            
            // Record in stock audit
            try {
                const audit = JSON.parse(localStorage.getItem('dyna_stock_audit') || '[]');
                audit.push({
                    id: 'AUD' + Date.now(),
                    action: 'field_program_issue',
                    details: {
                        requestId: request.id,
                        requestNumber: request.requestNumber,
                        distributor: request.distributorCode,
                        branch: request.branch,
                        items: issuedItems
                    },
                    timestamp: new Date().toISOString(),
                    user: (window.currentUser && window.currentUser.fullName) || 'System'
                });
                localStorage.setItem('dyna_stock_audit', JSON.stringify(JSON.stringify(audit).length > 50000 ? audit.slice(-1000) : audit));
            } catch (e) {
                console.error('Error saving audit:', e);
            }
            
            alert('‚úÖ Stock issued successfully with FEFO compliance!');
            closeFieldProgramIssuing();
            displayFieldProgramRequests();
        }

        function closeFieldProgramIssuing() {
            document.getElementById('fieldProgramIssuingModal').style.display = 'none';
        }

        function printFieldProgramRequestPDF(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (!request) {
                alert('Request not found');
                return;
            }
            
            // Create PDF content
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add logo and header
            doc.setFillColor(196, 30, 58); // Dynapharm red
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('DYNAPHARM NAMIBIA', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Field Program Stock Request', 105, 22, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            let yPos = 40;
            
            // Request Details
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Request Details', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Request Number: ${request.requestNumber || request.id}`, 10, yPos);
            yPos += 6;
            doc.text(`Date: ${new Date(request.date).toLocaleDateString()}`, 10, yPos);
            yPos += 6;
            doc.text(`Branch: ${request.branch}`, 10, yPos);
            yPos += 10;
            
            // Distributor Information
            doc.setFont('helvetica', 'bold');
            doc.text('Distributor Information', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Name: ${request.distributorName}`, 10, yPos);
            yPos += 6;
            doc.text(`NB Number: ${request.distributorCode}`, 10, yPos);
            yPos += 6;
            doc.text(`Mobile: ${request.distributorMobile}`, 10, yPos);
            yPos += 10;
            
            // Requested Items
            doc.setFont('helvetica', 'bold');
            doc.text('Requested Items', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            request.items.forEach((item, idx) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(`${idx + 1}. ${item.product} - ${item.quantity} ${item.unit || 'units'}`, 15, yPos);
                yPos += 6;
            });
            yPos += 5;
            
            // Notes
            if (request.notes) {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Notes:', 10, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                const notesLines = doc.splitTextToSize(request.notes, 190);
                doc.text(notesLines, 10, yPos);
                yPos += notesLines.length * 6 + 5;
            }
            
            // Terms and Conditions
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('Terms and Conditions of Stock Handling Commitment', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const terms = [
                '1. Stock Accountability: The distributor is fully responsible for all stock received.',
                '2. FEFO Compliance: Stock will be issued following First Expired First Out principles.',
                '3. Storage Requirements: Stock must be stored in appropriate conditions.',
                '4. Damage/Loss Reporting: Any damaged or lost stock must be reported immediately.',
                '5. Return Policy: Unused stock may be returned within 30 days if in original condition.',
                '6. Sales Records: Complete sales records must be maintained and submitted.',
                '7. Payment Terms: Payment for stock must be made according to agreed terms.',
                '8. Compliance: All stock must be used/sold in compliance with Dynapharm policies.'
            ];
            
            terms.forEach(term => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                const lines = doc.splitTextToSize(term, 190);
                doc.text(lines, 10, yPos);
                yPos += lines.length * 5 + 3;
            });
            
            // Signature
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('Distributor Signature:', 10, yPos);
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(request.signature || 'N/A', 10, yPos);
            yPos += 10;
            doc.line(10, yPos, 80, yPos);
            doc.setFontSize(8);
            doc.text('Signature', 10, yPos + 5);
            
            // Status
            if (request.status) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(196, 30, 58);
                doc.text(`Status: ${request.status.toUpperCase()}`, 150, yPos - 10);
                if (request.approvedBy) {
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Approved by: ${request.approvedBy}`, 150, yPos - 5);
                    doc.text(`Date: ${new Date(request.approvedAt).toLocaleDateString()}`, 150, yPos);
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 105, 285, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 290, { align: 'center' });
            }
            
            // Save PDF
            doc.save(`FieldProgramRequest_${request.requestNumber || request.id}.pdf`);
        }

        function getUploadedBonusList() {
            try {
                const raw = localStorage.getItem('finance_bonus_list');
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (!data || !Array.isArray(data.items)) return null;
                return data; // { month, items }
            } catch(e) { return null; }
        }

        function sumPaidBonusFor(distributorNB, ym) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const ymStr = String(ym || '').slice(0,7);
            const toYm = (d) => String(d || '').slice(0,7);
            const cash = (Array.isArray(typeof cashBonuses !== 'undefined' ? cashBonuses : []) ? cashBonuses : []);
            const bank = (Array.isArray(typeof bankBonuses !== 'undefined' ? bankBonuses : []) ? bankBonuses : []);
            let total = 0;
            cash.forEach(b => {
                if (b?.distributorNB && b.distributorNB.trim() === distributorNB && toYm(b.date) === ymStr) total += Number(b.amount || 0);
            });
            bank.forEach(b => {
                if (b?.distributorNB && b.distributorNB.trim() === distributorNB && toYm(b.date) === ymStr) total += Number(b.amount || 0);
            });
            return total;
        }

        function renderDispenserPendingBonuses() {
            const listEl = document.getElementById('dispenserPendingBonusList');
            const summaryEl = document.getElementById('dispenserBonusSummary');
            if (!listEl) return;
            const monthInput = document.getElementById('dispenserBonusMonth');
            const search = (document.getElementById('dispenserBonusSearch')?.value || '').trim().toLowerCase();
            const ym = monthInput?.value || '';

            const upload = getUploadedBonusList();
            if (!upload || !Array.isArray(upload.items) || (upload.month && ym && upload.month !== ym)) {
                listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No uploaded bonus list for selected month</p>';
                if (summaryEl) summaryEl.textContent = '';
                return;
            }

            // Normalize items to { nb, name, branch, amount }
            const norm = upload.items.map(row => {
                const obj = (Array.isArray(row) ? {} : row) || {};
                // Try common keys
                const nb = (obj.NB || obj.DRN || obj.drn || obj.nb || obj.Id || obj.id || obj['Distributor NB'] || obj['Distributor'] || obj['DRN']).toString?.() || '';
                const name = (obj.NAME || obj.Name || obj.name || obj['Distributor Name'] || obj['Distributor']).toString?.() || '';
                const branch = (obj.Branch || obj.BRANCH || obj.branch || obj.Location || obj.location || '').toString?.() || '';
                // Amount: try several keys
                const amountRaw = obj.Amount ?? obj.AMOUNT ?? obj.amount ?? obj['Bonus'] ?? obj['BONUS'] ?? obj['Value'] ?? 0;
                const amount = Number(normalizeBonusAmount ? normalizeBonusAmount(amountRaw) : (parseFloat(String(amountRaw).replace(/[^0-9.\-]/g,'')) || 0));
                return { nb: String(nb).trim(), name: String(name).trim(), branch: String(branch).trim(), amount };
            }).filter(x => x.nb);

            let totalPending = 0;
            let totalCount = 0;

            const rows = norm
                .map(item => {
                    const paid = sumPaidBonusFor(item.nb, ym);
                    const outstanding = Math.max(0, Number(item.amount || 0) - Number(paid || 0));
                    return { ...item, paid, outstanding };
                })
                .filter(it => it.outstanding > 0)
                .filter(it => !search || it.nb.toLowerCase().includes(search) || it.name.toLowerCase().includes(search));

            rows.forEach(r => { totalPending += r.outstanding; totalCount++; });
            if (summaryEl) summaryEl.innerHTML = `Pending: <strong>${totalCount}</strong> distributors, Total Outstanding: <strong>N$ ${totalPending.toFixed(2)}</strong>`;

            if (rows.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No pending bonuses</p>';
                return;
            }

            listEl.innerHTML = rows.map(r => `
                <div class="client-card" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div>
                        <div style="font-weight: 700; color: #2c3e50;">${r.name}</div>
                        <div style="color: #7f8c8d; font-size: 0.9rem;">NB: ${r.nb} ‚Ä¢ Branch: ${r.branch || '‚Äî'}</div>
                        <div style="margin-top: 6px; font-size: 0.9rem;">
                            Uploaded: <strong>N$ ${Number(r.amount).toFixed(2)}</strong> ‚Ä¢ Paid: <strong>N$ ${Number(r.paid).toFixed(2)}</strong> ‚Ä¢ Outstanding: <strong style="color:#c41e3a;">N$ ${Number(r.outstanding).toFixed(2)}</strong>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success" onclick="openDispenserBonusPayout('${r.nb}', '${r.name.replace(/'/g, "\'")}', '${r.branch.replace(/'/g, "\'")}', '${ym}', ${Number(r.outstanding).toFixed(2)})">üíµ Pay</button>
                        <button class="btn" onclick="showDistributorBonusHistory('${r.nb}')">üìú History</button>
                    </div>
                </div>
            `).join('');
        }

        function openDispenserBonusPayout(nb, name, branch, ym, maxAmount) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'dispenserBonusPayoutModal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:520px;">
                    <span class="close" onclick="closeModal('dispenserBonusPayoutModal')">&times;</span>
                    <h2>üéÅ Record Bonus Payout</h2>
                    <div class="form-group"><label>Distributor</label><input type="text" value="${name} (${nb})" disabled></div>
                    <div class="form-group"><label>Month</label><input type="text" value="${ym}" disabled></div>
                    <div class="form-group"><label>Branch</label><input type="text" value="${branch || ''}" disabled></div>
                    <div class="form-group"><label>Amount (N$)</label><input type="number" id="dispenserBonusAmount" step="0.01" min="0.01" max="${Number(maxAmount).toFixed(2)}" value="${Number(maxAmount).toFixed(2)}"></div>
                    <div class="form-group"><label>Reason</label><input type="text" id="dispenserBonusReason" placeholder="Monthly bonus" value="Monthly bonus"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="recordDispenserBonusPayout('${nb}','${name.replace(/'/g, "\'")}', '${branch.replace(/'/g, "\'")}', '${ym}')">üíæ Save & Print</button>
                        <button class="btn" onclick="closeModal('dispenserBonusPayoutModal')">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function recordDispenserBonusPayout(nb, name, branch, ym) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const amtEl = document.getElementById('dispenserBonusAmount');
            const reasonEl = document.getElementById('dispenserBonusReason');
            const amount = parseFloat(amtEl?.value || '0');
            if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }
            const today = new Date();
            const dateStr = `${ym}-01`;
            const payout = {
                id: 'BNS' + Date.now(),
                branch: branch || (currentUser?.branch || ''),
                distributorNB: nb,
                distributorName: name,
                date: dateStr,
                amount: amount,
                reason: reasonEl?.value || 'Monthly bonus',
                approvedBy: currentUser?.username || 'Dispenser',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'Dispenser',
                method: 'cash',
                source: 'dispenser'
            };
            if (!Array.isArray(cashBonuses)) { window.cashBonuses = []; }
            cashBonuses.push(payout);
            try { saveEnhancedFinanceData && saveEnhancedFinanceData(); } catch(e) {
                localStorage.setItem('finance_bonuses', JSON.stringify(cashBonuses));
            }
            try { refreshFinancialDashboard && refreshFinancialDashboard(); } catch(e) {}
            closeModal('dispenserBonusPayoutModal');
            renderDispenserPendingBonuses();
            openBonusReceiptWindow(payout, 'a4');
        }

        function showDistributorBonusHistory(nb) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const payouts = [];
            (Array.isArray(cashBonuses) ? cashBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Cash' }); });
            (Array.isArray(bankBonuses) ? bankBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Bank' }); });
            payouts.sort((a,b) => String(b.createdAt||b.date).localeCompare(String(a.createdAt||a.date)));

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'distributorBonusHistoryModal';
            modal.style.display = 'block';
            const name = payouts[0]?.distributorName || nb;
            modal.innerHTML = `
                <div class="modal-content" style="max-width:760px;">
                    <span class="close" onclick="closeModal('distributorBonusHistoryModal')">&times;</span>
                    <h2>üìú Bonus History - ${name} (${nb})</h2>
                    <div style="max-height: 420px; overflow:auto; border:1px solid #eee; border-radius:8px;">
                        <table style="width:100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Date</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Amount</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Channel</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payouts.map(p => `
                                    <tr>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${(p.date||'').slice(0,10)}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">N$ ${Number(p.amount||0).toFixed(2)}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${p.channel}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${p.reason||''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:12px; display:flex; gap:10px;">
                        <button class="btn" onclick="printDistributorBonusHistory('${nb}')">üñ®Ô∏è Print PDF</button>
                        <button class="btn" onclick="closeModal('distributorBonusHistoryModal')">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printDistributorBonusHistory(nb) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const payouts = [];
            (Array.isArray(cashBonuses) ? cashBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Cash' }); });
            (Array.isArray(bankBonuses) ? bankBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Bank' }); });
            payouts.sort((a,b) => String(a.date).localeCompare(String(b.date)));
            const name = payouts[0]?.distributorName || nb;
            const win = window.open('', '_blank');
            const today = new Date().toISOString().slice(0,10);
            const rows = payouts.map(p => `
                <tr>
                    <td>${(p.date||'').slice(0,10)}</td>
                    <td>N$ ${Number(p.amount||0).toFixed(2)}</td>
                    <td>${p.channel}</td>
                    <td>${p.reason||''}</td>
                </tr>
            `).join('');
            win.document.write(`
                <html><head><title>Bonus History - ${name}</title>
                <style>@media print {@page { size: A4; margin: 16mm; }} body{font-family:Arial, sans-serif; color:#2c3e50;} table{width:100%; border-collapse:collapse;} th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}</style>
                </head><body>
                <h2>Bonus History</h2>
                <div>Distributor: <strong>${name} (${nb})</strong></div>
                <div>Date: ${today}</div>
                <hr/>
                <table><thead><tr><th>Date</th><th>Amount</th><th>Channel</th><th>Reason</th></tr></thead><tbody>${rows}</tbody></table>
                </body></html>
            `);
            win.document.close();
            win.focus();
            win.print();
        }

        function openBonusReceiptWindow(payout, format) {
            const win = window.open('', '_blank');
            const branch = payout.branch || '';
            const name = payout.distributorName || payout.distributorNB;
            const date = (payout.date||'').slice(0,10);
            const amount = Number(payout.amount||0).toFixed(2);
            const small = format === 'receipt';
            const style = small ? '@page { size: 80mm auto; margin: 6mm; } body{font-size:12px;}' : '@page { size: A4; margin: 16mm; } body{font-size:14px;}';
            win.document.write(`
                <html><head><title>Bonus Receipt</title><style>${style} body{font-family: Arial, sans-serif; color:#2c3e50;} .muted{color:#7f8c8d} .sign{margin-top:40px;}
                .row{display:flex; justify-content:space-between; margin:6px 0;}
                </style></head><body>
                <h2 style="margin:0 0 8px 0;">Bonus Payment Acknowledgement</h2>
                <div class="muted">Receipt No: ${payout.id}</div>
                <div class="muted">Date: ${date}</div>
                <hr/>
                <div class="row"><div>Distributor:</div><div><strong>${name}</strong> (${payout.distributorNB})</div></div>
                <div class="row"><div>Branch:</div><div>${branch}</div></div>
                <div class="row"><div>Amount:</div><div><strong>N$ ${amount}</strong></div></div>
                <div class="row"><div>Reason:</div><div>${payout.reason||''}</div></div>
                <div class="row"><div>Processed By:</div><div>${payout.createdBy||''}</div></div>
                <hr/>
                <div class="sign">
                    <div style="height:60px; border:1px dashed #bbb; margin-bottom:6px;"></div>
                    <div class="muted">Distributor Signature</div>
                </div>
                </body></html>
            `);
            win.document.close();
            win.focus();
            win.print();
        }

        function refreshDispenserData() {
            displayPrescriptions();
            displayPriceList();
            refreshBusinessIntelligence();
            displayCashDrawerStatus();
            refreshWalkInSalesList();
            refreshUnifiedSales(); // Add unified sales dashboard
            displayBranchInventory();
        }
        
        // Banking Functions
        function showBankDepositModal() {
            showBankDeposit();
        }
        
        function showCashDrawerModal() {
            const modal = document.createElement('div');
            modal.id = 'cashDrawerModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeModal('cashDrawerModal')">&times;</span>
                    <h2>üíµ Cash Drawer Management</h2>
                    <div id="cashDrawerDetails" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        ${document.getElementById('cashDrawerStatus')?.innerHTML || ''}
                    </div>
                    <button class="btn btn-success" onclick="openCashDrawer()">üîì Open Drawer</button>
                    <button class="btn btn-danger" onclick="closeCashDrawer()">üîí Close Drawer</button>
                    <button class="btn" onclick="closeModal('cashDrawerModal')">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showCashExpenseModal() {
            const modal = document.createElement('div');
            modal.id = 'expenseModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('expenseModal')">&times;</span>
                    <h2>üí∏ Record Cash Expense</h2>
                    <form id="expenseForm" onsubmit="submitExpense(event)">
                        <div class="form-group">
                            <label>Expense Type</label>
                            <select id="expenseType" required>
                                <option value="petty">Petty Cash</option>
                                <option value="transport">Transport</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount (N$)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="expenseDescription" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Submit</button>
                        <button type="button" class="btn" onclick="closeModal('expenseModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function submitExpense(e) {
            e.preventDefault();
            if (!branchCashSession || !branchCashSession.isOpen) {
                alert('Cash drawer is not open. Open the drawer before recording expenses.');
                return;
            }

            const type = document.getElementById('expenseType')?.value || 'other';
            const amountInput = document.getElementById('expenseAmount')?.value || '0';
            const description = document.getElementById('expenseDescription')?.value || type;
            const amount = parseFloat(amountInput);

            if (Number.isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }

            const branchId =
                (typeof getBranchId === 'function' && getBranchId()) ||
                (currentUser && currentUser.branch) ||
                'default';

            try {
                await createBranchCashMovement({
                    branchId,
                    sessionId: branchCashSession.id,
                    type: 'expense',
                    amount,
                    description,
                    notes: `Category: ${type}`,
                    recordedBy: currentUser?.fullName || currentUser?.username || 'system'
                });

                document.getElementById('expenseForm')?.reset();
                closeModal('expenseModal');
                alert('‚úÖ Expense recorded successfully!');
            } catch (error) {
                console.error('Failed to submit expense:', error);
                alert(`‚ùå Failed to record expense: ${error.message}`);
            }
        }
        
        function displayBankingHistory() {
            const container = document.getElementById('bankingOperations');
            if (!container) return;

            const branchId =
                (typeof getBranchId === 'function' && getBranchId()) ||
                (currentUser && currentUser.branch) ||
                'default';

            const depositsForBranch = (branchDeposits || []).filter(
                (deposit) => (deposit.branchId || deposit.branch) === branchId
            );

            if (depositsForBranch.length === 0) {
                container.innerHTML = `
                    <h4>Banking History</h4>
                    <p style="text-align: center; color: #666; padding: 20px;">No banking records found for this branch.</p>
                `;
                return;
            }

            const cards = depositsForBranch
                .sort((a, b) => new Date(b.createdAt || b.date || 0) - new Date(a.createdAt || a.date || 0))
                .map((deposit) => {
                    const amount = Number(deposit.amount || 0).toFixed(2);
                    const dateLabel = new Date(deposit.date || deposit.createdAt || Date.now()).toLocaleDateString();
                    const status = (deposit.status || 'pending').toLowerCase();
                    const statusColor =
                        status === 'approved' ? '#27ae60' : status === 'rejected' ? '#e74c3c' : '#f39c12';
                    return `
                        <div class="client-card" style="margin-bottom: 12px;">
                            <div style="display:flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h4 style="margin-bottom: 6px;">Slip ${deposit.slipNumber || deposit.id}</h4>
                                    <p style="margin: 0; color: #555;">Amount: <strong>N$ ${amount}</strong></p>
                                    <p style="margin: 0; color: #555;">Bank: ${deposit.bankName || 'N/A'} (${deposit.bankBranch || 'Branch'})</p>
                                    <p style="margin: 0; color: #555;">Deposited by: ${deposit.depositedBy || 'Unknown'} on ${dateLabel}</p>
                                    ${deposit.notes ? `<p style="margin-top: 6px; color: #777;">${deposit.notes}</p>` : ''}
                                    ${
                                        deposit.decisionNotes
                                            ? `<p style="margin-top: 6px; color: #555;"><strong>Finance Note:</strong> ${deposit.decisionNotes}</p>`
                                            : ''
                                    }
                                </div>
                                <div style="text-align: right;">
                                    <span style="display:inline-block; padding: 6px 12px; border-radius: 16px; background:${statusColor}; color:white; font-weight:600;">
                                        ${status.toUpperCase()}
                                    </span>
                                    <div style="margin-top: 12px; color:#888; font-size:0.85rem;">
                                        ${new Date(deposit.createdAt || deposit.date || Date.now()).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = `
                <h4>Banking History</h4>
                <div style="max-height: 520px; overflow-y: auto; padding-right: 8px;">
                    ${cards}
                </div>
            `;
        }

        // Branch Inventory (Dispenser Stock Tab)
        function getBranchId() {
            try {
                return (window.currentUser && window.currentUser.branch) || document.getElementById('branchSelect')?.value || 'unknown';
            } catch (e) { return 'unknown'; }
        }

        function displayBranchInventory() {
            const listEl = document.getElementById('branchInventoryList');
            if (!listEl) return;

            // Load branch-specific stock snapshot
            const branchId = getBranchId();
            let branchStockMap = {};
            try {
                const stockData = JSON.parse(localStorage.getItem('dyna_branch_stock') || '{}');
                branchStockMap = stockData && typeof stockData === 'object' ? (stockData[branchId] || {}) : {};
            } catch (e) { branchStockMap = {}; }

            // Load reorder levels from consolidated inventory to enrich branch view
            let masterInventory = {};
            try { masterInventory = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}'); } catch (_) { masterInventory = {}; }

            const search = (document.getElementById('branchInventorySearch')?.value || '').toLowerCase();

            const entries = Object.keys(branchStockMap).map(name => ({
                name,
                currentStock: Number(branchStockMap[name] || 0),
                reorderLevel: masterInventory[name]?.reorderLevel ?? 5
            })).filter(e => !search || e.name.toLowerCase().includes(search));

            if (entries.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:20px;">No inventory records found for this branch.</p>';
                return;
            }

            const rows = entries.map(e => {
                const low = e.currentStock <= e.reorderLevel;
                return `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${e.name}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right; font-weight:700; color:${low ? '#e74c3c' : '#27ae60'};">${e.currentStock}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${e.reorderLevel}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${low ? '‚ö†Ô∏è Low' : '‚úÖ OK'}</td>
                    </tr>`;
            }).join('');

            listEl.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Product</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Qty</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Reorder</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }

        function searchBranchInventory() { displayBranchInventory(); }
        function showAllBranchInventory() {
            const el = document.getElementById('branchInventorySearch');
            if (el) { el.value = ''; }
            displayBranchInventory();
        }

        // ==========================
        // Branch Inventory Management with Restrictions
        // ==========================
        let branchInventoryData = [];
        let branchStockMovements = [];

        // Check if user has access to sensitive inventory data
        function hasInventoryFullAccess() {
            const user = window.currentUser || {};
            const role = user.role || '';
            return ['gm', 'director', 'admin', 'stock'].includes(role.toLowerCase());
        }

        async function refreshBranchInventory({ notify = false } = {}) {
            await loadBranchInventory({ notify });
            await loadBranchStockMovements({ notify });
            updateBranchInventoryKPIs();
        }

        async function loadBranchInventory({ notify = false } = {}) {
                const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            await syncBranchInventoryFromApi({ branchId, notify });
                const noticeEl = document.getElementById('branchInventoryRestrictedNotice');
            if (noticeEl) {
                noticeEl.style.display = !hasInventoryFullAccess() ? 'block' : 'none';
            }
        }

        function filterBranchInventory() {
            const searchTerm = (document.getElementById('branchInventorySearch')?.value || '').toLowerCase();
            const category = document.getElementById('branchInventoryCategory')?.value || 'all';
            const sortBy = document.getElementById('branchInventorySort')?.value || 'name';
            const tbody = document.getElementById('branchInventoryTableBody');
            
            if (!tbody) return;

            let filtered = [...branchInventoryData];

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.product || '').toLowerCase().includes(searchTerm) ||
                    (item.batchNo || '').toLowerCase().includes(searchTerm)
                );
            }

            // Filter by category
            if (category === 'low') {
                filtered = filtered.filter(item => item.status === 'low_stock');
            } else if (category === 'out') {
                filtered = filtered.filter(item => item.status === 'out_of_stock' || (item.quantity || 0) === 0);
            } else if (category === 'expiring') {
                const now = new Date();
                const threeMonths = new Date(now.getFullYear(), now.getMonth() + 3, now.getDate());
                filtered = filtered.filter(item => {
                    if (!item.expiryDate) return false;
                    const expiry = new Date(item.expiryDate + '-01');
                    return expiry <= threeMonths && expiry > now;
                });
            }

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'stock':
                        return (b.quantity || 0) - (a.quantity || 0);
                    case 'expiry':
                        if (!a.expiryDate && !b.expiryDate) return 0;
                        if (!a.expiryDate) return 1;
                        if (!b.expiryDate) return -1;
                        return new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01');
                    default:
                        return (a.product || '').localeCompare(b.product || '');
                }
            });

            // Render table
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="stock-empty-state">No inventory items found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const statusClass = item.status === 'low_stock' ? 'warn' : item.status === 'out_of_stock' || (item.quantity || 0) === 0 ? 'bad' : 'good';
                const statusText = item.status === 'low_stock' ? 'Low Stock' : item.status === 'out_of_stock' || (item.quantity || 0) === 0 ? 'Out of Stock' : 'In Stock';
                const expiryDate = item.expiryDate ? new Date(item.expiryDate + '-01').toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) : 'N/A';
                const totalValue = (item.quantity || 0) * (item.unitPrice || 0);
                const actions = hasInventoryFullAccess() ? `<button class="stock-inline-btn" onclick="editBranchInventoryItem('${item.id || ''}')">Edit</button>` : '';

                return `
                    <tr class="stock-table-row">
                        <td class="stock-cell">${item.product || 'N/A'}</td>
                        <td class="stock-cell">${item.batchNo || 'N/A'}</td>
                        <td class="stock-cell stock-cell--qty">${item.quantity || 0}</td>
                        <td class="stock-cell stock-cell--expiry">${expiryDate}</td>
                        <td class="stock-cell stock-cell--price">N$${(item.unitPrice || 0).toFixed(2)}</td>
                        <td class="stock-cell stock-cell--value">N$${totalValue.toFixed(2)}</td>
                        <td class="stock-cell stock-cell--status">
                            <span class="stock-status-badge stock-status-badge--${statusClass}">${statusText}</span>
                        </td>
                        <td class="stock-cell stock-cell--actions">${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateBranchInventoryKPIs() {
            const totalProducts = branchInventoryData.length;
            const totalValue = branchInventoryData.reduce((sum, item) => sum + ((item.quantity || 0) * (item.unitPrice || 0)), 0);
            const lowStock = branchInventoryData.filter(item => item.status === 'low_stock').length;
            const outOfStock = branchInventoryData.filter(item => item.status === 'out_of_stock' || (item.quantity || 0) === 0).length;

            const totalProductsEl = document.getElementById('branchInventoryTotalProducts');
            const totalValueEl = document.getElementById('branchInventoryTotalValue');
            const lowStockEl = document.getElementById('branchInventoryLowStock');
            const outOfStockEl = document.getElementById('branchInventoryOutOfStock');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (totalValueEl) totalValueEl.textContent = `N$${totalValue.toFixed(2)}`;
            if (lowStockEl) lowStockEl.textContent = lowStock;
            if (outOfStockEl) outOfStockEl.textContent = outOfStock;
        }

        async function loadBranchStockMovements({ notify = false } = {}) {
                const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            await syncBranchMovementsFromApi({ branchId, notify });

                const movementsEl = document.getElementById('branchInventoryMovements');
                if (!movementsEl) return;

            let branchMovements = [...branchStockMovements];

                if (!hasInventoryFullAccess()) {
                    branchMovements = branchMovements.filter(m => {
                    if (m.metadata?.isExpectedStock && !m.metadata?.gmApproved) return false;
                    if (m.metadata?.isStockLoss || m.type === 'loss') return false;
                    if (m.metadata?.isSensitive || m.metadata?.sensitive) return false;
                        return true;
                    });
                }

                if (branchMovements.length === 0) {
                    movementsEl.innerHTML = '<div class="stock-activity-empty">No stock movements recorded</div>';
                    return;
                }

            movementsEl.innerHTML = branchMovements
                .slice(0, 50)
                .map(movement => {
                    const variant =
                        movement.type === 'receive'
                            ? 'receive'
                            : movement.type === 'transfer_out'
                            ? 'transfer_out'
                            : movement.type === 'transfer_in'
                            ? 'transfer_in'
                            : movement.type === 'adjustment'
                            ? 'adjustment'
                            : 'default';
                    const actionIcon =
                        movement.type === 'receive'
                            ? 'üì•'
                            : movement.type === 'transfer_out'
                            ? 'üì§'
                            : movement.type === 'transfer_in'
                            ? 'üì•'
                            : movement.type === 'adjustment'
                            ? '‚úèÔ∏è'
                            : 'üìä';
                    const movementDate = new Date(movement.timestamp || Date.now());
                    const qtyText = typeof movement.quantity === 'number' ? `${movement.quantity} ${movement.unit || 'units'}` : '';
                    const metaSegments = [];
                    if (qtyText) metaSegments.push(qtyText);
                    metaSegments.push(movementDate.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }));
                    if (movement.user || movement.performedBy) metaSegments.push(`By ${movement.user || movement.performedBy}`);
                    if (movement.sourceBranch) metaSegments.push(`From ${movement.sourceBranch}`);
                    if (movement.destinationBranch) metaSegments.push(`To ${movement.destinationBranch}`);
                    if (movement.metadata?.reference || movement.reference) metaSegments.push(`Ref ${movement.metadata?.reference || movement.reference}`);
                    if (movement.metadata?.expiryDate || movement.expiryDate) {
                        const expiryRaw = movement.metadata?.expiryDate || movement.expiryDate;
                        const expiry = new Date((expiryRaw?.length === 7 ? `${expiryRaw}-01` : expiryRaw));
                        if (!Number.isNaN(expiry.getTime())) {
                            metaSegments.push(`Expiry ${expiry.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })}`);
                        }
                    }
                    const meta = metaSegments.length ? metaSegments.map(part => `<span>${part}</span>`).join('') : '<span>Details unavailable</span>';
                    const note = movement.notes || movement.metadata?.note || movement.metadata?.reason || '';

                    return `
                        <article class="stock-activity-item">
                            <div class="stock-activity-icon" data-variant="${variant}">${actionIcon}</div>
                            <div class="stock-activity-body">
                                <h4 class="stock-activity-title">${movement.productName || movement.product || movement.description || 'Inventory Update'}</h4>
                                <div class="stock-activity-meta">${meta}</div>
                                ${note ? `<p class="stock-activity-note">${note}</p>` : ''}
                            </div>
                        </article>
                    `;
                })
                .join('');
        }

        function openBranchStockReceiveModal() {
            const modal = document.getElementById('branchStockReceiveModal');
            if (!modal) return;

            // Reset form
            document.getElementById('branchStockReceiveForm').reset();

            // Load products
            const productSelect = document.getElementById('receiveProductSelect');
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                PRICE_LIST.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.description;
                    option.textContent = product.description;
                    productSelect.appendChild(option);
                });
            }

            modal.style.display = 'block';
        }

        function closeBranchStockReceiveModal() {
            document.getElementById('branchStockReceiveModal').style.display = 'none';
        }

        async function submitBranchStockReceive(event) {
            event.preventDefault();
            
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const product = document.getElementById('receiveProductSelect').value;
            const batchNo = document.getElementById('receiveBatchNo').value;
            const expiryDate = document.getElementById('receiveExpiryDate').value;
            const quantity = parseInt(document.getElementById('receiveQuantity').value);
            const unit = document.getElementById('receiveUnit').value || 'units';
            const source = document.getElementById('receiveSource').value;
            const notes = document.getElementById('receiveNotes').value;

            if (!product || !batchNo || !expiryDate || !quantity) {
                alert('Please fill in all required fields');
                return;
            }

            // Check if this is expected stock (requires GM approval)
            const isExpectedStock = source === 'warehouse' && quantity > 100; // Threshold for GM approval
            
            if (isExpectedStock && !hasInventoryFullAccess()) {
                // Create expected stock request for GM approval
                const expectedStockRequest = {
                    id: 'ESR' + Date.now(),
                    type: 'expected_stock',
                    branch: branchId,
                    product: product,
                    batchNo: batchNo,
                    expiryDate: expiryDate,
                    quantity: quantity,
                    unit: unit,
                    notes: notes,
                    status: 'pending',
                    requestedBy: (window.currentUser && window.currentUser.fullName) || 'System',
                    requestedAt: new Date().toISOString(),
                    requiresGMApproval: true
                };

                const pendingRequests = JSON.parse(localStorage.getItem('gm_inventory_approvals') || '[]');
                pendingRequests.push(expectedStockRequest);
                localStorage.setItem('gm_inventory_approvals', JSON.stringify(pendingRequests));

                alert('‚ö†Ô∏è Expected stock request submitted for GM approval. You will be notified once approved.');
                closeBranchStockReceiveModal();
                return;
            }

            // Get product price
            let unitPrice = 0;
            if (typeof PRICE_LIST !== 'undefined') {
                const prod = PRICE_LIST.find(p => p.description === product);
                if (prod) unitPrice = prod.cp || prod.dp || 0;
            }

            try {
                await postBranchInventoryAction('receive', {
                    branchId,
                    productName: product,
                    productCode: null,
                    batchNo,
                    expiryDate,
                    quantity,
                    unit,
                    unitPrice,
                    source,
                    notes,
                    metadata: {
                        unit,
                        isExpectedStock,
                    gmApproved: hasInventoryFullAccess() || !isExpectedStock
                    }
                });

                alert('‚úÖ Stock received successfully!');
                closeBranchStockReceiveModal();
                filterBranchInventory();
                updateBranchInventoryKPIs();
                loadBranchStockMovements();
            } catch (error) {
                console.error('Error saving stock:', error);
                alert(`‚ùå Error saving stock: ${error.message || error}`);
            }
        }

        function openBranchStockTransferModal() {
            const modal = document.getElementById('branchStockTransferModal');
            if (!modal) return;

            // Reset form
            document.getElementById('branchStockTransferForm').reset();

            // Set from branch
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const branchName = (typeof branches !== 'undefined' && Array.isArray(branches)) ? branches.find(b => b.id === branchId)?.name || branchId : branchId;
            document.getElementById('transferFromBranch').value = branchName;

            // Load destination branches
            const toBranchSelect = document.getElementById('transferToBranch');
            toBranchSelect.innerHTML = '<option value="">Select Destination Branch</option>';
            if (typeof branches !== 'undefined' && Array.isArray(branches)) {
                branches.forEach(branch => {
                    if (branch.id !== branchId) {
                        const option = document.createElement('option');
                        option.value = branch.id || branch.name;
                        option.textContent = branch.name;
                        toBranchSelect.appendChild(option);
                    }
                });
            }

            // Load products
            const productSelect = document.getElementById('transferProductSelect');
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                PRICE_LIST.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.description;
                    option.textContent = product.description;
                    productSelect.appendChild(option);
                });
            }

            modal.style.display = 'block';
        }

        function closeBranchStockTransferModal() {
            document.getElementById('branchStockTransferModal').style.display = 'none';
        }

        async function submitBranchStockTransfer(event) {
            event.preventDefault();
            
            const fromBranchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const toBranchId = document.getElementById('transferToBranch').value;
            const product = document.getElementById('transferProductSelect').value;
            const batchNo = document.getElementById('transferBatchNo').value;
            const quantity = parseInt(document.getElementById('transferQuantity').value);
            const notes = document.getElementById('transferNotes').value;

            if (!toBranchId || !product || !batchNo || !quantity) {
                alert('Please fill in all required fields');
                return;
            }

            const sourceItem = branchInventoryData.find(item => 
                item.product === product && item.batchNo === batchNo && item.branch === fromBranchId
            );

            if (!sourceItem || (sourceItem.quantity || 0) < quantity) {
                alert('Insufficient stock for transfer');
                return;
            }

            const expiryDate = sourceItem.expiryDate || null;
            const unit = sourceItem.unit || 'units';

            try {
                await postBranchInventoryAction('transfer', {
                    fromBranchId,
                    toBranchId,
                    productName: product,
                    batchNo,
                    quantity,
                    unit,
                    expiryDate,
                    notes,
                    metadata: {
                        initiatedBy: (window.currentUser && window.currentUser.fullName) || 'System'
                    }
                });

                alert('‚úÖ Stock transferred successfully!');
                closeBranchStockTransferModal();
                filterBranchInventory();
                updateBranchInventoryKPIs();
                loadBranchStockMovements();
            } catch (error) {
                console.error('Error transferring stock:', error);
                alert(`‚ùå Error transferring stock: ${error.message || error}`);
            }
        }

        async function editBranchInventoryItem(itemId) {
            if (!hasInventoryFullAccess()) {
                alert('‚ö†Ô∏è Access Denied: Stock adjustments require GM approval. Please contact your General Manager.');
                return;
            }

            const item = branchInventoryData.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }

            const newQuantity = prompt(`Current quantity: ${item.quantity}\n\nEnter new quantity:`, item.quantity);
            if (newQuantity === null) return;

            const qty = parseInt(newQuantity);
            if (isNaN(qty) || qty < 0) {
                alert('Invalid quantity');
                return;
            }

            const oldQty = item.quantity;
            const difference = qty - oldQty;
            const isLoss = difference < 0;

            // If it's a loss, require GM approval for non-GM users
            if (isLoss && !hasInventoryFullAccess()) {
                const lossRequest = {
                    id: 'SLR' + Date.now(),
                    type: 'stock_loss',
                    branch: item.branch,
                    product: item.product,
                    batchNo: item.batchNo,
                    quantity: Math.abs(difference),
                    oldQuantity: oldQty,
                    newQuantity: qty,
                    reason: prompt('Please provide reason for stock loss:') || 'Not specified',
                    status: 'pending',
                    requestedBy: (window.currentUser && window.currentUser.fullName) || 'System',
                    requestedAt: new Date().toISOString(),
                    requiresGMApproval: true
                };

                const pendingRequests = JSON.parse(localStorage.getItem('gm_inventory_approvals') || '[]');
                pendingRequests.push(lossRequest);
                localStorage.setItem('gm_inventory_approvals', JSON.stringify(pendingRequests));

                alert('‚ö†Ô∏è Stock loss adjustment submitted for GM approval. You will be notified once approved.');
                return;
            }

            try {
                await postBranchInventoryAction('adjust', {
                    branchId: item.branch,
                    productName: item.product,
                batchNo: item.batchNo,
                expiryDate: item.expiryDate,
                    quantity: qty,
                unit: item.unit || 'units',
                notes: `Adjustment: ${oldQty} ‚Üí ${qty}${isLoss ? ' (LOSS)' : ''}`,
                    metadata: {
                isStockLoss: isLoss,
                        previousQuantity: oldQty,
                        adjustedBy: (window.currentUser && window.currentUser.fullName) || 'System'
                    }
                });

                filterBranchInventory();
                updateBranchInventoryKPIs();
                loadBranchStockMovements();
            } catch (error) {
                console.error('Error updating inventory:', error);
                alert(`Error updating inventory: ${error.message || error}`);
            }
        }

        function exportBranchInventoryCSV() {
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const branchName = (typeof branches !== 'undefined' && Array.isArray(branches)) ? branches.find(b => b.id === branchId)?.name || branchId : branchId;
            
            const csv = [
                ['Product', 'Batch No', 'Quantity', 'Unit', 'Expiry Date', 'Unit Price', 'Total Value', 'Status'].join(','),
                ...branchInventoryData.map(item => [
                    `"${(item.product || '').replace(/"/g, '""')}"`,
                    `"${(item.batchNo || '').replace(/"/g, '""')}"`,
                    item.quantity || 0,
                    `"${(item.unit || 'units').replace(/"/g, '""')}"`,
                    item.expiryDate || '',
                    (item.unitPrice || 0).toFixed(2),
                    ((item.quantity || 0) * (item.unitPrice || 0)).toFixed(2),
                    `"${(item.status || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BranchInventory_${branchName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Cross-portal workflow shortcuts from Stock tab
        function openStockDashboard() {
            // Focus the integrated stock portal tab within this application
            if (typeof openTab === 'function') {
                openTab('stock');
                try { recordDepartmentEvent('open_stock_dashboard', { branch: getBranchId() }); } catch (e) {}
                return;
            }
            // Fallback: navigate to stock tab via hash
            window.location.hash = '#stock';
            try { recordDepartmentEvent('open_stock_dashboard', { branch: getBranchId() }); } catch (e) {}
        }
        function openMISFromStock() {
            window.open('mis-portal.html', '_blank');
            try { recordDepartmentEvent('handover_to_mis', { branch: getBranchId() }); } catch (e) {}
        }
        function openFinanceFromStock() {
            // Finance is a tab in the same app; if available, switch tab, else open report data
            if (typeof openTab === 'function') { try { openTab('finance'); } catch (e) {} }
            try { recordDepartmentEvent('handover_to_finance', { branch: getBranchId() }); } catch (e) {}
        }
        
        // Payment Functions (Unified with Finance)
        function showRecordPaymentModal() {
            const modal = document.createElement('div');
            modal.id = 'paymentModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            const today = new Date().toISOString().split('T')[0];
            const branchOptions = (window.branches || []).map(b => `<option value="${b}">${b}</option>`).join('');
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 640px;">
                    <span class="close" onclick="closeModal('paymentModal')">&times;</span>
                    <h2>üí≥ Record Payment</h2>
                    <form id="recordPaymentForm" onsubmit="submitPayment(event)">
                        <div class="form-group">
                            <label>Branch *</label>
                            <select id="paymentBranch" required>
                                <option value="">Select Branch</option>
                                ${branchOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="paymentDate" value="${today}" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name *</label>
                            <input type="text" id="paymentClient" list="clientList" required>
                            <datalist id="clientList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="paymentInvoice" required>
                        </div>
                        <div class="form-group">
                            <label>Amount (N$) *</label>
                            <input type="number" id="paymentAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="paymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reference</label>
                            <input type="text" id="paymentReference" placeholder="Txn ref / last 4 / slip no.">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="paymentNotes" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">üíæ Record Payment</button>
                            <button type="button" class="btn" onclick="closeModal('paymentModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            // Preselect branch if context is known
            try {
                const select = document.getElementById('paymentBranch');
                const financeSelect = document.getElementById('financeBranchSelect');
                const branchFromContext = (typeof getBranchId === 'function' && getBranchId()) || (financeSelect && financeSelect.value !== 'all' ? financeSelect.value : '');
                if (select && branchFromContext) select.value = branchFromContext;
            } catch (e) {}
        }
        
        function submitPayment(e) {
            e.preventDefault();
            const payment = {
                id: 'PAY' + Date.now(),
                branch: document.getElementById('paymentBranch')?.value || (typeof getBranchId === 'function' ? getBranchId() : ''),
                date: document.getElementById('paymentDate')?.value || new Date().toISOString().split('T')[0],
                client: document.getElementById('paymentClient')?.value || '',
                invoice: document.getElementById('paymentInvoice')?.value || '',
                amount: parseFloat(document.getElementById('paymentAmount')?.value || '0'),
                method: document.getElementById('paymentMethod')?.value || 'cash',
                reference: document.getElementById('paymentReference')?.value || '',
                notes: document.getElementById('paymentNotes')?.value || '',
                recordedBy: (window.currentUser && window.currentUser.fullName) || 'system',
                recordedAt: new Date().toISOString()
            };
            if (!payment.branch) { alert('Please select a branch'); return; }
            if (!payment.amount || payment.amount <= 0) { alert('Please enter a valid amount'); return; }
            const payments = JSON.parse(localStorage.getItem('finance_payments') || '[]');
            payments.push(payment);
            localStorage.setItem('finance_payments', JSON.stringify(payments));
            try { recordDepartmentEvent && recordDepartmentEvent('record_payment', { branch: payment.branch, amount: payment.amount, method: payment.method }); } catch (e) {}
            closeModal('paymentModal');
            displayPaymentHistory();
            try { refreshFinancialDashboard && refreshFinancialDashboard(); } catch (e) {}
            alert('Payment recorded successfully!');
        }
        
        function searchPayments() {
            displayPaymentHistory();
        }
        
        function displayPaymentHistory() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            const payments = JSON.parse(localStorage.getItem('finance_payments') || '[]');
            const branchFilter = (typeof getBranchId === 'function' && getBranchId()) || '';
            const term = (document.getElementById('paymentSearch')?.value || '').toLowerCase();
            const filtered = payments.filter(p => {
                const matchesBranch = !branchFilter || p.branch === branchFilter;
                const matchesTerm = !term || `${p.client} ${p.invoice}`.toLowerCase().includes(term);
                return matchesBranch && matchesTerm;
            }).sort((a,b)=> (b.recordedAt||'').localeCompare(a.recordedAt||''));
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No payment records found.</p>';
                return;
            }
            const rows = filtered.map(p => `
                <tr>
                    <td style="padding:10px; border:1px solid #ddd;">${new Date(p.date).toLocaleDateString()}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.branch}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.client}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.invoice}</td>
                    <td style="padding:10px; border:1px solid #ddd; text-align:right;">N$ ${Number(p.amount||0).toFixed(2)}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.method.replace('_',' ')}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.reference||''}</td>
                </tr>
            `).join('');
            container.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Date</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Branch</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Client</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Invoice</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Amount</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Method</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Reference</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }
        
        // Staff Functions
        const COMMUNICATION_STORAGE_KEY = 'dynapharm_portal_communications_v1';
        const STAFF_IDENTIFIER = 'staff';
        const COMMUNICATION_TARGETS = [
            { id: 'hr', label: 'HR', icon: 'üë•' },
            { id: 'gm', label: 'GM', icon: 'üëî' },
            { id: 'director', label: 'Director', icon: 'üéØ' },
            { id: 'finance', label: 'Finance', icon: 'üí∞' },
            { id: 'frontdesk', label: 'Front Desk', icon: 'üñ•Ô∏è' },
            { id: 'mis', label: 'MIS', icon: 'üìä' }
        ];
        const COMMUNICATION_TARGET_IDS = COMMUNICATION_TARGETS.map(p => p.id);
        let staffSubTabActive = 'services';
        let staffCommFilter = 'all';

        function getCommunicationMeta(id) {
            return COMMUNICATION_TARGETS.find(p => p.id === id) || { id, label: id.toUpperCase(), icon: 'üí¨' };
        }

        function escapeHTML(str) {
            return (str || '').replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch] || ch));
        }

        function getAllCommunications() {
            try {
                const raw = localStorage.getItem(COMMUNICATION_STORAGE_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.warn('Failed to load communications', e);
                return [];
            }
        }

        function saveAllCommunications(list) {
            try {
                localStorage.setItem(COMMUNICATION_STORAGE_KEY, JSON.stringify(list));
            } catch (e) {
                console.warn('Failed to save communications', e);
            }
        }

        function showStaffSubTab(tabName, evt) {
            if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
            staffSubTabActive = tabName;
            const section = document.getElementById('dispenserStaffSection');
            if (!section) return;
            section.querySelectorAll('.staff-subtab-btn').forEach(btn => {
                const btnTab = btn.dataset ? btn.dataset.tab : btn.getAttribute('data-tab');
                btn.classList.toggle('active', btnTab === tabName);
            });
            section.querySelectorAll('.staff-subtab-content').forEach(panel => {
                const isServices = tabName === 'services' && panel.id === 'staffServicesTab';
                const isComm = tabName === 'communications' && panel.id === 'staffCommunicationsTab';
                panel.classList.toggle('active', isServices || isComm);
            });
            if (tabName === 'communications') {
                renderStaffCommunications();
            }
        }

        function setStaffCommFilter(filter, evt) {
            if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
            staffCommFilter = filter;
            const containers = [
                document.getElementById('dispenserCommunicationSection'),
                document.getElementById('dispenserStaffSection')
            ].filter(Boolean);
            containers.forEach(section => {
                section.querySelectorAll('.staff-comm-filter-btn').forEach(btn => {
                    const btnFilter = btn.dataset ? btn.dataset.filter : btn.getAttribute('data-filter');
                    btn.classList.toggle('active', btnFilter === filter);
                });
            });
            renderStaffCommunications();
        }

        function toggleStaffRecipients(selectAll) {
            document.querySelectorAll('#staffCommRecipients input[name="staffCommRecipient"]').forEach(cb => {
                cb.checked = !!selectAll;
            });
        }

        function resetStaffCommunicationForm() {
            const form = document.getElementById('staffCommunicationForm');
            if (form) form.reset();
        }

        function submitStaffCommunication(event) {
            event.preventDefault();
            const recipients = Array.from(document.querySelectorAll('#staffCommRecipients input[name="staffCommRecipient"]:checked'))
                .map(cb => cb.value)
                .filter(id => COMMUNICATION_TARGET_IDS.includes(id));
            if (recipients.length === 0) {
                alert('Select at least one portal to send your message to.');
                return;
            }
            const messageInput = document.getElementById('staffCommMessage');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            if (!message) {
                alert('Enter a message before sending.');
                return;
            }
            const entry = {
                id: 'comm-' + Date.now(),
                from: STAFF_IDENTIFIER,
                fromName: (currentUser && currentUser.fullName) || 'Staff Member',
                to: recipients,
                message,
                createdAt: new Date().toISOString()
            };
            const communications = getAllCommunications();
            communications.push(entry);
            saveAllCommunications(communications);
            messageInput.value = '';
            renderStaffCommunications();
            recipients.forEach(portalId => renderPortalCommunications(portalId));
            alert('Communication sent successfully.');
        }

        function submitPortalCommunication(event, portalId) {
            event.preventDefault();
            const textarea = document.getElementById(`portalCommunicationMessage-${portalId}`);
            if (!textarea) return;
            const message = textarea.value.trim();
            if (!message) {
                alert('Enter a message before sending.');
                return;
            }
            const meta = getCommunicationMeta(portalId);
            const entry = {
                id: `comm-${Date.now()}-${portalId}`,
                from: portalId,
                fromName: (currentUser && currentUser.fullName) || meta.label,
                to: [STAFF_IDENTIFIER],
                message,
                createdAt: new Date().toISOString()
            };
            const communications = getAllCommunications();
            communications.push(entry);
            saveAllCommunications(communications);
            textarea.value = '';
            renderPortalCommunications(portalId);
            renderStaffCommunications();
            alert('Message sent to staff.');
        }

        function clearPortalCommunication(portalId) {
            const textarea = document.getElementById(`portalCommunicationMessage-${portalId}`);
            if (textarea) textarea.value = '';
        }

        function buildCommunicationHTML(entry, perspective) {
            const isOutgoing = perspective === STAFF_IDENTIFIER ? entry.from === STAFF_IDENTIFIER : entry.from === perspective;
            const senderMeta = entry.from === STAFF_IDENTIFIER ? { icon: 'üë§', label: 'Staff' } : getCommunicationMeta(entry.from);
            const senderName = entry.from === STAFF_IDENTIFIER ? (entry.fromName || 'Staff') : (entry.fromName || senderMeta.label);
            const recipients = (entry.to || []).map(target => {
                if (target === STAFF_IDENTIFIER) return 'üë§ Staff';
                const meta = getCommunicationMeta(target);
                return `${meta.icon} ${meta.label}`;
            }).join(', ');
            return `
                <div class="communication-message ${isOutgoing ? 'outgoing' : ''}">
                    <div class="communication-meta">
                        <span>${senderMeta.icon} ${escapeHTML(senderName)}</span>
                        <span> ‚Üí ${recipients || '‚Äî'}</span>
                        <span style="margin-left:8px;">${new Date(entry.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="communication-body">${escapeHTML(entry.message)}</div>
                </div>
            `;
        }

        function isStaffEntryVisible(entry, filter) {
            const staffSent = entry.from === STAFF_IDENTIFIER;
            const toStaff = Array.isArray(entry.to) && entry.to.includes(STAFF_IDENTIFIER);
            const fromPortal = COMMUNICATION_TARGET_IDS.includes(entry.from);
            if (!staffSent && !fromPortal) return false;

            const involvedPortals = [];
            if (staffSent) {
                (entry.to || []).forEach(target => {
                    if (COMMUNICATION_TARGET_IDS.includes(target)) involvedPortals.push(target);
                });
            } else if (fromPortal && toStaff) {
                involvedPortals.push(entry.from);
            }

            if (filter === 'all') {
                return involvedPortals.length > 0;
            }
            return involvedPortals.includes(filter);
        }

        function renderStaffCommunications() {
            const container = document.getElementById('staffCommunicationInbox');
            if (!container) return;
            const communications = getAllCommunications();
            const filtered = communications
                .filter(entry => isStaffEntryVisible(entry, staffCommFilter))
                .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            if (filtered.length === 0) {
                container.innerHTML = '<div class="communication-empty">No communications yet.</div>';
                return;
            }
            container.innerHTML = filtered.map(entry => buildCommunicationHTML(entry, STAFF_IDENTIFIER)).join('');
        }

        function renderPortalCommunications(portalId) {
            const container = document.getElementById(`portalCommunicationList-${portalId}`);
            if (!container) return;
            const communications = getAllCommunications();
            const filtered = communications
                .filter(entry => {
                    if (entry.from === portalId && Array.isArray(entry.to) && entry.to.includes(STAFF_IDENTIFIER)) return true;
                    if (entry.from === STAFF_IDENTIFIER && Array.isArray(entry.to) && entry.to.includes(portalId)) return true;
                    return false;
                })
                .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            if (filtered.length === 0) {
                container.innerHTML = '<div class="communication-empty">No conversations yet.</div>';
                return;
            }
            container.innerHTML = filtered.map(entry => buildCommunicationHTML(entry, portalId)).join('');
        }

        function initializeCommunicationPanels() {
            try { renderStaffCommunications(); } catch (e) { console.warn(e); }
            COMMUNICATION_TARGET_IDS.forEach(id => {
                try { renderPortalCommunications(id); } catch (e) { console.warn(e); }
            });
        }

        initializeCommunicationPanels();

        const STAFF_SERVICES_CONTEXTS = {};
        let activeStaffContext = 'branch';

        function registerStaffServicesContext(contextKey, config = {}) {
            if (!contextKey) return;
            STAFF_SERVICES_CONTEXTS[contextKey] = {
                leaveStatusId: config.leaveStatusId || null,
                cashStatusId: config.cashStatusId || null
            };
        }

        function getStaffStatusElement(contextKey, type) {
            const context = STAFF_SERVICES_CONTEXTS[contextKey] || {};
            const fallbackId = type === 'leave' ? 'myLeaveStatus' : 'myCashStatus';
            const targetId = type === 'leave' ? context.leaveStatusId : context.cashStatusId;
            return document.getElementById(targetId || fallbackId);
        }

        function refreshStaffServices(contextKey = 'branch') {
            viewMyLeaveRequests(contextKey);
            viewMyCashRequests(contextKey);
        }

        function openStaffLeaveRequest(contextKey = 'branch') {
            activeStaffContext = contextKey;
            const modal = document.createElement('div');
            modal.id = 'leaveRequestModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('leaveRequestModal')">&times;</span>
                    <h2>üìÖ Request Leave</h2>
                    <form id="leaveRequestForm" onsubmit="submitLeaveRequest(event)">
                        <div class="form-group">
                            <label>Leave Type</label>
                            <select id="leaveType" required>
                                <option value="">Select Leave Type</option>
                                <option value="vacation">Vacation</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="leaveStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="leaveEndDate" required>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="leaveReason" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Urgent?</label>
                            <label><input type="checkbox" id="leaveUrgent"> Mark as urgent</label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">üìÖ Submit Request</button>
                            <button type="button" class="btn" onclick="closeModal('leaveRequestModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function viewMyLeaveRequests(contextKey = 'branch') {
            const statusDiv = getStaffStatusElement(contextKey, 'leave');
            if (!statusDiv) return;
            statusDiv.innerHTML = '<p style="color: #64748b;">Loading leave requests...</p>';
            const username = (currentUser?.username || '').toLowerCase();
            const combined = await fetchLeaveRecordsIncludingOffline();
            const mine = combined.filter((req) => (req.staff || '').toLowerCase() === username);
            if (mine.length === 0) {
                statusDiv.innerHTML = '<p style="color: #666;">No leave requests yet.</p>';
                return;
            }
            const sorted = mine.sort(
                (a, b) =>
                    new Date(b.submittedAt || b.createdAt || 0).getTime() - new Date(a.submittedAt || a.createdAt || 0).getTime()
            );
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            sorted.forEach((req) => {
                const status = req.status || 'Pending';
                const badge = status === 'Approved' ? '#27ae60' : status === 'Rejected' ? '#e74c3c' : '#f39c12';
                const pendingBadge = req.pendingSync
                    ? '<span style="margin-left: 6px; color: #f97316; font-size: 0.75rem;">(offline)</span>'
                    : '';
                const startLabel = req.startDate ? new Date(req.startDate).toLocaleDateString() : '‚Äî';
                const endLabel = req.endDate ? new Date(req.endDate).toLocaleDateString() : '‚Äî';
                html += `
                    <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${badge};">
                        <strong>${req.type || 'Leave'}</strong> ${pendingBadge}<br>
                        ${startLabel} to ${endLabel}<br>
                        <span style="background: ${badge}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85rem;">${status}</span>
                    </div>
                `;
            });
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        async function submitLeaveRequest(e) {
            e.preventDefault();
            const typeField = document.getElementById('leaveType');
            const startField = document.getElementById('leaveStartDate');
            const endField = document.getElementById('leaveEndDate');
            const reasonField = document.getElementById('leaveReason');
            const urgentField = document.getElementById('leaveUrgent');

            const leaveType = typeField?.value || '';
            const startDate = startField?.value || '';
            const endDate = endField?.value || '';
            const reason = reasonField?.value || '';
            const urgent = Boolean(urgentField?.checked);

            if (!leaveType || !startDate || !endDate) {
                alert('Please complete all required fields before submitting.');
                return;
            }

            const payload = {
                type: leaveType,
                startDate,
                endDate,
                reason,
                urgent,
                staff: currentUser?.username || undefined,
                fullName: currentUser?.fullName || undefined,
                branch: currentBranch || undefined
            };

            let result = null;
            try {
                result = await apiRequest(LEAVE_API_ENDPOINT, 'POST', payload);
            } catch (error) {
                console.warn('submitLeaveRequest error', error);
            }

            let normalized = null;
            if (result && result.offline && result.data) {
                normalized = normalizeLeaveRecord(result.data, {
                    defaultStaff: currentUser?.username || null,
                    defaultStaffName: currentUser?.fullName || null,
                    defaultBranch: currentBranch || null,
                    pendingSync: true,
                    source: 'offline'
                });
            } else if (result) {
                const candidate =
                    result.leave ||
                    result.data ||
                    result.record ||
                    result.result ||
                    (result.success && result.payload) ||
                    (result.success === true && result);
                if (candidate) {
                    normalized = normalizeLeaveRecord(candidate, {
                        defaultStaff: currentUser?.username || null,
                        defaultStaffName: currentUser?.fullName || null,
                        defaultBranch: currentBranch || null,
                        source: 'api'
                    });
                }
            }

            if (!normalized) {
                normalized = normalizeLeaveRecord(payload, {
                    defaultStaff: currentUser?.username || null,
                    defaultStaffName: currentUser?.fullName || null,
                    defaultBranch: currentBranch || null,
                    pendingSync: true,
                    source: 'offline'
                });
                enqueuePendingRequest(LEAVE_PENDING_QUEUE_KEY, {
                    id: normalized.id,
                    payload: Object.assign({}, payload),
                    createdAt: normalized.createdAt,
                    staff: normalized.staff,
                    branch: normalized.branch
                });
            } else if (!normalized.pendingSync) {
                removePendingRequest(LEAVE_PENDING_QUEUE_KEY, normalized.id);
            }

            upsertLeaveCacheRecord(normalized);
            closeModal('leaveRequestModal');
            alert(
                normalized.pendingSync
                    ? 'Leave request saved offline. It will sync automatically when the connection is restored.'
                    : 'Leave request submitted successfully!'
            );
            const context = activeStaffContext || 'branch';
            refreshStaffServices(context);
            if (!normalized.pendingSync) {
                try {
                    await viewMyLeaveRequests(context);
                } catch (_) {}
            }
        }

        function openStaffCashRequest(contextKey = 'branch') {
            activeStaffContext = contextKey;
            const modal = document.createElement('div');
            modal.id = 'cashRequestModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('cashRequestModal')">&times;</span>
                    <h2>üíµ Request Cash</h2>
                    <form id="cashRequestForm" onsubmit="submitCashRequest(event)">
                        <div class="form-group">
                            <label>Amount Needed (N$)</label>
                            <input type="number" id="cashAmount" step="0.01" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Purpose</label>
                            <textarea id="cashPurpose" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Urgent?</label>
                            <label><input type="checkbox" id="cashUrgent"> Mark as urgent</label>
                        </div>
                        <button type="submit" class="btn btn-success">Submit Request</button>
                        <button type="button" class="btn" onclick="closeModal('cashRequestModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitCashRequest(e) {
            e.preventDefault();
            const amountField = document.getElementById('cashAmount');
            const purposeField = document.getElementById('cashPurpose');
            const urgentField = document.getElementById('cashUrgent');

            const amount = Number(amountField?.value || 0);
            const purpose = (purposeField?.value || '').trim();
            const urgent = Boolean(urgentField?.checked);

            if (!Number.isFinite(amount) || amount <= 0 || !purpose) {
                alert('Please provide a valid amount and purpose for the cash request.');
                return;
            }

            const payload = {
                amount,
                purpose,
                urgent,
                branch: currentBranch || undefined,
                employeeId: currentUser?.username || undefined,
                employee: currentUser?.fullName || undefined
            };

            let result = null;
            try {
                result = await apiRequest(CASH_API_ENDPOINT, 'POST', payload);
            } catch (error) {
                console.warn('submitCashRequest error', error);
            }

            let normalized = null;
            if (result && result.offline && result.data) {
                normalized = normalizeCashRecord(result.data, {
                    defaultEmployeeId: currentUser?.username || null,
                    defaultEmployeeName: currentUser?.fullName || null,
                    defaultBranch: currentBranch || null,
                    pendingSync: true,
                    source: 'offline'
                });
            } else if (result) {
                const candidate =
                    result.cashRequest ||
                    result.request ||
                    result.data ||
                    result.record ||
                    result.result ||
                    (result.success && result.payload) ||
                    (result.success === true && result);
                if (candidate) {
                    normalized = normalizeCashRecord(candidate, {
                        defaultEmployeeId: currentUser?.username || null,
                        defaultEmployeeName: currentUser?.fullName || null,
                        defaultBranch: currentBranch || null,
                        source: 'api'
                    });
                }
            }

            if (!normalized) {
                normalized = normalizeCashRecord(payload, {
                    defaultEmployeeId: currentUser?.username || null,
                    defaultEmployeeName: currentUser?.fullName || null,
                    defaultBranch: currentBranch || null,
                    pendingSync: true,
                    source: 'offline'
                });
                enqueuePendingRequest(CASH_PENDING_QUEUE_KEY, {
                    id: normalized.id,
                    payload: Object.assign({}, payload),
                    createdAt: normalized.createdAt,
                    employeeId: normalized.employeeId,
                    branch: normalized.branch
                });
            } else if (!normalized.pendingSync) {
                removePendingRequest(CASH_PENDING_QUEUE_KEY, normalized.id);
            }

            upsertCashCacheRecord(normalized);
            if (typeof recordDepartmentEvent === 'function') {
                try {
                    recordDepartmentEvent('cash_requested', normalized);
                } catch (_) {}
            }

            closeModal('cashRequestModal');
            alert(
                normalized.pendingSync
                    ? 'Cash request saved offline. It will sync automatically when the connection returns.'
                    : 'Cash request submitted successfully!'
            );
            displayFinanceCashRequests && displayFinanceCashRequests();
            const context = activeStaffContext || 'branch';
            refreshStaffServices(context);
            if (!normalized.pendingSync) {
                try {
                    await viewMyCashRequests(context);
                } catch (_) {}
            }
        }

        async function viewMyCashRequests(contextKey = 'branch') {
            const container = getStaffStatusElement(contextKey, 'cash');
            if (!container) return;
            container.innerHTML = '<p style="color: #64748b;">Loading cash requests...</p>';
            const username = (currentUser?.username || '').toLowerCase();
            const combined = await fetchCashRecordsIncludingOffline();
            const mine = combined.filter((r) => (r.employeeId || '').toLowerCase() === username);
            if (mine.length === 0) {
                container.innerHTML = '<p style="color: #666;">No cash requests yet.</p>';
                return;
            }
            mine.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            container.innerHTML = mine
                .slice(-10)
                .map((r) => {
                    const statusColor =
                        r.status === 'approved' ? '#27ae60' : r.status === 'rejected' ? '#e74c3c' : '#3498db';
                    const offlineBadge = r.pendingSync
                        ? '<span style="margin-left: 6px; color: #f97316; font-size: 0.75rem;">(offline)</span>'
                        : '';
                    return `
                        <div style="background: white; border-left: 4px solid ${statusColor}; padding: 10px; margin-bottom: 8px; border-radius: 6px;">
                            <div style="display:flex; justify-content: space-between;">
                                <strong>N$ ${Number(r.amount || 0).toFixed(2)}</strong>
                                <span style="background:${statusColor}; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem;">${(r.status || 'pending').toUpperCase()}</span>
                            </div>
                            <div style="color:#666; font-size:0.9rem;">${r.purpose || ''} ${offlineBadge}</div>
                            <div style="color:#999; font-size:0.8rem;">${new Date(r.createdAt || Date.now()).toLocaleString()}</div>
                        </div>
                    `;
                })
                .join('');
        }

        function showDispenserLeaveRequest() {
            openStaffLeaveRequest('branch');
        }

        function showDispenserCashRequest() {
            openStaffCashRequest('branch');
        }

        function loadMyStaffStatus() {
            refreshStaffServices('branch');
            showStaffSubTab(staffSubTabActive || 'services');
            renderStaffCommunications();
        }

        registerStaffServicesContext('branch', {
            leaveStatusId: 'staffLeaveStatus-branch',
            cashStatusId: 'staffCashStatus-branch'
        });
        
        // Cash drawer functions
        function displayCashDrawerStatus() {
            const statusDiv = document.getElementById('cashDrawerStatus');
            if (!statusDiv) return;
            
            // Calculate today's cash from paid prescriptions
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const todayReports = reports.filter(r => new Date(r.timestamp) >= startOfDay);
            
            let todayCash = 0;
            todayReports.forEach(r => {
                const client = clients.find(c => c.referenceNumber === r.clientId);
                if (r.medicines && client) {
                    const totals = calculatePrescriptionTotals(r.medicines, client.membershipStatus);
                    todayCash += totals.paid.dp + totals.paid.cp;
                }
            });
            
            const totalDrops = cashDrawer.drops.reduce((sum, drop) => sum + drop.amount, 0);
            const totalExpenses = cashDrawer.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const expectedCash = cashDrawer.openingBalance + todayCash - totalDrops - totalExpenses;
            
            statusDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'};">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Drawer Status</p>
                        <h3 style="color: ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'}; font-size: 16pt;">
                            ${cashDrawer.isOpen ? 'üîì OPEN' : 'üîí CLOSED'}
                        </h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #3498db;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Opening Balance</p>
                        <h3 style="color: #3498db; font-size: 16pt;">N$${cashDrawer.openingBalance.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #27ae60;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Today's Cash</p>
                        <h3 style="color: #27ae60; font-size: 16pt;">N$${todayCash.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #f39c12;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Expected in Drawer</p>
                        <h3 style="color: #f39c12; font-size: 16pt;">N$${expectedCash.toFixed(2)}</h3>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    ${!cashDrawer.isOpen ? `
                        <button class="btn btn-success" onclick="openCashDrawer()">üîì Open Cash Drawer</button>
                    ` : `
                        <button class="btn btn-warning" onclick="recordCashDrop()" style="margin-right: 10px;">üí∞ Cash Drop</button>
                        <button class="btn btn-info" onclick="recordExpense()" style="margin-right: 10px;">üìù Record Expense</button>
                        <button class="btn btn-primary" onclick="viewCashHistory()" style="margin-right: 10px;">üìã View History</button>
                        <button class="btn btn-danger" onclick="closeCashDrawer()">üîí Close & Reconcile</button>
                    `}
                </div>
            `;
        }

        async function openCashDrawer() {
            const openingBalanceInput = prompt('Enter opening cash balance in drawer (N$):');
            if (openingBalanceInput === null) return;

            const amount = parseFloat(openingBalanceInput);
            if (Number.isNaN(amount) || amount < 0) {
                alert('Invalid opening balance.');
                return;
            }

            const branchId =
                (typeof getBranchId === 'function' && getBranchId()) ||
                (currentUser && currentUser.branch) ||
                'default';

            try {
                const response = await fetch('/api/branch/cash-sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'open',
                        branchId,
                openingBalance: amount,
                        openedBy: currentUser?.fullName || currentUser?.username || 'system'
                    })
                });

                const payload = await response.json();
                if (!response.ok || !payload.success) {
                    throw new Error(payload.error || 'Failed to open cash drawer');
                }

                branchCashSession = payload.session;
                branchCashMovements = [];
                saveBranchFinanceCache('branch_cash_session', branchId, branchCashSession);
                saveBranchFinanceCache('branch_cash_movements', branchId, branchCashMovements);
                refreshCashDrawerState(branchId);
            displayCashDrawerStatus();
                alert(
                    `‚úÖ Cash drawer opened\nOpening Balance: N$${amount.toFixed(2)}\nOpened by: ${
                        branchCashSession.openedBy || currentUser?.fullName || 'system'
                    }`
                );
            } catch (error) {
                console.error('Error opening cash drawer:', error);
                alert(`‚ùå Failed to open cash drawer: ${error.message}`);
            }
        }

        async function recordCashDrop() {
            if (!branchCashSession || !branchCashSession.isOpen) {
                alert('Cash drawer is not open. Please open the drawer first.');
                return;
            }

            const amountInput = prompt('Enter cash drop amount (N$):');
            if (!amountInput) return;

            const dropAmount = parseFloat(amountInput);
            if (Number.isNaN(dropAmount) || dropAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            const notes = prompt('Notes (optional):') || '';
            const branchId = branchCashSession.branchId;

            try {
                await createBranchCashMovement({
                    branchId,
                    sessionId: branchCashSession.id,
                    type: 'drop',
                    amount: dropAmount,
                    notes,
                    recordedBy: currentUser?.fullName || currentUser?.username || 'system'
                });
                alert(
                    `‚úÖ Cash drop recorded\nAmount: N$${dropAmount.toFixed(
                        2
                    )}\nRemaining in drawer: N$${(cashDrawer.currentBalance || 0).toFixed(2)}`
                );
            } catch (error) {
                console.error('Error recording cash drop:', error);
                alert(`‚ùå Failed to record cash drop: ${error.message}`);
            }
        }

        async function recordExpense() {
            if (!branchCashSession || !branchCashSession.isOpen) {
                alert('Cash drawer is not open. Please open the drawer first.');
                return;
            }

            const description = prompt('Expense description:');
            if (!description) return;
            
            const amountInput = prompt('Expense amount (N$):');
            if (!amountInput) return;
            
            const expenseAmount = parseFloat(amountInput);
            if (Number.isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            const branchId = branchCashSession.branchId;

            try {
                await createBranchCashMovement({
                    branchId,
                    sessionId: branchCashSession.id,
                    type: 'expense',
                    amount: expenseAmount,
                    description,
                    recordedBy: currentUser?.fullName || currentUser?.username || 'system'
                });
                alert(
                    `‚úÖ Expense recorded\nDescription: ${description}\nAmount: N$${expenseAmount.toFixed(
                        2
                    )}`
                );
            } catch (error) {
                console.error('Error recording expense:', error);
                alert(`‚ùå Failed to record expense: ${error.message}`);
            }
        }

        function viewCashHistory() {
            let history = `CASH DRAWER HISTORY\n\n`;
            history += `Opening Balance: N$${cashDrawer.openingBalance.toFixed(2)}\n`;
            history += `Opened by: ${cashDrawer.openedBy} at ${new Date(cashDrawer.openedAt).toLocaleString('en-GB')}\n\n`;
            
            if (cashDrawer.drops.length > 0) {
                history += `CASH DROPS (${cashDrawer.drops.length}):\n`;
                cashDrawer.drops.forEach((drop, idx) => {
                    history += `${idx + 1}. N$${drop.amount.toFixed(2)} - ${new Date(drop.recordedAt).toLocaleString('en-GB')}\n`;
                    history += `   By: ${drop.recordedBy} | Ref: ${drop.reference}\n`;
                    if (drop.notes) history += `   Notes: ${drop.notes}\n`;
                });
                history += `\n`;
            }
            
            if (cashDrawer.expenses.length > 0) {
                history += `EXPENSES (${cashDrawer.expenses.length}):\n`;
                cashDrawer.expenses.forEach((exp, idx) => {
                    history += `${idx + 1}. ${exp.description} - N$${exp.amount.toFixed(2)}\n`;
                    history += `   By: ${exp.recordedBy} at ${new Date(exp.recordedAt).toLocaleString('en-GB')}\n`;
                });
            }
            
            alert(history);
        }

        async function closeCashDrawer() {
            if (!branchCashSession || !branchCashSession.isOpen) {
                alert('Cash drawer is not open.');
                return;
            }

            const actualCash = prompt('Enter actual cash counted in drawer (N$):');
            if (actualCash === null) return;
            
            const counted = parseFloat(actualCash);
            if (Number.isNaN(counted)) {
                alert('Invalid amount');
                return;
            }
            
            const notes = prompt('Add closing notes (optional):') || '';
            const branchId = branchCashSession.branchId;

            try {
                const response = await fetch('/api/branch/cash-sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'close',
                        sessionId: branchCashSession.id,
                        countedCash: counted,
                        notes,
                        closedBy: currentUser?.fullName || currentUser?.username || 'system'
                    })
                });
                const payload = await response.json();
                if (!response.ok || !payload.success) {
                    throw new Error(payload.error || 'Failed to close cash drawer');
                }

                branchCashSession = payload.session;
                saveBranchFinanceCache('branch_cash_session', branchId, branchCashSession);
                refreshCashDrawerState(branchId);
                displayCashDrawerStatus();
                alert('‚úÖ Cash drawer closed successfully');
            } catch (error) {
                console.error('Error closing cash drawer:', error);
                alert(`‚ùå Failed to close cash drawer: ${error.message}`);
            }
        }

        function showAllInventory() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            list.innerHTML = Object.entries(inventory).map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Reorder At</p>
                                <strong>${data.reorderLevel}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">‚ûï</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">‚ûñ</button>
                            <button class="btn btn-sm btn-info" onclick="setReorderLevel('${productName.replace(/'/g, "\\'")})" style="padding: 5px 10px;">‚öôÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            if (!searchTerm) {
                showAllInventory();
                return;
            }
            
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const filtered = Object.entries(inventory).filter(([name, _]) => 
                name.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = filtered.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">‚ûï</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">‚ûñ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showLowStockItems() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            if (lowStock.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #27ae60;"><h3>‚úÖ All items adequately stocked</h3></div>';
                return;
            }
            
            list.innerHTML = `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è ${lowStock.length} Items Need Reordering</h4>
                </div>
            ` + lowStock.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #e74c3c;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${productName}</strong>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Current: ${data.currentStock} | Reorder at: ${data.reorderLevel}
                            </p>
                        </div>
                        <button class="btn btn-success" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')">üì¶ Restock</button>
                    </div>
                </div>
            `).join('');
        }

        function adjustStock(productName, action) {
            const quantity = prompt(`Enter quantity to ${action === 'add' ? 'add' : 'remove'}:`);
            if (!quantity) return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                alert('Invalid quantity');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: 5,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            }
            
            const previousStock = inventory[productName].currentStock;
            
            if (action === 'add') {
                inventory[productName].currentStock += qty;
            } else {
                inventory[productName].currentStock = Math.max(0, inventory[productName].currentStock - qty);
            }
            
            // Record in history
            inventory[productName].history.push({
                action: action,
                quantity: qty,
                previousStock: previousStock,
                newStock: inventory[productName].currentStock,
                user: currentUser.fullName,
                timestamp: new Date().toISOString(),
                reference: (action === 'add' ? 'STOCK-IN' : 'STOCK-OUT') + Date.now()
            });
            
            inventory[productName].lastUpdated = new Date().toISOString();
            
            alert(`‚úÖ Stock updated\n${productName}\nPrevious: ${previousStock}\nNew: ${inventory[productName].currentStock}`);
            showAllInventory();
        }

        function setReorderLevel(productName) {
            const current = inventory[productName]?.reorderLevel || 5;
            const newLevel = prompt(`Set reorder level for:\n${productName}\n\nCurrent reorder level: ${current}\n\nEnter new reorder level:`);
            
            if (!newLevel) return;
            
            const level = parseInt(newLevel);
            if (isNaN(level) || level < 0) {
                alert('Invalid reorder level');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: level,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            } else {
                inventory[productName].reorderLevel = level;
            }
            
            alert(`‚úÖ Reorder level updated to ${level}`);
            showAllInventory();
        }

        function printInventoryReport() {
            initializeInventory();
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            const totalProducts = Object.keys(inventory).length;
            const totalStock = Object.values(inventory).reduce((sum, data) => sum + data.currentStock, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Inventory Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th { background: #f8f9fa; padding: 8px; border: 1px solid #ddd; text-align: left; }
                        td { padding: 6px 8px; border: 1px solid #ddd; }
                        .low-stock { background: #ffebee; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Inventory Stock Report</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalProducts}</h3>
                            <p>Total Products</p>
                        </div>
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalStock}</h3>
                            <p>Total Units in Stock</p>
                        </div>
                        <div style="text-align: center; background: #ffebee; padding: 12px; border-radius: 5px;">
                            <h3 style="color: #e74c3c;">${lowStock.length}</h3>
                            <p>Low Stock Items</p>
                        </div>
                    </div>
                    
                    ${lowStock.length > 0 ? `
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Low Stock Items (Reorder Required)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Level</th>
                                    <th>Shortage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStock.map(([name, data], idx) => `
                                    <tr class="low-stock">
                                        <td>${idx + 1}</td>
                                        <td>${name}</td>
                                        <td>${data.currentStock}</td>
                                        <td>${data.reorderLevel}</td>
                                        <td>${data.reorderLevel - data.currentStock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <h3 style="margin-top: 30px; margin-bottom: 10px;">üì¶ Full Inventory List</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(inventory).map(([name, data], idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${name}</td>
                                    <td>${data.currentStock}</td>
                                    <td>${data.reorderLevel}</td>
                                    <td>${data.currentStock > data.reorderLevel ? '‚úÖ OK' : '‚ö†Ô∏è LOW'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== Unified Sales Dashboard Functions ==========
        
        function refreshUnifiedSales() {
            const timeframe = document.getElementById('salesTimeframe')?.value || 'month';
            
            // Get all sales data
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const reports = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
            
            // Calculate date range based on timeframe
            let startDate = new Date();
            switch(timeframe) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case 'all':
                    startDate = new Date(0); // Start of epoch
                    break;
            }
            
            // Filter walk-in sales
            const filteredWalkInSales = walkInSales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate >= startDate;
            });
            
            // Filter prescription sales (paid items only)
            let prescriptionSales = [];
            reports.forEach(report => {
                if (!report.medicines || !report.medicines.length) return;
                
                report.medicines.forEach(med => {
                    if (med.paid && med.amountPaid) {
                        const paidDate = new Date(med.paidAt || report.createdAt);
                        if (paidDate >= startDate) {
                            prescriptionSales.push({
                                id: report.id,
                                customerName: report.clientName || 'Unknown',
                                distributorReferral: report.distributorReferral || { name: 'N/A', id: 'N/A' },
                                productName: med.name,
                                quantity: med.quantity || 1,
                                price: med.price || med.amountPaid,
                                totalAmount: med.amountPaid,
                                bv: med.bv || 0,
                                type: 'prescription',
                                saleDate: paidDate,
                                soldBy: med.paidBy || 'Unknown',
                                branch: report.branch || 'Unknown'
                            });
                        }
                    }
                });
            });
            
            // Aggregate data
            let totalSales = 0;
            let totalBV = 0;
            let distributorSales = 0;
            let customerSales = 0;
            
            filteredWalkInSales.forEach(sale => {
                totalSales += sale.total;
                totalBV += sale.totalBV || 0;
                if (sale.customerType === 'distributor') {
                    distributorSales += sale.total;
                } else {
                    customerSales += sale.total;
                }
            });
            
            prescriptionSales.forEach(sale => {
                totalSales += sale.totalAmount;
                totalBV += sale.bv * sale.quantity;
                customerSales += sale.totalAmount; // Prescriptions are always customer sales
            });
            
            // Update summary cards
            document.getElementById('totalSales').textContent = `N$ ${totalSales.toFixed(2)}`;
            document.getElementById('totalBV').textContent = totalBV.toFixed(0);
            document.getElementById('walkInCount').textContent = filteredWalkInSales.length;
            document.getElementById('prescriptionCount').textContent = prescriptionSales.length;
            
            // Update customer type breakdown
            document.getElementById('distributorSales').textContent = `N$ ${distributorSales.toFixed(2)}`;
            document.getElementById('customerSales').textContent = `N$ ${customerSales.toFixed(2)}`;
            
            const totalCustSales = distributorSales + customerSales;
            const distributorPercentage = totalCustSales > 0 ? (distributorSales / totalCustSales * 100) : 0;
            const customerPercentage = totalCustSales > 0 ? (customerSales / totalCustSales * 100) : 0;
            
            document.getElementById('distributorBar').style.width = distributorPercentage + '%';
            document.getElementById('customerBar').style.width = customerPercentage + '%';
            
            // Top distributors
            const distributorMap = new Map();
            [...filteredWalkInSales, ...prescriptionSales].forEach(sale => {
                const distName = sale.distributorReferral?.name || 'N/A';
                const current = distributorMap.get(distName) || { sales: 0, bv: 0 };
                current.sales += sale.total || sale.totalAmount || 0;
                current.bv += sale.totalBV || (sale.bv * sale.quantity) || 0;
                distributorMap.set(distName, current);
            });
            
            const topDistributors = Array.from(distributorMap.entries())
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 5);
            
            document.getElementById('topDistributors').innerHTML = topDistributors.length > 0
                ? topDistributors.map(([name, data]) => `
                    <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                        <span style="font-weight: 500;">${name}</span>
                        <span style="color: #27ae60;">N$ ${data.sales.toFixed(2)}</span>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: #7f8c8d; padding: 10px;">No distributor sales</p>';
            
            // Detailed sales breakdown
            const allSales = [
                ...filteredWalkInSales.map(sale => ({
                    ...sale,
                    type: 'walkin',
                    saleDate: new Date(sale.timestamp)
                })),
                ...prescriptionSales
            ].sort((a, b) => b.saleDate - a.saleDate);
            
            document.getElementById('unifiedSalesDetail').innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Referrer</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Amount</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">BV</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Sold By</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allSales.slice(0, 50).map(sale => `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 8px;">${sale.saleDate.toLocaleDateString('en-GB')}</td>
                                <td style="padding: 8px;">
                                    <span style="padding: 3px 8px; border-radius: 3px; font-size: 0.8rem; background: ${sale.type === 'walkin' ? '#fff3cd' : '#e8f5e9'};">
                                        ${sale.type === 'walkin' ? 'üõí Walk-in' : 'üíä Prescription'}
                                    </span>
                                </td>
                                <td style="padding: 8px;">${sale.customerName || 'N/A'}</td>
                                <td style="padding: 8px; font-size: 0.85rem;">${sale.distributorReferral?.name || 'N/A'}</td>
                                <td style="padding: 8px; text-align: right; font-weight: bold;">N$ ${(sale.total || sale.totalAmount || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">${(sale.totalBV || (sale.bv * sale.quantity) || 0).toFixed(0)}</td>
                                <td style="padding: 8px; font-size: 0.85rem;">${sale.soldBy || 'Unknown'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function printUnifiedSales() {
            const printWindow = window.open('', '_blank');
            const timeframe = document.getElementById('salesTimeframe')?.value || 'month';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Unified Sales Report - ${timeframe}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f8f9fa; }
                    </style>
                </head>
                <body>
                    <h1>Unified Sales Report - ${timeframe.charAt(0).toUpperCase() + timeframe.slice(1)}</h1>
                    ${document.getElementById('unifiedSalesDetail').innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        }
        
        function exportUnifiedSales() {
            alert('Excel export feature will be implemented soon.');
        }
        
        async function refreshBusinessIntelligence() {
            await loadData();
            
            const display = document.getElementById('biDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const biData = calculateBusinessIntelligence(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 24pt; margin-bottom: 3px;">${biData.totalRevenue.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total Revenue (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 24pt; margin-bottom: 3px;">${biData.totalPaid.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Cash Collected (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 24pt; margin-bottom: 3px;">${biData.totalOutstanding.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Outstanding (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #9b59b6; text-align: center;">
                            <h3 style="color: #9b59b6; font-size: 24pt; margin-bottom: 3px;">${biData.totalBV}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total BV</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 24pt; margin-bottom: 3px;">${biData.productsSold}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Products Sold</p>
                        </div>
                    </div>

                    <!-- Top Selling Products & Revenue Breakdown -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üèÜ Top Selling Products</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Qty</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${biData.topSellingProducts.slice(0, 10).map((product, idx) => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                            <td style="padding: 8px;">${product.name}</td>
                                            <td style="padding: 8px; text-align: center;">${product.quantity}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: bold;">N$${product.revenue.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üí∞ Revenue Breakdown</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Member Sales (DP):</span>
                                    <strong style="color: #27ae60;">N$${biData.dpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 12px; border-radius: 6px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.dpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.dpPercentage}%</p>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Referred Sales (CP):</span>
                                    <strong style="color: #f39c12;">N$${biData.cpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 12px; border-radius: 6px;">
                                    <div style="background: #f39c12; height: 100%; width: ${biData.cpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.cpPercentage}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Package vs Individual Sales -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üì¶ Package vs Individual Sales</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Package Sales:</span>
                                    <strong style="color: #27ae60;">${biData.packageSales} (N$${biData.packageRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.packagePercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Individual Sales:</span>
                                    <strong style="color: #2196f3;">${biData.individualSales} (N$${biData.individualRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e3f2fd; height: 10px; border-radius: 5px;">
                                    <div style="background: #2196f3; height: 100%; width: ${biData.individualPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üë• Consultant Performance</h4>
                            ${biData.topConsultants.slice(0, 5).map((consultant, idx) => `
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 0.9rem;">${consultant.name}</span>
                                        <strong style="color: #c41e3a;">N$${consultant.revenue.toFixed(0)}</strong>
                                    </div>
                                    <div style="background: #f8f9fa; height: 8px; border-radius: 4px;">
                                        <div style="background: #c41e3a; height: 100%; width: ${consultant.percentage}%; border-radius: 4px;"></div>
                                    </div>
                                    <p style="font-size: 0.75rem; color: #666; margin-top: 2px;">${consultant.clients} clients | ${consultant.percentage}%</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateBusinessIntelligence(timeframe) {
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = reports.filter(r => new Date(r.timestamp) >= startDate);
            
            // Calculate revenue
            let totalRevenue = 0, totalPaid = 0, totalOutstanding = 0, totalBV = 0;
            let dpRevenue = 0, cpRevenue = 0;
            let packageSales = 0, individualSales = 0;
            let packageRevenue = 0, individualRevenue = 0;
            let productsSold = 0;
            
            const productRevenue = {};
            const consultantRevenue = {};
            
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client || !report.medicines) return;
                
                const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                
                totalRevenue += totals.total.dp + totals.total.cp;
                totalPaid += totals.paid.dp + totals.paid.cp;
                totalOutstanding += totals.outstanding.dp + totals.outstanding.cp;
                totalBV += totals.total.bv;
                
                dpRevenue += totals.total.dp;
                cpRevenue += totals.total.cp;
                
                // Track consultant performance
                if (!consultantRevenue[report.consultant]) {
                    consultantRevenue[report.consultant] = { revenue: 0, clients: 0 };
                }
                consultantRevenue[report.consultant].revenue += totals.paid.dp + totals.paid.cp;
                consultantRevenue[report.consultant].clients++;
                
                // Track products
                report.medicines.forEach(med => {
                    const price = findProductPrice(med.name);
                    const isPackage = price.isPackage;
                    
                    if (isPackage) {
                        packageSales++;
                        const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                        const revenue = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                        packageRevenue += revenue;
                        
                        if (!productRevenue[med.name]) {
                            productRevenue[med.name] = { quantity: 0, revenue: 0 };
                        }
                        productRevenue[med.name].quantity++;
                        productRevenue[med.name].revenue += revenue;
                    } else {
                        if (med.dispensed) {
                            individualSales++;
                            const revenue = client.membershipStatus === 'member' ? price.dp : price.cp;
                            individualRevenue += revenue;
                            
                            if (!productRevenue[med.name]) {
                                productRevenue[med.name] = { quantity: 0, revenue: 0 };
                            }
                            productRevenue[med.name].quantity++;
                            productRevenue[med.name].revenue += revenue;
                        }
                    }
                    productsSold++;
                });
            });
            
            const topSellingProducts = Object.entries(productRevenue)
                .map(([name, data]) => ({
                    name,
                    quantity: data.quantity,
                    revenue: data.revenue
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const topConsultants = Object.entries(consultantRevenue)
                .map(([name, data]) => ({
                    name,
                    revenue: data.revenue,
                    clients: data.clients,
                    percentage: totalPaid > 0 ? Math.round((data.revenue / totalPaid) * 100) : 0
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const totalSales = packageSales + individualSales;
            
            return {
                totalRevenue,
                totalPaid,
                totalOutstanding,
                totalBV,
                dpRevenue,
                cpRevenue,
                dpPercentage: totalRevenue > 0 ? Math.round((dpRevenue / totalRevenue) * 100) : 0,
                cpPercentage: totalRevenue > 0 ? Math.round((cpRevenue / totalRevenue) * 100) : 0,
                packageSales,
                individualSales,
                packageRevenue,
                individualRevenue,
                packagePercentage: totalSales > 0 ? Math.round((packageSales / totalSales) * 100) : 0,
                individualPercentage: totalSales > 0 ? Math.round((individualSales / totalSales) * 100) : 0,
                productsSold,
                topSellingProducts,
                topConsultants
            };
        }

        function printBusinessIntelligence() {
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Business Intelligence Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Business Intelligence Report - ${timeframeText}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('biDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Price list functions
        function displayPriceList() {
            const list = document.getElementById('priceList');
            if (!list) return;
            
            // Combine packages and individual products
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${allItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` üì¶ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function searchPriceList() {
            const searchTerm = document.getElementById('priceSearch').value.toLowerCase();
            const list = document.getElementById('priceList');
            if (!list) return;
            
            if (!searchTerm) {
                displayPriceList();
                return;
            }
            
            // Combine packages and individual products for search
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            const filteredItems = allItems.filter(item => 
                item.description.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">Search Results (${filteredItems.length} items)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${filteredItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` üì¶ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function showAllPrices() {
            document.getElementById('priceSearch').value = '';
            displayPriceList();
        }

        function printPriceList() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #c41e3a; margin-bottom: 10px; }
                        .price-table { width: 100%; border-collapse: collapse; }
                        .price-table th, .price-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .price-table th { background-color: #f8f9fa; font-weight: bold; }
                        .price-table .description { width: 60%; }
                        .price-table .dp, .price-table .cp, .price-table .bv { width: 13.33%; text-align: center; }
                        .dp { color: #c41e3a; font-weight: bold; }
                        .cp { color: #27ae60; font-weight: bold; }
                        .bv { color: #f39c12; font-weight: bold; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h1>
                        <p>DESCRIPTION | DP | CP | BV</p>
                    </div>
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th class="description">DESCRIPTION</th>
                                <th class="dp">DP</th>
                                <th class="cp">CP</th>
                                <th class="bv">BV</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${PRICE_LIST.map(item => `
                                <tr>
                                    <td class="description">${item.description}</td>
                                    <td class="dp">${item.dp}</td>
                                    <td class="cp">${item.cp}</td>
                                    <td class="bv">${item.bv}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function viewPrescriptionDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (report) {
                alert(`Prescription Details:\n\nReport ID: ${report.id}\nClient: ${client ? client.fullName : 'Unknown'}\nConsultant: ${report.consultant}\nCreated: ${new Date(report.timestamp).toLocaleString()}\n\nPrescription:\n${report.prescription}\n\nNotes:\n${report.notes || 'None'}`);
            }
        }

        function printPrescription(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report) return;
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Prescription - ${report.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #c41e3a; padding-bottom: 20px; margin-bottom: 20px; }
                        .patient-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .medicines { margin: 20px 0; }
                        .medicine-item { padding: 8px; margin: 5px 0; border-left: 3px solid #c41e3a; background: #f8f9fa; }
                        .notes { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        .footer { margin-top: 30px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Summary Analysis Report Card</h2>
                        <p>Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
                        <p>Branch: ${client ? client.branch : 'Unknown'}</p>
                    </div>
                    
                    <div class="patient-info">
                        <h3>Patient Information</h3>
                        <p><strong>Name:</strong> ${client ? client.fullName : 'Unknown'}</p>
                        <p><strong>Reference:</strong> ${report.clientId}</p>
                        <p><strong>Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="medicines">
                        <h3>Prescribed Medicines with Prices</h3>
                        ${report.medicines ? (() => {
                            const clientMembershipStatus = client ? client.membershipStatus : 'referred';
                            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
                            return `
                            ${report.medicines.map(med => {
                                const price = findProductPrice(med.name);
                                let effectivePrice;
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                
                                return `
                                <div class="medicine-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${med.name}</strong> ${med.dispensed ? '‚úÖ Dispensed' : '‚è≥ Pending'}
                                            ${med.paid ? 'üí∞ Paid' : ''}
                                        </div>
                                        <div style="text-align: right; font-size: 0.9rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${effectivePrice.dp}</div>
                                                <div><strong>BV:</strong> ${effectivePrice.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${effectivePrice.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            
                            <!-- Receipt Totals -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; border: 2px solid #c41e3a;">
                                <h4 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">PRESCRIPTION TOTALS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                        <h5 style="color: #c41e3a; margin-bottom: 5px;">TOTAL</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.total.dp}</div>
                                                <div><strong>BV:</strong> ${totals.total.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.total.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #e8f5e9; padding: 10px; border-radius: 5px; border: 1px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin-bottom: 5px;">DISPENSED</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.dispensed.dp}</div>
                                                <div><strong>BV:</strong> ${totals.dispensed.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.dispensed.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #155724;">
                                        <h5 style="color: #155724; margin-bottom: 5px;">PAID</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.paid.dp}</div>
                                                <div><strong>BV:</strong> ${totals.paid.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.paid.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #721c24;">
                                        <h5 style="color: #721c24; margin-bottom: 5px;">OUTSTANDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.outstanding.dp}</div>
                                                <div><strong>BV:</strong> ${totals.outstanding.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.outstanding.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin-bottom: 5px;">PENDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.pending.dp}</div>
                                                <div><strong>BV:</strong> ${totals.pending.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.pending.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        })() : '<p>No medicines prescribed</p>'}
                    </div>
                    
                    ${report.notes ? `
                    <div class="notes">
                        <h3>Consultant Notes</h3>
                        <p>${report.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p><strong>Consultant:</strong> ${report.consultant}</p>
                        <p><strong>Report ID:</strong> ${report.id}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printThermalReceipt(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report || !client) {
                alert('Report or client data not found');
                return;
            }
            
            const clientMembershipStatus = client.membershipStatus || 'referred';
            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Create thermal receipt
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Receipt - ${report.id}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        .center {
                            text-align: center;
                        }
                        
                        .bold {
                            font-weight: bold;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                            margin-bottom: 8px;
                        }
                        
                        .header h1 {
                            font-size: 12pt;
                            margin-bottom: 3px;
                        }
                        
                        .header p {
                            font-size: 8pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin: 8px 0;
                            padding-bottom: 5px;
                        }
                        
                        .section-title {
                            font-weight: bold;
                            font-size: 9pt;
                            border-bottom: 2px solid #c41e3a;
                            margin-bottom: 4px;
                            padding-bottom: 2px;
                            color: #c41e3a;
                            text-transform: uppercase;
                        }
                        
                        .info-line {
                            display: flex;
                            justify-content: space-between;
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        
                        .item {
                            margin: 4px 0;
                            font-size: 9pt;
                        }
                        
                        .item-name {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        
                        .item-status {
                            display: flex;
                            justify-content: space-between;
                            font-size: 8pt;
                            margin-top: 1px;
                        }
                        
                        .divider {
                            border-top: 1px dashed #c41e3a;
                            margin: 6px 0;
                        }
                        
                        .total-line {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            font-size: 10pt;
                            margin: 3px 0;
                            color: #c41e3a;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 12px;
                            border-top: 2px solid #c41e3a;
                            padding-top: 8px;
                            font-size: 8pt;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 5px;">
                        ${generateLogoSVG(60, 40)}
                    </div>
                    
                    <!-- Header -->
                    <div class="header" style="border-bottom: 2px solid #c41e3a; background: linear-gradient(135deg, rgba(196,30,58,0.1) 0%, rgba(139,0,0,0.1) 100%); border-radius: 4px;">
                        <h1 style="color: #c41e3a; font-weight: 900;">DYNAPHARM NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>PRESCRIPTION RECEIPT</p>
                        <p>${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</p>
                    </div>
                    
                    <!-- Client Details -->
                    <div class="section">
                        <div class="section-title">CLIENT DETAILS</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span class="bold">${client.fullName}</span>
                        </div>
                        <div class="info-line">
                            <span>DOB:</span>
                            <span>${client.dob || 'N/A'}</span>
                        </div>
                        <div class="info-line">
                            <span>Contact:</span>
                            <span>${client.phone}</span>
                        </div>
                        <div class="info-line">
                            <span>Type:</span>
                            <span>${clientMembershipStatus === 'member' ? 'MEMBER (DP)' : 'REFERRED (CP)'}</span>
                        </div>
                        ${clientMembershipStatus === 'referred' ? `
                        <div class="info-line">
                            <span>Referred By:</span>
                            <span>${client.referralName || 'N/A'}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Consultant Info -->
                    <div class="section">
                        <div class="section-title">CONSULTANT</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span>${report.consultant}</span>
                        </div>
                        <div class="info-line">
                            <span>Date:</span>
                            <span>${new Date(report.timestamp).toLocaleDateString('en-GB')}</span>
                        </div>
                        <div class="info-line">
                            <span>Report ID:</span>
                            <span>${report.id}</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Prescribed Items -->
                    <div class="section">
                        <div class="section-title">PRESCRIBED PRODUCTS</div>
                        ${report.medicines.map(med => {
                            const price = findProductPrice(med.name);
                            const isPackage = price.isPackage;
                            let effectivePrice;
                            let isTaken;
                            
                            if (isPackage) {
                                const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                }
                                // For packages, show partial status if some items are dispensed
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    isTaken = '‚úì TAKEN';
                                } else if (packagePricing.dispensedCount > 0) {
                                    isTaken = `‚óê PARTIAL (${packagePricing.dispensedCount}/${packagePricing.totalCount})`;
                                } else {
                                    isTaken = '‚óã NOT TAKEN';
                                }
                            } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                isTaken = med.dispensed ? '‚úì TAKEN' : '‚óã NOT TAKEN';
                            }
                            
                            return `
                            <div class="item">
                                <div class="item-name">${med.name}${isPackage ? ' üì¶' : ''}</div>
                                <div class="item-status">
                                    <span>${isTaken}</span>
                                    <span class="bold">
                                        ${clientMembershipStatus === 'member' ? 
                                            `N$${effectivePrice.dp}` : 
                                            `N$${effectivePrice.cp}`}
                                    </span>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Totals -->
                    <div class="section">
                        <div class="section-title">SUMMARY</div>
                        <div class="info-line">
                            <span>Consultation Fee:</span>
                            <span>N$${consultationFee}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="total-line">
                            <span>TOTAL:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.total.dp}` : 
                                    `N$${totals.total.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Dispensed:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.dispensed.dp}` : 
                                    `N$${totals.dispensed.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Pending:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.pending.dp}` : 
                                    `N$${totals.pending.cp}`}
                            </span>
                        </div>
                        ${clientMembershipStatus === 'member' ? `
                        <div class="info-line">
                            <span>Total BV:</span>
                            <span>${totals.total.bv}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p style="color: #c41e3a; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                        <p style="margin-top: 3px;">Thank you for choosing Dynapharm!</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function showDailyStatementModal() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Generate preview content directly (same as what gets printed in A4)
            const content = document.getElementById('dailyStatementContent');
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Summary Statistics -->
                    <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üìä DAILY SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalClientsToday}</h3>
                                <p style="color: #666; font-size: 9pt;">Total Clients</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalMembers}</h3>
                                <p style="color: #666; font-size: 9pt;">Registered Members</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalReferred}</h3>
                                <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</h3>
                        ${Object.keys(statementData.consultantStats).map(consultantName => {
                            const stats = statementData.consultantStats[consultantName];
                            return `
                            <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #e3f2fd;">
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üì¶ PRODUCTS DISPENSED TODAY</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr style="background: #e8f5e9;">
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(statementData.productDispensed).map((product, idx) => `
                                    <tr>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${statementData.totalRevenue.bv}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.dp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(statementData.totalPaid.dp + statementData.totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal
            document.getElementById('dailyStatementModal').style.display = 'block';
        }
        
        function generateDailyStatementData() {
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            
            // Filter reports for today
            const todayReports = reports.filter(r => {
                const reportDate = new Date(r.timestamp);
                return reportDate >= startOfDay && reportDate <= endOfDay;
            });
            
            if (todayReports.length === 0) {
                alert('No consultations recorded for today');
                return;
            }
            
            // Group reports by consultant
            const consultantStats = {};
            let totalClientsToday = 0;
            let totalMembers = 0;
            let totalReferred = 0;
            let totalRevenue = { dp: 0, cp: 0, bv: 0 };
            let totalPaid = { dp: 0, cp: 0, bv: 0 };
            let totalOutstanding = { dp: 0, cp: 0, bv: 0 };
            
            // Product dispensing tracking
            const productDispensed = {};
            
            todayReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client) return;
                
                totalClientsToday++;
                const isMember = client.membershipStatus === 'member';
                if (isMember) totalMembers++;
                else totalReferred++;
                
                // Initialize consultant stats
                if (!consultantStats[report.consultant]) {
                    consultantStats[report.consultant] = {
                        totalClients: 0,
                        members: 0,
                        referred: 0,
                        clients: []
                    };
                }
                
                consultantStats[report.consultant].totalClients++;
                if (isMember) {
                    consultantStats[report.consultant].members++;
                } else {
                    consultantStats[report.consultant].referred++;
                }
                
                consultantStats[report.consultant].clients.push({
                    name: client.fullName,
                    type: isMember ? 'Member' : 'Referred',
                    referralNb: client.referralNbNumber || client.nbNumber || 'N/A',
                    referredBy: client.referralName || 'Self'
                });
                
                // Calculate totals
                if (report.medicines) {
                    const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                    
                    totalRevenue.dp += totals.total.dp;
                    totalRevenue.cp += totals.total.cp;
                    totalRevenue.bv += totals.total.bv;
                    
                    totalPaid.dp += totals.paid.dp;
                    totalPaid.cp += totals.paid.cp;
                    totalPaid.bv += totals.paid.bv;
                    
                    totalOutstanding.dp += totals.outstanding.dp;
                    totalOutstanding.cp += totals.outstanding.cp;
                    totalOutstanding.bv += totals.outstanding.bv;
                    
                    // Track dispensed products
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        const isPackage = price.isPackage;
                        
                        if (isPackage) {
                            // For packages, track individual items
                            const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                            if (packagePricing.dispensedCount > 0) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        partialCount: 0,
                                        fullCount: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].partialCount++;
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    productDispensed[med.name].fullCount++;
                                }
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += packagePricing.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += packagePricing.cp;
                                }
                            }
                        } else {
                            // For individual products
                            if (med.dispensed) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].quantity++;
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += price.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += price.cp;
                                }
                            }
                        }
                    });
                }
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        .summary-box {
                            background: #f8f9fa;
                            border: 2px solid #c41e3a;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-top: 10px;
                        }
                        
                        .summary-item {
                            background: white;
                            padding: 12px;
                            border-radius: 5px;
                            border-left: 4px solid #c41e3a;
                            text-align: center;
                        }
                        
                        .summary-item h3 {
                            color: #c41e3a;
                            font-size: 24pt;
                            margin-bottom: 5px;
                        }
                        
                        .summary-item p {
                            color: #666;
                            font-size: 9pt;
                        }
                        
                        .section {
                            margin-bottom: 25px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 8px 15px;
                            font-size: 12pt;
                            font-weight: bold;
                            border-radius: 5px;
                            margin-bottom: 10px;
                        }
                        
                        .consultant-section {
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            padding: 15px;
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                        }
                        
                        .consultant-section h4 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                            font-size: 11pt;
                        }
                        
                        .client-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .client-table th {
                            background: #e3f2fd;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .client-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .product-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .product-table th {
                            background: #e8f5e9;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .product-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .totals-section {
                            background: #fff3cd;
                            border: 2px solid #ffc107;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        
                        .totals-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        
                        .total-item {
                            background: white;
                            padding: 10px;
                            border-radius: 5px;
                            border-left: 3px solid #f39c12;
                        }
                        
                        .total-item strong {
                            color: #c41e3a;
                            font-size: 11pt;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #c41e3a;
                            font-size: 9pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="summary-box">
                        <h3 style="color: #c41e3a; margin-bottom: 10px; text-align: center;">üìä DAILY SUMMARY</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <h3>${totalClientsToday}</h3>
                                <p>Total Clients</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalMembers}</h3>
                                <p>Registered Members</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalReferred}</h3>
                                <p>Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div class="section">
                        <div class="section-title">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</div>
                        ${Object.keys(consultantStats).map(consultantName => {
                            const stats = consultantStats[consultantName];
                            return `
                            <div class="consultant-section">
                                <h4>üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total Clients:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table class="client-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Client Name</th>
                                            <th>Type</th>
                                            <th>Referral NB</th>
                                            <th>Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td>${idx + 1}</td>
                                                <td>${client.name}</td>
                                                <td>${client.type}</td>
                                                <td>${client.referralNb}</td>
                                                <td>${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div class="section">
                        <div class="section-title">üì¶ PRODUCTS DISPENSED TODAY</div>
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product Name</th>
                                    <th>Quantity Dispensed</th>
                                    <th>Revenue (DP)</th>
                                    <th>Revenue (CP)</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(productDispensed).map((product, idx) => `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${product.name}</td>
                                        <td>
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td>N$${product.revenue.dp.toFixed(2)}</td>
                                        <td>N$${product.revenue.cp.toFixed(2)}</td>
                                        <td><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="totals-section">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                        <div class="totals-grid">
                            <div class="total-item">
                                <strong>Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${totalRevenue.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Paid BV: ${totalPaid.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (DP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Outstanding BV: ${totalOutstanding.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (CP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 12pt; color: #27ae60;">TOTAL CASH COLLECTED: N$${(totalPaid.dp + totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            return statementData;
        }
        
        function generateDailyStatementHTML(data, isThermal) {
            if (isThermal) {
                // Thermal receipt format - compact and bold
                return `
                    <div style="font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold;">
                        <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                            <div style="font-size: 11pt; font-weight: bold;">DYNAPHARM NAMIBIA</div>
                            <div style="font-size: 9pt;">DAILY STATEMENT</div>
                            <div style="font-size: 8pt;">${new Date().toLocaleDateString('en-GB')}</div>
                        </div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">SUMMARY</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total Clients:</span><span>${data.totalClientsToday}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Members:</span><span>${data.totalMembers}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Referred:</span><span>${data.totalReferred}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">REVENUE</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total DP:</span><span>N$${data.totalRevenue.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total CP:</span><span>N$${data.totalRevenue.cp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total BV:</span><span>${data.totalRevenue.bv}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">CASH COLLECTED</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid DP:</span><span>N$${data.totalPaid.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid CP:</span><span>N$${data.totalPaid.cp.toFixed(2)}</span>
                            </div>
                            <div style="border-top: 1px solid #000; margin: 4px 0;"></div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0; font-size: 11pt;">
                                <span>TOTAL:</span><span>N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">OUTSTANDING</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding DP:</span><span>N$${data.totalOutstanding.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding CP:</span><span>N$${data.totalOutstanding.cp.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 8pt;">
                            <div>HEALTH | WEALTH | FREEDOM</div>
                        </div>
                    </div>
                `;
            } else {
                // A4 format - full detailed report
                return `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <!-- Summary Statistics -->
                        <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üìä DAILY SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalClientsToday}</h3>
                                    <p style="color: #666; font-size: 9pt;">Total Clients</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalMembers}</h3>
                                    <p style="color: #666; font-size: 9pt;">Registered Members</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalReferred}</h3>
                                    <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consultant Breakdown -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è CONSULTANTS BREAKDOWN</h3>
                            ${Object.keys(data.consultantStats).map(consultantName => {
                                const stats = data.consultantStats[consultantName];
                                return `
                                <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ${consultantName}</h4>
                                    <p style="margin-bottom: 10px; color: #666;">
                                        <strong>Total:</strong> ${stats.totalClients} | 
                                        <strong>Members:</strong> ${stats.members} | 
                                        <strong>Referred:</strong> ${stats.referred}
                                    </p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                        <thead>
                                            <tr style="background: #e3f2fd;">
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${stats.clients.map((client, idx) => `
                                                <tr>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Products Dispensed -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">üì¶ PRODUCTS DISPENSED TODAY</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                <thead>
                                    <tr style="background: #e8f5e9;">
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(data.productDispensed).map((product, idx) => `
                                        <tr>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                                ${product.quantity !== undefined ? 
                                                    `${product.quantity} units` : 
                                                    `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                            </td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Financial Summary -->
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üí∞ FINANCIAL SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.dp.toFixed(2)}</p>
                                    <p style="font-size: 9pt; color: #666;">Total BV: ${data.totalRevenue.bv}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.cp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.dp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.cp.toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                                <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // For preview (non-thermal), just return empty for now - modal will use direct content
            return '';
        }
        
        function printDailyStatementA4() {
            // Close modal first
            closeModal('dailyStatementModal');
            // Use the existing A4 print function logic
            printDailyStatement();
        }
        
        function printDailyStatementThermal() {
            // Close modal first
            closeModal('dailyStatementModal');
            
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${generateDailyStatementHTML(statementData, true)}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function printDailyStatement() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Create A4 print window with full statement
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${generateDailyStatementHTML(statementData, false)}
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #c41e3a; font-size: 9pt; color: #666;">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function toggleDispense(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (report && report.medicines && report.medicines[medIndex]) {
        if (!hasActionPermission('dispense')) { alert('You do not have permission to dispense.'); return; }
                const medicine = report.medicines[medIndex];
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                
        // For packages, guide for partial/all dispensing
        if (isPackage) {
            const packageProducts = price.products || [];
            const allGiven = packageProducts.every(product => 
                medicine.packageStatus && medicine.packageStatus[product] === 'given'
            );
            if (!allGiven) {
                const doAll = confirm('Some items in this package are not marked as Given.\n\nOK: Mark all remaining as Given and dispense the full package.\nCancel: Keep partial (do not set as fully dispensed).');
                if (!doAll) { return; }
                medicine.packageStatus = medicine.packageStatus || {};
                packageProducts.forEach(p => { if (medicine.packageStatus[p] !== 'given') medicine.packageStatus[p] = 'given'; });
            }
        }

        // Due-out/backorder check when dispensing
        if (!medicine.dispensed) {
            try {
                const inv = (window.inventory && window.inventory[medicine.name]) ? window.inventory[medicine.name] : null;
                const neededQty = Number(medicine.quantity || 1);
                const available = inv ? Number(inv.currentStock || 0) : Infinity;
                if (available < neededQty) {
                    const proceed = confirm(`Insufficient stock for ${medicine.name}.\nAvailable: ${available}, Needed: ${neededQty}.\n\nOK: Mark as Due-out\nCancel: Abort dispensing`);
                    if (proceed) {
                        medicine.dueOut = Math.max(0, neededQty - available);
                        try { const res = await apiRequest('/reports', 'PUT', report); if (res?.success) { const idx = reports.findIndex(r=>r.id===reportId); if (idx!==-1) reports[idx]=report; displayPrescriptions(); alert('üì¶ Item marked as Due-out.'); } } catch(_){ }
                        return;
                    } else {
                        return;
                    }
                }
            } catch(_){ }
        }
                
                medicine.dispensed = !medicine.dispensed;
                
                // Update dispensed timestamp
                if (medicine.dispensed) {
                    medicine.dispensedBy = currentUser.fullName;
                    medicine.dispensedAt = new Date().toISOString();
            // FEFO lot assignment if available
            try {
                const lot = pickFefoLot(medicine.name, Number(medicine.quantity||1));
                if (lot) { medicine.lotBatch = lot.batch; medicine.lotExpiry = lot.expiry; }
            } catch(_){ }
            try { adjustInventoryForDispense(report, medicine, Number(medicine.quantity||1)); } catch(_){ }
                } else {
                    delete medicine.dispensedBy;
                    delete medicine.dispensedAt;
                    delete medicine.paid;
                    delete medicine.paidBy;
                    delete medicine.paidAt;
                    
                    // For packages, also reset individual product statuses
                    if (isPackage) {
                        const packageProducts = price.products || [];
                        packageProducts.forEach(product => {
                            if (medicine.packageStatus) {
                                medicine.packageStatus[product] = 'not_given';
                            }
                        });
                    }
                }
                
                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        // Update local data
                        const index = reports.findIndex(r => r.id === reportId);
                        if (index !== -1) {
                            reports[index] = report;
                        }
                        displayPrescriptions();
                        alert(`‚úÖ ${isPackage ? 'Package' : 'Medicine'} status updated successfully`);
                    } else {
                        console.error('Backend error:', result);
                        alert('Error updating prescription: ' + (result.error || result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            } else {
                alert('Report or medicine not found');
            }
        }

        async function togglePayment(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) {
                alert('Report or medicine not found');
                return;
            }
            
            const medicine = report.medicines[medIndex];
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            // If marking as paid, show payment details dialog
            if (!medicine.paid) {
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                let amount;
                
                if (isPackage) {
                    const packagePricing = calculatePackagePricing(medicine, client.membershipStatus);
                    amount = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                } else {
                    amount = client.membershipStatus === 'member' ? price.dp : price.cp;
                }
                
                // Show payment method selection
                const paymentMethod = prompt(`Payment for: ${medicine.name}\nAmount: N$${amount}\n\nEnter payment method:\n1 - Cash\n2 - Card\n3 - Mobile Money\n4 - Bank Transfer\n\nEnter number (1-4):`);
                
                if (!paymentMethod) return; // Cancelled
                
                const methods = { '1': 'Cash', '2': 'Card', '3': 'Mobile Money', '4': 'Bank Transfer' };
                const method = methods[paymentMethod] || 'Cash';
                
                // Initialize payment history if not exists
                if (!medicine.paymentHistory) {
                    medicine.paymentHistory = [];
                }
                
                // Add payment record
                medicine.paymentHistory.push({
                    amount: amount,
                    method: method,
                    paidBy: currentUser.fullName,
                    paidAt: new Date().toISOString(),
                    reference: 'PAY' + Date.now()
                });
                
                medicine.paid = true;
                medicine.paidBy = currentUser.fullName;
                medicine.paidAt = new Date().toISOString();
                medicine.paymentMethod = method;
                medicine.amountPaid = amount;
            } else {
                // Unpay - remove payment info
                medicine.paid = false;
                delete medicine.paidBy;
                delete medicine.paidAt;
                delete medicine.paymentMethod;
                delete medicine.amountPaid;
            }
            
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    const index = reports.findIndex(r => r.id === reportId);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                    displayPrescriptions();
                    if (medicine.paid) {
                        alert(`‚úÖ Payment recorded successfully\nMethod: ${medicine.paymentMethod}\nAmount: N$${medicine.amountPaid}`);
                    }
                } else {
                    console.error('Backend error:', result);
                    alert('Error updating payment: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error updating payment. Please try again.');
            }
        }

        function viewPaymentHistory(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) return;
            
            const medicine = report.medicines[medIndex];
            
            if (!medicine.paymentHistory || medicine.paymentHistory.length === 0) {
                alert('No payment history available for this item');
                return;
            }
            
            let historyHTML = `
                <div style="padding: 20px;">
                    <h3>Payment History: ${medicine.name}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Amount</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Method</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Received By</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Reference</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${medicine.paymentHistory.map(payment => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${new Date(payment.paidAt).toLocaleString('en-GB')}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">N$${payment.amount.toFixed(2)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.method}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.paidBy}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.reference}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="printPaymentReceipt('${reportId}', ${medIndex})">üßæ Print Receipt</button>
                    </div>
                </div>
            `;
            
            alert(historyHTML.replace(/<[^>]*>/g, '\\n').replace(/\\n+/g, '\\n'));
        }

        function printPaymentReceipt(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            const medicine = report.medicines[medIndex];
            
            if (!medicine || !medicine.paymentHistory) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Payment Receipt</title>
                    <style>
                        @page { size: 80mm auto; margin: 0; }
                        body { font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold; padding: 5mm; width: 80mm; background: #fff; }
                        .center { text-align: center; }
                        .divider { border-top: 1px dashed #c41e3a; margin: 6px 0; }
                        .info-item { margin: 8px 0; font-size: 9pt; }
                        .info-item strong { color: #c41e3a; }
                        .amount { color: #27ae60; font-weight: bold; font-size: 10pt; }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 5px;">
                        ${generateLogoSVG(60, 40)}
                    </div>
                    
                    <div class="center" style="border-bottom: 2px solid #c41e3a; padding-bottom: 8px; margin-bottom: 10px; background: linear-gradient(135deg, rgba(196,30,58,0.1) 0%, rgba(139,0,0,0.1) 100%); border-radius: 4px;">
                        <div style="font-size: 12pt; color: #c41e3a; font-weight: 900;">DYNAPHARM NAMIBIA</div>
                        <div style="font-size: 9pt; color: #c41e3a; font-weight: bold;">PAYMENT RECEIPT</div>
                        <div style="font-size: 8pt; color: #666;">${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    
                    <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #c41e3a; font-size: 9pt;">
                        <div><strong>Client:</strong> ${client.fullName}</div>
                        <div><strong>Report:</strong> ${report.id}</div>
                        <div><strong>Product:</strong> ${medicine.name}</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    ${medicine.paymentHistory.map(payment => `
                        <div class="info-item" style="background: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #c41e3a;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Amount:</strong></span>
                                <span class="amount">N$${payment.amount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Method:</strong></span>
                                <span>${payment.method}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Ref:</strong></span>
                                <span>${payment.reference}</span>
                            </div>
                            <div style="font-size: 8pt; margin-top: 3px; color: #666; text-align: right;">
                                ${new Date(payment.paidAt).toLocaleString('en-GB')}
                            </div>
                        </div>
                    `).join('<div class="divider"></div>')}
                    
                    <div class="divider"></div>
                    
                    <div class="center" style="margin-top: 12px; padding-top: 8px; border-top: 2px solid #c41e3a; font-size: 8pt;">
                        <div style="color: #c41e3a; font-weight: bold;">HEALTH | WEALTH | FREEDOM</div>
                        <div style="margin-top: 3px;">Thank you for choosing Dynapharm!</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function markDispensed(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (report) {
                // FEFO deduction across barcode/batch stock first
                const products = (report.medicines || []).map(m => ({ name: m.name, quantity: m.quantity || 1 }));
                const branchId = (currentUser && currentUser.branch) || (selectedBranch && selectedBranch.id) || 'unknown_branch';
                const userName = (currentUser && currentUser.fullName) || 'system';
                const fefoResult = await fefoDispenseProducts(products, branchId, userName, report.id);
                if (!fefoResult.success) {
                    alert('‚ö†Ô∏è FEFO deduction issues for prescription:\n' + fefoResult.errors.join('\n'));
                }

                // Also update simple inventory counters for legacy displays
                const invReduction = reduceInventoryForProducts(products, userName, report.id);
                if (!invReduction.success && (!fefoResult || !fefoResult.success)) {
                    // Only block if both mechanisms report failures across the board
                    alert('‚ö†Ô∏è Stock deduction issues persisted. Please review inventory.');
                }

                report.dispensed = true;
                report.dispensedBy = currentUser.fullName;
                report.dispensedAt = new Date().toISOString();
                
                // Record department event
                recordDepartmentEvent('prescription_dispensed', {
                    reportId: report.id,
                    clientId: report.clientId,
                    medicines: products
                });

                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        alert('‚úÖ Prescription marked as dispensed');
                        try { localStorage.setItem('dyna_reports', JSON.stringify(reports)); } catch(_) {}
                        try { window.dispatchEvent(new CustomEvent('reports:updated', { detail: { id: report.id, action: 'dispensed' } })); } catch(_) {}
                        try { fetch('/api/realtime_publish', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ channel: 'reports', event: { id: report.id, action: 'dispensed', ts: Date.now() } }) }); } catch(_) {}
                        try {
                            const m = document.querySelector('meta[name="rt-base"]');
                            const rtBase = m && m.content && m.content.trim();
                            if (rtBase) {
                                fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ event: { id: report.id, action: 'dispensed', ts: Date.now() } })
                                });
                            }
                        } catch(_) {}
                        displayPrescriptions();
                        if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                            try { if (typeof displayMyReports === 'function') displayMyReports(); } catch(e) { console.debug('displayMyReports error:', e); }
                        }
                    } else {
                        alert('Error updating prescription: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            }
        }

        function showAddUser() {
            loadBranches();
            loadBranchCheckboxes();
            document.getElementById('addUserModal').style.display = 'block';
        }

        function loadBranchCheckboxes() {
            const branchCheckboxes = document.getElementById('branchCheckboxes');
            branchCheckboxes.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="additionalBranches" value="${branch.id}" style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                branchCheckboxes.appendChild(checkboxDiv);
            });
        }

        function toggleAllBranchesAccess() {
            const checkbox = document.getElementById('allBranchesCheckbox');
            const branchSelect = document.getElementById('userBranchSelect');
            const additionalBranches = document.getElementById('additionalBranches');
            
            if (checkbox && checkbox.checked) {
                if (branchSelect) branchSelect.disabled = true;
                if (additionalBranches) additionalBranches.style.display = 'none';
            } else {
                if (branchSelect) branchSelect.disabled = false;
                // Check if role is consultant or sales_staff to show additional branches
                const role = document.querySelector('select[name="role"]')?.value;
                if ((role === 'consultant' || role === 'sales_staff') && additionalBranches) {
                    additionalBranches.style.display = 'block';
                }
            }
        }
        
        function updatePortalAccessByRole() {
            const roleSelect = document.querySelector('select[name="role"]');
            const role = roleSelect?.value;
            if (!role) return;
            
            const defaultPortals = ROLE_PORTAL_ACCESS[role] || ['client'];
            const portalCheckboxes = document.querySelectorAll('input[name="portalAccess"]');
            
            portalCheckboxes.forEach(cb => {
                cb.checked = defaultPortals.includes(cb.value);
            });
        }
        
        function toggleAdditionalBranches() {
            const roleSelect = document.querySelector('select[name="role"]');
            const additionalBranches = document.getElementById('additionalBranches');
            
            if (roleSelect.value === 'consultant' || roleSelect.value === 'sales_staff') {
                additionalBranches.style.display = 'block';
            } else {
                additionalBranches.style.display = 'none';
                // Clear all checkboxes when not consultant or sales_staff
                const checkboxes = document.querySelectorAll('input[name="additionalBranches"]');
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Get selected additional branches for consultants
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="additionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));
            
            // Get selected portal access
            const portalAccess = [];
            const portalCheckboxes = document.querySelectorAll('input[name="portalAccess"]:checked');
            portalCheckboxes.forEach(cb => portalAccess.push(cb.value));
            
            // Determine branch access
            const allBranchesAccess = document.getElementById('allBranchesCheckbox').checked;
            const primaryBranch = formData.get('branch') || null;
            
            // Create branches array - primary branch + additional branches
            let allBranches = [];
            if (allBranchesAccess) {
                // User has access to all branches
                allBranches = ['*']; // Special marker for all branches
            } else {
                if (primaryBranch) {
                    allBranches.push(primaryBranch);
                }
            if (formData.get('role') === 'consultant' || formData.get('role') === 'sales_staff') {
                additionalBranches.forEach(branchId => {
                        if (branchId !== primaryBranch && !allBranches.includes(branchId)) {
                        allBranches.push(branchId);
                    }
                });
                }
            }
            
            // Handle photo upload
            let photoBase64 = null;
            const photoFile = document.getElementById('userPhotoInput').files[0];
            if (photoFile) {
                try {
                    photoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(photoFile);
                    });
                } catch (error) {
                    console.error('Error reading photo:', error);
                }
            }
            
            const newUser = {
                id: 'USR' + Date.now(),
                username: formData.get('username'),
                password: formData.get('password'),
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                role: formData.get('role'),
                branch: primaryBranch || null,
                branches: allBranches,
                allBranchesAccess: allBranchesAccess,
                portalAccess: portalAccess.length > 0 ? portalAccess : (ROLE_PORTAL_ACCESS[formData.get('role')] || ['client']),
                photo: photoBase64,
                createdAt: new Date().toISOString()
            };
            
            if (users.find(u => (u.username || '').toLowerCase() === newUser.username.toLowerCase())) {
                if (statusEl) {
                    statusEl.innerHTML = '<span style="color: #dc2626;">A user with that username already exists.</span>';
                } else {
                alert('Username exists');
                }
                return;
            }
            
            try {
                if (statusEl) {
                    statusEl.innerHTML = '<span style="color: #0f172a;">‚è≥ Creating user...</span>';
                }

                const result = await apiRequest('/users', 'POST', newUser);

                if (result && result.success === false) {
                    throw new Error(result.message || 'Server rejected the request');
                }

                let createdUser = null;
                if (result && result.user) {
                    createdUser = result.user;
                } else if (Array.isArray(result?.data) && result.data.length > 0) {
                    createdUser = result.data[0];
                } else if (Array.isArray(result) && result.length > 0) {
                    createdUser = result[result.length - 1];
                } else if (result && result.id) {
                    createdUser = result;
                }

                if (!createdUser) {
                    createdUser = { ...newUser };
                }

                if (!createdUser.id) {
                    createdUser.id = newUser.id;
                }

                createdUser.role = createdUser.role || newUser.role;
                createdUser.portalAccess = createdUser.portalAccess || newUser.portalAccess;
                createdUser.branches = createdUser.branches || newUser.branches;
                createdUser.branch = createdUser.branch || newUser.branch;

                users = users.filter(u => u.id !== createdUser.id).concat([createdUser]);
                try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {
                    console.warn('Unable to persist users locally:', e);
                }

                try {
                    window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: createdUser, action: 'created' } }));
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'users:updated', user: createdUser, action: 'created', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'users', event: { user: createdUser, action: 'created', ts: Date.now() } })
                        }).catch(_ => {});
                    } catch (_) {}

                loadUserList();

                if (statusEl) {
                    statusEl.innerHTML = `<span style="color: #16a34a;">‚úÖ ${createdUser.fullName || createdUser.username} added successfully.</span>`;
                }

            this.reset();
                const preview = document.getElementById('userPhotoPreview');
                const previewImg = document.getElementById('userPhotoPreviewImg');
                if (preview) preview.style.display = 'none';
                if (previewImg) previewImg.src = '';

                setTimeout(() => {
                    closeModal('addUserModal');
                    if (statusEl) statusEl.innerHTML = '';
                }, 1000);

                    await refreshAllData();
            } catch (error) {
                console.error('Error creating user:', error);
                if (statusEl) {
                    statusEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${error.message || 'Error creating user. Please try again.'}</span>`;
                } else {
                alert('Error creating user. Please try again.');
                }
            }
        });

        function loadUserList() {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(user => {
                const branchName = branches.find(b => b.id === user.branch)?.name || user.branch;
                const userBranches = user.branches || [user.branch];
                const branchNames = userBranches.map(branchId => 
                    branches.find(b => b.id === branchId)?.name || branchId
                ).join(', ');
                
                const card = document.createElement('div');
                card.className = 'client-card';
                const userPhoto = user.photo ? (typeof user.photo === 'string' && user.photo.startsWith('data:') ? user.photo : `data:image/jpeg;base64,${user.photo}`) : null;
                
                // Check if current user is admin
                const isAdmin = currentUser && currentUser.role === 'admin';
                
                card.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: start;">
                        ${userPhoto ? `<img src="${userPhoto}" alt="${user.fullName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">` : '<div style="width: 80px; height: 80px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px;">üë§</div>'}
                        <div style="flex: 1;">
                    <h4>${user.fullName} (${user.username})</h4>
                    <p>Role: ${user.role} | Primary Branch: ${branchName}</p>
                    <p>All Branches: ${branchNames}</p>
                    <p>Email: ${user.email || 'Not provided'} | Phone: ${user.phone || 'Not provided'}</p>
                    ${isAdmin ? `<p id="password-display-${user.id}" style="margin-top: 5px; font-family: monospace; color: #666; display: none;">Password: <span id="password-value-${user.id}">${user.password || 'N/A'}</span></p>` : ''}
                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${isAdmin ? `
                            <button class="btn btn-info" onclick="togglePasswordView('${user.id}', this)" id="password-toggle-${user.id}" style="font-size: 0.85rem; padding: 6px 12px;">üëÅÔ∏è View Password</button>
                            <button class="btn btn-primary" onclick="showResetPasswordModal('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">üîë Reset Password</button>
                        ` : ''}
                        ${user.username !== 'admin' ? `
                            <button class="btn btn-warning" onclick="editUserBranches('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">Edit Branches</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">üóëÔ∏è Delete</button>
                        ` : '<p style="color: #27ae60; margin: 0;">Protected</p>'}
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function togglePasswordView(userId, buttonElement) {
            const passwordDisplay = document.getElementById(`password-display-${userId}`);
            const passwordValue = document.getElementById(`password-value-${userId}`);
            const button = buttonElement || document.getElementById(`password-toggle-${userId}`);
            
            if (!passwordDisplay || !passwordValue) return;
            
            if (passwordDisplay.style.display === 'none' || passwordDisplay.style.display === '') {
                passwordDisplay.style.display = 'block';
                if (button) button.textContent = 'üôà Hide Password';
            } else {
                passwordDisplay.style.display = 'none';
                if (button) button.textContent = 'üëÅÔ∏è View Password';
            }
        }

        function showResetPasswordModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            const userIdInput = document.getElementById('resetPasswordUserId');
            const usernameSpan = document.getElementById('resetPasswordUsername');
            const fullNameSpan = document.getElementById('resetPasswordFullName');
            const modal = document.getElementById('resetPasswordModal');
            
            if (!userIdInput || !usernameSpan || !fullNameSpan || !modal) {
                console.error('Reset password modal elements not found');
                alert('Error: Reset password modal not properly initialized');
                return;
            }
            
            userIdInput.value = userId;
            usernameSpan.textContent = user.username;
            fullNameSpan.textContent = user.fullName;
            modal.style.display = 'block';
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                const deletedUser = users.find(u => u.id === userId);
                const fallbackUser = deletedUser || { id: userId, fullName: 'Selected user', username: userId };
                const statusMessage = `Deleting ${fallbackUser.fullName || fallbackUser.username}...`;
                console.log(statusMessage);
                try {
                    const result = await apiRequest(`/users?id=${encodeURIComponent(userId)}`, 'DELETE', { id: userId });
                    if (result && result.success === false) {
                        const message = result.message || 'Server rejected the request.';
                        alert('Error deleting user: ' + message);
                        return;
                    }

                users = users.filter(u => u.id !== userId);
                try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}

                        // Broadcast user update event for real-time sync
                        try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: fallbackUser, action: 'deleted' } }));
                            const m = document.querySelector('meta[name="rt-base"]');
                            const rtBase = m && m.content && m.content.trim();
                            if (rtBase) {
                                fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: fallbackUser, action: 'deleted', ts: Date.now() } })
                                }).catch(_ => {});
                            }
                            fetch('/api/realtime_publish', { 
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: fallbackUser, action: 'deleted', ts: Date.now() } })
                            }).catch(_ => {});
                        } catch (_) {}

                    alert(`‚úÖ ${fallbackUser.fullName || fallbackUser.username} deleted successfully`);
                    loadUserList();
                        await refreshAllData();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user. Please try again.');
                }
            }
        }

        let editingUserId = null;

        function editUserBranches(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            
            // Show user info
            document.getElementById('editUserInfo').innerHTML = `
                <h4>${user.fullName} (${user.username})</h4>
                <p>Role: ${user.role}</p>
            `;

            // Populate primary branch dropdown
            const primarySelect = document.getElementById('editPrimaryBranch');
            primarySelect.innerHTML = '<option value="">Select Primary Branch</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                if (branch.id === user.branch) {
                    option.selected = true;
                }
                primarySelect.appendChild(option);
            });

            // Populate additional branches checkboxes
            const checkboxesDiv = document.getElementById('editBranchCheckboxes');
            checkboxesDiv.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                
                const isChecked = user.branches && user.branches.includes(branch.id) && branch.id !== user.branch;
                
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="editAdditionalBranches" value="${branch.id}" ${isChecked ? 'checked' : ''} style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                checkboxesDiv.appendChild(checkboxDiv);
            });

            // Show/hide additional branches based on role
            if (user.role === 'consultant') {
                checkboxesDiv.style.display = 'block';
            } else {
                checkboxesDiv.style.display = 'none';
            }

            document.getElementById('editBranchesModal').style.display = 'block';
        }

        document.getElementById('editBranchesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (!editingUserId) return;

            const user = users.find(u => u.id === editingUserId);
            if (!user) return;

            // Get selected additional branches
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="editAdditionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));

            // Create branches array
            const allBranches = [formData.get('primaryBranch')];
            if (user.role === 'consultant') {
                additionalBranches.forEach(branchId => {
                    if (branchId !== formData.get('primaryBranch')) {
                        allBranches.push(branchId);
                    }
                });
            }

            // Update user
            const updatedUser = {
                ...user,
                branch: formData.get('primaryBranch'),
                branches: allBranches
            };

            try {
                const result = await apiRequest('/users', 'PUT', updatedUser);
                if (result.success) {
                    // Update local users array
                    const userIndex = users.findIndex(u => u.id === editingUserId);
                    if (userIndex !== -1) {
                        users[userIndex] = updatedUser;
                    }
                    try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    // Broadcast user update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: updatedUser, action: 'updated' } }));
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: updatedUser, action: 'updated', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: updatedUser, action: 'updated', ts: Date.now() } }) 
                        }).catch(_ => {});
                    } catch (_) {}
                    alert('‚úÖ User branches updated successfully');
                    closeModal('editBranchesModal');
                loadUserList();
                } else {
                    alert('Error updating user branches: ' + result.message);
            }
            } catch (error) {
                console.error('Error updating user branches:', error);
                alert('Error updating user branches. Please try again.');
        }
        });

                function showChangePassword() {
            const usernameField = document.querySelector('#changePasswordForm input[name="username"]');
            if (usernameField && currentUser) {
                usernameField.value = currentUser.username || currentUser.id || '';
            }
            document.getElementById('changePasswordModal').style.display = 'block';                                                                             
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (formData.get('currentPassword') !== currentUser.password) {
                alert('Current password incorrect');
                return;
            }
            
            if (formData.get('newPassword') !== formData.get('confirmPassword')) {
                alert('Passwords do not match');
                return;
            }
            
            currentUser.password = formData.get('newPassword');
            
            try {
                const result = await apiRequest('/users', 'PUT', currentUser);
                if (result.success) {
            const index = users.findIndex(u => u.id === currentUser.id);
            users[index] = currentUser;
            try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    alert('‚úÖ Password changed successfully');
            closeModal('changePasswordModal');
            this.reset();
                } else {
                    alert('Error changing password: ' + result.message);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password. Please try again.');
            }
        });

        // Admin Reset Password Form Handler
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        if (resetPasswordForm) {
            resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Check if current user is admin
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Only administrators can reset user passwords');
                return;
            }
            
            const userId = formData.get('userId');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (!newPassword || newPassword.length < 3) {
                alert('Password must be at least 3 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            // Update user password
            const updatedUser = {
                ...user,
                password: newPassword
            };
            
            try {
                const result = await apiRequest('/users', 'PUT', updatedUser);
                if (result.success) {
                    // Update local users array
                    const userIndex = users.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        users[userIndex] = updatedUser;
                    }
                    try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    
                    // Broadcast user update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: updatedUser, action: 'password_reset' } }));
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: updatedUser, action: 'password_reset', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: updatedUser, action: 'password_reset', ts: Date.now() } }) 
                        }).catch(_ => {});
                    } catch (_) {}
                    
                    alert(`‚úÖ Password reset successfully for ${user.fullName} (${user.username})`);
                    closeModal('resetPasswordModal');
                    this.reset();
                    loadUserList(); // Refresh user list to show updated password
                } else {
                    alert('Error resetting password: ' + result.message);
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Error resetting password. Please try again.');
            }
        });
        }

        async function addBranch() {
            const nameInput = document.getElementById('newBranchName');
            const locationInput = document.getElementById('newBranchLocation');
            const phoneInput = document.getElementById('newBranchPhone');
            const name = nameInput?.value?.trim();
            if (!name) {
                alert('Enter branch name');
                return;
            }

            const branch = {
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name,
                location: locationInput?.value?.trim() || null,
                phone: phoneInput?.value?.trim() || null
            };

            try {
                const result = await apiRequest('/branches', 'POST', branch);
                if (result?.success) {
                    if (nameInput) nameInput.value = '';
                    if (locationInput) locationInput.value = '';
                    if (phoneInput) phoneInput.value = '';
                    await syncBranchesFromBackend(true);
                    loadBranches();
                    loadBranchListAdmin();
                    alert('‚úÖ Branch added successfully');
                } else {
                    alert('Error adding branch: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding branch:', error);
                alert('Error adding branch. Please try again.');
            }
        }

        function loadBranchListAdmin() {
            const list = document.getElementById('branchList');
            list.innerHTML = '';
            branches.forEach(branch => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <h4>${branch.name}</h4>
                    <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')">Delete</button>
                `;
                list.appendChild(card);
            });
        }

        async function deleteBranch(branchId) {
            if (!branchId) return;
            if (!confirm('Delete branch?')) return;
            try {
                const result = await apiRequest(`/branches?id=${branchId}`, 'DELETE');
                if (result?.success) {
                    await syncBranchesFromBackend(true);
                    loadBranches();
                    loadBranchListAdmin();
                    alert('‚úÖ Branch deleted successfully');
                } else {
                    alert('Error deleting branch: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting branch:', error);
                alert('Failed to delete branch. Please try again.');
            }
        }