 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#c41e3a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dynapharm">
    <link rel="manifest" href="./manifest.json">
    <!-- Explicit favicon to avoid /favicon.ico 404s -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23c41e3a'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, Helvetica, sans-serif' font-size='28' fill='%23ffffff'%3ED%3C/text%3E%3C/svg%3E">
    <script src="./cloud-sync.js"></script>
    <script src="./inventory-reporting.js"></script>
    <script>
        // Suppress console noise from expected image 404 errors
        // Note: Product images may not exist for all products, 404s are expected and handled gracefully
        (function() {
            const originalError = console.error;
            const originalWarn = console.warn;
            
            // Filter console.error calls
            console.error = function(...args) {
                // Filter out image 404 errors to reduce console noise
                const message = args.join(' ');
                if (message.includes('404') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    // Silently ignore expected image 404 errors - they're handled by onerror handlers
                    return;
                }
                // Filter 507 (Insufficient Storage) errors for images
                if (message.includes('507') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    return;
                }
                originalError.apply(console, args);
            };
            
            // Filter console.warn calls
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('404') && (message.includes('wp-content/uploads/products') || message.includes('.jpg') || message.includes('.png') || message.includes('dynapharm.net/ph/wp-content'))) {
                    return;
                }
                originalWarn.apply(console, args);
            };
            
            // Intercept network errors using global error handler
            window.addEventListener('error', function(event) {
                // Check if it's an image loading error
                if (event.target && event.target.tagName === 'IMG') {
                    const src = event.target.src || '';
                    if (src.includes('wp-content/uploads/products') || src.includes('dynapharm.net/ph/wp-content')) {
                        // Suppress the error - it's already handled by onerror handlers
                        event.preventDefault();
                        return false;
                    }
                }
                // Allow other errors through
            }, true); // Use capture phase to catch before default handlers
            
            // Intercept unhandled promise rejections from image loading
            window.addEventListener('unhandledrejection', function(event) {
                const reason = event.reason?.message || event.reason?.toString() || '';
                if (reason.includes('404') || reason.includes('wp-content/uploads/products') || reason.includes('dynapharm.net/ph/wp-content')) {
                    event.preventDefault();
                }
            });
        })();
        
        // Collect local data (localStorage + IndexedDB) and upload to /api/collect
        async function collectAndUploadSnapshot(providedToken) {
            try {
                const token = providedToken || (window.cloudStorage && window.cloudStorage.getStoredToken && window.cloudStorage.getStoredToken()) || '';
                if (!token) {
                    alert('GitHub token required to upload snapshot. Click the Save to Cloud button to store one.');
                    return { success: false };
                }

                // Gather localStorage keys starting with "dyna_"
                const ls = {};
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith('dyna_')) {
                            try { ls[k] = JSON.parse(localStorage.getItem(k)); } catch(_) { ls[k] = localStorage.getItem(k); }
                        }
                    }
                } catch(_) {}

                // Dump IndexedDB: DynapharmDB stores if present
                async function dumpIndexedDB() {
                    const out = {};
                    try {
                        const req = indexedDB.open('DynapharmDB');
                        const db = await new Promise((resolve, reject) => {
                            req.onerror = () => reject(req.error);
                            req.onsuccess = () => resolve(req.result);
                        });
                        const storeNames = Array.from(db.objectStoreNames || []);
                        for (const name of storeNames) {
                            try {
                                const tx = db.transaction(name, 'readonly');
                                const store = tx.objectStore(name);
                                const getAllReq = store.getAll();
                                const rows = await new Promise((resolve, reject) => {
                                    getAllReq.onerror = () => resolve([]);
                                    getAllReq.onsuccess = () => resolve(getAllReq.result || []);
                                });
                                out[name] = rows;
                            } catch(_) {}
                        }
                        try { db.close(); } catch(_) {}
                    } catch(_) {}
                    return out;
                }

                const idb = await dumpIndexedDB();

                const meta = {
                    hostname: location.hostname,
                    href: location.href,
                    userAgent: navigator.userAgent,
                    at: new Date().toISOString(),
                    currentUser: (window.currentUser && window.currentUser.username) || null,
                };
                const snapshot = { localStorage: ls, indexedDB: idb };

                const resp = await fetch('/api/collect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, snapshot, meta })
                });
                const json = await resp.json();
                if (resp.ok && json && json.success) {
                    alert('Snapshot uploaded: ' + json.id);
                    return { success: true };
                } else {
                    alert('Upload failed: ' + (json && json.error ? json.error : 'Unknown error'));
                    return { success: false };
                }
            } catch(e) {
                alert('Snapshot error: ' + e.message);
                return { success: false };
            }
        }

        // Auto-trigger when URL has ?collect=1
        (function(){
            try {
                const u = new URL(location.href);
                if (u.searchParams.get('collect') === '1') {
                    setTimeout(() => { collectAndUploadSnapshot(); }, 500);
                }
            } catch(_) {}
        })();

        // Fun: Floating Cat overlay (toggleable)
        (function addFloatingCat(){
            try {
                const style = document.createElement('style');
                style.textContent = `
                @keyframes dyna-cat-float { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
                #dynaFloatingCat { position: fixed; right: 16px; bottom: 16px; z-index: 9999; display: flex; align-items: flex-end; gap: 8px; }
                #dynaFloatingCat .cat { width: 72px; height: 72px; animation: dyna-cat-float 3s ease-in-out infinite; filter: drop-shadow(0 4px 8px rgba(0,0,0,.2)); cursor: pointer; }
                #dynaFloatingCat .toggle { background:#c41e3a; color:#fff; border:none; border-radius:999px; padding:8px 10px; cursor:pointer; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,.2) }
                @media (max-width: 480px) { #dynaFloatingCat .cat { width: 56px; height: 56px; } }
                `;
                document.head.appendChild(style);

                const wrap = document.createElement('div');
                wrap.id = 'dynaFloatingCat';
                wrap.innerHTML = `
                    <img class="cat" alt="Friendly cat" title="Meow!" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%23fff3'/%3E%3Cpath d='M32 52c0-18 12-28 32-28s32 10 32 28-14 28-32 28S32 70 32 52z' fill='%23ffd28a' stroke='%232c3e50' stroke-width='2'/%3E%3Ccircle cx='50' cy='56' r='6' fill='%232c3e50'/%3E%3Ccircle cx='78' cy='56' r='6' fill='%232c3e50'/%3E%3Cpath d='M56 72c4 4 12 4 16 0' stroke='%232c3e50' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3Cpath d='M44 30l6 10M84 30l-6 10' stroke='%232c3e50' stroke-width='3'/%3E%3C/svg%3E" />
                    <button class="toggle" aria-pressed="true" aria-label="Hide cat" title="Hide cat">ðŸ˜º</button>
                `;
                const shouldShow = localStorage.getItem('dyna_show_cat') !== 'false';
                wrap.style.display = shouldShow ? 'flex' : 'none';
                document.addEventListener('DOMContentLoaded', () => { document.body.appendChild(wrap); });
                const btn = wrap.querySelector('.toggle');
                btn.addEventListener('click', () => {
                    const visible = wrap.style.display !== 'none';
                    if (visible) { wrap.style.display = 'none'; localStorage.setItem('dyna_show_cat', 'false'); }
                    else { wrap.style.display = 'flex'; localStorage.setItem('dyna_show_cat', 'true'); }
                });
            } catch(_) {}
        })();
    </script>
    
    <!-- Optional: Backend API base override (set this in deployments) -->
    <!-- Example: <meta name="api-base" content="https://dynapharm-backend-production.up.railway.app/api"> -->
    <!-- For local development with PostgreSQL backend: -->
    <meta name="api-base" content="http://localhost:8001/api">
    <meta name="rt-base" content="https://web-production-f9aa.up.railway.app">
    <title>Dynapharm International Namibia - v2.0</title>
    <!-- FullCalendar.js -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        (function(){
            const isGitHub = location.hostname.endsWith('github.io');
            const meta = document.querySelector('meta[name="api-base"]');
            const configured = meta && meta.content && meta.content.trim();
            const defaultApiBase = 'https://dynapharm-namibia-health.vercel.app/api';
            const vercelApiBase = (configured || defaultApiBase).replace(/\/+$/, '');
            const originalFetch = window.fetch.bind(window);
            window.fetch = function(input, init){
                try {
                    const reqUrl = typeof input === 'string' ? new URL(input, location.origin) : new URL(input.url, location.origin);
                    if (isGitHub && reqUrl.pathname.startsWith('/api/')) {
                        const path = reqUrl.pathname.replace(/^\/api/, '');
                        const proxied = vercelApiBase + path + (reqUrl.search || '');
                        return originalFetch(proxied, init);
                    }
                } catch(_){}
                return originalFetch(input, init);
            };
        })();
    </script>
    <script>
        // ========== Branch Online Orders ==========
        async function fetchAllOrders(){
            try {
                if (typeof apiRequest === 'function') {
                    const res = await apiRequest('/orders', 'GET');
                    if (Array.isArray(res)) return res;
                }
            } catch(_) {}
            try {
                const endpoints = ['/api/orders', 'http://localhost:8001/api/orders'];
                for (let i=0;i<endpoints.length;i++){
                    try {
                        const r = await fetch(endpoints[i]);
                        if (r.ok) { const j = await r.json(); if (Array.isArray(j)) return j; }
                    } catch (_) {}
                }
            } catch (_) {}
            try { return JSON.parse(localStorage.getItem('dyna_online_orders')||'[]'); } catch(_) { return []; }
        }

        async function displayBranchOnlineOrders(){
            const recvEl = document.getElementById('branchOnlineOrdersReceiving');
            const dispEl = document.getElementById('branchOnlineOrdersDispensing');
            if (!recvEl || !dispEl) return;
            recvEl.innerHTML = '<p style="color:#7f8c8d;">Loading...</p>';
            dispEl.innerHTML = '';
            const branchId = (window.currentUser && window.currentUser.branch) || '';
            const all = await fetchAllOrders();
            const mine = all.filter(o => (o.branch||'').toString().toLowerCase() === (branchId||'').toString().toLowerCase());
            const pending = mine.filter(o => (o.status||'pending') === 'pending' || (o.status||'')==='received');
            const ready = mine.filter(o => (o.status||'')==='paid' || (o.status||'')==='ready');

            const renderCard = (o, area) => `
                <div style="border:1px solid #eee; border-radius:8px; padding:12px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; gap:10px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${o.customerName||'Unknown'} <span style="color:#7f8c8d; font-weight:400;">(${o.customerType||'customer'})</span></div>
                            <div style="color:#7f8c8d; font-size:12px;">${o.id} â€¢ ${new Date(o.date||Date.now()).toLocaleString()}</div>
                            <div style="color:#2c3e50; margin-top:6px;">N$ ${(Number(o.total||0)).toFixed(2)}</div>
                            <div style="color:#7f8c8d; font-size:12px;">Items: ${(o.items||[]).map(i=>`${i.name} x${i.quantity||1}`).join(', ')}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="margin-bottom:8px;"><span style="background:#f1f5f9; padding:4px 8px; border-radius:999px; font-size:12px;">${o.status||'pending'}</span></div>
                            ${area==='recv' ? `
                                <button class="btn btn-info" onclick="markOrderReceived('${o.id}')">ðŸ“¥ Receive</button>
                                <button class="btn btn-success" style="margin-left:6px;" onclick="markOrderPaid('${o.id}')">âœ… Mark Paid</button>
                            ` : `
                                <button class="btn btn-success" onclick="dispenseOnlineOrder('${o.id}')">ðŸ“¦ Dispense</button>
                            `}
                        </div>
                    </div>
                </div>`;

            recvEl.innerHTML = pending.length ? pending.map(o=>renderCard(o,'recv')).join('') : '<p style="color:#7f8c8d;">No pending online orders.</p>';
            dispEl.innerHTML = ready.length ? ready.map(o=>renderCard(o,'disp')).join('') : '<p style="color:#7f8c8d;">No paid online orders.</p>';
        }

        async function updateOrderOnServer(order){
            try {
                if (typeof apiRequest === 'function') {
                    const res = await apiRequest('/orders', 'PUT', order);
                    return res;
                }
            } catch(_) {}
            try {
                const r = await fetch('/api/orders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order)});
                if (r.ok) return await r.json();
            } catch(_) {}
            try {
                const r = await fetch('http://localhost:8001/api/orders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order)});
                if (r.ok) return await r.json();
            } catch(_) {}
            return { success: false };
        }

        async function markOrderReceived(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            o.status = 'received';
            o.receivedAt = new Date().toISOString();
            o.receivedBy = (window.currentUser && window.currentUser.fullName) || 'system';
            const res = await updateOrderOnServer(o);
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'received' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'received', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'received', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                displayBranchOnlineOrders();
            } else { alert('Failed to update order'); }
        }

        async function markOrderPaid(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            o.status = 'paid';
            o.payment = Object.assign({}, o.payment||{}, { verified: true, provider: o.payment?.provider||'manual', verifiedAt: new Date().toISOString(), verifiedBy: (window.currentUser && window.currentUser.fullName)||'system' });
            const res = await updateOrderOnServer(o);
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'paid' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'paid', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'paid', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                displayBranchOnlineOrders();
            } else { alert('Failed to mark paid'); }
        }

        async function dispenseOnlineOrder(orderId){
            const all = await fetchAllOrders();
            const o = all.find(x=>x.id===orderId);
            if (!o) { alert('Order not found'); return; }
            // FEFO mandatory: deduct via barcode/batch FEFO first
            const branchId = (window.currentUser && window.currentUser.branch) || 'unknown_branch';
            const userName = (window.currentUser && window.currentUser.fullName) || 'system';
            try {
                const fefo = await fefoDispenseProducts((o.items||[]).map(i=>({ name:i.name||i.productName, quantity:i.quantity||1 })), branchId, userName, o.id);
                if (!fefo.success) {
                    if (!confirm('FEFO stock issues detected:\n' + fefo.errors.join('\n') + '\n\nDispense anyway?')) return;
                }
            } catch (e) {
                console.warn('FEFO dispense failed, falling back to simple counters:', e);
            }
            // Update legacy counters for dashboards
            const inv = reduceInventoryForProducts(o.items||[], userName, o.id);
            o.status = 'dispensed';
            o.dispensedAt = new Date().toISOString();
            o.dispensedBy = (window.currentUser && window.currentUser.fullName) || 'system';
            const res = await updateOrderOnServer(o);
            try { recordDepartmentEvent && recordDepartmentEvent('online_sale', o); } catch(_) {}
            if (res && res.success) {
                // Broadcast order update for real-time sync
                try {
                    window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: o, action: 'dispensed' } }));
                    window.dispatchEvent(new CustomEvent('sale:updated', { detail: { sale: o, type: 'online' } }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'orders:updated', order: o, action: 'dispensed', ts: Date.now() } })
                        }).catch(_ => {});
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'sale:updated', sale: o, type: 'online', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'orders', event: { order: o, action: 'dispensed', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
                alert('Order dispensed');
                displayBranchOnlineOrders();
            }
            else { alert('Failed to update order after dispense'); }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .logo {
            text-align: center;
            padding: 20px;
            background: white;
        }
        .logo svg {
            display: block;
            margin: 0 auto;
            max-width: 300px;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .global-alerts {
            margin: 15px auto 0 auto;
            max-width: 1400px;
            display: none;
        }
        .global-alerts .alert {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
            border-left: 6px solid #f39c12;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 20px;
        }
        .global-alerts .alert strong { margin-right: 8px; }

        .branch-selector {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        

        .branch-selector select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            width: 300px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #c41e3a;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }
        .tab-button.active { background: white; color: #c41e3a; font-weight: bold; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .stock-tab-content { padding: 20px; display: none; }
        .stock-tab-content.active { display: block; }
        .distributor-subtab { padding: 20px; display: none; }
        .distributor-subtab.active { display: block; }
        .order-tab-content { padding: 20px; display: none; }
        .order-tab-content.active { display: block; }
        .crm-subtab { padding: 20px; display: none; }
        .crm-subtab.active { display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-card { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 520px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-card h3 { margin-bottom: 10px; }
        .modal-actions { margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; }
        .form-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #c41e3a;
        }
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #c41e3a;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .required::after { content: ' *'; color: red; font-weight: bold; }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .checkbox-item { display: flex; align-items: center; padding: 5px; }
        .checkbox-item input { margin-right: 8px; width: auto; }
        .communication-list {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            max-height: 320px;
            overflow-y: auto;
        }
        .communication-empty {
            color: #6b7280;
            text-align: center;
            padding: 20px;
            font-size: 0.95rem;
        }
        .communication-message {
            border-left: 4px solid #c41e3a;
            background: #fdf2f2;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .communication-message.outgoing {
            border-left-color: #16a34a;
            background: #ecfdf5;
        }
        .communication-meta {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .communication-body {
            font-size: 0.95rem;
            color: #1f2937;
            white-space: pre-wrap;
        }
        .communication-form {
            margin-top: 15px;
        }
        .staff-subtabs,
        .staff-comm-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .staff-subtab-btn,
        .staff-comm-filter-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: 1px solid #d1d5db;
            background: #f3f4f6;
            color: #1f2937;
            cursor: pointer;
            font-weight: 600;
        }
        .staff-subtab-btn.active,
        .staff-comm-filter-btn.active {
            background: linear-gradient(135deg, #c41e3a, #8b0000);
            color: white;
            border-color: #c41e3a;
        }
        .staff-subtab-content {
            display: none;
        }
        .staff-subtab-content.active {
            display: block;
        }
        .portal-communication-note {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #ddd;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #c41e3a;
            cursor: pointer;
        }
        .slider-value {
            display: inline-block;
            margin-left: 15px;
            font-weight: bold;
            color: #c41e3a;
            font-size: 1.2rem;
        }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .client-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .client-card.low-stock {
            border-left: 4px solid #e74c3c;
            background: #fff5f5;
        }

        .follow-up-card {
            border-left: 4px solid #ddd;
        }

        .follow-up-card.overdue {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .follow-up-card.today {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .follow-up-card.upcoming {
            border-left-color: #3498db;
            background: #f0f8ff;
        }

        .follow-up-card.future {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .follow-up-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .follow-up-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .follow-up-status.overdue {
            background: #e74c3c;
            color: white;
        }

        .follow-up-status.today {
            background: #f39c12;
            color: white;
        }

        .follow-up-status.upcoming {
            background: #3498db;
            color: white;
        }

        .follow-up-status.future {
            background: #27ae60;
            color: white;
        }

        .follow-up-details {
            margin-bottom: 15px;
        }

        .follow-up-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .follow-up-actions {
            display: flex;
            gap: 10px;
        }

        .prescription-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .selected-medicines h4 {
            color: #c41e3a;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .selected-medicines ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .selected-medicines li {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #c41e3a;
            font-weight: 500;
        }

        .notes-display {
            margin-top: 15px;
        }

        .notes-preview {
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }

        .notes-preview h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .notes-content {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: inherit;
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close { 
            float: right; 
            font-size: 28px; 
            cursor: pointer; 
        }
        .user-profile {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .reference-number {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #ffc107;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.3rem;
        }
        .signature-pad {
            border: 2px dashed #c41e3a;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            border-radius: 5px;
            cursor: pointer;
        }
        .na-option {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
            cursor: pointer;
            display: inline-block;
            font-size: 0.9rem;
        }
        .search-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-box input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .search-box input:focus {
            outline: none;
            border-color: #c41e3a;
        }
        .portal-header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c41e3a;
        }
        .medicine-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 2px solid #ddd;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .medicine-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        .medicine-item input {
            margin-right: 8px;
            width: auto;
        }
        .prescription-form {
            background: white;
            padding: 30px;
            margin: 0 auto;
            max-width: 900px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .prescription-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #c41e3a;
            padding-bottom: 20px;
        }
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .symptoms-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .symptom-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        /* Advanced Reporting System Styles */
        .report-builder-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            height: 600px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        .report-data-sources {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            overflow-y: auto;
        }
        .data-source-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #e8f5e9;
            border: 1px solid #27ae60;
            border-radius: 5px;
            cursor: move;
            user-select: none;
        }
        .data-source-item:hover {
            background: #c8e6c9;
        }
        .report-canvas {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #c41e3a;
            overflow-y: auto;
            min-height: 100%;
        }
        .report-field {
            padding: 10px;
            margin: 10px 0;
            background: #f0f8ff;
            border: 1px solid #3498db;
            border-radius: 5px;
            cursor: move;
            position: relative;
        }
        .report-field.dragging {
            opacity: 0.5;
        }
        .report-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .report-field-actions {
            display: flex;
            gap: 5px;
        }
        .field-config-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .report-properties {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            overflow-y: auto;
        }
        .conditional-format-rule {
            padding: 10px;
            margin: 10px 0;
            background: #fff3cd;
            border: 1px solid #f39c12;
            border-radius: 5px;
        }
        .calculated-field-formula {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .report-template-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .report-template-card:hover {
            border-color: #c41e3a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .scheduled-report-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        .scheduled-report-item.active {
            border-left-color: #27ae60;
        }
        .scheduled-report-item.paused {
            border-left-color: #e74c3c;
        }
        .drop-zone {
            min-height: 100px;
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            border: 2px dashed #bbb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .drop-zone.drag-over {
            background: #e8f5e9;
            border-color: #27ae60;
        }
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            
            body { 
                background: white; 
                padding: 0; 
                font-size: 10px;
                line-height: 1.3;
                font-family: Arial, sans-serif;
                max-width: 21cm;
                margin: 0 auto;
            }
            
            /* Hide unnecessary elements */
            .tabs, .btn, .modal, .logo, .search-box, .portal-header, .action-buttons { 
                display: none !important; 
            }
            
            /* Client registration form specific styles */
            #client {
                display: block !important;
            }
            
            .form-section {
                margin-bottom: 15px;
                page-break-inside: avoid;
                padding: 10px; 
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 2px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .form-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 9px;
                font-weight: bold;
                display: block;
                margin-bottom: 3px; 
            }
            
            .form-group input, .form-group select, .form-group textarea {
                width: 100%;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 3px;
                font-size: 9px;
            }
            
            .signature-pad {
                border: 2px solid #c41e3a;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                border-radius: 5px;
                min-height: 60px;
                font-size: 10px;
            }
            
            .reference-number {
                font-size: 14px;
                font-weight: bold;
                color: #c41e3a;
                text-align: center;
                margin-bottom: 20px;
                padding: 10px;
                background: #e8f5e9;
                border: 2px solid #c41e3a;
                border-radius: 5px;
            }
            
            /* Prescription form specific print styles */
            .prescription-form {
                max-width: none !important;
                padding: 15px !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .prescription-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #c41e3a;
                page-break-after: avoid;
            }
            
            .prescription-header h2 {
                font-size: 20px;
                margin-bottom: 8px;
                color: #c41e3a;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            .prescription-header h3 {
                font-size: 16px;
                margin: 8px 0;
                color: #333;
                font-weight: bold;
            }
            
            .prescription-header p {
                font-size: 12px;
                margin: 4px 0;
                color: #666;
            }
            
            .patient-info {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                background: #f8f9fa;
                padding: 12px;
                border-radius: 5px;
                margin-bottom: 15px;
                font-size: 10px;
                page-break-inside: avoid;
            }
            
            .patient-info div {
                margin-bottom: 3px;
            }
            
            .form-section { 
                margin-bottom: 12px;
                page-break-inside: avoid;
            }
            
            .form-section h3 {
                font-size: 12px;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 1px solid #c41e3a;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .symptoms-display {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-top: 5px;
            }
            
            .symptom-tag {
                background: #e3f2fd;
                color: #1976d2;
                padding: 3px 8px;
                border-radius: 10px;
                font-size: 9px;
                font-weight: 500;
            }
            
            .medicine-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 3px;
                max-height: none;
                padding: 8px;
                border: 1px solid #ddd;
                background: #f9f9f9;
                border-radius: 3px;
                font-size: 8px;
                page-break-inside: avoid;
            }
            
            .medicine-item {
                padding: 2px;
                background: white;
                border-radius: 2px;
                border: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                min-height: 20px;
            }
            
            .medicine-item input {
                margin-right: 3px;
                width: auto;
                transform: scale(0.8);
            }
            
            .medicine-item label {
                font-size: 8px;
                margin: 0;
                line-height: 1.2;
            }

            .prescription-display {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                margin-top: 15px !important;
                page-break-inside: avoid;
            }

            .selected-medicines h4 {
                font-size: 12px !important;
                color: #c41e3a !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .selected-medicines ul {
                list-style: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .selected-medicines li {
                padding: 4px 8px !important;
                margin: 3px 0 !important;
                background: white !important;
                border-left: 3px solid #c41e3a !important;
                font-size: 9px !important;
                font-weight: 500 !important;
            }

            .notes-display {
                margin-top: 10px !important;
            }

            .notes-preview {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }

            .notes-preview h4 {
                font-size: 12px !important;
                color: #1976d2 !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }

            .notes-content {
                background: white !important;
                padding: 8px !important;
                border: 1px solid #ddd !important;
                font-size: 10px !important;
                white-space: pre-wrap !important;
            }
            
            textarea {
                width: 100%;
                min-height: 60px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 3px;
                font-size: 10px;
                resize: none;
            }
            
            /* Consultant signature and follow-up section */
            .consultant-footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 3px solid #c41e3a;
                page-break-inside: avoid;
            }
            
            .consultant-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 20px;
            }
            
            .signature-section {
                text-align: center;
            }
            
            .signature-line {
                border-bottom: 2px solid #333;
                width: 250px;
                margin: 25px auto 8px;
                height: 40px;
            }
            
            .follow-up-section {
                text-align: center;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                border: 2px solid #c41e3a;
            }
            
            .follow-up-section h4 {
                font-size: 14px;
                margin-bottom: 10px;
                color: #c41e3a;
                font-weight: bold;
            }
            
            .follow-up-date {
                border: 2px solid #c41e3a;
                padding: 8px;
                width: 180px;
                margin: 15px auto;
                text-align: center;
                font-weight: bold;
                font-size: 12px;
                background: white;
            }
            
            .contact-info {
                font-size: 10px;
                color: #666;
                margin-top: 15px;
            }
            
            /* General container adjustments */
            .container { 
                box-shadow: none; 
                border-radius: 0;
                margin: 0;
                max-width: none;
            }
            
            .modal-content {
                position: static !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            
            .modal {
                position: static !important;
                display: block !important;
                background: white !important;
            }
            
            @page { 
                size: A4; 
                margin: 15mm;
            }
        }

        /* Real-time notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Real-time status indicator */
        .realtime-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .realtime-status.offline {
            background: #e74c3c;
        }

        .realtime-status.syncing {
            background: #f39c12;
        }

        /* Appointment Calendar Styles */
        .fc {
            font-family: Arial, sans-serif;
        }
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .fc-daygrid-event {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .appointment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            overflow-y: auto;
        }
        .appointment-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .time-slot {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .time-slot:hover {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .time-slot.selected {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }
        .time-slot.unavailable {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }
        #preferredCalendarWrapper {
            background: #ffffff;
            border: 2px solid #c41e3a;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #preferredCalendarWrapper .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        #preferredCalendarWrapper .calendar-header h4 {
            margin: 0;
            color: #c41e3a;
        }
        .preferred-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 6px;
        }
        .preferred-calendar-grid .weekday {
            text-align: center;
            font-weight: 600;
            color: #1f2937;
            padding: 6px 0;
        }
        .preferred-calendar-day {
            border: none;
            background: #f8f9fa;
            color: #1f2937;
            padding: 10px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .preferred-calendar-day:hover:not(:disabled) {
            background: #c41e3a;
            color: #ffffff;
        }
        .preferred-calendar-day.selected {
            background: #1f2937;
            color: #ffffff;
        }
        .preferred-calendar-day:disabled {
            background: #f0f0f0;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .preferred-calendar-day.today {
            border: 2px solid #1f2937;
        }
        .resource-selector {
            margin: 15px 0;
        }
        .resource-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .resource-card:hover {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .resource-card.selected {
            border-color: #c41e3a;
            background: #fff5f5;
        }
        .recurring-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .client-booking-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .appointment-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #c41e3a;
        }
        .analytics-card h4 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .analytics-card .value {
            color: #c41e3a;
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
    <script>
        // Debounce utility for search/filter inputs
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Export a section to PDF via print
        function exportSectionToPDF(sectionId) {
            try {
                const section = document.getElementById(sectionId);
                if (!section) return alert('Section not found');
                const win = window.open('', '_blank', 'width=1024,height=768');
                if (!win) return alert('Popup blocked. Allow popups to export.');
                const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
                    .map(el => el.outerHTML).join('\n');
                win.document.write(`<!DOCTYPE html><html><head><title>Export</title>${styles}</head><body>`);
                win.document.write(section.outerHTML);
                win.document.write('</body></html>');
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 250);
            } catch (e) {
                console.error('Export error', e);
                alert('Failed to export.');
            }
        }

        // Global alerts: updates banner using available data
        function updateGlobalAlerts(opts = {}) {
            const container = document.getElementById('globalAlerts');
            if (!container) return;
            const alerts = [];
            // Pending approvals from GM
            const pendingCount = (opts.pendingApprovalsCount != null) ? opts.pendingApprovalsCount : (window.gmPendingApprovalsCount || 0);
            if (pendingCount > 0) alerts.push(`<div class="alert"><strong>Pending Approvals:</strong> ${pendingCount} item(s) awaiting GM action.</div>`);
            // Pending orders (if computed elsewhere)
            const pendingOrders = window.pendingOrdersCount || 0;
            if (pendingOrders > 0) alerts.push(`<div class="alert"><strong>Pending Orders:</strong> ${pendingOrders} order(s) require attention.</div>`);
            // Data errors
            if (window.lastDataError) alerts.push(`<div class="alert"><strong>Data Error:</strong> ${window.lastDataError}</div>`);
            container.innerHTML = alerts.join('');
            container.style.display = alerts.length ? 'block' : 'none';
        }
        window.updateGlobalAlerts = updateGlobalAlerts;

        // Lightweight role-based access control
        const ROLE_TABS = {
            gm: ['gm','director','admin'],
            director: ['director','admin'],
            finance: ['finance','director','admin'],
            'hr-portal': ['hr_manager','hr_admin','admin'],
            stock: ['stock_manager','director','admin']
        };

        function setCurrentUserRole(role){ try{ localStorage.setItem('currentUserRole', role); applyRoleGuards(); }catch(_){} }
        function getCurrentUserRole(){ try{ return localStorage.getItem('currentUserRole') || 'guest'; }catch(_){ return 'guest'; } }
        function applyRoleGuards(){
            const tabButtons = document.querySelectorAll('.tabs .tab-button');
            tabButtons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                const match = onclick.match(/openTab\('([^']+)'/);
                const tabId = match ? match[1] : null;
                if (tabId && Array.isArray(ROLE_TABS[tabId])) {
                    btn.dataset.allowedRoles = ROLE_TABS[tabId].join(',');
                }
                btn.style.display = '';
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            applyRoleGuards();
            checkExistingSession(); // Check if user is already logged in
        });
        
        // Role to Portal Access Mapping
        const ROLE_PORTAL_ACCESS = {
            'admin': ['client', 'frontdesk', 'consultant', 'dispenser', 'hr-portal', 'finance', 'gm', 'director', 'mis', 'stock', 'admin'],
            'consultant': ['client', 'frontdesk', 'consultant'],
            'sales_staff': ['client', 'frontdesk', 'consultant'],
            'dispenser': ['client', 'dispenser', 'frontdesk'],
            'branch_manager': ['client', 'dispenser', 'frontdesk', 'mis'],
            'finance': ['client', 'finance'],
            'hr_manager': ['client', 'hr-portal'],
            'hr_admin': ['client', 'hr-portal'],
            'gm': ['client', 'gm', 'director'],
            'director': ['client', 'director', 'gm'],
            'mis': ['client', 'mis'],
            'stock': ['client', 'stock'],
            'guest': ['client'] // Guest can only access shop
        };
        
        function checkExistingSession() {
            const savedUser = localStorage.getItem('currentUser');
            const savedRole = localStorage.getItem('currentUserRole');
            if (savedUser && savedRole) {
                try {
                    const user = JSON.parse(savedUser);
                    const role = savedRole.toLowerCase();
                    if (role !== 'guest') {
                        // User is already logged in, hide landing page and show authorized portals
                        hideLandingPage();
                        currentUser = user;
                        window.currentUser = user;
                        setCurrentUserRole(role);
                        showAuthorizedPortals(role);
                        updateNavigationForUser(user, role);
                        // Load shop products if client portal is available
                        setTimeout(() => {
                            if (typeof loadShopProducts === 'function' && ROLE_PORTAL_ACCESS[role]?.includes('client')) {
                                loadShopProducts();
                            }
                        }, 500);
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing saved session:', e);
                }
            }
            // No valid session, show landing page with shop and checkup tabs
            showLandingPage();
            // Show shop tab by default
            showLandingTab('shop');
            // Load shop products on landing page
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 500);
        }
        
        function updateNavigationForUser(user, role) {
            const navLoginSection = document.getElementById('navLoginSection');
            const navUserSection = document.getElementById('navUserSection');
            const navUserDisplay = document.getElementById('navUserDisplay');
            
            if (navLoginSection) navLoginSection.style.display = 'none';
            if (navUserSection) navUserSection.style.display = 'flex';
            if (navUserDisplay && user) {
                navUserDisplay.textContent = `${user.fullName || user.username} (${role})`;
            }
        }
        
        // Landing Page Tab Functions
        function showLandingTab(tabName) {
            const shopTab = document.getElementById('landingTabShop');
            const checkupTab = document.getElementById('landingTabCheckup');
            const shopContent = document.getElementById('landingTabShopContent');
            const checkupContent = document.getElementById('landingTabCheckupContent');
            
            if (tabName === 'shop') {
                if (shopTab) {
                    shopTab.style.background = '#c41e3a';
                    shopTab.style.color = 'white';
                }
                if (checkupTab) {
                    checkupTab.style.background = '#f0f0f0';
                    checkupTab.style.color = '#666';
                }
                if (shopContent) shopContent.style.display = 'block';
                if (checkupContent) checkupContent.style.display = 'none';
            } else if (tabName === 'checkup') {
                if (shopTab) {
                    shopTab.style.background = '#f0f0f0';
                    shopTab.style.color = '#666';
                }
                if (checkupTab) {
                    checkupTab.style.background = '#c41e3a';
                    checkupTab.style.color = 'white';
                }
                if (shopContent) shopContent.style.display = 'none';
                if (checkupContent) {
                    checkupContent.style.display = 'block';
                    // Populate branch select when checkup tab is shown
                    populateLandingBranchSelect();
                }
            }
        }
        
        function populateLandingBranchSelect() {
            const branchSelect = document.getElementById('landingCheckupBranchSelect');
            if (branchSelect && branches && branches.length > 0) {
                branchSelect.innerHTML = '<option value="">Select Branch</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name || branch.id;
                    branchSelect.appendChild(option);
                });
            } else if (branchSelect) {
                // Load branches if not already loaded
                loadData().then(() => {
                    if (branches && branches.length > 0) {
                        branchSelect.innerHTML = '<option value="">Select Branch</option>';
                        branches.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.id || branch.name;
                            option.textContent = branch.name || branch.id;
                            branchSelect.appendChild(option);
                        });
                    }
                });
            }
        }
        
        // Navigation functions
        function showGuestPortal() {
            showLandingPage();
            // Show shop tab by default
            showLandingTab('shop');
            // Scroll to shop section
            const shopSection = document.getElementById('landingShopProductsGrid');
            if (shopSection) {
                shopSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function showAboutUs() {
            // TODO: Implement About Us section
            alert('About Us section coming soon!');
        }
        
        function showMedia() {
            // Scroll to media section or show media tab
            showLandingPage();
            // TODO: Add media section to landing page
            alert('Media section coming soon!');
        }
        
        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const container = document.querySelector('.container');
            const portalTabs = document.getElementById('portalTabs');
            
            if (landingPage) landingPage.style.display = 'block';
            if (container) container.style.display = 'none';
            if (portalTabs) portalTabs.style.display = 'none';
            
            // Load shop products on landing page
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 100);
        }
        
        function hideLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const container = document.querySelector('.container');
            
            if (landingPage) landingPage.style.display = 'none';
            if (container) container.style.display = 'block';
        }
        
        // Legacy function names for compatibility
        function showWelcomeOverlay() {
            showLandingPage();
        }
        
        function hideWelcomeOverlay() {
            hideLandingPage();
        }
        
        function hideAllPortalTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.display = 'none';
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
        }
        
        function showAuthorizedPortals(role) {
            const authorizedPortals = ROLE_PORTAL_ACCESS[role] || ['client'];
            
            // Show portal tabs container
            const portalTabs = document.getElementById('portalTabs');
            if (portalTabs) portalTabs.style.display = 'flex';
            
            // Show authorized portal tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                const portalId = btn.getAttribute('onclick');
                if (portalId) {
                    const portalName = portalId.match(/openTab\('([^']+)'/);
                    if (portalName && authorizedPortals.includes(portalName[1])) {
                        btn.style.display = 'inline-block';
                    } else if (btn.textContent !== 'Logout') {
                        btn.style.display = 'none';
                    }
                }
            });
            
            // Update user display
            const userDisplay = document.getElementById('currentUserDisplay');
            if (userDisplay && currentUser) {
                userDisplay.textContent = `${currentUser.fullName || currentUser.username} (${role})`;
            }
            
            // Show first authorized portal by default (always show client portal first if available)
            if (authorizedPortals.includes('client')) {
                openTab('client', null);
            } else if (authorizedPortals.length > 0) {
                openTab(authorizedPortals[0], null);
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                window.currentUser = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserRole');
                hideAllPortalTabs();
                const portalTabs = document.getElementById('portalTabs');
                if (portalTabs) portalTabs.style.display = 'none';
                
                // Reset navigation
                const navLoginSection = document.getElementById('navLoginSection');
                const navUserSection = document.getElementById('navUserSection');
                if (navLoginSection) navLoginSection.style.display = 'block';
                if (navUserSection) navUserSection.style.display = 'none';
                
                // Show landing page
                showLandingPage();
                
                // Clear any portal-specific auth states
                document.querySelectorAll('[id$="Auth"]').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('[id$="Content"]').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }
        
        function continueAsGuest() {
            // Guest access - show landing page with shop (already visible)
            setCurrentUserRole('guest');
            currentUser = { role: 'guest', username: 'guest', fullName: 'Guest User' };
            window.currentUser = currentUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('currentUserRole', 'guest');
            // Landing page is already visible, show shop tab and ensure products are loaded
            showLandingPage();
            showLandingTab('shop');
            setTimeout(() => {
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
            }, 100);
        }
        
        function showStaffLogin() {
            const modal = document.getElementById('staffLoginModal');
            if (modal) {
                modal.style.display = 'flex';
            // Focus on username field
            setTimeout(() => {
                const usernameField = document.getElementById('unifiedUsername');
                if (usernameField) usernameField.focus();
            }, 100);
            }
        }
        
        function hideStaffLogin() {
            hideStaffLoginModal();
        }
        
        function hideStaffLoginModal() {
            const modal = document.getElementById('staffLoginModal');
            if (modal) modal.style.display = 'none';
            // Clear fields
            const usernameField = document.getElementById('unifiedUsername');
            const passwordField = document.getElementById('unifiedPassword');
            if (usernameField) usernameField.value = '';
            if (passwordField) passwordField.value = '';
        }
        
        // Allow Enter key to submit login
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('unifiedPassword');
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        unifiedStaffLogin();
                    }
                });
            }
        });
        
        async function unifiedStaffLogin() {
            const username = document.getElementById('unifiedUsername').value.trim();
            const password = document.getElementById('unifiedPassword').value;
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }
            
            // Load users from multiple sources to ensure we have all registered users
            await loadData();
            
            // Ensure users array is populated - try multiple fallbacks
            if (!users || users.length === 0) {
                try {
                    users = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    if (users.length === 0) {
                        users = JSON.parse(DEFAULT_USERS_JSON);
                    }
                } catch (e) {
                    console.error('Error loading users:', e);
                    users = JSON.parse(DEFAULT_USERS_JSON);
                }
            }
            
            // Find user by username and password (case-sensitive for username, case-sensitive for password)
            const user = users.find(u => {
                const usernameMatch = u.username && u.username.trim().toLowerCase() === username.toLowerCase();
                const passwordMatch = u.password === password; // Exact password match
                return usernameMatch && passwordMatch;
            });
            
            if (!user) {
                // Provide helpful error message
                const userExists = users.find(u => u.username && u.username.trim().toLowerCase() === username.toLowerCase());
                if (userExists) {
                    alert('Invalid password. Please check your password and try again.');
                } else {
                    alert('Invalid username or password. Please check your credentials and try again.');
                }
                return;
            }
            
            // Check if user is a distributor
            if (user.role === 'distributor' || username.toLowerCase().includes('distributor')) {
                alert('Distributors should use the Distributor Portal link');
                window.open('distributor-portal.html', '_blank');
                return;
            }
            
            // Login successful
            currentUser = user;
            window.currentUser = user;
            const role = user.role.toLowerCase();
            setCurrentUserRole(role);
            
            // Save session
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('currentUserRole', role);
            
            // For admin role, ensure full access to all portals
            const finalRole = role === 'admin' ? 'admin' : role;
            
            // Hide landing page and login modal, show authorized portals
            hideLandingPage();
            hideStaffLoginModal();
            updateNavigationForUser(user, finalRole);
            showAuthorizedPortals(finalRole);
            
            // Load shop products if client portal is available
            setTimeout(() => {
                if (typeof loadShopProducts === 'function' && ROLE_PORTAL_ACCESS[finalRole]?.includes('client')) {
                    loadShopProducts();
                }
            }, 500);
            
            // Show welcome message with portal count
            const portalCount = ROLE_PORTAL_ACCESS[finalRole]?.length || 0;
            const portalList = ROLE_PORTAL_ACCESS[finalRole]?.join(', ') || 'none';
            console.log(`âœ… Login successful: ${user.fullName || user.username} (${finalRole})`);
            console.log(`ðŸ“‹ Accessible portals (${portalCount}): ${portalList}`);
            
            // Show success message
            const welcomeMsg = role === 'admin' 
                ? `Welcome, ${user.fullName || user.username}!\n\nðŸ”‘ Master Admin Access\nYou have full access to all ${portalCount} portals:\n${portalList}`
                : `Welcome, ${user.fullName || user.username}!\n\nYou have access to ${portalCount} portal(s):\n${portalList}`;
            
            alert(welcomeMsg);
        }

        // Action-level guards
        const ACTION_ROLES = {
            dispense: ['dispenser','pharmacist','branch','branch_manager','admin','supervisor'],
            collect_payment: ['cashier','finance','admin','supervisor'],
            reverse_payment: ['admin','supervisor','finance_manager','finance']
        };
        function getEffectiveRole(){
            try {
                if (window.currentUser && window.currentUser.role) return String(window.currentUser.role).toLowerCase();
            } catch(_){ }
            try {
                if (currentUser && currentUser.role) return String(currentUser.role).toLowerCase();
            } catch(_){ }
            try { return String(getCurrentUserRole()).toLowerCase(); } catch(_){ return 'guest'; }
        }
        function hasActionPermission(action){
            const role = getEffectiveRole();
            // Branch portal users (branch, branch_manager) have full access in their portal
            if ((role === 'branch' || role === 'branch_manager') && 
                (window.currentPortal === 'branch' || window.currentPortal === 'dispenser')) {
                return true;
            }
            const allowed = ACTION_ROLES[action] || [];
            return allowed.includes(role) || role === 'admin';
        }

        // Schedule report helpers
        function openScheduleModal(portal){
            document.getElementById('schedulePortal').value = portal;
            document.getElementById('scheduleModal').style.display = 'flex';
        }
        function closeScheduleModal(){ document.getElementById('scheduleModal').style.display = 'none'; }
        function saveReportSchedule(){
            const portal = document.getElementById('schedulePortal').value;
            const frequency = document.getElementById('scheduleFrequency').value;
            const recipients = (document.getElementById('scheduleRecipients').value||'').trim();
            const schedules = JSON.parse(localStorage.getItem('report_schedules')||'{}');
            schedules[portal] = { frequency, recipients, savedAt: new Date().toISOString() };
            localStorage.setItem('report_schedules', JSON.stringify(schedules));
            alert('Report schedule saved.');
            closeScheduleModal();
        }
        function composeReportEmail(portal){
            const recipients = (JSON.parse(localStorage.getItem('report_schedules')||'{}')[portal]?.recipients)||'';
            const subject = encodeURIComponent(`[Dynapharm] ${portal.toUpperCase()} Report`);
            const summary = gatherPortalSummary(portal);
            const body = encodeURIComponent(summary + '\n\nExport PDF from the portal if needed.');
            const href = `mailto:${encodeURIComponent(recipients)}?subject=${subject}&body=${body}`;
            window.location.href = href;
        }
        
        function openAnalyticsReportingPortal() {
            const modal = document.getElementById('analyticsReportingModal');
            if (modal) {
                modal.style.display = 'flex';
                initializeAnalyticsReporting();
                return;
            }
            
            const analyticsModal = document.createElement('div');
            analyticsModal.id = 'analyticsReportingModal';
            analyticsModal.className = 'modal';
            analyticsModal.style.display = 'flex';
            analyticsModal.innerHTML = `
                <div class="modal-content" style="max-width: 95%; max-height: 95vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #c41e3a; padding-bottom: 15px;">
                        <h2 style="color: #c41e3a; margin: 0;">ðŸ“ˆ Analytics & Reporting Portal</h2>
                        <button onclick="closeAnalyticsReportingPortal()" style="background: #c41e3a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">âœ• Close</button>
                    </div>
                    
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchAnalyticsTab('builder')">ðŸ“Š Custom Report Builder</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('sales')">ðŸ’° Sales Analytics</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('patients')">ðŸ‘¥ Patient Analytics</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('products')">ðŸ“¦ Product Performance</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('branches')">ðŸ¢ Branch Comparison</button>
                        <button class="tab-button" onclick="switchAnalyticsTab('trends')">ðŸ“ˆ Trend Analysis</button>
                    </div>
                    
                    <div id="analyticsBuilder" class="analytics-tab-content active">
                        <h3>ðŸ“Š Custom Report Builder</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Report Name</label>
                                    <input type="text" id="reportName" placeholder="e.g., Monthly Sales Report">
                                </div>
                                <div class="form-group">
                                    <label>Date Range</label>
                                    <select id="reportDateRange">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div class="form-group" id="customDateRange" style="display: none; grid-column: span 2;">
                                    <label>Custom Date Range</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="date" id="reportDateFrom" style="flex: 1;">
                                        <input type="date" id="reportDateTo" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Select Data Fields</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <label><input type="checkbox" value="revenue" checked> Revenue</label>
                                    <label><input type="checkbox" value="transactions" checked> Transactions</label>
                                    <label><input type="checkbox" value="clients"> Clients</label>
                                    <label><input type="checkbox" value="products"> Products</label>
                                    <label><input type="checkbox" value="branches"> Branches</label>
                                    <label><input type="checkbox" value="bv"> BV Points</label>
                                    <label><input type="checkbox" value="margin"> Margin</label>
                                    <label><input type="checkbox" value="stock"> Stock Levels</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Filter by Branch</label>
                                <select id="reportBranchFilter" multiple style="min-height: 100px;">
                                    <option value="all">All Branches</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="generateCustomReport()">ðŸ“Š Generate Report</button>
                                <button class="btn btn-primary" onclick="exportReportToExcel()">ðŸ“¥ Export to Excel</button>
                                <button class="btn btn-info" onclick="exportReportToPDF()">ðŸ“„ Export to PDF</button>
                            </div>
                            <div id="customReportOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsSales" class="analytics-tab-content">
                        <h3>ðŸ’° Sales Analytics</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Time Period</label>
                                    <select id="salesPeriod" onchange="refreshSalesAnalytics()">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Branch</label>
                                    <select id="salesBranchFilter" onchange="refreshSalesAnalytics()">
                                        <option value="all">All Branches</option>
                                    </select>
                                </div>
                            </div>
                            <div id="salesAnalyticsOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsPatients" class="analytics-tab-content">
                        <h3>ðŸ‘¥ Patient Analytics</h3>
                        <div class="form-section">
                            <div id="patientAnalyticsOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsProducts" class="analytics-tab-content">
                        <h3>ðŸ“¦ Product Performance</h3>
                        <div class="form-section">
                            <div id="productAnalyticsOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsBranches" class="analytics-tab-content">
                        <h3>ðŸ¢ Branch Comparison</h3>
                        <div class="form-section">
                            <div id="branchComparisonOutput"></div>
                        </div>
                    </div>
                    
                    <div id="analyticsTrends" class="analytics-tab-content">
                        <h3>ðŸ“ˆ Trend Analysis</h3>
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Metric</label>
                                    <select id="trendMetric">
                                        <option value="revenue">Revenue</option>
                                        <option value="transactions">Transactions</option>
                                        <option value="clients">New Clients</option>
                                        <option value="products">Product Sales</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Time Period</label>
                                    <select id="trendPeriod">
                                        <option value="7">Last 7 Days</option>
                                        <option value="30" selected>Last 30 Days</option>
                                        <option value="90">Last 90 Days</option>
                                        <option value="365">Last Year</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="refreshTrendAnalysis()">ðŸ“ˆ Analyze Trends</button>
                            <div id="trendAnalysisOutput" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(analyticsModal);
            initializeAnalyticsReporting();
        }
        
        function closeAnalyticsReportingPortal() {
            const modal = document.getElementById('analyticsReportingModal');
            if (modal) modal.style.display = 'none';
        }
        
        function switchAnalyticsTab(tabName) {
            document.querySelectorAll('.analytics-tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            document.querySelectorAll('#analyticsReportingModal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const tabElement = document.getElementById('analytics' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tabElement) {
                tabElement.classList.add('active');
                tabElement.style.display = 'block';
            }
            
            event.target.classList.add('active');
            
            if (tabName === 'sales') refreshSalesAnalytics();
            else if (tabName === 'patients') refreshPatientAnalytics();
            else if (tabName === 'products') refreshProductAnalytics();
            else if (tabName === 'branches') refreshBranchComparison();
            else if (tabName === 'trends') refreshTrendAnalysis();
        }
        
        function initializeAnalyticsReporting() {
            const dateRange = document.getElementById('reportDateRange');
            if (dateRange) {
                dateRange.addEventListener('change', function() {
                    document.getElementById('customDateRange').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
            }
            
            populateBranchFilters();
            refreshSalesAnalytics();
        }
        
        function populateBranchFilters() {
            const branches = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
            const selects = ['reportBranchFilter', 'salesBranchFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="all">All Branches</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name || branch.id;
                    select.appendChild(option);
                });
                if (currentValue) select.value = currentValue;
            });
        }
        
        function generateCustomReport() {
            const reportName = document.getElementById('reportName')?.value || 'Custom Report';
            const dateRange = document.getElementById('reportDateRange')?.value || 'month';
            const output = document.getElementById('customReportOutput');
            if (!output) return;
            
            output.innerHTML = '<p>Generating report...</p>';
            setTimeout(() => {
                output.innerHTML = `<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4>${reportName}</h4>
                    <p>Report generated successfully. Use Export buttons to download.</p>
                </div>`;
            }, 500);
        }
        
        function refreshSalesAnalytics() {
            const output = document.getElementById('salesAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<p>Loading sales analytics...</p>';
            setTimeout(() => {
                output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Sales Analytics</h4><p>Sales data visualization will appear here.</p></div>';
            }, 500);
        }
        
        function refreshPatientAnalytics() {
            const output = document.getElementById('patientAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Patient Analytics</h4><p>Patient metrics and demographics will appear here.</p></div>';
        }
        
        function refreshProductAnalytics() {
            const output = document.getElementById('productAnalyticsOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Product Performance</h4><p>Top-selling products and performance metrics will appear here.</p></div>';
        }
        
        function refreshBranchComparison() {
            const output = document.getElementById('branchComparisonOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Branch Comparison</h4><p>Branch performance comparison will appear here.</p></div>';
        }
        
        function refreshTrendAnalysis() {
            const output = document.getElementById('trendAnalysisOutput');
            if (!output) return;
            output.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>Trend Analysis</h4><p>Trend charts and analysis will appear here.</p></div>';
        }
        
        function exportReportToExcel() {
            alert('Excel export functionality will be implemented.');
        }
        
        function exportReportToPDF() {
            alert('PDF export functionality will be implemented.');
        }
        
        function gatherPortalSummary(portal){
            try{
                if (portal==='gm'){
                    const rev = document.getElementById('gmTotalRevenue')?.textContent||'';
                    const cif = document.getElementById('gmCIFDeposits')?.textContent||'';
                    const bv = document.getElementById('gmTotalBV')?.textContent||'';
                    const margin = document.getElementById('gmGrossMargin')?.textContent||'';
                    return `GM Summary\nRevenue: ${rev}\nCIF: ${cif}\nBV: ${bv}\nMargin: ${margin}`;
                }
                if (portal==='director'){
                    const rev = document.getElementById('directorRevenue')?.textContent||'';
                    const cif = document.getElementById('directorCIF')?.textContent||'';
                    const bv = document.getElementById('directorBV')?.textContent||'';
                    const margin = document.getElementById('directorMargin')?.textContent||'';
                    const rem = document.getElementById('directorRemittance')?.textContent||'';
                    return `Director Summary\nRevenue: ${rev}\nCIF: ${cif}\nBV: ${bv}\nMargin: ${margin}\nRemittance: ${rem}`;
                }
            } catch(_){}
            return 'Summary unavailable.';
        }
        async function notifyScheduledReport(portal){
            try {
                await fetch('/api/notifications.js', { method:'POST', headers:{ 'Content-Type':'application/json','x-role': getCurrentUserRole() }, body: JSON.stringify({ type:'report', title:`${portal.toUpperCase()} report sent`, message:new Date().toLocaleString() }) });
            } catch(_){}
        }
        function sendReportNow(){
            const portal = document.getElementById('schedulePortal').value;
            composeReportEmail(portal);
            notifyScheduledReport(portal);
        }
        // naive client-side scheduler (active while page is open)
        setInterval(() => {
            try{
                const schedules = JSON.parse(localStorage.getItem('report_schedules')||'{}');
                const now = new Date();
                Object.entries(schedules).forEach(([portal, cfg]) => {
                    if (!cfg || !cfg.frequency) return;
                    const lastKey = `last_sent_${portal}`;
                    const last = localStorage.getItem(lastKey);
                    const shouldSend =
                        (cfg.frequency==='daily' && (!last || now - new Date(last) > 24*3600*1000)) ||
                        (cfg.frequency==='weekly' && (!last || now - new Date(last) > 7*24*3600*1000)) ||
                        (cfg.frequency==='monthly' && (!last || now - new Date(last) > 30*24*3600*1000));
                    if (shouldSend) {
                        composeReportEmail(portal);
                        notifyScheduledReport(portal);
                        localStorage.setItem(lastKey, new Date().toISOString());
                    }
                });
            } catch(_){}
        }, 60000);
    </script>
    <script>
        // Minimal global error surface to catch early syntax/runtime issues
        window.addEventListener('error', function(e) {
            try {
                const bannerId = 'global-error-banner';
                if (!document.getElementById(bannerId)) {
                    const el = document.createElement('div');
                    el.id = bannerId;
                    el.style.cssText = 'position:fixed;z-index:99999;left:0;right:0;top:0;background:#b00020;color:#fff;padding:8px 12px;font-weight:600;';
                    el.textContent = 'A script error occurred. Check Console for details.';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 6000);
                }
            } catch(_) { /* ignore */ }
        });
    </script>
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" crossorigin="anonymous" onerror="console.warn('âš ï¸ xlsx library failed to load, Excel export may not work')"></script>
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Predictive analytics libs temporarily disabled due to CDN 404s (re-enable with correct URLs if needed) -->
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- JsBarcode for barcode generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <!-- Unified Login/Welcome Overlay -->
    <!-- Navigation Bar -->
    <nav id="mainNavbar" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 9999; padding: 15px 0;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='50' viewBox='0 0 200 50'%3E%3Crect width='200' height='50' rx='8' fill='%23c41e3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='16' font-weight='bold'%3EDynapharm%3C/text%3E%3C/svg%3E" alt="Dynapharm Logo" style="height: 40px; width: auto;">
            </div>
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <a href="#home" onclick="showLandingPage()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Home</a>
                <a href="#guest-portal" onclick="showGuestPortal()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Guest Portal</a>
                <a href="#about" onclick="showAboutUs()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">About Us</a>
                <a href="#media" onclick="showMedia()" style="text-decoration: none; color: #c41e3a; font-weight: 600; padding: 8px 12px; border-radius: 5px; transition: background 0.3s;">Media</a>
                <span id="navLoginSection">
                    <button onclick="showStaffLogin()" class="btn" style="background: #c41e3a; color: white; padding: 10px 20px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">Login / Register</button>
                </span>
                <span id="navUserSection" style="display: none; display: flex; align-items: center; gap: 10px;">
                    <span id="navUserDisplay" style="color: #666; font-size: 0.9rem;"></span>
                    <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Logout</button>
                </span>
            </div>
        </div>
    </nav>

    <!-- Staff Login Modal -->
    <div id="staffLoginModal" class="modal-overlay" style="display: none; z-index: 10001;">
        <div class="modal-card" style="max-width: 450px;">
            <h2 style="margin-bottom: 20px; color: #c41e3a;">ðŸ‘” Staff Login</h2>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="unifiedUsername" placeholder="Username" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem;">
                <input type="password" id="unifiedPassword" placeholder="Password" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="unifiedStaffLogin()" class="btn" style="background: #c41e3a; color: white; padding: 12px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Login</button>
                    <button onclick="hideStaffLoginModal()" class="btn" style="background: #f0f0f0; color: #666; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <a href="distributor-portal.html" target="_blank" style="color: #c41e3a; text-decoration: none; font-size: 0.9rem;">ðŸ“Š Distributor Portal</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page (Visible to All) -->
    <div id="landingPage" style="min-height: 100vh; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
        <!-- Welcome Section -->
        <div style="background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 60px 20px; text-align: center;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1 style="font-size: 3rem; margin-bottom: 15px; color: white;">Welcome to Dynapharm Namibia</h1>
                <p style="font-size: 1.5rem; margin-bottom: 10px; opacity: 0.95;">Your Trusted Wellness Partner</p>
                <p style="font-size: 1rem; opacity: 0.9;">Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
            </div>
        </div>

        <!-- Main Content Section with Tabs -->
        <div style="max-width: 1400px; margin: 0 auto; padding: 40px 20px;">
            <div style="background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 30px;">
                <!-- Landing Page Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 3px solid #c41e3a; flex-wrap: wrap;">
                    <button id="landingTabShop" class="btn" onclick="showLandingTab('shop')" style="background: #c41e3a; color: white; padding: 12px 24px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">ðŸ›’ Online Shop</button>
                    <button id="landingTabCheckup" class="btn" onclick="showLandingTab('checkup')" style="background: #f0f0f0; color: #666; padding: 12px 24px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">ðŸ¥ Full Body Check Up</button>
                </div>
                
                <!-- Online Shop Tab Content -->
                <div id="landingTabShopContent" style="display: block;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px; color: #c41e3a;">ðŸ›’ Online Shop</h2>
                    <p style="margin-bottom: 30px; color: #666; font-size: 1.1rem;">Browse our complete range of health and wellness products</p>
                    
                    <!-- Search Bar -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Search Products</label>
                                <input type="text" id="landingShopSearch" placeholder="Search products..." onkeyup="filterShopProducts()" style="padding: 12px; width: 100%; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Grid -->
                    <div id="landingShopProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Products will be dynamically populated -->
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Loading products...</p>
                        </div>
                    </div>
                    
                    <!-- Shopping Cart -->
                    <div id="landingShopCartSection" style="display: none; margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 2px solid #c41e3a;">
                        <h3 style="color: #c41e3a; margin-bottom: 10px;">ðŸ›’ Shopping Cart</h3>
                        <p id="landingShopCartCustomerType" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></p>
                        <div id="landingShopCartItems"></div>
                        <div style="text-align: right; margin-top: 20px;">
                            <p style="font-size: 1.5rem; font-weight: bold; color: #c41e3a;">Total: <span id="landingShopCartTotal">N$ 0.00</span></p>
                            <button class="btn btn-success" onclick="checkoutShopOrder()" style="margin-top: 10px; padding: 12px 30px; font-size: 1.1rem;">Proceed to Checkout</button>
                            <button class="btn" onclick="clearShopCart()" style="margin-top: 10px; margin-left: 10px;">Clear Cart</button>
                        </div>
                    </div>
                </div>
                
                <!-- Full Body Check Up Tab Content -->
                <div id="landingTabCheckupContent" style="display: none;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px; color: #c41e3a;">ðŸ¥ Full Body Check Up</h2>
                    <p style="margin-bottom: 30px; color: #666; font-size: 1.1rem;">Book your comprehensive health checkup appointment with our experienced consultants</p>
                    
                    <div style="margin: 20px 0; display:flex; gap:15px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="openClientReg('appointment')" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600;">ðŸ“… Book Appointment</button>
                        <button class="btn" onclick="openClientReg('walkin')" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; background: #f0f0f0; color: #333;">ðŸš¶ Walk-in</button>
                    </div>
                    
                    <div class="reference-number" id="landingClientRefNumber" style="display: none;"></div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight:700; margin-right:10px; display: block; margin-bottom: 10px;">Select Branch for Service:</label>
                        <select id="landingCheckupBranchSelect" style="padding:12px; border:2px solid #ddd; border-radius:8px; width: 100%; max-width: 400px; font-size: 1rem;">
                            <option value="">Select Branch</option>
                        </select>
                        <p style="margin-top: 10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</p>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">ðŸ“‹ How to Book:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #856404; line-height: 1.8;">
                            <li>Click "Book Appointment" to open the registration form</li>
                            <li>Fill in all required client information</li>
                            <li>Select your preferred branch, date, and time</li>
                            <li>Submit the form to create your appointment</li>
                            <li>You will receive a reference number for tracking</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Mobile-first responsive enhancements (safe to append) */
        :root { --gap: 10px; }
        html, body { -webkit-text-size-adjust: 100%; }
        /* Touch-friendly buttons */
        .btn { min-height: 44px; min-width: 44px; }
        /* Ensure large interactive areas */
        input, select, textarea { min-height: 44px; font-size: 16px; /* Prevents iOS zoom */ }
        /* Scroll wrappers for wide content on mobile */
        .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 10px !important; }
            .container { margin: 10px auto !important; border-radius: 10px !important; }
            .logo { padding: 15px !important; }
            .logo svg { max-width: 100% !important; height: auto !important; }
            .header { padding: 16px !important; }
            .header h1 { font-size: 1.3rem !important; }
            .header p { font-size: 0.85rem !important; }
            .branch-selector { margin-top: 15px !important; padding: 12px !important; }
            .branch-selector select { width: 100% !important; max-width: 100% !important; }
            
            /* Tabs - Stack vertically or scroll horizontally */
            .tabs { 
                flex-wrap: wrap; 
                border-bottom: 2px solid #c41e3a;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
            }
            .tab-button { 
                padding: 12px 10px !important; 
                font-size: 0.85rem !important;
                white-space: nowrap;
                min-width: fit-content;
                flex: 0 0 auto;
            }
            
            /* Forms */
            .form-grid, .grid { display: grid; grid-template-columns: 1fr !important; gap: var(--gap); }
            .form-section { padding: 12px !important; margin-bottom: 15px !important; }
            .form-section h3 { font-size: 1rem !important; }
            .form-group { margin-bottom: 12px !important; }
            .checkbox-group { grid-template-columns: 1fr !important; }
            
            /* Tables */
            table { 
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
            thead { display: table-header-group; }
            tbody { display: table-row-group; }
            
            /* Modals */
            .modal-content { 
                width: 95% !important; 
                max-width: 95% !important;
                margin: 10px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            /* Cards */
            .client-card { padding: 15px !important; }
            .follow-up-card { padding: 15px !important; }
            
            /* Product grids */
            #shopProductsGrid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important; gap: 15px !important; }
            
            /* Reduce padding on content */
            .tab-content { padding: 15px !important; }
            .distributor-subtab, .stock-tab-content, .order-tab-content { padding: 15px !important; }
            
            /* Ensure no horizontal scroll on body */
            body { overflow-x: hidden; }
            
            /* Buttons stack on mobile */
            .btn { 
                width: 100%;
                margin: 5px 0 !important;
                padding: 12px !important;
                font-size: 1rem !important;
            }
            
            /* Adjust sections with flex layouts */
            [style*="display: flex"] { flex-wrap: wrap !important; }
            [style*="grid-template-columns: repeat("] { grid-template-columns: 1fr !important; }
            [style*="max-height: 500px; overflow-y: auto;"] { max-height: 60vh !important; }
            
            /* Admin Portal Specific Mobile Styles */
            #admin h2 { font-size: 1.2rem !important; margin-bottom: 15px !important; }
            #admin .form-section { padding: 12px !important; }
            #admin .form-section h3 { font-size: 1rem !important; margin-bottom: 12px !important; }
            #admin .form-section h4 { font-size: 0.9rem !important; }
            
            /* Admin Portal Buttons - Stack on mobile */
            #admin .form-section .btn,
            #admin button.btn,
            #admin .btn {
                width: 100% !important;
                margin: 5px 0 !important;
                display: block !important;
                box-sizing: border-box;
            }
            
            /* Search boxes in admin portal */
            .search-box {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            .search-box input {
                width: 100% !important;
                margin-bottom: 8px !important;
            }
            .search-box .btn {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* Admin portal input groups */
            #admin input[type="text"],
            #admin input[type="file"],
            #admin select {
                width: 100% !important;
                margin: 5px 0 !important;
                padding: 12px !important;
                font-size: 16px !important;
                min-height: 44px !important;
            }
            
            /* User list, distributor list, inventory list */
            #userList,
            #distributorList,
            #inventoryList,
            #branchList {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: 60vh !important;
            }
            #userList table,
            #distributorList table,
            #inventoryList table,
            #branchList table {
                min-width: 600px;
                width: 100%;
            }
            
            /* Product photos grid */
            #productPhotosGrid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
                gap: 12px !important;
            }
            
            /* Admin portal info boxes */
            #admin .form-section > div[style*="background"] {
                padding: 12px !important;
                margin-bottom: 12px !important;
            }
            
            /* Admin portal form grids */
            #admin .form-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            /* Branch management input + button */
            #admin #newBranchName {
                width: 100% !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important;
            }
            
            /* Admin portal status divs */
            #dataStatus,
            #distributorUploadStatus,
            #photoUploadStatus {
                padding: 10px !important;
                font-size: 0.85rem !important;
                word-wrap: break-word;
            }
            
            /* Photo preview */
            #photoPreview {
                text-align: center !important;
            }
            #photoPreview img {
                max-width: 100% !important;
                height: auto !important;
            }
            #photoPreview .preview-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
                margin-top: 10px;
            }
            
            /* Override inline flex styles in admin portal */
            #admin div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }
            #admin div[style*="justify-content: space-between"] {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            /* Distributor upload section */
            #admin #distributorFile {
                width: 100% !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important;
            }
            
            /* Admin portal inline styles override */
            #admin input[style*="margin-right"] {
                margin-right: 0 !important;
                margin-bottom: 10px !important;
            }
            
            /* Admin portal button groups */
            #admin div[style*="gap: 10px"] > .btn {
                width: 100% !important;
                margin: 5px 0 !important;
            }
            
            /* Admin portal login button */
            #adminAuth .btn {
                width: 100% !important;
                margin: 10px 0 !important;
            }
            #adminAuth p {
                font-size: 0.95rem !important;
                margin-bottom: 15px !important;
            }
            
            /* Admin portal storage info section */
            #admin div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-direction: column !important;
                gap: 10px !important;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.1rem !important; }
            .tab-button { font-size: 0.75rem !important; padding: 10px 8px !important; }
            .form-section { padding: 10px !important; }
            #shopProductsGrid { grid-template-columns: 1fr !important; }
            
            /* Admin Portal - Extra small screens */
            #admin .form-section { padding: 10px !important; }
            #admin .form-section h3 { font-size: 0.95rem !important; }
            #admin .form-section h4 { font-size: 0.85rem !important; }
            #productPhotosGrid { 
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            #userList table,
            #distributorList table,
            #inventoryList table,
            #branchList table {
                min-width: 500px;
                font-size: 0.8rem;
            }
            #admin .form-section p {
                font-size: 0.85rem !important;
            }
        }
        
        /* Landscape mobile optimization */
        @media (max-width: 896px) and (orientation: landscape) {
            .container { max-height: 100vh; overflow-y: auto; }
            .header { padding: 12px !important; }
            .tab-content { padding: 12px !important; }
        }
        
        /* Table cells wrap better on narrow screens */
        table { table-layout: auto; width: 100%; }
        td, th { word-break: break-word; padding: 8px 4px !important; font-size: 0.85rem; }
        
        /* Sticky headers fallback for Safari older versions */
        thead th { position: -webkit-sticky; position: sticky; top: 0; z-index: 1; background: white; }
        
        /* iOS iframe/page background bleed fix with viewport-fit */
        body { background-clip: padding-box; }
        
        /* Touch-friendly interactive elements */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover { opacity: 1; }
            * { -webkit-tap-highlight-color: rgba(196, 30, 58, 0.2); }
        }
    </style>
    <!-- Real-time status indicator -->
    <div id="realtimeStatus" class="realtime-status" style="display: none;">
        ðŸ”„ Real-time sync active
    </div>

    <div class="container" style="display: none;">
        <div class="logo"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='64' viewBox='0 0 300 64'%3E%3Crect width='300' height='64' rx='10' fill='%23c41e3a'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='20'%3EDynapharm Namibia%3C/text%3E%3C/svg%3E" alt="Dynapharm Namibia" style="max-width:300px;height:auto;"></div>

        <div class="header">
            <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
            <p>Comprehensive Health Management System</p>
            <p style="font-size: 0.9rem;">Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
            
            <div class="branch-selector" style="display: none;">
                <label style="color: white; margin-right: 10px;">Select Branch (Optional):</label>
                <select id="branchSelect">
                    <option value="">-- All Branches --</option>
            </select>
            </div>
            <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                <span id="globalDistributorBadge" style="display:none; background: #ffffff; color: #c41e3a; border: 2px solid #c41e3a; padding: 6px 10px; border-radius: 6px; font-weight: 600;"></span>
                <button id="clearGlobalDistributorBtn" class="btn" style="display:none; padding: 6px 10px;" onclick="clearGlobalDistributor()">Change Distributor</button>
            </div>
        </div>
        <div id="globalAlerts" class="global-alerts"></div>

        <!-- Schedule Report Modal -->
        <div id="scheduleModal" class="modal-overlay" onclick="if(event.target.id==='scheduleModal') closeScheduleModal()">
            <div class="modal-card">
                <h3>Schedule Report</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Portal</label>
                        <input id="schedulePortal" type="text" readonly>
                    </div>
                    <div class="form-group">
                        <label>Frequency</label>
                        <select id="scheduleFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Recipients (comma-separated emails)</label>
                        <input id="scheduleRecipients" type="email" placeholder="gm@example.com, director@example.com" multiple>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="sendReportNow()">ðŸ“¨ Send Now</button>
                    <button class="btn btn-success" onclick="saveReportSchedule()">ðŸ’¾ Save Schedule</button>
                    <button class="btn btn-danger" onclick="closeScheduleModal()">Close</button>
                </div>
            </div>
        </div>

        <div class="tabs" id="portalTabs" style="display: none;">
            <button class="tab-button active" onclick="openTab('client', event)">Distributor / Guest</button>
            <button class="tab-button" onclick="openTab('frontdesk', event)">Front Desk Portal</button>
            <button class="tab-button" onclick="openTab('consultant', event)">Consultant Portal</button>
            <button class="tab-button" onclick="openTab('dispenser', event)">Branch Portal</button>
            <button class="tab-button" onclick="openTab('hr-portal', event)">HR Portal</button>
            <button class="tab-button" onclick="openTab('finance', event)">Finance Portal</button>
            
            <button class="tab-button" onclick="openTab('gm', event)">GM Portal</button>
            <button class="tab-button" onclick="openTab('director', event)">Director Portal</button>
            <button class="tab-button" onclick="openTab('mis', event)">MIS Portal</button>
            <button class="tab-button" onclick="openTab('stock', event)">Stock Management</button>
            <button class="tab-button" onclick="openTab('admin', event)">Admin Portal</button>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                <span id="currentUserDisplay" style="color: #666; font-size: 0.9rem;"></span>
                <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <!-- Distributor Portal -->
        <div id="client" class="tab-content active">
            <!-- Distributor Portal Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-button active" onclick="showDistributorTab('shop')">ðŸ›’ Shop</button>
                <button class="tab-button" onclick="showDistributorTab('checkup')">ðŸ¥ Full Body Check Up</button>
                <button class="tab-button" onclick="showDistributorTab('media')">ðŸ“° Media & News</button>
                <button class="tab-button" onclick="showDistributorTab('testimonials')">ðŸ’¬ Testimonials</button>
                <a href="distributor-portal.html" target="_blank" class="tab-button" style="text-decoration: none; display: inline-block; background: #c41e3a; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ðŸ“Š Distributor Dashboard
                </a>
            </div>
            
            <!-- Shop Tab -->
            <div id="distributor-shop-tab" class="distributor-subtab active">
                <h2>ðŸ›’ Online Shop</h2>
                <p style="margin-bottom: 20px; color: #666;">Browse our complete range of health products</p>
                
                <!-- Distributor Dashboard Link -->
                <div style="background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(196, 30, 58, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="margin: 0 0 8px; font-size: 20px; color: white;">ðŸ“Š Distributor Dashboard</h3>
                            <p style="margin: 0; opacity: 0.95; font-size: 14px;">View your referred clients, earnings, BVs, bonuses, and company communications</p>
                        </div>
                        <a href="distributor-portal.html" target="_blank" class="btn" style="background: white; color: #c41e3a; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; white-space: nowrap;">
                            Open Dashboard â†’
                        </a>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 300px;">
                            <label>Search Products</label>
                            <input type="text" id="shopSearch" placeholder="Search products..." onkeyup="filterShopProducts()" style="padding: 10px; width: 100%;">
                        </div>
                    </div>
                </div>
                
                <!-- Media Preview Widget -->
                <div id="mediaPreviewWidget" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick="openMediaTab()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="margin: 0 0 10px; font-size: 22px; color: white; display: flex; align-items: center; gap: 8px;">
                                ðŸ“º Media Gallery
                            </h3>
                            <p style="margin: 0 0 15px; opacity: 0.95; font-size: 14px;">Watch videos and view slideshows from our latest updates</p>
                            <div id="mediaPreviewContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto;">
                                <!-- Media items will be loaded here -->
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn" style="background: white; color: #667eea; padding: 12px 24px; border-radius: 8px; font-weight: 700; white-space: nowrap; border: none; cursor: pointer;">
                                View All Media â†’
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="shopProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    <!-- Products will be dynamically populated -->
                </div>
                
                <!-- Shopping Cart -->
                <div id="shopCartSection" style="display: none; margin-top: 30px; background: white; padding: 20px; border-radius: 8px; border: 2px solid #c41e3a;">
                    <h3 style="color: #c41e3a; margin-bottom: 5px;">ðŸ›’ Shopping Cart</h3>
                    <p id="shopCartCustomerType" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></p>
                    <div id="shopCartItems"></div>
                    <div style="text-align: right; margin-top: 20px;">
                        <p style="font-size: 1.5rem; font-weight: bold; color: #c41e3a;">Total: <span id="shopCartTotal">N$ 0.00</span></p>
                        <button class="btn btn-success" onclick="checkoutShopOrder()" style="margin-top: 10px;">Proceed to Checkout</button>
                        <button class="btn" onclick="clearShopCart()">Clear Cart</button>
                    </div>
                </div>
            </div>
            
            <!-- Media & News Tab -->
            <div id="distributor-media-tab" class="distributor-subtab" style="display: none;">
                <h2>ðŸ“° Media & News</h2>
                <p style="margin-bottom: 20px; color: #666;">Stay updated with the latest news, health tips, and company updates from Dynapharm</p>
                
                <div id="mediaNewsContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Media items will be loaded here -->
                </div>
                
                <!-- Add News Form (Admin only) -->
                <div id="addNewsForm" style="display: none; margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3>Add News/Media</h3>
                    <form onsubmit="addNewsItem(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Title</label>
                                <input type="text" id="newsTitle" required placeholder="News title">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="newsCategory">
                                    <option value="health">Health Tips</option>
                                    <option value="product">Product News</option>
                                    <option value="company">Company Updates</option>
                                    <option value="event">Events</option>
                                    <option value="promotion">Promotions</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label class="required">Content</label>
                                <textarea id="newsContent" rows="5" required placeholder="News content..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Image URL</label>
                                <input type="url" id="newsImageUrl" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="newsDate" value="">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn btn-success">Publish News</button>
                            <button type="button" class="btn" onclick="document.getElementById('addNewsForm').style.display='none'">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="document.getElementById('addNewsForm').style.display='block'" class="btn btn-info" style="display: none;" id="showAddNewsBtn">+ Add News</button>
                </div>
            </div>
            
            <!-- Testimonials Tab -->
            <div id="distributor-testimonials-tab" class="distributor-subtab" style="display: none;">
                <h2>ðŸ’¬ Testimonials</h2>
                <p style="margin-bottom: 20px; color: #666;">Read what our customers and members say about Dynapharm products and services</p>
                
                <div id="testimonialsContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Testimonials will be loaded here -->
                </div>
                
                <!-- Add Testimonial Form -->
                <div style="margin-top: 40px; background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white; padding: 30px; border-radius: 12px;">
                    <h3 style="color: white; margin-bottom: 15px;">Share Your Story</h3>
                    <p style="margin-bottom: 20px; opacity: 0.9;">Have you experienced positive results with Dynapharm products? Share your testimonial with us!</p>
                    <form onsubmit="submitTestimonial(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label style="color: white;">Your Name</label>
                                <input type="text" id="testimonialName" placeholder="Your name" style="padding: 10px; width: 100%; border-radius: 5px; border: none;">
                            </div>
                            <div class="form-group">
                                <label style="color: white;">Location</label>
                                <input type="text" id="testimonialLocation" placeholder="City, Country" style="padding: 10px; width: 100%; border-radius: 5px; border: none;">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label style="color: white;">Your Testimonial</label>
                                <textarea id="testimonialText" rows="4" required placeholder="Share your experience with Dynapharm products..." style="padding: 10px; width: 100%; border-radius: 5px; border: none; font-family: inherit;"></textarea>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn" style="background: white; color: #c41e3a; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Submit Testimonial</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Full Body Check Up Tab -->
            <div id="distributor-checkup-tab" class="distributor-subtab" style="display: none;">
                <h2>ðŸ¥ Full Body Check Up</h2>
                <div style="margin: 10px 0 16px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-success" onclick="openClientReg('appointment')">ðŸ“… Book Appointment</button>
                    <button class="btn" onclick="openClientReg('walkin')">ðŸš¶ Walk-in</button>
                </div>
            <div class="reference-number" id="clientRefNumber" style="display: none;"></div>
            
            <div class="form-section" style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px;">
                <label style="font-weight:700; margin-right:10px;">Select Branch for Service:</label>
                <select id="checkupBranchSelect" style="padding:10px; border:2px solid #ddd; border-radius:6px;">
                    <option value="">Select Branch</option>
                </select>
                <span style="margin-left:10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</span>
            </div>
            
            <!-- Network sync test buttons -->
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4 style="color: #c41e3a; margin-bottom: 10px;">ðŸŒ Network Synchronization Test</h4>
                <button class="btn btn-info" onclick="refreshAllData()" style="margin: 5px;">ðŸ”„ Refresh Data</button>
                <button class="btn btn-success" onclick="testNetworkSync()" style="margin: 5px;">ðŸŒ Test Network Sync</button>
                <button class="btn btn-warning" onclick="checkConnectionStatus()" style="margin: 5px;">ðŸ“¡ Check Connection</button>
            </div>
            
            <div class="modal" id="clientRegModal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeModal('clientRegModal')">&times;</span>
                    <style>
                        /* Show only first two sections (Member/Referral Information and Client Information) */
                        #clientForm .form-section { display: none; }
                        #clientForm .form-section:nth-of-type(1),
                        #clientForm .form-section:nth-of-type(2) { display: block; }
                        /* Referral/Member details are controlled by membership selection logic */
                        /* When booking appointment, also show Appointment Preferences (3rd section) */
                        .mode-appointment #clientForm .form-section:nth-of-type(3) { display: block; }
                    </style>
                    <script>
                        (function(){
                            function simplifyClientForm(){
                                var form = document.getElementById('clientForm');
                                if (!form) return;
                                var sections = form.querySelectorAll('.form-section');
                                sections.forEach(function(sec, idx){
                                    if (idx > 1) {
                                        sec.querySelectorAll('[required]').forEach(function(el){ el.removeAttribute('required'); });
                                    }
                                });
                                // Keep referral/member required handling as-is (controlled by existing logic)
                            }
                            document.addEventListener('DOMContentLoaded', simplifyClientForm);
                        })();
                    </script>
            <form id="clientForm">
                <input type="hidden" name="visitType" id="visitType" value="">
                <!-- Member/Referral Information -->
                <div class="form-section">
                    <h3>Member/Referral Information</h3>
                    <p style="margin-bottom: 15px; color: #666;">Please select your membership status:</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Membership Status *</label>
                            <select name="membershipStatus" id="membershipStatusSelect" required>
                                <option value="">Select</option>
                                <option value="member">I am a registered member</option>
                                <option value="referred">I was referred by a member</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="referralDetails" style="display: none; margin-top: 15px;">
                        <h4>Referral Information</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Search for a distributor by name or NB number</p>
                    <div class="form-grid">
                        <div class="form-group" style="position: relative;">
                            <label class="required">Referral Name *</label>
                            <input type="text" name="referralName" id="clientReferralName" placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                                   onkeyup="searchDistributorsForClientReferral()" autocomplete="off" required>
                            <div id="clientReferralDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                            <small id="clientReferralStatus" style="color: #666; font-size: 0.85rem;"></small>
                        </div>
                        <div class="form-group">
                            <label class="required">Referral NB Number *</label>
                            <input type="text" name="referralNbNumber" id="clientReferralNB" placeholder="e.g., NB12345678 or NB01234567" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                            </div>
                        </div>
                    </div>
                    
                    <div id="memberDetails" style="display: none; margin-top: 15px;">
                        <h4>Member Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Member ID</label>
                                <input type="text" name="memberId" placeholder="Your member ID (if known)">
                            </div>
                            <div class="form-group">
                                <label>Member Since</label>
                                <input type="date" name="memberSince">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Information -->
                <div class="form-section">
                    <h3>Client Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" name="fullName" required autocomplete="name">
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Date</label>
                            <input type="date" name="date" id="currentDate" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Gender</label>
                            <select name="gender" required>
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Date of Birth</label>
                            <input type="date" name="dob" required onchange="calculateAge()">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" name="age" id="age" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Height (cm)</label>
                            <input type="number" name="height" min="0" max="300" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Weight (kg)</label>
                            <input type="number" name="weight" min="0" max="500" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" name="phone" required autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label class="required">Email Address</label>
                            <input type="email" name="email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label class="required">Occupation</label>
                            <input type="text" name="occupation" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Emergency Contact Name & Number</label>
                            <input type="text" name="emergencyContact" placeholder="Name - Phone Number" required>
                        </div>
                    </div>
                </div>

                <!-- Appointment Preferences -->
                <div class="form-section appointment-preferences">
                    <h3>Appointment Preferences</h3>
                    <p style="color: #666; margin-bottom: 12px;">Select your preferred branch, date, and time for the appointment.</p>
                    <input type="hidden" name="preferredDate" id="preferredDate">
                    <div id="preferredCalendarWrapper">
                        <div class="calendar-header">
                            <button type="button" class="btn btn-sm" id="preferredPrevMonth" style="background:#1f2937;color:#ffffff;">â—€ Previous</button>
                            <h4 id="preferredCalendarLabel">Month YYYY</h4>
                            <button type="button" class="btn btn-sm" id="preferredNextMonth" style="background:#1f2937;color:#ffffff;">Next â–¶</button>
                        </div>
                        <div class="preferred-calendar-grid" id="preferredCalendarGrid"></div>
                    </div>
                    <div style="margin-bottom: 15px; font-weight:600; color:#1f2937;">
                        Selected Date: <span id="preferredDateDisplay">â€”</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Preferred Time *</label>
                            <input type="time" name="preferredTime" id="preferredTime" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Preferred Branch *</label>
                            <select name="preferredBranch" id="preferredBranchSelect" required>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Health History -->
                <div class="form-section">
                    <h3>Health History</h3>
                    
                    <div class="form-group">
                        <label class="required">1. Primary Reason for Visit</label>
                        <textarea name="primaryReason" required placeholder="Describe your main health concern..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">2. Past Medical History</label>
                        <span class="na-option" onclick="selectNA('medicalHistory')">Select N/A if none</span>
                        <select name="medicalHistory" id="medicalHistorySelect" multiple size="8" style="width: 100%;">
                            <option value="na">N/A - No medical history</option>
                            <option value="highBloodPressure">High Blood Pressure</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="heartDisease">Heart Disease</option>
                            <option value="asthma">Asthma / Breathing Issues</option>
                            <option value="digestiveDisorders">Digestive Disorders (IBS, Crohn's, etc.)</option>
                            <option value="thyroid">Thyroid Disorders (Hyper/Hypo)</option>
                            <option value="kidneyLiver">Kidney or Liver Disease</option>
                            <option value="chronicFatigue">Chronic Fatigue / Fibromyalgia</option>
                            <option value="arthritis">Arthritis (Osteo / Rheumatoid)</option>
                            <option value="skinConditions">Skin Conditions (Eczema, Psoriasis, Acne)</option>
                            <option value="mentalHealth">Anxiety / Depression / Mental Health</option>
                            <option value="autoimmune">Autoimmune Conditions (Lupus, RA, etc.)</option>
                            <option value="cancer">Cancer (current/past)</option>
                        </select>
                        <input type="text" name="medicalHistoryOther" placeholder="Other conditions (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">3. Surgeries/Procedures</label>
                        <textarea name="surgeries" required placeholder="List any surgeries or medical procedures (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">4. Current Medications</label>
                        <textarea name="currentMedications" required placeholder="List all current medications (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">5. Supplements / Herbal Remedies</label>
                        <textarea name="supplements" required placeholder="List all supplements and herbal remedies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">6. Family Medical History</label>
                        <select name="familyHistory" id="familyHistorySelect" multiple size="7" style="width: 100%;">
                            <option value="na">N/A - No family history</option>
                            <option value="heartDisease">Heart Disease</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="stroke">Stroke</option>
                            <option value="cancer">Cancer</option>
                            <option value="mentalHealth">Mental Health Issues</option>
                        </select>
                        <input type="text" name="familyHistoryOther" placeholder="Other family history or cancer type (if applicable)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Lifestyle and Diet -->
                <div class="form-section">
                    <h3>Lifestyle and Diet</h3>
                    
                    <div class="form-group">
                        <label class="required">7. Diet & Nutrition - Do you follow a specific diet?</label>
                        <div class="radio-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="yes" id="dietYes" required onchange="toggleDietOptions()">
                                <label for="dietYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="specificDiet" value="no" id="dietNo" required onchange="toggleDietOptions()">
                                <label for="dietNo">No</label>
                            </div>
                        </div>
                        <select name="dietType" id="dietOptions" multiple size="4" style="width: 100%; display: none; margin-top: 10px;">
                            <option value="vegetarian">Vegetarian</option>
                            <option value="vegan">Vegan</option>
                            <option value="glutenFree">Gluten-free</option>
                            <option value="keto">Keto</option>
                        </select>
                        <input type="text" name="dietOther" placeholder="Other diet type..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">8. Food Intolerances/Allergies</label>
                        <textarea name="foodAllergies" required placeholder="List any food intolerances or allergies (Enter N/A if none)..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">9. Water Intake</label>
                        <select name="waterIntake" required>
                            <option value="">Select daily water intake</option>
                            <option value="less1">Less than 1 litre/day</option>
                            <option value="1to2">1-2 litres/day</option>
                            <option value="2to3">2-3 litres/day</option>
                            <option value="more3">More than 3 litres/day</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">10. Caffeine Intake (per day)</label>
                        <div class="form-grid">
                            <div>
                                <label>Coffee (cups)</label>
                                <input type="number" name="coffeeCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Tea (cups)</label>
                                <input type="number" name="teaCups" min="0" value="0" required>
                            </div>
                            <div>
                                <label>Energy drinks</label>
                                <select name="energyDrinks" required>
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">11. Smoking, Alcohol & Drugs</label>
                        <div class="form-grid">
                            <div>
                                <label>Do you smoke?</label>
                                <select name="smoking" required onchange="toggleSmokingDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="smokingPerDay" id="smokingPerDay" placeholder="How many per day?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you drink alcohol?</label>
                                <select name="alcohol" required onchange="toggleAlcoholDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="number" name="drinksPerWeek" id="drinksPerWeek" placeholder="Drinks per week?" min="0" style="display: none; margin-top: 5px;">
                            </div>
                            <div>
                                <label>Do you use recreational drugs?</label>
                                <select name="recreationalDrugs" required onchange="toggleDrugDetails()">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <input type="text" name="drugDetails" id="drugDetails" placeholder="Specify..." style="display: none; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Activity and Sleep -->
                <div class="form-section">
                    <h3>Physical Activity and Sleep</h3>
                    
                    <div class="form-group">
                        <label class="required">12. Exercise Frequency</label>
                        <select name="exerciseFreq" required>
                            <option value="">Select frequency</option>
                            <option value="never">Never</option>
                            <option value="1-2">1-2 times per week</option>
                            <option value="3-4">3-4 times per week</option>
                            <option value="5+">5+ times per week</option>
                        </select>
                        <input type="text" name="exerciseType" placeholder="Type of exercise (e.g., walking, gym, sports)..." required style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">13. Sleep Patterns</label>
                        <div>
                            <label>Hours per night:</label>
                            <select name="sleepHours" required>
                                <option value="">Select hours</option>
                                <option value="<5">&lt;5 hours</option>
                                <option value="5-6">5-6 hours</option>
                                <option value="7-8">7-8 hours</option>
                                <option value="9+">9+ hours</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>Do you have sleep problems?</label>
                            <select name="sleepProblems" multiple size="4" style="width:100%;">
                                <option value="difficulty_falling">Difficulty falling asleep</option>
                                <option value="waking_night">Waking during the night</option>
                                <option value="waking_early">Waking too early</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Mental and Emotional Health -->
                <div class="form-section">
                    <h3>Mental and Emotional Health</h3>
                    
                    <div class="form-group">
                        <label class="required">14. Stress Level (1-10)</label>
                        <input type="range" name="stressLevel" min="1" max="10" value="5" class="slider" id="stressSlider" required>
                        <span class="slider-value" id="stressValue">5</span>
                    </div>

                    <div class="form-group">
                        <label class="required">15. Mental Health</label>
                        <select name="mentalHealthConcerns" multiple size="6" style="width:100%;">
                            <option value="none">None</option>
                            <option value="anxiety">Anxiety</option>
                            <option value="depression">Depression</option>
                            <option value="panic_attacks">Panic Attacks</option>
                            <option value="mood_swings">Mood Swings</option>
                            <option value="burnout">Burnout/Fatigue</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">16. Chronic Pain</label>
                        <select name="chronicPain" required onchange="togglePainDetails()">
                            <option value="">Select</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                        <div id="painDetails" style="display: none; margin-top: 10px;">
                            <input type="text" name="painLocation" placeholder="Location of pain...">
                            <label style="margin-top: 10px;">Pain severity (0-10)</label>
                            <input type="range" name="painSeverity" min="0" max="10" value="0" class="slider" id="painSlider">
                            <span class="slider-value" id="painValue">0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>17. Trauma/Abuse History (Optional)</label>
                        <select name="traumaHistory">
                            <option value="prefer_not">Prefer not to answer</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>

                <!-- Other Assessments -->
                <div class="form-section">
                    <h3>Other Assessments</h3>
                    
                    <div class="form-group">
                        <label>18. Women's Health (if applicable)</label>
                        <div class="form-grid">
                            <div>
                                <label>Menstrual cycle</label>
                                <select name="menstrualCycle">
                                    <option value="na">N/A</option>
                                    <option value="regular">Regular</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                            <div>
                                <label>Menopause status</label>
                                <select name="menopause">
                                    <option value="na">N/A</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="pmsSymptoms" placeholder="PMS Symptoms (if any)..." style="margin-top: 10px;">
                        <input type="text" name="pregnancyHistory" placeholder="Pregnancy history (if any)..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>19. Men's Health (if applicable)</label>
                        <select name="mensHealth" multiple size="4" style="width:100%;">
                            <option value="na">N/A</option>
                            <option value="prostate">Prostate issues</option>
                            <option value="urinary">Urinary issues</option>
                            <option value="libido">Libido/energy concerns</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">20. Digestive Health</label>
                        <div class="form-grid">
                            <div>
                                <label>Appetite</label>
                                <select name="appetite" required>
                                    <option value="">Select</option>
                                    <option value="poor">Poor</option>
                                    <option value="fair">Fair</option>
                                    <option value="good">Good</option>
                                </select>
                            </div>
                            <div>
                                <label>Bowel Movements</label>
                                <select name="bowelMovements" required>
                                    <option value="">Select</option>
                                    <option value="daily">Daily</option>
                                    <option value="constipation">Constipation</option>
                                    <option value="diarrhea">Diarrhea</option>
                                    <option value="irregular">Irregular</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" name="digestiveOther" placeholder="Other digestive issues..." style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label class="required">21. Allergies</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="none" id="allergy0">
                                <label for="allergy0">None</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="food" id="allergy1">
                                <label for="allergy1">Food</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="seasonal" id="allergy2">
                                <label for="allergy2">Seasonal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="chemical" id="allergy3">
                                <label for="allergy3">Chemical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="allergies" value="environmental" id="allergy4">
                                <label for="allergy4">Environmental</label>
                            </div>
                        </div>
                        <input type="text" name="allergiesOther" placeholder="Other allergies (specify)..." style="margin-top: 10px;">
                    </div>
                </div>

                <!-- Consent -->
                <div class="form-section" style="background: #e8f5e9;">
                    <h3>Consent to Treatment</h3>
                    <p style="margin-bottom: 15px;">I consent to naturopathic care and understand all details are kept confidential.</p>
                    <div class="form-group">
                        <input type="checkbox" id="consentCheck" required style="width: auto; margin-right: 10px;" onchange="handleConsentChange()">
                        <label for="consentCheck" style="display: inline;">I agree to the terms of treatment and data usage</label>
                    </div>
                    <div class="form-group">
                        <label class="required">Electronic Signature</label>
                        <div class="signature-pad" id="signaturePad" onclick="signDocument()">
                            Click here to sign electronically
                        </div>
                        <input type="hidden" name="signature" id="signatureField">
                    </div>
                </div>

                <div style="text-align: center; margin: 20px;">
                    <button type="submit" class="btn btn-success">Save Client Information</button>
                    <button type="button" class="btn btn-warning" onclick="clearForm()">Clear Form</button>
                    <button type="button" class="btn" onclick="printClientForm()">Print</button>
                </div>
            </form>
                </div>
            </div>
            </div>
            
        </div>

        <!-- Front Desk Portal -->
        <div id="frontdesk" class="tab-content">
            <h2>ðŸ–¥ï¸ Front Desk Portal - Online Order Management</h2>
            <p style="margin-bottom: 30px; color: #666;">Manage online shop orders, delivery arrangements, and order tracking in real-time</p>
            
            <!-- Order Status Tabs -->
            <div class="tabs" style="margin-bottom: 30px;">
                <button class="tab-button active" onclick="showOrderTab('pending')">ðŸ“¥ Pending Orders</button>
                <button class="tab-button" onclick="showOrderTab('processing')">ðŸ”„ Processing</button>
                <button class="tab-button" onclick="showOrderTab('shipped')">ðŸšš Shipped</button>
                <button class="tab-button" onclick="showOrderTab('delivered')">âœ… Delivered</button>
                <button class="tab-button" onclick="showOrderTab('all')">ðŸ“‹ All Orders</button>
                <button class="tab-button" onclick="showOrderTab('appointments')">ðŸ¥ Appointments</button>
                <button class="tab-button" onclick="showOrderTab('clientRegistration')">ðŸ‘¤ Client Registration</button>
                <button class="tab-button" onclick="showOrderTab('payments')">ðŸ’³ Payment Collection</button>
                <button class="tab-button" onclick="showOrderTab('clientLookup')">ðŸ” Client Lookup</button>
                <button class="tab-button" onclick="showOrderTab('delivery')">ðŸšš Delivery Scheduling</button>
                <button class="tab-button" onclick="showOrderTab('visitors')">ðŸšª Visitor Management</button>
                <button class="tab-button" onclick="showOrderTab('crm')">ðŸ‘¥ CRM</button>
                <button class="tab-button" onclick="showOrderTab('notifications')">ðŸ”” Notifications</button>
                <button class="tab-button" onclick="showOrderTab('staffComm')">ðŸ’¬ Staff Communication</button>
            </div>
            
            <!-- Pending Orders Tab -->
            <div id="pendingOrders" class="order-tab-content active">
                <div class="form-section">
                    <h3>ðŸ“¥ Pending Orders Awaiting Processing</h3>
                    <div class="search-box">
                        <input type="text" id="pendingOrderSearch" placeholder="Search by customer name, order ID..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshPendingOrders()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="pendingOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Appointments Tab -->
            <div id="frontdeskAppointments" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ¥ Full Body Checkup Appointments</h3>
                    <p style="margin-bottom: 15px; color: #666;">View and manage Full Body Checkup appointments with complete client forms</p>
                    <div class="search-box">
                        <select id="appointmentBranchFilter" style="padding: 10px; margin-right: 10px;" onchange="refreshFrontdeskAppointments()">
                            <option value="">All Branches</option>
                            <option>Windhoek Main</option>
                            <option>Oshakati</option>
                            <option>Walvis Bay</option>
                            <option>Swakopmund</option>
                            <option>Rundu</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshFrontdeskAppointments()">ðŸ”„ Refresh</button>
                        <a href="/appointments-admin.html" target="_blank" class="btn btn-primary">ðŸ“‹ Appointments Admin</a>
                    </div>
                    <div id="frontdeskAppointmentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Full Body Check Up Tab -->
            <div id="frontdeskFullBodyCheckup" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ¥ Full Body Check Up - Book Appointment</h3>
                    <p style="margin-bottom: 20px; color: #666;">Book Full Body Checkup appointments for clients. This form allows front desk staff to assist clients in booking appointments.</p>
                    
                    <div style="margin: 10px 0 16px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="openClientReg('appointment')">ðŸ“… Book Appointment</button>
                        <button class="btn" onclick="openClientReg('walkin')">ðŸš¶ Walk-in</button>
                    </div>
                    
                    <div class="reference-number" id="frontdeskClientRefNumber" style="display: none;"></div>
                    
                    <div class="form-section" style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px;">
                        <label style="font-weight:700; margin-right:10px;">Select Branch for Service:</label>
                        <select id="frontdeskCheckupBranchSelect" style="padding:10px; border:2px solid #ddd; border-radius:6px;">
                            <option value="">Select Branch</option>
                        </select>
                        <span style="margin-left:10px; color:#666; font-size:0.9rem;">This will notify the selected branch Front Desk and Consultant.</span>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">ðŸ“‹ Instructions for Front Desk Staff:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #856404;">
                            <li>Click "Book Appointment" to open the client registration form</li>
                            <li>Fill in all required client information</li>
                            <li>Select preferred branch, date, and time for the appointment</li>
                            <li>Submit the form to create the appointment</li>
                            <li>The client will receive a reference number for tracking</li>
                        </ol>
                    </div>
                    
                    <div id="frontdeskCheckupAppointmentsList" style="margin-top: 30px;">
                        <h4>Recent Appointments Booked</h4>
                        <p style="color: #666; font-size: 0.9rem;">Appointments will appear here after booking.</p>
                    </div>
                </div>
            </div>

            <!-- Client Registration Tab -->
            <div id="frontdeskClientRegistration" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ‘¤ Client Registration - Walk-in Registration</h3>
                    <p style="margin-bottom: 15px; color: #666;">Register new clients who visit the branch in person</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" id="fdClientName" placeholder="Full Name" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" id="fdClientPhone" placeholder="0812345678" required>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="fdClientEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="fdClientDOB">
                        </div>
                        <div class="form-group">
                            <label>ID Number</label>
                            <input type="text" id="fdClientID" placeholder="ID Number">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="fdClientAddress" rows="2" placeholder="Physical Address"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Distributor Referral (NB Number)</label>
                            <input type="text" id="fdClientReferral" placeholder="NB Number (optional)" style="text-transform: uppercase;">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="registerFrontDeskClient()">âž• Register Client</button>
                        <button class="btn btn-info" onclick="checkExistingClient()">ðŸ” Check Existing</button>
                        <button class="btn" onclick="clearFrontDeskClientForm()">ðŸ”„ Clear Form</button>
                    </div>
                    <div id="fdClientRegistrationResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Payment Collection Tab -->
            <div id="frontdeskPayments" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ’³ Payment Collection</h3>
                    <p style="margin-bottom: 15px; color: #666;">Collect payments for orders, prescriptions, and services</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Order/Prescription ID</label>
                            <input type="text" id="fdPaymentOrderID" placeholder="Enter Order ID or Prescription ID" required>
                            <button class="btn btn-info" style="margin-top: 5px; width: 100%;" onclick="lookupOrderForPayment()">ðŸ” Lookup Order</button>
                        </div>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="fdPaymentCustomer" placeholder="Customer Name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Amount Due</label>
                            <input type="number" id="fdPaymentAmount" placeholder="0.00" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Payment Method</label>
                            <select id="fdPaymentMethod" required>
                                <option value="">Select Payment Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="ewallet">E-Wallet</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="fdPaymentPaid" placeholder="Enter amount paid" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Reference Number</label>
                            <input type="text" id="fdPaymentReference" placeholder="Transaction/Reference Number">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="processFrontDeskPayment()">ðŸ’³ Process Payment</button>
                        <button class="btn" onclick="clearPaymentForm()">ðŸ”„ Clear</button>
                    </div>
                    <div id="fdPaymentResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“‹ Recent Payments</h3>
                    <div class="search-box">
                        <input type="text" id="fdPaymentSearch" placeholder="Search by customer name, order ID..." style="flex: 1;">
                        <button class="btn btn-info" onclick="refreshFrontDeskPayments()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="fdPaymentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Client Lookup Tab -->
            <div id="frontdeskClientLookup" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ” Client Lookup & Information</h3>
                    <p style="margin-bottom: 15px; color: #666;">Search for client information, order history, and records</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Search By</label>
                            <select id="fdLookupType" onchange="updateLookupFields()">
                                <option value="name">Name</option>
                                <option value="phone">Phone Number</option>
                                <option value="email">Email</option>
                                <option value="id">ID Number</option>
                                <option value="order">Order ID</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Search Term</label>
                            <input type="text" id="fdLookupTerm" placeholder="Enter search term" required>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="performClientLookup()">ðŸ” Search</button>
                        <button class="btn" onclick="clearLookupResults()">ðŸ”„ Clear</button>
                    </div>
                    <div id="fdLookupResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Delivery Scheduling Tab -->
            <div id="frontdeskDelivery" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸšš Delivery Scheduling</h3>
                    <p style="margin-bottom: 15px; color: #666;">Schedule and manage order deliveries</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Order ID</label>
                            <input type="text" id="fdDeliveryOrderID" placeholder="Enter Order ID" required>
                            <button class="btn btn-info" style="margin-top: 5px; width: 100%;" onclick="lookupOrderForDelivery()">ðŸ” Lookup Order</button>
                        </div>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="fdDeliveryCustomer" placeholder="Customer Name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Delivery Address</label>
                            <textarea id="fdDeliveryAddress" rows="3" placeholder="Delivery Address" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="required">Delivery Date</label>
                            <input type="date" id="fdDeliveryDate" required>
                        </div>
                        <div class="form-group">
                            <label>Delivery Time</label>
                            <input type="time" id="fdDeliveryTime">
                        </div>
                        <div class="form-group">
                            <label>Delivery Method</label>
                            <select id="fdDeliveryMethod">
                                <option value="standard">Standard Delivery</option>
                                <option value="express">Express Delivery</option>
                                <option value="pickup">Customer Pickup</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Delivery Notes</label>
                            <textarea id="fdDeliveryNotes" rows="2" placeholder="Special instructions, landmark, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Contact Phone</label>
                            <input type="tel" id="fdDeliveryPhone" placeholder="Contact number for delivery">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="scheduleDelivery()">ðŸ“… Schedule Delivery</button>
                        <button class="btn" onclick="clearDeliveryForm()">ðŸ”„ Clear</button>
                    </div>
                    <div id="fdDeliveryResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“‹ Scheduled Deliveries</h3>
                    <div class="search-box">
                        <select id="fdDeliveryStatusFilter" style="padding: 10px; margin-right: 10px;">
                            <option value="all">All Statuses</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in_transit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn btn-info" onclick="refreshDeliveries()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="fdDeliveriesList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Visitor Management Tab -->
            <div id="frontdeskVisitors" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸšª Visitor Management</h3>
                    <p style="margin-bottom: 15px; color: #666;">Register and track visitors to the branch</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Visitor Name</label>
                            <input type="text" id="fdVisitorName" placeholder="Full Name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="fdVisitorPhone" placeholder="0812345678">
                        </div>
                        <div class="form-group">
                            <label class="required">Purpose of Visit</label>
                            <select id="fdVisitorPurpose" required>
                                <option value="">Select Purpose</option>
                                <option value="consultation">Consultation</option>
                                <option value="product_purchase">Product Purchase</option>
                                <option value="order_collection">Order Collection</option>
                                <option value="appointment">Appointment</option>
                                <option value="inquiry">Inquiry</option>
                                <option value="meeting">Meeting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Person/Department to Visit</label>
                            <input type="text" id="fdVisitorContact" placeholder="Staff member or department name">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="fdVisitorNotes" rows="2" placeholder="Additional information"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="registerVisitor()">âœ… Register Visitor</button>
                        <button class="btn" onclick="clearVisitorForm()">ðŸ”„ Clear</button>
                    </div>
                    <div id="fdVisitorResult" style="margin-top: 20px;"></div>
                </div>
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“‹ Today's Visitors</h3>
                    <div class="search-box">
                        <input type="text" id="fdVisitorSearch" placeholder="Search visitors..." style="flex: 1;">
                        <button class="btn btn-info" onclick="refreshVisitors()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="fdVisitorsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Front Desk CRM Tab -->
            <div id="frontdeskCRM" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ‘¥ CRM - Lead Management</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Lead Name</label>
                            <input type="text" id="crmLeadName" placeholder="Full Name">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="crmLeadPhone" placeholder="0812345678">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="crmLeadEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Interest</label>
                            <input type="text" id="crmLeadInterest" placeholder="Product/package of interest">
                        </div>
                        <div class="form-group">
                            <label>Next Follow-up</label>
                            <input type="date" id="crmLeadFollowUp">
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="addCRMLead()">âž• Add Lead</button>
                        <button class="btn btn-info" onclick="refreshCRMLeads()">ðŸ”„ Refresh</button>
                        <button class="btn" onclick="openMISFromCRM()">ðŸ“Š View in MIS</button>
                    </div>
                </div>
                <div class="form-section">
                    <h3>ðŸ“‹ Leads</h3>
                    <div id="crmLeadsList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>

                <!-- Advanced CRM Sub-tabs -->
                <div class="form-section">
                    <div class="tabs" style="margin-bottom: 16px;">
                        <button class="tab-button active" onclick="showFrontdeskCRMTab('comm')">ðŸ’¬ Communication</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('segments')">ðŸ“Š Segmentation</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('workflows')">âš™ï¸ Workflows</button>
                        <button class="tab-button" onclick="showFrontdeskCRMTab('loyalty')">ðŸŽ Loyalty</button>
                    </div>

                    <!-- Communication -->
                    <div id="fdcrm-comm" class="fdcrm-subtab" style="display:block;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Client</label>
                                <input type="text" id="fdcrmCommClient" placeholder="Name or NB (optional)">
                            </div>
                            <div class="form-group">
                                <label>Channel</label>
                                <select id="fdcrmCommChannel">
                                    <option value="call">Call</option>
                                    <option value="sms">SMS</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="email">Email</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <input type="text" id="fdcrmCommNote" placeholder="Summary...">
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmAddInteraction()">âž• Add Interaction</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshInteractions()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="fdcrmCommList" style="max-height: 380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Segmentation -->
                    <div id="fdcrm-segments" class="fdcrm-subtab" style="display:none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Segment Name</label>
                                <input type="text" id="fdcrmSegName" placeholder="e.g., High BV Clients">
                            </div>
                            <div class="form-group">
                                <label>Rule</label>
                                <select id="fdcrmSegRule">
                                    <option value="bv_1000">BV â‰¥ 1000 (lifetime)</option>
                                    <option value="purchases_3m">â‰¥ 3 purchases (last 3 months)</option>
                                    <option value="no_purchase_60d">No purchase in 60 days</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmCreateSegment()">âž• Create Segment</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshSegments()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="fdcrmSegList" style="max-height:380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Workflows -->
                    <div id="fdcrm-workflows" class="fdcrm-subtab" style="display:none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Trigger</label>
                                <select id="fdcrmWfTrigger">
                                    <option value="lead_created">When lead is created</option>
                                    <option value="segment_join">When client joins segment</option>
                                    <option value="no_purchase_30d">No purchase in 30 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Action</label>
                                <select id="fdcrmWfAction">
                                    <option value="send_sms">Send SMS</option>
                                    <option value="send_email">Send Email</option>
                                    <option value="create_task">Create Follow-up Task</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="fdcrmCreateWorkflow()">âž• Create Workflow</button>
                            <button class="btn btn-info" onclick="fdcrmRefreshWorkflows()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="fdcrmWfList" style="max-height:380px; overflow-y:auto; margin-top:12px;"></div>
                    </div>

                    <!-- Loyalty -->
                    <div id="fdcrm-loyalty" class="fdcrm-subtab" style="display:none;">
                        <div style="margin-bottom:10px;">Top clients by BV or purchases (approx.)</div>
                        <div id="fdcrmLoyaltyList" style="max-height:380px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Front Desk Notifications Tab -->
            <div id="frontdeskNotifications" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ”” Notifications</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-info" onclick="renderNotifications()">ðŸ”„ Refresh</button>
                        <button class="btn" onclick="markAllNotificationsRead()">âœ… Mark All Read</button>
                        <button class="btn btn-danger" onclick="clearAllNotifications()">ðŸ—‘ï¸ Clear All</button>
                    </div>
                    <div id="notificationsList" style="max-height: 420px; overflow-y:auto;"></div>
                </div>
            </div>

            <div id="frontdeskStaffCommunication" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Coordinate front desk actions with branch staff and respond to their announcements.</p>
                    <div id="portalCommunicationList-frontdesk" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'frontdesk')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-frontdesk">Message</label>
                            <textarea id="portalCommunicationMessage-frontdesk" rows="4" placeholder="Share collection reminders, delivery updates or visitor notices..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('frontdesk')">Clear</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Processing Orders Tab -->
            <div id="processingOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ”„ Orders in Process</h3>
                    <div class="search-box">
                        <input type="text" id="processingOrderSearch" placeholder="Search orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshProcessingOrders()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="processingOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Shipped Orders Tab -->
            <div id="shippedOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸšš Shipped Orders</h3>
                    <div class="search-box">
                        <input type="text" id="shippedOrderSearch" placeholder="Search shipped orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshShippedOrders()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="shippedOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Delivered Orders Tab -->
            <div id="deliveredOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>âœ… Delivered Orders</h3>
                    <div class="search-box">
                        <input type="text" id="deliveredOrderSearch" placeholder="Search delivered orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshDeliveredOrders()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="deliveredOrdersList" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- All Orders Tab -->
            <div id="allOrders" class="order-tab-content" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ“‹ All Orders</h3>
                    <div class="search-box">
                        <input type="text" id="allOrderSearch" placeholder="Search all orders..." style="flex: 1;">
                        <button class="btn btn-success" onclick="refreshAllOrders()">ðŸ”„ Refresh</button>
                        <button class="btn btn-primary" onclick="exportOrdersReport()">ðŸ“¥ Export Report</button>
                    </div>
                    <div id="allOrdersList" style="margin-top: 20px;"></div>
                </div>

                <!-- Barcode System Tab -->
                <div id="barcodeTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ“· Barcode System</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; align-items: end;">
                            <div>
                                <label>Product</label>
                                <input type="text" id="barcodeProductName" placeholder="Enter product name...">
                            </div>
                            <div>
                                <label>SKU/Code</label>
                                <input type="text" id="barcodeSku" placeholder="e.g., PRD-0001">
                            </div>
                            <div>
                                <button class="btn btn-success" onclick="generateProductBarcode()">ðŸ·ï¸ Generate Barcode</button>
                            </div>
                        </div>
                        <div id="barcodePreview" style="margin-top: 15px; display: flex; gap: 20px; align-items: center;"></div>
                    </div>

                    <div class="form-section">
                        <h3>ðŸ“¥ Quick Stock Update (Manual Scan)</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
                            <input type="text" id="scannedCode" placeholder="Scan or enter code...">
                            <input type="number" id="scannedQuantity" placeholder="Quantity" min="1">
                            <select id="scanAction">
                                <option value="add">Add to Stock</option>
                                <option value="remove">Remove from Stock</option>
                            </select>
                            <button class="btn btn-success" onclick="applyScannedUpdate()">âœ… Apply</button>
                        </div>
                        <div id="scanUpdateStatus" style="margin-top: 10px; color: #666;"></div>
                    </div>
                </div>

                <!-- Reorder Points Tab -->
                <div id="reorderTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>âš ï¸ Automated Reorder Points</h3>
                        <div class="search-box" style="margin-bottom: 12px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="displayReorderPoints()">ðŸ”„ Refresh</button>
                            <button class="btn" onclick="exportReorderList()">ðŸ“¥ Export</button>
                            <button class="btn btn-primary" onclick="generatePurchaseOrders()">ðŸ§¾ Generate Purchase Orders</button>
                        </div>
                        <div id="reorderList" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ§ª Reorder Scenarios</h3>
                        <form onsubmit="handleReorderScenario(event)" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; background:#f8f9fa; border:1px solid #e1e5ec; padding:10px; border-radius:8px;">
                            <div>
                                <label>Name</label>
                                <input type="text" id="scenarioName" placeholder="e.g., Festive Uplift">
                            </div>
                            <div>
                                <label>Uplift %</label>
                                <input type="number" id="scenarioUplift" value="10" min="0" step="1">
                            </div>
                            <div>
                                <label>Lead Time (days)</label>
                                <input type="number" id="scenarioLeadTime" value="0" min="0">
                            </div>
                            <div>
                                <label>Service Level</label>
                                <select id="scenarioServiceLevel">
                                    <option value="0.9">90%</option>
                                    <option value="0.95" selected>95%</option>
                                    <option value="0.99">99%</option>
                                </select>
                            </div>
                            <div style="grid-column:1 / -1;">
                                <label>Notes</label>
                                <textarea id="scenarioNotes" rows="2" placeholder="Assumptions, constraints..."></textarea>
                            </div>
                            <div style="display:flex; gap:8px; align-items:end;">
                                <button class="btn btn-success" type="submit">Run Scenario</button>
                            </div>
                        </form>
                        <div id="reorderScenarioResults" style="margin-top:10px;"></div>
                    </div>
                </div>

                <!-- Batch Tracking Tab -->
                <div id="batchTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ”¢ Batch Tracking & Expiry Alerts</h3>
                        <div class="search-box" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <input type="text" id="batchSearch" placeholder="Search by product/batch..." onkeyup="displayBatchTracking()">
                            <select id="batchExpiryFilter" onchange="displayBatchTracking()">
                                <option value="all">All</option>
                                <option value="expiring60">Expiring â‰¤ 60 days</option>
                                <option value="expired">Expired</option>
                                <option value="recalled">Recalled</option>
                            </select>
                            <button class="btn btn-info" onclick="displayBatchTracking()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="batchTrackingList" style="max-height: 600px; overflow-y: auto; margin-top: 10px;"></div>
                    </div>
                    <div class="form-section">
                        <h3>â†©ï¸ Returns & Recalls</h3>
                        <form onsubmit="handleReturnSubmit(event)" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; background:#f8f9fa; border:1px solid #e1e5ec; padding:10px; border-radius:8px;">
                            <div>
                                <label>Type</label>
                                <select id="returnType">
                                    <option value="customer">Customer Return</option>
                                    <option value="supplier">Supplier Return</option>
                                    <option value="recall">Recall</option>
                                </select>
                            </div>
                            <div>
                                <label>Product</label>
                                <input type="text" id="returnProduct" required>
                            </div>
                            <div>
                                <label>Batch</label>
                                <input type="text" id="returnBatch">
                            </div>
                            <div>
                                <label>Quantity</label>
                                <input type="number" id="returnQuantity" min="1" required>
                            </div>
                            <div>
                                <label>Reason</label>
                                <input type="text" id="returnReason" placeholder="e.g., damage">
                            </div>
                            <div>
                                <label>Disposition</label>
                                <select id="returnDisposition">
                                    <option value="hold">Hold</option>
                                    <option value="destroy">Destroy</option>
                                    <option value="return">Return to Supplier</option>
                                </select>
                            </div>
                            <div style="grid-column:1 / -1;">
                                <label>Notes</label>
                                <textarea id="returnNotes" rows="2"></textarea>
                            </div>
                            <div style="display:flex; gap:8px; align-items:end;">
                                <button class="btn btn-success" type="submit">Save</button>
                            </div>
                        </form>
                        <div id="returnsList" style="margin-top:10px;"></div>
                    </div>
                </div>

                <!-- Stock Valuation Tab -->
                <div id="valuationTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ’° Stock Valuation</h3>
                        <div class="search-box" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <label>Method</label>
                            <select id="valuationMethod" onchange="displayStockValuation()">
                                <option value="fifo">FIFO</option>
                                <option value="lifo">LIFO</option>
                            </select>
                            <button class="btn btn-info" onclick="displayStockValuation()">ðŸ”„ Refresh</button>
                            <button class="btn" onclick="exportStockValuation()">ðŸ“¥ Export</button>
                        </div>
                        <div id="stockValuationSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 10px;"></div>
                        <div id="stockValuationDetails" style="max-height: 600px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consultant Portal -->
        <div id="consultant" class="tab-content">
            <div id="consultantAuth">
                <div class="portal-header">
                    <h2>ðŸ‘¨â€âš•ï¸ Consultant Portal</h2>
                    <p>Access client records and create medical reports</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">ðŸ”„ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access consultant portal</p>
                    <button class="btn" onclick="showLogin('consultant')">ðŸ” Login</button>
                </div>
            </div>
            <div id="consultantContent" style="display: none;">
                <div class="user-profile" id="consultantProfile"></div>
                
                <div class="portal-header">
                    <h2>ðŸ‘¨â€âš•ï¸ Consultant Portal - Client Management</h2>
                    <p>Review client information and create medical reports</p>
                </div>
                
                <div class="search-box">
                    <input type="text" id="consultantSearch" placeholder="Search client by name, phone, or reference number...">
                    <button class="btn" onclick="searchClients('consultant')">ðŸ” Search</button>
                    <button class="btn btn-info" onclick="showAllClients('consultant')">ðŸ“‹ Show All Clients</button>
                    <button class="btn btn-success" onclick="refreshConsultantData()">ðŸ”„ Refresh Data</button>
                </div>

                <div id="clientList"></div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“‹ My Created Reports</h3>
                    <div class="search-box">
                        <input type="text" id="reportSearch" placeholder="Search reports by client name or report ID...">
                        <button class="btn" onclick="searchMyReports()">ðŸ” Search</button>
                        <button class="btn btn-info" onclick="showAllMyReports()">ðŸ“‹ Show All</button>
                        <button class="btn btn-success" onclick="refreshMyReports()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="myReportsList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“… Upcoming Follow-ups</h3>
                    <div class="search-box">
                        <input type="date" id="followUpSearch" placeholder="Filter by date..." onchange="filterFollowUps()">
                        <button class="btn btn-primary" onclick="showAllFollowUps()">Show All</button>
                        <button class="btn btn-info" onclick="refreshFollowUps()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="followUpList"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“Š My Performance Analytics</h3>
                    <div class="search-box">
                        <select id="analyticsTimeframe" onchange="refreshAnalytics()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshAnalytics()">ðŸ”„ Refresh Analytics</button>
                        <button class="btn btn-primary" onclick="printAnalytics()">ðŸ–¨ï¸ Print Report</button>
                    </div>
                    <div id="analyticsDisplay"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“… Appointment Calendar</h3>
                    <div class="search-box">
                        <select id="calendarView" onchange="changeCalendarView()" style="padding: 10px; margin-right: 10px;">
                            <option value="dayGridMonth">Monthly</option>
                            <option value="timeGridWeek">Weekly</option>
                            <option value="timeGridDay">Daily</option>
                        </select>
                        <button class="btn btn-success" onclick="initFullCalendar()">ðŸ“… Open Calendar</button>
                        <button class="btn btn-primary" onclick="showAppointmentBookingModal()">âž• Book Appointment</button>
                        <button class="btn btn-info" onclick="showTimeSlotManagement()">â° Manage Time Slots</button>
                        <button class="btn btn-warning" onclick="showAppointmentAnalytics()">ðŸ“Š Analytics</button>
                        <a href="/appointments-admin.html" target="_blank" style="background:#ffffff;border:2px solid #1f2937;color:#1f2937;padding:6px 10px;border-radius:6px;text-decoration:none;font-weight:700;">Appointments Admin</a>
                    </div>
                    <div id="appointmentCalendar" style="display: none; margin-top: 20px;"></div>
                    <div id="appointmentsList"></div>
                </div>
                
                <!-- Client Self-Service Booking Page -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ”— Client Booking Page</h3>
                    <button class="btn btn-success" onclick="showClientBookingPage()">ðŸŒ Open Client Booking Page</button>
                    <button class="btn btn-info" onclick="copyBookingLink()">ðŸ“‹ Copy Booking Link</button>
                </div>
            </div>
        </div>

        <!-- Branch Portal (formerly Dispenser Portal) -->
        <div id="dispenser" class="tab-content">
            <div id="dispenserAuth">
                <div class="portal-header">
                    <h2>ðŸ¬ Branch Portal</h2>
                    <p>Sales, prescriptions, and branch operations</p>
                    <button class="btn btn-primary" onclick="refreshAllData()" style="margin-top: 10px;">ðŸ”„ Refresh Data</button>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access branch portal</p>
                    <button class="btn" onclick="showLogin('dispenser')">ðŸ” Login</button>
                </div>
            </div>
            <div id="dispenserContent" style="display: none;">
                <div class="user-profile" id="dispenserProfile"></div>
                
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">ðŸ¬ Branch Portal</h2>
                
                <!-- Cash Drawer Status -->
                <div id="cashDrawerStatus" style="background: #f8f9fa; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <!-- Will be populated by displayCashDrawerStatus() -->
                </div>
                
                <!-- Main Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 3px solid #c41e3a; flex-wrap: wrap;">
                    <button class="dispenserTab" id="walkInTab" onclick="showDispenserTab('walkIn')" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold;">
                        ðŸ›’ Sales
                    </button>
                    <button class="dispenserTab" id="prescriptionTab" onclick="showDispenserTab('prescription')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ’Š Prescriptions
                    </button>
                    <button class="dispenserTab" id="stockTab" onclick="showDispenserTab('stock')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ“¦ Stock
                    </button>
                    <button class="dispenserTab" id="bankingTab" onclick="showDispenserTab('banking')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ¦ Banking
                    </button>
                    <button class="dispenserTab" id="paymentsTab" onclick="showDispenserTab('payments')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ’³ Payments
                    </button>
                    <button class="dispenserTab" id="onlineOrdersTab" onclick="showDispenserTab('onlineOrders')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ›ï¸ Online Orders
                    </button>
                    <button class="dispenserTab" id="bonusTab" onclick="showDispenserTab('bonus')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸŽ Bonus
                    </button>
                    <button class="dispenserTab" id="communicationTab" onclick="showDispenserTab('communication')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ’¬ Communication
                    </button>
                    <button class="dispenserTab" id="staffTab" onclick="showDispenserTab('staff')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ‘¤ Staff
                    </button>
                    <button class="dispenserTab" id="distributorRegistrationTab" onclick="showDispenserTab('distributorRegistration')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸ“ Distributor Registration
                    </button>
                    <button class="dispenserTab" id="fieldProgramTab" onclick="showDispenserTab('fieldProgram')" style="flex: 1; padding: 15px; background: #ecf0f1; color: #2c3e50; font-size: 1rem; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">
                        ðŸš Field Program
                    </button>
                </div>
                
                <!-- Branch Stock Section (Hidden by default) -->
                <div id="dispenserStockSection" style="display: none;">
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h2 style="color: #2c3e50; margin: 0;">ðŸ“¦ Branch Inventory Management</h2>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="refreshBranchInventory()" style="background: #c41e3a; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ðŸ”„ Refresh
                                </button>
                                <button class="btn btn-success" onclick="openBranchStockReceiveModal()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    âž• Receive Stock
                                </button>
                                <button class="btn btn-info" onclick="openBranchStockTransferModal()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    ðŸ“¤ Transfer Stock
                                </button>
                                <button class="btn btn-secondary" onclick="exportBranchInventoryCSV()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    ðŸ“¥ Export CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filters and Search -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>Search Product</label>
                                    <input type="text" id="branchInventorySearch" placeholder="Search products..." 
                                           onkeyup="filterBranchInventory()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="branchInventoryCategory" onchange="filterBranchInventory()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="all">All Categories</option>
                                        <option value="low">Low Stock</option>
                                        <option value="out">Out of Stock</option>
                                        <option value="expiring">Expiring Soon</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Sort By</label>
                                    <select id="branchInventorySort" onchange="filterBranchInventory()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="name">Product Name</option>
                                        <option value="stock">Stock Level</option>
                                        <option value="expiry">Expiry Date</option>
                                    </select>
                                </div>
                    </div>
                </div>
                
                        <!-- KPI Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Products</div>
                                <div id="branchInventoryTotalProducts" style="font-size: 2rem; font-weight: bold; margin-top: 5px;">0</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Stock Value</div>
                                <div id="branchInventoryTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 5px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Low Stock Items</div>
                                <div id="branchInventoryLowStock" style="font-size: 2rem; font-weight: bold; margin-top: 5px;">0</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Out of Stock</div>
                                <div id="branchInventoryOutOfStock" style="font-size: 2rem; font-weight: bold; margin-top: 5px;">0</div>
                            </div>
                        </div>
                        
                        <!-- Inventory Table -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; overflow-x: auto;">
                            <table id="branchInventoryTable" class="table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #c41e3a;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Product</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Batch No</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600;">Quantity</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Expiry Date</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600;">Unit Price</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600;">Total Value</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Status</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="branchInventoryTableBody">
                                    <tr>
                                        <td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">
                                            Loading inventory...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Stock Movements History (Restricted) -->
                        <div style="margin-top: 30px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">ðŸ“Š Recent Stock Movements</h3>
                            <div id="branchInventoryMovements" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d;">Loading movements...</p>
                            </div>
                            <div id="branchInventoryRestrictedNotice" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <p style="color: #856404; margin: 0;">
                                    <strong>âš ï¸ Restricted Access:</strong> Sensitive inventory data (expected stock, stock losses, and adjustments) requires GM clearance. 
                                    Contact your General Manager for access to this information.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Branch Stock Receive Modal -->
                <div id="branchStockReceiveModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeBranchStockReceiveModal()">&times;</span>
                        <h2 style="color: #c41e3a;">ðŸ“¦ Receive Stock</h2>
                        
                        <form id="branchStockReceiveForm" onsubmit="submitBranchStockReceive(event)">
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="receiveProductSelect" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Batch Number *</label>
                                    <input type="text" id="receiveBatchNo" required placeholder="Enter or scan batch number">
                                </div>
                                <div class="form-group">
                                    <label>Expiry Date *</label>
                                    <input type="month" id="receiveExpiryDate" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" id="receiveQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Unit</label>
                                    <input type="text" id="receiveUnit" placeholder="boxes, units, etc.">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Source</label>
                                <select id="receiveSource" style="width: 100%; padding: 10px;">
                                    <option value="warehouse">Warehouse</option>
                                    <option value="transfer">Transfer from Branch</option>
                                    <option value="return">Return</option>
                                    <option value="adjustment">Adjustment</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="receiveNotes" rows="3" placeholder="Additional notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-success" style="flex: 1;">âœ… Receive Stock</button>
                                <button type="button" class="btn btn-secondary" onclick="closeBranchStockReceiveModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Branch Stock Transfer Modal -->
                <div id="branchStockTransferModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeBranchStockTransferModal()">&times;</span>
                        <h2 style="color: #c41e3a;">ðŸ“¤ Transfer Stock</h2>
                        
                        <form id="branchStockTransferForm" onsubmit="submitBranchStockTransfer(event)">
                            <div class="form-group">
                                <label>From Branch *</label>
                                <input type="text" id="transferFromBranch" readonly style="width: 100%; padding: 10px; background: #f0f0f0;">
                            </div>
                            
                            <div class="form-group">
                                <label>To Branch *</label>
                                <select id="transferToBranch" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Destination Branch</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="transferProductSelect" required style="width: 100%; padding: 10px;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Batch Number *</label>
                                    <input type="text" id="transferBatchNo" required placeholder="Enter or scan batch number">
                                </div>
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" id="transferQuantity" min="1" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="transferNotes" rows="3" placeholder="Transfer reason or notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-success" style="flex: 1;">ðŸ“¤ Transfer Stock</button>
                                <button type="button" class="btn btn-secondary" onclick="closeBranchStockTransferModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Online Orders Section (Hidden by default) -->
                <div id="dispenserOnlineOrdersSection" style="display: none;">
                    <div class="form-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                            <h3 style="color:#2c3e50; margin:0;">ðŸ›ï¸ Online Orders</h3>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-success" onclick="displayBranchOnlineOrders()">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        <p style="color:#7f8c8d; margin-top:6px;">Receive and dispense online orders assigned to this branch.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px; margin-top:12px;">
                            <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                                <h4 style="margin:0 0 10px 0;">ðŸ“¥ Receiving</h4>
                                <div id="branchOnlineOrdersReceiving" style="max-height:420px; overflow:auto;"></div>
                            </div>
                            <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                                <h4 style="margin:0 0 10px 0;">ðŸ“¦ Dispensing</h4>
                                <div id="branchOnlineOrdersDispensing" style="max-height:420px; overflow:auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Walk-in Section (Default visible) -->
                <div id="dispenserWalkInSection">
                
                <!-- Walk-in Sales Section -->
                <div class="form-section" style="margin-bottom: 30px; padding: 30px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 1.3rem; padding: 25px 50px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="showWalkInSaleModal('customer')">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ›’</div>
                            <div style="font-weight: bold; font-size: 1.2rem;">New Walk-in Sale</div>
                            <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 5px;">Process walk-in customer purchase</div>
                        </button>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ“‹ Recent Walk-in Sales</h4>
                        <div id="walkInSalesList" style="min-height: 100px;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">No walk-in sales yet</p>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Prescription Section (Hidden by default) -->
                <div id="dispenserPrescriptionSection" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ðŸ“‹ Prescription Dispensing</h3>
                
                <div class="search-box">
                    <input type="text" id="dispenserSearch" placeholder="Search prescriptions by client name, report ID, or consultant...">
                    <button class="btn" onclick="searchPrescriptions('dispenser')">ðŸ” Search</button>
                    <button class="btn btn-info" onclick="showAllPrescriptions('dispenser')">ðŸ’Š Show All Prescriptions</button>
                    <button class="btn btn-warning" onclick="updateExistingReportsPricing()">ðŸ’° Update Pricing</button>
                    <button class="btn btn-primary" onclick="showDailyStatementModal()">ðŸ“Š Daily Statement</button>
                    <button class="btn btn-success" onclick="refreshDispenserData()">ðŸ”„ Refresh Data</button>
                </div>

                <!-- Status/Date Filters -->
                <div class="search-box" style="gap: 10px; align-items: center;">
                    <select id="rxStatusFilter" onchange="displayPrescriptions()" style="padding: 10px;">
                        <option value="all" selected>Status: All</option>
                        <option value="pending">Pending</option>
                        <option value="dispensed">Dispensed</option>
                        <option value="paid">Paid</option>
                        <option value="outstanding">Outstanding</option>
                    </select>
                    <input type="date" id="rxFromDate" onchange="displayPrescriptions()" title="From date" style="padding: 10px;">
                    <input type="date" id="rxToDate" onchange="displayPrescriptions()" title="To date" style="padding: 10px;">
                    <button class="btn" onclick="clearRxFilters()">â™»ï¸ Clear Filters</button>
                </div>

                <div id="prescriptionList"></div>

                <!-- Business Intelligence Dashboard -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“ˆ Business Intelligence Dashboard</h3>
                    <div class="search-box">
                        <select id="biTimeframe" onchange="refreshBusinessIntelligence()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshBusinessIntelligence()">ðŸ”„ Refresh</button>
                        <button class="btn btn-primary" onclick="printBusinessIntelligence()">ðŸ–¨ï¸ Print Report</button>
                    </div>
                    <div id="biDisplay"></div>
                </div>
                
                <!-- Unified Sales Dashboard -->
                <div class="form-section" style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">ðŸ“Š Unified Sales Dashboard</h3>
                    <div class="search-box" style="margin-bottom: 20px;">
                        <select id="salesTimeframe" onchange="refreshUnifiedSales()" style="padding: 10px; margin-right: 10px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-success" onclick="refreshUnifiedSales()">ðŸ”„ Refresh</button>
                        <button class="btn btn-primary" onclick="printUnifiedSales()">ðŸ–¨ï¸ Print Report</button>
                        <button class="btn btn-info" onclick="exportUnifiedSales()">ðŸ“¥ Export Excel</button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 id="totalSales" style="color: #3498db; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total Sales (N$)</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 id="totalBV" style="color: #27ae60; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total BV Points</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 id="walkInCount" style="color: #e74c3c; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Walk-in Sales</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 id="prescriptionCount" style="color: #f39c12; font-size: 28pt; margin-bottom: 5px;">0</h3>
                            <p style="color: #666; font-size: 0.9rem;">Prescriptions</p>
                        </div>
                    </div>
                    
                    <!-- Customer Type Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ’¼ Customer Type Sales</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Distributor Sales:</span>
                                    <strong id="distributorSales" style="color: #27ae60;">N$ 0.00</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div id="distributorBar" style="background: #27ae60; height: 100%; width: 0%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Customer Sales:</span>
                                    <strong id="customerSales" style="color: #f39c12;">N$ 0.00</strong>
                                </div>
                                <div style="background: #fff3cd; height: 10px; border-radius: 5px;">
                                    <div id="customerBar" style="background: #f39c12; height: 100%; width: 0%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ‘¥ Top Distributors</h4>
                            <div id="topDistributors" style="max-height: 200px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Sales Table -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ“‹ Detailed Sales Breakdown</h4>
                        <div id="unifiedSalesDetail" style="max-height: 400px; overflow-y: auto;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading sales data...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Price List Section -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ’° Official Price List - June 2025</h3>
                    <div class="search-box">
                        <input type="text" id="priceSearch" placeholder="Search products by name..." onkeyup="searchPriceList()">
                        <button class="btn btn-info" onclick="showAllPrices()">ðŸ“‹ Show All Prices</button>
                        <button class="btn btn-success" onclick="printPriceList()">ðŸ–¨ï¸ Print Price List</button>
                    </div>
                    <div id="priceList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Banking Section -->
            <div id="dispenserBankingSection" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ¦ Banking Operations</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <button class="btn btn-success" style="padding: 20px; font-size: 1.1rem;" onclick="showBankDepositModal()">
                            ðŸ’° Make Deposit
                        </button>
                        <button class="btn btn-info" style="padding: 20px; font-size: 1.1rem;" onclick="showCashDrawerModal()">
                            ðŸ’µ Cash Drawer
                        </button>
                        <button class="btn btn-warning" style="padding: 20px; font-size: 1.1rem;" onclick="showCashExpenseModal()">
                            ðŸ’¸ Record Expense
                        </button>
                        <button class="btn" style="padding: 20px; font-size: 1.1rem;" onclick="displayBankingHistory()">
                            ðŸ“‹ Banking History
                        </button>
                    </div>
                    <div id="bankingOperations" style="background: white; padding: 20px; border-radius: 8px;"></div>
                </div>
            </div>
            
            <!-- Payments Section -->
            <div id="dispenserPaymentsSection" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ’³ Payment Management</h3>
                    <div class="search-box">
                        <input type="text" id="paymentSearch" placeholder="Search by client name or invoice number..." onkeyup="searchPayments()">
                        <button class="btn btn-success" onclick="showRecordPaymentModal()">âž• Record Payment</button>
                        <button class="btn btn-info" onclick="displayPaymentHistory()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="paymentsList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Bonus Section -->
            <div id="dispenserBonusSection" style="display: none;">
                <div class="form-section">
                    <h3>ðŸŽ Bonus Payouts</h3>
                    <div class="search-box" style="margin-bottom: 12px; gap: 10px; flex-wrap: wrap;">
                        <input type="month" id="dispenserBonusMonth" style="max-width: 200px;">
                        <input type="text" id="dispenserBonusSearch" placeholder="Search NB or Name..." onkeyup="renderDispenserPendingBonuses()" style="flex: 1; min-width: 240px;">
                        <button class="btn btn-success" onclick="renderDispenserPendingBonuses()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="dispenserBonusSummary" style="margin: 8px 0; color: #2c3e50;"></div>
                    <div id="dispenserPendingBonusList" class="scroll-x" style="max-height: 460px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No pending bonuses</p>
                    </div>
                </div>
            </div>

            <!-- Communication Section -->
            <div id="dispenserCommunicationSection" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communications</h3>
                    <p class="portal-communication-note">Review messages from HR, GM, Director, Finance, Front Desk and MIS, then send updates back to them.</p>
                    <div class="staff-comm-tabs">
                        <button class="staff-comm-filter-btn active" data-filter="all" onclick="setStaffCommFilter('all', event)">All</button>
                        <button class="staff-comm-filter-btn" data-filter="hr" onclick="setStaffCommFilter('hr', event)">ðŸ‘¥ HR</button>
                        <button class="staff-comm-filter-btn" data-filter="gm" onclick="setStaffCommFilter('gm', event)">ðŸ‘” GM</button>
                        <button class="staff-comm-filter-btn" data-filter="director" onclick="setStaffCommFilter('director', event)">ðŸŽ¯ Director</button>
                        <button class="staff-comm-filter-btn" data-filter="finance" onclick="setStaffCommFilter('finance', event)">ðŸ’° Finance</button>
                        <button class="staff-comm-filter-btn" data-filter="frontdesk" onclick="setStaffCommFilter('frontdesk', event)">ðŸ–¥ï¸ Front Desk</button>
                        <button class="staff-comm-filter-btn" data-filter="mis" onclick="setStaffCommFilter('mis', event)">ðŸ“Š MIS</button>
                    </div>
                    <div id="staffCommunicationInbox" class="communication-list"></div>
                    <form id="staffCommunicationForm" class="communication-form" onsubmit="submitStaffCommunication(event)">
                        <div class="form-group">
                            <label class="required">Choose recipients</label>
                            <div class="checkbox-group" id="staffCommRecipients">
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="hr">ðŸ‘¥ HR</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="gm">ðŸ‘” GM</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="director">ðŸŽ¯ Director</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="finance">ðŸ’° Finance</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="frontdesk">ðŸ–¥ï¸ Front Desk</label>
                                <label class="checkbox-item"><input type="checkbox" name="staffCommRecipient" value="mis">ðŸ“Š MIS</label>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-info btn-sm" onclick="toggleStaffRecipients(true)">Select All</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleStaffRecipients(false)">Clear</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required" for="staffCommMessage">Message</label>
                            <textarea id="staffCommMessage" rows="4" placeholder="Type your update or request..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send Communication</button>
                            <button type="button" class="btn" onclick="resetStaffCommunicationForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Staff Section (Services & Communications) -->
            <div id="dispenserStaffSection" style="display: none;">
                <div class="form-section">
                    <div class="staff-subtabs">
                        <button class="staff-subtab-btn active" data-tab="services" onclick="showStaffSubTab('services', event)">ðŸ› ï¸ Services</button>
                    </div>

                    <div id="staffServicesTab" class="staff-subtab-content active">
                        <h3>ðŸ‘¤ Staff Services</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Leave Request -->
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 2px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">ðŸ“… Leave Management</h4>
                                <button class="btn btn-success" onclick="showDispenserLeaveRequest()">Request Leave</button>
                                <button class="btn btn-info" onclick="viewMyLeaveRequests()">My Leave Requests</button>
                                <div id="myLeaveStatus" style="margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Cash Request -->
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border: 2px solid #2196f3;">
                                <h4 style="color: #1565c0; margin-bottom: 15px;">ðŸ’µ Cash Requests</h4>
                                <button class="btn btn-success" onclick="showDispenserCashRequest()">Request Cash</button>
                                <button class="btn btn-info" onclick="viewMyCashRequests()">My Cash Requests</button>
                                <div id="myCashStatus" style="margin-top: 15px;"></div>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
            
            <!-- Distributor Registration Section -->
            <div id="dispenserDistributorRegistrationSection" style="display: none;">
                <div class="form-section">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">ðŸ“ Distributor Agreement Form</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Register a new distributor by filling out the agreement form below.</p>
                    
                    <form id="distributorAgreementForm" onsubmit="submitDistributorAgreement(event)" style="background: white; padding: 30px; border-radius: 8px; border: 1px solid #ddd;">
                        <!-- Instructions -->
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #856404;">âš ï¸ PLEASE READ CAREFULLY</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #856404;">
                                <li><strong>This is a legal agreement. FORMS WITH INCOMPLETE INFORMATION WILL NOT BE PROCESSED.</strong></li>
                                <li>Please press firmly and print clearly.</li>
                                <li>Husband and wife are considered as one Distributor only.</li>
                                <li>Corporation may register, but needs to submit SEC/DTI. Authorized Representative will need duly appointed Power of Attorney or Board Resolution.</li>
                            </ol>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Distributor's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label class="required">Full Name (Last name, First name, M.I.)</label>
                                <input type="text" id="distributorName" name="distributorName" required placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label class="required">Birthdate</label>
                                <input type="date" id="distributorBirthdate" name="birthdate" required>
                            </div>
                            
                            <div>
                                <label>Age</label>
                                <input type="number" id="distributorAge" name="age" min="18" readonly>
                            </div>
                            
                            <div>
                                <label class="required">Sex</label>
                                <select id="distributorSex" name="sex" required style="padding: 10px;">
                                    <option value="">Select...</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="required">Nationality</label>
                                <input type="text" id="distributorNationality" name="nationality" required placeholder="e.g., Namibian">
                            </div>
                            
                            <div>
                                <label class="required">Mobile Number</label>
                                <input type="tel" id="distributorMobile" name="mobileNo" required placeholder="0812345678">
                            </div>
                            
                            <div>
                                <label>Residence Phone</label>
                                <input type="tel" id="distributorResidencePhone" name="residencePhone" placeholder="0612345678">
                            </div>
                            
                            <div>
                                <label>Office Phone</label>
                                <input type="tel" id="distributorOfficePhone" name="officePhone" placeholder="0612345678">
                            </div>
                            
                            <div>
                                <label>Email</label>
                                <input type="email" id="distributorEmail" name="email" placeholder="email@example.com">
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <label>Profile Photo (Optional)</label>
                                <input type="file" name="photo" id="distributorPhotoInput" accept="image/*" onchange="previewDistributorPhoto(event)">
                                <div id="distributorPhotoPreview" style="margin-top: 10px; display: none;">
                                    <img id="distributorPhotoPreviewImg" src="" alt="Photo preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                                </div>
                            </div>
                            
                            <div>
                                <label class="required">Mailing Address (House number, Street)</label>
                                <input type="text" id="distributorAddress1" name="address1" required placeholder="House No., Street">
                            </div>
                            
                            <div>
                                <label class="required">Town, City</label>
                                <input type="text" id="distributorCity" name="city" required placeholder="Town, City">
                            </div>
                            
                            <div>
                                <label>Zip/Postal Code</label>
                                <input type="text" id="distributorZipCode" name="zipCode" placeholder="00000">
                            </div>
                            
                            <div>
                                <label>Tax Identification No.</label>
                                <input type="text" id="distributorTaxId" name="taxId" placeholder="Tax ID">
                            </div>
                            
                            <div>
                                <label>SSS No.</label>
                                <input type="text" id="distributorSSS" name="sssNo" placeholder="SSS Number">
                            </div>
                            
                            <div>
                                <label>Beneficiary</label>
                                <input type="text" id="distributorBeneficiary" name="beneficiary" placeholder="Beneficiary Name">
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Direct Upline's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label>Upline Name (Last name, First name, M.I.)</label>
                                <input type="text" id="uplineName" name="uplineName" placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label>Direct Upline's ID No.</label>
                                <input type="text" id="uplineIdNo" name="uplineIdNo" placeholder="e.g., NB001544" onkeyup="searchUplineDistributor()">
                                <div id="uplineSearchResults" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                            </div>
                            
                            <div>
                                <label>Upline Mailing Address</label>
                                <input type="text" id="uplineAddress" name="uplineAddress" placeholder="Address">
                            </div>
                            
                            <div>
                                <label>Upline City</label>
                                <input type="text" id="uplineCity" name="uplineCity" placeholder="City">
                            </div>
                            
                            <div>
                                <label>Upline Mobile</label>
                                <input type="tel" id="uplineMobile" name="uplineMobile" placeholder="Mobile">
                            </div>
                            
                            <div>
                                <label>Upline Zip Code</label>
                                <input type="text" id="uplineZipCode" name="uplineZipCode" placeholder="Zip Code">
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Sponsor's Data</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label>Sponsor Name (Last name, First name, M.I.)</label>
                                <input type="text" id="sponsorName" name="sponsorName" placeholder="Last, First, M.I.">
                            </div>
                            
                            <div>
                                <label>Sponsor's ID No.</label>
                                <input type="text" id="sponsorIdNo" name="sponsorIdNo" placeholder="e.g., NB001544" onkeyup="searchSponsorDistributor()">
                                <div id="sponsorSearchResults" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                            </div>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Registration Kit Selection</h3>
                        
                        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 5px; padding: 15px; margin-top: 20px; margin-bottom: 20px;">
                            <p style="margin: 0 0 10px 0; color: #1565c0; font-weight: bold;">âš ï¸ Required: Select a registration kit to be dispensed</p>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="registrationKit" value="fert" required style="margin-right: 8px;">
                                <strong>REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)</strong>
                                <span style="color: #666; margin-left: 10px;">- Price: N$ 1,200.00 (CP: N$ 1,200.00, BV: 150)</span>
                            </label>
                            <label style="display: block;">
                                <input type="radio" name="registrationKit" value="alfalfa" required style="margin-right: 8px;">
                                <strong>REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)</strong>
                                <span style="color: #666; margin-left: 10px;">- Price: N$ 1,200.00 (CP: N$ 1,200.00, BV: 150)</span>
                            </label>
                            <small style="color: #666; display: block; margin-top: 10px;">
                                The selected kit will be automatically dispensed and stock will be reduced from the branch inventory upon registration.
                            </small>
                        </div>
                        
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-top: 30px;">Material Received</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="bag"> Bag
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="products"> Products (Specified)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="brochure"> All in One Product Brochure
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="priceList"> Price List
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="compensationPlan"> Compensation Plan
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="bodySystemsGuide"> Body Systems Guide
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="agreementForms"> Distributor Agreement Forms
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="materials" value="others"> Others: 
                                <input type="text" id="materialsOthers" placeholder="Specify" style="flex: 1; padding: 5px;">
                            </label>
                        </div>
                        
                        <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 5px; padding: 15px; margin-top: 30px;">
                            <h4 style="margin-top: 0; color: #2e7d32;">Declaration</h4>
                            <p style="color: #1b5e20; margin: 0;">
                                I, the undersigned, prior to becoming a distributor of Dynapharm, have read and understood the Dynapharm Compensation Plan and Distributor Agreement which are deemed to form part of this contract. I have read and am fully aware of the Terms and Conditions, and policies appearing on the reverse of this application form.
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div>
                                <label class="required">Date</label>
                                <input type="date" id="agreementDate" name="agreementDate" required value="" onchange="document.getElementById('agreementDate').value = this.value">
                            </div>
                            <div>
                                <label class="required">Applicant's Signature</label>
                                <input type="text" id="applicantSignature" name="applicantSignature" required placeholder="Full Name">
                            </div>
                        </div>
                        
                        <!-- FOR OFFICIAL USE ONLY -->
                        <div style="background: #7b1fa2; color: white; padding: 15px; border-radius: 5px; margin-top: 30px;">
                            <h3 style="margin-top: 0; color: white;">FOR OFFICIAL USE ONLY</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label>Date Received</label>
                                    <input type="date" id="dateReceived" name="dateReceived" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label>Received by</label>
                                    <input type="text" id="receivedBy" name="receivedBy" placeholder="Staff Name" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label>Processed by</label>
                                    <input type="text" id="processedBy" name="processedBy" placeholder="Staff Name" style="padding: 10px; width: 100%;">
                                </div>
                                <div>
                                    <label style="font-weight: bold;">Assigned Distributor ID No.</label>
                                    <input type="text" id="assignedDistributorId" name="assignedDistributorId" readonly style="padding: 10px; width: 100%; background: #fff; color: #000; font-weight: bold; font-size: 1.1rem;">
                                    <small style="color: #fff; opacity: 0.9;">Will be auto-generated upon save</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success" style="flex: 1; padding: 15px; font-size: 1.1rem;">
                                ðŸ’¾ Save & Register Distributor
                            </button>
                            <button type="button" class="btn" onclick="resetDistributorAgreementForm()" style="flex: 1; padding: 15px;">
                                ðŸ”„ Reset Form
                            </button>
                        </div>
                        
                        <div id="distributorAgreementStatus" style="margin-top: 20px;"></div>
                    </form>
                </div>
            </div>
            
            <!-- Field Program Section -->
            <div id="dispenserFieldProgramSection" style="display: none;">
                <div class="form-section">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">ðŸš Field Program - Stock Requests</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Manage stock requests from distributors for field program activities. All requests require distributor verification and FEFO compliance.</p>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openFieldProgramRequestForm()" style="background: #c41e3a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            âž• New Stock Request
                        </button>
                        <button class="btn btn-secondary" onclick="refreshFieldProgramRequests()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                    
                    <div id="fieldProgramRequestsList" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <p style="text-align: center; color: #7f8c8d;">Loading field program requests...</p>
                    </div>
                </div>
            </div>
            
            <!-- Field Program Request Form Modal -->
            <div id="fieldProgramRequestModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeFieldProgramRequestForm()">&times;</span>
                    <h2 style="color: #c41e3a; margin-bottom: 20px;">ðŸš Field Program Stock Request Form</h2>
                    
                    <form id="fieldProgramRequestForm" onsubmit="submitFieldProgramRequest(event)">
                        <!-- Distributor Verification -->
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #856404;">Distributor Verification *</h3>
                            <div class="form-group" style="position: relative;">
                                <label>Search Distributor by NB Number or Name *</label>
                                <input type="text" id="fieldProgramDistributorSearch" placeholder="Type NB number (e.g., NB001544) or name" 
                                       onkeyup="searchFieldProgramDistributor()" autocomplete="off" required>
                                <div id="fieldProgramDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                                <input type="hidden" id="fieldProgramDistributorId" required>
                                <small id="fieldProgramDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                            </div>
                            <div id="fieldProgramDistributorInfo" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                <strong>Selected Distributor:</strong> <span id="fieldProgramDistributorName"></span><br>
                                <strong>NB Number:</strong> <span id="fieldProgramDistributorCode"></span><br>
                                <strong>Mobile:</strong> <span id="fieldProgramDistributorMobile"></span>
                            </div>
                        </div>
                        
                        <!-- Request Details -->
                        <div class="form-group">
                            <label>Request Date *</label>
                            <input type="date" id="fieldProgramRequestDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Branch *</label>
                            <select id="fieldProgramBranch" required>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                        
                        <!-- Product Selection -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Requested Products *</h3>
                            <div id="fieldProgramProducts">
                                <div class="field-program-product-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;">
                                    <div class="form-group">
                                        <label>Product *</label>
                                        <select class="field-program-product-select" required>
                                            <option value="">Select Product</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Quantity *</label>
                                        <input type="number" class="field-program-quantity" min="1" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Unit</label>
                                        <input type="text" class="field-program-unit" placeholder="boxes, units, etc.">
                                    </div>
                                    <button type="button" class="btn btn-danger" onclick="removeFieldProgramProductRow(this)" style="padding: 8px 12px;">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addFieldProgramProductRow()" style="margin-top: 10px;">âž• Add Product</button>
                        </div>
                        
                        <!-- Notes -->
                        <div class="form-group">
                            <label>Purpose/Notes</label>
                            <textarea id="fieldProgramNotes" rows="3" placeholder="Brief description of field program activity or purpose"></textarea>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div style="background: #f8f9fa; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                            <h3 style="margin-top: 0; color: #c41e3a;">Terms and Conditions of Stock Handling Commitment</h3>
                            <ol style="font-size: 0.9rem; line-height: 1.6;">
                                <li><strong>Stock Accountability:</strong> The distributor is fully responsible for all stock received and must account for every item.</li>
                                <li><strong>FEFO Compliance:</strong> Stock will be issued following First Expired First Out (FEFO) principles. All products must be issued by batch/expiry date using barcode scanning.</li>
                                <li><strong>Storage Requirements:</strong> Stock must be stored in appropriate conditions (temperature, humidity, etc.) as per product specifications.</li>
                                <li><strong>Damage/Loss Reporting:</strong> Any damaged or lost stock must be reported immediately to the branch manager.</li>
                                <li><strong>Return Policy:</strong> Unused stock may be returned within 30 days if in original condition and packaging.</li>
                                <li><strong>Sales Records:</strong> Complete sales records must be maintained and submitted as required.</li>
                                <li><strong>Payment Terms:</strong> Payment for stock must be made according to agreed terms. Late payments may affect future requests.</li>
                                <li><strong>Compliance:</strong> All stock must be used/sold in compliance with Dynapharm policies and local regulations.</li>
                            </ol>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="fieldProgramAgreeTerms" required style="margin-right: 8px; width: 18px; height: 18px;">
                                    <span>I have read and agree to the Terms and Conditions of Stock Handling Commitment *</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Signature -->
                        <div class="form-group">
                            <label>Distributor Signature (Type Full Name) *</label>
                            <input type="text" id="fieldProgramSignature" placeholder="Full name as signature" required>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="closeFieldProgramRequestForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Field Program Stock Issuing Modal (FEFO) -->
            <div id="fieldProgramIssuingModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeFieldProgramIssuing()">&times;</span>
                    <h2 style="color: #c41e3a; margin-bottom: 20px;">ðŸ“¦ Issue Stock (FEFO Compliance Required)</h2>
                    
                    <div id="fieldProgramIssuingContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock & Inventory Management Portal -->
        <div id="stock" class="tab-content">
            <div id="stockAuth">
                <div class="portal-header">
                    <h2>ðŸ“¦ Stock & Inventory Management</h2>
                    <p>Manage stock receiving, warehouses, and distribution</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access stock management portal</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn" onclick="showLogin('stock')">ðŸ” Login</button>
                    </div>
                </div>
            </div>
            <div id="stockContent" style="display: none;">
                <div class="user-profile" id="stockProfile"></div>
                
                <div class="portal-header">
                    <h2>ðŸ“¦ Stock & Inventory Management Portal</h2>
                    <p>Manage country stock, warehouse inventory, and branch distribution</p>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="refreshAllData()">ðŸ”„ Refresh Data</button>
                        <button class="btn" id="stockHelpBtnGlobal">â“ Help</button>
                    </div>
                </div>
                
                <!-- Stock Management Tabs - Modern Comprehensive Structure -->
                <div class="tabs" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 3px solid #c41e3a; padding-bottom: 10px;">
                    <button class="tab-button active" onclick="showStockTab('overview')" id="stockTabOverview">ðŸ“Š Overview</button>
                    <button class="tab-button" onclick="showStockTab('countryImport')" id="stockTabCountryImport">ðŸ“¥ Country Import</button>
                    <button class="tab-button" onclick="showStockTab('warehouseDistribution')" id="stockTabWarehouseDistribution">ðŸ¢ Warehouse Distribution</button>
                    <button class="tab-button" onclick="showStockTab('branchDistribution')" id="stockTabBranchDistribution">ðŸ¬ Branch Distribution</button>
                    <button class="tab-button" onclick="showStockTab('transfers')" id="stockTabTransfers">ðŸ”„ Transfers</button>
                    <button class="tab-button" onclick="showStockTab('sharing')" id="stockTabSharing">ðŸ¤ Shop & Warehouse Sharing</button>
                    <button class="tab-button" onclick="showStockTab('orders')" id="stockTabOrders">ðŸ“‹ Orders (Auto & Manual)</button>
                    <button class="tab-button" onclick="showStockTab('countryInventory')" id="stockTabCountryInventory">ðŸŒ Country Inventory</button>
                    <button class="tab-button" onclick="showStockTab('realtime')" id="stockTabRealtime">âš¡ Real-time Sync</button>
                </div>
                
                <!-- Overview Tab - Stock Management Dashboard -->
                <div id="overviewTab" class="stock-tab-content" style="display: block;">
                    <!-- KPI Dashboard -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Stock Value</div>
                            <div id="overviewTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Pending Orders</div>
                            <div id="overviewPendingOrders" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Low Stock Items</div>
                            <div id="overviewLowStock" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Active Transfers</div>
                            <div id="overviewActiveTransfers" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                        </div>
                    </div>
                    
                    <!-- Stock Flow Visualization -->
                    <div class="form-section">
                        <h3>ðŸ“Š Stock Flow Overview</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                                <div style="text-align: center; flex: 1; min-width: 150px;">
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                        <strong>ðŸ“¥ Country Import</strong>
                                        <div id="overviewCountryStock" style="font-size: 1.5rem; font-weight: bold; color: #1976d2; margin-top: 5px;">0</div>
                            </div>
                            </div>
                                <div style="text-align: center; font-size: 2rem; color: #666;">â†’</div>
                                <div style="text-align: center; flex: 1; min-width: 150px;">
                                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                        <strong>ðŸ¢ Warehouses</strong>
                                        <div id="overviewWarehouseStock" style="font-size: 1.5rem; font-weight: bold; color: #f57c00; margin-top: 5px;">0</div>
                            </div>
                            </div>
                                <div style="text-align: center; font-size: 2rem; color: #666;">â†’</div>
                                <div style="text-align: center; flex: 1; min-width: 150px;">
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                        <strong>ðŸ¬ Branches</strong>
                                        <div id="overviewBranchStock" style="font-size: 1.5rem; font-weight: bold; color: #388e3c; margin-top: 5px;">0</div>
                            </div>
                            </div>
                                <div style="text-align: center; font-size: 2rem; color: #666;">â†’</div>
                                <div style="text-align: center; flex: 1; min-width: 150px;">
                                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                                        <strong>ðŸ›’ Shop/Sales</strong>
                                        <div id="overviewShopStock" style="font-size: 1.5rem; font-weight: bold; color: #c2185b; margin-top: 5px;">0</div>
                            </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="form-section">
                        <h3>âš¡ Recent Stock Movements</h3>
                        <div id="overviewRecentMovements" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading movements...</p>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="form-section">
                        <h3>ðŸš€ Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button class="btn btn-success" onclick="showStockTab('countryImport')" style="padding: 15px; font-size: 1rem;">
                                ðŸ“¥ Import Country Stock
                            </button>
                            <button class="btn btn-info" onclick="showStockTab('warehouseDistribution')" style="padding: 15px; font-size: 1rem;">
                                ðŸ¢ Distribute to Warehouse
                            </button>
                            <button class="btn btn-primary" onclick="showStockTab('branchDistribution')" style="padding: 15px; font-size: 1rem;">
                                ðŸ¬ Distribute to Branch
                            </button>
                            <button class="btn btn-warning" onclick="showStockTab('orders')" style="padding: 15px; font-size: 1rem;">
                                ðŸ“‹ View Orders
                            </button>
                            <button class="btn" onclick="showStockTab('countryInventory')" style="padding: 15px; font-size: 1rem;">
                                ðŸŒ Country Inventory
                            </button>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ§¾ Purchase Orders & Supplier Collaboration</h3>
                        <p style="margin-bottom: 20px; color: #666;">Purchase orders use the same format as stock import. They are automatically generated from stock movements across all branches.</p>
                        
                        <!-- Purchase Order Form with Table Format (identical to Stock Import) -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">ðŸ“‹ Create Purchase Order (Table Format)</h4>
                            <form id="purchaseOrderForm" onsubmit="handlePurchaseOrderSubmit(event)">
                                <div style="margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                    <div>
                                        <label>Supplier</label>
                                        <input type="text" id="poSupplier" placeholder="Supplier name" required>
                                    </div>
                                    <div>
                                        <label>PO Number</label>
                                        <input type="text" id="poNumber" placeholder="PO-2025-001" required>
                                    </div>
                                    <div>
                                        <label>Expected Arrival</label>
                                        <input type="date" id="poEta" required>
                                    </div>
                                    <div>
                                        <label>Total Cost (N$)</label>
                                        <input type="number" id="poValue" min="0" step="0.01" required>
                                    </div>
                                    <div>
                                        <label>Currency</label>
                                        <input type="text" id="poCurrency" value="NAD" required>
                                    </div>
                                    <div>
                                        <label>Status</label>
                                        <select id="poStatus" required>
                                            <option value="Open">Open</option>
                                            <option value="Acknowledged">Acknowledged</option>
                                            <option value="In Transit">In Transit</option>
                                            <option value="Delivered">Delivered</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label>Notes</label>
                                    <textarea id="poNotes" rows="2" placeholder="Incoterms, lead time commitments..." style="width: 100%; padding: 8px;"></textarea>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table id="purchaseOrderTable" style="width: 100%; border-collapse: collapse; background: white;">
                                        <thead>
                                            <tr style="background: #c41e3a; color: white;">
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cartons No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Batch No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Expiry Date</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Quantity</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total (CTNS)</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchaseOrderTableBody">
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="po-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="po-description" style="width: 100%; padding: 8px;" placeholder="Product description" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="po-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="month" class="po-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="po-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="po-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-danger" onclick="removePurchaseOrderRow(this)" style="padding: 5px 10px;">Remove</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7" style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-success" onclick="addPurchaseOrderRow()">âž• Add Row</button>
                                                    <button type="button" class="btn btn-info" onclick="autoGeneratePurchaseOrdersFromMovements()" style="margin-left: 10px;">ðŸ”„ Auto-Generate from Stock Movements</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button type="submit" class="btn btn-success" style="padding: 12px 40px; font-size: 1.1rem;">ðŸ“¥ Create Purchase Order</button>
                                    <button type="button" class="btn" onclick="clearPurchaseOrderForm()">Clear All</button>
                                </div>
                            </form>
                        </div>
                        
                        <div style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                            <div style="background: white; border-radius: 8px; border: 1px solid #e1e5ec; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">Open Orders</h4>
                                    <div style="display:flex; gap:8px;">
                                        <button class="btn btn-info" onclick="renderPurchaseOrders()">ðŸ”„ Refresh</button>
                                        <button class="btn" onclick="exportPurchaseOrders()">ðŸ“¥ Export</button>
                                    </div>
                                </div>
                                <div id="purchaseOrderList" style="max-height: 360px; overflow-y: auto; display: grid; gap: 12px;"></div>
                            </div>
                            <div style="background: white; border-radius: 8px; border: 1px solid #e1e5ec; padding: 15px;">
                                <h4 style="margin-top: 0;">Strategic Procurement Signals</h4>
                                <ul id="planInsights" style="margin: 0; padding-left: 18px; color: #555; line-height: 1.6;"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ¤ Supplier Scorecards</h3>
                        <p style="margin-bottom: 10px; color: #666;">Automatically updated from purchase orders, ASNs, and quality checks to highlight supplier reliability.</p>
                        <div id="supplierScorecard" style="overflow-x: auto;"></div>
                    </div>
                </div>

                <!-- Stock Help Modal -->
                <div id="stockHelpModal" style="position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:5000;">
                    <div style="width:min(960px,94vw); max-height:84vh; overflow:auto; background:#fff; color:#111; border:1px solid #ccc; border-radius:10px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;">
                            <div id="stockHelpTitle" style="font-weight:700;">Stock Workflows</div>
                            <button id="stockHelpClose" class="btn">Close</button>
                        </div>
                        <div id="stockHelpBody" style="padding:14px 16px; font-size:14px; line-height:1.55;"></div>
                    </div>
                </div>
                
                <!-- Country Import Tab -->
                <div id="countryImportTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ“¥ Country Stock Import & Quality Assurance</h3>
                        <p style="margin-bottom: 15px; color: #666;">Import stock into country inventory with batch tracking, quality checks, and FEFO enforcement</p>
                        
                        <!-- ASN & Quality Section -->
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div>
                                <h4 style="margin-bottom:8px;">ðŸšš Supplier ASNs</h4>
                                <div id="asnList" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">No ASNs pending</p>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:8px;">ðŸ§ª Quality & Disposition</h4>
                                <div id="qualityList" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
                                    <p style="color: #7f8c8d; text-align: center; font-size: 0.9rem;">Recent quality inspections</p>
                                </div>
                                <form onsubmit="handleQualitySubmit(event)" style="background:#f8f9fa; border:1px solid #e1e5ec; border-radius:8px; padding:10px;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Batch</label>
                                            <input type="text" id="qcBatch" required placeholder="Batch No.">
                                        </div>
                                        <div class="form-group">
                                            <label>ASN Ref</label>
                                            <input type="text" id="qcAsn" placeholder="ASN Reference">
                                        </div>
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" id="qcDate">
                                        </div>
                                        <div class="form-group">
                                            <label>Temp Zone</label>
                                            <select id="qcTemperature">
                                                <option value="ambient">Ambient</option>
                                                <option value="cold">Cold-chain</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Visual</label>
                                            <select id="qcVisual">
                                                <option>Pass</option>
                                                <option>Fail</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Docs</label>
                                            <select id="qcDocs">
                                                <option>Complete</option>
                                                <option>Missing</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Disposition</label>
                                            <select id="qcDisposition">
                                                <option value="Released">Released</option>
                                                <option value="Quarantine">Quarantine</option>
                                                <option value="Reject">Reject</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Hold Until</label>
                                            <input type="date" id="qcHold">
                                        </div>
                                        <div class="form-group" style="grid-column:1 / -1;">
                                            <label>Notes</label>
                                            <textarea id="qcNotes" rows="2" placeholder="Inspection notes..."></textarea>
                                        </div>
                                    </div>
                                    <div style="text-align:right; margin-top:8px;">
                                        <button class="btn btn-success" type="submit">Save Inspection</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“¥ Receive Country Stock</h3>
                        <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ“‹ Import Workflow</h4>
                            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                                <strong>All imported stock is automatically:</strong><br>
                                â€¢ Allocated with unique barcodes for tracking<br>
                                â€¢ Enforced with FEFO (First Expired First Out) - batches sorted by expiry date<br>
                                â€¢ Stored in Country Stock (location: 'country_stock') for distribution to warehouses<br>
                                â€¢ Tracked for full audit trail from import to sale
                            </p>
                        </div>
                        <p style="margin-bottom: 20px; color: #666;">Import stock with batch tracking and FIFO/FEFO enforcement</p>
                        
                        <!-- Bulk Import Form -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">ðŸ“‹ Import Stock (Table Format)</h4>
                            <form id="bulkStockImportForm">
                                <div style="overflow-x: auto;">
                                    <table id="stockImportTable" style="width: 100%; border-collapse: collapse; background: white;">
                                        <thead>
                                            <tr style="background: #c41e3a; color: white;">
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cartons No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Batch No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Expiry Date</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Quantity</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total (CTNS)</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stockImportTableBody">
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-description" style="width: 100%; padding: 8px;" placeholder="Product description" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7" style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-success" onclick="addStockImportRow()">âž• Add Row</button>
                                                    <button type="button" class="btn btn-info" onclick="importFromCSV()" style="margin-left: 10px;">ðŸ“ Import from CSV</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button type="submit" class="btn btn-success" style="padding: 12px 40px; font-size: 1.1rem;">ðŸ“¥ Import Stock</button>
                                    <button type="button" class="btn" onclick="clearStockImportForm()">Clear All</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“Š Country Stock Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="countryStockSearch" placeholder="Search products..." onkeyup="searchCountryStock()">
                            <button class="btn btn-success" onclick="displayCountryStock()">ðŸ”„ Refresh</button>
                            <button class="btn" onclick="exportCountryStock()">ðŸ“¥ Export CSV</button>
                        </div>
                        <div id="countryStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading country stock...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Legacy Country Stock Tab (Hidden) -->
                <div id="countryStockTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸšš Inbound ASNs & ðŸ§ª Quality</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                            <div>
                                <h4 style="margin-bottom:8px;">Supplier ASNs</h4>
                                <div id="asnList"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:8px;">Quality & Disposition</h4>
                                <div id="qualityList"></div>
                                <form onsubmit="handleQualitySubmit(event)" style="margin-top:12px; background:#f8f9fa; border:1px solid #e1e5ec; border-radius:8px; padding:10px;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Batch</label>
                                            <input type="text" id="qcBatch" required placeholder="Batch No.">
                                        </div>
                                        <div class="form-group">
                                            <label>ASN Ref</label>
                                            <input type="text" id="qcAsn" placeholder="ASN Reference">
                                        </div>
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" id="qcDate">
                                        </div>
                                        <div class="form-group">
                                            <label>Temp Zone</label>
                                            <select id="qcTemperature">
                                                <option value="ambient">Ambient</option>
                                                <option value="cold">Cold-chain</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Visual</label>
                                            <select id="qcVisual">
                                                <option>Pass</option>
                                                <option>Fail</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Docs</label>
                                            <select id="qcDocs">
                                                <option>Complete</option>
                                                <option>Missing</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Disposition</label>
                                            <select id="qcDisposition">
                                                <option value="Released">Released</option>
                                                <option value="Quarantine">Quarantine</option>
                                                <option value="Reject">Reject</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Hold Until</label>
                                            <input type="date" id="qcHold">
                                        </div>
                                        <div class="form-group" style="grid-column:1 / -1;">
                                            <label>Notes</label>
                                            <textarea id="qcNotes" rows="2" placeholder="Inspection notes..."></textarea>
                                        </div>
                                    </div>
                                    <div style="text-align:right; margin-top:8px;">
                                        <button class="btn btn-success" type="submit">Save Inspection</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ“¥ Receive Country Stock <button class="btn" data-stock-help="country" style="margin-left:8px;">Help</button></h3>
                        <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ“‹ Import Workflow</h4>
                            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                                <strong>All imported stock is automatically:</strong><br>
                                â€¢ Allocated with unique barcodes for tracking<br>
                                â€¢ Enforced with FEFO (First Expired First Out) - batches sorted by expiry date<br>
                                â€¢ Stored in Country Stock for distribution to warehouses<br>
                                â€¢ Tracked for full audit trail from import to sale
                            </p>
                        </div>
                        <p style="margin-bottom: 20px; color: #666;">Import stock with batch tracking and FIFO/FEFO enforcement</p>
                        
                        <!-- Bulk Import Form -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">ðŸ“‹ Import Stock (Table Format)</h4>
                            <form id="bulkStockImportForm">
                                <div style="overflow-x: auto;">
                                    <table id="stockImportTable" style="width: 100%; border-collapse: collapse; background: white;">
                                        <thead>
                                            <tr style="background: #c41e3a; color: white;">
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cartons No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Batch No.</th>
                                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Expiry Date</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Quantity</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total (CTNS)</th>
                                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stockImportTableBody">
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-description" style="width: 100%; padding: 8px;" placeholder="Product description" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1" required>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7" style="padding: 10px; border: 1px solid #ddd;">
                                                    <button type="button" class="btn btn-success" onclick="addStockImportRow()">âž• Add Row</button>
                                                    <button type="button" class="btn btn-info" onclick="importFromCSV()" style="margin-left: 10px;">ðŸ“ Import from CSV</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button type="submit" class="btn btn-success" style="padding: 12px 40px; font-size: 1.1rem;">ðŸ“¥ Import Stock</button>
                                    <button type="button" class="btn" onclick="clearStockImportForm()">Clear All</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“Š Country Stock Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="countryStockSearch" placeholder="Search products..." onkeyup="searchCountryStock()">
                            <button class="btn btn-success" onclick="displayCountryStock()">Refresh</button>
                        </div>
                        <div id="countryStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Windhoek Warehouse Tab -->
                <div id="windhoekTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">ðŸ“‹ Workflow Information</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock â†’ Windhoek Warehouse â†’ Branches<br>
                            Stock can only be transferred from Country Stock to this warehouse. From here, stock is distributed to branches.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ¢ Windhoek Warehouse - Transfer Stock from Country Stock</h3>
                        <form id="transferToWindhoekForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source</label>
                                    <select id="windhoekSource" required onchange="loadWindhoekProducts()">
                                        <option value="country">Country Stock</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Stock must come from Country Stock</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="windhoekProduct" required onchange="updateWindhoekAvailableQuantity()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="windhoekAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;" placeholder="Select product to view available quantity">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="windhoekQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="windhoekNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸ“¤ Transfer to Windhoek</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“¦ Windhoek Warehouse Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="windhoekSearch" placeholder="Search products..." onkeyup="searchWindhoekStock()">
                            <button class="btn btn-success" onclick="displayWindhoekStock()">Refresh</button>
                            <button class="btn btn-warning" onclick="showLowStockWindhoek()">âš ï¸ Low Stock Alert</button>
                        </div>
                        <div id="windhoekStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Ondangwa Warehouse Tab -->
                <div id="ondangwaTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ“‹ Workflow Information</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock â†’ Ondangwa Warehouse â†’ Branches<br>
                            Stock can only be transferred from Country Stock to this warehouse. From here, stock is distributed to branches.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>ðŸ¢ Ondangwa Warehouse - Transfer Stock from Country Stock</h3>
                        <form id="transferToOndangwaForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source</label>
                                    <select id="ondangwaSource" required onchange="loadOndangwaProducts()">
                                        <option value="country">Country Stock</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Stock must come from Country Stock</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="ondangwaProduct" required onchange="updateOndangwaAvailableQuantity()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="ondangwaAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;" placeholder="Select product to view available quantity">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="ondangwaQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="ondangwaNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸ“¤ Transfer to Ondangwa</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“¦ Ondangwa Warehouse Inventory</h3>
                        <div class="search-box">
                            <input type="text" id="ondangwaSearch" placeholder="Search products..." onkeyup="searchOndangwaStock()">
                            <button class="btn btn-success" onclick="displayOndangwaStock()">Refresh</button>
                            <button class="btn btn-warning" onclick="showLowStockOndangwa()">âš ï¸ Low Stock Alert</button>
                        </div>
                        <div id="ondangwaStockList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Distribution Tab -->
                <div id="distributionTab" class="stock-tab-content" style="display: none;">
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">ðŸ“‹ Distribution Workflow</h4>
                        <p style="margin: 0; color: #424242; font-size: 0.95rem;">
                            <strong>Stock Flow:</strong> Country Stock â†’ Warehouses (Windhoek/Ondangwa) â†’ Branches<br>
                            Branches can only receive stock from warehouses, not directly from Country Stock.
                        </p>
                    </div>
                    <div class="form-section">
                        <h3>ðŸšš Distribute Stock to Branches from Warehouses</h3>
                        <form id="distributeStockForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">From Warehouse</label>
                                    <select id="distributionWarehouse" required onchange="loadDistributionProducts()">
                                        <option value="">Select Warehouse</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.85rem;">Only warehouses can distribute to branches</small>
                                </div>
                                <div class="form-group">
                                    <label class="required">To Branch</label>
                                    <select id="distributionBranch" required>
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="distributionProduct" required>
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="distributionQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="distributionDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Expiry Date</label>
                                    <input type="month" id="distributionExpiryDate" required placeholder="YYYY-MM" title="Enter the expiry date for this stock batch">
                                </div>
                                <div class="form-group">
                                    <label class="required">Dispatch Number</label>
                                    <input type="text" id="distributionDispatchNumber" required placeholder="e.g., DISP-2024-001" title="Enter the dispatch/reference number for this distribution">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="distributionNotes" rows="2" placeholder="Distribution notes..."></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸšš Distribute to Branch</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“‹ Distribution History</h3>
                        <div class="search-box">
                            <input type="text" id="distributionSearch" placeholder="Search distributions..." onkeyup="searchDistribution()">
                            <button class="btn btn-success" onclick="displayDistributionHistory()">Refresh</button>
                        </div>
                        <div id="distributionHistoryList" style="max-height: 500px; overflow-y: auto; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Inventory Management Tab -->
                <div id="inventoryTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ“Š Inventory Management - All Stock Movements</h3>
                        <p style="margin-bottom: 20px; color: #666;">Track all stock movements across country, warehouses, and branches</p>
                        
                        <!-- Filters -->
                        <div class="form-grid" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Location</label>
                                <select id="inventoryLocationFilter" onchange="filterInventoryMovements()">
                                    <option value="all">All Locations</option>
                                    <option value="country">Country Stock</option>
                                    <option value="windhoek">Windhoek Warehouse</option>
                                    <option value="ondangwa">Ondangwa Warehouse</option>
                                    <option value="barcode">Barcode Stock</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Movement Type</label>
                                <select id="inventoryMovementFilter" onchange="filterInventoryMovements()">
                                    <option value="all">All Movements</option>
                                    <option value="import">Import</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="distribution">Distribution</option>
                                    <option value="adjustment">Adjustment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Search Product</label>
                                <input type="text" id="inventoryProductSearch" placeholder="Search by product name..." onkeyup="filterInventoryMovements()">
                            </div>
                            <div class="form-group">
                                <label>Date Range</label>
                                <input type="date" id="inventoryDateFrom" onchange="filterInventoryMovements()">
                                <input type="date" id="inventoryDateTo" onchange="filterInventoryMovements()">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-success" onclick="displayInventoryMovements()">ðŸ”„ Refresh</button>
                            <button class="btn btn-primary" onclick="exportInventoryMovements()">ðŸ“¥ Export</button>
                            <button class="btn btn-warning" onclick="printInventoryReport()">ðŸ–¨ï¸ Print Report</button>
                        </div>
                        
                        <div id="inventoryMovementsList" style="max-height: 600px; overflow-y: auto;">
                            <p style="text-align: center; padding: 20px; color: #666;">Loading inventory movements...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Warehouse Distribution Tab -->
                <div id="warehouseDistributionTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ¢ Warehouse Distribution - Country Stock to Warehouses</h3>
                        <p style="margin-bottom: 15px; color: #666;">Distribute stock from Country Stock to Windhoek and Ondangwa warehouses</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <!-- Windhoek Warehouse -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #2196f3; margin-bottom: 15px;">ðŸ¢ Windhoek Warehouse</h4>
                                <form id="transferToWindhoekForm" onsubmit="handleTransferToWindhoek(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Product</label>
                                            <select id="windhoekProduct" required onchange="updateWindhoekAvailableQuantity()">
                                                <option value="">Select Product</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Available in Country</label>
                                            <input type="text" id="windhoekAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">Quantity</label>
                                            <input type="number" id="windhoekQuantity" min="1" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Notes</label>
                                            <textarea id="windhoekNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">ðŸ“¤ Transfer to Windhoek</button>
                                </form>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="displayWindhoekStock()">ðŸ”„ View Windhoek Inventory</button>
                                </div>
                            </div>
                            
                            <!-- Ondangwa Warehouse -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #ff9800; margin-bottom: 15px;">ðŸ¢ Ondangwa Warehouse</h4>
                                <form id="transferToOndangwaFormNew" onsubmit="handleTransferToOndangwa(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required">Product</label>
                                            <select id="ondangwaProductNew" required onchange="updateOndangwaAvailableQuantity()">
                                                <option value="">Select Product</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Available in Country</label>
                                            <input type="text" id="ondangwaAvailableQtyNew" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">Quantity</label>
                                            <input type="number" id="ondangwaQuantityNew" min="1" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Notes</label>
                                            <textarea id="ondangwaNotesNew" rows="2" placeholder="Transfer notes..."></textarea>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">ðŸ“¤ Transfer to Ondangwa</button>
                                </form>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="displayOndangwaStock()">ðŸ”„ View Ondangwa Inventory</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“¦ Warehouse Inventory Summary</h3>
                        <div id="warehouseInventorySummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <div id="windhoekInventorySummary" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4>Windhoek Warehouse</h4>
                                <p style="color: #7f8c8d;">Loading...</p>
                            </div>
                            <div id="ondangwaInventorySummary" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4>Ondangwa Warehouse</h4>
                                <p style="color: #7f8c8d;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Branch Distribution Tab -->
                <div id="branchDistributionTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ¬ Branch Distribution - Warehouse to Branches</h3>
                        <p style="margin-bottom: 15px; color: #666;">Distribute stock from warehouses to branches based on requests and replenishment needs</p>
                        
                        <form id="branchDistributionForm" onsubmit="handleBranchDistribution(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Source Warehouse</label>
                                    <select id="branchDistSourceWarehouse" required>
                                        <option value="">Select Warehouse</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Destination Branch</label>
                                    <select id="branchDistDestination" required>
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="branchDistProduct" required onchange="updateBranchDistAvailableQty()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available in Warehouse</label>
                                    <input type="text" id="branchDistAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="branchDistQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select id="branchDistPriority">
                                        <option value="normal">Normal</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>Notes</label>
                                    <textarea id="branchDistNotes" rows="2" placeholder="Distribution notes..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">ðŸ“¤ Distribute to Branch</button>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“‹ Pending Branch Requests</h3>
                        <div id="pendingBranchRequests" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading requests...</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“Š Distribution History</h3>
                        <div id="branchDistributionHistory" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading history...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Transfers Tab -->
                <div id="transfersTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ”„ Stock Transfers - Inter-Location Transfers</h3>
                        <p style="margin-bottom: 15px; color: #666;">Manage transfers between branches, warehouses, and other locations</p>
                        
                        <form id="stockTransferForm" onsubmit="handleStockTransfer(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">From Location</label>
                                    <select id="transferFromLocation" required onchange="loadTransferFromProducts()">
                                        <option value="">Select Source</option>
                                        <option value="country">Country Stock</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">To Location</label>
                                    <select id="transferToLocation" required>
                                        <option value="">Select Destination</option>
                                        <option value="windhoek">Windhoek Warehouse</option>
                                        <option value="ondangwa">Ondangwa Warehouse</option>
                                        <option value="branch">Branch (select below)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="transferBranchSelect" style="display: none;">
                                    <label>Select Branch</label>
                                    <select id="transferBranch">
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Product</label>
                                    <select id="transferProduct" required onchange="updateTransferAvailableQty()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Available Quantity</label>
                                    <input type="text" id="transferAvailableQty" readonly style="background-color: #f5f5f5; font-weight: bold; color: #27ae60;">
                                </div>
                                <div class="form-group">
                                    <label class="required">Quantity</label>
                                    <input type="number" id="transferQuantity" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Reason</label>
                                    <select id="transferReason">
                                        <option value="replenishment">Replenishment</option>
                                        <option value="adjustment">Stock Adjustment</option>
                                        <option value="emergency">Emergency</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>Notes</label>
                                    <textarea id="transferNotes" rows="2" placeholder="Transfer notes..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">ðŸ”„ Create Transfer</button>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>ðŸ“‹ Active Transfers</h3>
                        <div class="search-box" style="margin-bottom: 15px;">
                            <select id="transferStatusFilter" onchange="loadStockTransfers()">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_transit">In Transit</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-info" onclick="loadStockTransfers()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="activeTransfersList" style="max-height: 500px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <p style="text-align: center; color: #7f8c8d;">Loading transfers...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Shop & Warehouse Sharing Tab -->
                <div id="sharingTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ¤ Shop & Warehouse Sharing</h3>
                        <p style="margin-bottom: 15px; color: #666;">Enable sharing of stock visibility and cross-location access between shops and warehouses</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border: 1px solid #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">ðŸ¬ Shop Visibility</h4>
                                <p style="margin-bottom: 15px; color: #666;">Configure which shops can view warehouse inventory</p>
                                <div id="shopVisibilityList" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading shop visibility settings...</p>
                                </div>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">ðŸ¢ Warehouse Sharing</h4>
                                <p style="margin-bottom: 15px; color: #666;">Configure cross-warehouse stock visibility and sharing</p>
                                <div id="warehouseSharingList" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading warehouse sharing settings...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>âž• Add Sharing Rule</h4>
                            <form id="sharingRuleForm" onsubmit="handleSharingRule(event)" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="required">From Location</label>
                                        <select id="sharingFrom" required>
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">To Location</label>
                                        <select id="sharingTo" required>
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Access Level</label>
                                        <select id="sharingAccessLevel" required>
                                            <option value="view">View Only</option>
                                            <option value="request">Can Request</option>
                                            <option value="transfer">Can Transfer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Status</label>
                                        <select id="sharingStatus">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">âž• Add Sharing Rule</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Tab (Auto & Manual) -->
                <div id="ordersTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸ“‹ Orders - Automatic & Manual</h3>
                        <p style="margin-bottom: 15px; color: #666;">Manage automatic reorder triggers and manual purchase orders</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">ðŸ¤– Automatic Orders</h4>
                                <p style="margin-bottom: 15px; color: #666;">Orders triggered by reorder points and low stock alerts</p>
                                <div id="automaticOrdersList" style="max-height: 400px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading automatic orders...</p>
                                </div>
                                <button class="btn btn-info" onclick="refreshAutomaticOrders()" style="width: 100%; margin-top: 15px;">ðŸ”„ Refresh</button>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">âœ‹ Manual Orders</h4>
                                <p style="margin-bottom: 15px; color: #666;">Manually created purchase orders and special requests</p>
                                <div id="manualOrdersList" style="max-height: 400px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading manual orders...</p>
                                </div>
                                <button class="btn btn-success" onclick="showCreateManualOrder()" style="width: 100%; margin-top: 15px;">âž• Create Manual Order</button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>âš™ï¸ Automatic Order Settings</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Enable Auto-Orders</label>
                                        <input type="checkbox" id="autoOrdersEnabled" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Reorder Point Threshold (%)</label>
                                        <input type="number" id="reorderThreshold" value="20" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label>Auto-Order Frequency</label>
                                        <select id="autoOrderFrequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Require Approval</label>
                                        <input type="checkbox" id="requireOrderApproval">
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="saveAutoOrderSettings()">ðŸ’¾ Save Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Country Inventory Tab -->
                <div id="countryInventoryTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>ðŸŒ Country-Wide Inventory Dashboard</h3>
                        <p style="margin-bottom: 15px; color: #666;">Comprehensive view of all inventory across country stock, warehouses, and branches</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Country Stock Value</div>
                                <div id="countryTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Warehouse Stock</div>
                                <div id="warehouseTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Branch Stock</div>
                                <div id="branchTotalValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Products</div>
                                <div id="countryTotalProducts" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>ðŸ“Š Inventory by Location</h4>
                            <div class="search-box" style="margin-bottom: 15px;">
                                <select id="countryInvLocationFilter" onchange="displayCountryStockInventory()">
                                    <option value="all">All Locations</option>
                                    <option value="country">Country Stock</option>
                                    <option value="windhoek">Windhoek Warehouse</option>
                                    <option value="ondangwa">Ondangwa Warehouse</option>
                                    <option value="branches">All Branches</option>
                                </select>
                                <select id="countryInvProductFilter" onchange="displayCountryStockInventory()">
                                    <option value="all">All Products</option>
                                </select>
                                <button class="btn btn-success" onclick="displayCountryStockInventory()">ðŸ”„ Refresh</button>
                                <button class="btn btn-primary" onclick="exportCountryInventory()">ðŸ“¥ Export Report</button>
                            </div>
                            <div id="countryInventoryTable" style="max-height: 600px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <p style="text-align: center; color: #7f8c8d;">Loading inventory...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Sync Tab -->
                <div id="realtimeTab" class="stock-tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>âš¡ Real-time Information Sharing</h3>
                        <p style="margin-bottom: 15px; color: #666;">Monitor real-time synchronization between stock, branch, and other portals</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">ðŸ”„ Sync Status</h4>
                                <div id="syncStatusCards" style="display: grid; gap: 10px;">
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Stock Portal</span>
                                            <span id="syncStockPortal" class="pill good">ðŸŸ¢ Connected</span>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Branch Portal</span>
                                            <span id="syncBranchPortal" class="pill good">ðŸŸ¢ Connected</span>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>GM Portal</span>
                                            <span id="syncGMPortal" class="pill good">ðŸŸ¢ Connected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ff9800;">
                                <h4 style="color: #f57c00; margin-bottom: 15px;">ðŸ“¡ Recent Sync Events</h4>
                                <div id="realtimeSyncEvents" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: #7f8c8d; text-align: center;">Loading sync events...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>âš™ï¸ Sync Configuration</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Sync Frequency</label>
                                        <select id="syncFrequency">
                                            <option value="realtime" selected>Real-time</option>
                                            <option value="1min">Every 1 minute</option>
                                            <option value="5min">Every 5 minutes</option>
                                            <option value="15min">Every 15 minutes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Auto-Sync Enabled</label>
                                        <input type="checkbox" id="autoSyncEnabled" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Sync Stock Changes</label>
                                        <input type="checkbox" id="syncStockChanges" checked>
                                    </div>
                                    <div class="form-group">
                                        <label>Sync Order Changes</label>
                                        <input type="checkbox" id="syncOrderChanges" checked>
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="saveSyncSettings()">ðŸ’¾ Save Settings</button>
                                <button class="btn btn-info" onclick="testSyncConnection()" style="margin-left: 10px;">ðŸ” Test Connection</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HR Portal -->
        <div id="hr-portal" class="tab-content">
            <h2>ðŸ‘¥ HR Portal</h2>
            
            <!-- HR Sub-tabs -->
            <div class="hr-subtabs">
                <button class="hr-tab-btn active" onclick="showHRSubTab('employee-management')">ðŸ‘¤ Employee Management</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('leave-management')">ðŸ“… Leave Management</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('warnings')">âš ï¸ Warnings & Disciplinary</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('terminations')">ðŸšª Terminations</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('attendance')">ðŸ• Attendance</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('performance')">ðŸ“Š Performance Review</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('hr-communication')">ðŸ’¬ Staff Communication</button>
                <button class="hr-tab-btn" onclick="showHRSubTab('data-collection')">ðŸ“‹ Data Collection</button>
            </div>

            <!-- Employee Management Tab -->
            <div id="employee-management" class="hr-tab-content active">
                <div class="form-section">
                    <h3>ðŸ‘¤ Employee Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddEmployee()">âž• Add New Employee</button>
                        <button class="btn btn-primary" onclick="refreshEmployeeList()">ðŸ”„ Refresh List</button>
                        <button class="btn btn-warning" onclick="exportEmployeeData()">ðŸ“¥ Export Employee Data</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="employeeSearch" placeholder="Search employees by name, ID, or department..." 
                               style="flex: 1; padding: 10px;">
                    </div>
                    
                    <div id="employeeList"></div>
                </div>

                <!-- Add Employee Modal -->
                <div id="addEmployeeModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
                        <h2>âž• Add New Employee</h2>
                        <form id="addEmployeeForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee ID</label>
                                    <input type="text" id="employeeId" required placeholder="e.g., EMP001">
                                </div>
                                <div class="form-group">
                                    <label class="required">Full Name</label>
                                    <input type="text" id="employeeName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Department</label>
                                    <select id="employeeDepartment" required>
                                        <option value="">Select Department</option>
                                        <option value="Administration">Administration</option>
                                        <option value="Health Consultation">Health Consultation</option>
                                        <option value="Pharmacy">Pharmacy</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Management">Management</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Position</label>
                                    <input type="text" id="employeePosition" required placeholder="e.g., Health Consultant">
                                </div>
                                <div class="form-group">
                                    <label class="required">Email</label>
                                    <input type="email" id="employeeEmail" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Phone</label>
                                    <input type="tel" id="employeePhone" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Hire Date</label>
                                    <input type="date" id="employeeHireDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Employment Type</label>
                                    <select id="employmentType" required>
                                        <option value="">Select Type</option>
                                        <option value="Full-time">Full-time</option>
                                        <option value="Part-time">Part-time</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Temporary">Temporary</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Salary</label>
                                    <input type="number" id="employeeSalary" placeholder="Enter salary (N$)">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="employeeAddress" placeholder="Full address">
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth</label>
                                    <input type="date" id="employeeDOB">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" id="emergencyContactName">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" id="emergencyContactPhone">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="employeeNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸ’¾ Save Employee</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addEmployeeModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div id="leave-management" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸ“… Leave Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showApplyLeave()">âž• Apply for Leave</button>
                        <button class="btn btn-primary" onclick="refreshLeaveList()">ðŸ”„ Refresh</button>
                        <button class="btn btn-info" onclick="showLeaveReports()">ðŸ“Š Leave Reports</button>
                    </div>
                    
                    <!-- Leave Balance Summary -->
                    <div id="leaveBalanceCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="leaveSearch" placeholder="Search leave requests..." style="flex: 1; padding: 10px;">
                        <select id="leaveStatusFilter" style="padding: 10px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div id="leaveList"></div>
                </div>

                <!-- Apply Leave Modal -->
                <div id="applyLeaveModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('applyLeaveModal')">&times;</span>
                        <h2>âž• Apply for Leave</h2>
                        <form id="applyLeaveForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="leaveEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Leave Type</label>
                                    <select id="leaveType" required>
                                        <option value="">Select Leave Type</option>
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Maternity">Maternity Leave</option>
                                        <option value="Paternity">Paternity Leave</option>
                                        <option value="Emergency">Emergency Leave</option>
                                        <option value="Unpaid">Unpaid Leave</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Start Date</label>
                                    <input type="date" id="leaveStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">End Date</label>
                                    <input type="date" id="leaveEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Number of Days</label>
                                    <input type="number" id="leaveDays" required readonly>
                                </div>
                                <div class="form-group">
                                    <label>Reason</label>
                                    <textarea id="leaveReason" rows="4" placeholder="Reason for leave..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸ“¤ Submit Leave Request</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('applyLeaveModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Warnings & Disciplinary Tab -->
            <div id="warnings" class="hr-tab-content">
                <div class="form-section">
                    <h3>âš ï¸ Warnings & Disciplinary Actions</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="showIssueWarning()">âš ï¸ Issue Warning</button>
                        <button class="btn btn-primary" onclick="refreshWarningList()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="warningSearch" placeholder="Search warnings..." style="flex: 1; padding: 10px;">
                        <select id="warningTypeFilter" style="padding: 10px;">
                            <option value="all">All Types</option>
                            <option value="Verbal">Verbal Warning</option>
                            <option value="Written">Written Warning</option>
                            <option value="Final">Final Warning</option>
                        </select>
                    </div>
                    
                    <div id="warningList"></div>
                </div>

                <!-- Issue Warning Modal -->
                <div id="issueWarningModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('issueWarningModal')">&times;</span>
                        <h2>âš ï¸ Issue Warning</h2>
                        <form id="issueWarningForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="warningEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Warning Type</label>
                                    <select id="warningType" required>
                                        <option value="">Select Type</option>
                                        <option value="Verbal">Verbal Warning</option>
                                        <option value="Written">Written Warning</option>
                                        <option value="Final">Final Warning</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="warningDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Issued By</label>
                                    <input type="text" id="warningIssuedBy" required placeholder="Supervisor/Manager name">
                                </div>
                                <div class="form-group full-width">
                                    <label class="required">Reason</label>
                                    <textarea id="warningReason" rows="5" required placeholder="Detailed reason for the warning..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="warningNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-warning">âš ï¸ Issue Warning</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('issueWarningModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Terminations Tab -->
            <div id="terminations" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸšª Termination Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-danger" onclick="showTerminateEmployee()">ðŸšª Record Termination</button>
                        <button class="btn btn-primary" onclick="refreshTerminationList()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="terminationSearch" placeholder="Search terminations..." style="flex: 1; padding: 10px;">
                        <select id="terminationReasonFilter" style="padding: 10px;">
                            <option value="all">All Reasons</option>
                            <option value="Resignation">Resignation</option>
                            <option value="Dismissal">Dismissal</option>
                            <option value="Retirement">Retirement</option>
                            <option value="Contract End">Contract End</option>
                            <option value="Mutual Agreement">Mutual Agreement</option>
                        </select>
                    </div>
                    
                    <div id="terminationList"></div>
                </div>

                <!-- Record Termination Modal -->
                <div id="terminateEmployeeModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('terminateEmployeeModal')">&times;</span>
                        <h2>ðŸšª Record Termination</h2>
                        <form id="terminateEmployeeForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="terminationEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Termination Date</label>
                                    <input type="date" id="terminationDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Termination Type</label>
                                    <select id="terminationType" required>
                                        <option value="">Select Type</option>
                                        <option value="Resignation">Resignation</option>
                                        <option value="Dismissal">Dismissal</option>
                                        <option value="Retirement">Retirement</option>
                                        <option value="Contract End">Contract End</option>
                                        <option value="Mutual Agreement">Mutual Agreement</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Reason</label>
                                    <textarea id="terminationReason" rows="5" required placeholder="Reason for termination..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Notice Period (Days)</label>
                                    <input type="number" id="noticePeriod" placeholder="Number of days">
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="terminationNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-danger">ðŸšª Record Termination</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('terminateEmployeeModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸ• Attendance Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showRecordAttendance()">âœ… Record Attendance</button>
                        <button class="btn btn-primary" onclick="refreshAttendanceList()">ðŸ”„ Refresh</button>
                        <button class="btn btn-info" onclick="generateAttendanceReport()">ðŸ“Š Generate Report</button>
                    </div>
                    
                    <div id="attendanceSummaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="attendanceSearch" placeholder="Search attendance records..." style="flex: 1; padding: 10px;">
                        <input type="date" id="attendanceDateFilter" style="padding: 10px;">
                        <select id="attendanceStatusFilter" style="padding: 10px;">
                            <option value="all">All Status</option>
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Half Day">Half Day</option>
                        </select>
                    </div>
                    
                    <div id="attendanceList"></div>
                </div>

                <!-- Record Attendance Modal -->
                <div id="recordAttendanceModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('recordAttendanceModal')">&times;</span>
                        <h2>âœ… Record Attendance</h2>
                        <form id="recordAttendanceForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="attendanceEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date</label>
                                    <input type="date" id="attendanceDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Status</label>
                                    <select id="attendanceStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="Present">Present</option>
                                        <option value="Absent">Absent</option>
                                        <option value="Late">Late</option>
                                        <option value="Half Day">Half Day</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Check In Time</label>
                                    <input type="time" id="checkInTime">
                                </div>
                                <div class="form-group">
                                    <label>Check Out Time</label>
                                    <input type="time" id="checkOutTime">
                                </div>
                                <div class="form-group full-width">
                                    <label>Notes</label>
                                    <textarea id="attendanceNotes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">âœ… Record Attendance</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('recordAttendanceModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Performance Review Tab -->
            <div id="performance" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸ“Š Performance Review</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddPerformanceReview()">âž• Add Performance Review</button>
                        <button class="btn btn-primary" onclick="refreshPerformanceList()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <div class="search-box" style="margin-bottom: 20px;">
                        <input type="text" id="performanceSearch" placeholder="Search performance reviews..." style="flex: 1; padding: 10px;">
                    </div>
                    
                    <div id="performanceList"></div>
                </div>

                <!-- Add Performance Review Modal -->
                <div id="addPerformanceReviewModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('addPerformanceReviewModal')">&times;</span>
                        <h2>ðŸ“Š Add Performance Review</h2>
                        <form id="addPerformanceReviewForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee</label>
                                    <select id="performanceEmployeeSelect" required>
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Review Period Start</label>
                                    <input type="date" id="reviewStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Review Period End</label>
                                    <input type="date" id="reviewEndDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Reviewed By</label>
                                    <input type="text" id="reviewedBy" required placeholder="Reviewer name">
                                </div>
                                <div class="form-group full-width">
                                    <label class="required">Overall Rating</label>
                                    <select id="overallRating" required>
                                        <option value="">Select Rating</option>
                                        <option value="Excellent">Excellent</option>
                                        <option value="Good">Good</option>
                                        <option value="Average">Average</option>
                                        <option value="Below Average">Below Average</option>
                                        <option value="Unsatisfactory">Unsatisfactory</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label>Strengths</label>
                                    <textarea id="strengths" rows="4" placeholder="Employee strengths..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Areas for Improvement</label>
                                    <textarea id="improvements" rows="4" placeholder="Areas for improvement..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Goals for Next Period</label>
                                    <textarea id="goals" rows="4" placeholder="Goals for next review period..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Comments</label>
                                    <textarea id="reviewComments" rows="4" placeholder="Additional comments..."></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">ðŸ’¾ Save Review</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addPerformanceReviewModal')">âŒ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="hr-communication" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Send HR updates to branch staff and review their replies.</p>
                    <div id="portalCommunicationList-hr" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'hr')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-hr">Message</label>
                            <textarea id="portalCommunicationMessage-hr" rows="4" placeholder="Share policy changes, approvals or notices..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('hr')">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Data Collection Tab -->
            <div id="data-collection" class="hr-tab-content">
                <div class="form-section">
                    <h3>ðŸ“‹ Staff Data Collection Form</h3>
                    <form id="dataCollectionForm" onsubmit="submitDataCollection(event)">
                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Personal Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Full Name</label>
                                    <input type="text" id="dcFullName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">ID / Passport No.</label>
                                    <input type="text" id="dcIdNumber" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Date of Birth</label>
                                    <input type="date" id="dcDob" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Nationality</label>
                                    <input type="text" id="dcNationality" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Gender</label>
                                    <select id="dcGender" required>
                                        <option value="">Select</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Marital Status</label>
                                    <select id="dcMaritalStatus" required>
                                        <option value="">Select</option>
                                        <option>Single</option>
                                        <option>Married</option>
                                        <option>Divorced</option>
                                        <option>Widowed</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Contact & Address Details</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Mobile Number</label>
                                    <input type="tel" id="dcMobile" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Email Address</label>
                                    <input type="email" id="dcEmail" required>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Residential Address</label>
                                    <textarea id="dcResAddress" rows="3" required></textarea>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Postal Address</label>
                                    <textarea id="dcPostAddress" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Educational Background</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Highest Level of Education</label>
                                    <input type="text" id="dcEducation" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Institution Attended</label>
                                    <input type="text" id="dcInstitution" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Year Completed</label>
                                    <input type="number" id="dcYearCompleted" min="1950" max="2050" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Employment Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Branch / DPC Name</label>
                                    <select id="dcBranch" required>
                                        <option value="">Select</option>
                                        <option>townshop</option>
                                        <option>khomasdal</option>
                                        <option>swakopmund</option>
                                        <option>walvisbay</option>
                                        <option>katima</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="required">Employment Start Date</label>
                                    <input type="date" id="dcStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Social Security No.</label>
                                    <input type="text" id="dcSocialSecurity" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Position Appointed</label>
                                    <input type="text" id="dcPosition" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Banking Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Bank Name</label>
                                    <input type="text" id="dcBankName" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Account Number</label>
                                    <input type="text" id="dcAccountNumber" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Branch Code</label>
                                    <input type="text" id="dcBranchCode" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Emergency Contact Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Next of Kin Name</label>
                                    <input type="text" id="dcNextOfKin" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Relationship</label>
                                    <input type="text" id="dcRelationship" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Contact Number</label>
                                    <input type="tel" id="dcKinContact" required>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="required">Address</label>
                                    <textarea id="dcKinAddress" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Medical & Background Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Height (cm)</label>
                                    <input type="number" id="dcHeight" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Weight (kg)</label>
                                    <input type="number" id="dcWeight" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label>Chronic Illnesses / Conditions</label>
                                    <input type="text" id="dcChronicIllness">
                                </div>
                                <div class="form-group">
                                    <label>Disabilities (if any)</label>
                                    <input type="text" id="dcDisabilities">
                                </div>
                                <div class="form-group">
                                    <label class="required">Criminal Record</label>
                                    <div style="display:flex; gap:16px; margin-top:8px;">
                                        <label style="display:flex; align-items:center; gap:6px;">
                                            <input type="radio" name="dcCriminal" value="yes" id="dcCriminalYes"> Yes
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px;">
                                            <input type="radio" name="dcCriminal" value="no" id="dcCriminalNo" checked> No
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>If yes, please specify</label>
                                    <input type="text" id="dcCriminalSpecify">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Allergies / Other Medical Notes</label>
                                    <textarea id="dcAllergies" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h4 style="font-weight:700; color:#dc2626; font-size:14px; margin-bottom:12px; text-transform:uppercase;">Declaration & Signature</h4>
                            <div style="margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px;">
                                <p style="margin:0; line-height:1.6;">I confirm that the information provided above is true, complete, and accurate to the best of my knowledge. I authorize Dynapharm Namibia to verify all submitted information where necessary.</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Employee Signature</label>
                                    <input type="text" id="dcEmpSignature" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">HR Officer / Manager</label>
                                    <input type="text" id="dcHROfficer" required>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb; color:#64748b; font-size:12px; text-align:center;">
                            All information is confidential and handled in accordance with the Social Security Act (Act 34 of 1994).
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">Submit Data Collection</button>
                            <button type="button" class="btn" onclick="clearDataCollectionForm()">Clear Form</button>
                        </div>
                    </form>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>Submitted Forms</h3>
                    <div id="dcTable"><div style="color:#64748b;">Loading...</div></div>
                </div>
            </div>
        </div>

        <!-- GM Portal -->
        <div id="gm" class="tab-content">
            <div id="gmAuth" style="display: block;">
                <div class="portal-header">
                    <h2>ðŸ‘” GM Portal</h2>
                    <p>General Manager Dashboard - Country Overview & Approvals</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access GM portal</p>
                    <button class="btn" onclick="showLogin('gm')">ðŸ” Login</button>
                </div>
            </div>
            <div id="gmContent" style="display: none;">
                <div class="user-profile" id="gmProfile"></div>
                
                <div class="portal-header">
                    <h2>ðŸ‘” GM Portal - Country Overview</h2>
                    <p>Monitor KPIs, Approve Special Sales, Oversee Operations</p>
                    <button class="btn btn-primary" onclick="refreshGMData()">ðŸ”„ Refresh Data</button>
                    <button class="btn" onclick="exportSectionToPDF('gmContent')">ðŸ–¨ï¸ Export PDF</button>
                    <a class="btn" href="gm-portal-integration.html" target="_blank" rel="noopener" style="margin-left: 10px;">ðŸ“Š Open GM Business Portal</a>
                    <button class="btn btn-info" onclick="openAnalyticsReportingPortal()" style="margin-left: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">ðŸ“ˆ Analytics & Reporting Portal</button>
                    <button class="btn btn-success" onclick="openScheduleModal('gm')" style="margin-left: 10px;">â±ï¸ Schedule Report</button>
                </div>

                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Share announcements with branch staff and keep their responses visible to the GM office.</p>
                    <div id="portalCommunicationList-gm" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'gm')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-gm">Message</label>
                            <textarea id="portalCommunicationMessage-gm" rows="4" placeholder="Inform staff about directives, meetings or approvals..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('gm')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <!-- KPI Dashboard -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ’°</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Revenue</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmTotalRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ“¦</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">CIF Deposits</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmCIFDeposits">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">â­</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total BV Points</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmTotalBV">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ“Š</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Gross Margin</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="gmGrossMargin">N$ 0.00</div>
                    </div>
                </div>
                
                <!-- Comprehensive Approval System -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>â³ Approval Center</h3>
                        <button class="btn btn-primary" onclick="refreshAllApprovals()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <!-- Approval Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchApprovalTab('all')" id="approvalTabAll">All Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('cash')" id="approvalTabCash">ðŸ’µ Cash Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('leave')" id="approvalTabLeave">ðŸ“… Leave Requests</button>
                        <button class="tab-button" onclick="switchApprovalTab('stock')" id="approvalTabStock">ðŸ“¦ Stock Movements</button>
                        <button class="tab-button" onclick="switchApprovalTab('other')" id="approvalTabOther">Other Requests</button>
                    </div>
                    
                    <!-- Approval Content -->
                    <div id="approvalContent" style="min-height: 400px;">
                        <div id="allApprovalsList" class="approval-tab-content active"></div>
                        <div id="cashApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="leaveApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="stockApprovalsList" class="approval-tab-content" style="display: none;"></div>
                        <div id="otherApprovalsList" class="approval-tab-content" style="display: none;"></div>
                    </div>
                    
                    <script>
                        // update global alert banner with count, if available after GM load
                        (function(){
                            try {
                                const count = window.gmPendingApprovalsCount || 0;
                                if (typeof window.updateGlobalAlerts === 'function') {
                                    window.updateGlobalAlerts({ pendingApprovalsCount: count });
                                }
                            } catch(_){}
                        })();
                    </script>
                </div>
                
                <!-- Campaigns Management -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ðŸŽ¯ Campaigns Management</h3>
                        <button class="btn btn-success" onclick="showCreateCampaignModal()">âž• Create Campaign</button>
                    </div>
                    
                    <!-- Campaign Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchCampaignTab('all')" id="campaignTabAll">All Campaigns</button>
                        <button class="tab-button" onclick="switchCampaignTab('sales')" id="campaignTabSales">ðŸ’° Sales Discounts</button>
                        <button class="tab-button" onclick="switchCampaignTab('recruiting')" id="campaignTabRecruiting">ðŸ‘¥ Recruiting</button>
                        <button class="tab-button" onclick="switchCampaignTab('sponsoring')" id="campaignTabSponsoring">ðŸ¤ Sponsoring</button>
                        <button class="tab-button" onclick="switchCampaignTab('gift')" id="campaignTabGift">ðŸŽ Gift Campaigns</button>
                    </div>
                    
                    <!-- Campaign Content -->
                    <div id="campaignContent" style="min-height: 400px;">
                        <div id="allCampaignsList" class="campaign-tab-content active"></div>
                        <div id="salesCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="recruitingCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="sponsoringCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                        <div id="giftCampaignsList" class="campaign-tab-content" style="display: none;"></div>
                    </div>
                </div>

                <!-- Inventory Oversight & Management -->
                <div class="form-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ðŸ“¦ Inventory Oversight & Management</h3>
                        <button class="btn btn-primary" onclick="refreshGMInventoryData()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <!-- Inventory Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-button active" onclick="switchGMInventoryTab('overview')" id="gmInvTabOverview">ðŸ“Š Overview</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('expected')" id="gmInvTabExpected">ðŸ“¥ Expected Stock</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('losses')" id="gmInvTabLosses">âš ï¸ Stock Losses</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('manipulations')" id="gmInvTabManipulations">ðŸ” Manipulations Audit</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('approvals')" id="gmInvTabApprovals">âœ… Pending Approvals</button>
                        <button class="tab-button" onclick="switchGMInventoryTab('allbranches')" id="gmInvTabAllBranches">ðŸ¬ All Branches</button>
                    </div>
                    
                    <!-- Inventory Content -->
                    <div id="gmInventoryContent" style="min-height: 400px;">
                        <!-- Overview Tab -->
                        <div id="gmInvOverview" class="gm-inv-tab-content active">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Stock Value (All Branches)</div>
                                    <div id="gmTotalStockValue" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Pending Expected Stock Requests</div>
                                    <div id="gmPendingExpectedStock" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Stock Losses (This Month)</div>
                                    <div id="gmStockLosses" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">N$ 0.00</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Pending Adjustments</div>
                                    <div id="gmPendingAdjustments" style="font-size: 2rem; font-weight: bold; margin-top: 10px;">0</div>
                                </div>
                            </div>
                            <div id="gmInventoryOverviewTable" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="margin-top: 0;">Branch Inventory Summary</h4>
                                <div id="gmBranchInventorySummary"></div>
                            </div>
                        </div>
                        
                        <!-- Expected Stock Tab -->
                        <div id="gmInvExpected" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Expected Stock Requests Requiring Approval</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="gmExpectedBranchFilter" onchange="loadGMExpectedStock()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <select id="gmExpectedStatusFilter" onchange="loadGMExpectedStock()" style="padding: 8px;">
                                            <option value="pending">Pending Approval</option>
                                            <option value="all">All Status</option>
                                            <option value="approved">Approved</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmExpectedStockList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Stock Losses Tab -->
                        <div id="gmInvLosses" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Stock Losses & Discrepancies</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="date" id="gmLossesDateFrom" onchange="loadGMStockLosses()" style="padding: 8px;">
                                        <input type="date" id="gmLossesDateTo" onchange="loadGMStockLosses()" style="padding: 8px;">
                                        <select id="gmLossesBranchFilter" onchange="loadGMStockLosses()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmStockLossesList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Manipulations Audit Tab -->
                        <div id="gmInvManipulations" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Stock Manipulation Audit Trail</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="gmManipSearch" placeholder="Search by user, product, branch..." 
                                               onkeyup="loadGMStockManipulations()" style="padding: 8px; min-width: 250px;">
                                        <select id="gmManipBranchFilter" onchange="loadGMStockManipulations()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <select id="gmManipTypeFilter" onchange="loadGMStockManipulations()" style="padding: 8px;">
                                            <option value="all">All Types</option>
                                            <option value="adjustment">Adjustments</option>
                                            <option value="loss">Losses</option>
                                            <option value="transfer">Transfers</option>
                                            <option value="receive">Receipts</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="gmStockManipulationsList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- Pending Approvals Tab -->
                        <div id="gmInvApprovals" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">Pending Inventory Approvals</h4>
                                    <button class="btn btn-success" onclick="loadGMPendingInventoryApprovals()">ðŸ”„ Refresh</button>
                                </div>
                                <div id="gmPendingInventoryApprovalsList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- All Branches Tab -->
                        <div id="gmInvAllBranches" class="gm-inv-tab-content" style="display: none;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0;">All Branch Inventory (Full Access)</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="gmAllBranchesBranchFilter" onchange="loadGMAllBranchInventory()" style="padding: 8px;">
                                            <option value="all">All Branches</option>
                                        </select>
                                        <button class="btn btn-info" onclick="exportGMInventoryReport()">ðŸ“¥ Export Report</button>
                                    </div>
                                </div>
                                <div id="gmAllBranchInventoryList" style="max-height: 600px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Special Sales Management (Legacy) -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸŽ¯ Special Sales Campaigns (Legacy)</h3>
                    <button class="btn btn-success" onclick="showSpecialSalesModal()">âž• Create Campaign</button>
                    <div id="specialSalesList" style="margin-top: 20px;"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“¦ Branch Inventory Breakdown</h3>
                    <div id="gmInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                </div>
            </div>
        </div>

        <!-- Director Portal -->
        <div id="director" class="tab-content">
            <div id="directorAuth" style="display: block;">
                <div class="portal-header">
                    <h2>ðŸŽ¯ Director Portal</h2>
                    <p>Executive Dashboard - Strategic KPIs & Oversight</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access Director portal</p>
                    <button class="btn" onclick="showLogin('director')">ðŸ” Login</button>
                </div>
            </div>
            <div id="directorContent" style="display: none;">
                <div class="user-profile" id="directorProfile"></div>
                
                <div class="portal-header">
                    <h2>ðŸŽ¯ Director Portal - Executive Overview</h2>
                    <p>Monitor Revenue, CIF, BV, Margin, and Stock Management</p>
                    <button class="btn btn-primary" onclick="refreshDirectorData()">ðŸ”„ Refresh Data</button>
                    <button class="btn" onclick="exportSectionToPDF('directorContent')">ðŸ–¨ï¸ Export PDF</button>
                    <button class="btn btn-success" onclick="openScheduleModal('director')" style="margin-left: 10px;">â±ï¸ Schedule Report</button>
                </div>

                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Coordinate strategic directives with staff and log their feedback.</p>
                    <div id="portalCommunicationList-director" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'director')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-director">Message</label>
                            <textarea id="portalCommunicationMessage-director" rows="4" placeholder="Share strategic updates, policy changes or acknowledgements..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('director')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <!-- Executive KPIs -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ’°</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Revenue</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ¦</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">CIF</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorCIF">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">â­</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">BV</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorBV">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ“Š</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Margin</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorMargin">N$ 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 25px; border-radius: 15px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ’¸</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Remittance</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="directorRemittance">N$ 0.00</div>
                    </div>
                </div>
                
                <!-- Stock Depletion Dashboard -->
                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“¦ Stock Depletion Overview</h3>
                    <div id="stockDepletionDashboard"></div>
                </div>

                <div class="form-section" style="margin-top: 30px;">
                    <h3>ðŸ“¦ Branch Inventory Breakdown</h3>
                    <div id="directorInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
                </div>
            </div>
        </div>

        <!-- Admin Portal -->
        <div id="admin" class="tab-content">
            <h2>Admin Portal</h2>
            <div id="adminAuth">
                <p>Please login to access admin portal</p>
                <button class="btn" onclick="showLogin('admin')">Login</button>
            </div>
            <div id="adminContent" style="display: none;">
                <div class="form-section">
                    <h3>User Management</h3>
                    <button class="btn btn-success" onclick="showAddUser()">Add User</button>
                    <button class="btn btn-warning" onclick="showChangePassword()">Change Password</button>
                    <button class="btn btn-primary" onclick="refreshAllData()">ðŸ”„ Refresh Data</button>
                    <div id="userList"></div>
                </div>
                
                <div class="form-section">
                    <h3>ðŸ’¾ Data Management</h3>
                    <button class="btn btn-primary" onclick="exportData()">ðŸ“¥ Export All Data</button>
                    <button class="btn btn-success" onclick="importData()">ðŸ“¤ Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleFileImport(event)">
                    <div id="dataStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
                </div>
                
                <div class="form-section">
                    <h3>ðŸ”§ System Maintenance</h3>
                    <button class="btn btn-info" onclick="updateExistingReportsPricing()">ðŸ’° Fix Package Pricing</button>
                    <button class="btn btn-info" onclick="fixExistingClientNBNumbers()">ðŸ†” Fix NB Numbers</button>
                    <button class="btn btn-success" onclick="runSystemMaintenance()">ðŸ”§ Run All Fixes</button>
                    <div style="margin-top: 15px; font-size: 0.85rem; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <p><strong>System Maintenance Tools:</strong></p>
                        <p>â€¢ <strong>Fix Package Pricing:</strong> Updates existing reports with correct package pricing and component selection</p>
                        <p>â€¢ <strong>Fix NB Numbers:</strong> Converts old NB number formats to new "NB" format</p>
                        <p>â€¢ <strong>Run All Fixes:</strong> Executes both fixes in sequence</p>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Branch Management</h3>
                    <input type="text" id="newBranchName" placeholder="Branch name" style="padding: 10px; margin-right: 10px;">
                    <button class="btn btn-success" onclick="addBranch()">Add Branch</button>
                    <div id="branchList"></div>
                </div>
                
                <div class="form-section">
                    <h3>ðŸ‘¥ Distributor Management</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4>ðŸ“¤ Upload Distributor Data</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                            Upload CSV or Excel (.xlsx, .xls) files with distributor information.<br>
                            <strong>Supported formats:</strong> CSV (Comma Separated Values) or Excel (.xlsx, .xls)<br>
                            <strong style="color: #c41e3a;">Required columns:</strong> DRN, NAME (DRN contains NB numbers for purchases)<br>
                            <strong>Example format:</strong> DRN[tab]NAME or DRN,NAME<br>
                            <em>Note: Only DRN and NAME are required. Other columns are optional.</em>
                        </p>
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 5px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>ðŸ’¾ Storage:</strong> <span id="storageInfo">Loading...</span></span>
                            <button onclick="clearAllDistributors()" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.8rem;">ðŸ—‘ï¸ Clear All</button>
                        </div>
                        <input type="file" id="distributorFile" accept=".csv,.xlsx,.xls" style="padding: 8px; margin-right: 10px;">
                        <button class="btn btn-success" onclick="uploadDistributorFile()">ðŸ“¤ Upload CSV/Excel File</button>
                        <div id="distributorUploadStatus" style="margin-top: 10px;"></div>
                    </div>
                    <div class="search-box">
                        <input type="text" id="distributorSearch" placeholder="Search distributors..." onkeyup="searchDistributors()" style="flex: 1;">
                        <button class="btn btn-success" onclick="showAllDistributors()">ðŸ“‹ Show All</button>
                        <button class="btn btn-warning" onclick="exportDistributors()">ðŸ“¥ Export Data</button>
                        <button class="btn btn-danger" onclick="clearAllDistributors()">ðŸ—‘ï¸ Clear All</button>
                    </div>
                    <div id="distributorList" style="margin-top: 15px; max-height: 500px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-section">
                    <h3>ðŸ“¸ Product Photo Management</h3>
                    <p style="margin-bottom: 15px; color: #666;">Upload and manage product photos for the online shop</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Upload Product Photo</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Select Product</label>
                                <select id="photoProductSelect" required style="padding: 10px; width: 100%;">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Product Photos</label>
                                <input type="file" id="productPhotoInput" accept="image/*" multiple style="padding: 10px; width: 100%;" onchange="previewProductPhoto(event)">
                                <small style="color: #666;">Supported formats: JPG, PNG, WebP (Max 5MB per file). You can select up to 4 photos at once.</small>
                            </div>
                        </div>
                        <div id="photoPreview" style="margin-top: 15px; text-align: center;"></div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="uploadProductPhoto()">ðŸ“¤ Upload Photos</button>
                            <button class="btn btn-warning" onclick="clearPhotoForm()">Clear</button>
                        </div>
                        <div id="photoUploadStatus" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Product Photos Gallery</h4>
                        <div class="search-box">
                            <input type="text" id="photoSearch" placeholder="Search products..." style="flex: 1;" onkeyup="filterProductPhotos()">
                            <button class="btn btn-success" onclick="loadProductPhotos()">ðŸ”„ Refresh</button>
                            <button class="btn btn-primary" onclick="startDownloadProductImages()" id="downloadImagesBtn">â¬‡ï¸ Download All Images</button>
                        </div>
                        <div id="downloadProgress" style="margin-top: 15px; display: none;">
                            <div style="background: #f0f0f0; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span id="downloadStatus">Starting download...</span>
                                    <span id="downloadStats">0/0</span>
                                </div>
                                <div style="background: #ddd; border-radius: 3px; height: 20px; overflow: hidden;">
                                    <div id="downloadProgressBar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div id="downloadLog" style="max-height: 200px; overflow-y: auto; font-size: 12px; color: #666;"></div>
                        </div>
                        <div id="productPhotosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading product photos...</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>ðŸ“¦ Inventory Management</h3>
                    <div class="search-box">
                        <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="searchInventory()">
                        <button class="btn btn-success" onclick="showAllInventory()">ðŸ“‹ Show All</button>
                        <button class="btn btn-warning" onclick="showLowStockItems()">âš ï¸ Low Stock Alert</button>
                        <button class="btn btn-primary" onclick="printInventoryReport()">ðŸ–¨ï¸ Print Report</button>
                    </div>
                    <div id="inventoryList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- CRM Portal -->
        <div id="crm" class="tab-content">
            <h2>ðŸ‘¥ Client Relationship Management (CRM)</h2>
            
            <!-- CRM Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-button active" onclick="showCRMTab('communication')">ðŸ’¬ Communication History</button>
                <button class="tab-button" onclick="showCRMTab('segmentation')">ðŸ“Š Client Segmentation</button>
                <button class="tab-button" onclick="showCRMTab('workflows')">âš™ï¸ Automated Workflows</button>
                <button class="tab-button" onclick="showCRMTab('loyalty')">ðŸŽ Loyalty Program</button>
            </div>

            <!-- Communication History Tab -->
            <div id="crm-communication" class="crm-subtab active">
                <div class="form-section">
                    <h3>ðŸ’¬ Client Communication History</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="crmClientSelect" onchange="loadClientCommunication()" style="padding: 10px; min-width: 250px;">
                            <option value="">Select Client...</option>
                        </select>
                        <button class="btn btn-success" onclick="addClientInteraction()">âž• Add Interaction</button>
                        <button class="btn btn-info" onclick="refreshCRMCommunication()">ðŸ”„ Refresh</button>
                        <button class="btn" onclick="exportClientHistory()">ðŸ“¥ Export</button>
                    </div>
                    
                    <!-- Client Overview -->
                    <div id="crmClientOverview" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 id="crmClientName"></h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <strong>Total Interactions:</strong> <span id="crmTotalInteractions">0</span>
                            </div>
                            <div>
                                <strong>Last Contact:</strong> <span id="crmLastContact">Never</span>
                            </div>
                            <div>
                                <strong>Purchase History:</strong> <span id="crmPurchaseCount">0</span> purchases
                            </div>
                            <div>
                                <strong>Total Spent:</strong> <span id="crmTotalSpent">N$ 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Interaction Timeline -->
                    <div id="crmInteractionTimeline" style="max-height: 600px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">Select a client to view communication history</p>
                    </div>
                </div>
            </div>

            <!-- Client Segmentation Tab -->
            <div id="crm-segmentation" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>ðŸ“Š Client Segmentation</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="refreshSegmentation()">ðŸ”„ Refresh Analysis</button>
                        <button class="btn" onclick="exportSegmentationReport()">ðŸ“¥ Export Report</button>
                    </div>

                    <!-- Segmentation Dashboard -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">â­ VIP Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="vipClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Clients spending N$ 10,000+</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">âš ï¸ At-Risk Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="atRiskClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">No purchase in 90+ days</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">ðŸ”„ Active Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="activeClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Purchased in last 30 days</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">
                            <h4 style="color: white;">ðŸ†• New Clients</h4>
                            <div style="font-size: 2rem; font-weight: bold;" id="newClientCount">0</div>
                            <p style="margin-top: 10px; opacity: 0.9;">Registered in last 30 days</p>
                        </div>
                    </div>

                    <!-- Client Lists by Segment -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <div class="form-section">
                            <h4>â­ VIP Clients</h4>
                            <div id="vipClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>âš ï¸ At-Risk Clients</h4>
                            <div id="atRiskClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>ðŸ”„ Active Clients</h4>
                            <div id="activeClientsList" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>ðŸ“ˆ Purchase Behavior Analysis</h4>
                            <div id="purchaseBehaviorAnalysis" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Automated Workflows Tab -->
            <div id="crm-workflows" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>âš™ï¸ Automated Workflows</h3>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="createWorkflow()">âž• Create Workflow</button>
                        <button class="btn btn-info" onclick="refreshWorkflows()">ðŸ”„ Refresh</button>
                    </div>

                    <!-- Active Workflows -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-section" style="background: #e8f5e9;">
                            <h4>ðŸ“§ Welcome Emails</h4>
                            <div id="welcomeEmailStats">
                                <p>Sent today: <strong id="welcomeEmailsToday">0</strong></p>
                                <p>Total sent: <strong id="welcomeEmailsTotal">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureWelcomeEmails()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #fff3e0;">
                            <h4>ðŸŽ‚ Birthday Greetings</h4>
                            <div id="birthdayStats">
                                <p>Today's birthdays: <strong id="birthdaysToday">0</strong></p>
                                <p>Sent today: <strong id="birthdayGreetingsToday">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureBirthdayGreetings()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #e3f2fd;">
                            <h4>ðŸ”„ Reorder Reminders</h4>
                            <div id="reorderStats">
                                <p>Reminders sent today: <strong id="reorderRemindersToday">0</strong></p>
                                <p>Total active: <strong id="activeReminders">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureReorderReminders()">Configure</button>
                        </div>
                        <div class="form-section" style="background: #fce4ec;">
                            <h4>ðŸ“… Follow-up Scheduling</h4>
                            <div id="followupStats">
                                <p>Scheduled today: <strong id="followupsToday">0</strong></p>
                                <p>Pending: <strong id="pendingFollowups">0</strong></p>
                            </div>
                            <button class="btn btn-sm" onclick="configureFollowups()">Configure</button>
                        </div>
                    </div>

                    <!-- Workflow Log -->
                    <div class="form-section">
                        <h4>ðŸ“‹ Workflow Execution Log</h4>
                        <div id="workflowLog" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <p style="text-align: center; color: #7f8c8d;">No workflow executions yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loyalty Program Tab -->
            <div id="crm-loyalty" class="crm-subtab" style="display: none;">
                <div class="form-section">
                    <h3>ðŸŽ Loyalty Program</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showLoyaltyConfig()">âš™ï¸ Configure Program</button>
                        <button class="btn btn-info" onclick="refreshLoyaltyData()">ðŸ”„ Refresh</button>
                        <button class="btn" onclick="viewLoyaltyReport()">ðŸ“Š Reports</button>
                    </div>

                    <!-- Loyalty Tiers -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #cd7f32;">
                            <h4>ðŸ¥‰ Bronze</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #cd7f32;" id="bronzeCount">0</div>
                            <p>0 - N$ 2,499</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #c0c0c0;">
                            <h4>ðŸ¥ˆ Silver</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #c0c0c0;" id="silverCount">0</div>
                            <p>N$ 2,500 - N$ 9,999</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #ffd700;">
                            <h4>ðŸ¥‡ Gold</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffd700;" id="goldCount">0</div>
                            <p>N$ 10,000 - N$ 24,999</p>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; border: 3px solid #b9f2ff;">
                            <h4>ðŸ’Ž Platinum</h4>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #b9f2ff;" id="platinumCount">0</div>
                            <p>N$ 25,000+</p>
                        </div>
                    </div>

                    <!-- Loyalty Members -->
                    <div class="form-section">
                        <h4>ðŸŽ Loyalty Program Members</h4>
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="loyaltySearch" placeholder="Search members..." onkeyup="filterLoyaltyMembers()" style="padding: 10px; width: 300px;">
                        </div>
                        <div id="loyaltyMembersList" style="max-height: 500px; overflow-y: auto;">
                            <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading loyalty members...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finance Portal -->
        <div id="finance" class="tab-content">
            <h2>ðŸ’° Finance Portal</h2>
            
            <!-- Branch Selector -->
            <div class="form-section" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Select Branch:</label>
                <select id="financeBranchSelect" onchange="refreshFinancialDashboard()" style="padding: 10px; width: 300px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="all">All Branches</option>
                </select>
            </div>

            <div class="form-section">
                <h3>ðŸ’¬ Staff Communication Tab</h3>
                <p class="portal-communication-note">Notify staff about finance approvals and review cash office responses.</p>
                <div id="portalCommunicationList-finance" class="communication-list"></div>
                <form class="communication-form" onsubmit="submitPortalCommunication(event, 'finance')">
                    <div class="form-group">
                        <label class="required" for="portalCommunicationMessage-finance">Message</label>
                        <textarea id="portalCommunicationMessage-finance" rows="4" placeholder="Share finance notices, approvals or reminders..." required></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-success">Send to Staff</button>
                        <button type="button" class="btn" onclick="clearPortalCommunication('finance')">Clear</button>
                    </div>
                </form>
            </div>
            
            <!-- Live Per-Branch Metrics Dashboard -->
            <div class="form-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: white; border-bottom: 2px solid white; margin: 0;">ðŸ“Š Live Financial Metrics (Today)</h3>
                    <select id="financeComparisonPeriod" onchange="refreshFinancialDashboard()" style="padding: 8px 12px; border: 2px solid white; border-radius: 6px; background: rgba(255,255,255,0.2); color: white;">
                        <option value="none">No Comparison</option>
                        <option value="yesterday">vs Yesterday</option>
                        <option value="lastWeek">vs Last Week</option>
                        <option value="lastMonth">vs Last Month</option>
                    </select>
                </div>
                
                <!-- Top Level Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Total Sales</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyTotalSales">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Cash: <span id="dailyCashSales">N$ 0.00</span> | Card: <span id="dailyCardSales">N$ 0.00</span></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash at Hand</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="cashAtHand">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Expected vs Counted</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Bank Deposits</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyDeposits">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Today's Deposits</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash Expenses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyCashExpenses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Approved Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Cash Bonuses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyBonuses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Paid Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Bank Bonuses</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="dailyBankBonuses">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Paid Today</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Variance</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="variance">N$ 0.00</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;" id="varianceStatus">Status: OK</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4>Branch Stock (Items)</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="financeBranchStockQty">0</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Low: <span id="financeBranchLowStock">0</span></div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="refreshFinancialDashboard()" style="background: white; color: #667eea;">ðŸ”„ Refresh</button>
                    <button class="btn btn-primary" onclick="showShiftManager()" style="background: white; color: #667eea;">ðŸ• Shift Manager</button>
                    <button class="btn" onclick="showRecordPaymentModal()" style="background: white; color: #667eea;">ðŸ’³ Record Payment</button>
                    <button class="btn" onclick="showBankDeposit()" style="background: white; color: #667eea;">ðŸ’° Bank Deposit</button>
                    <button class="btn" onclick="showCashBonus()" style="background: white; color: #667eea;">ðŸŽ Cash Bonus</button>
                    <button class="btn" onclick="showBankBonus()" style="background: white; color: #667eea;">ðŸ¦ Bank Bonus</button>
                    <button class="btn" onclick="showBonusUpload()" style="background: white; color: #667eea;">ðŸ“¤ Bonus Upload</button>
                    <button class="btn" onclick="generateZReport()" style="background: white; color: #667eea;">ðŸ“Š Z-Report</button>
                    <button class="btn" onclick="exportFinancialData()" style="background: white; color: #667eea;">ðŸ“¥ Export</button>
                </div>
            </div>

            <!-- Bonus Upload Section -->
            <div class="form-section" id="bonusUploadSection" style="display: none;">
                <h3>ðŸ“¤ Monthly Bonus CSV Upload</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">Upload monthly bonus CSV files per month. This becomes the source of truth for bonus payments.</p>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
                    <label style="font-size: 13px; color: #334e68; font-weight: 600;">Month:</label>
                    <input id="bonusUploadMonth" type="month" style="padding: 10px 12px; border: 2px solid #e3e7ee; border-radius: 8px; background: #fff;" />
                    <input id="bonusUploadFile" type="file" accept=".csv" style="padding: 10px 12px; border: 2px solid #e3e7ee; border-radius: 8px; background: #fff;" />
                    <select id="bonusUploadBranchFilter" style="padding: 10px 12px; border: 2px solid #e3e7ee; border-radius: 8px; background: #fff;">
                        <option value="">All Branches</option>
                        <option>NB1</option>
                        <option>NB2</option>
                        <option>NB3</option>
                        <option>NB4</option>
                    </select>
                    <button class="btn btn-primary" id="bonusUploadBtn" onclick="uploadBonusCsv()" disabled>Upload Monthly Bonus</button>
                    <button class="btn" id="approveBonusUploadBtn" onclick="approveBonusUpload()">âœ… Approve Upload</button>
                    <button class="btn" id="rejectBonusUploadBtn" onclick="rejectBonusUpload()">â›” Reject</button>
                    <button class="btn btn-ghost" onclick="clearBonusUpload()">Clear</button>
                    <button class="btn btn-secondary" onclick="downloadBonusTemplate()">Download Template</button>
                    <button class="btn" onclick="exportBankBatch()">ðŸ¦ Export Bank Batch</button>
                    <button class="btn" onclick="exportPain001()">ðŸ“„ Export PAIN.001</button>
                    <button class="btn" onclick="exportCashSheet()">ðŸ’µ Export Cash Sheet</button>
                    <button class="btn" onclick="showFinanceReconciliation()">ðŸ§¾ Reconciliation</button>
                </div>
                
                <div class="totals" id="bonusUploadTotals" style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px;"></div>
                
                <div class="scroll-x" id="bonusUploadTableWrap" style="overflow: auto; border: 1px solid #e3e7ee; border-radius: 8px; display: none; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 920px;">
                        <thead>
                            <tr>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">#</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">DRN</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Name</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Stockist</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Area</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">NAD</th>
                                <th style="padding: 10px 12px; border-bottom: 1px solid #eef2f7; text-align: left; background: #f2f5f9; position: sticky; top: 0; z-index: 1;">Signature</th>
                            </tr>
                        </thead>
                        <tbody id="bonusUploadBody"></tbody>
                    </table>
                </div>
                
                <div style="padding: 16px 0; color: #6b7c93; font-size: 13px;">
                    Monthly bonus upload saved to <span style="background: #eef2f7; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #334e68;">/api/bonus</span>. This is the source of truth for bonus payments. Distributors not in this CSV for the selected month cannot be paid.
                </div>
            </div>

            <!-- Reconciliation Section -->
            <div class="form-section" id="financeReconciliation" style="display: none;">
                <h3>ðŸ§¾ Monthly Reconciliation</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <input id="reconMonth" type="month" style="padding: 10px 12px; border: 2px solid #e3e7ee; border-radius: 8px; background: #fff;" />
                    <button class="btn btn-info" onclick="loadReconciliation()">ðŸ”„ Refresh</button>
                </div>
                <div id="reconSummary" style="margin-bottom: 10px; color: #334e68;"></div>
                <div class="scroll-x" style="max-height: 420px; overflow: auto; border: 1px solid #e3e7ee; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                        <thead>
                            <tr>
                                <th style="padding: 10px; background: #f2f5f9;">DRN</th>
                                <th style="padding: 10px; background: #f2f5f9;">Name</th>
                                <th style="padding: 10px; background: #f2f5f9;">Uploaded NAD</th>
                                <th style="padding: 10px; background: #f2f5f9;">Paid NAD</th>
                                <th style="padding: 10px; background: #f2f5f9;">Method</th>
                                <th style="padding: 10px; background: #f2f5f9;">Status</th>
                                <th style="padding: 10px; background: #f2f5f9;">Variance</th>
                            </tr>
                        </thead>
                        <tbody id="reconBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Staff Requests (Approvals) -->
            <div class="form-section">
                <h3>ðŸ‘¤ Staff Requests - Cash Approval</h3>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="displayFinanceCashRequests()">ðŸ”„ Refresh</button>
                </div>
                <div id="financeCashRequests" class="scroll-x" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No cash requests yet.</p>
                </div>
            </div>

            <div class="form-section">
                <h3>ðŸ“¦ Branch Inventory Breakdown</h3>
                <div id="financeInventoryBreakdown" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;"></div>
            </div>

            <!-- Expense Management -->
            <div class="form-section">
                <h3>ðŸ’¸ Expense Management</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddExpenseModal()">âž• Add Expense</button>
                    <button class="btn btn-info" onclick="refreshExpenses()">ðŸ”„ Refresh</button>
                    <button class="btn btn-warning" onclick="showExpenseSummary()">ðŸ“Š Summary</button>
                </div>
                
                <!-- Expense Filters -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <select id="expenseCategoryFilter" onchange="filterExpenses()">
                        <option value="all">All Categories</option>
                        <optgroup label="OPERATING EXPENSES">
                            <option value="cleaning-materials">Cleaning Materials & equipment</option>
                            <option value="transportation-taxi">Transportation/Taxi fare</option>
                            <option value="fuel">Fuel</option>
                            <option value="telephone-internet">Telephone & internet</option>
                            <option value="printing-photocopy">Printing & photocopy</option>
                            <option value="meals">Meals</option>
                            <option value="car-repair">Repair & Maintenance (car)</option>
                            <option value="nampost-courier">Nampost courier services</option>
                            <option value="stationary">Stationary</option>
                            <option value="office-equipment">Office equipment</option>
                            <option value="bonus">Bonus</option>
                            <option value="fitness-certificate">Fitness certificate</option>
                            <option value="marketing-expos">Marketing/Expos/Conference halls</option>
                            <option value="bad-debts">Bad debts/Losses and Thefts</option>
                            <option value="miscellaneous">Miscellaneous</option>
                            <option value="advertisement-promotions">Advertisement & promotions</option>
                            <option value="accommodation">Accommodation</option>
                            <option value="company-stock">Stock for company use (NON CASH PRODUCTS)</option>
                            <option value="bank-charges">Bank charges</option>
                            <option value="cash-back">Cash back</option>
                            <option value="field-work">Field work</option>
                            <option value="consistency">Consistency</option>
                            <option value="payroll-processing">Payroll Processing Services</option>
                            <option value="social-security">Social Security</option>
                            <option value="payroll-taxes">Payroll Taxes</option>
                            <option value="website-development">Website development</option>
                            <option value="business-licenses">Business Licenses and permits</option>
                            <option value="labour">Labour</option>
                            <option value="carpenter-plumbing">Carpenter/Plumbing services (fixtures & fittings)</option>
                            <option value="salaries">Salaries</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="periodic-expenses">Periodic Expenses</option>
                            <option value="foreign-affairs-paperwork">Foreign affairs: paperwork</option>
                            <option value="visas">Visas</option>
                            <option value="foreign-affairs-flights">Foreign affairs: flight tickets</option>
                            <option value="gift-promotions">Gift Promotions</option>
                            <option value="management-travel">Management Travel Expenses</option>
                        </optgroup>
                        <optgroup label="VARIABLE EXPENSES">
                            <option value="water-bill">Water Bill</option>
                            <option value="electricity-bill">Electricity Bill</option>
                            <option value="security-services">Security Services</option>
                            <option value="rent">Rent</option>
                            <option value="body-corporate">Body Corporate</option>
                        </optgroup>
                        <optgroup label="INTEREST & TAXES">
                            <option value="interest-income">Interest (income)</option>
                            <option value="interest-expenses">Interest Expenses</option>
                            <option value="interest-expenses-taxes">Interest (income), expenses & Taxes</option>
                        </optgroup>
                    </select>
                    <select id="expenseMonthFilter" onchange="filterExpenses()">
                        <option value="all">All Months</option>
                    </select>
                    <input type="text" id="expenseSearch" placeholder="Search expenses..." onkeyup="filterExpenses()">
                </div>
                
                <div id="expenseList" class="scroll-x" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading expenses...</p>
                </div>
            </div>

            <!-- Revenue Tracking -->
            <div class="form-section">
                <h3>ðŸ’µ Revenue Tracking</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="refreshRevenue()">ðŸ”„ Refresh</button>
                    <button class="btn btn-success" onclick="showRevenueBreakdown()">ðŸ“Š Breakdown</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <h4>Prescription Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;" id="prescriptionRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h4>Walk-in Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2196f3;" id="walkinRevenue">N$ 0.00</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <h4>Total Sales</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;" id="totalSales">N$ 0.00</div>
                    </div>
                </div>
                
                <div id="revenueList" class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Revenue details...</p>
                </div>
            </div>

            <!-- Budget Management -->
            <div class="form-section">
                <h3>ðŸ“ˆ Budget Planning</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddBudgetModal()">âž• Create Budget</button>
                    <button class="btn btn-info" onclick="refreshBudgets()">ðŸ”„ Refresh</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <select id="budgetMonthFilter" onchange="filterBudgets()">
                        <option value="">Select Month</option>
                    </select>
                    <select id="budgetYearFilter" onchange="filterBudgets()">
                        <option value="">Select Year</option>
                    </select>
                </div>
                
                <div id="budgetList" class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No budgets created yet</p>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="form-section">
                <h3>ðŸ“Š Monthly Financial Summary</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center;">
                    <select id="summaryMonth" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <input type="number" id="summaryYear" min="2020" max="2030" value="2025" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 100px;">
                    <button class="btn btn-primary" onclick="generateMonthlySummary()">Generate Summary</button>
                    <button class="btn btn-success" onclick="exportMonthlySummaryCSV()">ðŸ“¥ Export CSV</button>
                    <button class="btn btn-info" onclick="printMonthlySummary()">ðŸ–¨ï¸ Print</button>
                </div>
                <div id="monthlySummaryTable" class="scroll-x" style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Select month and year, then click 'Generate Summary'</p>
                </div>
            </div>

            <!-- Financial Reports -->
            <div class="form-section">
                <h3>ðŸ“‹ Financial Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <button class="btn btn-success" onclick="generateProfitLossReport()">ðŸ“Š Profit & Loss</button>
                    <button class="btn btn-primary" onclick="generateCashFlowReport()">ðŸ’¸ Cash Flow Statement</button>
                    <button class="btn btn-warning" onclick="generateBudgetReport()">ðŸ“ˆ Budget vs Actual</button>
                    <button class="btn btn-info" onclick="generateExpenseReport()">ðŸ’¸ Expense Report</button>
                </div>
                <div id="financeReportDisplay" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d;">Select a report to view</p>
                </div>
            </div>
        </div>

        <!-- MIS Portal -->
        <div id="mis" class="tab-content">
            <div id="misAuth">
                <div class="portal-header">
                    <h2>ðŸ“Š MIS Portal</h2>
                    <p>Sales Receipt Management & Reporting</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">Please login to access MIS portal</p>
                    <button class="btn" onclick="showLogin('mis')">ðŸ” Login</button>
                </div>
            </div>
            <div id="misContent" style="display: none;">
                <div class="user-profile" id="misProfile"></div>
                
                <div class="portal-header">
                    <h2>ðŸ“Š MIS Portal - Sales Receipt Management</h2>
                    <p>View and analyze sales receipts across all branches</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="refreshAllData()">ðŸ”„ Refresh Data</button>
                        <button class="btn btn-success" onclick="openDailyReportWindow()">ðŸ“„ Daily Operations Report</button>
                        <button class="btn btn-info" onclick="viewDepartmentEvents()">ðŸ“§ View Department Events</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ðŸ’¬ Staff Communication Tab</h3>
                    <p class="portal-communication-note">Share MIS alerts with staff and log their confirmations or data submissions.</p>
                    <div id="portalCommunicationList-mis" class="communication-list"></div>
                    <form class="communication-form" onsubmit="submitPortalCommunication(event, 'mis')">
                        <div class="form-group">
                            <label class="required" for="portalCommunicationMessage-mis">Message</label>
                            <textarea id="portalCommunicationMessage-mis" rows="4" placeholder="Notify staff about reconciliations, missing reports or KPIs..." required></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success">Send to Staff</button>
                            <button type="button" class="btn" onclick="clearPortalCommunication('mis')">Clear</button>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                <h3>Branch & Search Filters</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Branch</label>
                        <select id="misBranchSelect" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                            <option value="all">All Branches</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Search by Name or NB Number</label>
                        <input type="text" id="misSearchInput" placeholder="Type name or NB number..." onkeyup="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>From (Date & Time)</label>
                        <input type="datetime-local" id="misDateFrom" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>To (Date & Time)</label>
                        <input type="datetime-local" id="misDateTo" onchange="filterMISReports()" style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn" onclick="setMISDateToday(); return false;">ðŸ“… Today</button>
                        <button class="btn btn-info" onclick="clearMISDateFilters(); return false;">ðŸ§¹ Clear</button>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                    <strong>ðŸ“Š Summary:</strong>
                    <span id="misTotalCount" style="margin-left: 10px;">Total Records: 0</span>
                    <span id="misBranchSummary" style="margin-left: 20px;">Branch Breakdown: Loading...</span>
                    <span id="misStockSummary" style="margin-left: 20px;">Stock: Loading...</span>
                </div>
            </div>

            <div class="form-section">
                <h3>Sales Receipts List</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="exportMISData()">ðŸ“¥ Export to Excel</button>
                    <button class="btn btn-success" onclick="refreshMISData()">ðŸ”„ Refresh Data</button>
                    <button class="btn btn-primary" onclick="printMISReport()">ðŸ–¨ï¸ Print Report</button>
                </div>
                <div id="misReportsDisplay" class="scroll-x" style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                    <p style="text-align: center; color: #7f8c8d;">Loading sales receipts...</p>
                </div>
            </div>

            <div class="form-section">
                <h3>Daily Receipts Summary by Branch</h3>
                <div id="misBranchDailySummary" class="scroll-x" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                    <p style="text-align: center; color: #7f8c8d;">Branch summary will appear here.</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Walk-in Sale Modal -->
    <div class="modal" id="walkInSaleModal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('walkInSaleModal')">&times;</span>
            <h2 id="walkInSaleTitle">ðŸ›’ Walk-in Sale</h2>
            
            <form id="walkInSaleForm">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="position: relative;">
                        <label>Customer Name *</label>
                        <input type="text" id="walkInCustomerName" placeholder="Full Name" required>
                        <input type="hidden" id="walkInCustomerCode">
                        <div id="customerNameDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Phone Number (Optional)</label>
                        <input type="tel" id="walkInPhone" placeholder="0812345678">
                    </div>
                    <div class="form-group">
                        <label>Email Address (Optional)</label>
                        <input type="email" id="walkInEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Customer Type *</label>
                        <select id="walkInCustomerType" onchange="onCustomerTypeChange()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;" required>
                            <option value="customer">Customer</option>
                            <option value="distributor">Distributor</option>
                        </select>
                    </div>
                </div>
                
                <!-- Distributor Referral Field for Customers -->
                <div id="customerReferralField" style="display: block; margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 5px;">                                                                
                    <h4 style="margin-bottom: 10px; color: #856404;">âš ï¸ Required: Referred Distributor</h4>
                    
                    <!-- Checkbox for "I have no referral" -->
                    <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                            <input type="checkbox" id="noReferralCheckbox" onchange="handleNoReferralCheckbox()" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #856404;">I have no referral (will use Dynapharm Namibia)</span>
                        </label>
                    </div>
                                                      
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">                                                                         
                        <div class="form-group" style="position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="color: #856404;">Search by Name or NB Number *</label>
                                <button type="button" id="changeReferralBtn" onclick="clearSelectedReferral()" style="display: none; padding: 5px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Change Referral</button>
                            </div>
                            <input type="text" id="distributorReferralSearch" placeholder="Type name or NB number (e.g. OTTILIE or NB001544)"                   
                                   onkeyup="searchDistributorsForReferral()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;" required>                                                                          
                            <input type="hidden" id="distributorReferralValue" required>                                                                        
                            <div id="distributorReferralDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div> 
                        </div>
                        <div id="selectedDistributorInfo" style="display: none; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;"> 
                            <div style="font-size: 0.9rem;">
                                <strong>Selected:</strong> <span id="selectedDistributorName"></span><br>                                                       
                                <strong>NB Number:</strong> <span id="selectedDistributorCode"></span> |                                                        
                                <strong>Mobile:</strong> <span id="selectedDistributorMobile"></span>                                                           
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ðŸ“¦ Select Products</h4>
                    <div id="walkInProductsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                        <p style="text-align: center; color: #7f8c8d;">Loading products...</p>
                    </div>
                </div>
                
                <div style="border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ðŸ›’ Shopping Cart</h4>
                    <div id="walkInCartList" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">Cart is empty</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #666;">
                        ðŸ’¡ <strong>Tip:</strong> Click quantity to edit, or click âŒ to remove items
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.2rem;">Total Amount:</strong>
                                <span id="walkInTotalAmount" style="font-size: 1.5rem; color: #27ae60; font-weight: bold;">N$ 0.00</span>
                            </div>
                            <div style="display: none;">
                                <strong>Tax:</strong>
                                <span id="walkInTaxAmount">N$ 0.00</span>
                            </div>
                            <div>
                                <strong>Discount:</strong>
                                <span id="walkInDiscountAmount">N$ 0.00</span>
                            </div>
                            <div>
                                <strong style="font-size: 1.1rem;">Grand Total:</strong>
                                <span id="walkInGrandTotal" style="font-size: 1.3rem; color: #c41e3a; font-weight: bold;">N$ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method Selection -->
                <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ðŸ’³ Payment Method *</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button type="button" id="paymentMethodCash" class="payment-method-btn active" onclick="selectWalkInPaymentMethod('cash')" style="padding: 15px; border: 2px solid #27ae60; border-radius: 8px; background: #e8f5e9; cursor: pointer; font-weight: bold;">
                            ðŸ’µ Cash
                        </button>
                        <button type="button" id="paymentMethodCard" class="payment-method-btn" onclick="selectWalkInPaymentMethod('card')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            ðŸ’³ Card
                        </button>
                        <button type="button" id="paymentMethodMobile" class="payment-method-btn" onclick="selectWalkInPaymentMethod('mobile')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            ðŸ“± Mobile Money
                        </button>
                        <button type="button" id="paymentMethodBank" class="payment-method-btn" onclick="selectWalkInPaymentMethod('bank')" style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            ðŸ¦ Bank Transfer
                        </button>
                    </div>
                    <input type="hidden" id="walkInPaymentMethod" value="cash">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('walkInSaleModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="showWalkInSaleConfirmation()" id="reviewWalkInSaleBtn">ðŸ“‹ Review & Confirm Sale</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Walk-in Sale Confirmation Modal -->
    <div class="modal" id="walkInSaleConfirmationModal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('walkInSaleConfirmationModal')">&times;</span>
            <h2>ðŸ“‹ Confirm Sale Details</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #2c3e50;">Customer Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <strong>Name:</strong>
                        <div id="confirmCustomerName" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Type:</strong>
                        <div id="confirmCustomerType" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Phone:</strong>
                        <div id="confirmPhone" style="color: #666;"></div>
                    </div>
                    <div>
                        <strong>Email:</strong>
                        <div id="confirmEmail" style="color: #666;"></div>
                    </div>
                </div>
                <div id="confirmReferralInfo" style="display: none; padding: 10px; background: white; border-radius: 5px; margin-top: 10px;">
                    <strong>Referred By:</strong>
                    <div id="confirmReferral" style="color: #666;"></div>
                </div>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #856404;">Order Summary</h3>
                <div id="confirmProductsList" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
                <div style="border-top: 2px solid #f39c12; padding-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Subtotal:</strong>
                        <span id="confirmSubtotal" style="font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Total BV:</strong>
                        <span id="confirmTotalBV" style="color: #c41e3a; font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; padding-top: 10px; border-top: 2px solid #f39c12;">
                        <strong>Grand Total:</strong>
                        <span id="confirmGrandTotal" style="color: #c41e3a; font-weight: bold; font-size: 1.3rem;"></span>
                    </div>
                </div>
            </div>

            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #27ae60;">Payment Information</h3>
                <div>
                    <strong>Payment Method:</strong>
                    <div id="confirmPaymentMethod" style="color: #666; font-size: 1.1rem; margin-top: 5px;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn" onclick="closeModal('walkInSaleConfirmationModal')">â† Back to Edit</button>
                <button type="button" class="btn btn-success" onclick="confirmWalkInSale()" style="padding: 12px 30px; font-size: 1.1rem;">
                    âœ… Confirm & Process Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="username" placeholder="Username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn">Login</button>
                <div style="margin-top: 15px; font-size: 0.85rem; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <p><strong>Default Test Accounts:</strong></p>
                    <p>Admin: <code>admin</code> / <code>admin123</code></p>
                    <p>Consultant: <code>consultant</code> / <code>consultant123</code></p>
                    <p>Dispenser: <code>dispenser</code> / <code>dispenser123</code></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>Add User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <input type="text" name="fullName" placeholder="Full Name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <input type="text" name="username" placeholder="Username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <input type="password" name="password" placeholder="Password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Email Address" required autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="tel" name="phone" placeholder="Phone Number" required autocomplete="tel">
                </div>
                <div class="form-group">
                    <select name="role" required onchange="toggleAdditionalBranches(); updatePortalAccessByRole();">
                        <option value="">Select Role</option>
                        <option value="consultant">Consultant</option>
                        <option value="sales_staff">Sales Staff</option>
                        <option value="dispenser">Dispenser</option>
                        <option value="stock">Stock Manager</option>
                        <option value="admin">Admin</option>
                        <option value="finance">Finance</option>
                        <option value="hr_manager">HR Manager</option>
                        <option value="gm">General Manager</option>
                        <option value="director">Director</option>
                        <option value="mis">MIS</option>
                        <option value="branch_manager">Branch Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Branch Assignment (Optional):</label>
                    <div id="branchSelection">
                        <select name="branch" id="userBranchSelect">
                            <option value="">-- No Branch Assignment --</option>
                        </select>
                    </div>
                    <div id="additionalBranches" style="display: none; margin-top: 10px;">
                        <label><strong>Additional Branches (for Consultants & Sales Staff):</strong></label>
                        <small style="color: #666; display: block; margin-bottom: 8px;">Select additional branches this user can access. The primary branch is already included.</small>
                        <div id="branchCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        </div>
                    </div>
                    <div id="allBranchesAccess" style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="allBranches" id="allBranchesCheckbox" onchange="toggleAllBranchesAccess()">
                            <span>Access to All Branches</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Portal Access:</label>
                    <div id="portalAccessCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="client">
                            <span>Client Portal (Shop)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="frontdesk">
                            <span>Front Desk</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="consultant">
                            <span>Consultant Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="dispenser">
                            <span>Dispenser Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="hr-portal">
                            <span>HR Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="finance">
                            <span>Finance Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="gm">
                            <span>GM Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="director">
                            <span>Director Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="mis">
                            <span>MIS Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="stock">
                            <span>Stock Portal</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="portalAccess" value="admin">
                            <span>Admin Portal</span>
                        </label>
                    </div>
                    <small style="color: #666; font-size: 0.9rem; display: block; margin-top: 5px;">Select which portals this user can access. Portal access can be customized based on role.</small>
                </div>
                <div class="form-group">
                    <label>Profile Photo (Optional)</label>
                    <input type="file" name="photo" id="userPhotoInput" accept="image/*" onchange="previewUserPhoto(event)">
                    <div id="userPhotoPreview" style="margin-top: 10px; display: none;">
                        <img id="userPhotoPreviewImg" src="" alt="Photo preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Create User</button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2>Change Password</h2>
            <form id="changePasswordForm">
                <input type="text" name="username" autocomplete="username" style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;" aria-hidden="true" tabindex="-1">
                <div class="form-group">
                    <input type="password" name="currentPassword" placeholder="Current Password" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <input type="password" name="newPassword" placeholder="New Password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <input type="password" name="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-success">Change Password</button>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
            <h2>Reset User Password</h2>
            <form id="resetPasswordForm">
                <input type="hidden" name="userId" id="resetPasswordUserId">
                <div class="form-group">
                    <p><strong>User:</strong> <span id="resetPasswordFullName"></span> (<span id="resetPasswordUsername"></span>)</p>
                </div>
                <div class="form-group">
                    <input type="password" name="newPassword" placeholder="New Password" required autocomplete="new-password" minlength="3">
                </div>
                <div class="form-group">
                    <input type="password" name="confirmPassword" placeholder="Confirm New Password" required autocomplete="new-password" minlength="3">
                </div>
                <button type="submit" class="btn btn-success">Reset Password</button>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            
            <div class="prescription-form">
                <div class="prescription-header">
                    <h2>DYNAPHARM INTERNATIONAL NAMIBIA</h2>
                    <p id="branchInfo"></p>
                    <h3>Summary Analysis Report Card</h3>
            </div>

                <div class="patient-info" id="patientInfo"></div>

                <div class="form-section">
                    <h3>Presenting Symptoms</h3>
                    <div id="patientSymptoms"></div>
            </div>

                <div class="form-section">
                    <h3>Health Assessment</h3>
                    <div id="healthAssessment"></div>
                </div>

                <div class="form-section" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                    <h3 style="color: #2196f3;">ðŸ©º ABOUT THE PROBLEMS OF SUB-HEALTH TRENDS</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Select the body system(s) and symptoms affecting the patient to view lifestyle recommendations:</p>
                    
                    <div id="bodySystemsSelector" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <!-- Body systems will be populated here -->
                    </div>
                    
                    <div id="lifestyleRecommendations" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #2196f3; min-height: 100px; display: none;">
                        <!-- Lifestyle recommendations will appear here -->
                    </div>
                </div>

                <div class="form-section" style="background: #e8f5e9; border-left: 5px solid #27ae60;">
                    <h3 style="color: #27ae60;">ðŸŽ¯ AI-Powered Product Recommendations</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Based on symptoms and health conditions, here are suggested products:</p>
                    <div id="recommendationsDisplay" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #27ae60;">
                        <p style="text-align: center; color: #7f8c8d; font-style: italic;">Analyzing patient data...</p>
                    </div>
                    <button type="button" class="btn btn-success" onclick="applyRecommendations()" style="margin-top: 15px; width: 100%;">
                        âœ… Apply All Recommended Products
                    </button>
                </div>

                <div class="form-section">
                    <h3>Consultant's Notes & Diagnosis</h3>
                    <textarea id="consultantNotes" rows="5" style="width: 100%;" placeholder="Enter diagnosis and treatment notes..." oninput="updateNotesDisplay()"></textarea>
                    <div id="notesDisplay" class="notes-display"></div>
                </div>

                <div class="form-section">
                    <h3>Follow-up Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <label for="followUpDate">Recommended Follow-up Date:</label>
                            <input type="date" id="followUpDate" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div>
                            <label for="followUpNotes">Follow-up Notes (Optional):</label>
                            <input type="text" id="followUpNotes" placeholder="e.g., Review progress, adjust dosage..." style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Prescription & Medicine Selection</h3>
                    <div class="medicine-grid" id="medicineGrid"></div>
                    <div id="prescriptionDisplay" class="prescription-display"></div>
                </div>

            <div class="form-group">
                <label>Upload PDF (Optional)</label>
                <input type="file" id="pdfUpload" accept=".pdf" onchange="handlePDF(event)">
                <p id="pdfStatus"></p>
            </div>

                <div class="consultant-footer">
                    <div class="consultant-info">
                        <div class="signature-section">
                            <h4>Consultant Signature</h4>
                            <div class="signature-line"></div>
                            <p id="consultantSignatureName">${currentUser ? currentUser.fullName : 'Consultant Name'}</p>
                            <div class="contact-info" id="consultantContactInfo">
                                <p>Tel: 061-300877</p>
                                <p>Email: info@dynapharm.com.na</p>
                            </div>
                        </div>
                        <div class="follow-up-section">
                            <h4>Follow-up Date</h4>
                            <div class="follow-up-date" id="followUpDateDisplay">________________</div>
                            <p>Next appointment recommended</p>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div id="autosaveStatus" style="display: none; padding: 8px 15px; background: #fff; border-radius: 5px; color: #666; font-size: 0.9rem;">
                        <span style="color: #27ae60;">âœ“</span> Draft saved at <span id="autosaveTime"></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveReport()">ðŸ’¾ Save Report</button>
                        <button class="btn btn-primary" onclick="finalizeReport()">âœ… Finalize & E-Sign</button>
                        <button class="btn btn-warning" onclick="printReport()">ðŸ–¨ï¸ Print</button>
                        <button class="btn" onclick="exportReportPDF()">ðŸ“„ Export PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Template Modal -->
    <div class="modal" id="reportTemplateModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('reportTemplateModal')">&times;</span>
            <h2>ðŸ“‹ Select Report Template</h2>
            <p style="margin-bottom: 20px; color: #666;">Choose a template to quickly fill in common consultation details</p>
            
            <div id="templateList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                <!-- Templates will be populated by JavaScript -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="closeModal('reportTemplateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit User Branches Modal -->
    <div class="modal" id="editBranchesModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editBranchesModal')">&times;</span>
            <h2>Edit User Branches</h2>
            <div id="editUserInfo" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            </div>
            <form id="editBranchesForm">
                <div class="form-group">
                    <label>Primary Branch:</label>
                    <select name="primaryBranch" id="editPrimaryBranch" required>
                        <option value="">Select Primary Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Branches (for Consultants):</label>
                    <div id="editBranchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Branches</button>
            </form>
        </div>
    </div>

    <!-- Daily Statement Modal -->
    <div class="modal" id="dailyStatementModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('dailyStatementModal')">&times;</span>
            <h2 style="text-align: center; color: #c41e3a; margin-bottom: 10px;">ðŸ“Š Daily Statement Preview</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                Review today's activity, then print or simply close to view only
            </p>
            
            <div id="dailyStatementContent" style="background: white; padding: 20px; border-radius: 8px; max-height: 60vh; overflow-y: auto;">
                <!-- Content will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 2px solid #ddd; background: #f8f9fa; border-radius: 8px;">
                <p style="margin-bottom: 15px; color: #666; font-weight: 500;">Choose an action:</p>
                <button class="btn btn-success" onclick="printDailyStatementA4()" style="margin-right: 10px;">ðŸ–¨ï¸ Print A4 / PDF</button>
                <button class="btn btn-warning" onclick="printDailyStatementThermal()" style="margin-right: 10px;">ðŸ§¾ Thermal Receipt</button>
                <button class="btn btn-secondary" onclick="closeModal('dailyStatementModal')">ðŸ‘ï¸ View Only (Close)</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addExpenseModal')">&times;</span>
            <h2>ðŸ’¸ Add Expense</h2>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label>Expense Category *</label>
                    <select id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <optgroup label="OPERATING EXPENSES">
                            <option value="cleaning-materials">Cleaning Materials & equipment</option>
                            <option value="transportation-taxi">Transportation/Taxi fare</option>
                            <option value="fuel">Fuel</option>
                            <option value="telephone-internet">Telephone & internet</option>
                            <option value="printing-photocopy">Printing & photocopy</option>
                            <option value="meals">Meals</option>
                            <option value="car-repair">Repair & Maintenance (car)</option>
                            <option value="nampost-courier">Nampost courier services</option>
                            <option value="stationary">Stationary</option>
                            <option value="office-equipment">Office equipment</option>
                            <option value="bonus">Bonus</option>
                            <option value="fitness-certificate">Fitness certificate</option>
                            <option value="marketing-expos">Marketing/Expos/Conference halls</option>
                            <option value="bad-debts">Bad debts/Losses and Thefts</option>
                            <option value="miscellaneous">Miscellaneous</option>
                            <option value="advertisement-promotions">Advertisement & promotions</option>
                            <option value="accommodation">Accommodation</option>
                            <option value="company-stock">Stock for company use (NON CASH PRODUCTS)</option>
                            <option value="bank-charges">Bank charges</option>
                            <option value="cash-back">Cash back</option>
                            <option value="field-work">Field work</option>
                            <option value="consistency">Consistency</option>
                            <option value="payroll-processing">Payroll Processing Services</option>
                            <option value="social-security">Social Security</option>
                            <option value="payroll-taxes">Payroll Taxes</option>
                            <option value="website-development">Website development</option>
                            <option value="business-licenses">Business Licenses and permits</option>
                            <option value="labour">Labour</option>
                            <option value="carpenter-plumbing">Carpenter/Plumbing services (fixtures & fittings)</option>
                            <option value="salaries">Salaries</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="periodic-expenses">Periodic Expenses</option>
                            <option value="foreign-affairs-paperwork">Foreign affairs: paperwork</option>
                            <option value="visas">Visas</option>
                            <option value="foreign-affairs-flights">Foreign affairs: flight tickets</option>
                            <option value="gift-promotions">Gift Promotions</option>
                            <option value="management-travel">Management Travel Expenses</option>
                        </optgroup>
                        <optgroup label="VARIABLE EXPENSES">
                            <option value="water-bill">Water Bill</option>
                            <option value="electricity-bill">Electricity Bill</option>
                            <option value="security-services">Security Services</option>
                            <option value="rent">Rent</option>
                            <option value="body-corporate">Body Corporate</option>
                        </optgroup>
                        <optgroup label="INTEREST & TAXES">
                            <option value="interest-income">Interest (income)</option>
                            <option value="interest-expenses">Interest Expenses</option>
                            <option value="interest-expenses-taxes">Interest (income), expenses & Taxes</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Monthly rent payment" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="expensePaymentMethod">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="expenseNotes" rows="3" placeholder="Additional details..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ðŸ’¾ Save Expense</button>
                    <button type="button" class="btn" onclick="closeModal('addExpenseModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div class="modal" id="addBudgetModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBudgetModal')">&times;</span>
            <h2>ðŸ“ˆ Create Budget</h2>
            <form id="addBudgetForm">
                <div class="form-group">
                    <label>Budget Period *</label>
                    <select id="budgetPeriod" required>
                        <option value="">Select Period</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Month *</label>
                    <select id="budgetMonth" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year *</label>
                    <input type="number" id="budgetYear" min="2024" max="2030" value="2024" required>
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select id="budgetCategory" required>
                        <option value="">Select Category</option>
                        <option value="salaries">Salaries</option>
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="supplies">Supplies</option>
                        <option value="marketing">Marketing</option>
                        <option value="travel">Travel</option>
                        <option value="insurance">Insurance</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Budgeted Amount (N$) *</label>
                    <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="budgetNotes" rows="3" placeholder="Budget details..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ðŸ’¾ Create Budget</button>
                    <button type="button" class="btn" onclick="closeModal('addBudgetModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Manager Modal -->
    <div class="modal" id="shiftManagerModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('shiftManagerModal')">&times;</span>
            <h2>ðŸ• Shift Manager - Cash Tracking</h2>
            <div id="shiftContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bank Deposit Modal -->
    <div class="modal" id="bankDepositModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankDepositModal')">&times;</span>
            <h2>ðŸ’° Record Bank Deposit</h2>
            <form id="bankDepositForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="depositBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="depositDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="depositAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Deposit Slip Number *</label>
                    <input type="text" id="depositSlipNo" required placeholder="Bank slip reference">
                </div>
                <div class="form-group">
                    <label>Bank Name *</label>
                    <select id="depositBank" required>
                        <option value="">Select Bank</option>
                        <option value="FNB">First National Bank (FNB)</option>
                        <option value="Nedbank">Nedbank</option>
                        <option value="Bank Windhoek">Bank Windhoek</option>
                        <option value="Standard Bank">Standard Bank</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bank Branch *</label>
                    <input type="text" id="depositBankBranch" required placeholder="e.g., Windhoek Main">
                </div>
                <div class="form-group">
                    <label>Account Number *</label>
                    <input type="text" id="depositAccountNumber" required placeholder="e.g., 1234567890">
                </div>
                <div class="form-group">
                    <label>Account Type *</label>
                    <select id="depositAccountType" required>
                        <option value="">Select Type</option>
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deposited By *</label>
                    <input type="text" id="depositedBy" required placeholder="Name of person making deposit">
                </div>
                <div class="form-group">
                    <label>Upload Deposit Slip (Optional)</label>
                    <input type="file" id="depositPhoto" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="depositNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ðŸ’° Record Deposit</button>
                    <button type="button" class="btn" onclick="closeModal('bankDepositModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cash Bonus Modal -->
    <div class="modal" id="cashBonusModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cashBonusModal')">&times;</span>
            <h2>ðŸŽ Record Cash Bonus Payment</h2>
            <form id="cashBonusForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="bonusBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group" style="position: relative;">
                    <label>Distributor NB Number *</label>
                    <input type="text" id="bonusDistributorNB" required placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                           onkeyup="searchDistributorsForBonus('bonus')" autocomplete="off">
                    <div id="bonusDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                    <small id="bonusDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="bonusDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="bonusAmount" step="0.01" min="0" required onchange="checkBonusLimit()">
                </div>
                <div id="bonusLimitWarning" style="display: none; padding: 10px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 5px; margin-bottom: 15px;">
                    <strong>âš ï¸ Warning:</strong> This bonus exceeds the branch limit or available cash. GM approval may be required.
                </div>
                <div class="form-group">
                    <label>Reason *</label>
                    <textarea id="bonusReason" rows="3" required placeholder="Reason for bonus payment..."></textarea>
                </div>
                <div class="form-group">
                    <label>Approved By *</label>
                    <input type="text" id="bonusApprovedBy" required placeholder="Manager name">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ðŸŽ Record Bonus</button>
                    <button type="button" class="btn" onclick="closeModal('cashBonusModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bank Bonus Modal -->
    <div class="modal" id="bankBonusModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankBonusModal')">&times;</span>
            <h2>ðŸ¦ Record Bank Bonus Payment</h2>
            <form id="bankBonusForm">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="bankBonusBranch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group" style="position: relative;">
                    <label>Distributor NB Number *</label>
                    <input type="text" id="bankBonusDistributorNB" required placeholder="Type name or NB number (e.g. OTTILIE or NB001544)" 
                           onkeyup="searchDistributorsForBonus('bank')" autocomplete="off">
                    <div id="bankBonusDistributorDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); top: 100%; left: 0; margin-top: 5px;"></div>
                    <small id="bankBonusDistributorStatus" style="color: #666; font-size: 0.85rem;"></small>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="bankBonusDate" required>
                </div>
                <div class="form-group">
                    <label>Amount (N$) *</label>
                    <input type="number" id="bankBonusAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Reason *</label>
                    <textarea id="bankBonusReason" rows="3" required placeholder="Reason for bank bonus payment..."></textarea>
                </div>
                <div class="form-group">
                    <label>Approved By *</label>
                    <input type="text" id="bankBonusApprovedBy" required placeholder="Manager name">
                </div>
                <div class="form-group">
                    <label>Bank Name *</label>
                    <select id="bankBonusBank" required>
                        <option value="">Select Bank</option>
                        <option value="FNB">First National Bank (FNB)</option>
                        <option value="Nedbank">Nedbank</option>
                        <option value="Bank Windhoek">Bank Windhoek</option>
                        <option value="Standard Bank">Standard Bank</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bank Branch *</label>
                    <input type="text" id="bankBonusBankBranch" required placeholder="e.g., Windhoek Main">
                </div>
                <div class="form-group">
                    <label>Account Number *</label>
                    <input type="text" id="bankBonusAccountNumber" required placeholder="e.g., 1234567890">
                </div>
                <div class="form-group">
                    <label>Account Type *</label>
                    <select id="bankBonusAccountType" required>
                        <option value="">Select Type</option>
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ðŸ¦ Record Bank Bonus</button>
                    <button type="button" class="btn" onclick="closeModal('bankBonusModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Z-Report Modal -->
    <div class="modal" id="zReportModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('zReportModal')">&times;</span>
            <h2>ðŸ“Š Daily Z-Report</h2>
            <div id="zReportContent">
                <!-- Will be populated by JavaScript -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="printZReport()">ðŸ–¨ï¸ Print Z-Report</button>
                <button class="btn btn-success" onclick="exportZReportCSV()">ðŸ“¥ Export CSV</button>
                <button class="btn" onclick="closeModal('zReportModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let users = [];
        let branches = [];
        
        // HR Portal Data
        let employees = [];
        let leaveRequests = [];
        let warnings = [];
        let terminations = [];
        let attendanceRecords = [];
        let performanceReviews = [];
        let reports = [];
        let expenses = [];
        let budgets = [];
        // Finance Portal Enhanced Data
        let bankDeposits = [];
        let cashBonuses = [];
        let bankBonuses = [];
        let cashShifts = [];
        let currentShift = null;
        let currentUser = null;
        let currentPortal = null;
        let currentClientId = null;
        let currentBranch = '';
        let uploadedPDF = null;
        let autoRefreshInterval = null;
        
        // Global Distributor selection (name + NB number) shared across portals
        let globalDistributor = null;

        function setGlobalDistributor(info) {
            try {
                globalDistributor = {
                    name: (info && (info.name || info.distributorName)) || '',
                    nbNumber: (info && (info.nbNumber || info.code)) || '',
                    phone: (info && (info.phone || info.mobile || info.mobileNo)) || ''
                };
                try { localStorage.setItem('globalDistributor', JSON.stringify(globalDistributor)); } catch (_) {}
                renderGlobalDistributorBadge();
            } catch (_) {}
        }

        function getGlobalDistributor() {
            try {
                if (globalDistributor && (globalDistributor.name || globalDistributor.nbNumber)) return globalDistributor;
                const saved = localStorage.getItem('globalDistributor');
                if (saved) {
                    globalDistributor = JSON.parse(saved);
                    return globalDistributor;
                }
            } catch (_) {}
            return null;
        }

        function clearGlobalDistributor() {
            try {
                globalDistributor = null;
                try { localStorage.removeItem('globalDistributor'); } catch (_) {}
                renderGlobalDistributorBadge();
                try { if (typeof clearSelectedReferral === 'function') clearSelectedReferral(); } catch (_) {}
            } catch (_) {}
        }

        function renderGlobalDistributorBadge() {
            const badge = document.getElementById('globalDistributorBadge');
            const clearBtn = document.getElementById('clearGlobalDistributorBtn');
            const gd = getGlobalDistributor();
            if (badge) {
                if (gd && gd.name && gd.nbNumber) {
                    badge.textContent = `Distributor: ${gd.name} | NB: ${gd.nbNumber}`;
                    badge.style.display = 'inline-block';
                    if (clearBtn) clearBtn.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'none';
                }
            }
            // Also update cart header if visible
            try { if (typeof updateShopCart === 'function') updateShopCart(); } catch (_) {}
        }

        // Initialize from saved selection on load
        (function initGlobalDistributor(){ try { getGlobalDistributor(); renderGlobalDistributorBadge(); } catch(_){} })();

        // Cash management
        let cashDrawer = {
            openingBalance: 0,
            currentBalance: 0,
            isOpen: false,
            openedBy: null,
            openedAt: null,
            drops: [],
            expenses: []
        };
        
        // Inventory tracking
        let inventory = {};
        
        // Initialize inventory from price list (called on login)
        function initializeInventory() {
            if (Object.keys(inventory).length === 0) {
                // Initialize from PRICE_LIST
                PRICE_LIST.forEach(product => {
                    inventory[product.description] = {
                        currentStock: 0,
                        reorderLevel: 5,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
                
                // Initialize packages
                Object.keys(PACKAGE_DATABASE).forEach(packageName => {
                    inventory[packageName] = {
                        currentStock: 0,
                        reorderLevel: 2,
                        lastUpdated: new Date().toISOString(),
                        history: []
                    };
                });
            }
        }

        // Reduce inventory programmatically for a list of products [{name, quantity}]
        function reduceInventoryForProducts(products, userFullName, reference) {
            if (!Array.isArray(products) || products.length === 0) return { success: true };
            initializeInventory();
            const errors = [];
            products.forEach(prod => {
                const productName = prod.name || prod.productName;
                const qty = parseInt(prod.quantity || 1);
                if (!productName || !qty) return;
                if (!inventory[productName]) {
                    errors.push(`Product not found in inventory: ${productName}`);
                    return;
                }
                const previousStock = inventory[productName].currentStock;
                if (previousStock < qty) {
                    errors.push(`Insufficient stock for ${productName} (have ${previousStock}, need ${qty})`);
                }
                const newStock = Math.max(0, previousStock - qty);
                inventory[productName].currentStock = newStock;
                inventory[productName].lastUpdated = new Date().toISOString();
                if (!inventory[productName].history) inventory[productName].history = [];
                inventory[productName].history.push({
                    action: 'remove',
                    quantity: qty,
                    previousStock: previousStock,
                    newStock: newStock,
                    user: userFullName || 'system',
                    timestamp: new Date().toISOString(),
                    reference: reference || ('SALE-' + Date.now())
                });
            });
            try {
                localStorage.setItem('dynapharm_inventory', JSON.stringify(inventory));
                // Broadcast stock update event for real-time sync across portals
                try {
                    const branchId = (currentUser && currentUser.branch) || 'unknown';
                    window.dispatchEvent(new CustomEvent('stock:updated', { 
                        detail: { branch: branchId, products: products, user: userFullName, reference } 
                    }));
                    // Publish to Railway gateway
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products, ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    // Also publish to Vercel SSE
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products, ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
            } catch (e) {
                console.warn('Inventory persistence warning:', e);
            }
            return { success: errors.length === 0, errors };
        }

        // Append a stock audit entry compatible with dyna_stock_audit used by stock APIs
        function appendStockAudit(action, details) {
            try {
                const key = 'dyna_stock_audit';
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                list.push({
                    id: 'AUD' + Date.now(),
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                });
                if (list.length > 5000) list.shift();
                localStorage.setItem(key, JSON.stringify(list));
            } catch (e) {
                console.warn('Audit append failed:', e);
            }
        }

        // FEFO-based deduction for prescription items using barcode/batch stock
        // products: [{ name, quantity }]
        async function fefoDispenseProducts(products, branchId, userFullName, reference) {
            const errors = [];
            const successes = [];
            try {
                if (!Array.isArray(products) || products.length === 0) return { success: true, errors: [], successes: [] };
                // Dynamic import ensures we don't hard-couple this file to modules at parse time
                const mod = await import('/web-modules/barcode-stock.js');
                for (const prod of products) {
                    const productName = (prod && (prod.name || prod.productName)) || '';
                    let needed = Number(prod && prod.quantity) || 0;
                    if (!productName || needed <= 0) continue;

                    // Get FEFO-ordered batches and enforce not expired
                    const fefo = mod.getFEFOStock(productName, needed);
                    if (!fefo || !fefo.success) {
                        errors.push(`No stock available for ${productName}`);
                        continue;
                    }
                    const batches = (fefo.data || []).filter(b => {
                        try {
                            const expiry = new Date((b.expiryDate || '') + '-01');
                            return expiry >= new Date();
                        } catch (_) {
                            return true; // if bad date, allow but module also guards quantity
                        }
                    });

                    for (const batch of batches) {
                        if (needed <= 0) break;
                        const available = Number(batch.remainingQuantity) || 0;
                        if (available <= 0) continue;
                        const take = Math.min(available, needed);
                        // Use sellStockByBarcode to model dispense (retail) and update batch
                        const sale = mod.sellStockByBarcode(batch.barcode, take, 'retail', branchId);
                        if (!sale || !sale.success) {
                            errors.push(`Failed to deduct ${take} of ${productName} from batch ${batch.batchNo || ''}`);
                            continue;
                        }
                        needed -= take;
                        successes.push({ product: productName, quantity: take, batchNo: batch.batchNo, barcode: batch.barcode });
                        appendStockAudit('dispense_fefo', {
                            reference: reference,
                            branch: branchId,
                            product: productName,
                            quantity: take,
                            batchNo: batch.batchNo,
                            barcode: batch.barcode,
                            user: userFullName || 'system'
                        });
                        try {
                            await recordStockMovement({
                                type: 'dispense',
                                product: productName,
                                quantity: take,
                                batchNo: batch.batchNo,
                                branchId: branchId,
                                reference: reference,
                                createdBy: userFullName || 'system'
                            });
                        } catch(_){}
                    }

                    if (needed > 0) {
                        errors.push(`Insufficient FEFO stock for ${productName} (short ${needed})`);
                    }
                }
            } catch (e) {
                errors.push('FEFO dispense error: ' + (e && e.message ? e.message : String(e)));
            }
            // Broadcast stock update event for real-time sync across portals
            if (products.length > 0) {
                try {
                    window.dispatchEvent(new CustomEvent('stock:updated', { 
                        detail: { branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), user: userFullName, reference } 
                    }));
                    // Publish to Railway gateway
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    // Also publish to Vercel SSE
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products: products.map(p => ({ name: p.name || p.productName, quantity: p.quantity || 1 })), ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
            }
            return { success: errors.length === 0, errors, successes };
        }

        // Record a department notification event for MIS/Finance/Stock/GM/Director
        function recordDepartmentEvent(eventType, payload) {
            const recipients = ['MIS', 'Finance', 'Stock', 'GM', 'Director'];
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            events.push({
                id: 'EVT-' + Date.now(),
                type: eventType,
                recipients: recipients,
                payload: payload,
                createdAt: new Date().toISOString(),
                createdBy: (window.currentUser && window.currentUser.fullName) || 'system'
            });
            localStorage.setItem('dyna_department_events', JSON.stringify(events));
        }
        
        // Generate and display daily operations report
        function openDailyReportWindow() {
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayEvents = events.filter(e => e.createdAt.startsWith(today));
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]').filter(s => s.timestamp && s.timestamp.startsWith(today));
            const dispensedPrescriptions = (reports || []).filter(r => r.dispensed && r.dispensedAt && r.dispensedAt.startsWith(today));
            const onlineOrdersLocal = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]').filter(o => (o.dispensedAt && o.dispensedAt.startsWith(today)) || ((o.date||'').startsWith(today) && (o.status==='paid' || o.status==='dispensed')));
            const allClients = clients || [];
            const totalSalesAmount = walkInSales.reduce((sum, s) => sum + (s.total || 0), 0) + dispensedPrescriptions.reduce((sum, r) => sum + (r.medicines || []).reduce((medsum, m) => medsum + (m.amountPaid || 0), 0), 0) + onlineOrdersLocal.reduce((sum, o) => sum + (o.total || 0), 0);

            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Operations Report - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                        .header { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
                        .header h1 { color: #c41e3a; margin: 0 0 10px 0; }
                        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
                        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #c41e3a; }
                        .kpi-card h3 { color: #666; font-size: 0.9rem; margin: 0 0 10px 0; text-transform: uppercase; }
                        .kpi-card .value { color: #c41e3a; font-size: 2rem; font-weight: bold; margin: 10px 0; }
                        .section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .section h2 { color: #c41e3a; border-bottom: 2px solid #c41e3a; padding-bottom: 10px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; color: #c41e3a; font-weight: bold; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 0.9rem; }
                        @media print { body { background: white; } .section { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ðŸ“Š DAILY OPERATIONS REPORT</h1>
                        <p>Dynapharm International Namibia</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')} | Generated: ${new Date().toLocaleString('en-GB')}</p>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <h3>Today's Sales</h3>
                            <div class="value">N$${totalSalesAmount.toFixed(2)}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Walk-in Sales</h3>
                            <div class="value">${walkInSales.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Online Sales</h3>
                            <div class="value">${onlineOrdersLocal.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Prescriptions Dispensed</h3>
                            <div class="value">${dispensedPrescriptions.length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>New Clients</h3>
                            <div class="value">${allClients.filter(c => c.timestamp && c.timestamp.startsWith(today)).length}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>Department Events</h3>
                            <div class="value">${todayEvents.length}</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>ðŸ“§ Department Events (Last 20)</h2>
                        <table>
                            <thead><tr><th>Time</th><th>Type</th><th>Details</th><th>Created By</th></tr></thead>
                            <tbody>
                                ${events.slice(-20).reverse().map(e => `<tr>
                                    <td>${new Date(e.createdAt).toLocaleString()}</td>
                                    <td>${e.type}</td>
                                    <td>${JSON.stringify(e.payload).substring(0, 50)}...</td>
                                    <td>${e.createdBy}</td>
                                </tr>`).join('') || '<tr><td colspan="4" style="text-align: center;">No events today</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>ðŸ›’ Recent Walk-in Sales</h2>
                        <table>
                            <thead><tr><th>Time</th><th>Customer</th><th>Branch</th><th>Amount</th></tr></thead>
                            <tbody>
                                ${walkInSales.slice(-10).reverse().map(s => `<tr>
                                    <td>${new Date(s.timestamp).toLocaleString()}</td>
                                    <td>${s.customerName}</td>
                                    <td>${s.branch}</td>
                                    <td>N$${(s.total || 0).toFixed(2)}</td>
                                </tr>`).join('') || '<tr><td colspan="4" style="text-align: center;">No sales today</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div class="footer">
                        <p>Report generated for: MIS, Finance, Stock, GM, Director</p>
                        <p style="margin-top: 10px;"><strong>HEALTH | WEALTH | FREEDOM</strong></p>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            win.document.write(reportHTML);
            win.document.close();
        }

        // View department events in a modal
        function viewDepartmentEvents() {
            const events = JSON.parse(localStorage.getItem('dyna_department_events') || '[]');
            if (events.length === 0) {
                alert('No department events recorded yet.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>ðŸ“§ Department Events Log</h2>
                    <div style="margin: 20px 0;">
                        <input type="text" id="eventsSearch" placeholder="Search events..." style="padding: 10px; width: 100%; margin-bottom: 10px;" onkeyup="filterEvents(this.value)">
                        <select id="eventsFilter" style="padding: 10px; width: 100%;" onchange="filterEvents(document.getElementById('eventsSearch').value)">
                            <option value="all">All Event Types</option>
                            <option value="walkin_sale">Walk-in Sales</option>
                            <option value="prescription_dispensed">Prescription Dispensed</option>
                        </select>
                    </div>
                    <div id="eventsList">${renderEventsList(events)}</div>
                </div>
            `;
            document.body.appendChild(modal);

            window.filterEvents = function(searchTerm) {
                const filterType = document.getElementById('eventsFilter').value;
                let filtered = events;
                if (filterType !== 'all') filtered = filtered.filter(e => e.type === filterType);
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    filtered = filtered.filter(e => JSON.stringify(e).toLowerCase().includes(search));
                }
                document.getElementById('eventsList').innerHTML = renderEventsList(filtered);
            };
        }

        function renderEventsList(events) {
            return events.reverse().map(e => `
                <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #c41e3a;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong style="color: #c41e3a;">${e.type}</strong>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">${new Date(e.createdAt).toLocaleString()}</p>
                            <p style="margin: 5px 0; color: #666;">By: ${e.createdBy}</p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #3498db;">View Details</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(e.payload, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Appointments tracking
        let appointments = [];
        
        // Visits tracking (created at check-in)
        let visits = [];
        
        // Time slots configuration
        let timeSlots = {
            morning: { start: '08:00', end: '12:00', interval: 30 },
            afternoon: { start: '13:00', end: '17:00', interval: 30 }
        };
        
        // Resources (consultants, dispensers, rooms)
        let resources = [];
        
        // Appointment reminders queue
        let reminderQueue = [];
        
        let lastDataHash = null;
        
        // API Configuration
        // IMPORTANT: Set your actual Railway/backend URL here
        // For now, this is commented out. Uncomment and update when you have a deployed backend.
        // const API_BASE = 'https://dynapharm-backend-production.up.railway.app/api';
        const API_BASE = '/api'; // Use Vercel serverless functions in production
        const API_BASE_LOCAL = '/api';
        const USE_OFFLINE_MODE = false; // Prefer online API; only fallback if truly offline

        // Safe JSON parse with default fallback
        function safeParseFromStorage(key, defaultJsonString) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return JSON.parse(defaultJsonString);
                const parsed = JSON.parse(raw);
                if (parsed === null || parsed === undefined) return JSON.parse(defaultJsonString);
                return parsed;
            } catch (e) {
                return JSON.parse(defaultJsonString);
            }
        }

        // Unified storage adapter (IndexedDB-first with localStorage fallback)
        const DYN_DB_NAME = 'DynapharmDB';
        const DYN_DB_VERSION = 3; // v3 adds 'stockMovements' store
        const DYN_CLIENTS_STORE = 'clients';
        const DYN_MOVEMENTS_STORE = 'stockMovements';

        let dynDb = null;

        function openDynDb() {
            if (dynDb) return Promise.resolve(dynDb);
            return new Promise((resolve, reject) => {
                let request;
                try {
                    request = indexedDB.open(DYN_DB_NAME, DYN_DB_VERSION);
                } catch (e) {
                    return reject(e);
                }
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { dynDb = request.result; resolve(dynDb); };
                request.onupgradeneeded = (event) => {
                    const dbu = event.target.result;
                    // Ensure clients store exists
                    if (!dbu.objectStoreNames.contains(DYN_CLIENTS_STORE)) {
                        const store = dbu.createObjectStore(DYN_CLIENTS_STORE, { keyPath: 'referenceNumber' });
                        try { store.createIndex('fullName', 'fullName', { unique: false }); } catch(_){}
                        try { store.createIndex('phone', 'phone', { unique: false }); } catch(_){}
                        try { store.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                    }
                    // Ensure stock movements store exists
                    if (!dbu.objectStoreNames.contains(DYN_MOVEMENTS_STORE)) {
                        const m = dbu.createObjectStore(DYN_MOVEMENTS_STORE, { keyPath: 'id' });
                        try { m.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                        try { m.createIndex('branchId', 'branchId', { unique: false }); } catch(_){}
                        try { m.createIndex('type', 'type', { unique: false }); } catch(_){}
                    }
                };
            });
        }

        async function dbGetAll(storeName) {
            try {
                const dbu = await openDynDb();
                return await new Promise((resolve, reject) => {
                    const tx = dbu.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            } catch (e) {
                return null;
            }
        }

        async function dbBulkPut(storeName, items) {
            const dbu = await openDynDb();
            await new Promise((resolve, reject) => {
                const tx = dbu.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                // Clear before bulk put to mirror current behavior
                const clearReq = store.clear();
                clearReq.onsuccess = () => {
                    (items || []).forEach((item) => { try { store.put(item); } catch(_){} });
                };
                clearReq.onerror = () => reject(clearReq.error);
            });
        }

        async function dbAdd(storeName, item) {
            const dbu = await openDynDb();
            await new Promise((resolve, reject) => {
                const tx = dbu.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                try { store.put(item); } catch (e) { reject(e); }
            });
        }

        // --- Stock Movements: record locally in IDB and attempt cloud sync ---
        function getGitHubTokenForWrites(){
            try { return (window.cloudStorage && window.cloudStorage.getStoredToken && window.cloudStorage.getStoredToken()) || ''; } catch(_){ return ''; }
        }

        function getPendingMovements(){
            try { return JSON.parse(localStorage.getItem('dyna_pending_movements')||'[]'); } catch(_){ return []; }
        }
        function setPendingMovements(list){
            try { localStorage.setItem('dyna_pending_movements', JSON.stringify(list||[])); } catch(_){ }
        }

        async function recordStockMovement(movement){
            const normalized = Object.assign({
                id: movement.id || ('MOV-' + Date.now() + '-' + Math.random().toString(36).slice(2,8)),
                createdAt: new Date().toISOString()
            }, movement);
            try { await dbAdd(DYN_MOVEMENTS_STORE, normalized); } catch(_){ }
            // queue for server write
            const pending = getPendingMovements(); pending.push(normalized); setPendingMovements(pending);
            // try sync in background
            try { trySyncPendingMovements(); } catch(_){ }
            return normalized;
        }

        async function trySyncPendingMovements(){
            const token = getGitHubTokenForWrites();
            if (!token) return false;
            let pending = getPendingMovements();
            if (!Array.isArray(pending) || pending.length === 0) return true;
            const keep = [];
            for (const mov of pending){
                try {
                    const resp = await fetch('/api/stock-movements', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'x-github-token': token },
                        body: JSON.stringify({ movement: mov })
                    });
                    if (!resp.ok) { keep.push(mov); }
                } catch(_){ keep.push(mov); }
            }
            setPendingMovements(keep);
            return keep.length === 0;
        }

        async function rebuildBranchStockFromMovements(){
            try {
                // Comprehensive stock calculation from ALL sources
                
                // 1. Fetch cloud movements
                let cloud = [];
                try {
                    const r = await fetch('/api/stock-movements');
                    if (r.ok) cloud = await r.json();
                } catch(_){ cloud = []; }
                
                // 2. Local queued movements
                const localPending = getPendingMovements();
                
                // 3. Local IDB movements
                let localDb = [];
                try { localDb = await dbGetAll(DYN_MOVEMENTS_STORE) || []; } catch(_){ localDb = []; }
                
                // 4. Barcode stock batches (by location)
                const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                
                // 5. Distribution history (warehouse â†’ branch)
                const distributionHistory = JSON.parse(localStorage.getItem('dyna_distribution_history') || '[]');
                
                // 6. Stock transfers (country â†’ warehouse â†’ branch)
                const stockTransfers = JSON.parse(localStorage.getItem('dyna_stock_transfers') || '[]');
                
                // Combine all movement records
                const all = ([]).concat(
                    Array.isArray(cloud)?cloud:[],
                    Array.isArray(localDb)?localDb:[],
                    Array.isArray(localPending)?localPending:[]
                );
                
                // Initialize branch stock object
                const branchStock = {};
                
                // Process movement records
                for (const m of all){
                    const type = (m && m.type) || '';
                    const product = (m && m.product) || m.description || '';
                    const qty = Number(m && m.quantity || 0);
                    if (!product || !qty) continue;
                    
                    if (type === 'receive' || type === 'distribution'){
                        const dest = m.destination || m.branchId || m.toBranch || 'unknown';
                        branchStock[dest] = branchStock[dest] || {};
                        branchStock[dest][product] = (branchStock[dest][product] || 0) + qty;
                    } else if (type === 'transfer'){
                        const from = m.source || m.branchId || m.fromWarehouse || 'unknown';
                        const to = m.destination || m.toBranch || 'unknown';
                        branchStock[from] = branchStock[from] || {};
                        branchStock[to] = branchStock[to] || {};
                        branchStock[from][product] = (branchStock[from][product] || 0) - qty;
                        branchStock[to][product] = (branchStock[to][product] || 0) + qty;
                    } else if (type === 'adjust'){
                        const b = m.branchId || m.location || 'unknown';
                        branchStock[b] = branchStock[b] || {};
                        branchStock[b][product] = (branchStock[b][product] || 0) + qty; // qty can be negative
                    } else if (type === 'dispense' || type === 'sale'){
                        const b = m.branchId || m.branch || 'unknown';
                        branchStock[b] = branchStock[b] || {};
                        branchStock[b][product] = (branchStock[b][product] || 0) - qty;
                    }
                }
                
                // Process barcode stock batches by location (for branches)
                const branchNames = ['windhoek', 'ondangwa', 'oshakati', 'rundu', 'walvis bay', 'swakopmund'];
                barcodeStock.forEach(batch => {
                    if (!batch.location || !batch.description) return;
                    const location = batch.location.toLowerCase();
                    
                    // Check if location is a branch
                    const isBranch = branchNames.some(branch => location.includes(branch));
                    if (isBranch) {
                        const branchId = branchNames.find(b => location.includes(b)) || location;
                        branchStock[branchId] = branchStock[branchId] || {};
                        branchStock[branchId][batch.description] = (branchStock[branchId][batch.description] || 0) + (batch.remainingQuantity || 0);
                    }
                });
                
                // Process distribution history (warehouse â†’ branch)
                distributionHistory.forEach(dist => {
                    if (!dist.branch || !dist.product || !dist.quantity) return;
                    const branchId = dist.branch.toLowerCase();
                    branchStock[branchId] = branchStock[branchId] || {};
                    branchStock[branchId][dist.product] = (branchStock[branchId][dist.product] || 0) + Number(dist.quantity || 0);
                });
                
                // Process stock transfers (warehouse â†’ branch)
                stockTransfers.forEach(transfer => {
                    if (!transfer.toBranch || !transfer.items) return;
                    const branchId = transfer.toBranch.toLowerCase();
                    branchStock[branchId] = branchStock[branchId] || {};
                    
                    if (Array.isArray(transfer.items)) {
                        transfer.items.forEach(item => {
                            const product = item.product || item.name || item.description || '';
                            const qty = Number(item.quantity || 0);
                            if (product && qty > 0) {
                                branchStock[branchId][product] = (branchStock[branchId][product] || 0) + qty;
                            }
                        });
                    }
                });
                
                // Save calculated branch stock
                localStorage.setItem('dyna_branch_stock', JSON.stringify(branchStock));
                
                // Trigger event for real-time updates
                window.dispatchEvent(new CustomEvent('branch_stock:updated', { 
                    detail: { branchStock, timestamp: new Date().toISOString() } 
                }));
                
            } catch(error){ 
                console.error('Error rebuilding branch stock from movements:', error);
            }
        }

        // background timers
        setInterval(() => { try { trySyncPendingMovements(); } catch(_){} }, 15000);
        setInterval(() => { try { rebuildBranchStockFromMovements(); } catch(_){} }, 20000);
        // initial kick
        setTimeout(() => { try { trySyncPendingMovements(); rebuildBranchStockFromMovements(); } catch(_){} }, 1200);

        // Adapter: Clients
        async function loadClientsAdapter() {
            // Try DB first
            const fromDb = await dbGetAll(DYN_CLIENTS_STORE);
            if (Array.isArray(fromDb)) return fromDb;
            // Fallback to localStorage
            return safeParseFromStorage('dyna_clients', '[]');
        }

        async function saveAllClientsAdapter(list) {
            try {
                if (Array.isArray(list)) {
                    await dbBulkPut(DYN_CLIENTS_STORE, list);
                }
            } catch(_) {}
            try { localStorage.setItem('dyna_clients', JSON.stringify(list || [])); } catch(_) {}
        }

        async function addClientAdapter(client) {
            const now = new Date().toISOString();
            const record = { createdAt: now, ...client };
            try { await dbAdd(DYN_CLIENTS_STORE, record); } catch(_) {}
            try {
                const ls = safeParseFromStorage('dyna_clients', '[]');
                ls.push(record);
                localStorage.setItem('dyna_clients', JSON.stringify(ls));
            } catch(_) {}
            return { success: true };
        }

        // One-time migration from localStorage to IndexedDB for clients
        async function migrateClientsToIndexedDBIfNeeded() {
            try {
                const flagKey = 'migrated_clients_to_idb_v2';
                if (localStorage.getItem(flagKey) === 'true') return;
                const lsClients = safeParseFromStorage('dyna_clients', '[]');
                const dbClients = await dbGetAll(DYN_CLIENTS_STORE);
                if ((dbClients || []).length === 0 && (lsClients || []).length > 0) {
                    await dbBulkPut(DYN_CLIENTS_STORE, lsClients);
                    localStorage.setItem(flagKey, 'true');
                } else {
                    localStorage.setItem(flagKey, 'true');
                }
            } catch(_) {}
        }

        // Load persisted appointments/visits on startup (if present)
        try {
            const storedAppointments = localStorage.getItem('dyna_appointments');
            if (storedAppointments) { appointments = JSON.parse(storedAppointments) || []; }
        } catch(e) {}
        try {
            const storedVisits = localStorage.getItem('dyna_visits');
            if (storedVisits) { visits = JSON.parse(storedVisits) || []; }
        } catch(e) {}

        const DEFAULT_USERS_JSON = '[{"id":"USR001","username":"admin","password":"walker33","fullName":"Administrator","email":"admin@dynapharm.com.na","phone":"061-300877","role":"admin","branch":"townshop","branches":["townshop"]},{"id":"USR1759829667953","username":"moses","password":"walker33","fullName":"MOSES MUKISA","email":"mosesmukisa1@gmail.com","phone":"0817317160","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-07T09:34:27.953Z"},{"id":"USR1759829814781","username":"Geneva","password":"Pearl_11","fullName":"Jennifer Joseph","email":"shange1124@gmail.com","phone":"0852803618","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-07T09:36:54.781Z"},{"id":"USR1759830625722","username":"NAEM","password":"PASSWORD","fullName":"NAEM HANGULA","email":"naemhangula4@gmail.com","phone":"0817499757","role":"dispenser","branch":"townshop","branches":["townshop"],"createdAt":"2025-10-07T09:50:25.722Z"},{"id":"USR1759928153488","username":"GEINGOS","password":"ALBERTO99","fullName":"HILMA C","email":"geingoshilma@gmail","phone":"0814137106","role":"consultant","branch":"townshop","branches":["townshop","khomasdal","katima","outapi","ondangwa","okongo","okahao","nkurenkuru","swakopmund","hochland-park","rundu","gobabis","walvisbay","eenhana","otjiwarongo"],"createdAt":"2025-10-08T12:55:53.488Z"},{"id":"USR2000000000001","username":"stock","password":"stock123","fullName":"Stock Manager","email":"stock@dynapharm.com.na","phone":"0812000000","role":"stock","branch":"townshop","branches":["townshop"],"createdAt":"2025-01-20T10:00:00.000Z"},{"id":"USR2000000000002","username":"mis","password":"mis123","fullName":"MIS Manager","email":"mis@dynapharm.com.na","phone":"0813000000","role":"mis","branch":"townshop","branches":["townshop"],"createdAt":"2025-01-20T10:00:00.000Z"}]';

        const DEFAULT_BRANCHES_JSON = '[{"id":"townshop","name":"TOWNSHOP (Head Office)","location":"Shop No.1 Continental Building Independence Avenue - Windhoek","phone":"814683999"},{"id":"khomasdal","name":"KHOMASDAL DPC","location":"Shop No.2 Khomasdal Funky Town - Windhoek","phone":"814682991"},{"id":"katima","name":"KATIMA DPC","location":"Opposite Open Market Hospital Road, Katima","phone":"817375818"},{"id":"outapi","name":"OUTAPI DPC","location":"Okasilili Location in Christmas Building, Next Tolemeka Garage Main Road Oshakati - Outapi","phone":"814685886"},{"id":"ondangwa","name":"ONDANGWA DPC","location":"Shop No.3 Woerman Block Oluno, Opposite Fresco, Cash and Carry Entrance Ondangwa","phone":"814685882"},{"id":"okongo","name":"OKONGO DPC","location":"Handongo Festus Erf 333 Okongo Village Council","phone":"814684935"},{"id":"okahao","name":"OKAHAO DPC","location":"Iteka complex opposite Pep store Okahao - Oshakati main road","phone":"814683963"},{"id":"nkurenkuru","name":"NKURENKURU DPC","location":"Total Service Station, Next to Oluno Bar - Nkurenkuru","phone":"814684939"},{"id":"swakopmund","name":"SWAKOPMUND DPC","location":"Opposite Mondesa Usave Swakopmund","phone":"814686806"},{"id":"hochland-park","name":"HOCHLAND PARK","location":"House No.2 Robin Road, Taubern Glain Street, Next to OK Food Windhoek","phone":"813207195"},{"id":"rundu","name":"RUNDU DPC","location":"Shop No.6 Fish Building opposite, Dr. Romanus Kampungi Stadium","phone":"814050125"},{"id":"gobabis","name":"GOBABIS","location":"Shop No. Church Street Woerman Complex Gobabis","phone":"814685905"},{"id":"walvisbay","name":"WALVISBAY","location":"Shop No.6 Pelican Mall Shop Sam Nujoma Avenue","phone":"814685894"},{"id":"eenhana","name":"EENHANA","location":"Shop No.3 Tangi Complex, Next to Namibia Funeral Supply, Dimo Amaambo Street Eenhana","phone":"814682049"},{"id":"otjiwarongo","name":"OTJIWARONGO DPC","location":"Erindi Complex next to Spar","phone":"814681997"}]';

        // Official Price List - June 2025
        const PRICE_LIST = [
            {description: "ARABICA COFFEE MIX W/GOAT'S AND GANO 25gx20's", dp: 260, cp: 320, bv: 43},
            {description: "BEE POLEN CAPSULE (30's)", dp: 182, cp: 237, bv: 32},
            {description: "BEE POLLEN CAPSULE (100's)", dp: 320, cp: 390, bv: 75},
            {description: "BODY CONTOUR CREAM", dp: 290, cp: 377, bv: 75},
            {description: "COMPACT POWDER 12g", dp: 190, cp: 247, bv: 55},
            {description: "D.I GROW (GREEN) (1 LITER)", dp: 300, cp: 390, bv: 38},
            {description: "D.I GROW (GREEN) (4LITERS)", dp: 650, cp: 780, bv: 115},
            {description: "D.I GROW (RED) (1 LITER)", dp: 240, cp: 312, bv: 38},
            {description: "D.I GROW (RED) (4LITERS)", dp: 560, cp: 728, bv: 115},
            {description: "D.I GROW BIO-8 1 LTR", dp: 220, cp: 286, bv: 27},
            {description: "D.I GROW K 1 LTR", dp: 220, cp: 286, bv: 30},
            {description: "D.I. INSTANT GOAT'S MILK POWDER PREMIX 20's x 21g", dp: 325, cp: 400, bv: 43},
            {description: "D.I. INSTANT SOYBEAN MIXTURE WITH GINGER 25g x 20'", dp: 221, cp: 287, bv: 38},
            {description: "DI LIQUID ALFALFA PLUS GUARANA (500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI LIQUID ALFALFAPLUS GUARANA (150ml)", dp: 200, cp: 260, bv: 21},
            {description: "DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml", dp: 430, cp: 530, bv: 75},
            {description: "Di Liquid Alpha Alpha 500ml", dp: 430, cp: 530, bv: 75},
            {description: "DI NONI 500ml", dp: 350, cp: 455, bv: 110},
            {description: "DI NONI JUICE 1 L", dp: 750, cp: 950, bv: 175},
            {description: "DYNA C- 100 TABLET 150's", dp: 140, cp: 182, bv: 32},
            {description: "DYNA C- 250 TABLET 90's", dp: 140, cp: 182, bv: 27},
            {description: "DYNA 'S' TABLET 120's", dp: 290, cp: 360, bv: 65},
            {description: "DYNA SERENOA TABLET 100's", dp: 520, cp: 620, bv: 115},
            {description: "DYNA SERENOA TABLET 30's", dp: 195, cp: 254, bv: 38},
            {description: "DYNA TONIC (150ml)", dp: 208, cp: 270, bv: 27},
            {description: "DYNA TONIC (780ml)", dp: 600, cp: 710, bv: 120},
            {description: "DYNA TOOTHBRUSH (SET 3 OF 3)", dp: 70, cp: 91, bv: 15},
            {description: "DYNA-RH CAPSULE 100's", dp: 300, cp: 390, bv: 60},
            {description: "E-VITA CREAM (50g)", dp: 610, cp: 700, bv: 165},
            {description: "GANODERMA LOTION 150ML", dp: 182, cp: 237, bv: 38},
            {description: "GANODERMA SHOWER GEL 150ml(GANODERMA BODY SCRUB)", dp: 220, cp: 285, bv: 38},
            {description: "GANODERMA SOAP 2 x 100g", dp: 140, cp: 182, bv: 30},
            {description: "GANODERMA TOOTHPASTE (150g)", dp: 150, cp: 194, bv: 20},
            {description: "GINALI CAPSULE 100's", dp: 403, cp: 493, bv: 80},
            {description: "GINALI CAPSULE 30's", dp: 195, cp: 254, bv: 38},
            {description: "GINSENG CAPSULE 9 x 10's", dp: 546, cp: 655, bv: 115},
            {description: "GOAT'S MILK SOAP (100g)", dp: 70, cp: 91, bv: 15},
            {description: "GOAT'S MILK TABLET 150's", dp: 286, cp: 372, bv: 48},
            {description: "GOAT'S MILK TABLET 75's", dp: 170, cp: 221, bv: 27},
            {description: "GREEN TEA CAPSULE 30's", dp: 195, cp: 254, bv: 43},
            {description: "GREEN TEA CAPSULE 60's", dp: 344, cp: 430, bv: 85},
            {description: "HERBA WARISAN MAHARANI 6 x 10g", dp: 520, cp: 620, bv: 110},
            {description: "HIGH FIBER NUTRITION FOOD 30'sx25g", dp: 660, cp: 790, bv: 120},
            {description: "INSTANT CAPPUCCINO W/ GANO 15's x 35g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT CEREAL 15's x 32g", dp: 325, cp: 423, bv: 48},
            {description: "INSTANT CEREAL 30's x 32g", dp: 510, cp: 610, bv: 95},
            {description: "INSTANT CHOC W/ GANO 30's x 30g", dp: 325, cp: 423, bv: 43},
            {description: "INSTANT COFFEE MIX W/GANODERMA, COLLAGEN & KACIP", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE MIX W/TONGKAT & MACA POWDER(15'sx21g)", dp: 250, cp: 300, bv: 38},
            {description: "Tongkat Ali & Maca - C", dp: 250, cp: 300, bv: 38},
            {description: "INSTANT COFFEE MIX WITH GANODERMA 4-IN-1(SACHET) (20's x 21g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GANO, GREEN TEA 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ GINKGO & GINSENG 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/ TONGKAT ALI 20's x 21g", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT COFFEE W/GANO & TONGKAT ALI BLACK 30's x 5g", dp: 276, cp: 359, bv: 59},
            {description: "INSTANT GINSENG HONEY GINGER 500g", dp: 350, cp: 420, bv: 43},
            {description: "INSTANT PEGAGA CAFÃ‰ 25G x 15s", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT PREMIX COFFEE WITH MANGOSTEEN(25'sx15g)", dp: 260, cp: 320, bv: 38},
            {description: "INSTANT WHEATGRASS W/ CHLOROPHYLL 20's x 10g", dp: 286, cp: 372, bv: 43},
            {description: "MILK TEA WITH TONGKAT ALI 21g x 20's", dp: 230, cp: 290, bv: 43},
            {description: "MILK THISTLE TABLET 120's", dp: 500, cp: 592, bv: 125},
            {description: "MILK THISTLE TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "MINERAL POT", dp: 1250, cp: 1625, bv: 265},
            {description: "Nano Home Feminine Wash Antiseptic w/ Sirih 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "Nano Home Feminine Wash Kacip Fatimah 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME FEMININE WASH with GAMAT 60ml", dp: 100, cp: 130, bv: 11.5},
            {description: "NANO HOME GAMAT SOAP 100g", dp: 70, cp: 91, bv: 15},
            {description: "NANO HOME PEGAGA SOAP 100g", dp: 70, cp: 91, bv: 8},
            {description: "NONI PLUS TEA 30's x 3g", dp: 299, cp: 360, bv: 65},
            {description: "NUTMEG OINTMENT (2's x 20g)", dp: 180, cp: 234, bv: 19.5},
            {description: "PRESIDENT'S CHOICE 4 IN 1 AND CHOCOLATE COFFEE 20'", dp: 288, cp: 374, bv: 43},
            {description: "PRO- LSB TABLET 150's", dp: 455, cp: 573, bv: 100},
            {description: "PROLINK 20's x 20g", dp: 588, cp: 688, bv: 135},
            {description: "PROLINK 30's x 20g", dp: 600, cp: 719, bv: 170},
            {description: "RED COFFEE W/ GINSENG (12's x 25g)", dp: 260, cp: 320, bv: 38},
            {description: "REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150},
            {description: "SEA CUCUMBER JELLY (250ml)", dp: 312, cp: 406, bv: 55},
            {description: "SEA CUCUMBER JELLY (500ml)", dp: 533, cp: 633, bv: 110},
            {description: "SEA WATER SPIRULINA POWDER 500g", dp: 340, cp: 420, bv: 48},
            {description: "SOYBEAN POWDER 454g", dp: 260, cp: 338, bv: 38},
            {description: "SPIRULINA TABLET (1,000's)", dp: 750, cp: 900, bv: 150},
            {description: "SPIRULINA TABLET (100's)", dp: 208, cp: 270, bv: 27},
            {description: "SPIRULINA TABLET (300's)", dp: 351, cp: 456, bv: 64},
            {description: "TEA TREE OIL FEMININE WASH (250ml)", dp: 190, cp: 247, bv: 43},
            {description: "TEA TREE OIL LOTION (250ml)", dp: 180, cp: 234, bv: 19.5},
            {description: "TEA TREE OIL TOOTHPASTE (175g)", dp: 150, cp: 194, bv: 20},
            {description: "TONGKAT ALI CAPSULE 100's", dp: 400, cp: 490, bv: 80},
            {description: "TONGKAT ALI CAPSULE 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEGANO CAPSULE 30's", dp: 195, cp: 254, bv: 27},
            {description: "YEEGANO CAPSULE 90's", dp: 364, cp: 454, bv: 75},
            {description: "Yeeginako Tabs 90's , 30's", dp: 364, cp: 454, bv: 75},
            {description: "YEEGARLIC CAPSULE 90's", dp: 300, cp: 390, bv: 64},
            {description: "YEEGINKGO TABLET (30's)", dp: 234, cp: 304, bv: 27},
            {description: "YEEGINKGO TABLETS 90's", dp: 420, cp: 500, bv: 80},
            {description: "YEEYANGYEN TABLET 30's", dp: 195, cp: 254, bv: 32},
            {description: "YEEYANGYEN TABLET 90's", dp: 370, cp: 455, bv: 90}
        ];
        
        // Make PRICE_LIST globally accessible
        if (typeof window !== 'undefined') {
            window.PRICE_LIST = PRICE_LIST;
        }

        // Price lookup function with package support
        function findProductPrice(productName) {
            if (!productName) return {description: productName, dp: 0, cp: 0, bv: 0};
            
            // First check if it's a package - exact match
            if (PACKAGE_DATABASE.hasOwnProperty(productName)) {
                const packageData = PACKAGE_DATABASE[productName];
                return {
                    description: productName,
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            // Try fuzzy matching for packages (e.g., "Blood Circulation Package" -> "Blood Circulation Pack")
            const normalizedProductName = productName.toLowerCase().trim();
            const packageMatch = Object.keys(PACKAGE_DATABASE).find(key => {
                const normalizedKey = key.toLowerCase().trim();
                return normalizedKey === normalizedProductName ||
                       normalizedKey.replace(/pack/g, 'package') === normalizedProductName ||
                       normalizedProductName.replace(/pack/g, 'package') === normalizedKey ||
                       normalizedKey.replace(/\s+/g, '') === normalizedProductName.replace(/\s+/g, '');
            });
            
            if (packageMatch) {
                const packageData = PACKAGE_DATABASE[packageMatch];
                return {
                    description: packageMatch, // Return the correct package name
                    dp: packageData.price.dp,
                    cp: packageData.price.cp,
                    bv: packageData.price.bv,
                    isPackage: true,
                    products: packageData.products.map(p => p.name)
                };
            }
            
            const searchName = productName.toLowerCase().trim();
            
            // Normalize the search name (remove special chars, extra spaces)
            const normalizedSearch = searchName.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
            
            // First try exact match
            let product = PRICE_LIST.find(p => 
                p.description.toLowerCase() === searchName
            );
            
            // Try normalized exact match
            if (!product) {
                product = PRICE_LIST.find(p => {
                    const normalizedDesc = p.description.toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
                    return normalizedDesc === normalizedSearch;
                });
            }
            
            // Try keyword matching (all keywords must be present)
            if (!product) {
                const keywords = normalizedSearch.split(' ').filter(w => w.length > 2);
                product = PRICE_LIST.find(p => {
                    const desc = p.description.toLowerCase();
                    return keywords.every(keyword => desc.includes(keyword));
                });
            }
            
            // Try partial match (most similar)
            if (!product) {
                const matches = PRICE_LIST.filter(p => {
                    const desc = p.description.toLowerCase();
                    return desc.includes(normalizedSearch) || normalizedSearch.includes(desc);
                });
                
                if (matches.length > 0) {
                    // Return the best match (shortest description usually more specific)
                    product = matches.reduce((best, current) => 
                        current.description.length < best.description.length ? current : best
                    );
                }
            }
            
            // Log if product not found for debugging (only once per product name)
            if (!product && typeof window !== 'undefined') {
                if (!window._missingProducts) window._missingProducts = new Set();
                if (!window._missingProducts.has(productName)) {
                    window._missingProducts.add(productName);
                    console.debug(`Product not found in price list: "${productName}"`);
                }
            }
            
            return product || {description: productName, dp: 0, cp: 0, bv: 0};
        }

        // Calculate prescription totals with member/referral pricing and consultation fees
        function calculatePrescriptionTotals(medicines, clientMembershipStatus = 'referred') {
            // Get consultation fee based on membership status
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            
            // Initialize totals with consultation fee
            let totalDP = clientMembershipStatus === 'member' ? consultationFee : 0;
            let totalCP = clientMembershipStatus === 'member' ? 0 : consultationFee;
            let totalBV = 0;
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let pendingDP = 0, pendingCP = 0, pendingBV = 0;
            let paidDP = 0, paidCP = 0, paidBV = 0;
            let outstandingDP = 0, outstandingCP = 0, outstandingBV = 0;

            medicines.forEach(med => {
                const price = findProductPrice(med.name);
                const quantity = med.quantity || 1; // Get quantity, default to 1
                
                // Check if it's a package and calculate based on dispensed items
                let effectivePrice;
                let packageFullPrice = { dp: 0, cp: 0, bv: 0 };
                let packageDispensedPrice = { dp: 0, cp: 0, bv: 0 };
                let packagePendingPrice = { dp: 0, cp: 0, bv: 0 };
                
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                    
                    // Get full package price
                if (clientMembershipStatus === 'member') {
                        packageFullPrice = { 
                            dp: packagePricing.packageTotal.dp * quantity, 
                            cp: packagePricing.packageTotal.cp * quantity, 
                            bv: packagePricing.packageTotal.bv * quantity 
                        };
                        packageDispensedPrice = { 
                            dp: packagePricing.dp * quantity, 
                            cp: packagePricing.cp * quantity, 
                            bv: packagePricing.bv * quantity 
                        };
                    } else {
                        packageFullPrice = { 
                            dp: 0, 
                            cp: packagePricing.packageTotal.cp * quantity, 
                            bv: 0 
                        };
                        packageDispensedPrice = { 
                            dp: 0, 
                            cp: packagePricing.cp * quantity, 
                            bv: 0 
                        };
                    }
                    
                    // Calculate pending price (full package - dispensed items)
                    packagePendingPrice.dp = packageFullPrice.dp - packageDispensedPrice.dp;
                    packagePendingPrice.cp = packageFullPrice.cp - packageDispensedPrice.cp;
                    packagePendingPrice.bv = packageFullPrice.bv - packageDispensedPrice.bv;
                    
                    effectivePrice = packageDispensedPrice; // For dispensed calculation
                } else {
                    // Individual product pricing
                    if (clientMembershipStatus === 'member') {
                    effectivePrice = { 
                        dp: price.dp * quantity, 
                        cp: price.cp * quantity, 
                        bv: price.bv * quantity 
                    };
                } else {
                    effectivePrice = { 
                        dp: 0, 
                        cp: price.cp * quantity, 
                        bv: 0 
                    };
                    }
                }
                
                // Add to totals
                if (price.isPackage) {
                    totalDP += packageFullPrice.dp;
                    totalCP += packageFullPrice.cp;
                    totalBV += packageFullPrice.bv;
                    
                    // Add dispensed items
                    dispensedDP += packageDispensedPrice.dp;
                    dispensedCP += packageDispensedPrice.cp;
                    dispensedBV += packageDispensedPrice.bv;
                    
                    // Add pending items
                    pendingDP += packagePendingPrice.dp;
                    pendingCP += packagePendingPrice.cp;
                    pendingBV += packagePendingPrice.bv;
                    
                    // For packages, check payment on dispensed items
                    if (med.paid) {
                        paidDP += packageDispensedPrice.dp;
                        paidCP += packageDispensedPrice.cp;
                        paidBV += packageDispensedPrice.bv;
                    } else {
                        outstandingDP += packageDispensedPrice.dp;
                        outstandingCP += packageDispensedPrice.cp;
                        outstandingBV += packageDispensedPrice.bv;
                    }
                } else {
                totalDP += effectivePrice.dp;
                totalCP += effectivePrice.cp;
                totalBV += effectivePrice.bv;

                if (med.dispensed) {
                    dispensedDP += effectivePrice.dp;
                    dispensedCP += effectivePrice.cp;
                    dispensedBV += effectivePrice.bv;
                    
                    // Check if payment is recorded
                    if (med.paid) {
                        paidDP += effectivePrice.dp;
                        paidCP += effectivePrice.cp;
                        paidBV += effectivePrice.bv;
                    } else {
                        outstandingDP += effectivePrice.dp;
                        outstandingCP += effectivePrice.cp;
                        outstandingBV += effectivePrice.bv;
                    }
                } else {
                    pendingDP += effectivePrice.dp;
                    pendingCP += effectivePrice.cp;
                    pendingBV += effectivePrice.bv;
                    }
                }
            });
            
            // Add consultation fee to appropriate categories
            const hasDispensedItems = medicines.some(m => {
                if (m.dispensed) return true;
                const price = findProductPrice(m.name);
                if (price.isPackage) {
                    const packagePricing = calculatePackagePricing(m, clientMembershipStatus);
                    return packagePricing.dispensedCount > 0;
                }
                return false;
            });
            
            if (hasDispensedItems) {
                // At least one medicine or package item dispensed, add consultation fee to dispensed and paid
                if (clientMembershipStatus === 'member') {
                    dispensedDP += consultationFee;
                    paidDP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                } else {
                    dispensedCP += consultationFee;
                    paidCP += consultationFee; // Consultation fee is considered paid when any item is dispensed
                }
            } else {
                // No medicines dispensed yet, add consultation fee to pending
                if (clientMembershipStatus === 'member') {
                    pendingDP += consultationFee;
                } else {
                    pendingCP += consultationFee;
                }
            }

            return {
                total: { dp: totalDP, cp: totalCP, bv: totalBV },
                dispensed: { dp: dispensedDP, cp: dispensedCP, bv: dispensedBV },
                pending: { dp: pendingDP, cp: pendingCP, bv: pendingBV },
                paid: { dp: paidDP, cp: paidCP, bv: paidBV },
                outstanding: { dp: outstandingDP, cp: outstandingCP, bv: outstandingBV }
            };
        }

        // Update existing reports with new pricing
        async function updateExistingReportsPricing() {
            try {
                console.log('Updating existing reports with new pricing...');
                
                // Get all reports
                await loadData();
                
                let updatedCount = 0;
                
                // Update each report
                for (let report of reports) {
                    if (report.medicines && report.medicines.length > 0) {
                        let reportUpdated = false;
                        
                        // Update pricing for each medicine in the report
                        report.medicines.forEach(med => {
                            // First, try to match package names for existing reports
                            let medicineName = med.name;
                            let matchedPackage = null;
                            
                            // Check if this is a package that needs name matching
                            const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                                key.toLowerCase().includes(medicineName.toLowerCase()) || 
                                medicineName.toLowerCase().includes(key.toLowerCase()) ||
                                medicineName.toLowerCase().replace(/\s+/g, '') === key.toLowerCase().replace(/\s+/g, '')
                            );
                            
                            if (possibleMatch && PACKAGE_DATABASE[possibleMatch]) {
                                console.log(`Found package match: "${medicineName}" -> "${possibleMatch}"`);
                                medicineName = possibleMatch;
                                med.name = possibleMatch; // Update the medicine name
                                matchedPackage = PACKAGE_DATABASE[possibleMatch];
                                reportUpdated = true;
                            }
                            
                            const newPrice = findProductPrice(medicineName);
                            
                            // Update the medicine with current pricing
                            if (newPrice && (newPrice.dp !== 0 || newPrice.cp !== 0)) {
                                med.currentPrice = {
                                    dp: newPrice.dp,
                                    cp: newPrice.cp,
                                    bv: newPrice.bv,
                                    isPackage: newPrice.isPackage || false,
                                    updatedAt: new Date().toISOString()
                                };
                                
                                // Initialize packageStatus for package medicines if it doesn't exist
                                if (newPrice.isPackage && !med.packageStatus) {
                                    med.packageStatus = {};
                                    console.log(`Initialized packageStatus for ${medicineName} in report ${report.id}`);
                                    reportUpdated = true;
                                }
                                
                                reportUpdated = true;
                            }
                        });
                        
                        if (reportUpdated) {
                            // Update the report in backend
                            try {
                                const result = await apiRequest('/reports', 'PUT', report);
                                if (result.success) {
                                    updatedCount++;
                                    console.log(`Updated pricing for report: ${report.id}`);
                                }
                            } catch (error) {
                                console.error(`Error updating report ${report.id}:`, error);
                            }
                        }
                    }
                }
                
                console.log(`Successfully updated pricing for ${updatedCount} reports`);
                
                // Refresh the display
                if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'consultant') {
                    await displayMyReports();
                }
                
                alert(`âœ… Successfully updated ${updatedCount} reports with new pricing and package functionality!`);
                
                return updatedCount;
            } catch (error) {
                console.error('Error updating existing reports pricing:', error);
                alert('âŒ Error updating reports. Please try again.');
                return 0;
            }
        }

        // Fix existing client NB numbers to follow new format
        async function fixExistingClientNBNumbers() {
            try {
                console.log('Fixing existing client NB numbers...');
                
                // Get all clients
                await loadData();
                
                let fixedCount = 0;
                
                // Fix each client's referral NB number if needed
                for (let client of clients) {
                    if (client.membershipStatus === 'referred' && client.referralNbNumber) {
                        // Check if the referral NB number needs fixing
                        if (!/^NB[0-9]+$/.test(client.referralNbNumber)) {
                            // Try to fix common patterns
                            let fixedNB = client.referralNbNumber;
                            
                            // If it's just digits, add NB prefix
                            if (/^[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB;
                            }
                            // If it starts with 'Nb' (lowercase), capitalize it
                            else if (/^Nb[0-9]+$/.test(fixedNB)) {
                                fixedNB = 'NB' + fixedNB.substring(2);
                            }
                            
                            // If we made a change, update the client
                            if (fixedNB !== client.referralNbNumber) {
                                client.referralNbNumber = fixedNB;
                                client.lastUpdated = new Date().toISOString();
                                client.updatedBy = currentUser ? currentUser.fullName : 'System';
                                
                                // Update in backend
                                try {
                                    const result = await apiRequest('/clients', 'PUT', client);
                                    if (result.success) {
                                        fixedCount++;
                                        console.log(`Fixed NB number for client: ${client.fullName} - ${client.referralNbNumber}`);
                                    }
                                } catch (error) {
                                    console.error(`Error updating client ${client.referenceNumber}:`, error);
                                }
                            }
                        }
                    }
                }
                
                if (fixedCount > 0) {
                    alert(`âœ… Successfully fixed ${fixedCount} client NB numbers to follow the new format!`);
                } else {
                    alert('âœ… All client NB numbers are already in the correct format!');
                }
                
                return fixedCount;
            } catch (error) {
                console.error('Error fixing client NB numbers:', error);
                alert('âŒ Error fixing client NB numbers. Please try again.');
                return 0;
            }
        }

        // Run all system maintenance fixes
        async function runSystemMaintenance() {
            try {
                if (!confirm('This will fix all existing data to work with the new system. Continue?')) {
                    return;
                }
                
                console.log('Running system maintenance...');
                
                // Fix NB numbers first
                const nbFixed = await fixExistingClientNBNumbers();
                
                // Then fix package pricing
                const pricingFixed = await updateExistingReportsPricing();
                
                alert(`âœ… System maintenance completed!\n\nâ€¢ Fixed ${nbFixed} client NB numbers\nâ€¢ Fixed ${pricingFixed} reports with package pricing\n\nAll existing data is now compatible with the new system!`);
                
            } catch (error) {
                console.error('Error running system maintenance:', error);
                alert('âŒ Error running system maintenance. Please try again.');
            }
        }

        // Function to ensure all new reports use updated pricing
        function validateReportPricing(report) {
            if (!report.medicines || report.medicines.length === 0) return report;
            
            // Update each medicine with current pricing
            report.medicines.forEach(med => {
                const currentPrice = findProductPrice(med.name);
                if (currentPrice && (currentPrice.dp !== 0 || currentPrice.cp !== 0)) {
                    med.currentPrice = {
                        dp: currentPrice.dp,
                        cp: currentPrice.cp,
                        bv: currentPrice.bv,
                        isPackage: currentPrice.isPackage || false,
                        updatedAt: new Date().toISOString()
                    };
                }
            });
            
            return report;
        }

        // Handle membership status change
        function handleMembershipStatusChange() {
            const membershipSelect = document.getElementById('membershipStatusSelect');
            const referralDetails = document.getElementById('referralDetails');
            const memberDetails = document.getElementById('memberDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');

            function updateVisibility(value) {
                if (value === 'member') {
                    if (referralDetails) referralDetails.style.display = 'none';
                    if (memberDetails) memberDetails.style.display = 'block';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                } else if (value === 'referred') {
                    if (referralDetails) referralDetails.style.display = 'block';
                    if (memberDetails) memberDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = true;
                    if (referralNbInput) referralNbInput.required = true;
                } else {
                    if (referralDetails) referralDetails.style.display = 'none';
                    if (memberDetails) memberDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                }
            }

            if (membershipSelect) {
                membershipSelect.addEventListener('change', function() { updateVisibility(this.value); });
                updateVisibility(membershipSelect.value);
            }
        }

        // Real-time data synchronization
        function createDataHash() {
            const dataString = JSON.stringify({
                clients: clients.length,
                users: users.length,
                branches: branches.length,
                reports: reports.length,
                lastUpdate: new Date().toISOString()
            });
            return btoa(dataString).substring(0, 16);
        }

        function hasDataChanged() {
            const currentHash = createDataHash();
            if (lastDataHash && lastDataHash !== currentHash) {
                lastDataHash = currentHash;
                return true;
            }
            lastDataHash = currentHash;
            return false;
        }

        // Consultation fees
        const CONSULTATION_FEES = {
            member: 150,    // N$150 for registered members
            referred: 200   // N$200 for referred clients
        };

        async         function init() {
            await loadData();
            loadBranches();
            handleMembershipStatusChange();
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('stressSlider').addEventListener('input', function() {
                document.getElementById('stressValue').textContent = this.value;
            });
            document.getElementById('branchSelect').addEventListener('change', e => {
                currentBranch = e.target.value;
            });
            const checkupSelect = document.getElementById('checkupBranchSelect');
            if (checkupSelect) {
                checkupSelect.addEventListener('change', e => {
                    currentBranch = e.target.value;
                    const globalSelect = document.getElementById('branchSelect');
                    if (globalSelect && globalSelect.value !== currentBranch) {
                        globalSelect.value = currentBranch;
                    }
                });
            }
            
            // Add event listener for full name field to update signature
            document.querySelector('input[name="fullName"]').addEventListener('input', function() {
                const consentCheck = document.getElementById('consentCheck');
                if (consentCheck && consentCheck.checked) {
                    handleConsentChange();
                }
            });
            
            // Update storage info display
            updateStorageInfo();
        }
        
        function updateStorageInfo() {
            const storageEl = document.getElementById('storageInfo');
            if (!storageEl) return;
            
            const info = checkStorageSpace();
            const color = parseFloat(info.percent) > 80 ? '#e74c3c' : parseFloat(info.percent) > 60 ? '#f39c12' : '#27ae60';
            storageEl.innerHTML = `<span style="color: ${color};">${info.used} MB / ${info.max} MB (${info.percent}%)</span>`;
        }

        // API Functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                updateRealtimeStatus('syncing');
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                

                // Try primary API
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, options);
                    
                    // Check if response is OK before parsing JSON
                    if (!response.ok) {
                        // Don't try to parse HTML error pages as JSON
                        if (response.status === 404) {
                            throw new Error(`404_NOT_FOUND`);
                        }
                        const errorText = await response.text();
                        throw new Error(`API error ${response.status}: ${errorText.substring(0, 100)}`);
                    }
                    
                    // Check if response is actually JSON
                    const contentType = response.headers.get('content-type') || '';
                    if (!contentType.includes('application/json')) {
                        // If 404 or HTML response, don't parse as JSON
                        if (response.status === 404 || contentType.includes('text/html')) {
                            throw new Error(`404_NOT_FOUND`);
                        }
                        const text = await response.text();
                        throw new Error(`Expected JSON but got ${contentType || 'unknown'}`);
                    }
                    
                    // Safely parse JSON with error handling
                    let result;
                    try {
                        const text = await response.text();
                        result = JSON.parse(text);
                    } catch (parseError) {
                        // If JSON parse fails, it's likely HTML or invalid response
                        throw new Error(`404_NOT_FOUND`);
                    }
                    
                    updateRealtimeStatus('online');
                    return result;
                } catch (primaryError) {
                    // Try secondary local API as fallback
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            const response = await fetch(`${API_BASE_LOCAL}${endpoint}`, options);
                            
                            if (!response.ok) {
                                throw new Error(`Secondary API returned ${response.status}`);
                            }
                            
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error(`Secondary API returned non-JSON`);
                            }
                            
                            const result = await response.json();
                            updateRealtimeStatus('online');
                            console.log('Using secondary local API as fallback');
                            return result;
                        } catch (localError) {
                            console.error('Both APIs failed, using localStorage');
                            throw localError;
                        }
                    } else {
                        throw primaryError;
                    }
                }
            } catch (error) {
                // Silently handle 404s (expected when APIs aren't deployed)
                const is404 = error.message && (
                    error.message.includes('404') || 
                    error.message.includes('404_NOT_FOUND') ||
                    (error.message.includes('Unexpected token') && error.message.includes('The page c'))
                );
                
                if (!is404) {
                    // Only log non-404 errors in debug mode
                    console.debug('API Error:', error.message || error);
                }
                
                updateRealtimeStatus('offline');
                // Fallback to localStorage if API is not available
                return await fallbackToLocalStorage(endpoint, method, data);
            }
        }

        async function fallbackToLocalStorage(endpoint, method, data) {
            console.log('API unavailable, using localStorage fallback');
            if (endpoint === '/clients') {
                if (method === 'GET') {
                    return JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                } else if (method === 'POST') {
                    const clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
                    clients.push(data);
            localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    return { success: true, message: 'Client saved (offline)' };
                }
            }
            if (endpoint === '/users') {
                if (method === 'GET') {
                    const parsed = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        localStorage.setItem('dyna_users', DEFAULT_USERS_JSON);
                        return JSON.parse(DEFAULT_USERS_JSON);
                    }
                    return parsed;
                } else if (method === 'POST') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    usersLocal.push(data);
                    localStorage.setItem('dyna_users', JSON.stringify(usersLocal));
                    return { success: true, message: 'User saved (offline)' };
                } else if (method === 'PUT') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    const idx = usersLocal.findIndex(u => u.id === data.id);
                    if (idx !== -1) {
                        usersLocal[idx] = data;
                        localStorage.setItem('dyna_users', JSON.stringify(usersLocal));
                        return { success: true, message: 'User updated (offline)' };
                    }
                    return { success: false, message: 'User not found (offline)' };
                } else if (method === 'DELETE') {
                    const usersLocal = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                    const url = new URL(window.location.origin + endpoint + (endpoint.includes('?') ? '' : ''));
                    // Expect id via query in caller; fallback: data.id
                    const id = (data && data.id) || (typeof endpoint === 'string' && endpoint.includes('?') ? new URLSearchParams(endpoint.split('?')[1]).get('id') : null);
                    if (!id) return { success: false, message: 'No user id provided (offline)' };
                    const next = usersLocal.filter(u => u.id !== id);
                    localStorage.setItem('dyna_users', JSON.stringify(next));
                    return { success: true, message: 'User deleted (offline)' };
                }
            }
            if (endpoint === '/branches') {
                if (method === 'GET') {
                    const parsed = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        localStorage.setItem('dyna_branches', DEFAULT_BRANCHES_JSON);
                        return JSON.parse(DEFAULT_BRANCHES_JSON);
                    }
                    return parsed;
                } else if (method === 'POST') {
                    const branchesLocal = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                    branchesLocal.push(data);
                    localStorage.setItem('dyna_branches', JSON.stringify(branchesLocal));
                    return { success: true, message: 'Branch saved (offline)' };
                }
            }
            if (endpoint === '/reports') {
                if (method === 'GET') {
                    // Try to load reports from localStorage, default to empty array
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    return reportsLocal;
                } else if (method === 'POST') {
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    reportsLocal.push(data);
                    localStorage.setItem('dyna_reports', JSON.stringify(reportsLocal));
                    return { success: true, message: 'Report saved (offline)' };
                } else if (method === 'PUT') {
                    const reportsLocal = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
                    const idx = reportsLocal.findIndex(r => r.id === data.id);
                    if (idx !== -1) {
                        reportsLocal[idx] = data;
                        localStorage.setItem('dyna_reports', JSON.stringify(reportsLocal));
                        return { success: true, message: 'Report updated (offline)' };
                    }
                    return { success: false, message: 'Report not found (offline)' };
                }
            }
            return { error: 'Offline mode - limited functionality' };
        }

        async function loadData() {
            try {
                clients = await apiRequest('/clients');
                users = await apiRequest('/users');
                branches = await apiRequest('/branches');
                reports = await apiRequest('/reports');
                
                // If API returns empty arrays, initialize with defaults
                if (users.length === 0) {
                    users = JSON.parse(DEFAULT_USERS_JSON);
                }
                
                if (branches.length === 0) {
                    branches = JSON.parse(DEFAULT_BRANCHES_JSON);
                }
                
                // Load reports from localStorage or keep the existing ones
                if (reports.length === 0) {
                    const storedReports = localStorage.getItem('dyna_reports');
                    if (storedReports && storedReports !== '[]' && storedReports !== 'null') {
                        reports = JSON.parse(storedReports);
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback to localStorage using safe parsing
                clients = safeParseFromStorage('dyna_clients', '[]');
                users = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
                branches = safeParseFromStorage('dyna_branches', DEFAULT_BRANCHES_JSON);
                reports = safeParseFromStorage('dyna_reports', '[]');
                
                // Ensure users and branches are not empty
                if (users.length === 0) {
                    users = JSON.parse(DEFAULT_USERS_JSON);
                    localStorage.setItem('dyna_users', DEFAULT_USERS_JSON);
                }
                if (branches.length === 0) {
                    branches = JSON.parse(DEFAULT_BRANCHES_JSON);
                    localStorage.setItem('dyna_branches', DEFAULT_BRANCHES_JSON);
                }
                
                // Auto-extract clients from reports if clients array is empty
                if (clients.length === 0 && reports.length > 0) {
                    console.log('ðŸ“‹ No clients found, extracting from reports...');
                    const extractedClients = [];
                    
                    reports.forEach(report => {
                        if (!report.clientInfo || !report.clientId) return;
                        
                        const exists = extractedClients.find(c => c.referenceNumber === report.clientId);
                        if (!exists) {
                            extractedClients.push({
                                referenceNumber: report.clientId,
                                fullName: report.clientInfo.fullName,
                                phone: report.clientInfo.phone || '',
                                email: report.clientInfo.email || '',
                                nbNumber: report.clientInfo.nbNumber || ''
                            });
                        }
                    });
                    
                    clients = extractedClients;
                    localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    console.log(`âœ… Extracted ${clients.length} clients from reports`);
                }
            }
        }

        async function saveData() {
            // This function is kept for compatibility but data is now saved via API calls
            console.log('Data saved via API calls');
        }

        // Global refresh function to update all portals
        // GM Portal data refresh
        function refreshGMData() {
            loadData();
            calculateGMMetrics();
            refreshAllApprovals();
            loadSpecialSales();
            displayGMInventoryBreakdown();
        }
        
        // Director Portal data refresh
        function refreshDirectorData() {
            loadData();
            calculateDirectorMetrics();
            loadStockDepletion();
            displayDirectorInventoryBreakdown();
        }
        
        // Calculate GM metrics
        function calculateGMMetrics() {
            let totalRevenue = 0;
            let totalBV = 0;
            let totalCIF = 0;
            
            // Calculate from reports
            reports.forEach(report => {
                const total = calculateReportTotal(report);
                totalRevenue += total;
                
                // Calculate BV from medicines
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        if (price && price.bv) {
                            totalBV += price.bv;
                        }
                    });
                }
                
                // Add CIF if present
                if (report.cif) {
                    totalCIF += parseFloat(report.cif);
                }
            });
            
            const grossMargin = totalRevenue * 0.20; // Assume 20% margin
            
            document.getElementById('gmTotalRevenue').textContent = `N$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('gmTotalBV').textContent = totalBV.toFixed(0);
            document.getElementById('gmCIFDeposits').textContent = `N$ ${totalCIF.toFixed(2)}`;
            document.getElementById('gmGrossMargin').textContent = `N$ ${grossMargin.toFixed(2)}`;
        }
        
        // Calculate Director metrics
        function calculateDirectorMetrics() {
            let revenue = 0;
            let cif = 0;
            let bv = 0;
            
            reports.forEach(report => {
                revenue += calculateReportTotal(report);
                
                if (report.cif) cif += parseFloat(report.cif);
                
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        if (price && price.bv) bv += price.bv;
                    });
                }
            });
            
            const margin = revenue * 0.20;
            const remittance = revenue - cif;
            
            document.getElementById('directorRevenue').textContent = `N$ ${revenue.toFixed(2)}`;
            document.getElementById('directorCIF').textContent = `N$ ${cif.toFixed(2)}`;
            document.getElementById('directorBV').textContent = bv.toFixed(0);
            document.getElementById('directorMargin').textContent = `N$ ${margin.toFixed(2)}`;
            document.getElementById('directorRemittance').textContent = `N$ ${remittance.toFixed(2)}`;
        }
        
        // Approval tab switching
        function switchApprovalTab(tabType) {
            // Hide all tabs
            document.querySelectorAll('.approval-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#gm .tabs .tab-button').forEach(btn => {
                if (btn.id && btn.id.startsWith('approvalTab')) {
                    btn.classList.remove('active');
                }
            });
            
            // Show selected tab
            const activeTab = document.getElementById(`${tabType}ApprovalsList`);
            const activeButton = document.getElementById(`approvalTab${tabType.charAt(0).toUpperCase() + tabType.slice(1)}`);
            
            if (activeTab) {
                activeTab.style.display = 'block';
                activeTab.classList.add('active');
            }
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data for the selected tab
            refreshAllApprovals(tabType);
        }
        
        // Refresh all approvals or specific type
        function refreshAllApprovals(type = null) {
            if (!type || type === 'all') {
                loadAllApprovals();
            }
            if (!type || type === 'cash') {
                loadCashApprovals();
            }
            if (!type || type === 'leave') {
                loadLeaveApprovals();
            }
            if (!type || type === 'stock') {
                loadStockApprovals();
            }
            if (!type || type === 'other') {
                loadOtherApprovals();
            }
            
            // Update global count
            updateApprovalCount();
        }
        
        // Load all approvals (combined view)
        function loadAllApprovals() {
            const container = document.getElementById('allApprovalsList');
            if (!container) return;
            
            const cashRequests = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]').filter(r => r.status === 'pending');
            const leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]').filter(r => r.status === 'Pending');
            const stockRequests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(r => r.status === 'pending_gm' || r.status === 'pending');
            const otherRequests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(r => r.status === 'pending');
            
            const allRequests = [
                ...cashRequests.map(r => ({ ...r, requestType: 'cash', type: 'cash', typeLabel: 'Cash Request', icon: 'ðŸ’µ' })),
                ...leaveRequests.map(r => ({ ...r, requestType: 'leave', type: 'leave', typeLabel: 'Leave Request', icon: 'ðŸ“…', leaveType: r.type })),
                ...stockRequests.map(r => ({ ...r, requestType: 'stock', type: 'stock', typeLabel: 'Stock Movement', icon: 'ðŸ“¦' })),
                ...otherRequests.map(r => ({ ...r, requestType: 'other', type: 'other', typeLabel: r.category || 'Other Request', icon: 'ðŸ“‹' }))
            ];
            
            if (allRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">âœ… No pending approvals at this time.</p>';
                return;
            }
            
            // Sort by date (newest first)
            allRequests.sort((a, b) => new Date(b.createdAt || b.submittedAt) - new Date(a.createdAt || a.submittedAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            allRequests.forEach(request => {
                const date = new Date(request.createdAt || request.submittedAt || Date.now());
                html += renderApprovalCard(request, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load cash approvals
        function loadCashApprovals() {
            const container = document.getElementById('cashApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]').filter(r => r.status === 'pending');
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">âœ… No pending cash requests.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.createdAt);
                html += renderApprovalCard({ ...request, requestType: 'cash', type: 'cash', typeLabel: 'Cash Request', icon: 'ðŸ’µ' }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load leave approvals
        function loadLeaveApprovals() {
            const container = document.getElementById('leaveApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]').filter(r => r.status === 'Pending');
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">âœ… No pending leave requests.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.submittedAt);
                html += renderApprovalCard({ ...request, type: 'leave', typeLabel: 'Leave Request', icon: 'ðŸ“…', leaveType: request.type }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load stock approvals
        function loadStockApprovals() {
            const container = document.getElementById('stockApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(r => 
                r.status === 'pending_gm' || (r.status === 'pending' && r.priority === 'urgent')
            );
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">âœ… No pending stock movement approvals.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.createdAt || request.date || Date.now());
                html += renderApprovalCard({ ...request, requestType: 'stock', type: 'stock', typeLabel: 'Stock Movement', icon: 'ðŸ“¦' }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load other approvals
        function loadOtherApprovals() {
            const container = document.getElementById('otherApprovalsList');
            if (!container) return;
            
            const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(r => r.status === 'pending');
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">âœ… No other pending requests.</p>';
                return;
            }
            
            requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            requests.forEach(request => {
                const date = new Date(request.createdAt);
                html += renderApprovalCard({ ...request, requestType: 'other', type: 'other', typeLabel: request.category || 'Other Request', icon: 'ðŸ“‹' }, date);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render approval card
        function renderApprovalCard(request, date) {
            const urgent = request.urgent || request.priority === 'urgent';
            const borderColor = urgent ? '#e74c3c' : '#3498db';
            
            let details = '';
            if (request.type === 'cash') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Amount:</strong> N$ ${request.amount?.toFixed(2) || '0.00'}<br>
                        <strong>Purpose:</strong> ${request.purpose || 'N/A'}<br>
                        <strong>Branch:</strong> ${request.branch || 'N/A'}
                    </div>
                `;
            } else if (request.type === 'leave') {
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Employee:</strong> ${request.staff || 'Unknown'}<br>
                        <strong>Leave Type:</strong> ${request.leaveType || 'N/A'}<br>
                        <strong>Period:</strong> ${startDate} to ${endDate}<br>
                        <strong>Reason:</strong> ${request.reason || 'N/A'}
                    </div>
                `;
            } else if (request.type === 'stock') {
                const itemsCount = request.items?.length || 0;
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Request Number:</strong> ${request.requestNumber || request.id || 'N/A'}<br>
                        <strong>From Branch:</strong> ${request.requestingBranch || 'N/A'}<br>
                        <strong>Items:</strong> ${itemsCount} item(s)<br>
                        <strong>Priority:</strong> ${request.priority || 'Normal'}
                    </div>
                `;
            } else {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Description:</strong> ${request.description || request.purpose || 'N/A'}<br>
                        <strong>Category:</strong> ${request.category || 'General'}
                    </div>
                `;
            }
            
            return `
                <div style="background: white; border-left: 4px solid ${borderColor}; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${request.icon || 'ðŸ“‹'}</span>
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50;">${request.typeLabel || 'Request'}</h4>
                                    <div style="color: #7f8c8d; font-size: 0.9rem;">${date.toLocaleString()}</div>
                                </div>
                            </div>
                            ${urgent ? '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px;">URGENT</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="approveRequest('${request.id}', '${request.type}')" style="padding: 8px 16px; font-size: 0.9rem;">âœ… Approve</button>
                            <button class="btn btn-danger" onclick="rejectRequest('${request.id}', '${request.type}')" style="padding: 8px 16px; font-size: 0.9rem;">âŒ Reject</button>
                        </div>
                    </div>
                    ${details}
                </div>
            `;
        }
        
        // Approve a request
        async function approveRequest(requestId, requestType) {
            const reason = prompt('Enter approval notes (optional):');
            if (reason === null) return; // User cancelled
            
            try {
                if (requestType === 'cash') {
                    const requests = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'approved';
                        request.approvedBy = window.currentUser?.fullName || 'GM';
                        request.approvedAt = new Date().toISOString();
                        request.approvalNotes = reason || '';
                        localStorage.setItem('finance_cash_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('cash_request', 'approved', request);
                        }
                    }
                } else if (requestType === 'leave') {
                    const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'Approved';
                        request.approvedBy = window.currentUser?.fullName || 'GM';
                        request.approvedAt = new Date().toISOString();
                        request.approvalNotes = reason || '';
                        localStorage.setItem('leaveRequests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('leave_request', 'approved', request);
                        }
                    }
                } else if (requestType === 'stock') {
                    const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'approved';
                        request.approvals = request.approvals || [];
                        request.approvals.push({
                            level: 'gm',
                            approvedBy: window.currentUser?.fullName || 'GM',
                            approvedAt: new Date().toISOString(),
                            notes: reason || ''
                        });
                        localStorage.setItem('dyna_stock_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('stock_request', 'approved', request);
                        }
                    }
                } else {
                    const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'approved';
                        request.approvedBy = window.currentUser?.fullName || 'GM';
                        request.approvedAt = new Date().toISOString();
                        request.approvalNotes = reason || '';
                        localStorage.setItem('gm_pending_requests', JSON.stringify(requests));
                    }
                }
                
                alert('âœ… Request approved successfully!');
                refreshAllApprovals();
                updateApprovalCount();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('âŒ Error approving request. Please try again.');
            }
        }
        
        // Reject a request
        async function rejectRequest(requestId, requestType) {
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || reason.trim() === '') {
                alert('Rejection reason is required.');
                return;
            }
            
            try {
                if (requestType === 'cash') {
                    const requests = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('finance_cash_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('cash_request', 'rejected', request);
                        }
                    }
                } else if (requestType === 'leave') {
                    const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'Rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('leaveRequests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('leave_request', 'rejected', request);
                        }
                    }
                } else if (requestType === 'stock') {
                    const requests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('dyna_stock_requests', JSON.stringify(requests));
                        
                        // Broadcast event
                        if (typeof publishRealtimeEvent === 'function') {
                            publishRealtimeEvent('stock_request', 'rejected', request);
                        }
                    }
                } else {
                    const requests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]');
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = 'rejected';
                        request.rejectedBy = window.currentUser?.fullName || 'GM';
                        request.rejectedAt = new Date().toISOString();
                        request.rejectionReason = reason;
                        localStorage.setItem('gm_pending_requests', JSON.stringify(requests));
                    }
                }
                
                alert('âŒ Request rejected.');
                refreshAllApprovals();
                updateApprovalCount();
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('âŒ Error rejecting request. Please try again.');
            }
        }
        
        // Update approval count
        function updateApprovalCount() {
            const cashRequests = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]').filter(r => r.status === 'pending');
            const leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]').filter(r => r.status === 'Pending');
            const stockRequests = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]').filter(r => r.status === 'pending_gm' || (r.status === 'pending' && r.priority === 'urgent'));
            const otherRequests = JSON.parse(localStorage.getItem('gm_pending_requests') || '[]').filter(r => r.status === 'pending');
            
            const totalCount = cashRequests.length + leaveRequests.length + stockRequests.length + otherRequests.length;
            window.gmPendingApprovalsCount = totalCount;
            
            if (typeof window.updateGlobalAlerts === 'function') {
                window.updateGlobalAlerts({ pendingApprovalsCount: totalCount });
            }
        }
        
        // Load pending approvals (legacy function for backward compatibility)
        function loadPendingApprovals() {
            refreshAllApprovals('all');
        }
        
        // Load special sales
        function loadSpecialSales() {
            const container = document.getElementById('specialSalesList');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; color: #666;">No active special sales campaigns.</p>';
        }
        
        // Load stock depletion
        function loadStockDepletion() {
            const container = document.getElementById('stockDepletionDashboard');
            if (!container) return;
            
            const batches = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const byProduct = {};
            
            batches.forEach(b => {
                if (!byProduct[b.description]) {
                    byProduct[b.description] = { total: 0, remaining: 0 };
                }
                byProduct[b.description].total += b.quantity;
                byProduct[b.description].remaining += b.remainingQuantity;
            });
            
            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #c41e3a; color: white;"><th style="padding: 10px;">Product</th><th style="padding: 10px;">Total</th><th style="padding: 10px;">Remaining</th><th style="padding: 10px;">Depleted</th></tr></thead><tbody>';
            
            Object.entries(byProduct).forEach(([product, stats]) => {
                const depleted = stats.total - stats.remaining;
                const percent = (depleted / stats.total * 100).toFixed(0);
                html += `<tr><td style="padding: 10px; border: 1px solid #ddd;">${product}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.total}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.remaining}</td><td style="padding: 10px; border: 1px solid #ddd;">${percent}%</td></tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Show special sales modal
        function showSpecialSalesModal() {
            alert('Special Sales creation will be available soon!');
        }
        
        // Campaign Management Functions
        function switchCampaignTab(tabType) {
            // Hide all tabs
            document.querySelectorAll('.campaign-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#gm .tabs .tab-button').forEach(btn => {
                if (btn.id && btn.id.startsWith('campaignTab')) {
                    btn.classList.remove('active');
                }
            });
            
            // Show selected tab
            const activeTab = document.getElementById(`${tabType}CampaignsList`);
            const activeButton = document.getElementById(`campaignTab${tabType.charAt(0).toUpperCase() + tabType.slice(1)}`);
            
            if (activeTab) {
                activeTab.style.display = 'block';
                activeTab.classList.add('active');
            }
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data for the selected tab
            refreshCampaigns(tabType);
        }
        
        function refreshCampaigns(type = null) {
            if (!type || type === 'all') {
                loadAllCampaigns();
            }
            if (!type || type === 'sales') {
                loadSalesCampaigns();
            }
            if (!type || type === 'recruiting') {
                loadRecruitingCampaigns();
            }
            if (!type || type === 'sponsoring') {
                loadSponsoringCampaigns();
            }
            if (!type || type === 'gift') {
                loadGiftCampaigns();
            }
        }
        
        function loadAllCampaigns() {
            const container = document.getElementById('allCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No campaigns created yet.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadSalesCampaigns() {
            const container = document.getElementById('salesCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'sales');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No sales discount campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadRecruitingCampaigns() {
            const container = document.getElementById('recruitingCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'recruiting');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No recruiting campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadSponsoringCampaigns() {
            const container = document.getElementById('sponsoringCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'sponsoring');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No sponsoring campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function loadGiftCampaigns() {
            const container = document.getElementById('giftCampaignsList');
            if (!container) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]')
                .filter(c => c.type === 'gift');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No gift campaigns.</p>';
                return;
            }
            
            campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '<div style="display: grid; gap: 15px;">';
            campaigns.forEach(campaign => {
                html += renderCampaignCard(campaign);
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderCampaignCard(campaign) {
            const isActive = campaign.status === 'active';
            const isExpired = new Date(campaign.endDate) < new Date();
            const borderColor = isExpired ? '#95a5a6' : isActive ? '#27ae60' : '#e74c3c';
            
            const typeIcons = {
                'sales': 'ðŸ’°',
                'recruiting': 'ðŸ‘¥',
                'sponsoring': 'ðŸ¤',
                'gift': 'ðŸŽ'
            };
            
            const typeLabels = {
                'sales': 'Sales Discount',
                'recruiting': 'Recruiting',
                'sponsoring': 'Sponsoring',
                'gift': 'Gift Campaign'
            };
            
            let details = '';
            if (campaign.type === 'sales') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Discount:</strong> ${campaign.discount || 0}%<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                        ${campaign.products?.length > 0 ? `<strong>Products:</strong> ${campaign.products.length} product(s)<br>` : ''}
                        ${campaign.minPurchaseAmount ? `<strong>Min Purchase:</strong> N$ ${campaign.minPurchaseAmount}<br>` : ''}
                    </div>
                `;
            } else if (campaign.type === 'recruiting') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Reward:</strong> ${campaign.reward || 'N/A'}<br>
                        <strong>Target:</strong> ${campaign.target || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            } else if (campaign.type === 'sponsoring') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Incentive:</strong> ${campaign.incentive || 'N/A'}<br>
                        <strong>Target:</strong> ${campaign.target || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            } else if (campaign.type === 'gift') {
                details = `
                    <div style="margin-top: 10px;">
                        <strong>Gift:</strong> ${campaign.giftDescription || 'N/A'}<br>
                        <strong>Condition:</strong> ${campaign.condition || 'N/A'}<br>
                        <strong>Applicable Branches:</strong> ${campaign.branches?.length > 0 ? campaign.branches.join(', ') : 'All Branches'}<br>
                    </div>
                `;
            }
            
            return `
                <div style="background: white; border-left: 4px solid ${borderColor}; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${typeIcons[campaign.type] || 'ðŸ“‹'}</span>
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50;">${campaign.name || 'Unnamed Campaign'}</h4>
                                    <div style="color: #7f8c8d; font-size: 0.9rem;">${typeLabels[campaign.type] || campaign.type} â€¢ ${new Date(campaign.startDate).toLocaleDateString()} - ${new Date(campaign.endDate).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <span style="background: ${borderColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px;">
                                ${campaign.status?.toUpperCase() || 'INACTIVE'}${isExpired ? ' (EXPIRED)' : ''}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="editCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">âœï¸ Edit</button>
                            <button class="btn btn-danger" onclick="deleteCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">ðŸ—‘ï¸ Delete</button>
                            ${!isActive && !isExpired ? `<button class="btn btn-success" onclick="activateCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">âœ… Activate</button>` : ''}
                            ${isActive ? `<button class="btn btn-warning" onclick="deactivateCampaign('${campaign.id}')" style="padding: 8px 16px; font-size: 0.9rem;">â¸ï¸ Deactivate</button>` : ''}
                        </div>
                    </div>
                    ${campaign.description ? `<p style="color: #555; margin-top: 10px;">${campaign.description}</p>` : ''}
                    ${details}
                </div>
            `;
        }
        
        function showCreateCampaignModal() {
            const modal = document.createElement('div');
            modal.id = 'createCampaignModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeModal('createCampaignModal')">&times;</span>
                    <h2>ðŸŽ¯ Create Campaign</h2>
                    <form id="createCampaignForm" onsubmit="submitCampaign(event)">
                        <div class="form-group">
                            <label class="required">Campaign Name</label>
                            <input type="text" id="campaignName" required placeholder="e.g., Summer Sales 2025">
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Campaign Type</label>
                            <select id="campaignType" required onchange="updateCampaignForm()">
                                <option value="">Select Type</option>
                                <option value="sales">ðŸ’° Sales Discount</option>
                                <option value="recruiting">ðŸ‘¥ Recruiting</option>
                                <option value="sponsoring">ðŸ¤ Sponsoring</option>
                                <option value="gift">ðŸŽ Gift Campaign</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="campaignDescription" rows="3" placeholder="Campaign description..."></textarea>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Start Date</label>
                                <input type="date" id="campaignStartDate" required>
                            </div>
                            <div class="form-group">
                                <label class="required">End Date</label>
                                <input type="date" id="campaignEndDate" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Apply To</label>
                            <select id="campaignApplyTo" required onchange="updateBranchSelection()">
                                <option value="all">All Branches</option>
                                <option value="selected">Selected Branches</option>
                            </select>
                        </div>
                        
                        <div id="branchSelectionDiv" class="form-group" style="display: none;">
                            <label>Select Branches</label>
                            <div id="branchCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <!-- Branches will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Sales Discount Specific Fields -->
                        <div id="salesFields" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Discount Percentage</label>
                                    <input type="number" id="campaignDiscount" min="0" max="100" step="0.01" placeholder="e.g., 15">
                                </div>
                                <div class="form-group">
                                    <label>Minimum Purchase Amount (N$)</label>
                                    <input type="number" id="campaignMinPurchase" min="0" step="0.01" placeholder="Optional">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Apply to Specific Products (Optional)</label>
                                <input type="text" id="campaignProducts" placeholder="Comma-separated product names or leave empty for all products">
                            </div>
                        </div>
                        
                        <!-- Recruiting Specific Fields -->
                        <div id="recruitingFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Reward Description</label>
                                <textarea id="campaignReward" rows="2" placeholder="e.g., N$ 500 bonus for each new distributor"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target</label>
                                <input type="text" id="campaignTarget" placeholder="e.g., 10 new distributors">
                            </div>
                        </div>
                        
                        <!-- Sponsoring Specific Fields -->
                        <div id="sponsoringFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Incentive Description</label>
                                <textarea id="campaignIncentive" rows="2" placeholder="e.g., Extra 5% commission for sponsors"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target</label>
                                <input type="text" id="campaignSponsorTarget" placeholder="e.g., 5 sponsored members">
                            </div>
                        </div>
                        
                        <!-- Gift Specific Fields -->
                        <div id="giftFields" style="display: none;">
                            <div class="form-group">
                                <label class="required">Gift Description</label>
                                <textarea id="campaignGift" rows="2" placeholder="e.g., Free product sample kit"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="required">Condition</label>
                                <textarea id="campaignGiftCondition" rows="2" placeholder="e.g., For purchases above N$ 500" required></textarea>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">âœ… Create Campaign</button>
                            <button type="button" class="btn" onclick="closeModal('createCampaignModal')">âŒ Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load branches
            loadBranchesForCampaign();
            
            // Set default dates
            const today = new Date();
            document.getElementById('campaignStartDate').value = today.toISOString().split('T')[0];
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('campaignEndDate').value = nextMonth.toISOString().split('T')[0];
        }
        
        function loadBranchesForCampaign() {
            const branches = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
            const container = document.getElementById('branchCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';
            branches.forEach(branch => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="campaignBranches" value="${branch.id || branch.name}" style="width: auto;">
                        <span>${branch.name || branch.id}</span>
                    </label>
                `;
                container.appendChild(div);
            });
        }
        
        function updateCampaignForm() {
            const type = document.getElementById('campaignType')?.value;
            
            // Hide all type-specific fields
            document.getElementById('salesFields').style.display = 'none';
            document.getElementById('recruitingFields').style.display = 'none';
            document.getElementById('sponsoringFields').style.display = 'none';
            document.getElementById('giftFields').style.display = 'none';
            
            // Show relevant fields
            if (type === 'sales') {
                document.getElementById('salesFields').style.display = 'block';
            } else if (type === 'recruiting') {
                document.getElementById('recruitingFields').style.display = 'block';
            } else if (type === 'sponsoring') {
                document.getElementById('sponsoringFields').style.display = 'block';
            } else if (type === 'gift') {
                document.getElementById('giftFields').style.display = 'block';
            }
        }
        
        function updateBranchSelection() {
            const applyTo = document.getElementById('campaignApplyTo')?.value;
            const branchDiv = document.getElementById('branchSelectionDiv');
            if (branchDiv) {
                branchDiv.style.display = applyTo === 'selected' ? 'block' : 'none';
            }
        }
        
        function submitCampaign(event) {
            event.preventDefault();
            
            try {
                const type = document.getElementById('campaignType').value;
                const applyTo = document.getElementById('campaignApplyTo').value;
                
                let branches = [];
                if (applyTo === 'selected') {
                    const checkboxes = document.querySelectorAll('input[name="campaignBranches"]:checked');
                    branches = Array.from(checkboxes).map(cb => cb.value);
                }
                
                const campaign = {
                    id: 'CAMP-' + Date.now(),
                    name: document.getElementById('campaignName').value,
                    type: type,
                    description: document.getElementById('campaignDescription').value || '',
                    startDate: document.getElementById('campaignStartDate').value,
                    endDate: document.getElementById('campaignEndDate').value,
                    branches: branches,
                    status: 'inactive',
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser?.fullName || 'GM'
                };
                
                // Add type-specific fields
                if (type === 'sales') {
                    campaign.discount = parseFloat(document.getElementById('campaignDiscount').value) || 0;
                    campaign.minPurchaseAmount = parseFloat(document.getElementById('campaignMinPurchase').value) || null;
                    const productsStr = document.getElementById('campaignProducts').value;
                    campaign.products = productsStr ? productsStr.split(',').map(p => p.trim()).filter(p => p) : [];
                } else if (type === 'recruiting') {
                    campaign.reward = document.getElementById('campaignReward').value;
                    campaign.target = document.getElementById('campaignTarget').value || '';
                } else if (type === 'sponsoring') {
                    campaign.incentive = document.getElementById('campaignIncentive').value;
                    campaign.target = document.getElementById('campaignSponsorTarget').value || '';
                } else if (type === 'gift') {
                    campaign.giftDescription = document.getElementById('campaignGift').value;
                    campaign.condition = document.getElementById('campaignGiftCondition').value;
                }
                
                // Save campaign
                const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
                campaigns.push(campaign);
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'created', campaign);
                }
                
                alert('âœ… Campaign created successfully!');
                closeModal('createCampaignModal');
                refreshCampaigns();
                
            } catch (error) {
                console.error('Error creating campaign:', error);
                alert('âŒ Error creating campaign: ' + error.message);
            }
        }
        
        function editCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) {
                alert('Campaign not found');
                return;
            }
            
            // Similar to create modal but pre-filled
            showCreateCampaignModal();
            // TODO: Pre-fill form with campaign data
            alert('Edit functionality coming soon. For now, delete and recreate the campaign.');
        }
        
        function deleteCampaign(campaignId) {
            if (!confirm('Are you sure you want to delete this campaign?')) return;
            
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const filtered = campaigns.filter(c => c.id !== campaignId);
            localStorage.setItem('gm_campaigns', JSON.stringify(filtered));
            
            // Broadcast event
            if (typeof publishRealtimeEvent === 'function') {
                publishRealtimeEvent('campaign', 'deleted', { id: campaignId });
            }
            
            alert('âœ… Campaign deleted');
            refreshCampaigns();
        }
        
        function activateCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                campaign.status = 'active';
                campaign.activatedAt = new Date().toISOString();
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'activated', campaign);
                }
                
                alert('âœ… Campaign activated');
                refreshCampaigns();
            }
        }
        
        function deactivateCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('gm_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                campaign.status = 'inactive';
                campaign.deactivatedAt = new Date().toISOString();
                localStorage.setItem('gm_campaigns', JSON.stringify(campaigns));
                
                // Broadcast event
                if (typeof publishRealtimeEvent === 'function') {
                    publishRealtimeEvent('campaign', 'deactivated', campaign);
                }
                
                alert('â¸ï¸ Campaign deactivated');
                refreshCampaigns();
            }
        }
        
        // Display GM Inventory Breakdown
        function displayGMInventoryBreakdown() {
            const container = document.getElementById('gmInventoryBreakdown');
            if (!container) return;
            try {
                if (typeof getInventorySummary !== 'function') {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Inventory reporting module loading...</p>';
                    return;
                }
                const summary = getInventorySummary({ branchId: null });
                if (!summary.success) {
                    container.innerHTML = `<p style="color: #e74c3c;">Error: ${summary.error}</p>`;
                    return;
                }
                const data = summary.data;
                let html = '<div style="margin-bottom: 15px;"><strong>ðŸ“Š Inventory Overview</strong></div>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<thead><tr style="background: #667eea; color: white;"><th style="padding: 8px;">Metric</th><th style="padding: 8px; text-align: right;">Value</th></tr></thead><tbody>';
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Products</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalProducts}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Quantity</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalQuantity}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Low Stock Items</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e74c3c;">${data.totals.lowStockItems}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Expiring Soon (30 days)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f39c12;">${data.totals.expiringSoon}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Requests</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingRequests}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Transfers</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingTransfers}</td></tr>`;
                html += '</tbody></table>';
                if (data.alerts && data.alerts.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong>âš ï¸ Alerts</strong></div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    data.alerts.slice(0, 5).forEach(alert => {
                        html += `<li style="color: #f39c12;">${alert.message}</li>`;
                    });
                    html += '</ul>';
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p style="color: #e74c3c;">Error displaying inventory: ${error.message}</p>`;
            }
        }
        
        // Display Director Inventory Breakdown
        function displayDirectorInventoryBreakdown() {
            const container = document.getElementById('directorInventoryBreakdown');
            if (!container) return;
            try {
                if (typeof getInventorySummary !== 'function') {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Inventory reporting module loading...</p>';
                    return;
                }
                const summary = getInventorySummary({ branchId: null });
                if (!summary.success) {
                    container.innerHTML = `<p style="color: #e74c3c;">Error: ${summary.error}</p>`;
                    return;
                }
                const data = summary.data;
                let html = '<div style="margin-bottom: 15px;"><strong>ðŸ“Š Inventory Overview</strong></div>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<thead><tr style="background: #667eea; color: white;"><th style="padding: 8px;">Metric</th><th style="padding: 8px; text-align: right;">Value</th></tr></thead><tbody>';
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Products</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalProducts}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Total Quantity</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.totals.totalQuantity}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Low Stock Items</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e74c3c;">${data.totals.lowStockItems}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Expiring Soon (30 days)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f39c12;">${data.totals.expiringSoon}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Requests</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingRequests}</td></tr>`;
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">Pending Transfers</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${data.pendingTransfers}</td></tr>`;
                html += '</tbody></table>';
                if (data.alerts && data.alerts.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong>âš ï¸ Alerts</strong></div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    data.alerts.slice(0, 5).forEach(alert => {
                        html += `<li style="color: #f39c12;">${alert.message}</li>`;
                    });
                    html += '</ul>';
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p style="color: #e74c3c;">Error displaying inventory: ${error.message}</p>`;
            }
        }
        
        async function refreshAllData() {
            const previousHash = lastDataHash;
            await loadData();
            loadBranches();
            
            // Check if data has changed and show notification
            if (previousHash && hasDataChanged()) {
                showDataUpdateNotification();
            }
            
            // Refresh current portal data if user is logged in
            if (currentUser) {
                if (currentPortal === 'consultant') {
                    await displayClients();
                    await displayFollowUps();
                } else if (currentPortal === 'dispenser') {
                    await displayPrescriptions();
                } else if (currentPortal === 'stock') {
                    renderForecastList();
                    renderPurchaseOrders();
                    renderSupplierScorecard();
                    renderPlanInsights();
                    renderASNList();
                    renderQualityList();
                    renderPutawayQueue();
                    renderWarehouseCapacity();
                    renderReplenishmentSuggestions();
                    renderBranchRequestList();
                    updateBranchMetrics();
                    renderReturnsList();
                    renderRouteBoard();
                    renderInventoryAlerts();
                    renderReorderScenarioResults();
                    displayCountryStock();
                    displayWindhoekStock();
                    displayOndangwaStock();
                    displayDistributionHistory();
                } else if (currentPortal === 'mis') {
                    loadMISBranches();
                    displayMISReports();
                } else if (currentPortal === 'admin') {
                    loadUserList();
                    loadBranchListAdmin();
                }
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh every 30 seconds when user is logged in (reduced from 5s to prevent API spam)
            // Real-time updates should come from WebSocket/SSE, not polling
            autoRefreshInterval = setInterval(async () => {
                if (currentUser) {
                    try {
                        await refreshAllData();
                    } catch (error) {
                        // Silently handle errors to prevent console spam
                        console.debug('Auto-refresh error (using localStorage):', error.message);
                    }
                }
            }, 30000); // 30 seconds instead of 5 seconds
            
            console.log('ðŸ”„ Auto-refresh started (30 second intervals)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('â¹ï¸ Auto-refresh stopped');
            }
        }

        // Show notification when data is updated
        function showDataUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = 'ðŸ”„ Data updated from another device';
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Show/hide real-time status indicator
        function showRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'block';
                status.className = 'realtime-status';
                status.innerHTML = 'ðŸ”„ Real-time sync active';
            }
        }

        function hideRealtimeStatus() {
            const status = document.getElementById('realtimeStatus');
            if (status) {
                status.style.display = 'none';
            }
        }

        function updateRealtimeStatus(status) {
            const statusElement = document.getElementById('realtimeStatus');
            if (statusElement) {
                statusElement.className = `realtime-status ${status}`;
                switch(status) {
                    case 'offline':
                        statusElement.innerHTML = 'âŒ Connection lost';
                        break;
                    case 'syncing':
                        statusElement.innerHTML = 'ðŸ”„ Syncing...';
                        break;
                    default:
                        statusElement.innerHTML = 'ðŸ”„ Real-time sync active';
                }
            }
        }

        // Network synchronization test functions
        async function testNetworkSync() {
            try {
                updateRealtimeStatus('syncing');
                
                // Test API connectivity with fallback
                let response;
                let data;
                let connectedTo = 'Unknown';
                
                // Try primary API
                try {
                    response = await fetch(`${API_BASE}/clients`);
                    data = await response.json();
                    connectedTo = 'Primary Server';
                } catch (e1) {
                    // Try secondary local API if different
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            response = await fetch(`${API_BASE_LOCAL}/clients`);
                            data = await response.json();
                            connectedTo = 'Secondary Local Server';
                        } catch (e2) {
                            // Fall back to local storage
                            data = clients;
                            connectedTo = 'Offline Mode (Local Storage)';
                        }
                    } else {
                        // Fall back to local storage
                        data = clients;
                        connectedTo = 'Offline Mode (Local Storage)';
                    }
                }
                
                updateRealtimeStatus('online');
                
                alert(`âœ… Network sync test successful!\n\nConnected to: ${connectedTo}\nTotal clients in system: ${data.length}\n\nLatest clients:\n${data.slice(-3).map(c => `- ${c.fullName} (${c.referenceNumber})`).join('\n')}`);
                
            } catch (error) {
                updateRealtimeStatus('offline');
                const localClients = safeParseFromStorage('clients', '[]');
                alert(`âš ï¸ Network connection failed!\n\nError: ${error.message}\n\nðŸ“¦ Current Status:\n- ${localClients.length} clients in local storage\n- Working in OFFLINE MODE\n\nNote: The app will continue working with local data. Sync will resume when connection is restored.`);
            }
        }

        async function checkConnectionStatus() {
            try {
                const startTime = Date.now();
                let response;
                let data;
                let endpoint = 'Unknown';
                let connectionStatus = 'âŒ Disconnected';
                
                // Try primary API
                try {
                    response = await fetch(`${API_BASE}/clients`);
                    data = await response.json();
                    endpoint = 'Primary Server';
                    connectionStatus = 'âœ… Connected';
                } catch (e1) {
                    // Try secondary local API if different
                    if (API_BASE_LOCAL !== API_BASE) {
                        try {
                            response = await fetch(`${API_BASE_LOCAL}/clients`);
                            data = await response.json();
                            endpoint = 'Secondary Local Server';
                            connectionStatus = 'âœ… Connected';
                        } catch (e2) {
                            // Fall back to local storage
                            data = clients;
                            endpoint = 'Offline Mode';
                            connectionStatus = 'âš ï¸ Offline (Using Local Storage)';
                        }
                    } else {
                        // Fall back to local storage
                        data = clients;
                        endpoint = 'Offline Mode';
                        connectionStatus = 'âš ï¸ Offline (Using Local Storage)';
                    }
                }
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const localData = safeParseFromStorage('clients', '[]');
                
                alert(`ðŸ“¡ Connection Status Report\n\n${connectionStatus}\nðŸŒ Endpoint: ${endpoint}\nâ±ï¸ Response Time: ${responseTime}ms\nðŸ“Š Total Clients: ${data.length}\nðŸ’¾ Local Storage: ${localData.length} records\nðŸ”„ Auto-refresh: ${autoRefreshInterval ? 'Active (5s intervals)' : 'Inactive'}\nðŸ‘¤ Current User: ${currentUser ? currentUser.fullName : 'Not logged in'}`);
                
            } catch (error) {
                const localClients = safeParseFromStorage('clients', '[]');
                alert(`âŒ Connection Status Report\n\nâŒ API Server: Disconnected\nðŸŒ Primary: ${API_BASE}\nðŸŒ Local: ${API_BASE_LOCAL}\nâš ï¸ Error: ${error.message}\n\nðŸ’¾ Local Storage: ${localClients.length} records available\n\nThe app will continue working with local data until connection is restored.`);
            }
        }

        function loadBranches() {
            console.log('Loading branches:', branches);
            const selects = [document.getElementById('branchSelect'), document.getElementById('userBranchSelect'), document.getElementById('checkupBranchSelect')];
            selects.forEach(select => {
                if(select) {
                    select.innerHTML = '<option value="">Select Branch</option>';
                    branches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    });
                    console.log('Populated select:', select.id, 'with', branches.length, 'branches');
                }
            });
        }

        function openTab(tabName, event) {
            // Set currentPortal for portal tabs
            const portalTabs = ['consultant', 'dispenser', 'admin', 'mis', 'stock', 'gm', 'director', 'finance', 'hr-portal'];
            if (portalTabs.includes(tabName)) {
                currentPortal = tabName;
                window.currentPortal = tabName; // Set global for permission checks
            }
            
            // Branch selection is now optional - portals can open without it
            // Branch selection will be requested only when needed for specific operations inside portals
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const btn = document.querySelector(`[onclick="openTab('${tabName}', event)"]`) || document.querySelector(`[onclick="openTab('${tabName}')"]`);
                if (btn) btn.classList.add('active');
            }
            
            // Auto-login for stock portal if not already logged in
            if (tabName === 'stock' && !currentUser) {
                // Give a small delay to let the tab load
                setTimeout(() => {
                    autoLoginStock();
                }, 100);
            }
            
            // MIS Portal now requires login - initialize if already logged in
            if (tabName === 'mis' && currentUser && currentUser.role === 'mis') {
                initializeMISPortal();
            }
            
            // Finance Portal - ensure data is loaded when tab is opened
            if (tabName === 'finance') {
                setTimeout(async () => {
                    try {
                        if (typeof loadEnhancedFinanceData === 'function') {
                            await loadEnhancedFinanceData();
                        }
                        if (typeof populateBranchSelects === 'function') {
                            populateBranchSelects();
                        }
                        if (typeof refreshFinancialDashboard === 'function') {
                            refreshFinancialDashboard();
                        }
                        if (typeof refreshFinancialOverview === 'function') {
                            refreshFinancialOverview();
                        }
                        if (typeof refreshRevenue === 'function') {
                            refreshRevenue();
                        }
                        if (typeof refreshExpenses === 'function') {
                            refreshExpenses();
                        }
                    } catch (e) {
                        console.debug('Finance portal initialization error:', e);
                    }
                }, 100);
            }
            
            // HR Portal - ensure data is loaded when tab is opened
            if (tabName === 'hr-portal') {
                // Reload employees when HR portal is opened to ensure fresh data
                if (typeof initHRPortal === 'function') {
                    initHRPortal();
                }
                // Also ensure employee list is loaded if employee-management tab is visible
                setTimeout(() => {
                    const empTab = document.querySelector('[onclick*="employee-management"]');
                    if (empTab && empTab.classList.contains('active')) {
                        if (typeof loadEmployees === 'function') {
                            loadEmployees();
                        }
                    }
                }, 100);
            }
            
            // Client/Distributor Portal - ensure shop products load when tab is opened
            if (tabName === 'client') {
                setTimeout(() => {
                    // Ensure shop tab is shown and products are loaded
                    const shopTab = document.getElementById('distributor-shop-tab');
                    if (shopTab && shopTab.classList.contains('active') || shopTab.style.display !== 'none') {
                        if (typeof loadShopProducts === 'function') {
                            loadShopProducts();
                        }
                    }
                    // Load media preview widget
                    if (typeof loadMediaPreviewWidget === 'function') {
                        loadMediaPreviewWidget();
                    }
                }, 200);
            }
            
            // Front Desk Portal - ensure internal tabs are visible
            if (tabName === 'frontdesk') {
                setTimeout(() => {
                    // Show all internal tabs within the front desk portal
                    const frontdeskTabsContainer = document.querySelector('#frontdesk .tabs');
                    if (frontdeskTabsContainer) {
                        const internalTabButtons = frontdeskTabsContainer.querySelectorAll('.tab-button');
                        internalTabButtons.forEach(btn => {
                            btn.style.display = 'inline-block';
                        });
                    }
                    // Ensure the default pending orders tab is shown
                    const pendingTab = document.getElementById('pendingOrders');
                    if (pendingTab) {
                        pendingTab.style.display = 'block';
                        pendingTab.classList.add('active');
                    }
                }, 100);
            }
        }

        // Ensure openTab is accessible from inline onclick handlers
        if (typeof window !== 'undefined') {
            window.openTab = openTab;
        }

        // MIS Portal Functions
        function initializeMISPortal() {
            loadMISBranches();
            displayMISReports();
        }

        function loadMISBranches() {
            const branchSelect = document.getElementById('misBranchSelect');
            if (!branchSelect) return;
            
            // Clear existing options except "All Branches"
            branchSelect.innerHTML = '<option value="all">All Branches</option>';
            
            // Add branches
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                branchSelect.appendChild(option);
            });
        }

        function filterMISReports() {
            const branchId = document.getElementById('misBranchSelect')?.value || 'all';
            const searchTerm = document.getElementById('misSearchInput')?.value?.toLowerCase() || '';
            const fromInput = document.getElementById('misDateFrom')?.value || '';
            const toInput = document.getElementById('misDateTo')?.value || '';
            const fromTs = fromInput ? new Date(fromInput).getTime() : null;
            const toTs = toInput ? new Date(toInput).getTime() : null;
            
            let filteredReports = reports.filter(report => {
                // Branch filter (only applies if report has branch info)
                if (branchId !== 'all') {
                    const rptBranch = report.branch || report.clientInfo?.branch || null;
                    if (!rptBranch || rptBranch !== branchId) {
                        return false;
                    }
                }
                
                // Time filter
                if (fromTs || toTs) {
                    const rptTs = report.timestamp ? new Date(report.timestamp).getTime() : null;
                    if (!rptTs) return false;
                    if (fromTs && rptTs < fromTs) return false;
                    if (toTs && rptTs > toTs) return false;
                }
                
                // Filter by search term (name or NB number)
                if (searchTerm) {
                    const name = report.clientInfo?.fullName?.toLowerCase() || '';
                    const nbNumber = report.clientInfo?.nbNumber?.toLowerCase() || '';
                    const receiptId = report.id?.toLowerCase() || '';
                    const consultant = (report.consultant || '').toLowerCase();
                    
                    return name.includes(searchTerm) || nbNumber.includes(searchTerm) || receiptId.includes(searchTerm) || consultant.includes(searchTerm);
                }
                
                return true;
            });
            
            displayMISReportsTable(filteredReports);
            updateMISSummary(filteredReports);
        }

        function displayMISReports() {
            // Default to today's receipts if no date range selected
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            if (fromInput && toInput && !fromInput.value && !toInput.value) {
                setMISDateToday();
            } else {
                filterMISReports();
            }
        }

        function displayMISReportsTable(reportsToDisplay) {
            const displayDiv = document.getElementById('misReportsDisplay');
            if (!displayDiv) return;
            
            if (reportsToDisplay.length === 0) {
                displayDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No sales receipts found.</p>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #c41e3a; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Invoice No.</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Client</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Items Purchased</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Time</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Dispenser</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            reportsToDisplay.forEach((report, index) => {
                const dt = report.timestamp ? new Date(report.timestamp) : null;
                const date = dt ? dt.toLocaleDateString('en-GB') : 'â€”';
                const time = dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'â€”';
                const totalAmount = calculateReportTotal(report);
                const itemsPurchased = getItemsPurchased(report).join('; ');
                const dispenser = getReportDispenser(report) || 'â€”';
                
                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                html += `
                    <tr style="background: ${rowColor};">
                        <td style="padding: 10px; border: 1px solid #ddd;">${report.id}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${report.clientInfo?.fullName || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${itemsPurchased || 'â€”'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${time}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${dispenser}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">N$${totalAmount.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            displayDiv.innerHTML = html;
        }

        function getItemsPurchased(report) {
            if (Array.isArray(report.medicines) && report.medicines.length > 0) {
                return report.medicines.map(m => m.name).filter(Boolean);
            }
            if (Array.isArray(report.products) && report.products.length > 0) {
                return report.products.map(p => p.name || p.product || p.description).filter(Boolean);
            }
            return [];
        }

        function getReportDispenser(report) {
            // Prefer dispenser from any dispensed medicine
            if (Array.isArray(report.medicines)) {
                const dispensed = report.medicines.find(m => m.dispensedBy);
                if (dispensed && dispensed.dispensedBy) return dispensed.dispensedBy;
                const paidBy = report.medicines.find(m => m.paidBy);
                if (paidBy && paidBy.paidBy) return paidBy.paidBy;
            }
            // Fallbacks: consultant or explicit cashier fields if present
            return report.dispensedBy || report.cashier || report.consultant || null;
        }

        function setMISDateToday() {
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            const toLocal = (d) => {
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };
            if (fromInput) fromInput.value = toLocal(start);
            if (toInput) toInput.value = toLocal(end);
            filterMISReports();
        }

        function clearMISDateFilters() {
            const fromInput = document.getElementById('misDateFrom');
            const toInput = document.getElementById('misDateTo');
            if (fromInput) fromInput.value = '';
            if (toInput) toInput.value = '';
            filterMISReports();
        }

        function calculateReportTotal(report) {
            if (!report || !report.medicines || report.medicines.length === 0) return 0;

            try {
                // Derive client membership status if available
                let membership = report.clientInfo?.membershipStatus;
                if (!membership && typeof clients !== 'undefined' && Array.isArray(clients)) {
                    const clientRef = report.clientId || report.clientInfo?.referenceNumber || report.clientInfo?.nbNumber;
                    const client = clients.find(c => c.referenceNumber === clientRef);
                    membership = client?.membershipStatus;
                }

                if (membership === 'member' || membership === 'referred') {
                    const totals = calculatePrescriptionTotals(report.medicines, membership);
                    return membership === 'member' ? (totals.total?.dp || 0) : (totals.total?.cp || 0);
                }
            } catch (e) {}

            // Fallback: sum CP from currentPrice when membership is unknown
            return report.medicines.reduce((total, med) => {
                if (med.currentPrice) {
                    const quantity = med.quantity || 1;
                    return total + ((med.currentPrice.cp || 0) * quantity);
                }
                return total;
            }, 0);
        }

        function updateMISSummary(reportsToDisplay) {
            const totalCount = document.getElementById('misTotalCount');
            const branchSummary = document.getElementById('misBranchSummary');
            const stockSummary = document.getElementById('misStockSummary');
            
            if (totalCount) {
                totalCount.textContent = `Total Records: ${reportsToDisplay.length}`;
            }
            
            if (branchSummary) {
                const byBranch = {};
                reportsToDisplay.forEach(r => {
                    const key = r.branch || r.clientInfo?.branch || 'Unknown';
                    byBranch[key] = (byBranch[key] || 0) + 1;
                });
                const parts = Object.entries(byBranch).map(([k, v]) => `${k}: ${v}`);
                branchSummary.textContent = parts.length ? `By Branch: ${parts.join(' | ')}` : `Showing ${reportsToDisplay.length} receipt(s)`;
            }

            // Stock summary (company-wide quick view)
            if (stockSummary) {
                try {
                    const inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}');
                    const totals = Object.keys(inv).reduce((acc, k) => {
                        const q = parseFloat(inv[k]?.currentStock || 0);
                        const ro = inv[k]?.reorderLevel ?? 5;
                        acc.qty += q;
                        if (q <= ro) acc.low += 1;
                        return acc;
                    }, { qty: 0, low: 0 });
                    stockSummary.textContent = `Stock: Qty ${totals.qty} | Low ${totals.low}`;
                } catch (e) {
                    stockSummary.textContent = 'Stock: N/A';
                }
            }

            renderMISBranchDailySummary(reportsToDisplay);

            // Render inventory breakdown table (uses consolidated inventory for now)
            try {
                const branchId = document.getElementById('misBranchSelect')?.value || 'all';
                renderInventoryBreakdown('misInventoryBreakdown', branchId);
            } catch (e) {}
        }

        function refreshMISData() {
            refreshAllData().then(() => {
                displayMISReports();
                alert('MIS data refreshed successfully!');
                try {
                    const branchId = document.getElementById('misBranchSelect')?.value || 'all';
                    renderInventoryBreakdown('misInventoryBreakdown', branchId);
                } catch (e) {}
            });
        }

        function exportMISData() {
            const csv = convertReportsToCSV(reports);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MIS_Sales_Receipts_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function convertReportsToCSV(reportsData) {
            let csv = 'Receipt ID,Date,Client Name,NB Number,Phone,Email,Consultant,Total Amount,Medicines\n';
            
            reportsData.forEach(report => {
                const date = new Date(report.timestamp).toLocaleDateString('en-GB');
                const totalAmount = calculateReportTotal(report);
                const medicinesList = report.medicines?.map(m => m.name).join('; ') || 'N/A';
                
                csv += `"${report.id}",`;
                csv += `"${date}",`;
                csv += `"${report.clientInfo?.fullName || 'N/A'}",`;
                csv += `"${report.clientInfo?.nbNumber || 'N/A'}",`;
                csv += `"${report.clientInfo?.phone || 'N/A'}",`;
                csv += `"${report.clientInfo?.email || 'N/A'}",`;
                csv += `"${report.consultant || 'N/A'}",`;
                csv += `"N$${totalAmount.toFixed(2)}",`;
                csv += `"${medicinesList}"\n`;
            });
            
            return csv;
        }

        // Generic renderer for inventory breakdown tables using dynapharm_inventory
        function renderInventoryBreakdown(targetId, branchId = 'all') {
            const el = document.getElementById(targetId);
            if (!el) return;
            let inv = {};
            try { inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}'); } catch (e) { inv = {}; }
            const entries = Object.keys(inv).map(name => ({
                name,
                qty: parseFloat(inv[name]?.currentStock || 0),
                reorder: inv[name]?.reorderLevel ?? 5
            }));
            if (entries.length === 0) {
                el.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:20px;">No inventory records found.</p>';
                return;
            }
            const rows = entries.map(e => {
                const low = e.qty <= e.reorder;
                return `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${e.name}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right; font-weight:700; color:${low ? '#e74c3c' : '#27ae60'};">${e.qty}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${e.reorder}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${low ? 'âš ï¸ Low' : 'âœ… OK'}</td>
                    </tr>`;
            }).join('');
            el.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Product</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Qty</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Reorder</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }

        function printMISReport() {
            window.print();
        }

        function renderMISBranchDailySummary(reportsToDisplay) {
            const container = document.getElementById('misBranchDailySummary');
            if (!container) return;
            if (!reportsToDisplay || reportsToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No data for selected range.</p>';
                return;
            }
            const groups = {};
            reportsToDisplay.forEach(r => {
                const branch = r.branch || r.clientInfo?.branch || 'Unknown';
                if (!groups[branch]) {
                    groups[branch] = { count: 0, total: 0 };
                }
                groups[branch].count += 1;
                groups[branch].total += calculateReportTotal(r);
            });
            let html = '<table style="width: 100%; border-collapse: collapse;">\n<thead>\n<tr style="background: #2c3e50; color: white;">\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Branch</th>\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Receipts</th>\n<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Total Amount</th>\n</tr>\n</thead><tbody>';
            Object.entries(groups).forEach(([branch, stats], i) => {
                const rowColor = i % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${rowColor};"><td style="padding: 10px; border: 1px solid #ddd;">${branch}</td><td style="padding: 10px; border: 1px solid #ddd;">${stats.count}</td><td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">N$${stats.total.toFixed(2)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function calculateAge() {
            const dob = document.querySelector('[name="dob"]').value;
            if (dob) {
                const age = Math.floor((new Date() - new Date(dob)) / 31536000000);
                document.getElementById('age').value = age;
            }
        }

        function selectNA(fieldName) {
            const checkboxes = document.querySelectorAll(`[name="${fieldName}"]`);
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('mh_na').checked = true;
        }

        // Toggle diet options visibility based on user selection
        function toggleDietOptions() {
            try {
                const dietYes = document.getElementById('dietYes');
                const dietNo = document.getElementById('dietNo');
                const dietOptions = document.getElementById('dietOptions');
                const dietOther = document.querySelector('input[name="dietOther"]');
                
                if (!dietOptions) {
                    console.warn('âš ï¸ Diet options element not found');
                    return;
                }
                
                // Show diet options if "Yes" is selected, hide if "No" is selected
                if (dietYes && dietYes.checked) {
                    dietOptions.style.display = 'block';
                    if (dietOther) {
                        dietOther.style.display = 'block';
                        dietOther.style.marginTop = '10px';
                    }
                    // Make selection required when visible
                    dietOptions.setAttribute('required', 'required');
                } else if (dietNo && dietNo.checked) {
                    dietOptions.style.display = 'none';
                    if (dietOther) {
                        dietOther.style.display = 'none';
                        dietOther.value = '';
                    }
                    // Clear selections when hidden
                    const options = dietOptions.querySelectorAll('option');
                    options.forEach(opt => opt.selected = false);
                    dietOptions.removeAttribute('required');
                }
            } catch (error) {
                console.error('âŒ Error in toggleDietOptions:', error);
            }
        }
        
        // Make function globally accessible for inline event handlers
        if (typeof window !== 'undefined') {
            window.toggleDietOptions = toggleDietOptions;
        }

        // Enhanced signature with camera support
        function signDocument() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Check if user wants to use camera or enter text
                const useCamera = confirm('Would you like to capture signature using camera? (Click OK for camera, Cancel for text input)');
                if (useCamera) {
                    captureSignatureWithCamera();
                } else {
            const name = prompt('Enter your full name for signature:');
            if (name) {
                document.getElementById('signatureField').value = name;
                document.getElementById('signaturePad').innerHTML = `Signed: ${name}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
                    }
                }
            } else {
                const name = prompt('Enter your full name for signature:');
                if (name) {
                    document.getElementById('signatureField').value = name;
                    document.getElementById('signaturePad').innerHTML = `Signed: ${name}<br>${new Date().toLocaleString()}`;
                    document.getElementById('signaturePad').style.background = '#e8f5e9';
                }
            }
        }

        function captureSignatureWithCamera() {
            const video = document.createElement('video');
            video.style.width = '100%';
            video.style.maxWidth = '400px';
            video.autoplay = true;
            video.playsInline = true;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;';
            
            const container = document.createElement('div');
            container.style.cssText = 'background: white; padding: 20px; border-radius: 10px; max-width: 90%;';

            const controls = document.createElement('div');
            controls.style.cssText = 'margin-top: 15px; display: flex; gap: 10px; justify-content: center;';

            const captureBtn = document.createElement('button');
            captureBtn.className = 'btn btn-success';
            captureBtn.textContent = 'ðŸ“· Capture';
            captureBtn.onclick = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                const dataURL = canvas.toDataURL('image/png');
                document.getElementById('signatureField').value = 'Signature captured';
                document.getElementById('signaturePad').innerHTML = `<img src="${dataURL}" style="max-width: 100%; border-radius: 5px;" alt="Signature"><br>Captured: ${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
                // Store signature image
                localStorage.setItem('lastSignature', dataURL);
                stopCamera();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = stopCamera;

            controls.appendChild(captureBtn);
            controls.appendChild(cancelBtn);
            container.appendChild(video);
            container.appendChild(controls);
            modal.appendChild(container);
            document.body.appendChild(modal);

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    window.captureStream = stream;
                })
                .catch(err => {
                    alert('Camera access denied. Please enter signature manually.');
                    document.body.removeChild(modal);
                });

            function stopCamera() {
                if (window.captureStream) {
                    window.captureStream.getTracks().forEach(track => track.stop());
                }
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }
        }

        function handleConsentChange() {
            const consentCheck = document.getElementById('consentCheck');
            const fullName = document.querySelector('input[name="fullName"]').value.trim();
            
            if (consentCheck.checked && fullName) {
                // Auto-fill signature with client's name
                document.getElementById('signatureField').value = fullName;
                document.getElementById('signaturePad').innerHTML = `Signed: ${fullName}<br>${new Date().toLocaleString()}`;
                document.getElementById('signaturePad').style.background = '#e8f5e9';
            } else if (!consentCheck.checked) {
                // Clear signature if consent is unchecked
                document.getElementById('signatureField').value = '';
                document.getElementById('signaturePad').innerHTML = 'Click here to sign electronically';
                document.getElementById('signaturePad').style.background = '#f0f8ff';
            }
        }

        function printClientForm() {
            // Get form data
            const formData = new FormData(document.getElementById('clientForm'));
            const branchSelect = document.getElementById('branchSelect');
            const branchName = branchSelect.options[branchSelect.selectedIndex]?.text || 'Select Branch';
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Client Registration Form</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 8mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 8pt;
                            line-height: 1.2;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 6px 10px;
                            text-align: center;
                            border-radius: 3px;
                            margin-bottom: 6px;
                        }
                        
                        .header h1 {
                            font-size: 14pt;
                            margin-bottom: 2px;
                        }
                        
                        .header p {
                            font-size: 7pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin-bottom: 5px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 3px 6px;
                            font-size: 9pt;
                            font-weight: bold;
                            border-radius: 2px;
                            margin-bottom: 3px;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 3px 8px;
                            background: #f8f9fa;
                            padding: 5px;
                            border-radius: 2px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 7pt;
                            line-height: 1.1;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 60px;
                            font-size: 7pt;
                        }
                        
                        .info-item[style*="grid-column: span 2"] {
                            grid-column: span 2;
                        }
                        
                        .info-item[style*="grid-column: span 3"] {
                            grid-column: span 3;
                        }
                        
                        .footer {
                            margin-top: 6px;
                            padding-top: 5px;
                            border-top: 1px solid #c41e3a;
                            font-size: 6pt;
                            text-align: center;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ðŸ¥ DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>CLIENT REGISTRATION FORM</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ðŸ‘¤ PERSONAL INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${formData.get('fullName') || ''}</div>
                            
                            <div class="info-item"><strong>Gender:</strong> ${formData.get('gender') || ''}</div>
                            <div class="info-item"><strong>DOB:</strong> ${formData.get('dob') || ''}</div>
                            <div class="info-item"><strong>Age:</strong> ${formData.get('age') || ''}y</div>
                            <div class="info-item"><strong>Height:</strong> ${formData.get('height') || ''}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${formData.get('weight') || ''}kg</div>
                            <div class="info-item"><strong>Phone:</strong> ${formData.get('phone') || ''}</div>
                            <div class="info-item"><strong>Email:</strong> ${formData.get('email') || ''}</div>
                            <div class="info-item"><strong>Occupation:</strong> ${formData.get('occupation') || ''}</div>
                            <div class="info-item" style="grid-column: span 2;"><strong>Emergency:</strong> ${formData.get('emergencyContact') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ðŸ‘¥ MEMBERSHIP/REFERRAL</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Status:</strong> ${formData.get('membershipStatus') === 'member' ? 'Member' : 'Referred'}</div>
                            ${formData.get('membershipStatus') === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${formData.get('memberId') || 'N/A'}</div>
                                <div class="info-item"><strong>Since:</strong> ${formData.get('memberSince') || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${formData.get('referralName') || 'N/A'}</div>
                                <div class="info-item"><strong>NB:</strong> ${formData.get('referralNbNumber') || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ðŸ¥ HEALTH INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;"><strong>Primary Reason:</strong> ${formData.get('primaryReason') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Surgeries:</strong> ${formData.get('surgeries') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Current Medications:</strong> ${formData.get('currentMedications') || ''}</div>
                            <div class="info-item" style="grid-column: span 3;"><strong>Supplements:</strong> ${formData.get('supplements') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ðŸŽ LIFESTYLE</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Water:</strong> ${formData.get('waterIntake') || ''}</div>
                            <div class="info-item"><strong>Exercise:</strong> ${formData.get('exerciseFreq') || ''}</div>
                            <div class="info-item"><strong>Sleep:</strong> ${formData.get('sleepHours') || ''}h</div>
                            <div class="info-item"><strong>Stress:</strong> ${formData.get('stressLevel') || ''}/10</div>
                            <div class="info-item"><strong>Smoking:</strong> ${formData.get('smoking') || ''}</div>
                            <div class="info-item"><strong>Alcohol:</strong> ${formData.get('alcohol') || ''}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">âœ… CONSENT & SIGNATURE</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 3;">
                                <strong>Consent:</strong> I consent to naturopathic care and understand all details are kept confidential.
                            </div>
                            <div class="info-item"><strong>Signature:</strong> ${formData.get('signature') || 'Not signed'}</div>
                            <div class="info-item"><strong>Date:</strong> ${new Date().toLocaleString()}</div>
                            <div class="info-item"></div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Confidential Registration Form</strong> - For inquiries: info@dynapharm.com.na | www.dynapharm.com.na</p>
                        <p>âœ“ 2-Page Maximum Format | This information is confidential and for internal use only</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const visitType = formData.get('visitType') || '';
            const preferredBranch = formData.get('preferredBranch') || currentBranch || (function(){
                const checkSel = document.getElementById('checkupBranchSelect');
                return checkSel ? checkSel.value : '';
            })();
            if (!preferredBranch) {
                alert('Please select a branch.');
                return;
            }

            const preferredDate = formData.get('preferredDate');
            const preferredTime = formData.get('preferredTime');
            // Appointment preferences required only when booking appointment

            currentBranch = preferredBranch;
            const checkSel = document.getElementById('checkupBranchSelect');
            if (checkSel) checkSel.value = preferredBranch;

            const fullName = (formData.get('fullName') || '').trim();
            if (!fullName) {
                alert('Full Name is required');
                return;
            }
            const membershipStatus = formData.get('membershipStatus');
            const referralName = formData.get('referralName')?.trim();
            const referralNbNumber = formData.get('referralNbNumber')?.trim();
            
            // Referral details not required for simplified registration
            if (false && membershipStatus === 'referred') {
                if (!referralName) {
                    alert('âŒ Referral Name is required for referred clients');
                    return;
                }
                
                if (!referralNbNumber) {
                    alert('âŒ Referral NB Number is required for referred clients');
                    return;
                }
                
                // Validate NB number format (NB followed by any digits including 0)
                if (!/^NB[0-9]+$/.test(referralNbNumber)) {
                    alert('âŒ Please enter a valid Referral NB Number (NB followed by any digits, e.g., NB12345678 or NB01234567)');
                    return;
                }
            }
            
            const firstName = fullName.split(' ')[0].toUpperCase();
            const referenceNumber = `CLT-${firstName}-${Date.now()}`;
            
            // Get NB number if it exists in form (may be optional)
            const nbNumber = formData.get('nbNumber')?.trim() || '';
            
            const client = {
                referenceNumber: referenceNumber,
                fullName: fullName,
                nbNumber: nbNumber, // Include NB number if provided
                email: formData.get('email') || '',
                phone: formData.get('phone') || '',
                membershipStatus: membershipStatus,
                referralName: referralName || '',
                referralNbNumber: referralNbNumber || '',
                memberId: formData.get('memberId') || '',
                memberSince: formData.get('memberSince') || '',
                gender: formData.get('gender') || '',
                dob: formData.get('dob') || '',
                age: formData.get('age') || '',
                height: formData.get('height') || '',
                weight: formData.get('weight') || '',
                occupation: formData.get('occupation') || '',
                emergencyContact: formData.get('emergencyContact') || '',
                primaryReason: formData.get('primaryReason') || '',
                medicalHistory: formData.getAll('medicalHistory') || [],
                currentMedications: formData.get('currentMedications') || '',
                supplements: formData.get('supplements') || '',
                familyHistory: formData.getAll('familyHistory') || [],
                waterIntake: formData.get('waterIntake') || '',
                exerciseFreq: formData.get('exerciseFreq') || '',
                sleepHours: formData.get('sleepHours') || '',
                stressLevel: formData.get('stressLevel') || '',
                symptoms: formData.getAll('symptoms') || [],
                signature: formData.get('signature') || '',
                preferredAppointment: (visitType === 'walkin') ? null : {
                    date: preferredDate,
                    time: preferredTime,
                    branch: preferredBranch
                },
                branch: preferredBranch,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Validate required fields before submitting
                if (!client.fullName || !client.phone || !client.email || !client.branch) {
                    alert('âŒ Missing required fields. Please check:\n- Full Name\n- Phone Number\n- Email Address\n- Branch selection');
                    return;
                }
                
                const result = await apiRequest('/clients', 'POST', client);
                
                // Handle different response formats
                const success = result?.success || (result?.client && result?.total !== undefined) || (result?.id && !result?.error);
                
                if (success) {
                    // Add to clients array
                    clients.push(client);
                    
                    // IMPORTANT: Save to localStorage immediately for persistence
                    // This ensures data persists even if API fails later or on refresh
                    try {
                        localStorage.setItem('dyna_clients', JSON.stringify(clients));
                        console.log(`âœ… Client saved to localStorage: ${referenceNumber}`);
                    } catch (storageError) {
                        console.error('âŒ Error saving client to localStorage:', storageError);
                        // Continue anyway - API save was successful
                    }
                    
                    // Realtime: notify other portals about new client
                    try {
                        // Publish via Vercel SSE channel "clients"
                        fetch('/api/realtime_publish', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                channel: 'clients',
                                event: { type: 'clients:updated', referenceNumber, action: 'created', ts: Date.now() }
                            })
                        }).catch(_ => {});
                    } catch(_) {}
                    try {
                        // Publish via Railway WebSocket gateway if configured
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'clients:updated', referenceNumber, action: 'created', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                    } catch(_) {}
            
                    const refEl = document.getElementById('clientRefNumber');
                    if (refEl) {
                        refEl.textContent = 'Reference Number: ' + referenceNumber;
                        refEl.style.display = 'block';
                    }
            
                    alert(`âœ… Client saved successfully!\n\nReference: ${referenceNumber}\n${client.referralName ? `Referred by: ${client.referralName}\n\n` : ''}Save this reference number for future visits.`);

            // If appointment flow, create a simple appointment record
            try {
                if (visitType === 'appointment') {
                    const preferredDate = formData.get('preferredDate');
                    const preferredTime = formData.get('preferredTime');
                    if (!preferredDate || !preferredTime) {
                        alert('Please select a preferred appointment date and time.');
                    } else {
                        const appointment = {
                            id: 'APT' + Date.now(),
                            date: preferredDate,
                            time: preferredTime,
                            clientName: fullName,
                            branch: preferredBranch,
                            serviceType: 'Full Body Check-Up',
                            status: 'requested',
                            createdAt: new Date().toISOString(),
                            clientReference: referenceNumber,
                            clientForm: client
                        };
                        try {
                            appointments.push(appointment);
                            localStorage.setItem('dyna_appointments', JSON.stringify(appointments));
                        } catch(_){ }
                        
                        // Also save to dyna_consult_appointments for appointments-admin.html
                        try {
                            const consultAppts = JSON.parse(localStorage.getItem('dyna_consult_appointments') || '[]');
                            const consultAppt = {
                                id: 'appt_' + Date.now(),
                                fullName: fullName,
                                phone: client.phone,
                                email: client.email,
                                date: preferredDate,
                                time: preferredTime,
                                branch: preferredBranch,
                                type: 'Full Body Check-Up',
                                status: 'pending',
                                createdAt: new Date().toISOString(),
                                clientReference: referenceNumber,
                                clientForm: client
                            };
                            consultAppts.push(consultAppt);
                            localStorage.setItem('dyna_consult_appointments', JSON.stringify(consultAppts));
                        } catch(_){ }
                        
                        (function(msg){
                            const el = document.createElement('div');
                            el.style.cssText = 'position:fixed;top:20px;right:20px;background:#111827;color:#fff;border-left:4px solid #16a34a;padding:12px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:9999;';
                            el.textContent = msg;
                            document.body.appendChild(el);
                            setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity 300ms'; setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); }, 320); }, 2500);
                        })(`âœ… Appointment request sent. Ref: ${referenceNumber} (${preferredDate} @ ${preferredTime})`);
                    }
                }
            } catch (e) { console.warn('Appointment creation step skipped:', e); }
            
            if (confirm('Print form?')) {
                window.print();
                    }
                } else {
                    alert('âŒ Error saving client: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('âŒ Error saving client:', error);
                console.error('Error details:', {
                    message: error?.message,
                    stack: error?.stack,
                    client: client
                });
                
                // Show user-friendly error message
                let errorMsg = 'âŒ Error saving client form:\n\n';
                if (error?.message) {
                    errorMsg += `Error: ${error.message}\n\n`;
                }
                errorMsg += 'Please check:\n';
                errorMsg += '1. All required fields are filled\n';
                errorMsg += '2. Internet connection is active\n';
                errorMsg += '3. Browser console for details (F12)\n\n';
                errorMsg += 'Attempting to save locally as backup...';
                
                // Fallback: Save directly to localStorage if API fails
                try {
                    clients.push(client);
                    localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    
                    const refEl = document.getElementById('clientRefNumber');
                    if (refEl) {
                        refEl.textContent = 'Reference Number: ' + referenceNumber;
                        refEl.style.display = 'block';
                    }
                    
                    alert(`âš ï¸ API unavailable, but client saved locally!\n\nReference: ${referenceNumber}\n${client.referralName ? `Referred by: ${client.referralName}\n\n` : ''}Save this reference number. Data will sync when API is available.`);
                    
                    // Broadcast client update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('clients:updated', { 
                            detail: { client: referenceNumber, action: 'created', ts: Date.now() } 
                        }));
                    } catch(_) {}
                    
                } catch (fallbackError) {
                    console.error('âŒ Critical: Failed to save client even to localStorage:', fallbackError);
                    alert('âŒ Critical Error: Failed to save client.\n\nError: ' + (fallbackError?.message || 'Unknown error') + '\n\nPlease:\n1. Take a screenshot of this error\n2. Contact support\n3. Copy your form data before refreshing');
                }
            }
        });

        function clearForm() {
            if (confirm('Are you sure you want to clear the entire form? All data will be lost.')) {
                const form = document.getElementById('clientForm');
                if (!form) return;
                form.reset();

                const signatureField = document.getElementById('signatureField');
                if (signatureField) signatureField.value = '';
                const signaturePad = document.getElementById('signaturePad');
                if (signaturePad) {
                    signaturePad.innerHTML = 'Tap to sign electronically';
                    signaturePad.style.background = '#fff6f8';
                }

                const memberDetails = document.getElementById('memberDetails');
                const referralDetails = document.getElementById('referralDetails');
                if (memberDetails) memberDetails.style.display = 'none';
                if (referralDetails) referralDetails.style.display = 'none';
                document.querySelectorAll('.membership-option').forEach(option => option.classList.remove('active'));

                const visitBadge = document.getElementById('visitTypeBadge');
                if (visitBadge) visitBadge.textContent = 'â€”';
                const referencePreview = document.getElementById('referencePreview');
                if (referencePreview) referencePreview.textContent = 'Generated on save';
                const preferredDateDisplay = document.getElementById('preferredDateDisplay');
                if (preferredDateDisplay) preferredDateDisplay.textContent = 'â€”';
                const refNumberDisplay = document.getElementById('clientRefNumber');
                if (refNumberDisplay) refNumberDisplay.style.display = 'none';

                initializeAppointmentPreferences();
            }
        }

        function printClientForm() {
            // Ensure we're on the client tab
            openTab('client');
            
            // Add a small delay to ensure the tab is active
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function showLogin(portal) {
            currentPortal = portal;
            window.currentPortal = portal; // Set global for permission checks
            // Update modal title to show which portal
            const modalTitle = document.querySelector('#loginModal h2');
            modalTitle.textContent = `${portal.charAt(0).toUpperCase() + portal.slice(1)} Portal Login`;
            document.getElementById('loginModal').style.display = 'block';
            // Clear previous values
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // Auto-login functions REMOVED - All portals now require proper authentication

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            console.log('=== LOGIN DEBUG START ===');
            console.log('Username:', username, 'Password entered:', password ? '***' : '(empty)');
            console.log('Current portal:', currentPortal);
            
            // Get users directly from localStorage to avoid timing issues
            let loginUsers = safeParseFromStorage('dyna_users', DEFAULT_USERS_JSON);
            console.log('Users from localStorage:', loginUsers);
            
            // If no users found, try to load from API/fallback
            if (!loginUsers || loginUsers.length === 0) {
                console.log('No users in localStorage, loading from API...');
                await loadData();
                loginUsers = users;
                console.log('Users after loadData:', loginUsers);
            }
            
            console.log('Total users available:', loginUsers ? loginUsers.length : 0);
            console.log('User names:', loginUsers ? loginUsers.map(u => u.username) : 'none');
            
            // Try to find the user
            const user = loginUsers ? loginUsers.find(u => u.username === username && u.password === password) : null;
            console.log('Found user:', user ? user.username + ' (' + user.role + ')' : 'NOT FOUND');
            
            if (!user) {
                console.log('=== LOGIN FAILED ===');
                alert('Invalid username or password');
                return;
            }
            
            console.log('User found! Role:', user.role, 'Required portal:', currentPortal);
            console.log('User details:', JSON.stringify(user, null, 2));
            
            if (user.role !== currentPortal) {
                console.log('=== ROLE MISMATCH ===');
                console.log('DEBUG: Showing content anyway for troubleshooting');
                // Temporarily allow any role to login to consultant portal for debugging
                if (currentPortal === 'consultant') {
                    console.log('DEBUG: Bypassing role check for consultant portal');
                } else {
                    alert(`This user is a ${user.role}, not a ${currentPortal}. Please use the correct portal.`);
                    return;
                }
            }
            
            console.log('=== LOGIN SUCCESS ===');
            console.log('Displaying content for portal:', currentPortal);

            // Initialize branch selection for consultant/dispenser (optional - not required for login)
            try {
                if (currentPortal === 'consultant' || currentPortal === 'dispenser') {
                    if (!currentBranch || currentBranch === '') {
                        if (user.branch) {
                            // Auto-assign single branch users
                            currentBranch = user.branch;
                            const sel = document.getElementById('branchSelect');
                            if (sel) sel.value = currentBranch;
                            const checkSel = document.getElementById('checkupBranchSelect');
                            if (checkSel) checkSel.value = currentBranch;
                        } else if (Array.isArray(user.branches) && user.branches.length > 0) {
                            // Auto-select first branch if user has multiple branches assigned
                            currentBranch = user.branches[0];
                            const sel = document.getElementById('branchSelect');
                            if (sel) sel.value = currentBranch;
                            const checkSel = document.getElementById('checkupBranchSelect');
                            if (checkSel) checkSel.value = currentBranch;
                        }
                        // If no branch is available, user can proceed and select branch when needed for specific operations
                    }
                }
            } catch (e) { /* no-op */ }

            // Login successful
            currentUser = user;
            window.currentUser = user; // Set global for permission checks
            window.currentPortal = currentPortal; // Set global for permission checks
            setCurrentUserRole(user.role); // Store role in localStorage
            closeModal('loginModal');
            
            const authElement = document.getElementById(currentPortal + 'Auth');
            const contentElement = document.getElementById(currentPortal + 'Content');
            
            console.log('Auth element:', authElement, 'Display:', authElement ? authElement.style.display : 'not found');
            console.log('Content element:', contentElement, 'Display:', contentElement ? contentElement.style.display : 'not found');
            
            if (authElement) authElement.style.display = 'none';
            if (contentElement) contentElement.style.display = 'block';
            
            console.log('After update - Auth display:', authElement ? authElement.style.display : 'not found');
            console.log('After update - Content display:', contentElement ? contentElement.style.display : 'not found');
            
            // Start real-time synchronization (delayed to avoid login conflicts)
            setTimeout(() => {
                startAutoRefresh();
                showRealtimeStatus();
            }, 2000);
            
            const branchName = branches.find(b => b.id === user.branch)?.name || 'Unknown';
            const profile = document.getElementById(currentPortal + 'Profile');
            if(profile) {
                profile.innerHTML = `
                    <h4>Welcome, ${user.fullName}</h4>
                    <p>Role: ${user.role} | Branch: ${branchName}</p>
                    <button class="btn btn-warning" onclick="showChangePassword()">Change Password</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            }
            
            if (currentPortal === 'consultant') {
                displayClients();
                displayMyReports();
                displayFollowUps();
            }
            if (currentPortal === 'dispenser') {
                displayPrescriptions();
                displayPriceList();
                // Show Branch Stock by default after login
                showDispenserTab('stock');
            }
            if (currentPortal === 'mis') {
                loadMISBranches();
                displayMISReports();
            }
            if (currentPortal === 'admin') {
                loadUserList();
                loadBranchListAdmin();
            }
            
            alert(`Welcome, ${user.fullName}! Real-time sync activated.`);
        });

        function logout() {
            currentUser = null;
            window.currentUser = null; // Clear global for permission checks
            window.currentPortal = null; // Clear global
            setCurrentUserRole('guest'); // Reset role
            stopAutoRefresh();
            hideRealtimeStatus();
            document.getElementById(currentPortal + 'Auth').style.display = 'block';
            document.getElementById(currentPortal + 'Content').style.display = 'none';
            openTab('client');
        }

        async function displayClients() {
            // Refresh data from API
            await loadData();
            
            const list = document.getElementById('clientList');
            if (clients.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ“‹ No clients registered</h3><p>Clients will appear here once they register through the client portal.</p></div>';
                return;
            }
            
            // Sort clients by timestamp - latest first
            const sortedClients = [...clients].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            sortedClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'ðŸ‘¤ Member' : 'ðŸ¤ Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>ðŸ“ž Phone:</strong> ${client.phone}</p>
                        <p><strong>ðŸŽ‚ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>ðŸ‘¤ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>ðŸ†” Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>ðŸ‘¤ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>ðŸ‘¤ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>ðŸ†” Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>ðŸ“… Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>ðŸŽ¯ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">ðŸ“ Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">ðŸ‘ï¸ View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Search functionality for consultant portal
        function searchClients(portal) {
            const searchTerm = document.getElementById('consultantSearch').value.toLowerCase();
            const list = document.getElementById('clientList');
            
            if (!searchTerm) {
                displayClients();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.fullName.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                client.referenceNumber.toLowerCase().includes(searchTerm) ||
                client.nbNumber.includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ” No clients found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Sort search results by timestamp - latest first
            filteredClients.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = '';
            filteredClients.forEach(client => {
                const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Reference: ${client.referenceNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${client.membershipStatus === 'member' ? '#e8f5e9' : '#fff3cd'}; color: ${client.membershipStatus === 'member' ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">${client.membershipStatus === 'member' ? 'ðŸ‘¤ Member' : 'ðŸ¤ Referred'}</span>
                            <span style="background: #e8f5e9; color: #27ae60; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; margin-left: 5px;">${branchName}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>ðŸ“ž Phone:</strong> ${client.phone}</p>
                        <p><strong>ðŸŽ‚ DOB:</strong> ${client.dob || 'Not provided'}</p>
                        <p><strong>ðŸ‘¤ Age:</strong> ${client.age || 'N/A'} years</p>
                        ${client.membershipStatus === 'member' ? `
                            <p><strong>ðŸ†” Namibian ID:</strong> ${client.nbNumber}</p>
                            <p><strong>ðŸ‘¤ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>ðŸ‘¤ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>ðŸ†” Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `}
                        <p><strong>ðŸ“… Registered:</strong> ${new Date(client.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>ðŸŽ¯ Primary Reason:</strong> ${client.primaryReason}</p>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="createReport('${client.referenceNumber}')">ðŸ“ Create Report</button>
                        <button class="btn btn-info" onclick="viewClientDetails('${client.referenceNumber}')">ðŸ‘ï¸ View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllClients(portal) {
            document.getElementById('consultantSearch').value = '';
            displayClients();
        }

        async function refreshConsultantData() {
            await loadData();
            await displayClients();
            await displayMyReports();
            await displayFollowUps();
            await refreshAnalytics();
        }

        async function refreshAnalytics() {
            await loadData();
            
            const display = document.getElementById('analyticsDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Performance Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalClients}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Total Clients</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 28pt; margin-bottom: 5px;">${analyticsData.totalReports}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Reports Created</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 28pt; margin-bottom: 5px;">${analyticsData.followUpsDue}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Follow-ups Due</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 28pt; margin-bottom: 5px;">${analyticsData.conversionRate}%</h3>
                            <p style="color: #666; font-size: 0.9rem;">Member Conversion</p>
                        </div>
                    </div>

                    <!-- Client Type Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ‘¥ Client Distribution</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Registered Members:</span>
                                    <strong style="color: #27ae60;">${analyticsData.memberClients}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.memberPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Referred Clients:</span>
                                    <strong style="color: #f39c12;">${analyticsData.referredClients}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 10px; border-radius: 5px;">
                                    <div style="background: #f39c12; height: 100%; width: ${analyticsData.referredPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ“… Follow-up Compliance</h4>
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Completed Follow-ups:</span>
                                    <strong style="color: #27ae60;">${analyticsData.completedFollowUps}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${analyticsData.followUpCompleteRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Missed Follow-ups:</span>
                                    <strong style="color: #e74c3c;">${analyticsData.missedFollowUps}</strong>
                                </div>
                                <div style="background: #ffebee; height: 10px; border-radius: 5px;">
                                    <div style="background: #e74c3c; height: 100%; width: ${analyticsData.followUpMissedRate}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                Compliance Rate: <strong style="color: #2196f3;">${analyticsData.followUpCompleteRate}%</strong>
                            </p>
                        </div>
                    </div>

                    <!-- Top Prescribed Products -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ’Š Top Prescribed Products</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Times Prescribed</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">% of Scripts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analyticsData.topProducts.slice(0, 10).map((product, idx) => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                        <td style="padding: 8px;">${product.name}</td>
                                        <td style="padding: 8px; text-align: center;">${product.count}</td>
                                        <td style="padding: 8px; text-align: right;">
                                            <div style="display: inline-block; width: 60px; background: #e8f5e9; height: 8px; border-radius: 4px; vertical-align: middle;">
                                                <div style="background: #27ae60; height: 100%; width: ${product.percentage}%; border-radius: 4px;"></div>
                                            </div>
                                            <span style="margin-left: 5px;">${product.percentage}%</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Common Symptoms Treated -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ©º Common Symptoms Treated</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            ${analyticsData.topSymptoms.slice(0, 8).map(symptom => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.9rem;">${symptom.name}</span>
                                        <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                            ${symptom.count}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateConsultantAnalytics(timeframe) {
            // Safety check for currentUser
            if (!currentUser || !currentUser.fullName) {
                console.warn('âš ï¸ currentUser not set, cannot calculate consultant analytics');
                return { totalReports: 0, totalClients: 0, totalRevenue: 0 };
            }
            const userFullName = currentUser.fullName; // Capture to prevent race conditions
            const myReports = reports.filter(r => r && r.consultant === userFullName);
            const myClients = clients.filter(c => {
                return myReports.some(r => r.clientId === c.referenceNumber);
            });
            
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = myReports.filter(r => new Date(r.timestamp) >= startDate);
            const filteredClients = myClients.filter(c => new Date(c.timestamp) >= startDate);
            
            // Calculate metrics
            const memberClients = filteredClients.filter(c => c.membershipStatus === 'member').length;
            const referredClients = filteredClients.filter(c => c.membershipStatus === 'referred').length;
            const totalClients = filteredClients.length;
            
            // Follow-up tracking
            const reportsWithFollowUp = filteredReports.filter(r => r.followUpDate);
            const followUpsDue = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                return followUpDate < new Date();
            }).length;
            
            // Check for completed follow-ups (client has another report after follow-up date)
            const completedFollowUps = reportsWithFollowUp.filter(r => {
                const followUpDate = new Date(r.followUpDate);
                const hasReturnVisit = myReports.some(r2 => 
                    r2.clientId === r.clientId && 
                    new Date(r2.timestamp) > followUpDate &&
                    r2.id !== r.id
                );
                return hasReturnVisit;
            }).length;
            
            const missedFollowUps = followUpsDue - completedFollowUps;
            const followUpCompleteRate = followUpsDue > 0 ? Math.round((completedFollowUps / followUpsDue) * 100) : 0;
            const followUpMissedRate = followUpsDue > 0 ? Math.round((missedFollowUps / followUpsDue) * 100) : 0;
            
            // Product prescription trends
            const productCounts = {};
            let totalPrescriptions = 0;
            
            filteredReports.forEach(r => {
                if (r.medicines) {
                    r.medicines.forEach(med => {
                        productCounts[med.name] = (productCounts[med.name] || 0) + 1;
                        totalPrescriptions++;
                    });
                }
            });
            
            const topProducts = Object.entries(productCounts)
                .map(([name, count]) => ({
                    name,
                    count,
                    percentage: Math.round((count / totalPrescriptions) * 100)
                }))
                .sort((a, b) => b.count - a.count);
            
            // Symptom tracking
            const symptomCounts = {};
            
            filteredReports.forEach(r => {
                if (r.symptoms) {
                    r.symptoms.forEach(s => {
                        symptomCounts[s.symptom] = (symptomCounts[s.symptom] || 0) + 1;
                    });
                }
            });
            
            const topSymptoms = Object.entries(symptomCounts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
            
            // Conversion rate (referred â†’ member)
            const referredCount = myClients.filter(c => c.membershipStatus === 'referred').length;
            const conversionRate = referredCount > 0 ? Math.round((memberClients / (memberClients + referredCount)) * 100) : 0;
            
            return {
                totalClients: totalClients,
                totalReports: filteredReports.length,
                memberClients,
                referredClients,
                memberPercentage: totalClients > 0 ? Math.round((memberClients / totalClients) * 100) : 0,
                referredPercentage: totalClients > 0 ? Math.round((referredClients / totalClients) * 100) : 0,
                followUpsDue,
                completedFollowUps,
                missedFollowUps,
                followUpCompleteRate,
                followUpMissedRate,
                topProducts,
                topSymptoms,
                conversionRate
            };
        }

        function showAppointmentCalendar() {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const isVisible = calendarDiv.style.display !== 'none';
            calendarDiv.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                renderCalendar(new Date());
            }
        }

        function renderCalendar(currentDate) {
            const calendarDiv = document.getElementById('appointmentCalendar');
            if (!calendarDiv) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get appointments for this month
            const monthAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getMonth() === month && aptDate.getFullYear() === year;
            });
            
            let calendarHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #c41e3a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-sm" onclick="changeMonth(-1)">â—€ Previous</button>
                        <h3 style="color: #c41e3a;">${monthNames[month]} ${year}</h3>
                        <button class="btn btn-sm" onclick="changeMonth(1)">Next â–¶</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                            <div style="background: #c41e3a; color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px;">
                                ${day}
                            </div>
                        `).join('')}
                        
                        ${Array(startingDayOfWeek).fill(null).map(() => 
                            '<div style="background: #f8f9fa; padding: 20px; border-radius: 5px;"></div>'
                        ).join('')}
                        
                        ${Array(daysInMonth).fill(null).map((_, i) => {
                            const day = i + 1;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const today = new Date();
                            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                            
                            const dayAppointments = monthAppointments.filter(apt => 
                                apt.date.startsWith(dateStr)
                            );
                            
                            return `
                                <div onclick="selectCalendarDate('${dateStr}')" 
                                     style="background: ${isToday ? '#e3f2fd' : 'white'}; 
                                            border: 2px solid ${dayAppointments.length > 0 ? '#27ae60' : '#ddd'}; 
                                            padding: 10px; 
                                            border-radius: 5px; 
                                            cursor: pointer; 
                                            text-align: center;
                                            transition: all 0.3s;
                                            position: relative;">
                                    <div style="font-weight: bold; font-size: 14pt; color: ${isToday ? '#2196f3' : '#2c3e50'};">
                                        ${day}
                                    </div>
                                    ${dayAppointments.length > 0 ? `
                                        <div style="background: #27ae60; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; margin-top: 5px;">
                                            ${dayAppointments.length} apt${dayAppointments.length > 1 ? 's' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div id="selectedDateAppointments" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <!-- Appointments for selected date will appear here -->
                    </div>
                </div>
            `;
            
            calendarDiv.innerHTML = calendarHTML;
            window.currentCalendarDate = currentDate;
        }

        function changeMonth(delta) {
            if (!window.currentCalendarDate) {
                window.currentCalendarDate = new Date();
            }
            
            window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
            renderCalendar(window.currentCalendarDate);
        }

        function selectCalendarDate(dateStr) {
            const selectedDiv = document.getElementById('selectedDateAppointments');
            if (!selectedDiv) return;
            
            const dayAppointments = appointments.filter(apt => apt.date.startsWith(dateStr));
            
            if (dayAppointments.length === 0) {
                selectedDiv.style.display = 'block';
                selectedDiv.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p style="margin-bottom: 15px;"><strong>No appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</strong></p>
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">âž• Book Appointment for This Date</button>
                    </div>
                `;
                return;
            }
            
            selectedDiv.style.display = 'block';
            selectedDiv.innerHTML = `
                <div>
                    <h4 style="color: #c41e3a; margin-bottom: 15px;">ðŸ“… Appointments on ${new Date(dateStr).toLocaleDateString('en-GB')}</h4>
                    ${dayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${apt.clientName}</strong>
                                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        â° ${apt.time} | ðŸ‘¨â€âš•ï¸ ${apt.consultant}
                                    </p>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #888; margin-top: 5px;">ðŸ“ ${apt.notes}</p>` : ''}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="cancelAppointment('${apt.id}')">âŒ Cancel</button>
                            </div>
                        </div>
                    `).join('')}
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="quickBookAppointment('${dateStr}')">âž• Add Another Appointment</button>
                    </div>
                </div>
            `;
        }

        function bookAppointment() {
            const date = prompt('Enter appointment date (YYYY-MM-DD or leave blank for today):');
            const appointmentDate = date || new Date().toISOString().split('T')[0];
            
            const time = prompt('Enter appointment time (HH:MM in 24-hour format):');
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: appointmentDate,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                serviceType: 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`âœ… Appointment booked\nDate: ${new Date(appointmentDate).toLocaleDateString('en-GB')}\nTime: ${time}\nClient: ${clientName}`);
            
            if (document.getElementById('appointmentCalendar').style.display !== 'none') {
                renderCalendar(window.currentCalendarDate || new Date());
            }
            viewTodayAppointments();
        }

        function quickBookAppointment(dateStr) {
            const time = prompt(`Book appointment for ${new Date(dateStr).toLocaleDateString('en-GB')}\n\nEnter time (HH:MM in 24-hour format):`);
            if (!time) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const notes = prompt('Notes (optional):') || '';
            
            appointments.push({
                id: 'APT' + Date.now(),
                date: dateStr,
                time: time,
                clientName: clientName,
                consultant: currentUser.fullName,
                notes: notes,
                serviceType: 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            });
            
            alert(`âœ… Appointment booked\nTime: ${time}\nClient: ${clientName}`);
            renderCalendar(window.currentCalendarDate || new Date());
            selectCalendarDate(dateStr);
        }

        function cancelAppointment(aptId) {
            if (!confirm('Cancel this appointment?')) return;
            
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments.splice(index, 1);
                alert('âœ… Appointment cancelled');
                renderCalendar(window.currentCalendarDate || new Date());
                viewTodayAppointments();
            }
        }

        function viewTodayAppointments() {
            const listDiv = document.getElementById('appointmentsList');
            if (!listDiv) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = appointments.filter(apt => 
                apt.date === today && apt.consultant === currentUser.fullName
            ).sort((a, b) => a.time.localeCompare(b.time));
            
            if (todayAppointments.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;"><p>No appointments scheduled for today</p></div>';
                return;
            }
            
            listDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">Today's Appointments (${todayAppointments.length})</h4>
                    ${todayAppointments.map(apt => `
                        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="font-size: 1.1rem;">â° ${apt.time}</strong> - <strong>${apt.clientName}</strong>
                                    <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 4px;">Service: ${apt.serviceType || 'Full Body Check-Up'} | Status: <span style="background:${apt.status==='scheduled'?'#e3f2fd':apt.status==='checked_in'?'#fff3e0':apt.status==='in_progress'?'#e8f5e9':'#ecf0f1'}; padding:2px 6px; border-radius:4px;">${apt.status || 'scheduled'}</span></div>
                                    ${apt.notes ? `<p style="font-size: 0.85rem; color: #666; margin-top: 5px;">ðŸ“ ${apt.notes}</p>` : ''}
                                </div>
                                <div>
                                    ${apt.status === 'scheduled' ? `<button class=\"btn btn-sm\" onclick=\"checkInAppointment('${apt.id}')\" style=\"margin-right: 5px; background:#3498db;color:white;\">ðŸ§¾ Check-in</button>` : ''}
                                    ${apt.status === 'checked_in' ? `<button class=\"btn btn-sm\" onclick=\"startFullBodyCheckup('${apt.id}')\" style=\"margin-right: 5px; background:#f39c12;color:white;\">â–¶ Start</button>` : ''}
                                    <button class=\"btn btn-sm btn-success\" onclick=\"markAppointmentComplete('${apt.id}')\" style=\"margin-right: 5px;\">âœ… Complete</button>
                                    ${apt.status === 'completed' ? `<button class=\"btn btn-sm\" onclick=\"createFollowUpAppointment('${apt.id}')\" style=\"margin-right: 5px; background:#27ae60;color:white;\">âž• Follow-up</button>` : ''}
                                    <button class=\"btn btn-sm btn-danger\" onclick=\"cancelAppointment('${apt.id}')\">âŒ Cancel</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function markAppointmentComplete(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'completed';
                appointments[index].completedAt = new Date().toISOString();
                // If a visit exists, close it
                try {
                    if (appointments[index].visitId) {
                        const vIdx = (visits || []).findIndex(v => v.id === appointments[index].visitId);
                        if (vIdx !== -1) {
                            visits[vIdx].status = 'completed';
                            visits[vIdx].completedAt = new Date().toISOString();
                        }
                        localStorage.setItem('dyna_visits', JSON.stringify(visits));
                    }
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_completed', appointments[index]); } catch(e){}
                alert('âœ… Appointment marked as complete');
                viewTodayAppointments();
                // Optional quick follow-up prompt
                if (confirm('Create a follow-up appointment?')) {
                    createFollowUpAppointment(appointments[index].id);
                }
            }
        }

        function checkInAppointment(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'checked_in';
                appointments[index].checkInAt = new Date().toISOString();
                appointments[index].serviceType = appointments[index].serviceType || 'Full Body Check-Up';
                // Create Visit record
                const visit = {
                    id: 'VIS' + Date.now(),
                    appointmentId: appointments[index].id,
                    clientName: appointments[index].clientName,
                    consultant: appointments[index].consultant || (currentUser && currentUser.fullName) || 'Unknown',
                    serviceType: appointments[index].serviceType,
                    branch: appointments[index].branch || (currentUser && currentUser.branch) || 'unknown',
                    status: 'checked_in',
                    createdAt: new Date().toISOString(),
                    checkInAt: appointments[index].checkInAt
                };
                try {
                    visits.push(visit);
                    appointments[index].visitId = visit.id;
                    localStorage.setItem('dyna_visits', JSON.stringify(visits));
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_checkin', appointments[index]); } catch(e){}
                viewTodayAppointments();
            }
        }

        function startFullBodyCheckup(aptId) {
            const index = appointments.findIndex(apt => apt.id === aptId);
            if (index !== -1) {
                appointments[index].status = 'in_progress';
                appointments[index].startedAt = new Date().toISOString();
                appointments[index].serviceType = appointments[index].serviceType || 'Full Body Check-Up';
                // Update related visit
                try {
                    if (appointments[index].visitId) {
                        const vIdx = (visits || []).findIndex(v => v.id === appointments[index].visitId);
                        if (vIdx !== -1) {
                            visits[vIdx].status = 'in_progress';
                            visits[vIdx].startedAt = appointments[index].startedAt;
                        }
                        localStorage.setItem('dyna_visits', JSON.stringify(visits));
                    }
                } catch(e) {}
                try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
                try { recordDepartmentEvent('appointment_started', appointments[index]); } catch(e){}
                viewTodayAppointments();
            }
        }

        function createFollowUpAppointment(sourceAptId) {
            const source = appointments.find(a => a.id === sourceAptId);
            const date = prompt('Enter follow-up date (YYYY-MM-DD):', new Date(Date.now()+7*24*60*60*1000).toISOString().split('T')[0]);
            if (!date) return;
            const time = prompt('Enter follow-up time (HH:MM in 24-hour format):', '09:00');
            if (!time) return;
            const followUp = {
                id: 'APT' + Date.now(),
                date: date,
                time: time,
                clientName: source ? source.clientName : 'Client',
                consultant: (source && source.consultant) || (currentUser && currentUser.fullName) || 'Consultant',
                notes: 'Follow-up appointment',
                serviceType: (source && source.serviceType) || 'Full Body Check-Up',
                status: 'scheduled',
                createdAt: new Date().toISOString(),
                followUpOf: sourceAptId
            };
            appointments.push(followUp);
            try { localStorage.setItem('dyna_appointments', JSON.stringify(appointments)); } catch (e) {}
            try { recordDepartmentEvent('appointment_followup_created', followUp); } catch(e){}
            alert('âœ… Follow-up appointment scheduled');
            viewTodayAppointments();
        }

        function printAnalytics() {
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'month';
            const analyticsData = calculateConsultantAnalytics(timeframe);
            
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Performance Analytics - ${currentUser.fullName}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Consultant Performance Analytics - ${timeframeText}</p>
                        <p>Consultant: ${currentUser.fullName}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('analyticsDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function displayMyReports() {
            try {
                await loadData();
                
                const list = document.getElementById('myReportsList');
                if (!list) return;
                
                // Safety check for currentUser
                if (!currentUser || !currentUser.fullName) {
                    console.warn('âš ï¸ currentUser not set, cannot display reports');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view your reports.</p>';
                    return;
                }
                
                // Capture to prevent race conditions
                const userFullName = currentUser.fullName;
                if (!userFullName) {
                    console.warn('âš ï¸ currentUser.fullName is empty');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view your reports.</p>';
                    return;
                }
                
                console.log('ðŸ” Displaying reports for:', userFullName);
                console.log('ðŸ“Š Total reports available:', reports.length);
                console.log('ðŸ‘¥ Consultants in reports:', [...new Set(reports.map(r => r && r.consultant).filter(Boolean))]);
                
                // Get all reports created by this consultant
                const myReports = reports.filter(r => r && r.id && r.consultant === userFullName);
                
                console.log('âœ… Reports found for', userFullName + ':', myReports.length);
                
                if (myReports.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ“‹ No reports created yet</h3><p>Reports you create will appear here for review and editing.</p></div>';
                    return;
                }
                
                // Sort by timestamp - latest first
                myReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                list.innerHTML = '';
                console.log('ðŸ“‹ Displaying', myReports.length, 'reports');
                console.log('ðŸ‘¥ Available clients:', clients.length);
                
                myReports.forEach(report => {
                    const client = clients.find(c => c.referenceNumber === report.clientId);
                    if (!client) {
                        console.warn('âš ï¸ No client found for report:', report.id, 'clientId:', report.clientId);
                        return;
                    }
                    
                    const dispensedCount = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;
                    const totalMedicines = report.medicines ? report.medicines.length : 0;
                    const isFullyDispensed = dispensedCount === totalMedicines && totalMedicines > 0;
                    
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.style.borderLeft = isFullyDispensed ? '5px solid #27ae60' : '5px solid #f39c12';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: #c41e3a; margin-bottom: 5px;">${client.fullName}</h4>
                                <p style="color: #7f8c8d; font-size: 0.9rem;">Report ID: ${report.id}</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${isFullyDispensed ? '#e8f5e9' : '#fff3cd'}; color: ${isFullyDispensed ? '#27ae60' : '#f39c12'}; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">
                                    ${isFullyDispensed ? 'âœ… Fully Dispensed' : `â³ ${dispensedCount}/${totalMedicines} Dispensed`}
                                </span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <p><strong>ðŸ“… Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                            <p><strong>ðŸ“ž Client Phone:</strong> ${client.phone}</p>
                            <p><strong>ðŸ’Š Medicines:</strong> ${totalMedicines} items</p>
                            ${report.followUpDate ? `<p><strong>ðŸ“… Follow-up:</strong> ${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
                        </div>
                        ${report.notes ? `
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #f39c12;">
                            <p style="font-size: 0.9rem;"><strong>ðŸ“ Notes:</strong> ${report.notes.substring(0, 100)}${report.notes.length > 100 ? '...' : ''}</p>
                        </div>
                        ` : ''}
                        <div style="text-align: center;">
                            <button class="btn btn-warning" onclick="editReport('${report.id}')" ${isFullyDispensed ? 'disabled title="Cannot edit fully dispensed report"' : ''}>
                                âœï¸ Edit Report
                            </button>
                            <button class="btn btn-info" onclick="viewReportDetails('${report.id}')">ðŸ‘ï¸ View Details</button>
                            <button class="btn" onclick="printReportById('${report.id}')">ðŸ–¨ï¸ Print</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('âŒ Error in displayMyReports:', error);
                const list = document.getElementById('myReportsList');
                if (list) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #e74c3c;">Error loading reports. Please try again.</p>';
                }
            }
        }

        function searchMyReports() {
            const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
            if (!searchTerm) {
                displayMyReports();
                return;
            }
            
            const list = document.getElementById('myReportsList');
            const myReports = reports.filter(r => {
                if (!r.id || r.consultant !== currentUser.fullName) return false;
                const client = clients.find(c => c.referenceNumber === r.clientId);
                return r.id.toLowerCase().includes(searchTerm) || 
                       (client && client.fullName.toLowerCase().includes(searchTerm));
            });
            
            if (myReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ” No reports found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            // Use same display logic (will need to extract into reusable function)
            displayMyReports();
        }

        function showAllMyReports() {
            document.getElementById('reportSearch').value = '';
            displayMyReports();
        }

        async function refreshMyReports() {
            await loadData();
            await displayMyReports();
        }

        function editReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) {
                alert('Report not found');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Set current client ID for editing
            currentClientId = report.clientId;
            
            // Fill the report modal with existing data
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list and pre-select medicines from report
            loadMedicineList();
            
            // Pre-select medicines after a brief delay to ensure checkboxes are rendered
            setTimeout(() => {
                if (report.medicines) {
                    report.medicines.forEach(med => {
                        const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            if (cb.value === med.name) {
                                cb.checked = true;
                            }
                        });
                    });
                }
                updatePrescriptionDisplay();
            }, 100);
            
            // Pre-fill consultant notes
            document.getElementById('consultantNotes').value = report.notes || '';
            
            // Pre-fill follow-up date and notes
            if (report.followUpDate) {
                document.getElementById('followUpDate').value = report.followUpDate.split('T')[0];
            }
            if (report.followUpNotes) {
                document.getElementById('followUpNotes').value = report.followUpNotes;
            }
            
            // Initialize body systems
            initializeBodySystems();
            
            // Restore symptom selections from saved report
            setTimeout(() => {
                if (report.symptoms && report.symptoms.length > 0) {
                    report.symptoms.forEach(symptomData => {
                        const systemId = symptomData.system.replace(/[^a-zA-Z0-9]/g, '_');
                        const symptomCheckboxes = document.querySelectorAll('.symptom-checkbox');
                        
                        symptomCheckboxes.forEach(cb => {
                            if (cb.dataset.system === systemId && cb.dataset.symptom === symptomData.symptom) {
                                cb.checked = true;
                            }
                        });
                    });
                    // Trigger the symptom selection handler to update the display
                    handleSymptomSelection();
                }
            }, 200);
            
            // Set consultant signature
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            updateFollowUpDisplay();
            setupFollowUpListener();
            updateNotesDisplay();
            generateRecommendations(client);
            
            // Store report ID for updating instead of creating new
            window.editingReportId = reportId;
            
            // Show modal
            document.getElementById('reportModal').style.display = 'block';
        }

        function viewReportDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            let detailsHTML = `
                <h3>Report Details</h3>
                <p><strong>Report ID:</strong> ${report.id}</p>
                <p><strong>Client:</strong> ${client ? client.fullName : 'Unknown'}</p>
                <p><strong>Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                <p><strong>Consultant:</strong> ${report.consultant}</p>
                
                <h4 style="margin-top: 20px;">Prescribed Medicines:</h4>
                <ul>
                    ${report.medicines ? report.medicines.map(m => `<li>${m.name} ${m.dispensed ? 'âœ…' : 'â³'}</li>`).join('') : '<li>None</li>'}
                </ul>
                
                ${report.notes ? `<h4>Notes:</h4><p>${report.notes}</p>` : ''}
                ${report.followUpDate ? `<h4>Follow-up:</h4><p>${new Date(report.followUpDate).toLocaleDateString()}</p>` : ''}
            `;
            
            alert(detailsHTML.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n'));
        }

        function printReportById(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // Set current client ID and simulate printing
            currentClientId = report.clientId;
            
            // We need to reload the report modal to print
            // For now, use simplified print
            alert('Opening print preview...');
            editReport(reportId);
            setTimeout(() => {
                printReport();
            }, 1000);
        }

        async function displayFollowUps() {
            try {
                const list = document.getElementById('followUpList');
                if (!list) return;

                // Safety check for currentUser
                if (!currentUser || !currentUser.fullName) {
                    console.warn('âš ï¸ currentUser not set, cannot display follow-ups');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view follow-ups.</p>';
                    return;
                }

                // Capture to prevent race conditions
                const userFullName = currentUser.fullName;
                if (!userFullName) {
                    console.warn('âš ï¸ currentUser.fullName is empty');
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Please log in to view follow-ups.</p>';
                    return;
                }

                // Get all reports with follow-up dates
                const reportsWithFollowUp = reports.filter(r => r && r.followUpDate && r.consultant === userFullName);
                
                if (reportsWithFollowUp.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ“… No follow-ups scheduled</h3><p>Follow-ups will appear here once you create reports with follow-up dates.</p></div>';
                    return;
                }

                // Sort by follow-up date
                reportsWithFollowUp.sort((a, b) => new Date(a.followUpDate) - new Date(b.followUpDate));

                list.innerHTML = '';
                reportsWithFollowUp.forEach(report => {
                    const client = clients.find(c => c.referenceNumber === report.clientId);
                    if (!client) return;

                    const followUpDate = new Date(report.followUpDate);
                    const today = new Date();
                    const daysUntil = Math.ceil((followUpDate - today) / (1000 * 60 * 60 * 24));
                    
                    let statusClass = '';
                    let statusText = '';
                    if (daysUntil < 0) {
                        statusClass = 'overdue';
                        statusText = `Overdue by ${Math.abs(daysUntil)} days`;
                    } else if (daysUntil === 0) {
                        statusClass = 'today';
                        statusText = 'Today';
                    } else if (daysUntil <= 7) {
                        statusClass = 'upcoming';
                        statusText = `In ${daysUntil} days`;
                    } else {
                        statusClass = 'future';
                        statusText = `In ${daysUntil} days`;
                    }

                    const card = document.createElement('div');
                    card.className = `client-card follow-up-card ${statusClass}`;
                    card.innerHTML = `
                        <div class="follow-up-header">
                            <h4>${client.fullName}</h4>
                            <span class="follow-up-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="follow-up-details">
                            <p><strong>Follow-up Date:</strong> ${followUpDate.toLocaleDateString('en-GB')}</p>
                            <p><strong>Client:</strong> ${client.fullName} (${client.referenceNumber})</p>
                            <p><strong>Phone:</strong> ${client.phone}</p>
                            <p><strong>Last Visit:</strong> ${new Date(report.timestamp).toLocaleDateString('en-GB')}</p>
                            ${report.followUpNotes ? `<p><strong>Notes:</strong> ${report.followUpNotes}</p>` : ''}
                            <p><strong>Prescription:</strong> ${report.prescription || 'No prescription'}</p>
                        </div>
                        <div class="follow-up-actions">
                            <button class="btn btn-primary" onclick="viewClientDetails('${client.referenceNumber}')">View Client</button>
                            <button class="btn btn-success" onclick="createReport('${client.referenceNumber}')">Create New Report</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('âŒ Error in displayFollowUps:', error);
                const list = document.getElementById('followUpList');
                if (list) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center; color: #e74c3c;">Error loading follow-ups. Please try again.</p>';
                }
            }
        }

        function filterFollowUps() {
            const searchDate = document.getElementById('followUpSearch').value;
            if (!searchDate) {
                displayFollowUps();
                return;
            }

            const list = document.getElementById('followUpList');
            const cards = list.querySelectorAll('.follow-up-card');
            
            cards.forEach(card => {
                const dateText = card.querySelector('.follow-up-details p').textContent;
                const cardDate = new Date(dateText.split(': ')[1]).toISOString().split('T')[0];
                card.style.display = cardDate === searchDate ? 'block' : 'none';
            });
        }

        function showAllFollowUps() {
            document.getElementById('followUpSearch').value = '';
            displayFollowUps();
        }

        async function refreshFollowUps() {
            await loadData();
            await displayFollowUps();
        }

        function viewClientDetails(referenceNumber, editMode = false) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a detailed view modal with edit functionality
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.id = 'clientDetailsModal';
            
            const editForm = editMode ? createClientEditForm(client) : createClientViewForm(client);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>${editMode ? 'Edit Client Details' : 'Client Details'} - ${client.referenceNumber}</h2>
                    ${editForm}
                    <div style="text-align: center; margin-top: 20px;">
                        ${editMode ? `
                            <button class="btn btn-success" onclick="saveClientChanges('${client.referenceNumber}')">ðŸ’¾ Save Changes</button>
                            <button class="btn btn-secondary" onclick="viewClientDetails('${client.referenceNumber}', false)">âŒ Cancel</button>
                        ` : `
                            <button class="btn btn-warning" onclick="viewClientDetails('${client.referenceNumber}', true)">âœï¸ Edit Details</button>
                            <button class="btn btn-primary" onclick="printClientDetails('${client.referenceNumber}')">ðŸ–¨ï¸ Print Details</button>
                            <button class="btn" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function createClientViewForm(client) {
            return `
                <div class="client-details-print">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'} years</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Height:</strong> ${client.height || 'Not provided'} cm</div>
                            <div><strong>Weight:</strong> ${client.weight || 'Not provided'} kg</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || 'None')}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branches.find(b => b.id === client.branch)?.name || client.branch}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createClientEditForm(client) {
            return `
                <form id="clientEditForm" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Full Name</label>
                                <input type="text" name="fullName" value="${client.fullName}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Namibian ID Number</label>
                                <input type="text" name="nbNumber" value="${client.nbNumber}" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Date of Birth</label>
                                <input type="date" name="dob" value="${client.dob || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" name="age" value="${client.age || ''}" min="1" max="120" readonly>
                            </div>
                            <div class="form-group">
                                <label class="required">Gender</label>
                                <select name="gender" required>
                                    <option value="Male" ${client.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${client.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${client.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Phone</label>
                                <input type="tel" name="phone" value="${client.phone}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" name="email" value="${client.email || ''}">
                            </div>
                            <div class="form-group">
                                <label class="required">Height (cm)</label>
                                <input type="number" name="height" value="${client.height || ''}" min="0" max="300" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Weight (kg)</label>
                                <input type="number" name="weight" value="${client.weight || ''}" min="0" max="500" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-group">
                            <label>Membership Status</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="member" ${client.membershipStatus === 'member' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Registered Member</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="membershipStatus" value="referred" ${client.membershipStatus === 'referred' ? 'checked' : ''} onchange="toggleEditMembershipStatus()" style="margin-right: 8px;">
                                    <span>Referred by Member</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="memberEditDetails" style="display: ${client.membershipStatus === 'member' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Member ID</label>
                                    <input type="text" name="memberId" value="${client.memberId || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Member Since</label>
                                    <input type="date" name="memberSince" value="${client.memberSince || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div id="referralEditDetails" style="display: ${client.membershipStatus === 'referred' ? 'block' : 'none'}; margin-top: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required">Referral Name *</label>
                                    <input type="text" name="referralName" value="${client.referralName || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">Referral NB Number *</label>
                                    <input type="text" name="referralNbNumber" value="${client.referralNbNumber || ''}" required pattern="NB[0-9]+" title="NB number must start with 'NB' followed by any number of digits (can start with 0)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Primary Reason for Visit</label>
                                <input type="text" name="primaryReason" value="${client.primaryReason}" required>
                            </div>
                            <div class="form-group">
                                <label>Current Medications</label>
                                <textarea name="currentMedications" rows="3">${client.currentMedications || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Allergies</label>
                                <textarea name="allergies" rows="3">${client.allergies || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Medical History</label>
                                <textarea name="medicalHistory" rows="3">${Array.isArray(client.medicalHistory) ? client.medicalHistory.join(', ') : (client.medicalHistory || '')}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Water Intake</label>
                                <select name="waterIntake">
                                    <option value="">Select...</option>
                                    <option value="Less than 1 liter" ${client.waterIntake === 'Less than 1 liter' ? 'selected' : ''}>Less than 1 liter</option>
                                    <option value="1-2 liters" ${client.waterIntake === '1-2 liters' ? 'selected' : ''}>1-2 liters</option>
                                    <option value="2-3 liters" ${client.waterIntake === '2-3 liters' ? 'selected' : ''}>2-3 liters</option>
                                    <option value="More than 3 liters" ${client.waterIntake === 'More than 3 liters' ? 'selected' : ''}>More than 3 liters</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Exercise Frequency</label>
                                <select name="exerciseFreq">
                                    <option value="">Select...</option>
                                    <option value="Never" ${client.exerciseFreq === 'Never' ? 'selected' : ''}>Never</option>
                                    <option value="1-2 times per week" ${client.exerciseFreq === '1-2 times per week' ? 'selected' : ''}>1-2 times per week</option>
                                    <option value="3-4 times per week" ${client.exerciseFreq === '3-4 times per week' ? 'selected' : ''}>3-4 times per week</option>
                                    <option value="Daily" ${client.exerciseFreq === 'Daily' ? 'selected' : ''}>Daily</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sleep Hours</label>
                                <select name="sleepHours">
                                    <option value="">Select...</option>
                                    <option value="Less than 5 hours" ${client.sleepHours === 'Less than 5 hours' ? 'selected' : ''}>Less than 5 hours</option>
                                    <option value="5-6 hours" ${client.sleepHours === '5-6 hours' ? 'selected' : ''}>5-6 hours</option>
                                    <option value="6-7 hours" ${client.sleepHours === '6-7 hours' ? 'selected' : ''}>6-7 hours</option>
                                    <option value="7-8 hours" ${client.sleepHours === '7-8 hours' ? 'selected' : ''}>7-8 hours</option>
                                    <option value="More than 8 hours" ${client.sleepHours === 'More than 8 hours' ? 'selected' : ''}>More than 8 hours</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stress Level</label>
                                <select name="stressLevel">
                                    <option value="">Select...</option>
                                    <option value="Low" ${client.stressLevel === 'Low' ? 'selected' : ''}>Low</option>
                                    <option value="Moderate" ${client.stressLevel === 'Moderate' ? 'selected' : ''}>Moderate</option>
                                    <option value="High" ${client.stressLevel === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Very High" ${client.stressLevel === 'Very High' ? 'selected' : ''}>Very High</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Symptoms</h3>
                        <div class="form-group">
                            <label>Select Symptoms (Hold Ctrl/Cmd to select multiple)</label>
                            <select name="symptoms" multiple size="6" style="width: 100%;">
                                <option value="Fatigue" ${client.symptoms && client.symptoms.includes('Fatigue') ? 'selected' : ''}>Fatigue</option>
                                <option value="Headaches" ${client.symptoms && client.symptoms.includes('Headaches') ? 'selected' : ''}>Headaches</option>
                                <option value="Digestive Issues" ${client.symptoms && client.symptoms.includes('Digestive Issues') ? 'selected' : ''}>Digestive Issues</option>
                                <option value="Sleep Problems" ${client.symptoms && client.symptoms.includes('Sleep Problems') ? 'selected' : ''}>Sleep Problems</option>
                                <option value="Joint Pain" ${client.symptoms && client.symptoms.includes('Joint Pain') ? 'selected' : ''}>Joint Pain</option>
                                <option value="Skin Issues" ${client.symptoms && client.symptoms.includes('Skin Issues') ? 'selected' : ''}>Skin Issues</option>
                                <option value="Weight Issues" ${client.symptoms && client.symptoms.includes('Weight Issues') ? 'selected' : ''}>Weight Issues</option>
                                <option value="Mood Changes" ${client.symptoms && client.symptoms.includes('Mood Changes') ? 'selected' : ''}>Mood Changes</option>
                                <option value="None" ${client.symptoms && client.symptoms.includes('None') ? 'selected' : ''}>None</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
        }

        function toggleEditMembershipStatus() {
            const memberRadio = document.querySelector('input[name="membershipStatus"][value="member"]');
            const referredRadio = document.querySelector('input[name="membershipStatus"][value="referred"]');
            const memberDetails = document.getElementById('memberEditDetails');
            const referralDetails = document.getElementById('referralEditDetails');
            const referralNameInput = document.querySelector('input[name="referralName"]');
            const referralNbInput = document.querySelector('input[name="referralNbNumber"]');
            
            if (memberRadio && referredRadio && memberDetails && referralDetails) {
                if (memberRadio.checked) {
                    memberDetails.style.display = 'block';
                    referralDetails.style.display = 'none';
                    if (referralNameInput) referralNameInput.required = false;
                    if (referralNbInput) referralNbInput.required = false;
                } else if (referredRadio.checked) {
                    memberDetails.style.display = 'none';
                    referralDetails.style.display = 'block';
                    if (referralNameInput) referralNameInput.required = true;
                    if (referralNbInput) referralNbInput.required = true;
                }
            }
        }

        async function saveClientChanges(referenceNumber) {
            const form = document.getElementById('clientEditForm');
            if (!form) return;

            const formData = new FormData(form);
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Update client data
            const updatedClient = {
                ...client,
                fullName: formData.get('fullName').trim(),
                nbNumber: formData.get('nbNumber').trim(),
                email: formData.get('email'),
                phone: formData.get('phone'),
                age: formData.get('age'),
                gender: formData.get('gender'),
                membershipStatus: formData.get('membershipStatus'),
                memberId: formData.get('memberId'),
                memberSince: formData.get('memberSince'),
                referralName: formData.get('referralName'),
                referralNbNumber: formData.get('referralNbNumber'),
                primaryReason: formData.get('primaryReason'),
                currentMedications: formData.get('currentMedications'),
                allergies: formData.get('allergies'),
                medicalHistory: formData.get('medicalHistory'),
                waterIntake: formData.get('waterIntake'),
                exerciseFreq: formData.get('exerciseFreq'),
                sleepHours: formData.get('sleepHours'),
                stressLevel: formData.get('stressLevel'),
                symptoms: Array.from(formData.getAll('symptoms')),
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser ? currentUser.fullName : 'Unknown'
            };

            try {
                const result = await apiRequest('/clients', 'PUT', updatedClient);
                if (result.success) {
                    // Update local data
                    const index = clients.findIndex(c => c.referenceNumber === referenceNumber);
                    if (index !== -1) {
                        clients[index] = updatedClient;
                    }
                    
                    // Refresh the display
                    if (currentPortal === 'consultant') {
                        await displayClients();
                    }
                    
                    // Close modal and show success
                    document.getElementById('clientDetailsModal').remove();
                    alert('âœ… Client details updated successfully!');
                } else {
                    alert('Error updating client: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating client:', error);
                alert('Error updating client. Please try again.');
            }
        }

        function printClientDetails(referenceNumber) {
            const client = clients.find(c => c.referenceNumber === referenceNumber);
            if (!client) return;

            // Create a print-friendly window
            const printWindow = window.open('', '_blank');
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Client Details - ${client.referenceNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.3;
                            max-width: 21cm;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #c41e3a;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                            background: linear-gradient(135deg, rgba(196,30,58,0.05) 0%, rgba(139,0,0,0.05) 100%);
                            border-radius: 8px;
                            padding: 15px;
                        }
                        .header h1 {
                            font-size: 22px;
                            color: #c41e3a;
                            margin-bottom: 5px;
                            font-weight: 900;
                        }
                        .header h2 {
                            font-size: 14px;
                            color: #333;
                            margin: 5px 0;
                        }
                        .section {
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .section h3 {
                            font-size: 12px;
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid #c41e3a;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        .form-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                        }
                        .symptoms-display {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 5px;
                            margin-top: 5px;
                        }
                        .symptom-tag {
                            background: #e3f2fd;
                            color: #1976d2;
                            padding: 3px 8px;
                            border-radius: 10px;
                            font-size: 9px;
                            font-weight: 500;
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        ${generateLogoSVG(200, 120)}
                    </div>
                    
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Client Registration Details</h2>
                        <p>Branch: ${branchName} | Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Personal Information</h3>
                        <div class="form-grid">
                            <div><strong>Reference Number:</strong> ${client.referenceNumber}</div>
                            <div><strong>Full Name:</strong> ${client.fullName}</div>
                            <div><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            <div><strong>Email:</strong> ${client.email || 'Not provided'}</div>
                            <div><strong>Phone:</strong> ${client.phone}</div>
                            <div><strong>Age:</strong> ${client.age || 'Not provided'}</div>
                            <div><strong>Gender:</strong> ${client.gender}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Member/Referral Information</h3>
                        <div class="form-grid">
                            <div><strong>Membership Status:</strong> ${client.membershipStatus === 'member' ? 'Registered Member' : 'Referred by Member'}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div><strong>Member ID:</strong> ${client.memberId || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${client.memberSince || 'Not provided'}</div>
                            ` : `
                                <div><strong>Referred by:</strong> ${client.referralName}</div>
                                <div><strong>Referral NB:</strong> ${client.referralNbNumber || 'Not provided'}</div>
                            `}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Health Information</h3>
                        <div class="form-grid">
                            <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                            <div><strong>Current Medications:</strong> ${client.currentMedications || 'None'}</div>
                            <div><strong>Allergies:</strong> ${client.allergies || 'None'}</div>
                            <div><strong>Medical History:</strong> ${client.medicalHistory || 'None'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Lifestyle Information</h3>
                        <div class="form-grid">
                            <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                            <div><strong>Exercise Frequency:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                            <div><strong>Sleep Hours:</strong> ${client.sleepHours || 'Not specified'}</div>
                            <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Symptoms</h3>
                        <div class="symptoms-display">
                            ${client.symptoms && client.symptoms.length > 0 ? 
                                client.symptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') : 
                                '<span>No symptoms reported</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Registration Details</h3>
                        <div class="form-grid">
                            <div><strong>Registration Date:</strong> ${new Date(client.timestamp).toLocaleDateString('en-GB')}</div>
                            <div><strong>Branch:</strong> ${branchName}</div>
                            <div><strong>Signature:</strong> ${client.signature || 'Not signed'}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function createReport(refNum) {
            currentClientId = refNum;
            const client = clients.find(c => c.referenceNumber === refNum);
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Clear editing flag (we're creating a new report, not editing)
            window.editingReportId = null;
            
            // Fill prescription modal
            document.getElementById('branchInfo').textContent = `Branch: ${branchName}`;
            
            document.getElementById('patientInfo').innerHTML = `
                <div><strong>Reference:</strong> ${client.referenceNumber}</div>
                <div><strong>Name:</strong> ${client.fullName}</div>
                <div><strong>Age:</strong> ${client.age || 'N/A'}</div>
                <div><strong>Gender:</strong> ${client.gender}</div>
                <div><strong>Phone:</strong> ${client.phone}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                <div><strong>Consultant:</strong> ${currentUser.fullName}</div>
                <div><strong>Height:</strong> ${client.height}cm | <strong>Weight:</strong> ${client.weight}kg</div>
            `;
            
            // Display symptoms
            const symptoms = client.symptoms ? client.symptoms.filter(s => s !== 'none') : [];
            document.getElementById('patientSymptoms').innerHTML = symptoms.length > 0 ? 
                `<div class="symptoms-display">${symptoms.map(s => `<span class="symptom-tag">${s.toUpperCase().replace(/_/g, ' ')}</span>`).join('')}</div>` : 
                '<p style="color: #7f8c8d; font-style: italic;">No specific symptoms reported</p>';
            
            // Health Assessment
            document.getElementById('healthAssessment').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><strong>Primary Reason:</strong> ${client.primaryReason}</div>
                    <div><strong>Water Intake:</strong> ${client.waterIntake || 'Not specified'}</div>
                    <div><strong>Exercise:</strong> ${client.exerciseFreq || 'Not specified'}</div>
                    <div><strong>Sleep:</strong> ${client.sleepHours || 'Not specified'}</div>
                    <div><strong>Stress Level:</strong> ${client.stressLevel || 'Not specified'}/10</div>
                    <div><strong>Medical History:</strong> ${client.medicalHistory ? client.medicalHistory.join(', ') : 'None'}</div>
                </div>
            `;
            
            // Load medicine list
            loadMedicineList();
            
            // Set consultant signature name and contact info
            document.getElementById('consultantSignatureName').textContent = currentUser.fullName;
            document.getElementById('consultantContactInfo').innerHTML = `
                <p>Tel: ${currentUser.phone || '061-300877'}</p>
                <p>Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
            `;
            
            // Set default follow-up date (2 weeks from now)
            const followUpDate = new Date();
            followUpDate.setDate(followUpDate.getDate() + 14);
            document.getElementById('followUpDate').value = followUpDate.toISOString().split('T')[0];
            
            // Update follow-up date display
            updateFollowUpDisplay();
            
            // Setup event listener for follow-up date
            setupFollowUpListener();
            
            // Update prescription display
            updatePrescriptionDisplay();
            
            // Update notes display
            updateNotesDisplay();
            
            // Generate recommendations based on symptoms and health data
            generateRecommendations(client);
            
            // Initialize body systems selector
            initializeBodySystems();
            
            document.getElementById('reportModal').style.display = 'block';
        }

        // Body Systems and Lifestyle Recommendations Database
        const BODY_SYSTEMS_DATABASE = {
            'Nervous System': {
                symptoms: {
                    'Headaches and dizziness': 'Practice stress-management techniques like meditation, prayer, or deep breathing.',
                    'Insomnia or restless sleep': 'Maintain a regular sleep routine (7â€“8 hours daily).',
                    'Poor concentration and memory loss': 'Take short breaks from screens to rest the mind and eat foods rich in B-vitamins, omega-3, and magnesium (e.g., fish, nuts, leafy greens).'
                }
            },
            'Cardiovascular System': {
                symptoms: {
                    'Palpitations or irregular heartbeat': 'Practice relaxation techniques to reduce stress-induced hypertension and engage in light aerobic exercise.',
                    'Shortness of breath': 'Engage in aerobic exercise (walking, swimming, cycling) for at least 30 minutes, 4â€“5 times weekly.',
                    'Cold hands and feet or fatigue': 'Eat a balanced diet rich in fruits, vegetables, and healthy fats (olive oil, avocados) to improve circulation.'
                }
            },
            'Digestive System': {
                symptoms: {
                    'Bloating and indigestion': 'Eat meals on time and chew slowly to aid digestion.',
                    'Constipation or diarrhea': 'Increase fiber and water intake; reduce processed foods.',
                    'Loss of appetite or heartburn': 'Avoid late-night eating and use probiotic-rich foods (yogurt, fermented vegetables) to maintain gut health.'
                }
            },
            'Respiratory System': {
                symptoms: {
                    'Frequent cough or shortness of breath': 'Practice deep breathing exercises and outdoor walks in clean air.',
                    'Chest tightness': 'Avoid smoking and dusty environments; keep indoor air fresh with plants or ventilation.',
                    'Low lung endurance': 'Strengthen lungs through light aerobic activity or yoga.'
                }
            },
            'Immune System': {
                symptoms: {
                    'Frequent colds or infections': 'Eat immune-boosting foods (citrus fruits, garlic, mushrooms) and sleep adequately.',
                    'Slow wound healing': 'Maintain personal hygiene, stay hydrated, and ensure adequate rest.',
                    'Allergic reactions or fatigue': 'Exercise moderately to stimulate immune response and avoid chronic stress.'
                }
            },
            'Endocrine System': {
                symptoms: {
                    'Weight fluctuations': 'Keep consistent sleep and meal times to stabilize hormones and engage in regular moderate exercise.',
                    'Mood swings or irritability': 'Reduce sugar, alcohol, and processed food intake to balance hormones.',
                    'Irregular menstruation or libido changes': 'Consume hormone-supportive foods like soy, flaxseed, and whole grains.'
                }
            },
            'Musculoskeletal System': {
                symptoms: {
                    'Muscle stiffness or pain': 'Stretch daily and maintain good posture throughout the day.',
                    'Joint aches': 'Engage in strength and flexibility training with adequate calcium, magnesium, and vitamin D intake.',
                    'Back or neck discomfort': 'Avoid prolonged sitting â€” stand or walk every hour and maintain proper posture.'
                }
            },
            'Urinary System': {
                symptoms: {
                    'Frequent urination or urgency': 'Limit salt and caffeine intake; avoid holding urine for long periods.',
                    'Lower back pain': 'Drink 1.5â€“2 liters of water daily to flush toxins and maintain kidney health.',
                    'Swelling in legs or feet': 'Limit salt intake, stay hydrated, and elevate legs when resting.'
                }
            },
            'Reproductive System': {
                symptoms: {
                    'Reduced sexual desire': 'Eat zinc- and vitamin E-rich foods (nuts, seeds, eggs) and manage stress through proper rest.',
                    'Irregular cycles or erectile issues': 'Exercise to improve circulation and avoid excessive alcohol, smoking, and processed fats.',
                    'Hormonal imbalances': 'Ensure proper rest, eat hormone-supportive foods, and maintain a regular exercise routine.'
                }
            },
            'Integumentary System (Skin, Hair, Nails)': {
                symptoms: {
                    'Dry or dull skin': 'Drink plenty of water and consume antioxidant-rich foods (berries, green tea).',
                    'Hair loss or brittleness': 'Get enough sleep to support skin and hair repair, and ensure adequate protein intake.',
                    'Acne or skin sensitivity': 'Keep the skin clean and moisturized; avoid excessive sun exposure and use natural skincare.'
                }
            },
            'Lymphatic System': {
                symptoms: {
                    'Swollen lymph nodes': 'Engage in light exercise and massage to improve lymph circulation.',
                    'Puffy face or limbs': 'Stay hydrated, avoid heavy oily foods, and include detoxifying foods like lemon and ginger.',
                    'Chronic fatigue': 'Maintain proper posture, avoid tight clothing that blocks flow, and get adequate rest.'
                }
            },
            'Sensory System (Eyes, Ears, Nose)': {
                symptoms: {
                    'Eye fatigue or blurred vision': 'Take screen breaks every 30â€“40 minutes and do simple eye relaxation exercises (palming, distant focusing).',
                    'Ringing in the ears (tinnitus)': 'Avoid loud noise exposure, maintain ear hygiene, and ensure adequate magnesium intake.',
                    'Sensitivity to light or sound': 'Maintain good lighting while working or reading and eat foods rich in vitamin A and lutein (carrots, spinach).'
                }
            }
        };

        function initializeBodySystems() {
            const container = document.getElementById('bodySystemsSelector');
            let html = '';
            
            Object.keys(BODY_SYSTEMS_DATABASE).forEach((systemName, index) => {
                const system = BODY_SYSTEMS_DATABASE[systemName];
                const systemId = systemName.replace(/[^a-zA-Z0-9]/g, '_');
                
                html += `
                    <div class="body-system-card" style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleSystemSymptoms('${systemId}')">
                            <input type="checkbox" id="system_${systemId}" onchange="handleSystemSelection('${systemId}')" 
                                   style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                            <h4 style="color: #2196f3; margin: 0; flex: 1; font-size: 1.1rem;">${systemName}</h4>
                            <span id="toggle_${systemId}" style="font-size: 1.2rem; color: #2196f3;">â–¼</span>
                        </div>
                        
                        <div id="symptoms_${systemId}" style="display: none; margin-top: 10px; padding-left: 30px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 8px; font-weight: 600;">Common Symptoms:</p>
                            ${Object.keys(system.symptoms).map((symptom, i) => `
                                <label style="display: block; padding: 5px 0; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" class="symptom-checkbox" data-system="${systemId}" data-symptom="${symptom.replace(/"/g, '&quot;')}"
                                           onchange="handleSymptomSelection()" style="margin-right: 8px;">
                                    ${symptom}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleSystemSymptoms(systemId) {
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const toggleIcon = document.getElementById(`toggle_${systemId}`);
            
            if (symptomsDiv.style.display === 'none') {
                symptomsDiv.style.display = 'block';
                toggleIcon.textContent = 'â–²';
            } else {
                symptomsDiv.style.display = 'none';
                toggleIcon.textContent = 'â–¼';
            }
        }

        function handleSystemSelection(systemId) {
            const checkbox = document.getElementById(`system_${systemId}`);
            const symptomsDiv = document.getElementById(`symptoms_${systemId}`);
            const symptomCheckboxes = symptomsDiv.querySelectorAll('.symptom-checkbox');
            
            if (checkbox.checked) {
                // Expand symptoms
                symptomsDiv.style.display = 'block';
                document.getElementById(`toggle_${systemId}`).textContent = 'â–²';
            } else {
                // Uncheck all symptoms
                symptomCheckboxes.forEach(cb => cb.checked = false);
            }
            
            handleSymptomSelection();
        }

        function handleSymptomSelection() {
            const selectedSymptoms = [];
            const recommendationsDiv = document.getElementById('lifestyleRecommendations');
            
            // Find all checked symptoms with their data
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const systemId = checkbox.dataset.system;
                const symptomName = checkbox.dataset.symptom;
                
                // Find the original system name
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName) {
                    const system = BODY_SYSTEMS_DATABASE[systemName];
                    const recommendation = system.symptoms[symptomName];
                    
                    if (recommendation) {
                        selectedSymptoms.push({
                            system: systemName,
                            symptom: symptomName,
                            recommendation: recommendation
                        });
                    }
                }
            });
            
            if (selectedSymptoms.length === 0) {
                recommendationsDiv.style.display = 'none';
                return;
            }
            
            // Display recommendations - one per symptom
            let html = '<h4 style="color: #2196f3; margin-bottom: 20px; font-size: 1.2rem;">ðŸ“‹ Healthy Lifestyle Recommendations</h4>';
            html += '<div style="display: grid; gap: 12px;">';
            
            selectedSymptoms.forEach((item, index) => {
                html += `
                    <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 1.2rem; color: #2196f3;">âœ“</span>
                            <div style="flex: 1;">
                                <strong style="color: #1976d2; font-size: 0.95rem;">${item.symptom}</strong>
                                <span style="color: #666; font-size: 0.85rem; margin-left: 8px;">(${item.system})</span>
                                <p style="margin: 5px 0 0 0; color: #555; line-height: 1.5; font-size: 0.9rem;">${item.recommendation}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            recommendationsDiv.innerHTML = html;
            recommendationsDiv.style.display = 'block';
        }

        // Symptom-to-Medicine Recommendation Database
        const RECOMMENDATION_DATABASE = {
            // Symptoms mapping
            symptoms: {
                fatigue: ['Spirulina Tabs', 'Dyna Tonic 780ml', 'Bee Pollen Capsule 100\'s', 'Ginseng Capsule', 'Yeeginako Tabs'],
                headache: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Nutmeg Ointment'],
                nausea: ['Ginger capsule', 'Soybean & Ginger', 'Noni 1 Ltr', 'Spirulina Tabs'],
                dizziness: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                shortness_breath: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Ginkgo & Ginseng - C'],
                blurred_vision: ['Ginkgo & Ginseng - C', 'Dyna C- 150\'s', 'Spirulina Tabs'],
                joint_pain: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Dyna \'S\' Tablet 120\'s', 'Sea Cucumber 500ml'],
                cough: ['Dyna Tonic 780ml', 'Noni 1 Ltr', 'Spirulina Tabs'],
                digestive_issues: ['Spirulina Tabs', 'Pro LSB', 'Gastritus Package', 'High Fiber'],
                loss_appetite: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml'],
                fever: ['Dyna C- 150\'s', 'Spirulina Tabs', 'Noni 1 Ltr'],
                sore_throat: ['Ganoderma Toothpaste', 'Noni 1 Ltr', 'Dyna C- 150\'s'],
                skin_rash: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s'],
                chest_pain: ['Ginkgo & Ginseng - C', 'Blood Circulation Package', 'Noni 1 Ltr'],
                lower_back: ['Nutmeg Ointment', 'Healthy Joints Pack', 'Sea Cucumber 500ml'],
                weight_changes: ['Diet & Weight Management Pack', 'Spirulina Tabs', 'High Fiber'],
                insomnia: ['Gano & Green Tea - C', 'Spirulina Tabs', 'Maharani'],
                confusion: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Bee Pollen Capsule 100\'s'],
                foot_edema: ['Blood Circulation Package', 'Spirulina Tabs'],
                swelling: ['Blood Circulation Package', 'Spirulina Tabs', 'Sea Cucumber 500ml']
            },
            // Medical history mapping
            medicalHistory: {
                highBloodPressure: ['Blood Circulation Package', 'Spirulina Tabs', 'Ginkgo & Ginseng - C', 'Noni 1 Ltr'],
                diabetes: ['Spirulina Tabs', 'Noni 1 Ltr', 'Bitter Gourd Tea', 'Balanced Body System Package'],
                heartDisease: ['Blood Circulation Package', 'Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Noni 1 Ltr'],
                asthma: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Noni 1 Ltr'],
                digestiveDisorders: ['Gastritus Package', 'Spirulina Tabs', 'Pro LSB', 'High Fiber'],
                thyroid: ['Spirulina Tabs', 'Balanced Body System Package', 'Sea Cucumber 500ml'],
                kidneyLiver: ['Cleansing & Detoxification Package', 'Spirulina Tabs', 'Milk Thistle Tablet 120\'s'],
                chronicFatigue: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Dyna Tonic 780ml', 'Ginseng Capsule'],
                arthritis: ['Healthy Joints Pack', 'Nutmeg Ointment', 'Sea Cucumber 500ml', 'Spirulina Tabs'],
                skinConditions: ['E. Vita Cream 50g', 'Spirulina Tabs', 'Dyna C- 150\'s', 'Cleansing & Detoxification Package'],
                mentalHealth: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                autoimmune: ['Spirulina Tabs', 'Balanced Body System Package', 'Noni 1 Ltr'],
                cancer: ['Spirulina Tabs', 'Noni 1 Ltr', 'Total Health Pack']
            },
            // Gender-specific
            gender: {
                female: ['Women\'s Package', 'Kacip Fatimah', 'Collagen & Kacip- C', 'Maharani'],
                male: ['Men\'s Package', 'Tongkat Ali & Maca - C', 'Dyna Serenoa Tablet 100\'s']
            },
            // Lifestyle factors
            lifestyle: {
                poorSleep: ['Gano & Green Tea - C', 'Maharani', 'Spirulina Tabs'],
                highStress: ['Ginkgo & Ginseng - C', 'Spirulina Tabs', 'Gano & Green Tea - C'],
                lowExercise: ['Spirulina Tabs', 'Bee Pollen Capsule 100\'s', 'Total Health Pack'],
                poorWater: ['High Fiber', 'Spirulina Tabs']
            },
            // Age-based
            age: {
                elderly: ['Elderly Package (Female)', 'Elderly Package (Male)', 'Spirulina Tabs', 'Ginkgo & Ginseng - C']
            },
            // General wellness
            general: ['Spirulina Tabs', 'Dyna C- 150\'s', 'Bee Pollen Capsule 100\'s']
        };

        function generateRecommendations(client) {
            const recommendations = new Set();
            const reasonsMap = new Map();
            
            // Helper function to add recommendation with reason
            const addRecommendation = (medicine, reason) => {
                recommendations.add(medicine);
                if (!reasonsMap.has(medicine)) {
                    reasonsMap.set(medicine, []);
                }
                reasonsMap.get(medicine).push(reason);
            };
            
            // Check symptoms
            if (client.symptoms && client.symptoms.length > 0) {
                client.symptoms.forEach(symptom => {
                    if (symptom !== 'none' && RECOMMENDATION_DATABASE.symptoms[symptom]) {
                        RECOMMENDATION_DATABASE.symptoms[symptom].forEach(med => {
                            addRecommendation(med, `Symptom: ${symptom.replace(/_/g, ' ')}`);
                        });
                    }
                });
            }
            
            // Check medical history
            if (client.medicalHistory && Array.isArray(client.medicalHistory)) {
                client.medicalHistory.forEach(condition => {
                    if (condition !== 'na' && RECOMMENDATION_DATABASE.medicalHistory[condition]) {
                        RECOMMENDATION_DATABASE.medicalHistory[condition].forEach(med => {
                            addRecommendation(med, `Medical History: ${condition.replace(/([A-Z])/g, ' $1').trim()}`);
                        });
                    }
                });
            }
            
            // Check gender-specific
            const gender = client.gender ? client.gender.toLowerCase() : '';
            if (gender && RECOMMENDATION_DATABASE.gender[gender]) {
                RECOMMENDATION_DATABASE.gender[gender].forEach(med => {
                    addRecommendation(med, `Gender-specific (${gender})`);
                });
            }
            
            // Check lifestyle factors
            if (client.sleepHours === '<5' || client.sleepHours === '5-6') {
                RECOMMENDATION_DATABASE.lifestyle.poorSleep.forEach(med => {
                    addRecommendation(med, 'Poor sleep quality');
                });
            }
            
            if (parseInt(client.stressLevel) >= 7) {
                RECOMMENDATION_DATABASE.lifestyle.highStress.forEach(med => {
                    addRecommendation(med, 'High stress level');
                });
            }
            
            if (client.exerciseFreq === 'never' || client.exerciseFreq === '1-2') {
                RECOMMENDATION_DATABASE.lifestyle.lowExercise.forEach(med => {
                    addRecommendation(med, 'Low physical activity');
                });
            }
            
            if (client.waterIntake === 'less1') {
                RECOMMENDATION_DATABASE.lifestyle.poorWater.forEach(med => {
                    addRecommendation(med, 'Low water intake');
                });
            }
            
            // Check age (elderly 60+)
            if (client.age && parseInt(client.age) >= 60) {
                const elderlyPackage = gender === 'female' ? 'Elderly Package (Female)' : 'Elderly Package (Male)';
                addRecommendation(elderlyPackage, 'Age 60+');
                RECOMMENDATION_DATABASE.age.elderly.forEach(med => {
                    if (med !== elderlyPackage) {
                        addRecommendation(med, 'Age-appropriate');
                    }
                });
            }
            
            // If no specific recommendations, add general wellness
            if (recommendations.size === 0) {
                RECOMMENDATION_DATABASE.general.forEach(med => {
                    addRecommendation(med, 'General wellness');
                });
            }
            
            // Display recommendations
            displayRecommendations(Array.from(recommendations), reasonsMap);
        }

        function displayRecommendations(recommendations, reasonsMap) {
            const display = document.getElementById('recommendationsDisplay');
            
            if (recommendations.length === 0) {
                display.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">No specific recommendations available.</p>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">ðŸ“‹ Recommended Products (${recommendations.length})</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                        Click on any product to select it, or use "Apply All" button below to select all recommendations.
                    </p>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            recommendations.forEach((medicine, index) => {
                const reasons = reasonsMap.get(medicine) || [];
                const uniqueReasons = [...new Set(reasons)];
                
                html += `
                    <div class="recommendation-item" style="background: #f0fff4; border: 2px solid #27ae60; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;" 
                         onclick="selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')"
                         onmouseover="this.style.background='#d4edda'; this.style.transform='scale(1.02)'"
                         onmouseout="this.style.background='#f0fff4'; this.style.transform='scale(1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: #27ae60; font-size: 1.05rem;">âœ“ ${medicine}</strong>
                                <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                    ${uniqueReasons.map(reason => `<span style="background: #fff; padding: 2px 8px; border-radius: 10px; margin-right: 5px; display: inline-block; margin-top: 3px; border: 1px solid #ddd;">ðŸŽ¯ ${reason}</span>`).join('')}
                                </div>
                            </div>
                            <button class="btn btn-success" style="padding: 5px 15px; font-size: 0.85rem; margin-left: 10px;" 
                                    onclick="event.stopPropagation(); selectRecommendedMedicine('${medicine.replace(/'/g, "\\'")}')">
                                Add
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            display.innerHTML = html;
            
            // Store recommendations for "Apply All" functionality
            window.currentRecommendations = recommendations;
        }

        function selectRecommendedMedicine(medicineName) {
            // Find the checkbox for this medicine in the medicine grid
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === medicineName && !cb.checked) {
                    cb.checked = true;
                }
            });
            updatePrescriptionDisplay();
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Added';
            btn.style.background = '#2ecc71';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function applyRecommendations() {
            if (!window.currentRecommendations || window.currentRecommendations.length === 0) {
                alert('No recommendations available.');
                return;
            }
            
            // Select all recommended medicines
            const checkboxes = document.querySelectorAll('#medicineGrid input[type="checkbox"]');
            let appliedCount = 0;
            
            window.currentRecommendations.forEach(medicine => {
                checkboxes.forEach(cb => {
                    if (cb.value === medicine && !cb.checked) {
                        cb.checked = true;
                        appliedCount++;
                    }
                });
            });
            
            updatePrescriptionDisplay();
            alert(`âœ… Applied ${appliedCount} recommended products to prescription!`);
        }

        // DYNAPHARM NAMIBIA SPECIAL PACKAGE 2025 - Official Package Database
        const PACKAGE_DATABASE = {
            'Gastric Package': {
                price: { dp: 2054, cp: 2432, bv: 381 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'PRO-LSB TABLET 150\'s', quantity: 1, dp: 455, cp: 573, bv: 100 },
                    { name: 'INSTANT GINSENG HONEY GINGER 500g', quantity: 1, dp: 350, cp: 455, bv: 43 },
                    { name: 'GOAT\'S MILK TABLET 150\'s', quantity: 1, dp: 286, cp: 372, bv: 48 }
                ]
            },
            'Womens Package': {
                price: { dp: 2543, cp: 2950, bv: 481 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'HERBA WARISAN MAHARANI 6 x 10g', quantity: 1, dp: 520, cp: 620, bv: 110 },
                    { name: 'INSTANT COFFEE MIX W/GANO, COLLAGEN & KACIP 15\'s', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'GAMAT FEMININE WASH (2)', quantity: 1, dp: 200, cp: 260, bv: 23 }
                ]
            },
            'Mens Health Package': {
                price: { dp: 2033, cp: 2362, bv: 388 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Blood Circulation Pack': {
                price: { dp: 3290, cp: 3854, bv: 657 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'INSTANT COFFEE W/ TONGKAT ALI 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 }
                ]
            },
            'Elderly Package (Female)': {
                price: { dp: 3801, cp: 4475, bv: 779.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'PROLINK 20\'s x20g', quantity: 1, dp: 588, cp: 688, bv: 135 }
                ]
            },
            'Elderly Package (Male)': {
                price: { dp: 3263, cp: 3883, bv: 663 },
                products: [
                    { name: 'INSTANT COFFEE MIX W/GINKGO & GINSENG 20\'s x21g', quantity: 1, dp: 260, cp: 320, bv: 38 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'DYNA SERENOA TABLET 100\'s', quantity: 1, dp: 520, cp: 620, bv: 115 },
                    { name: 'GINALI CAPSULE 100\'s', quantity: 1, dp: 403, cp: 493, bv: 80 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 }
                ]
            },
            'Total Health Pack': {
                price: { dp: 2570, cp: 2985, bv: 515 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'YEE YANG YEN TABLET 90\'s', quantity: 1, dp: 370, cp: 455, bv: 90 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 }
                ]
            },
            'Balanced Body System Pack': {
                price: { dp: 3846, cp: 4446, bv: 835 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'SPIRULINA TABLET 1,000\'s', quantity: 1, dp: 750, cp: 900, bv: 150 },
                    { name: 'GINSENG CAPSULE 9 x 10\'s', quantity: 1, dp: 546, cp: 655, bv: 115 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'PROLINK 30\'s x20g', quantity: 1, dp: 600, cp: 719, bv: 170 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 }
                ]
            },
            'Cleansing And Detoxification Package': {
                price: { dp: 2183, cp: 2596, bv: 447 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'YEEGARLIC CAPSULE 90\'s', quantity: 1, dp: 300, cp: 390, bv: 64 },
                    { name: 'YEEGANO CAPSULE 90\'s', quantity: 1, dp: 364, cp: 454, bv: 75 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 43 },
                    { name: 'MILK THISTLE TABLET 120\'s', quantity: 1, dp: 500, cp: 592, bv: 125 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 }
                ]
            },
            'Weight Management Pack': {
                price: { dp: 2283, cp: 2680, bv: 448 },
                products: [
                    { name: 'GREEN TEA EXTRACT CAPSULE 60\'s', quantity: 1, dp: 344, cp: 430, bv: 85 },
                    { name: 'NONI PLUS TEA 30\'s x 3g', quantity: 1, dp: 299, cp: 360, bv: 65 },
                    { name: 'DYNA \'S\' TABLET 120\'s', quantity: 1, dp: 290, cp: 360, bv: 65 },
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'HIGH FIBER NUTRION FOOD 30\'s x25g', quantity: 1, dp: 660, cp: 780, bv: 120 },
                    { name: 'INSTANT COFFEE MIX W/ GANO & GREEN TEA 20\'s x 21g', quantity: 1, dp: 260, cp: 320, bv: 38 }
                ]
            },
            'Healthy Joints Package': {
                price: { dp: 3538, cp: 4177, bv: 687.5 },
                products: [
                    { name: 'DI LIQUID CHLOROPHYLL PLUS GUARANA 500ml', quantity: 1, dp: 430, cp: 530, bv: 75 },
                    { name: 'DYNA RH CAPSULE 100\'s', quantity: 1, dp: 300, cp: 390, bv: 60 },
                    { name: 'NUTMEG OINTMENT 2 x 20g', quantity: 1, dp: 180, cp: 234, bv: 19.5 },
                    { name: 'NONI JUICE 1 LTR', quantity: 1, dp: 750, cp: 950, bv: 175 },
                    { name: 'SEA CUCUMBER JELLY 500ml', quantity: 1, dp: 533, cp: 633, bv: 115 },
                    { name: 'YEEGINKGO TABLET 90\'s', quantity: 1, dp: 420, cp: 500, bv: 80 },
                    { name: 'DYNA TONIC 780ml', quantity: 1, dp: 600, cp: 700, bv: 120 },
                    { name: 'D I INSTANT GOAT MILK POWDER PREMIX 20\'s x 21g', quantity: 1, dp: 325, cp: 400, bv: 43 }
                ]
            }
        };

        // Individual product prices (for when sold separately)
        // Get individual products from PRICE_LIST
        const INDIVIDUAL_PRODUCTS = PRICE_LIST.map(item => item.description);

        function loadMedicineList() {
            const packages = Object.keys(PACKAGE_DATABASE);
            const grid = document.getElementById('medicineGrid');
            
            let html = '';
            let itemIndex = 0;
            
            // First, add packages
            packages.forEach(packageName => {
                const packageInfo = PACKAGE_DATABASE[packageName];
                html += `
                    <div class="medicine-item package-item" style="background: #e8f5e9; border-left: 4px solid #27ae60; padding: 12px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${packageName}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}" style="font-weight: bold; color: #27ae60;">
                            ðŸ“¦ ${packageName}
                            <br><small style="color: #666; font-weight: normal;">
                                Package (${packageInfo.products.length} products) - DP: N$${packageInfo.price.dp} | CP: N$${packageInfo.price.cp} | BV: ${packageInfo.price.bv}
                                <br><span style="font-size: 0.75rem; color: #888;">Contains: ${packageInfo.products.map(p => `${p.name} (Qty: ${p.quantity})`).join(', ')}</span>
                            </small>
                        </label>
                </div>
                `;
                itemIndex++;
            });
            
            // Then, add individual products from PRICE_LIST
            PRICE_LIST.forEach(product => {
                html += `
                    <div class="medicine-item individual-item" style="padding: 10px;">
                        <input type="checkbox" id="med_${itemIndex}" value="${product.description}" onchange="updatePrescriptionDisplay()">
                        <label for="med_${itemIndex}">
                            ${product.description}
                            <br><small style="color: #666; font-size: 0.85rem;">
                                DP: N$${product.dp} | CP: N$${product.cp} | BV: ${product.bv}
                            </small>
                        </label>
                    </div>
                `;
                itemIndex++;
            });
            
            grid.innerHTML = html;
        }

        function handlePDF(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPDF = {
                        name: file.name,
                        data: e.target.result
                    };
                    document.getElementById('pdfStatus').textContent = `Ready: ${file.name}`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveReport() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push({ name: cb.value, dispensed: false });
            });
            
            if (selectedMeds.length === 0) {
                alert('Please select at least one medicine!');
                return;
            }
            
            const client = clients.find(c => c.referenceNumber === currentClientId);
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Check if we're editing an existing report
            const isEditing = window.editingReportId;
            const existingReport = isEditing ? reports.find(r => r.id === window.editingReportId) : null;
            
            // If editing, preserve dispensed status and payment info for existing medicines
            let finalMedicines = selectedMeds;
            if (isEditing && existingReport && existingReport.medicines) {
                finalMedicines = selectedMeds.map(newMed => {
                    const existingMed = existingReport.medicines.find(m => m.name === newMed.name);
                    if (existingMed) {
                        // Preserve dispensed and payment status
                        return {
                            name: newMed.name,
                            dispensed: existingMed.dispensed || false,
                            paid: existingMed.paid || false,
                            dispensedBy: existingMed.dispensedBy,
                            dispensedAt: existingMed.dispensedAt,
                            paidBy: existingMed.paidBy,
                            paidAt: existingMed.paidAt
                        };
                    }
                    return newMed;
                });
            }
            
            const report = {
                id: isEditing ? window.editingReportId : 'RPT' + Date.now(),
                clientId: currentClientId,
                clientInfo: {
                    fullName: client.fullName,
                    phone: client.phone,
                    email: client.email,
                    nbNumber: client.nbNumber
                },
                consultant: currentUser.fullName,
                consultantInfo: {
                    fullName: currentUser.fullName,
                    email: currentUser.email,
                    phone: currentUser.phone
                },
                notes: document.getElementById('consultantNotes').value,
                prescription: finalMedicines.map(med => med.name).join(', '),
                medicines: finalMedicines,
                symptoms: selectedSymptoms,
                followUpDate: document.getElementById('followUpDate').value,
                followUpNotes: document.getElementById('followUpNotes').value,
                pdf: uploadedPDF,
                timestamp: isEditing ? (existingReport.timestamp || new Date().toISOString()) : new Date().toISOString(),
                createdAt: isEditing ? (existingReport.createdAt || existingReport.timestamp || new Date().toISOString()) : new Date().toISOString(),
                lastModified: isEditing ? new Date().toISOString() : undefined,
                dispensed: isEditing ? existingReport.dispensed : false
            };
            
            // Validate and update pricing for the report
            const validatedReport = validateReportPricing(report);
            
            try {
                // Use PUT for editing, POST for new reports
                const method = isEditing ? 'PUT' : 'POST';
                const result = await apiRequest('/reports', method, validatedReport);
                
                if (result.success) {
                    if (isEditing) {
                        // Update existing report in local array
                        const index = reports.findIndex(r => r.id === validatedReport.id);
                        if (index !== -1) {
                            reports[index] = validatedReport;
                        }
                        alert('âœ… Report updated successfully! ID: ' + validatedReport.id);
                    } else {
                        // Add new report to local array
                        reports.push(validatedReport);
                        alert('âœ… Report created successfully! ID: ' + validatedReport.id);
                    }
                    
                    // Clear editing flag
                    window.editingReportId = null;
                    
            closeModal('reportModal');
            document.getElementById('consultantNotes').value = '';
                    document.getElementById('followUpDate').value = '';
                    document.getElementById('followUpNotes').value = '';
            uploadedPDF = null;
            document.getElementById('pdfStatus').textContent = '';
                    
                    // Clear medicine selections
                    document.querySelectorAll('#medicineGrid input:checked').forEach(cb => cb.checked = false);
                    
                    // Persist and notify other sections
                    try { 
                        localStorage.setItem('dyna_reports', JSON.stringify(reports));
                        console.log(`âœ… Report saved to localStorage: ${validatedReport.id} for client ${validatedReport.clientId}`);
                    } catch(storageError) {
                        console.error('âŒ Error saving report to localStorage:', storageError);
                    }
                    try { window.dispatchEvent(new CustomEvent('reports:updated', { detail: { id: validatedReport.id, action: isEditing ? 'updated' : 'created' } })); } catch(_) {}
                    // Global notify (best-effort)
                    try { fetch('/api/realtime_publish', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ channel: 'reports', event: { id: validatedReport.id, action: isEditing ? 'updated' : 'created', ts: Date.now() } }) }); } catch(_) {}
                    try {
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { id: validatedReport.id, action: isEditing ? 'updated' : 'created', ts: Date.now() } })
                            });
                        }
                    } catch(_) {}
                    // Refresh consultant and dispenser views
                    await refreshConsultantData();
                    try { if (typeof displayPrescriptions === 'function') await displayPrescriptions(); } catch(_) {}
                } else {
                    alert('Error saving report: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Error saving report. Please try again.');
            }
        }

        function updateFollowUpDisplay() {
            const followUpDate = document.getElementById('followUpDate').value;
            const displayElement = document.getElementById('followUpDateDisplay');
            if (followUpDate) {
                const date = new Date(followUpDate);
                displayElement.textContent = date.toLocaleDateString('en-GB');
            } else {
                displayElement.textContent = '________________';
            }
        }

        // Add event listener for follow-up date changes when modal opens
        function setupFollowUpListener() {
            const followUpDateInput = document.getElementById('followUpDate');
            if (followUpDateInput) {
                followUpDateInput.addEventListener('change', updateFollowUpDisplay);
            }
        }

        // Generate Logo SVG - Reusable function for all documents
        function generateLogoSVG(width = 200, height = 120) {
            const viewBoxWidth = 400;
            const viewBoxHeight = 220;
            const scaleX = width / viewBoxWidth;
            const scaleY = height / viewBoxHeight;
            
            return `
                <svg width="${width}" height="${height}" viewBox="0 0 ${viewBoxWidth} ${viewBoxHeight}" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: 0 auto;">
                    <!-- Red Arc with Text -->
                    <path d="M 40 40 Q 200 20 360 40" fill="none" stroke="#c41e3a" stroke-width="4" stroke-linecap="round"/>
                    <text x="200" y="40" text-anchor="middle" fill="#c41e3a" font-size="14" font-weight="bold" font-family="Arial, sans-serif">HEALTH | WEALTH | FREEDOM</text>
                    
                    <!-- Central Geometric Design - Abstract structure with depth -->
                    <g transform="translate(200, 110)">
                        <!-- Left pillar/structure -->
                        <path d="M -60 30 L -50 -20 L -40 30 L -40 40 L -60 40 Z" fill="#c41e3a" opacity="0.9"/>
                        <path d="M -50 -20 L -35 -25 L -25 30 L -40 30 Z" fill="#c41e3a" opacity="0.7"/>
                        <path d="M -35 -25 L -20 -20 L -15 30 L -25 30 Z" fill="#c41e3a" opacity="0.5"/>
                        
                        <!-- Right pillar/structure (mirrored) -->
                        <path d="M 60 30 L 50 -20 L 40 30 L 40 40 L 60 40 Z" fill="#c41e3a" opacity="0.9"/>
                        <path d="M 50 -20 L 35 -25 L 25 30 L 40 30 Z" fill="#c41e3a" opacity="0.7"/>
                        <path d="M 35 -25 L 20 -20 L 15 30 L 25 30 Z" fill="#c41e3a" opacity="0.5"/>
                        
                        <!-- Central connecting elements -->
                        <rect x="-25" y="25" width="50" height="8" fill="#c41e3a" opacity="0.8"/>
                        <rect x="-15" y="15" width="30" height="6" fill="#c41e3a" opacity="0.6"/>
                    </g>
                    
                    <!-- Company Name -->
                    <text x="200" y="170" text-anchor="middle" fill="#c41e3a" font-size="32" font-weight="bold" font-family="Georgia, serif">DYNAPHARM</text>
                    <text x="200" y="195" text-anchor="middle" fill="#c41e3a" font-size="20" font-weight="bold" font-family="Arial, sans-serif">NAMIBIA</text>
                </svg>
            `;
        }

        function printReport() {
            const client = clients.find(c => c.referenceNumber === currentClientId);
            if (!client) {
                alert('Client data not found');
                return;
            }
            
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Get selected symptoms and recommendations
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkbox:checked').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                const systemId = checkbox.dataset.system;
                const systemName = Object.keys(BODY_SYSTEMS_DATABASE).find(name => 
                    name.replace(/[^a-zA-Z0-9]/g, '_') === systemId
                );
                
                if (systemName && symptomName) {
                    const recommendation = BODY_SYSTEMS_DATABASE[systemName].symptoms[symptomName];
                    selectedSymptoms.push({
                        system: systemName,
                        symptom: symptomName,
                        recommendation: recommendation
                    });
                }
            });
            
            // Get consultant notes and follow-up
            const consultantNotes = document.getElementById('consultantNotes').value;
            const followUpDate = document.getElementById('followUpDate').value;
            const followUpNotes = document.getElementById('followUpNotes').value;
            
            // Get branch name and address
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            const branchAddress = branches.find(b => b.id === client.branch)?.address || 'Namibia';
            
            // Create professional print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Summary Analytic Report Card - ${client.fullName}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 9pt;
                            line-height: 1.3;
                            color: #333;
                            padding: 12mm 15mm;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 12px 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 12px;
                        }
                        
                        .header h1 {
                            font-size: 18pt;
                            margin-bottom: 5px;
                            font-weight: 900;
                            letter-spacing: 1px;
                        }
                        
                        .header .subtitle {
                            font-size: 12pt;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .header .branch-info {
                            font-size: 10pt;
                            margin: 2px 0;
                            opacity: 0.95;
                        }
                        
                        .header .report-date {
                            font-size: 9pt;
                            margin-top: 8px;
                            opacity: 0.9;
                        }
                        
                        .section {
                            margin-bottom: 8px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .section.allow-break {
                            page-break-inside: auto;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 6px 12px;
                            font-size: 11pt;
                            font-weight: bold;
                            border-radius: 4px;
                            margin-bottom: 6px;
                            text-align: center;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 6px 15px;
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                        }
                        
                        .info-item {
                            font-size: 9pt;
                            line-height: 1.3;
                        }
                        
                        .info-item strong {
                            color: #c41e3a;
                            display: inline-block;
                            min-width: 80px;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item {
                            background: #e3f2fd;
                            padding: 6px 10px;
                            border-radius: 4px;
                            margin-bottom: 5px;
                            border-left: 4px solid #2196f3;
                            font-size: 9pt;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .symptom-item strong {
                            color: #1976d2;
                            display: inline;
                            font-size: 9pt;
                            font-weight: bold;
                        }
                        
                        .symptom-item p {
                            color: #555;
                            line-height: 1.4;
                            display: inline;
                            margin-left: 8px;
                        }
                        
                        .recommendation-item {
                            background: white;
                            padding: 5px 8px;
                            border-radius: 3px;
                            border-left: 3px solid #4caf50;
                            margin-bottom: 6px;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .medicine-list {
                            background: #e8f5e9;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #27ae60;
                        }
                        
                        .medicine-list ul {
                            list-style: none;
                            padding: 0;
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 4px;
                        }
                        
                        .medicine-list li {
                            padding: 4px 8px;
                            background: white;
                            border-radius: 3px;
                            font-size: 9pt;
                            border-left: 3px solid #27ae60;
                            line-height: 1.3;
                            font-weight: 500;
                        }
                        
                        .notes-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #ffc107;
                            font-size: 9pt;
                            line-height: 1.4;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .footer {
                            margin-top: 12px;
                            padding-top: 10px;
                            border-top: 3px solid #c41e3a;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            page-break-inside: avoid;
                        }
                        
                        .signature-box {
                            text-align: center;
                            font-size: 9pt;
                        }
                        
                        .signature-line {
                            border-bottom: 2px solid #333;
                            margin: 25px 0 6px 0;
                        }
                        
                        .signature-box strong {
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border: 2px solid #2196f3;
                            font-size: 9pt;
                        }
                        
                        .follow-up-box strong {
                            color: #1976d2;
                            display: block;
                            margin-bottom: 5px;
                            font-size: 10pt;
                            font-weight: bold;
                        }
                        
                        .follow-up-box p {
                            margin: 3px 0;
                            line-height: 1.4;
                        }
                        
                        .summary-footer {
                            text-align: center;
                            margin-top: 15px;
                            padding: 12px;
                            background: #f0f0f0;
                            border-radius: 6px;
                            border: 2px solid #c41e3a;
                            font-size: 9pt;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        .page-limit-warning {
                            text-align: center;
                            margin-top: 10px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            font-size: 8pt;
                            color: #666;
                        }
                        
                        @media print {
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                            }
                            
                            .page-limit-warning {
                                page-break-before: avoid;
                            }
                            
                            .section.allow-break {
                                page-break-inside: auto;
                            }
                            
                            .recommendation-item {
                                page-break-inside: avoid;
                                orphans: 2;
                                widows: 2;
                            }
                            
                            h1, h2, h3, h4, .section-title {
                                page-break-after: avoid;
                                orphans: 3;
                                widows: 3;
                            }
                            
                            * {
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        ${generateLogoSVG(180, 110)}
                    </div>
                    
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <div class="subtitle">SUMMARY ANALYTIC REPORT CARD</div>
                        <div class="branch-info">${branchName}</div>
                        <div class="branch-info">${branchAddress}</div>
                        <div class="report-date">Report Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="section">
                        <div class="section-title">ðŸ“‹ CLIENT INFORMATION</div>
                        <div class="info-grid">
                            <div class="info-item"><strong>Name:</strong> ${client.fullName}</div>
                            <div class="info-item"><strong>Reference:</strong> ${client.referenceNumber}</div>
                            <div class="info-item"><strong>Date of Birth:</strong> ${client.dob || 'Not provided'}</div>
                            <div class="info-item"><strong>Age:</strong> ${client.age || 'N/A'} years</div>
                            <div class="info-item"><strong>Gender:</strong> ${client.gender}</div>
                            <div class="info-item"><strong>Phone:</strong> ${client.phone}</div>
                            <div class="info-item"><strong>Height:</strong> ${client.height}cm</div>
                            <div class="info-item"><strong>Weight:</strong> ${client.weight}kg</div>
                            <div class="info-item"><strong>Namibian ID:</strong> ${client.nbNumber}</div>
                            ${client.membershipStatus === 'member' ? `
                                <div class="info-item"><strong>Member ID:</strong> ${client.memberId || 'N/A'}</div>
                            ` : `
                                <div class="info-item"><strong>Referred by:</strong> ${client.referralName || 'N/A'}</div>
                                <div class="info-item"><strong>Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Symptoms & Recommendations -->
                    ${selectedSymptoms.length > 0 ? `
                    <div class="section">
                        <div class="section-title">ðŸ©º SUB-HEALTH TRENDS</div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 2px solid #2196f3; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.map(item => `
                                <div style="margin-bottom: 5px; padding: 3px 6px; background: white; border-radius: 3px; border-left: 3px solid #2196f3; display: inline-block; margin-right: 5px;">
                                    <strong>${item.symptom}</strong> (${item.system})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Lifestyle Recommendations -->
                    <div class="section allow-break">
                        <div class="section-title">ðŸŒ¿ LIFESTYLE RECOMMENDATIONS</div>
                        <div style="background: #f0f8f0; padding: 10px; border-radius: 4px; border: 2px solid #4caf50; font-size: 9pt; line-height: 1.4;">
                            ${selectedSymptoms.length > 0 ? `
                                ${selectedSymptoms.map(item => `
                                    <div class="recommendation-item">
                                        <strong style="color: #2e7d32;">âœ“ ${item.symptom}:</strong>
                                        <span style="color: #555;">${item.recommendation}</span>
                                    </div>
                                `).join('')}
                            ` : `
                                <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                    <p>ðŸ“‹ <strong>No specific symptoms selected</strong></p>
                                    <p style="font-size: 8pt; margin-top: 5px;">To view personalized lifestyle recommendations, please select symptoms from the body systems above before printing this report.</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Prescribed Products -->
                    ${selectedMeds.length > 0 ? `
                    <div class="section">
                        <div class="section-title">ðŸ’Š PRESCRIBED PRODUCTS</div>
                        <div class="medicine-list">
                            <ul>
                                ${selectedMeds.map(med => `<li>âœ“ ${med}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Consultant Notes -->
                    ${consultantNotes.trim() ? `
                    <div class="section">
                        <div class="section-title">ðŸ“ CONSULTANT'S DIAGNOSIS & NOTES</div>
                        <div class="notes-box">${consultantNotes}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Follow-up & Signature -->
                    <div class="footer">
                        <div>
                            ${followUpDate ? `
                            <div class="follow-up-box">
                                <strong>ðŸ“… FOLLOW-UP APPOINTMENT</strong>
                                <p><strong>Date:</strong> ${new Date(followUpDate).toLocaleDateString('en-GB')}</p>
                                ${followUpNotes ? `<p><strong>Notes:</strong> ${followUpNotes}</p>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <strong>${currentUser.fullName}</strong>
                            <p>Certified Consultant</p>
                            <p style="font-size: 8pt;">Tel: ${currentUser.phone || '061-300877'}</p>
                            <p style="font-size: 8pt;">Email: ${currentUser.email || 'info@dynapharm.com.na'}</p>
                        </div>
                    </div>
                    
                    <!-- Summary Report Card Disclaimer -->
                    <div class="summary-footer">
                        <p>ðŸ“‹ THIS IS A SUMMARY REPORT CARD</p>
                        <p>For detailed analysis and comprehensive information, please refer to the complete Analysis Report Card</p>
                    </div>
                    
                    <!-- Dynapharm Motto -->
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 2px solid #c41e3a;">
                        <div style="font-size: 12pt; color: #c41e3a; font-weight: bold; letter-spacing: 1px;">
                            HEALTH | WEALTH | FREEDOM
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Print after content is loaded
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function updatePrescriptionDisplay() {
            // Get selected medicines
            const selectedMeds = [];
            document.querySelectorAll('#medicineGrid input:checked').forEach(cb => {
                selectedMeds.push(cb.value);
            });
            
            // Update the prescription display
            const prescriptionDisplay = document.getElementById('prescriptionDisplay');
            if (prescriptionDisplay) {
                if (selectedMeds.length > 0) {
                    prescriptionDisplay.innerHTML = `
                        <div class="selected-medicines">
                            <h4>Prescribed Medicines:</h4>
                            <ul>
                                ${selectedMeds.map(med => `<li>${med}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    prescriptionDisplay.innerHTML = '<p>No medicines selected</p>';
                }
            }
        }

        function updateNotesDisplay() {
            const notes = document.getElementById('consultantNotes').value;
            const notesDisplay = document.getElementById('notesDisplay');
            if (notesDisplay) {
                if (notes.trim()) {
                    notesDisplay.innerHTML = `
                        <div class="notes-preview">
                            <h4>Diagnosis & Treatment Notes:</h4>
                            <div class="notes-content">${notes}</div>
                        </div>
                    `;
                } else {
                    notesDisplay.innerHTML = '';
                }
            }
        }

        // Autosave functionality
        let autosaveInterval;
        let autosaveTimeout;
        
        function startAutosave() {
            // Clear any existing autosave
            clearInterval(autosaveInterval);
            
            // Autosave every 30 seconds
            autosaveInterval = setInterval(() => {
                autosaveDraft();
            }, 30000);
        }
        
        function stopAutosave() {
            clearInterval(autosaveInterval);
        }
        
        function autosaveDraft() {
            if (!currentClientId) return;
            
            const reportData = {
                clientId: currentClientId,
                consultant: currentUser.fullName,
                consultantNotes: document.getElementById('consultantNotes')?.value || '',
                followUpDate: document.getElementById('followUpDate')?.value || '',
                followUpNotes: document.getElementById('followUpNotes')?.value || '',
                timestamp: new Date().toISOString(),
                status: 'draft'
            };
            
            // Save to localStorage as draft
            const drafts = JSON.parse(localStorage.getItem('consultant_drafts') || '[]');
            const existingIndex = drafts.findIndex(d => d.clientId === currentClientId);
            
            if (existingIndex >= 0) {
                drafts[existingIndex] = reportData;
            } else {
                drafts.push(reportData);
            }
            
            localStorage.setItem('consultant_drafts', JSON.stringify(drafts));
            
            // Show autosave indicator
            const status = document.getElementById('autosaveStatus');
            const time = document.getElementById('autosaveTime');
            if (status && time) {
                time.textContent = new Date().toLocaleTimeString();
                status.style.display = 'block';
                
                // Hide after 5 seconds
                clearTimeout(autosaveTimeout);
                autosaveTimeout = setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Template functions
        function openReportTemplateSelector() {
            displayReportTemplates();
            document.getElementById('reportTemplateModal').style.display = 'block';
        }
        
        function displayReportTemplates() {
            const templates = [
                {
                    name: 'General Consultation',
                    icon: 'ðŸ©º',
                    description: 'Basic consultation template',
                    data: {
                        notes: 'Patient presents for general consultation.\n\nAssessment: General health evaluation.\n\nPlan: Continue healthy lifestyle, regular follow-up as needed.'
                    }
                },
                {
                    name: 'Respiratory Issues',
                    icon: 'ðŸ«',
                    description: 'Cough, cold, asthma',
                    data: {
                        notes: 'Patient presents with respiratory concerns.\n\nAssessment: Respiratory symptoms noted.\n\nPlan: Rest, hydration, monitor symptoms. Follow-up if symptoms persist.'
                    }
                },
                {
                    name: 'Digestive Health',
                    icon: 'ðŸ’Š',
                    description: 'Stomach, digestion issues',
                    data: {
                        notes: 'Patient presents with digestive concerns.\n\nAssessment: Digestive symptoms evaluated.\n\nPlan: Dietary modifications, hydration. Follow-up as needed.'
                    }
                },
                {
                    name: 'Pain Management',
                    icon: 'ðŸ¤•',
                    description: 'Headache, body pain',
                    data: {
                        notes: 'Patient presents with pain concerns.\n\nAssessment: Pain symptoms assessed.\n\nPlan: Pain management, rest, monitoring. Review progress.'
                    }
                },
                {
                    name: 'Wellness Check',
                    icon: 'âœ¨',
                    description: 'General wellness, vitamins',
                    data: {
                        notes: 'Patient presents for wellness consultation.\n\nAssessment: General wellness evaluation.\n\nPlan: Continue health maintenance, consider supplementation if needed.'
                    }
                }
            ];
            
            const list = document.getElementById('templateList');
            list.innerHTML = templates.map(t => `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #ddd; cursor: pointer;" onclick="applyTemplate('${t.name}')">
                    <div style="font-size: 3rem; margin-bottom: 10px;">${t.icon}</div>
                    <h4 style="color: #2c3e50; margin-bottom: 5px;">${t.name}</h4>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">${t.description}</p>
                </div>
            `).join('');
        }
        
        function applyTemplate(templateName) {
            const templates = {
                'General Consultation': { notes: 'Patient presents for general consultation.\n\nAssessment: General health evaluation.\n\nPlan: Continue healthy lifestyle, regular follow-up as needed.' },
                'Respiratory Issues': { notes: 'Patient presents with respiratory concerns.\n\nAssessment: Respiratory symptoms noted.\n\nPlan: Rest, hydration, monitor symptoms. Follow-up if symptoms persist.' },
                'Digestive Health': { notes: 'Patient presents with digestive concerns.\n\nAssessment: Digestive symptoms evaluated.\n\nPlan: Dietary modifications, hydration. Follow-up as needed.' },
                'Pain Management': { notes: 'Patient presents with pain concerns.\n\nAssessment: Pain symptoms assessed.\n\nPlan: Pain management, rest, monitoring. Review progress.' },
                'Wellness Check': { notes: 'Patient presents for wellness consultation.\n\nAssessment: General wellness evaluation.\n\nPlan: Continue health maintenance, consider supplementation if needed.' }
            };
            
            const template = templates[templateName];
            if (template) {
                const notesField = document.getElementById('consultantNotes');
                if (notesField) {
                    notesField.value = template.notes;
                    updateNotesDisplay();
                }
            }
            
            closeModal('reportTemplateModal');
        }

        // Finalize and e-sign
        function finalizeReport() {
            if (!currentClientId) {
                alert('Please select a client first');
                return;
            }
            
            const consultantNotes = document.getElementById('consultantNotes')?.value.trim();
            if (!consultantNotes) {
                alert('Please add diagnosis and treatment notes before finalizing');
                return;
            }
            
            if (confirm('Are you sure you want to finalize and e-sign this report? This action cannot be undone.')) {
                // Mark as finalized with e-signature
                const report = reports.find(r => r.clientId === currentClientId);
                if (report) {
                    report.status = 'finalized';
                    report.finalizedDate = new Date().toISOString();
                    report.eSignedBy = currentUser.fullName;
                    report.eSignedDate = new Date().toISOString();
                    
                    saveData();
                    alert('Report finalized and e-signed successfully!');
                    closeModal('reportModal');
                    stopAutosave();
                }
            }
        }

        // PDF Export
        function exportReportPDF() {
            printReport(); // Reuse print functionality
        }

        // Show drafts
        function showMyDrafts() {
            const drafts = JSON.parse(localStorage.getItem('consultant_drafts') || '[]');
            if (drafts.length === 0) {
                alert('No draft reports found');
                return;
            }
            
            let list = 'Available Drafts:\n\n';
            drafts.forEach((draft, idx) => {
                const client = clients.find(c => c.referenceNumber === draft.clientId);
                list += `${idx + 1}. ${client ? client.fullName : draft.clientId} (${new Date(draft.timestamp).toLocaleDateString()})\n`;
            });
            
            const selection = prompt(list + '\nEnter draft number to open:');
            if (selection) {
                const idx = parseInt(selection) - 1;
                if (idx >= 0 && idx < drafts.length) {
                    const draft = drafts[idx];
                    createReport(draft.clientId);
                    
                    // Restore draft data after a short delay
                    setTimeout(() => {
                        const notesField = document.getElementById('consultantNotes');
                        const followUpDateField = document.getElementById('followUpDate');
                        const followUpNotesField = document.getElementById('followUpNotes');
                        
                        if (notesField) notesField.value = draft.consultantNotes;
                        if (followUpDateField) followUpDateField.value = draft.followUpDate;
                        if (followUpNotesField) followUpNotesField.value = draft.followUpNotes;
                        
                        updateNotesDisplay();
                    }, 500);
                }
            }
        }

        // Show today's appointments
        function showTodaysAppointments() {
            const today = new Date().toISOString().split('T')[0];
            const todaysAppts = appointments.filter(a => 
                a.consultant === currentUser.fullName && 
                a.date === today &&
                a.status !== 'cancelled'
            );
            
            if (todaysAppts.length === 0) {
                alert('No appointments scheduled for today');
                return;
            }
            
            // Scroll to appointments section and filter
            const followUpSearch = document.getElementById('followUpSearch');
            if (followUpSearch) {
                followUpSearch.value = today;
                filterFollowUps();
                
                // Scroll to appointments
                followUpSearch.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function displayPrescriptions() {
            // Refresh data from API and localStorage to ensure fresh data
            await loadData();
            
            // Verify clients are loaded
            if (!clients || clients.length === 0) {
                console.warn('âš ï¸ No clients found when displaying prescriptions. Reloading...');
                try {
                    const clientsData = localStorage.getItem('dyna_clients');
                    if (clientsData) {
                        clients = JSON.parse(clientsData);
                        console.log(`âœ… Loaded ${clients.length} clients from localStorage for prescriptions`);
                    }
                } catch(error) {
                    console.error('âŒ Error loading clients for prescriptions:', error);
                }
            }
            
            // Verify reports are loaded
            if (!reports || reports.length === 0) {
                console.warn('âš ï¸ No reports found when displaying prescriptions. Reloading...');
                try {
                    const reportsData = localStorage.getItem('dyna_reports');
                    if (reportsData) {
                        reports = JSON.parse(reportsData);
                        console.log(`âœ… Loaded ${reports.length} reports from localStorage for prescriptions`);
                    }
                } catch(error) {
                    console.error('âŒ Error loading reports for prescriptions:', error);
                }
            }
            
            const list = document.getElementById('prescriptionList');
            // Filter only actual reports (with id field) that have prescriptions
    let pendingReports = reports.filter(r => r.id && r.prescription && r.medicines);

    // Apply status/date filters if present
    try {
        const statusSel = document.getElementById('rxStatusFilter');
        const fromEl = document.getElementById('rxFromDate');
        const toEl = document.getElementById('rxToDate');
        const status = statusSel ? statusSel.value : 'all';
        const fromDate = fromEl && fromEl.value ? new Date(fromEl.value + 'T00:00:00') : null;
        const toDate = toEl && toEl.value ? new Date(toEl.value + 'T23:59:59') : null;

        if (fromDate || toDate) {
            pendingReports = pendingReports.filter(r => {
                const t = r.timestamp ? new Date(r.timestamp) : null;
                if (!t) return true;
                if (fromDate && t < fromDate) return false;
                if (toDate && t > toDate) return false;
                return true;
            });
        }

        // By default, hide fully dispensed prescriptions to keep display clean
        // Only show them if explicitly filtered
        if (status && status !== 'all') {
            pendingReports = pendingReports.filter(r => {
                const meds = Array.isArray(r.medicines) ? r.medicines : [];
                if (status === 'pending') return meds.some(m => !m.dispensed);
                if (status === 'dispensed') return meds.length > 0 && meds.every(m => m.dispensed);
                if (status === 'paid') return meds.filter(m => m.dispensed).every(m => m.paid);
                if (status === 'outstanding') return meds.some(m => m.dispensed && !m.paid);
                return true;
            });
        } else {
            // Default: only show prescriptions with at least one pending item (not fully dispensed)
            pendingReports = pendingReports.filter(r => {
                const meds = Array.isArray(r.medicines) ? r.medicines : [];
                return meds.some(m => !m.dispensed); // Show only if there's at least one pending item
            });
        }
    } catch(_){ /* ignore filter errors */ }
            
    // Sort by latest first (prefer lastModified then timestamp) - newest prescriptions appear first
    pendingReports.sort((a, b) => {
        const dateA = new Date(a.lastModified || a.timestamp || 0);
        const dateB = new Date(b.lastModified || b.timestamp || 0);
        return dateB - dateA; // Latest first
    });

    if (pendingReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ’Š No prescriptions to dispense</h3><p>Prescriptions will appear here once consultants create reports.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            pendingReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                
                // Calculate medicine status
                const pending = report.medicines ? report.medicines.filter(m => !m.dispensed).length : 0;                                                       
                const dispensed = report.medicines ? report.medicines.filter(m => m.dispensed).length : 0;                                                      
                const total = report.medicines ? report.medicines.length : 0;
                
                // Calculate totals and membership status outside IIFE for use in buttons section                                                               
                const clientMembershipStatus = client ? client.membershipStatus : 'referred';                                                                   
                // Ensure totals is always defined, even if medicines array is empty or undefined
                const totals = (report.medicines && report.medicines.length > 0) 
                    ? calculatePrescriptionTotals(report.medicines, clientMembershipStatus)                                                                     
                    : { total: { dp: 0, cp: 0, bv: 0 }, dispensed: { dp: 0, cp: 0, bv: 0 }, paid: { dp: 0, cp: 0, bv: 0 }, outstanding: { dp: 0, cp: 0, bv: 0 }, pending: { dp: 0, cp: 0, bv: 0 } };
                
                                card.innerHTML = `
                    <div style="background: linear-gradient(135deg, #c41e3a 0%, #a0172e 100%); padding: 16px; border-radius: 8px 8px 0 0; color: white; margin: -15px -15px 15px -15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px;">PRESCRIPTION</div>
                                <h4 style="color: white; margin: 0; font-size: 1.3rem; font-weight: 700;">${report.id}</h4>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${pending > 0 ? 'rgba(255,255,255,0.25)' : 'rgba(255,255,255,0.3)'}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; backdrop-filter: blur(10px);">
                                    ${pending} pending${dispensed > 0 ? ` â€¢ ${dispensed} dispensed` : ''}
                                </span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px;">${client ? client.fullName : 'Unknown Client'}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">${report.clientId}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">               
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">ðŸ‘¨â€âš•ï¸</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Consultant</div>
                                <div style="font-weight: 600; color: #2c3e50;">${report.consultant}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">ðŸ“…</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Date</div>
                                <div style="font-weight: 600; color: #2c3e50;">${new Date(report.timestamp).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">ðŸ“ž</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Phone</div>
                                <div style="font-weight: 600; color: #2c3e50;">${client ? client.phone : 'N/A'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">ðŸ¢</span>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">Branch</div>
                                <div style="font-weight: 600; color: #2c3e50;">${client ? client.branch : 'Unknown'}</div>
                            </div>
                        </div>
                        ${client ? (client.membershipStatus === 'member' ? `
                            <p><strong>ðŸ†” NB Number:</strong> ${client.nbNumber || 'N/A'}</p>
                            <p><strong>ðŸ‘¤ Member ID:</strong> ${client.memberId || 'N/A'}</p>
                        ` : `
                            <p><strong>ðŸ‘¤ Referred by:</strong> ${client.referralName || 'N/A'}</p>
                            <p><strong>ðŸ†” Referral NB:</strong> ${client.referralNbNumber || 'N/A'}</p>
                        `) : ''}
                    </div>
                    ${report.medicines && report.medicines.length > 0 ? (() => {
                        const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
                        return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #c41e3a;">
                        <!-- Consultation Fee -->
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 2px solid #2196f3;">
                            <p style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">ðŸ‘¨â€âš•ï¸ CONSULTATION FEE</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Consultant Medical Examination</span>
                                <span style="font-weight: bold; color: #1976d2; font-size: 1.1rem;">
                                    ${clientMembershipStatus === 'member' ? `N$${consultationFee} (DP)` : `N$${consultationFee} (CP)`}
                                </span>
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${clientMembershipStatus === 'member' ? 'âœ“ Member Rate: N$150' : 'âœ“ Client Rate: N$200'}
                            </p>
                        </div>
                        
                        <p><strong>ðŸ’Š Prescription Medicines:</strong></p>
                        <div style="margin-top: 10px;">
                            ${report.medicines.map((med, i) => {
                                const price = findProductPrice(med.name);
                                const isPackage = price.isPackage;
                                
                                // Calculate pricing based on package status
                                let effectivePrice;
                                let packageInfo = null;
                                
                                if (isPackage) {
                                    // Initialize packageStatus if it doesn't exist for existing reports
                                    if (!med.packageStatus) {
                                        med.packageStatus = {};
                                        // Update the report in backend to persist the change
                                        updateReportInBackend(report);
                                    }
                                    
                                    const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                    if (clientMembershipStatus === 'member') {
                                        effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                    } else {
                                        effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                    }
                                    packageInfo = packagePricing;
                                } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                    }
                                }
                                
                                return `
                                <div style="padding: 12px; margin: 8px 0; background: ${med.dispensed ? '#e8f5e9' : '#fff3cd'}; border-radius: 5px; border-left: 4px solid ${med.dispensed ? '#27ae60' : '#f39c12'};">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="disp_${report.id}_${i}" ${med.dispensed ? 'checked' : ''}
                                            onchange="toggleDispense('${report.id}', ${i})" style="margin-right: 8px;">
                                        <label for="disp_${report.id}_${i}" style="font-weight: 600; flex: 1; font-size: 1.05rem;">
                                            ${med.name} ${med.dispensed ? 'âœ… Dispensed' : 'â³ Pending'}
                                            ${isPackage ? ' ðŸ“¦' : ''}
                                        </label>
                                    </div>
                                    
                                    ${isPackage ? `
                                    <div style="background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #b3d9ff;">
                                        <p style="font-weight: 600; color: #1976d2; margin-bottom: 8px; font-size: 0.9rem;">ðŸ“¦ Package Contents:</p>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px;">
                                            ${(() => {
                                                const packageData = PACKAGE_DATABASE[med.name];
                                                if (!packageData || !packageData.products) {
                                                    return `<div style="padding: 10px; background: #ffebee; border-radius: 3px; color: #c62828; font-size: 0.8rem;">
                                                        âš ï¸ Package data not found. Click "Update Pricing" to refresh.
                                                    </div>`;
                                                }
                                                return packageData.products.map((product, pIndex) => {
                                                    const productStatus = med.packageStatus && med.packageStatus[product.name] ? med.packageStatus[product.name] : 'not_given';
                                                    const escapedProductName = product.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                    return `
                                                    <div style="background: white; padding: 8px; border-radius: 3px; border-left: 3px solid ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                                            <span style="font-weight: 500; flex: 1; font-size: 0.85rem;">${product.name}</span>
                                                            <span style="font-size: 0.75rem; color: ${productStatus === 'given' ? '#27ae60' : '#f39c12'};">
                                                                ${productStatus === 'given' ? 'âœ…' : 'â³'}
                                                            </span>
                                                        </div>
                                                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
                                                            Qty: ${product.quantity} | 
                                                            ${clientMembershipStatus === 'member' ? 
                                                                `DP: N$${product.dp} | BV: ${product.bv}` : 
                                                                `CP: N$${product.cp}`}
                                                        </div>
                                                        <select id="package_select_${report.id}_${i}_${pIndex}" 
                                                                onchange="updatePackageStatus('${report.id}', ${i}, '${escapedProductName}', this.value)"
                                                                data-product-name="${escapedProductName}"
                                                                style="width: 100%; padding: 2px 4px; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 3px;">
                                                            <option value="not_given" ${productStatus === 'not_given' ? 'selected' : ''}>Not Given</option>
                                                            <option value="given" ${productStatus === 'given' ? 'selected' : ''}>Given</option>
                                                            <option value="out_of_stock" ${productStatus === 'out_of_stock' ? 'selected' : ''}>Out of Stock</option>
                                                        </select>
                                                    </div>
                                                    `;
                                                }).join('');
                                            })()}
                                        </div>
                                        <div style="background: #e8f5e9; padding: 8px; border-radius: 3px; margin-top: 8px; border: 1px solid #27ae60;">
                                            <div style="font-size: 0.8rem; color: #27ae60; text-align: center;">
                                                <div style="margin-bottom: 4px;">
                                                    <strong>ðŸ“¦ Dispensed:</strong> ${packageInfo.dispensedCount}/${packageInfo.totalCount} items
                                                    ${clientMembershipStatus === 'member' ? 
                                                        ` | DP: N$${effectivePrice.dp} | BV: ${effectivePrice.bv}` : 
                                                        ` | CP: N$${effectivePrice.cp}`}
                                                </div>
                                                <div style="font-size: 0.75rem; color: #666;">
                                                    ${packageInfo.dispensedCount < packageInfo.totalCount ? 
                                                        `Remaining: ${packageInfo.totalCount - packageInfo.dispensedCount} items` : 
                                                        'âœ… All items dispensed'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ` : `
                                    <div style="font-size: 0.9rem; color: #666; margin-left: 24px;">
                                        ${clientMembershipStatus === 'member' ? `
                                            <span style="margin-right: 15px;"><strong>DP:</strong> N$${effectivePrice.dp}</span>
                                            <span><strong>BV:</strong> ${effectivePrice.bv}</span>
                                        ` : `
                                            <span><strong>CP:</strong> N$${effectivePrice.cp}</span>
                                        `}
                                    </div>
                                    `}
                                    
                                    ${med.dispensed ? `
                                    <div style="margin-left: 24px; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="paid_${report.id}_${i}" ${med.paid ? 'checked' : ''}
                                                onchange="togglePayment('${report.id}', ${i})" style="margin-right: 8px;">
                                            <span style="font-size: 0.85rem; color: #27ae60; font-weight: 500;">ðŸ’° Payment Received</span>
                                        </label>
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Price Totals -->
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">                  
                            <h4 style="color: white; margin-bottom: 12px; text-align: center; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">ðŸ’° Prescription Summary</h4>                                
                            <p style="text-align: center; font-size: 0.85rem; color: rgba(255,255,255,0.9); margin-bottom: 18px;">    
                                Includes N$${consultationFee} consultation fee                                     
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">      
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">                                     
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Total</div>                       
                                    <div style="font-size: 1rem; font-weight: 700; color: #c41e3a;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.total.dp}</div>                     
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.total.bv}</div>                       
                                        ` : `                                 
                                            <div>N$${totals.total.cp}</div>                     
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #27ae60;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Dispensed</div>                   
                                    <div style="font-size: 1rem; font-weight: 700; color: #27ae60;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.dispensed.dp}</div>                 
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.dispensed.bv}</div>                   
                                        ` : `                                 
                                            <div>N$${totals.dispensed.cp}</div>                 
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #155724;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Paid</div>                        
                                    <div style="font-size: 1rem; font-weight: 700; color: #155724;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.paid.dp}</div>                      
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.paid.bv}</div>                        
                                        ` : `                                 
                                            <div>N$${totals.paid.cp}</div>                      
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Outstanding</div>                 
                                    <div style="font-size: 1rem; font-weight: 700; color: ${Number(totals.outstanding[clientMembershipStatus === 'member' ? 'dp' : 'cp']) > 0 ? '#f39c12' : '#27ae60'};">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.outstanding.dp}</div>               
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.outstanding.bv}</div>                 
                                        ` : `                                 
                                            <div>N$${totals.outstanding.cp}</div>               
                                        `}                                    
                                    </div>                                    
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.95); padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ff9800;">                                   
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;">Pending</div>                     
                                    <div style="font-size: 1rem; font-weight: 700; color: #ff9800;">          
                                        ${clientMembershipStatus === 'member' ? `                                    
                                            <div>N$${totals.pending.dp}</div>                   
                                            <div style="font-size: 0.75rem; color: #27ae60; margin-top: 4px;">BV: ${totals.pending.bv}</div>                     
                                        ` : `                                 
                                            <div>N$${totals.pending.cp}</div>                   
                                        `}                                    
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    })() : ''}
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>ðŸ“ Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid #e0e0e0; margin-top: 15px;">                         
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">ðŸ‘ï¸ View Details</button>                              
                        <button class="btn btn-warning" onclick="printPrescription('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">ðŸ–¨ï¸ Print Full</button>                                   
                        <button class="btn btn-success" onclick="printThermalReceipt('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">ðŸ§¾ Thermal Receipt</button>                           
                        ${pending > 0 ? `<button class="btn" onclick="dispenseAll('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; background: #27ae60; color: white; transition: all 0.3s;">âœ… Mark All Dispensed</button>` : ''}                                           
                        ${(totals && totals.outstanding && totals.outstanding[clientMembershipStatus === 'member' ? 'dp' : 'cp'] > 0) ? `<button class="btn btn-primary" onclick="openPaymentModal('${report.id}')" style="min-width: 160px; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 1.05rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">ðŸ’³ Collect Payment</button>` : ''}
                        <button class="btn" onclick="viewPrescriptionPaymentHistory('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">ðŸ“œ Payment History</button>                            
                        <button class="btn btn-warning" onclick="reverseLastPrescriptionPayment('${report.id}')" style="min-width: 140px; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.3s;">â†©ï¸ Reverse Payment</button>            
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Function to calculate package pricing based on dispensed items
        function calculatePackagePricing(medicine, clientMembershipStatus) {
            const packageData = PACKAGE_DATABASE[medicine.name];
            if (!packageData || !packageData.products) {
                // For existing reports with old package names, try to find a match
                const possibleMatch = Object.keys(PACKAGE_DATABASE).find(key => 
                    key.toLowerCase().includes(medicine.name.toLowerCase()) || 
                    medicine.name.toLowerCase().includes(key.toLowerCase())
                );
                
                if (possibleMatch) {
                    console.log(`Found package match: "${medicine.name}" -> "${possibleMatch}"`);
                    const matchedPackage = PACKAGE_DATABASE[possibleMatch];
                    
                    // Initialize packageStatus for the matched package
                    if (!medicine.packageStatus) {
                        medicine.packageStatus = {};
                    }
                    
                    // Update the medicine name to the correct package name
                    medicine.name = possibleMatch;
                    
                    // Return pricing for the matched package
                    return {
                        dp: matchedPackage.price.dp,
                        cp: matchedPackage.price.cp,
                        bv: matchedPackage.price.bv,
                        dispensedCount: 0,
                        totalCount: matchedPackage.products.length,
                        packageTotal: matchedPackage.price
                    };
                }
                
                return { dp: 0, cp: 0, bv: 0, dispensedCount: 0, totalCount: 0 };
            }
            
            let dispensedDP = 0, dispensedCP = 0, dispensedBV = 0;
            let dispensedCount = 0;
            const totalCount = packageData.products.length;
            
            packageData.products.forEach(product => {
                const productStatus = medicine.packageStatus && medicine.packageStatus[product.name] 
                    ? medicine.packageStatus[product.name] : 'not_given';
                
                if (productStatus === 'given') {
                    dispensedDP += product.dp;
                    dispensedCP += product.cp;
                    dispensedBV += product.bv;
                    dispensedCount++;
                }
            });
            
            return {
                dp: dispensedDP,
                cp: dispensedCP,
                bv: dispensedBV,
                dispensedCount,
                totalCount,
                packageTotal: packageData.price
            };
        }

        // Function to update package status for individual products
        function updatePackageStatus(reportId, medicineIndex, productName, status) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medicineIndex]) return;
            
            const medicine = report.medicines[medicineIndex];
            
            // Initialize packageStatus if it doesn't exist
            if (!medicine.packageStatus) {
                medicine.packageStatus = {};
            }
            
            // Update the specific product status
            medicine.packageStatus[productName] = status;
            
            // Update local reports array immediately
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex !== -1) {
                reports[reportIndex] = report;
            }
            
            // Update the report in the backend asynchronously
            updateReportInBackend(report);
            
            // Show status update feedback
            const statusEmoji = status === 'given' ? 'âœ…' : status === 'out_of_stock' ? 'âš ï¸' : 'â³';
            const statusText = status === 'given' ? 'Given' : status === 'out_of_stock' ? 'Out of Stock' : 'Not Given';
            
            // Show brief feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                padding: 10px 15px; border-radius: 5px; z-index: 10000; font-size: 0.9rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            feedback.textContent = `${statusEmoji} ${productName}: ${statusText}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    document.body.removeChild(feedback);
                }
            }, 2000);
            
            // Refresh the display to show updated totals
            displayPrescriptions();
        }

        // Function to update report in backend
        async function updateReportInBackend(report) {
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    // Update local reports array
                    const index = reports.findIndex(r => r.id === report.id);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                } else {
                    console.error('Failed to update report:', result.message);
                }
            } catch (error) {
                console.error('Error updating report:', error);
            }
        }

        // Search functionality for dispenser portal
        function searchPrescriptions(portal) {
            const searchTerm = document.getElementById('dispenserSearch').value.toLowerCase();
            const list = document.getElementById('prescriptionList');
            
            if (!searchTerm) {
                displayPrescriptions();
                return;
            }
            
            const pendingReports = reports.filter(r => !r.dispensed && r.prescription);
            let filteredReports = pendingReports.filter(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                return (
                    report.id.toLowerCase().includes(searchTerm) ||
                    (client && client.fullName.toLowerCase().includes(searchTerm)) ||
                    report.consultant.toLowerCase().includes(searchTerm) ||
                    report.prescription.toLowerCase().includes(searchTerm)
                );
            });
            // Latest first
            filteredReports.sort((a, b) => new Date(b.lastModified || b.timestamp) - new Date(a.lastModified || a.timestamp));
            
            if (filteredReports.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><h3>ðŸ” No prescriptions found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 5px;">Report ${report.id}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Client: ${client ? client.fullName : 'Unknown'}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: #fff3cd; color: #f39c12; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">Pending</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>ðŸ‘¨â€âš•ï¸ Consultant:</strong> ${report.consultant}</p>
                        <p><strong>ðŸ“… Created:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                        <p><strong>ðŸ“ž Client Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>ðŸ†” Reference:</strong> ${report.clientId}</p>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
                        <p><strong>ðŸ’Š Prescription:</strong></p>
                        <p style="margin-top: 8px; white-space: pre-wrap;">${report.prescription}</p>
                    </div>
                    ${report.notes ? `
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>ðŸ“ Consultant Notes:</strong></p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">${report.notes}</p>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="markDispensed('${report.id}')">âœ… Mark Dispensed</button>
                        <button class="btn btn-info" onclick="viewPrescriptionDetails('${report.id}')">ðŸ‘ï¸ View Details</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAllPrescriptions(portal) {
            document.getElementById('dispenserSearch').value = '';
            displayPrescriptions();
        }

function clearRxFilters() {
    const s = document.getElementById('rxStatusFilter');
    const f = document.getElementById('rxFromDate');
    const t = document.getElementById('rxToDate');
    if (s) s.value = 'all';
    if (f) f.value = '';
    if (t) t.value = '';
    displayPrescriptions();
}

// -----------------------
// Prescription Payment Modal Handlers
// -----------------------
let rxPaymentContext = null;

function rxFormat(n){ const v = Number(n||0); return 'N$ ' + v.toFixed(2); }

function openPaymentModal(reportId){
    if (!hasActionPermission('collect_payment')) { alert('You do not have permission to collect payments.'); return; }
    const modal = document.getElementById('rxPaymentModal');
    if (!modal) return;
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    const client = clients.find(c => c.referenceNumber === report.clientId);
    const memberStatus = client && client.membershipStatus ? client.membershipStatus : 'referred';
    const totals = calculatePrescriptionTotals(report.medicines||[], memberStatus);
    const consultation = memberStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
    const amountDue = memberStatus === 'member' ? Number(totals.outstanding.dp||0) : Number(totals.outstanding.cp||0);

    rxPaymentContext = { reportId, memberStatus, totals, consultation, amountDue };

        const summary = document.getElementById('paymentSummary');                
    if (summary){
        const totalVal = memberStatus === 'member' ? totals.total.dp : totals.total.cp;                              
        const dispVal = memberStatus === 'member' ? totals.dispensed.dp : totals.dispensed.cp;                       
        const paidVal = memberStatus === 'member' ? totals.paid.dp : totals.paid.cp;                                 
        const outVal = memberStatus === 'member' ? totals.outstanding.dp : totals.outstanding.cp;                    
        summary.innerHTML = `
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #c41e3a; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Total</div>          
                <div style="font-weight:700; color:#c41e3a; font-size:1.2rem;">${rxFormat(totalVal)}</div>                             
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #27ae60; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Dispensed</div>      
                <div style="font-weight:700; color:#27ae60; font-size:1.2rem;">${rxFormat(dispVal)}</div>                              
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #155724; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Paid</div>           
                <div style="font-weight:700; color:#155724; font-size:1.2rem;">${rxFormat(paidVal)}</div>                              
            </div>
            <div style="background:linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border:2px solid #e0e0e0; border-left:4px solid #f39c12; padding:14px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">                           
                <div style="font-size:0.7rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Outstanding</div>    
                <div style="font-weight:700; color:#f39c12; font-size:1.2rem;">${rxFormat(outVal)}</div>                               
            </div>`;
    }

    const consult = document.getElementById('paymentConsultation');
    if (consult) consult.textContent = rxFormat(consultation);

        const tenderRows = document.getElementById('tenderRows');                 
    if (tenderRows){
        tenderRows.innerHTML = '';
        const row = document.createElement('div');                            
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 150px 1fr';
        row.style.gap = '12px';
        row.style.marginBottom = '12px';
                row.innerHTML = `
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Payment Method</label>
                <select class="tender-method" onchange="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                 
                    <option value="Cash">ðŸ’° Cash</option>                            
                    <option value="Card">ðŸ’³ Card</option>                            
                    <option value="Mobile Money">ðŸ“± Mobile Money</option>            
                    <option value="Bank Transfer">ðŸ¦ Bank Transfer</option>          
                </select>
            </div>
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Reference</label>
                <input class="tender-ref" placeholder="Optional" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                         
            </div>
            <div>
                <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Amount (N$)</label>
                <input class="tender-amount" type="number" min="0" step="0.01" value="${amountDue.toFixed(2)}" oninput="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; font-weight:600; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                               
            </div>
        `;
        tenderRows.appendChild(row);
    }

    const disc = document.getElementById('paymentDiscount');
    if (disc) disc.value = '0';
    recalcPaymentTotals();
    modal.style.display = 'flex';
}

function closePaymentModal(){
    const modal = document.getElementById('rxPaymentModal');
    if (modal) modal.style.display = 'none';
    rxPaymentContext = null;
}

function addTenderRow(){
    const tenderRows = document.getElementById('tenderRows');                 
    if (!tenderRows) return;
    const row = document.createElement('div');                                
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 150px 1fr';
    row.style.gap = '12px';
    row.style.marginBottom = '12px';
        row.innerHTML = `
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Payment Method</label>
            <select class="tender-method" onchange="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                     
                <option value="Cash">ðŸ’° Cash</option>                                
                <option value="Card">ðŸ’³ Card</option>                                
                <option value="Mobile Money">ðŸ“± Mobile Money</option>                
                <option value="Bank Transfer">ðŸ¦ Bank Transfer</option>              
            </select>
        </div>
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Reference</label>
            <input class="tender-ref" placeholder="Optional" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                             
        </div>
        <div>
            <label style="display:block; font-size:0.75rem; color:#666; margin-bottom:4px; font-weight:600;">Amount (N$)</label>
            <input class="tender-amount" type="number" min="0" step="0.01" value="0" oninput="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.95rem; font-weight:600; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">                  
        </div>
    `;
    tenderRows.appendChild(row);
    recalcPaymentTotals();
}

function recalcPaymentTotals(){
    if (!rxPaymentContext) return;
    const discount = Number(document.getElementById('paymentDiscount')?.value||0);
    const amountDue = Math.max(0, Number(rxPaymentContext.amountDue||0) - discount);
    const tenderInputs = Array.from(document.querySelectorAll('#tenderRows .tender-amount'));
    const tenderTotal = tenderInputs.reduce((sum, el) => sum + (Number(el.value)||0), 0);
    const changeOrBalance = tenderTotal - amountDue;
    const amountDueEl = document.getElementById('amountDue');
    const tenderTotalEl = document.getElementById('tenderTotal');
    const changeBalanceEl = document.getElementById('changeBalance');
    if (amountDueEl) amountDueEl.textContent = rxFormat(amountDue);
    if (tenderTotalEl) tenderTotalEl.textContent = rxFormat(tenderTotal);
    if (changeBalanceEl) changeBalanceEl.textContent = rxFormat(changeOrBalance);
}

function generateReceiptNumber(reportId){
    try {
        const report = reports.find(r => r.id === reportId);
        const client = report ? clients.find(c => c.referenceNumber === report.clientId) : null;
        const branch = client ? (client.branch||'BR') : 'BR';
        const dt = new Date();
        const ymd = dt.toISOString().slice(0,10).replaceAll('-','');
        const seq = (''+Date.now()).slice(-6);
        return `${branch}-${ymd}-${seq}`;
    } catch(_) { return 'RX-'+Date.now(); }
}

async function confirmPayment(){
    if (!rxPaymentContext) return;
    const { reportId } = rxPaymentContext;
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    const discount = Number(document.getElementById('paymentDiscount')?.value||0);
    const methods = Array.from(document.querySelectorAll('#tenderRows .tender-method'));
    const refs = Array.from(document.querySelectorAll('#tenderRows .tender-ref'));
    const amts = Array.from(document.querySelectorAll('#tenderRows .tender-amount'));
    const tenders = methods.map((m, i) => ({ method: m.value, reference: refs[i]?.value || '', amount: Number(amts[i]?.value||0) }));
    const receipt = generateReceiptNumber(reportId);

    if (!report.payments) report.payments = [];
    report.payments.push({
        receipt,
        discount,
        tenders,
        memberStatus: rxPaymentContext.memberStatus,
        collectedBy: (currentUser && currentUser.fullName) ? currentUser.fullName : 'system',
        collectedAt: new Date().toISOString()
    });

    if (Array.isArray(report.medicines)) {
        report.medicines.forEach(m => {
            if (m.dispensed) {
                if (!m.paymentHistory) m.paymentHistory = [];
                m.paid = true;
                m.paidBy = (currentUser && currentUser.fullName) ? currentUser.fullName : 'system';
                m.paidAt = new Date().toISOString();
                m.paymentMethod = 'Multiple';
                m.amountPaid = tenders.reduce((s, t) => s + (Number(t.amount)||0), 0);
                m.paymentHistory.push({ amount: m.amountPaid, method: 'Multiple', paidBy: m.paidBy, paidAt: m.paidAt, reference: receipt });
            }
        });
    }

    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success) {
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            closePaymentModal();
            displayPrescriptions();
            alert(`âœ… Payment recorded. Receipt: ${receipt}`);
        } else {
            alert('Error saving payment');
        }
    } catch(e){ alert('Error saving payment'); }
}

function viewPrescriptionPaymentHistory(reportId){
    const report = reports.find(r => r.id === reportId);
    if (!report || !report.payments || report.payments.length === 0){
        alert('No prescription-level payments recorded');
        return;
    }
    const lines = report.payments.map(p => {
        const sum = (p.tenders||[]).reduce((s,t)=> s+(Number(t.amount)||0),0);
        const methods = (p.tenders||[]).map(t=> `${t.method}:${(Number(t.amount)||0).toFixed(2)}`).join(', ');
        return `${new Date(p.collectedAt).toLocaleString('en-GB')} | ${p.receipt} | ${methods} | Total: ${sum.toFixed(2)}`;
    }).join('\n');
    alert(`Payment History for ${reportId}:\n\n${lines}`);
}

// FEFO helper: choose earliest-expiring lot with enough qty (or first available)
function pickFefoLot(productName, qty){
    try {
        const inv = (window.inventory && window.inventory[productName]) ? window.inventory[productName] : null;
        const lots = Array.isArray(inv?.lots) ? inv.lots.slice() : [];
        if (lots.length === 0) return null;
        lots.sort((a,b) => new Date(a.expiry) - new Date(b.expiry));
        let chosen = null;
        for (const lot of lots){
            if (Number(lot.qty||0) >= Number(qty||1)) { chosen = lot; break; }
            if (!chosen) chosen = lot; // fallback to first
        }
        if (!chosen) chosen = lots[0];
        // decrement lot qty if tracked
        if (inv && inv.lots) {
            const idx = inv.lots.findIndex(l => l.batch === chosen.batch && l.expiry === chosen.expiry);
            if (idx >= 0) inv.lots[idx].qty = Math.max(0, Number(inv.lots[idx].qty||0) - Number(qty||1));
        }
        return { batch: chosen.batch, expiry: chosen.expiry };
    } catch(_){ return null; }
}

async function dispenseAll(reportId){
    if (!hasActionPermission('dispense')) { alert('You do not have permission to dispense.'); return; }
    const report = reports.find(r => r.id === reportId);
    if (!report || !Array.isArray(report.medicines)) return;
    const confirmAll = confirm('Mark all items as dispensed? This will update package items as given and adjust inventory.');
    if (!confirmAll) return;
    report.medicines.forEach(med => {
        const price = findProductPrice(med.name);
        const isPackage = !!price.isPackage;
        if (isPackage){
            const products = price.products || [];
            med.packageStatus = med.packageStatus || {};
            products.forEach(p => med.packageStatus[p] = 'given');
        }
        try {
            const inv = (window.inventory && window.inventory[med.name]) ? window.inventory[med.name] : null;
            const neededQty = Number(med.quantity || 1);
            const available = inv ? Number(inv.currentStock || 0) : Infinity;
            if (available < neededQty) {
                med.dueOut = Math.max(0, neededQty - available);
                med.dispensed = false;
                return;
            }
        } catch(_){ }
        med.dispensed = true;
        med.dispensedBy = (currentUser && currentUser.fullName) ? currentUser.fullName : 'system';
        med.dispensedAt = new Date().toISOString();
        try { const lot = pickFefoLot(med.name, Number(med.quantity||1)); if (lot) { med.lotBatch = lot.batch; med.lotExpiry = lot.expiry; } } catch(_){ }
        try { adjustInventoryForDispense(report, med, Number(med.quantity||1)); } catch(_){ }
    });
    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success){
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            displayPrescriptions();
            alert('âœ… All eligible items marked as dispensed. Due-outs recorded where stock was insufficient.');
        } else {
            alert('Error updating prescription');
        }
    } catch(e){ alert('Error updating prescription'); }
}

async function reverseLastPrescriptionPayment(reportId){
    const report = reports.find(r => r.id === reportId);
    if (!report || !report.payments || report.payments.length === 0){
        alert('No payments to reverse');
        return;
    }
    const reason = prompt('Enter reversal reason:');
    if (!reason) return;
    const last = report.payments[report.payments.length - 1];
    const reversingTenders = (last.tenders||[]).map(t => ({ method: t.method, reference: (t.reference||'') + ' (REV)', amount: -Math.abs(Number(t.amount)||0) }));
    report.payments.push({
        receipt: last.receipt + '-REV',
        discount: 0,
        tenders: reversingTenders,
        memberStatus: last.memberStatus,
        collectedBy: (currentUser && currentUser.fullName) ? currentUser.fullName : 'system',
        collectedAt: new Date().toISOString(),
        reversalOf: last.receipt,
        reason
    });
    if (Array.isArray(report.medicines)) {
        report.medicines.forEach(m => { if (m.dispensed) { m.paid = false; delete m.paidAt; delete m.paidBy; delete m.paymentMethod; delete m.amountPaid; } });
    }
    try {
        const result = await apiRequest('/reports', 'PUT', report);
        if (result && result.success){
            const idx = reports.findIndex(r => r.id === reportId);
            if (idx !== -1) reports[idx] = report;
            displayPrescriptions();
            alert('âœ… Payment reversed');
        } else {
            alert('Error reversing payment');
        }
    } catch(e){ alert('Error reversing payment'); }
}

        function showDispenserTab(tab) {
            // Hide all sections
            const sections = ['dispenserWalkInSection', 'dispenserPrescriptionSection', 'dispenserStockSection', 'dispenserBankingSection', 'dispenserPaymentsSection', 'dispenserOnlineOrdersSection', 'dispenserBonusSection', 'dispenserCommunicationSection', 'dispenserStaffSection', 'dispenserDistributorRegistrationSection', 'dispenserFieldProgramSection'];
            sections.forEach(sec => {
                const el = document.getElementById(sec);
                if (el) el.style.display = 'none';
            });
            
            // Reset all tab buttons
            const tabs = ['walkInTab', 'prescriptionTab', 'stockTab', 'bankingTab', 'paymentsTab', 'onlineOrdersTab', 'bonusTab', 'communicationTab', 'staffTab', 'distributorRegistrationTab', 'fieldProgramTab'];
            tabs.forEach(tabBtn => {
                const el = document.getElementById(tabBtn);
                if (el) {
                    el.style.background = '#ecf0f1';
                    el.style.color = '#2c3e50';
                    el.style.fontWeight = 'normal';
                }
            });
            
            // Show selected section and activate tab
            let activeSection = null;
            let activeTab = null;
            let gradient = '';
            
            switch(tab) {
                case 'walkIn':
                    activeSection = 'dispenserWalkInSection';
                    activeTab = 'walkInTab';
                    gradient = 'linear-gradient(135deg, #3498db, #2980b9)';
                    break;
                case 'prescription':
                    activeSection = 'dispenserPrescriptionSection';
                    activeTab = 'prescriptionTab';
                    gradient = 'linear-gradient(135deg, #27ae60, #229954)';
                    // Ensure data is loaded before displaying prescriptions
                    (async () => {
                        await loadData();
                        await displayPrescriptions();
                    })();
                    break;
                case 'stock':
                    activeSection = 'dispenserStockSection';
                    activeTab = 'stockTab';
                    gradient = 'linear-gradient(135deg, #34495e, #2c3e50)';
                    // Load branch inventory
                    if (typeof refreshBranchInventory === 'function') {
                        refreshBranchInventory();
                    }
                    break;
                case 'banking':
                    activeSection = 'dispenserBankingSection';
                    activeTab = 'bankingTab';
                    gradient = 'linear-gradient(135deg, #f39c12, #e67e22)';
                    displayBankingHistory();
                    break;
                case 'payments':
                    activeSection = 'dispenserPaymentsSection';
                    activeTab = 'paymentsTab';
                    gradient = 'linear-gradient(135deg, #9b59b6, #8e44ad)';
                    displayPaymentHistory();
                    break;
                case 'onlineOrders':
                    activeSection = 'dispenserOnlineOrdersSection';
                    activeTab = 'onlineOrdersTab';
                    gradient = 'linear-gradient(135deg, #6c5ce7, #5f27cd)';
                    displayBranchOnlineOrders();
                    break;
                case 'bonus':
                    activeSection = 'dispenserBonusSection';
                    activeTab = 'bonusTab';
                    gradient = 'linear-gradient(135deg, #e84393, #d63031)';
                    initializeDispenserBonusTab();
                    break;
                case 'communication':
                    activeSection = 'dispenserCommunicationSection';
                    activeTab = 'communicationTab';
                    gradient = 'linear-gradient(135deg, #16a34a, #0d9488)';
                    try { renderStaffCommunications(); } catch(_) {}
                    break;
                case 'fieldProgram':
                    activeSection = 'dispenserFieldProgramSection';
                    activeTab = 'fieldProgramTab';
                    gradient = 'linear-gradient(135deg, #e17055, #d63031)';
                    try { displayFieldProgramRequests(); } catch(_) {}
                    break;
                case 'staff':
                    activeSection = 'dispenserStaffSection';
                    activeTab = 'staffTab';
                    gradient = 'linear-gradient(135deg, #16a085, #138d75)';
                    loadMyStaffStatus();
                    break;
                case 'distributorRegistration':
                    activeSection = 'dispenserDistributorRegistrationSection';
                    activeTab = 'distributorRegistrationTab';
                    gradient = 'linear-gradient(135deg, #7b1fa2, #6a1b9a)';
                    initializeDistributorAgreementForm();
                    break;
            }
            
            if (activeSection && activeTab) {
                const sectionEl = document.getElementById(activeSection);
                const tabEl = document.getElementById(activeTab);
                
                if (sectionEl) sectionEl.style.display = 'block';
                if (tabEl) {
                    tabEl.style.background = gradient;
                    tabEl.style.color = 'white';
                    tabEl.style.fontWeight = 'bold';
                }
            }
        }

        // ========== Distributor Agreement Form ==========
        async function initializeDistributorAgreementForm() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('agreementDate');
            const dateReceivedInput = document.getElementById('dateReceived');
            if (dateInput) dateInput.value = today;
            if (dateReceivedInput) dateReceivedInput.value = today;
            
            // Auto-calculate age when birthdate changes
            const birthdateInput = document.getElementById('distributorBirthdate');
            if (birthdateInput) {
                birthdateInput.addEventListener('change', function() {
                    calculateAge(this.value);
                });
            }
            
            // Load current user info for "Received by" and "Processed by"
            if (window.currentUser) {
                const receivedBy = document.getElementById('receivedBy');
                const processedBy = document.getElementById('processedBy');
                if (receivedBy) receivedBy.value = window.currentUser.fullName || '';
                if (processedBy) processedBy.value = window.currentUser.fullName || '';
            }
        }
        
        function calculateAge(birthdate) {
            if (!birthdate) return;
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            const ageInput = document.getElementById('distributorAge');
            if (ageInput) ageInput.value = age;
        }
        
        async function getNextNBNumber() {
            try {
                // Fetch all distributors from database
                const response = await fetch('/api/distributors');
                if (!response.ok) throw new Error('Failed to fetch distributors');
                
                const distributors = await response.json();
                
                // Find the highest NB number
                let maxNB = 0;
                distributors.forEach(dist => {
                    const code = dist.distributor_code || dist.distributorCode || '';
                    const match = code.match(/^NB(\d+)$/i);
                    if (match) {
                        const num = parseInt(match[1], 10);
                        if (num > maxNB) maxNB = num;
                    }
                });
                
                // Generate next NB number
                const nextNB = maxNB + 1;
                return `NB${String(nextNB).padStart(6, '0')}`;
            } catch (error) {
                console.error('Error getting next NB number:', error);
                // Fallback: generate based on timestamp
                return `NB${String(Date.now()).slice(-6)}`;
            }
        }
        
        async function searchUplineDistributor() {
            const input = document.getElementById('uplineIdNo');
            const resultsDiv = document.getElementById('uplineSearchResults');
            if (!input || !resultsDiv) return;
            
            const searchTerm = input.value.trim().toUpperCase();
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/distributors?search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Search failed');
                
                const distributors = await response.json();
                const filtered = distributors.filter(d => {
                    const code = (d.distributor_code || d.distributorCode || '').toUpperCase();
                    const name = (d.distributor_name || d.distributorName || '').toUpperCase();
                    return code.includes(searchTerm) || name.includes(searchTerm);
                }).slice(0, 5);
                
                if (filtered.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }
                
                resultsDiv.innerHTML = filtered.map(dist => {
                    const code = dist.distributor_code || dist.distributorCode || '';
                    const name = dist.distributor_name || dist.distributorName || '';
                    return `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectUplineDistributor('${code}', '${name.replace(/'/g, "\\'")}')">${code} - ${name}</div>`;
                }).join('');
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Error searching upline:', error);
                resultsDiv.style.display = 'none';
            }
        }
        
        function selectUplineDistributor(code, name) {
            document.getElementById('uplineIdNo').value = code;
            document.getElementById('uplineName').value = name;
            document.getElementById('uplineSearchResults').style.display = 'none';
        }
        
        async function searchSponsorDistributor() {
            const input = document.getElementById('sponsorIdNo');
            const resultsDiv = document.getElementById('sponsorSearchResults');
            if (!input || !resultsDiv) return;
            
            const searchTerm = input.value.trim().toUpperCase();
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/distributors?search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Search failed');
                
                const distributors = await response.json();
                const filtered = distributors.filter(d => {
                    const code = (d.distributor_code || d.distributorCode || '').toUpperCase();
                    const name = (d.distributor_name || d.distributorName || '').toUpperCase();
                    return code.includes(searchTerm) || name.includes(searchTerm);
                }).slice(0, 5);
                
                if (filtered.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }
                
                resultsDiv.innerHTML = filtered.map(dist => {
                    const code = dist.distributor_code || dist.distributorCode || '';
                    const name = dist.distributor_name || dist.distributorName || '';
                    return `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectSponsorDistributor('${code}', '${name.replace(/'/g, "\\'")}')">${code} - ${name}</div>`;
                }).join('');
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Error searching sponsor:', error);
                resultsDiv.style.display = 'none';
            }
        }
        
        function selectSponsorDistributor(code, name) {
            document.getElementById('sponsorIdNo').value = code;
            document.getElementById('sponsorName').value = name;
            document.getElementById('sponsorSearchResults').style.display = 'none';
        }
        
        async function submitDistributorAgreement(event) {
            event.preventDefault();
            const statusDiv = document.getElementById('distributorAgreementStatus');
            statusDiv.innerHTML = '<p style="color: #f39c12;">â³ Processing registration...</p>';
            
            try {
                // Get form data
                const formData = {
                    distributor_name: document.getElementById('distributorName').value.trim(),
                    birthdate: document.getElementById('distributorBirthdate').value,
                    age: parseInt(document.getElementById('distributorAge').value) || null,
                    sex: document.getElementById('distributorSex').value,
                    nationality: document.getElementById('distributorNationality').value.trim(),
                    mobile_no: document.getElementById('distributorMobile').value.trim(),
                    residence_phone: document.getElementById('distributorResidencePhone').value.trim() || null,
                    office_phone: document.getElementById('distributorOfficePhone').value.trim() || null,
                    email: document.getElementById('distributorEmail').value.trim() || null,
                    address1: document.getElementById('distributorAddress1').value.trim(),
                    city: document.getElementById('distributorCity').value.trim(),
                    zip_code: document.getElementById('distributorZipCode').value.trim() || null,
                    tax_id: document.getElementById('distributorTaxId').value.trim() || null,
                    sss_no: document.getElementById('distributorSSS').value.trim() || null,
                    beneficiary: document.getElementById('distributorBeneficiary').value.trim() || null,
                    upline_name: document.getElementById('uplineName').value.trim() || null,
                    upline_id_no: document.getElementById('uplineIdNo').value.trim() || null,
                    upline_address: document.getElementById('uplineAddress').value.trim() || null,
                    upline_city: document.getElementById('uplineCity').value.trim() || null,
                    upline_mobile: document.getElementById('uplineMobile').value.trim() || null,
                    upline_zip_code: document.getElementById('uplineZipCode').value.trim() || null,
                    sponsor_name: document.getElementById('sponsorName').value.trim() || null,
                    sponsor_id_no: document.getElementById('sponsorIdNo').value.trim() || null,
                    agreement_date: document.getElementById('agreementDate').value,
                    applicant_signature: document.getElementById('applicantSignature').value.trim(),
                    date_received: document.getElementById('dateReceived').value || null,
                    received_by: document.getElementById('receivedBy').value.trim() || null,
                    processed_by: document.getElementById('processedBy').value.trim() || null
                };
                
                // Get materials received
                const materials = [];
                document.querySelectorAll('input[name="materials"]:checked').forEach(cb => {
                    if (cb.value === 'others') {
                        const othersText = document.getElementById('materialsOthers').value.trim();
                        if (othersText) materials.push(`Others: ${othersText}`);
                    } else {
                        materials.push(cb.value);
                    }
                });
                
                // Generate next NB number
                const nbNumber = await getNextNBNumber();
                formData.distributor_code = nbNumber;
                
                // Set assigned distributor ID
                document.getElementById('assignedDistributorId').value = nbNumber;
                
                // Get selected registration kit
                const selectedKit = document.querySelector('input[name="registrationKit"]:checked');
                if (!selectedKit) {
                    throw new Error('Please select a registration kit');
                }
                
                const kitType = selectedKit.value;
                const kitProduct = kitType === 'fert' 
                    ? { description: "REGISTRATION KIT WITH FERT,COFFEE & RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150 }
                    : { description: "REGISTRATION KIT WITH ALFALFA,COFFEE&RI(PERMANENT)", dp: 1200, cp: 1200, bv: 150 };
                
                // Save to database via API
                const response = await fetch('/api/distributors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        distributor_code: nbNumber,
                        distributor_name: formData.distributor_name,
                        mobile_no: formData.mobile_no,
                        email: formData.email,
                        commission_rate: 0,
                        status: 'active',
                        branch: window.currentUser?.branch || null
                    })
                });
                
                if (!response.ok) {
                    // Check if response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    let errorMessage = 'Failed to register distributor';
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const error = await response.json();
                            errorMessage = error.error || error.message || errorMessage;
                        } catch (e) {
                            // If JSON parsing fails, use status text
                            errorMessage = response.statusText || errorMessage;
                        }
                    } else {
                        // Non-JSON response (likely HTML error page)
                        const text = await response.text();
                        errorMessage = `Server error (${response.status}): ${text.substring(0, 100)}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                let newDistributor;
                try {
                    newDistributor = await response.json();
                } catch (e) {
                    throw new Error('Invalid response from server. Please try again.');
                }
                
                // Also save to local storage for immediate access
                if (typeof loadDistributors === 'function') {
                    await loadDistributors();
                    if (typeof distributors !== 'undefined') {
                        distributors.push({
                            id: newDistributor.id || `DIST-${Date.now()}`,
                            distributorCode: nbNumber,
                            distributorName: formData.distributor_name,
                            mobileNo: formData.mobile_no,
                            email: formData.email
                        });
                        if (typeof saveDistributors === 'function') {
                            await saveDistributors();
                        }
                    }
                }
                
                // Create registration kit sale and deduct stock
                try {
                    await createRegistrationKitSale(nbNumber, formData.distributor_name, formData.mobile_no, kitProduct);
                } catch (saleError) {
                    console.error('Error creating registration kit sale:', saleError);
                    // Continue even if sale creation fails - distributor is already registered
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; color: #856404; margin-bottom: 15px;">
                            <p><strong>âš ï¸ Warning:</strong> Distributor registered but registration kit sale failed. Please manually process the kit sale.</p>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; color: #155724;">
                        <h4 style="margin-top: 0; color: #155724;">âœ… Distributor Registered Successfully!</h4>
                        <p><strong>Distributor ID:</strong> ${nbNumber}</p>
                        <p><strong>Name:</strong> ${formData.distributor_name}</p>
                        <p style="margin-top: 10px;">The distributor has been added to the system and can now be used in sales and other operations.</p>
                    </div>
                `;
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    resetDistributorAgreementForm();
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting distributor agreement:', error);
                statusDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                        <h4 style="margin-top: 0; color: #721c24;">âŒ Registration Failed</h4>
                        <p>${error.message || 'An error occurred while registering the distributor. Please try again.'}</p>
                    </div>
                `;
            }
        }
        
        function resetDistributorAgreementForm() {
            document.getElementById('distributorAgreementForm').reset();
            document.getElementById('distributorAgreementStatus').innerHTML = '';
            initializeDistributorAgreementForm();
        }
        
        async function generateAndEmailDistributorPDF(formData, nbNumber, materials, kitProduct) {
            try {
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font and colors
                doc.setFontSize(16);
                doc.setTextColor(196, 30, 58); // Dynapharm red
                doc.text('DYNAPHARM INTERNATIONAL NAMIBIA', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Distributor Agreement Form', 105, 30, { align: 'center' });
                
                let yPos = 45;
                doc.setFontSize(10);
                
                // Distributor's Data Section
                doc.setFontSize(12);
                doc.setTextColor(196, 30, 58);
                doc.text('Distributor\'s Data', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Distributor ID: ${nbNumber}`, 14, yPos);
                yPos += 6;
                doc.text(`Name: ${formData.distributor_name}`, 14, yPos);
                yPos += 6;
                doc.text(`Birthdate: ${formData.birthdate || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Age: ${formData.age || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Sex: ${formData.sex || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Nationality: ${formData.nationality || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Mobile: ${formData.mobile_no || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.residence_phone) {
                    doc.text(`Residence Phone: ${formData.residence_phone}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.office_phone) {
                    doc.text(`Office Phone: ${formData.office_phone}`, 14, yPos);
                    yPos += 6;
                }
                doc.text(`Email: ${formData.email || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Address: ${formData.address1 || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`City: ${formData.city || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.zip_code) {
                    doc.text(`Zip Code: ${formData.zip_code}`, 14, yPos);
                    yPos += 6;
                }
                
                // Check if we need a new page
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Upline and Sponsor Data
                if (formData.upline_name || formData.sponsor_name) {
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Upline & Sponsor Information', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    if (formData.upline_name) {
                        doc.text(`Upline: ${formData.upline_name} (${formData.upline_id_no || 'N/A'})`, 14, yPos);
                        yPos += 6;
                    }
                    if (formData.sponsor_name) {
                        doc.text(`Sponsor: ${formData.sponsor_name} (${formData.sponsor_id_no || 'N/A'})`, 14, yPos);
                        yPos += 6;
                    }
                }
                
                // Registration Kit
                if (kitProduct) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Registration Kit', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Kit: ${kitProduct.description}`, 14, yPos);
                    yPos += 6;
                    doc.text(`Price: N$ ${kitProduct.cp.toFixed(2)}`, 14, yPos);
                    yPos += 6;
                }
                
                // Materials Received
                if (materials && materials.length > 0) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(196, 30, 58);
                    doc.text('Materials Received', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    materials.forEach(mat => {
                        doc.text(`â€¢ ${mat}`, 14, yPos);
                        yPos += 6;
                    });
                }
                
                // Agreement Date and Signature
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFontSize(12);
                doc.setTextColor(196, 30, 58);
                doc.text('Agreement Details', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Agreement Date: ${formData.agreement_date || 'N/A'}`, 14, yPos);
                yPos += 6;
                doc.text(`Applicant Signature: ${formData.applicant_signature || 'N/A'}`, 14, yPos);
                yPos += 6;
                if (formData.date_received) {
                    doc.text(`Date Received: ${formData.date_received}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.received_by) {
                    doc.text(`Received By: ${formData.received_by}`, 14, yPos);
                    yPos += 6;
                }
                if (formData.processed_by) {
                    doc.text(`Processed By: ${formData.processed_by}`, 14, yPos);
                }
                
                // Save PDF
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Download PDF
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = `Distributor_Agreement_${nbNumber}_${Date.now()}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Send email via API or mailto link
                const openEmailClient = (formData, nbNumber) => {
                    const subject = encodeURIComponent(`Distributor Registration Confirmation - ${nbNumber}`);
                    const body = encodeURIComponent(`Dear ${formData.distributor_name},\n\nYour distributor registration has been successfully processed.\n\nDistributor ID: ${nbNumber}\n\nPlease find attached your Distributor Agreement Form (downloaded automatically).\n\nThank you for joining Dynapharm International Namibia.\n\nBest regards,\nDynapharm Team`);
                    const mailtoLink = `mailto:${formData.email}?subject=${subject}&body=${body}`;
                    window.open(mailtoLink);
                    alert(`âœ… PDF generated and downloaded. Email client opened. Please attach the PDF file to the email.`);
                };
                
                try {
                    // Convert PDF blob to base64 for API
                    const reader = new FileReader();
                    reader.onloadend = async function() {
                        const base64Pdf = reader.result.split(',')[1];
                        
                        try {
                            // Try to send via API if available
                            const emailResponse = await fetch('/api/send-email', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    to: formData.email,
                                    subject: `Distributor Registration Confirmation - ${nbNumber}`,
                                    body: `Dear ${formData.distributor_name},\n\nYour distributor registration has been successfully processed.\n\nDistributor ID: ${nbNumber}\n\nPlease find attached your Distributor Agreement Form.\n\nThank you for joining Dynapharm International Namibia.\n\nBest regards,\nDynapharm Team`,
                                    attachment: base64Pdf,
                                    attachmentName: `Distributor_Agreement_${nbNumber}.pdf`
                                })
                            });
                            
                            if (emailResponse.ok) {
                                alert(`âœ… PDF generated and email sent to ${formData.email}`);
                            } else {
                                // Fallback to mailto link
                                openEmailClient(formData, nbNumber);
                            }
                        } catch (apiError) {
                            // Fallback to mailto link
                            openEmailClient(formData, nbNumber);
                        }
                    };
                    reader.readAsDataURL(pdfBlob);
                } catch (emailError) {
                    // Fallback: Open email client with mailto link
                    openEmailClient(formData, nbNumber);
                }
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }
        
        async function createRegistrationKitSale(distributorId, distributorName, mobileNo, kitProduct) {
            const now = new Date();
            const saleDate = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Create cart item for the kit
            const cartItem = {
                name: kitProduct.description,
                quantity: 1,
                dp: kitProduct.dp,
                cp: kitProduct.cp,
                bv: kitProduct.bv,
                price: kitProduct.cp // Use CP for distributor registration
            };
            
            // Create sale record
            const sale = {
                id: 'REG-' + Date.now(),
                clientId: distributorId,
                clientReferenceNumber: distributorId,
                customerName: distributorName,
                phone: mobileNo || '',
                email: '',
                customerType: 'distributor',
                distributorReferral: {
                    name: distributorName,
                    id: distributorId
                },
                products: [cartItem],
                subtotal: kitProduct.cp,
                tax: 0,
                total: kitProduct.cp,
                totalAmount: kitProduct.cp,
                totalBV: kitProduct.bv,
                date: saleDate,
                timestamp: now.toISOString(),
                soldBy: window.currentUser ? window.currentUser.fullName : 'System',
                branch: window.currentUser ? window.currentUser.branch : 'unknown',
                paymentMethod: 'registration',
                saleType: 'registration',
                registrationSale: true
            };
            
            // Deduct stock using FEFO or legacy method
            try {
                const branchId = (window.currentUser && window.currentUser.branch) || 'unknown_branch';
                const userName = (window.currentUser && window.currentUser.fullName) || 'system';
                
                // Try FEFO first
                if (typeof fefoDispenseProducts === 'function') {
                    const fefo = await fefoDispenseProducts(
                        [{ name: kitProduct.description, quantity: 1 }], 
                        branchId, 
                        userName, 
                        sale.id
                    );
                    if (!fefo.success) {
                        console.warn('FEFO stock issues:', fefo.errors);
                        // Fall back to legacy method
                        if (typeof reduceInventoryForProducts === 'function') {
                            const invReduction = reduceInventoryForProducts([cartItem], userName, sale.id);
                            if (!invReduction.success) {
                                throw new Error('Stock deduction failed: ' + invReduction.errors.join(', '));
                            }
                        }
                    }
                } else if (typeof reduceInventoryForProducts === 'function') {
                    // Use legacy method
                    const invReduction = reduceInventoryForProducts([cartItem], userName, sale.id);
                    if (!invReduction.success) {
                        throw new Error('Stock deduction failed: ' + invReduction.errors.join(', '));
                    }
                }
            } catch (stockError) {
                console.error('Error deducting stock:', stockError);
                throw new Error('Failed to deduct registration kit from stock: ' + stockError.message);
            }
            
            // Record department event
            if (typeof recordDepartmentEvent === 'function') {
                recordDepartmentEvent('registration_sale', sale);
            }
            
            // Broadcast stock update event
            try {
                const branchId = (window.currentUser && window.currentUser.branch) || 'unknown';
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: branchId, products: [cartItem], user: (window.currentUser && window.currentUser.fullName) || 'system', reference: sale.id } 
                }));
                window.dispatchEvent(new CustomEvent('sale:updated', { detail: { sale, type: 'registration' } }));
                
                // Publish to Railway gateway if available
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products: [cartItem], sale: sale.id, ts: Date.now() } })
                    }).catch(_ => {});
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'sale:updated', sale, type: 'registration', ts: Date.now() } })
                    }).catch(_ => {});
                }
                
                // Publish to Vercel SSE
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products: [cartItem], ts: Date.now() } }) 
                }).catch(_ => {});
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'sales', event: { sale, type: 'registration', ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}
            
            // Save sale to localStorage
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            walkInSales.push(sale);
            localStorage.setItem('dyna_walkin_sales', JSON.stringify(walkInSales));
            
            // Also save to finance portal key
            const financeSales = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            financeSales.push(sale);
            localStorage.setItem('dynapharm_walkin_sales', JSON.stringify(financeSales));
            
            // Update cash drawer
            const cashDrawer = JSON.parse(localStorage.getItem('dyna_cash_drawer') || '{}');
            if (!cashDrawer.totalSales) cashDrawer.totalSales = [];
            cashDrawer.totalSales.push({
                type: 'registration',
                amount: kitProduct.cp,
                timestamp: sale.timestamp
            });
            localStorage.setItem('dyna_cash_drawer', JSON.stringify(cashDrawer));
            
            // Try to save via API
            try {
                if (typeof apiRequest === 'function') {
                    await apiRequest('/orders', 'POST', sale);
                } else {
                    await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sale)
                    });
                }
            } catch (apiError) {
                console.warn('Failed to save registration sale via API:', apiError);
                // Continue - sale is saved locally
            }
            
            console.log('âœ… Registration kit sale created:', sale.id);
            return sale;
        }

        // ========== Dispenser Bonus Tab ==========
        function initializeDispenserBonusTab() {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const m = document.getElementById('dispenserBonusMonth');
            if (m && !m.value) {
                const today = new Date();
                m.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            renderDispenserPendingBonuses();
        }

        // Field Program Functions
        async function displayFieldProgramRequests() {
            const listEl = document.getElementById('fieldProgramRequestsList');
            if (!listEl) return;
            
            try {
                const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
                if (requests.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No stock requests yet. Click "New Stock Request" to create one.</p>';
                    return;
                }
                
                // Sort by date (newest first)
                requests.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                
                listEl.innerHTML = requests.map((req, idx) => `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0;">Request #${req.id || req.requestNumber || idx + 1}</h4>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;"><strong>Distributor:</strong> ${req.distributorName || 'N/A'} (${req.distributorCode || 'N/A'})</p>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;"><strong>Branch:</strong> ${req.branch || 'N/A'} | <strong>Date:</strong> ${new Date(req.date || Date.now()).toLocaleDateString()}</p>
                                ${req.signature ? `<p style="margin: 0; color: #666; font-size: 0.85rem;"><strong>Signed:</strong> ${req.signature}</p>` : ''}
                            </div>
                            <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; background: ${req.status === 'approved' ? '#d4edda' : req.status === 'rejected' ? '#f8d7da' : req.status === 'issued' ? '#cfe2ff' : '#fff3cd'}; color: ${req.status === 'approved' ? '#155724' : req.status === 'rejected' ? '#721c24' : req.status === 'issued' ? '#084298' : '#856404'};">${(req.status || 'pending').toUpperCase()}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <p><strong>Requested Items:</strong></p>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${(req.items || []).map(item => `<li>${item.product || 'N/A'}: ${item.quantity || 0} ${item.unit || 'units'}</li>`).join('')}
                            </ul>
                            ${req.notes ? `<p style="margin-top: 10px;"><strong>Notes:</strong> ${req.notes}</p>` : ''}
                            ${req.approvedBy ? `<p style="margin-top: 5px; color: #0f5132; font-size: 0.85rem;"><strong>Approved by:</strong> ${req.approvedBy} on ${new Date(req.approvedAt).toLocaleDateString()}</p>` : ''}
                            ${req.issuedBy ? `<p style="margin-top: 5px; color: #084298; font-size: 0.85rem;"><strong>Issued by:</strong> ${req.issuedBy} on ${new Date(req.issuedAt).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="printFieldProgramRequestPDF('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ–¨ï¸ Print PDF</button>
                            ${req.status === 'pending' ? `
                                <button class="btn btn-success" onclick="approveFieldProgramRequest('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">Approve</button>
                                <button class="btn btn-danger" onclick="rejectFieldProgramRequest('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">Reject</button>
                            ` : req.status === 'approved' ? `
                                <button class="btn btn-primary" onclick="issueFieldProgramStock('${req.id || idx}')" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“¦ Issue Stock (FEFO)</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading field program requests:', error);
                listEl.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading requests. Please try again.</p>';
            }
        }

        async function openFieldProgramRequestForm() {
            const modal = document.getElementById('fieldProgramRequestModal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('fieldProgramRequestForm').reset();
            document.getElementById('fieldProgramDistributorInfo').style.display = 'none';
            document.getElementById('fieldProgramDistributorDropdown').style.display = 'none';
            
            // Set default date to today
            document.getElementById('fieldProgramRequestDate').value = new Date().toISOString().split('T')[0];
            
            // Load branches
            const branchSelect = document.getElementById('fieldProgramBranch');
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            if (typeof branches !== 'undefined' && Array.isArray(branches)) {
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id || branch.name;
                    option.textContent = branch.name;
                    branchSelect.appendChild(option);
                });
            }
            
            // Load products
            const productSelects = document.querySelectorAll('.field-program-product-select');
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Product</option>';
                if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                    PRICE_LIST.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.description;
                        option.textContent = product.description;
                        select.appendChild(option);
                    });
                }
            });
            
            modal.style.display = 'block';
        }

        function closeFieldProgramRequestForm() {
            document.getElementById('fieldProgramRequestModal').style.display = 'none';
        }

        function addFieldProgramProductRow() {
            const container = document.getElementById('fieldProgramProducts');
            const row = document.createElement('div');
            row.className = 'field-program-product-row';
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            row.innerHTML = `
                <div class="form-group">
                    <label>Product *</label>
                    <select class="field-program-product-select" required>
                        <option value="">Select Product</option>
                        ${typeof PRICE_LIST !== 'undefined' ? PRICE_LIST.map(p => `<option value="${p.description}">${p.description}</option>`).join('') : ''}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" class="field-program-quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" class="field-program-unit" placeholder="boxes, units, etc.">
                </div>
                <button type="button" class="btn btn-danger" onclick="removeFieldProgramProductRow(this)" style="padding: 8px 12px;">Remove</button>
            `;
            container.appendChild(row);
        }

        function removeFieldProgramProductRow(button) {
            const rows = document.querySelectorAll('.field-program-product-row');
            if (rows.length > 1) {
                button.closest('.field-program-product-row').remove();
            } else {
                alert('At least one product row is required.');
            }
        }

        async function searchFieldProgramDistributor() {
            const searchInput = document.getElementById('fieldProgramDistributorSearch');
            const dropdown = document.getElementById('fieldProgramDistributorDropdown');
            const query = searchInput.value.trim().toUpperCase();
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            try {
                // Try to load distributors from API
                let distributors = [];
                try {
                    const response = await fetch('/api/distributors');
                    if (response.ok) {
                        distributors = await response.json();
                    }
                } catch (e) {
                    console.debug('API not available, trying localStorage');
                }
                
                // Fallback to localStorage
                if (distributors.length === 0) {
                    const stored = localStorage.getItem('dyna_distributors') || localStorage.getItem('dyna_distributors_cache');
                    if (stored) {
                        const data = JSON.parse(stored);
                        distributors = Array.isArray(data) ? data : (data.data || []);
                    }
                }
                
                // Filter distributors
                const matches = distributors.filter(d => {
                    const code = (d.distributorCode || d.code || d.distributor_code || '').toString().toUpperCase();
                    const name = (d.distributorName || d.name || d.distributor_name || '').toString().toUpperCase();
                    return code.includes(query) || name.includes(query);
                }).slice(0, 10);
                
                if (matches.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 10px; color: #666;">No distributors found</div>';
                } else {
                    dropdown.innerHTML = matches.map(d => {
                        const code = d.distributorCode || d.code || d.distributor_code || 'N/A';
                        const name = d.distributorName || d.name || d.distributor_name || 'N/A';
                        return `<div onclick="selectFieldProgramDistributor('${code}', '${name.replace(/'/g, "\\'")}', '${d.mobileNo || d.mobile || d.mobile_no || ''}', '${d.id || code}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">${code} - ${name}</div>`;
                    }).join('');
                }
                dropdown.style.display = 'block';
            } catch (error) {
                console.error('Error searching distributors:', error);
                dropdown.style.display = 'none';
            }
        }

        function selectFieldProgramDistributor(code, name, mobile, id) {
            document.getElementById('fieldProgramDistributorSearch').value = `${code} - ${name}`;
            document.getElementById('fieldProgramDistributorId').value = id;
            document.getElementById('fieldProgramDistributorCode').textContent = code;
            document.getElementById('fieldProgramDistributorName').textContent = name;
            document.getElementById('fieldProgramDistributorMobile').textContent = mobile;
            document.getElementById('fieldProgramDistributorInfo').style.display = 'block';
            document.getElementById('fieldProgramDistributorDropdown').style.display = 'none';
        }

        function submitFieldProgramRequest(event) {
            event.preventDefault();
            
            const distributorId = document.getElementById('fieldProgramDistributorId').value;
            if (!distributorId) {
                alert('Please select a distributor');
                return;
            }
            
            // Collect product items
            const productRows = document.querySelectorAll('.field-program-product-row');
            const items = [];
            let hasError = false;
            
            productRows.forEach(row => {
                const product = row.querySelector('.field-program-product-select').value;
                const quantity = parseInt(row.querySelector('.field-program-quantity').value);
                const unit = row.querySelector('.field-program-unit').value || 'units';
                
                if (!product || !quantity) {
                    hasError = true;
                    return;
                }
                
                items.push({ product, quantity, unit });
            });
            
            if (hasError || items.length === 0) {
                alert('Please add at least one product with quantity');
                return;
            }
            
            // Create request object
            const request = {
                id: 'FPR' + Date.now(),
                requestNumber: 'FPR-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6),
                distributorId: distributorId,
                distributorCode: document.getElementById('fieldProgramDistributorCode').textContent,
                distributorName: document.getElementById('fieldProgramDistributorName').textContent,
                distributorMobile: document.getElementById('fieldProgramDistributorMobile').textContent,
                date: document.getElementById('fieldProgramRequestDate').value,
                branch: document.getElementById('fieldProgramBranch').value,
                items: items,
                notes: document.getElementById('fieldProgramNotes').value,
                signature: document.getElementById('fieldProgramSignature').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage
            try {
                const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
                requests.push(request);
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                
                // Also save to API if available
                try {
                    fetch('/api/field_program_requests', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    }).catch(e => console.debug('API save failed:', e));
                } catch (e) {}
                
                alert('âœ… Stock request submitted successfully!');
                closeFieldProgramRequestForm();
                displayFieldProgramRequests();
            } catch (error) {
                console.error('Error saving request:', error);
                alert('âŒ Error saving request. Please try again.');
            }
        }

        function refreshFieldProgramRequests() {
            displayFieldProgramRequests();
        }

        function approveFieldProgramRequest(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (request && request.status === 'pending') {
                request.status = 'approved';
                request.approvedBy = (window.currentUser && window.currentUser.fullName) || 'System';
                request.approvedAt = new Date().toISOString();
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                displayFieldProgramRequests();
                alert('âœ… Request approved! You can now issue stock using FEFO.');
            }
        }

        function rejectFieldProgramRequest(requestId) {
            if (!confirm('Are you sure you want to reject this request?')) return;
            
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (request) {
                request.status = 'rejected';
                request.rejectedBy = (window.currentUser && window.currentUser.fullName) || 'System';
                request.rejectedAt = new Date().toISOString();
                localStorage.setItem('field_program_requests', JSON.stringify(requests));
                displayFieldProgramRequests();
            }
        }

        function issueFieldProgramStock(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (!request || request.status !== 'approved') {
                alert('Request not found or not approved');
                return;
            }
            
            // Open issuing modal with FEFO interface
            openFieldProgramIssuingModal(request);
        }

        function openFieldProgramIssuingModal(request) {
            const modal = document.getElementById('fieldProgramIssuingModal');
            const content = document.getElementById('fieldProgramIssuingContent');
            
            if (!modal || !content) return;
            
            content.innerHTML = `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #856404;">âš ï¸ FEFO Compliance Required</h3>
                    <p style="margin: 0; color: #856404;">Stock must be issued following First Expired First Out (FEFO) principles. Scan barcode for each item to record batch/expiry data.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Request Details</h4>
                    <p><strong>Distributor:</strong> ${request.distributorName} (${request.distributorCode})</p>
                    <p><strong>Branch:</strong> ${request.branch}</p>
                    <p><strong>Request Date:</strong> ${new Date(request.date).toLocaleDateString()}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Items to Issue (Scan Barcode for Each)</h4>
                    <div id="fieldProgramIssuingItems">
                        ${request.items.map((item, idx) => `
                            <div class="issuing-item" data-product="${item.product}" data-requested-qty="${item.quantity}" style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0;">${item.product}</h5>
                                <p><strong>Requested:</strong> ${item.quantity} ${item.unit || 'units'}</p>
                                <div style="margin-top: 10px;">
                                    <label>Scan Barcode or Enter Batch Number:</label>
                                    <input type="text" class="barcode-input" placeholder="Scan barcode or enter batch" 
                                           onchange="handleFieldProgramBarcodeScan(this, '${item.product}', ${item.quantity})" 
                                           style="width: 100%; padding: 8px; margin-top: 5px;">
                                </div>
                                <div class="scanned-items" style="margin-top: 10px;">
                                    <p><strong>Scanned Items:</strong> <span class="scanned-count">0</span> / ${item.quantity}</p>
                                    <div class="scanned-list" style="max-height: 150px; overflow-y: auto; margin-top: 5px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="completeFieldProgramIssuing('${request.id}')" style="flex: 1;">âœ… Complete Issuing</button>
                    <button class="btn btn-secondary" onclick="closeFieldProgramIssuing()">Cancel</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function handleFieldProgramBarcodeScan(input, productName, requestedQty) {
            const barcode = input.value.trim();
            if (!barcode) return;
            
            const itemDiv = input.closest('.issuing-item');
            const scannedList = itemDiv.querySelector('.scanned-list');
            const scannedCount = itemDiv.querySelector('.scanned-count');
            const currentScanned = parseInt(scannedCount.textContent) || 0;
            
            if (currentScanned >= requestedQty) {
                alert('Requested quantity already scanned');
                input.value = '';
                return;
            }
            
            // Try to get stock data (this would typically come from stock management system)
            // For now, create a record with barcode data
            const scannedItem = {
                barcode: barcode,
                product: productName,
                scannedAt: new Date().toISOString(),
                scannedBy: (window.currentUser && window.currentUser.fullName) || 'System'
            };
            
            // Add to scanned list
            const itemElement = document.createElement('div');
            itemElement.style.cssText = 'padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem;';
            itemElement.innerHTML = `
                <strong>Barcode:</strong> ${barcode}<br>
                <small>Scanned: ${new Date().toLocaleString()}</small>
                <button onclick="removeScannedItem(this)" style="float: right; padding: 2px 8px; font-size: 0.8rem;">Remove</button>
            `;
            itemElement.dataset.barcode = barcode;
            scannedList.appendChild(itemElement);
            
            scannedCount.textContent = currentScanned + 1;
            input.value = '';
            
            // Store scanned items in data attribute
            if (!itemDiv.dataset.scannedItems) {
                itemDiv.dataset.scannedItems = JSON.stringify([]);
            }
            const scannedItems = JSON.parse(itemDiv.dataset.scannedItems);
            scannedItems.push(scannedItem);
            itemDiv.dataset.scannedItems = JSON.stringify(scannedItems);
        }

        function removeScannedItem(button) {
            const itemElement = button.closest('div');
            const itemDiv = itemElement.closest('.issuing-item');
            const scannedCount = itemDiv.querySelector('.scanned-count');
            const currentCount = parseInt(scannedCount.textContent) || 0;
            
            // Remove from data
            const scannedItems = JSON.parse(itemDiv.dataset.scannedItems || '[]');
            const barcode = itemElement.dataset.barcode;
            const filtered = scannedItems.filter(item => item.barcode !== barcode);
            itemDiv.dataset.scannedItems = JSON.stringify(filtered);
            
            itemElement.remove();
            scannedCount.textContent = Math.max(0, currentCount - 1);
        }

        function completeFieldProgramIssuing(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                alert('Request not found');
                return;
            }
            
            // Collect all scanned items
            const issuingItems = document.querySelectorAll('.issuing-item');
            const issuedItems = [];
            let allComplete = true;
            
            issuingItems.forEach(itemDiv => {
                const product = itemDiv.dataset.product;
                const requestedQty = parseInt(itemDiv.dataset.requestedQty);
                const scannedCount = parseInt(itemDiv.querySelector('.scanned-count').textContent) || 0;
                const scannedItems = JSON.parse(itemDiv.dataset.scannedItems || '[]');
                
                if (scannedCount < requestedQty) {
                    allComplete = false;
                }
                
                issuedItems.push({
                    product: product,
                    requestedQty: requestedQty,
                    issuedQty: scannedCount,
                    scannedItems: scannedItems
                });
            });
            
            if (!allComplete) {
                if (!confirm('Not all items have been fully scanned. Continue anyway?')) {
                    return;
                }
            }
            
            // Update request
            request.status = 'issued';
            request.issuedBy = (window.currentUser && window.currentUser.fullName) || 'System';
            request.issuedAt = new Date().toISOString();
            request.issuedItems = issuedItems;
            
            // Save
            localStorage.setItem('field_program_requests', JSON.stringify(requests));
            
            // Record in stock audit
            try {
                const audit = JSON.parse(localStorage.getItem('dyna_stock_audit') || '[]');
                audit.push({
                    id: 'AUD' + Date.now(),
                    action: 'field_program_issue',
                    details: {
                        requestId: request.id,
                        requestNumber: request.requestNumber,
                        distributor: request.distributorCode,
                        branch: request.branch,
                        items: issuedItems
                    },
                    timestamp: new Date().toISOString(),
                    user: (window.currentUser && window.currentUser.fullName) || 'System'
                });
                localStorage.setItem('dyna_stock_audit', JSON.stringify(JSON.stringify(audit).length > 50000 ? audit.slice(-1000) : audit));
            } catch (e) {
                console.error('Error saving audit:', e);
            }
            
            alert('âœ… Stock issued successfully with FEFO compliance!');
            closeFieldProgramIssuing();
            displayFieldProgramRequests();
        }

        function closeFieldProgramIssuing() {
            document.getElementById('fieldProgramIssuingModal').style.display = 'none';
        }

        function printFieldProgramRequestPDF(requestId) {
            const requests = JSON.parse(localStorage.getItem('field_program_requests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === String(requestId));
            
            if (!request) {
                alert('Request not found');
                return;
            }
            
            // Create PDF content
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add logo and header
            doc.setFillColor(196, 30, 58); // Dynapharm red
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('DYNAPHARM NAMIBIA', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Field Program Stock Request', 105, 22, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            let yPos = 40;
            
            // Request Details
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Request Details', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Request Number: ${request.requestNumber || request.id}`, 10, yPos);
            yPos += 6;
            doc.text(`Date: ${new Date(request.date).toLocaleDateString()}`, 10, yPos);
            yPos += 6;
            doc.text(`Branch: ${request.branch}`, 10, yPos);
            yPos += 10;
            
            // Distributor Information
            doc.setFont('helvetica', 'bold');
            doc.text('Distributor Information', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Name: ${request.distributorName}`, 10, yPos);
            yPos += 6;
            doc.text(`NB Number: ${request.distributorCode}`, 10, yPos);
            yPos += 6;
            doc.text(`Mobile: ${request.distributorMobile}`, 10, yPos);
            yPos += 10;
            
            // Requested Items
            doc.setFont('helvetica', 'bold');
            doc.text('Requested Items', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            request.items.forEach((item, idx) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(`${idx + 1}. ${item.product} - ${item.quantity} ${item.unit || 'units'}`, 15, yPos);
                yPos += 6;
            });
            yPos += 5;
            
            // Notes
            if (request.notes) {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Notes:', 10, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                const notesLines = doc.splitTextToSize(request.notes, 190);
                doc.text(notesLines, 10, yPos);
                yPos += notesLines.length * 6 + 5;
            }
            
            // Terms and Conditions
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('Terms and Conditions of Stock Handling Commitment', 10, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const terms = [
                '1. Stock Accountability: The distributor is fully responsible for all stock received.',
                '2. FEFO Compliance: Stock will be issued following First Expired First Out principles.',
                '3. Storage Requirements: Stock must be stored in appropriate conditions.',
                '4. Damage/Loss Reporting: Any damaged or lost stock must be reported immediately.',
                '5. Return Policy: Unused stock may be returned within 30 days if in original condition.',
                '6. Sales Records: Complete sales records must be maintained and submitted.',
                '7. Payment Terms: Payment for stock must be made according to agreed terms.',
                '8. Compliance: All stock must be used/sold in compliance with Dynapharm policies.'
            ];
            
            terms.forEach(term => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                const lines = doc.splitTextToSize(term, 190);
                doc.text(lines, 10, yPos);
                yPos += lines.length * 5 + 3;
            });
            
            // Signature
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('Distributor Signature:', 10, yPos);
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(request.signature || 'N/A', 10, yPos);
            yPos += 10;
            doc.line(10, yPos, 80, yPos);
            doc.setFontSize(8);
            doc.text('Signature', 10, yPos + 5);
            
            // Status
            if (request.status) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(196, 30, 58);
                doc.text(`Status: ${request.status.toUpperCase()}`, 150, yPos - 10);
                if (request.approvedBy) {
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Approved by: ${request.approvedBy}`, 150, yPos - 5);
                    doc.text(`Date: ${new Date(request.approvedAt).toLocaleDateString()}`, 150, yPos);
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 105, 285, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 290, { align: 'center' });
            }
            
            // Save PDF
            doc.save(`FieldProgramRequest_${request.requestNumber || request.id}.pdf`);
        }

        function getUploadedBonusList() {
            try {
                const raw = localStorage.getItem('finance_bonus_list');
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (!data || !Array.isArray(data.items)) return null;
                return data; // { month, items }
            } catch(e) { return null; }
        }

        function sumPaidBonusFor(distributorNB, ym) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const ymStr = String(ym || '').slice(0,7);
            const toYm = (d) => String(d || '').slice(0,7);
            const cash = (Array.isArray(typeof cashBonuses !== 'undefined' ? cashBonuses : []) ? cashBonuses : []);
            const bank = (Array.isArray(typeof bankBonuses !== 'undefined' ? bankBonuses : []) ? bankBonuses : []);
            let total = 0;
            cash.forEach(b => {
                if (b?.distributorNB && b.distributorNB.trim() === distributorNB && toYm(b.date) === ymStr) total += Number(b.amount || 0);
            });
            bank.forEach(b => {
                if (b?.distributorNB && b.distributorNB.trim() === distributorNB && toYm(b.date) === ymStr) total += Number(b.amount || 0);
            });
            return total;
        }

        function renderDispenserPendingBonuses() {
            const listEl = document.getElementById('dispenserPendingBonusList');
            const summaryEl = document.getElementById('dispenserBonusSummary');
            if (!listEl) return;
            const monthInput = document.getElementById('dispenserBonusMonth');
            const search = (document.getElementById('dispenserBonusSearch')?.value || '').trim().toLowerCase();
            const ym = monthInput?.value || '';

            const upload = getUploadedBonusList();
            if (!upload || !Array.isArray(upload.items) || (upload.month && ym && upload.month !== ym)) {
                listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No uploaded bonus list for selected month</p>';
                if (summaryEl) summaryEl.textContent = '';
                return;
            }

            // Normalize items to { nb, name, branch, amount }
            const norm = upload.items.map(row => {
                const obj = (Array.isArray(row) ? {} : row) || {};
                // Try common keys
                const nb = (obj.NB || obj.DRN || obj.drn || obj.nb || obj.Id || obj.id || obj['Distributor NB'] || obj['Distributor'] || obj['DRN']).toString?.() || '';
                const name = (obj.NAME || obj.Name || obj.name || obj['Distributor Name'] || obj['Distributor']).toString?.() || '';
                const branch = (obj.Branch || obj.BRANCH || obj.branch || obj.Location || obj.location || '').toString?.() || '';
                // Amount: try several keys
                const amountRaw = obj.Amount ?? obj.AMOUNT ?? obj.amount ?? obj['Bonus'] ?? obj['BONUS'] ?? obj['Value'] ?? 0;
                const amount = Number(normalizeBonusAmount ? normalizeBonusAmount(amountRaw) : (parseFloat(String(amountRaw).replace(/[^0-9.\-]/g,'')) || 0));
                return { nb: String(nb).trim(), name: String(name).trim(), branch: String(branch).trim(), amount };
            }).filter(x => x.nb);

            let totalPending = 0;
            let totalCount = 0;

            const rows = norm
                .map(item => {
                    const paid = sumPaidBonusFor(item.nb, ym);
                    const outstanding = Math.max(0, Number(item.amount || 0) - Number(paid || 0));
                    return { ...item, paid, outstanding };
                })
                .filter(it => it.outstanding > 0)
                .filter(it => !search || it.nb.toLowerCase().includes(search) || it.name.toLowerCase().includes(search));

            rows.forEach(r => { totalPending += r.outstanding; totalCount++; });
            if (summaryEl) summaryEl.innerHTML = `Pending: <strong>${totalCount}</strong> distributors, Total Outstanding: <strong>N$ ${totalPending.toFixed(2)}</strong>`;

            if (rows.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No pending bonuses</p>';
                return;
            }

            listEl.innerHTML = rows.map(r => `
                <div class="client-card" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div>
                        <div style="font-weight: 700; color: #2c3e50;">${r.name}</div>
                        <div style="color: #7f8c8d; font-size: 0.9rem;">NB: ${r.nb} â€¢ Branch: ${r.branch || 'â€”'}</div>
                        <div style="margin-top: 6px; font-size: 0.9rem;">
                            Uploaded: <strong>N$ ${Number(r.amount).toFixed(2)}</strong> â€¢ Paid: <strong>N$ ${Number(r.paid).toFixed(2)}</strong> â€¢ Outstanding: <strong style="color:#c41e3a;">N$ ${Number(r.outstanding).toFixed(2)}</strong>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success" onclick="openDispenserBonusPayout('${r.nb}', '${r.name.replace(/'/g, "\'")}', '${r.branch.replace(/'/g, "\'")}', '${ym}', ${Number(r.outstanding).toFixed(2)})">ðŸ’µ Pay</button>
                        <button class="btn" onclick="showDistributorBonusHistory('${r.nb}')">ðŸ“œ History</button>
                    </div>
                </div>
            `).join('');
        }

        function openDispenserBonusPayout(nb, name, branch, ym, maxAmount) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'dispenserBonusPayoutModal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:520px;">
                    <span class="close" onclick="closeModal('dispenserBonusPayoutModal')">&times;</span>
                    <h2>ðŸŽ Record Bonus Payout</h2>
                    <div class="form-group"><label>Distributor</label><input type="text" value="${name} (${nb})" disabled></div>
                    <div class="form-group"><label>Month</label><input type="text" value="${ym}" disabled></div>
                    <div class="form-group"><label>Branch</label><input type="text" value="${branch || ''}" disabled></div>
                    <div class="form-group"><label>Amount (N$)</label><input type="number" id="dispenserBonusAmount" step="0.01" min="0.01" max="${Number(maxAmount).toFixed(2)}" value="${Number(maxAmount).toFixed(2)}"></div>
                    <div class="form-group"><label>Reason</label><input type="text" id="dispenserBonusReason" placeholder="Monthly bonus" value="Monthly bonus"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="recordDispenserBonusPayout('${nb}','${name.replace(/'/g, "\'")}', '${branch.replace(/'/g, "\'")}', '${ym}')">ðŸ’¾ Save & Print</button>
                        <button class="btn" onclick="closeModal('dispenserBonusPayoutModal')">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function recordDispenserBonusPayout(nb, name, branch, ym) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const amtEl = document.getElementById('dispenserBonusAmount');
            const reasonEl = document.getElementById('dispenserBonusReason');
            const amount = parseFloat(amtEl?.value || '0');
            if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }
            const today = new Date();
            const dateStr = `${ym}-01`;
            const payout = {
                id: 'BNS' + Date.now(),
                branch: branch || (currentUser?.branch || ''),
                distributorNB: nb,
                distributorName: name,
                date: dateStr,
                amount: amount,
                reason: reasonEl?.value || 'Monthly bonus',
                approvedBy: currentUser?.username || 'Dispenser',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'Dispenser',
                method: 'cash',
                source: 'dispenser'
            };
            if (!Array.isArray(cashBonuses)) { window.cashBonuses = []; }
            cashBonuses.push(payout);
            try { saveEnhancedFinanceData && saveEnhancedFinanceData(); } catch(e) {
                localStorage.setItem('finance_bonuses', JSON.stringify(cashBonuses));
            }
            try { refreshFinancialDashboard && refreshFinancialDashboard(); } catch(e) {}
            closeModal('dispenserBonusPayoutModal');
            renderDispenserPendingBonuses();
            openBonusReceiptWindow(payout, 'a4');
        }

        function showDistributorBonusHistory(nb) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const payouts = [];
            (Array.isArray(cashBonuses) ? cashBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Cash' }); });
            (Array.isArray(bankBonuses) ? bankBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Bank' }); });
            payouts.sort((a,b) => String(b.createdAt||b.date).localeCompare(String(a.createdAt||a.date)));

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'distributorBonusHistoryModal';
            modal.style.display = 'block';
            const name = payouts[0]?.distributorName || nb;
            modal.innerHTML = `
                <div class="modal-content" style="max-width:760px;">
                    <span class="close" onclick="closeModal('distributorBonusHistoryModal')">&times;</span>
                    <h2>ðŸ“œ Bonus History - ${name} (${nb})</h2>
                    <div style="max-height: 420px; overflow:auto; border:1px solid #eee; border-radius:8px;">
                        <table style="width:100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Date</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Amount</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Channel</th>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payouts.map(p => `
                                    <tr>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${(p.date||'').slice(0,10)}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">N$ ${Number(p.amount||0).toFixed(2)}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${p.channel}</td>
                                        <td style="padding:8px; border-bottom:1px solid #f3f3f3;">${p.reason||''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:12px; display:flex; gap:10px;">
                        <button class="btn" onclick="printDistributorBonusHistory('${nb}')">ðŸ–¨ï¸ Print PDF</button>
                        <button class="btn" onclick="closeModal('distributorBonusHistoryModal')">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printDistributorBonusHistory(nb) {
            try { loadEnhancedFinanceData && loadEnhancedFinanceData(); } catch(e) {}
            const payouts = [];
            (Array.isArray(cashBonuses) ? cashBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Cash' }); });
            (Array.isArray(bankBonuses) ? bankBonuses : []).forEach(p => { if (p.distributorNB === nb) payouts.push({ ...p, channel: 'Bank' }); });
            payouts.sort((a,b) => String(a.date).localeCompare(String(b.date)));
            const name = payouts[0]?.distributorName || nb;
            const win = window.open('', '_blank');
            const today = new Date().toISOString().slice(0,10);
            const rows = payouts.map(p => `
                <tr>
                    <td>${(p.date||'').slice(0,10)}</td>
                    <td>N$ ${Number(p.amount||0).toFixed(2)}</td>
                    <td>${p.channel}</td>
                    <td>${p.reason||''}</td>
                </tr>
            `).join('');
            win.document.write(`
                <html><head><title>Bonus History - ${name}</title>
                <style>@media print {@page { size: A4; margin: 16mm; }} body{font-family:Arial, sans-serif; color:#2c3e50;} table{width:100%; border-collapse:collapse;} th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}</style>
                </head><body>
                <h2>Bonus History</h2>
                <div>Distributor: <strong>${name} (${nb})</strong></div>
                <div>Date: ${today}</div>
                <hr/>
                <table><thead><tr><th>Date</th><th>Amount</th><th>Channel</th><th>Reason</th></tr></thead><tbody>${rows}</tbody></table>
                </body></html>
            `);
            win.document.close();
            win.focus();
            win.print();
        }

        function openBonusReceiptWindow(payout, format) {
            const win = window.open('', '_blank');
            const branch = payout.branch || '';
            const name = payout.distributorName || payout.distributorNB;
            const date = (payout.date||'').slice(0,10);
            const amount = Number(payout.amount||0).toFixed(2);
            const small = format === 'receipt';
            const style = small ? '@page { size: 80mm auto; margin: 6mm; } body{font-size:12px;}' : '@page { size: A4; margin: 16mm; } body{font-size:14px;}';
            win.document.write(`
                <html><head><title>Bonus Receipt</title><style>${style} body{font-family: Arial, sans-serif; color:#2c3e50;} .muted{color:#7f8c8d} .sign{margin-top:40px;}
                .row{display:flex; justify-content:space-between; margin:6px 0;}
                </style></head><body>
                <h2 style="margin:0 0 8px 0;">Bonus Payment Acknowledgement</h2>
                <div class="muted">Receipt No: ${payout.id}</div>
                <div class="muted">Date: ${date}</div>
                <hr/>
                <div class="row"><div>Distributor:</div><div><strong>${name}</strong> (${payout.distributorNB})</div></div>
                <div class="row"><div>Branch:</div><div>${branch}</div></div>
                <div class="row"><div>Amount:</div><div><strong>N$ ${amount}</strong></div></div>
                <div class="row"><div>Reason:</div><div>${payout.reason||''}</div></div>
                <div class="row"><div>Processed By:</div><div>${payout.createdBy||''}</div></div>
                <hr/>
                <div class="sign">
                    <div style="height:60px; border:1px dashed #bbb; margin-bottom:6px;"></div>
                    <div class="muted">Distributor Signature</div>
                </div>
                </body></html>
            `);
            win.document.close();
            win.focus();
            win.print();
        }

        function refreshDispenserData() {
            displayPrescriptions();
            displayPriceList();
            refreshBusinessIntelligence();
            displayCashDrawerStatus();
            refreshWalkInSalesList();
            refreshUnifiedSales(); // Add unified sales dashboard
            displayBranchInventory();
        }
        
        // Banking Functions
        function showBankDepositModal() {
            showBankDeposit();
        }
        
        function showCashDrawerModal() {
            const modal = document.createElement('div');
            modal.id = 'cashDrawerModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeModal('cashDrawerModal')">&times;</span>
                    <h2>ðŸ’µ Cash Drawer Management</h2>
                    <div id="cashDrawerDetails" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        ${document.getElementById('cashDrawerStatus')?.innerHTML || ''}
                    </div>
                    <button class="btn btn-success" onclick="openCashDrawer()">ðŸ”“ Open Drawer</button>
                    <button class="btn btn-danger" onclick="closeCashDrawer()">ðŸ”’ Close Drawer</button>
                    <button class="btn" onclick="closeModal('cashDrawerModal')">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showCashExpenseModal() {
            const modal = document.createElement('div');
            modal.id = 'expenseModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('expenseModal')">&times;</span>
                    <h2>ðŸ’¸ Record Cash Expense</h2>
                    <form id="expenseForm" onsubmit="submitExpense(event)">
                        <div class="form-group">
                            <label>Expense Type</label>
                            <select id="expenseType" required>
                                <option value="petty">Petty Cash</option>
                                <option value="transport">Transport</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount (N$)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="expenseDescription" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Submit</button>
                        <button type="button" class="btn" onclick="closeModal('expenseModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function submitExpense(e) {
            e.preventDefault();
            alert('Expense recorded successfully!');
            closeModal('expenseModal');
        }
        
        function displayBankingHistory() {
            const container = document.getElementById('bankingOperations');
            if (!container) return;
            
            container.innerHTML = `
                <h4>Banking History</h4>
                <p style="text-align: center; color: #666; padding: 20px;">No banking records found.</p>
            `;
        }

        // Branch Inventory (Dispenser Stock Tab)
        function getBranchId() {
            try {
                return (window.currentUser && window.currentUser.branch) || document.getElementById('branchSelect')?.value || 'unknown';
            } catch (e) { return 'unknown'; }
        }

        function displayBranchInventory() {
            const listEl = document.getElementById('branchInventoryList');
            if (!listEl) return;

            // Load branch-specific stock snapshot
            const branchId = getBranchId();
            let branchStockMap = {};
            try {
                const stockData = JSON.parse(localStorage.getItem('dyna_branch_stock') || '{}');
                branchStockMap = stockData && typeof stockData === 'object' ? (stockData[branchId] || {}) : {};
            } catch (e) { branchStockMap = {}; }

            // Load reorder levels from consolidated inventory to enrich branch view
            let masterInventory = {};
            try { masterInventory = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}'); } catch (_) { masterInventory = {}; }

            const search = (document.getElementById('branchInventorySearch')?.value || '').toLowerCase();

            const entries = Object.keys(branchStockMap).map(name => ({
                name,
                currentStock: Number(branchStockMap[name] || 0),
                reorderLevel: masterInventory[name]?.reorderLevel ?? 5
            })).filter(e => !search || e.name.toLowerCase().includes(search));

            if (entries.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:20px;">No inventory records found for this branch.</p>';
                return;
            }

            const rows = entries.map(e => {
                const low = e.currentStock <= e.reorderLevel;
                return `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${e.name}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right; font-weight:700; color:${low ? '#e74c3c' : '#27ae60'};">${e.currentStock}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${e.reorderLevel}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${low ? 'âš ï¸ Low' : 'âœ… OK'}</td>
                    </tr>`;
            }).join('');

            listEl.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Product</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Qty</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Reorder</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }

        function searchBranchInventory() { displayBranchInventory(); }
        function showAllBranchInventory() {
            const el = document.getElementById('branchInventorySearch');
            if (el) { el.value = ''; }
            displayBranchInventory();
        }

        // ==========================
        // Branch Inventory Management with Restrictions
        // ==========================
        let branchInventoryData = [];
        let branchStockMovements = [];

        // Check if user has access to sensitive inventory data
        function hasInventoryFullAccess() {
            const user = window.currentUser || {};
            const role = user.role || '';
            return ['gm', 'director', 'admin', 'stock'].includes(role.toLowerCase());
        }

        async function refreshBranchInventory() {
            await loadBranchInventory();
            await loadBranchStockMovements();
            updateBranchInventoryKPIs();
        }

        async function loadBranchInventory() {
            try {
                const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
                const tbody = document.getElementById('branchInventoryTableBody');
                if (!tbody) return;

                // Try to load from API first
                let inventory = [];
                try {
                    const response = await fetch(`/api/branch_stock?branch=${encodeURIComponent(branchId)}`);
                    if (response.ok) {
                        inventory = await response.json();
                    }
                } catch (e) {
                    console.debug('API not available, using localStorage');
                }

                // Fallback to localStorage
                if (inventory.length === 0) {
                    const stored = localStorage.getItem(`branch_stock_${branchId}`) || localStorage.getItem('branch_stock');
                    if (stored) {
                        inventory = JSON.parse(stored);
                    } else {
                        // Initialize from PRICE_LIST if available
                        if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                            inventory = PRICE_LIST.map(p => ({
                                product: p.description,
                                batchNo: '',
                                quantity: 0,
                                expiryDate: '',
                                unitPrice: p.cp || p.dp || 0,
                                totalValue: 0,
                                status: 'out_of_stock',
                                branch: branchId
                            }));
                        }
                    }
                }

                // Apply restrictions: hide expected stock, losses, and sensitive adjustments
                if (!hasInventoryFullAccess()) {
                    inventory = inventory.filter(item => {
                        // Hide items marked as expected stock (requires GM approval)
                        if (item.isExpectedStock && !item.gmApproved) return false;
                        // Hide items marked as stock loss
                        if (item.isStockLoss) return false;
                        // Hide sensitive adjustments
                        if (item.isSensitiveAdjustment) return false;
                        return true;
                    });
                }

                branchInventoryData = inventory;
                filterBranchInventory();
                
                // Show restriction notice if needed
                const noticeEl = document.getElementById('branchInventoryRestrictedNotice');
                if (noticeEl && !hasInventoryFullAccess()) {
                    noticeEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading branch inventory:', error);
                const tbody = document.getElementById('branchInventoryTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #dc3545;">Error loading inventory. Please try again.</td></tr>';
                }
            }
        }

        function filterBranchInventory() {
            const searchTerm = (document.getElementById('branchInventorySearch')?.value || '').toLowerCase();
            const category = document.getElementById('branchInventoryCategory')?.value || 'all';
            const sortBy = document.getElementById('branchInventorySort')?.value || 'name';
            const tbody = document.getElementById('branchInventoryTableBody');
            
            if (!tbody) return;

            let filtered = [...branchInventoryData];

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.product || '').toLowerCase().includes(searchTerm) ||
                    (item.batchNo || '').toLowerCase().includes(searchTerm)
                );
            }

            // Filter by category
            if (category === 'low') {
                filtered = filtered.filter(item => item.status === 'low_stock');
            } else if (category === 'out') {
                filtered = filtered.filter(item => item.status === 'out_of_stock' || (item.quantity || 0) === 0);
            } else if (category === 'expiring') {
                const now = new Date();
                const threeMonths = new Date(now.getFullYear(), now.getMonth() + 3, now.getDate());
                filtered = filtered.filter(item => {
                    if (!item.expiryDate) return false;
                    const expiry = new Date(item.expiryDate + '-01');
                    return expiry <= threeMonths && expiry > now;
                });
            }

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'stock':
                        return (b.quantity || 0) - (a.quantity || 0);
                    case 'expiry':
                        if (!a.expiryDate && !b.expiryDate) return 0;
                        if (!a.expiryDate) return 1;
                        if (!b.expiryDate) return -1;
                        return new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01');
                    default:
                        return (a.product || '').localeCompare(b.product || '');
                }
            });

            // Render table
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">No inventory items found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const statusClass = item.status === 'low_stock' ? 'warn' : item.status === 'out_of_stock' || (item.quantity || 0) === 0 ? 'bad' : 'good';
                const statusText = item.status === 'low_stock' ? 'Low Stock' : item.status === 'out_of_stock' || (item.quantity || 0) === 0 ? 'Out of Stock' : 'In Stock';
                const expiryDate = item.expiryDate ? new Date(item.expiryDate + '-01').toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) : 'N/A';
                const totalValue = (item.quantity || 0) * (item.unitPrice || 0);

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${item.product || 'N/A'}</td>
                        <td style="padding: 12px;">${item.batchNo || 'N/A'}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${item.quantity || 0}</td>
                        <td style="padding: 12px; text-align: center;">${expiryDate}</td>
                        <td style="padding: 12px; text-align: right;">N$${(item.unitPrice || 0).toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">N$${totalValue.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span class="pill ${statusClass}" style="padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${statusText}</span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${hasInventoryFullAccess() ? `<button class="btn btn-sm" onclick="editBranchInventoryItem('${item.id || ''}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">Edit</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateBranchInventoryKPIs() {
            const totalProducts = branchInventoryData.length;
            const totalValue = branchInventoryData.reduce((sum, item) => sum + ((item.quantity || 0) * (item.unitPrice || 0)), 0);
            const lowStock = branchInventoryData.filter(item => item.status === 'low_stock').length;
            const outOfStock = branchInventoryData.filter(item => item.status === 'out_of_stock' || (item.quantity || 0) === 0).length;

            const totalProductsEl = document.getElementById('branchInventoryTotalProducts');
            const totalValueEl = document.getElementById('branchInventoryTotalValue');
            const lowStockEl = document.getElementById('branchInventoryLowStock');
            const outOfStockEl = document.getElementById('branchInventoryOutOfStock');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (totalValueEl) totalValueEl.textContent = `N$${totalValue.toFixed(2)}`;
            if (lowStockEl) lowStockEl.textContent = lowStock;
            if (outOfStockEl) outOfStockEl.textContent = outOfStock;
        }

        async function loadBranchStockMovements() {
            try {
                const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
                const movementsEl = document.getElementById('branchInventoryMovements');
                if (!movementsEl) return;

                // Load from localStorage
                const allMovements = JSON.parse(localStorage.getItem('branch_stock_movements') || '[]');
                let branchMovements = allMovements.filter(m => m.branch === branchId);

                // Apply restrictions: hide sensitive movements
                if (!hasInventoryFullAccess()) {
                    branchMovements = branchMovements.filter(m => {
                        // Hide expected stock movements
                        if (m.isExpectedStock && !m.gmApproved) return false;
                        // Hide stock losses
                        if (m.type === 'loss' || m.isStockLoss) return false;
                        // Hide sensitive adjustments
                        if (m.type === 'adjustment' && m.isSensitive) return false;
                        return true;
                    });
                }

                branchMovements.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0)).slice(0, 50);
                branchStockMovements = branchMovements;

                if (branchMovements.length === 0) {
                    movementsEl.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No stock movements recorded</p>';
                    return;
                }

                movementsEl.innerHTML = branchMovements.map(movement => {
                    const actionIcon = movement.type === 'receive' ? 'ðŸ“¥' : movement.type === 'transfer_out' ? 'ðŸ“¤' : movement.type === 'transfer_in' ? 'ðŸ“¥' : movement.type === 'adjustment' ? 'âœï¸' : 'ðŸ“Š';
                    const actionColor = movement.type === 'receive' ? '#27ae60' : movement.type === 'transfer_out' ? '#3498db' : movement.type === 'transfer_in' ? '#27ae60' : movement.type === 'adjustment' ? '#f39c12' : '#7f8c8d';
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 12px; border-bottom: 1px solid #eee; gap: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <span style="font-size: 1.2rem;">${actionIcon}</span>
                                    <strong>${movement.product || 'N/A'}</strong>
                                    <span style="color: ${actionColor}; font-weight: 600; font-size: 0.85rem; text-transform: uppercase;">${movement.type || 'movement'}</span>
                                    ${movement.isSensitive || movement.isStockLoss ? '<span style="color: #dc3545; font-size: 0.75rem;">ðŸ”’ RESTRICTED</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    Batch: ${movement.batchNo || 'N/A'} | Qty: ${movement.quantity || 0} ${movement.unit || 'units'}
                                    ${movement.expiryDate ? ` | Expiry: ${new Date(movement.expiryDate + '-01').toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })}` : ''}
                                </div>
                                ${movement.notes ? `<div style="font-size: 0.8rem; color: #999; margin-top: 3px;">${movement.notes}</div>` : ''}
                            </div>
                            <div style="text-align: right; font-size: 0.85rem; color: #666;">
                                <div>${new Date(movement.timestamp || Date.now()).toLocaleDateString()}</div>
                                <div style="font-size: 0.75rem; color: #999;">${new Date(movement.timestamp || Date.now()).toLocaleTimeString()}</div>
                                <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">${movement.user || 'System'}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading stock movements:', error);
                const movementsEl = document.getElementById('branchInventoryMovements');
                if (movementsEl) {
                    movementsEl.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading movements</p>';
                }
            }
        }

        function openBranchStockReceiveModal() {
            const modal = document.getElementById('branchStockReceiveModal');
            if (!modal) return;

            // Reset form
            document.getElementById('branchStockReceiveForm').reset();

            // Load products
            const productSelect = document.getElementById('receiveProductSelect');
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                PRICE_LIST.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.description;
                    option.textContent = product.description;
                    productSelect.appendChild(option);
                });
            }

            modal.style.display = 'block';
        }

        function closeBranchStockReceiveModal() {
            document.getElementById('branchStockReceiveModal').style.display = 'none';
        }

        function submitBranchStockReceive(event) {
            event.preventDefault();
            
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const product = document.getElementById('receiveProductSelect').value;
            const batchNo = document.getElementById('receiveBatchNo').value;
            const expiryDate = document.getElementById('receiveExpiryDate').value;
            const quantity = parseInt(document.getElementById('receiveQuantity').value);
            const unit = document.getElementById('receiveUnit').value || 'units';
            const source = document.getElementById('receiveSource').value;
            const notes = document.getElementById('receiveNotes').value;

            if (!product || !batchNo || !expiryDate || !quantity) {
                alert('Please fill in all required fields');
                return;
            }

            // Check if this is expected stock (requires GM approval)
            const isExpectedStock = source === 'warehouse' && quantity > 100; // Threshold for GM approval
            
            if (isExpectedStock && !hasInventoryFullAccess()) {
                // Create expected stock request for GM approval
                const expectedStockRequest = {
                    id: 'ESR' + Date.now(),
                    type: 'expected_stock',
                    branch: branchId,
                    product: product,
                    batchNo: batchNo,
                    expiryDate: expiryDate,
                    quantity: quantity,
                    unit: unit,
                    notes: notes,
                    status: 'pending',
                    requestedBy: (window.currentUser && window.currentUser.fullName) || 'System',
                    requestedAt: new Date().toISOString(),
                    requiresGMApproval: true
                };

                const pendingRequests = JSON.parse(localStorage.getItem('gm_inventory_approvals') || '[]');
                pendingRequests.push(expectedStockRequest);
                localStorage.setItem('gm_inventory_approvals', JSON.stringify(pendingRequests));

                alert('âš ï¸ Expected stock request submitted for GM approval. You will be notified once approved.');
                closeBranchStockReceiveModal();
                return;
            }

            // Get product price
            let unitPrice = 0;
            if (typeof PRICE_LIST !== 'undefined') {
                const prod = PRICE_LIST.find(p => p.description === product);
                if (prod) unitPrice = prod.cp || prod.dp || 0;
            }

            // Check if item already exists
            const existingIndex = branchInventoryData.findIndex(item => 
                item.product === product && item.batchNo === batchNo && item.expiryDate === expiryDate && item.branch === branchId
            );

            if (existingIndex >= 0) {
                branchInventoryData[existingIndex].quantity += quantity;
                branchInventoryData[existingIndex].totalValue = branchInventoryData[existingIndex].quantity * unitPrice;
                branchInventoryData[existingIndex].status = branchInventoryData[existingIndex].quantity > 0 ? 'in_stock' : 'out_of_stock';
            } else {
                const newItem = {
                    id: 'BSI' + Date.now(),
                    product: product,
                    batchNo: batchNo,
                    quantity: quantity,
                    expiryDate: expiryDate,
                    unitPrice: unitPrice,
                    totalValue: quantity * unitPrice,
                    unit: unit,
                    branch: branchId,
                    status: quantity > 0 ? 'in_stock' : 'out_of_stock',
                    createdAt: new Date().toISOString(),
                    isExpectedStock: isExpectedStock,
                    gmApproved: hasInventoryFullAccess() || !isExpectedStock
                };
                branchInventoryData.push(newItem);
            }

            // Record movement
            const movement = {
                id: 'BSM' + Date.now(),
                type: 'receive',
                product: product,
                batchNo: batchNo,
                quantity: quantity,
                expiryDate: expiryDate,
                unit: unit,
                branch: branchId,
                source: source,
                notes: notes,
                timestamp: new Date().toISOString(),
                user: (window.currentUser && window.currentUser.fullName) || 'System',
                isExpectedStock: isExpectedStock,
                gmApproved: hasInventoryFullAccess() || !isExpectedStock
            };

            // Save to localStorage
            try {
                localStorage.setItem(`branch_stock_${branchId}`, JSON.stringify(branchInventoryData));
                
                const allMovements = JSON.parse(localStorage.getItem('branch_stock_movements') || '[]');
                allMovements.push(movement);
                localStorage.setItem('branch_stock_movements', JSON.stringify(allMovements.length > 1000 ? allMovements.slice(-1000) : allMovements));

                // Try to save to API
                try {
                    fetch('/api/branch_stock', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ branch: branchId, items: branchInventoryData, movement: movement })
                    }).catch(e => console.debug('API save failed:', e));
                } catch (e) {}

                alert('âœ… Stock received successfully!');
                closeBranchStockReceiveModal();
                refreshBranchInventory();
            } catch (error) {
                console.error('Error saving stock:', error);
                alert('âŒ Error saving stock. Please try again.');
            }
        }

        function openBranchStockTransferModal() {
            const modal = document.getElementById('branchStockTransferModal');
            if (!modal) return;

            // Reset form
            document.getElementById('branchStockTransferForm').reset();

            // Set from branch
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const branchName = (typeof branches !== 'undefined' && Array.isArray(branches)) ? branches.find(b => b.id === branchId)?.name || branchId : branchId;
            document.getElementById('transferFromBranch').value = branchName;

            // Load destination branches
            const toBranchSelect = document.getElementById('transferToBranch');
            toBranchSelect.innerHTML = '<option value="">Select Destination Branch</option>';
            if (typeof branches !== 'undefined' && Array.isArray(branches)) {
                branches.forEach(branch => {
                    if (branch.id !== branchId) {
                        const option = document.createElement('option');
                        option.value = branch.id || branch.name;
                        option.textContent = branch.name;
                        toBranchSelect.appendChild(option);
                    }
                });
            }

            // Load products
            const productSelect = document.getElementById('transferProductSelect');
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (typeof PRICE_LIST !== 'undefined' && Array.isArray(PRICE_LIST)) {
                PRICE_LIST.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.description;
                    option.textContent = product.description;
                    productSelect.appendChild(option);
                });
            }

            modal.style.display = 'block';
        }

        function closeBranchStockTransferModal() {
            document.getElementById('branchStockTransferModal').style.display = 'none';
        }

        function submitBranchStockTransfer(event) {
            event.preventDefault();
            
            const fromBranchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const toBranchId = document.getElementById('transferToBranch').value;
            const product = document.getElementById('transferProductSelect').value;
            const batchNo = document.getElementById('transferBatchNo').value;
            const quantity = parseInt(document.getElementById('transferQuantity').value);
            const notes = document.getElementById('transferNotes').value;

            if (!toBranchId || !product || !batchNo || !quantity) {
                alert('Please fill in all required fields');
                return;
            }

            // Find source item
            const sourceItem = branchInventoryData.find(item => 
                item.product === product && item.batchNo === batchNo && item.branch === fromBranchId
            );

            if (!sourceItem || (sourceItem.quantity || 0) < quantity) {
                alert('Insufficient stock for transfer');
                return;
            }

            // Update source branch inventory
            sourceItem.quantity -= quantity;
            sourceItem.totalValue = sourceItem.quantity * (sourceItem.unitPrice || 0);
            sourceItem.status = sourceItem.quantity > 0 ? 'in_stock' : 'out_of_stock';

            // Record movements for both branches
            const transferOut = {
                id: 'BSM' + Date.now(),
                type: 'transfer_out',
                product: product,
                batchNo: batchNo,
                quantity: quantity,
                expiryDate: sourceItem.expiryDate,
                unit: sourceItem.unit || 'units',
                branch: fromBranchId,
                toBranch: toBranchId,
                notes: notes,
                timestamp: new Date().toISOString(),
                user: (window.currentUser && window.currentUser.fullName) || 'System'
            };

            const transferIn = {
                id: 'BSM' + (Date.now() + 1),
                type: 'transfer_in',
                product: product,
                batchNo: batchNo,
                quantity: quantity,
                expiryDate: sourceItem.expiryDate,
                unit: sourceItem.unit || 'units',
                branch: toBranchId,
                fromBranch: fromBranchId,
                notes: notes,
                timestamp: new Date().toISOString(),
                user: (window.currentUser && window.currentUser.fullName) || 'System'
            };

            // Save
            try {
                localStorage.setItem(`branch_stock_${fromBranchId}`, JSON.stringify(branchInventoryData));
                
                const allMovements = JSON.parse(localStorage.getItem('branch_stock_movements') || '[]');
                allMovements.push(transferOut, transferIn);
                localStorage.setItem('branch_stock_movements', JSON.stringify(allMovements.length > 1000 ? allMovements.slice(-1000) : allMovements));

                alert('âœ… Stock transferred successfully!');
                closeBranchStockTransferModal();
                refreshBranchInventory();
            } catch (error) {
                console.error('Error transferring stock:', error);
                alert('âŒ Error transferring stock. Please try again.');
            }
        }

        function editBranchInventoryItem(itemId) {
            if (!hasInventoryFullAccess()) {
                alert('âš ï¸ Access Denied: Stock adjustments require GM approval. Please contact your General Manager.');
                return;
            }

            const item = branchInventoryData.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }

            const newQuantity = prompt(`Current quantity: ${item.quantity}\n\nEnter new quantity:`, item.quantity);
            if (newQuantity === null) return;

            const qty = parseInt(newQuantity);
            if (isNaN(qty) || qty < 0) {
                alert('Invalid quantity');
                return;
            }

            const oldQty = item.quantity;
            const difference = qty - oldQty;
            const isLoss = difference < 0;

            // If it's a loss, require GM approval for non-GM users
            if (isLoss && !hasInventoryFullAccess()) {
                const lossRequest = {
                    id: 'SLR' + Date.now(),
                    type: 'stock_loss',
                    branch: item.branch,
                    product: item.product,
                    batchNo: item.batchNo,
                    quantity: Math.abs(difference),
                    oldQuantity: oldQty,
                    newQuantity: qty,
                    reason: prompt('Please provide reason for stock loss:') || 'Not specified',
                    status: 'pending',
                    requestedBy: (window.currentUser && window.currentUser.fullName) || 'System',
                    requestedAt: new Date().toISOString(),
                    requiresGMApproval: true
                };

                const pendingRequests = JSON.parse(localStorage.getItem('gm_inventory_approvals') || '[]');
                pendingRequests.push(lossRequest);
                localStorage.setItem('gm_inventory_approvals', JSON.stringify(pendingRequests));

                alert('âš ï¸ Stock loss adjustment submitted for GM approval. You will be notified once approved.');
                return;
            }

            item.quantity = qty;
            item.totalValue = qty * (item.unitPrice || 0);
            item.status = qty > 0 ? 'in_stock' : 'out_of_stock';

            // Record adjustment
            const movement = {
                id: 'BSM' + Date.now(),
                type: 'adjustment',
                product: item.product,
                batchNo: item.batchNo,
                quantity: difference,
                expiryDate: item.expiryDate,
                unit: item.unit || 'units',
                branch: item.branch,
                notes: `Adjustment: ${oldQty} â†’ ${qty}${isLoss ? ' (LOSS)' : ''}`,
                timestamp: new Date().toISOString(),
                user: (window.currentUser && window.currentUser.fullName) || 'System',
                isStockLoss: isLoss,
                isSensitive: isLoss
            };

            try {
                localStorage.setItem(`branch_stock_${item.branch}`, JSON.stringify(branchInventoryData));
                
                const allMovements = JSON.parse(localStorage.getItem('branch_stock_movements') || '[]');
                allMovements.push(movement);
                localStorage.setItem('branch_stock_movements', JSON.stringify(allMovements.length > 1000 ? allMovements.slice(-1000) : allMovements));

                refreshBranchInventory();
            } catch (error) {
                console.error('Error updating inventory:', error);
                alert('Error updating inventory');
            }
        }

        function exportBranchInventoryCSV() {
            const branchId = (typeof getBranchId === 'function' ? getBranchId() : (window.currentUser && window.currentUser.branch) || 'default');
            const branchName = (typeof branches !== 'undefined' && Array.isArray(branches)) ? branches.find(b => b.id === branchId)?.name || branchId : branchId;
            
            const csv = [
                ['Product', 'Batch No', 'Quantity', 'Unit', 'Expiry Date', 'Unit Price', 'Total Value', 'Status'].join(','),
                ...branchInventoryData.map(item => [
                    `"${(item.product || '').replace(/"/g, '""')}"`,
                    `"${(item.batchNo || '').replace(/"/g, '""')}"`,
                    item.quantity || 0,
                    `"${(item.unit || 'units').replace(/"/g, '""')}"`,
                    item.expiryDate || '',
                    (item.unitPrice || 0).toFixed(2),
                    ((item.quantity || 0) * (item.unitPrice || 0)).toFixed(2),
                    `"${(item.status || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BranchInventory_${branchName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Cross-portal workflow shortcuts from Stock tab
        function openStockDashboard() {
            // Open embedded stock dashboard portal in a new window for full-screen view
            window.open('stock-management-portal.html', '_blank');
            try { recordDepartmentEvent('open_stock_dashboard', { branch: getBranchId() }); } catch (e) {}
        }
        function openMISFromStock() {
            window.open('mis-portal.html', '_blank');
            try { recordDepartmentEvent('handover_to_mis', { branch: getBranchId() }); } catch (e) {}
        }
        function openFinanceFromStock() {
            // Finance is a tab in the same app; if available, switch tab, else open report data
            if (typeof openTab === 'function') { try { openTab('finance'); } catch (e) {} }
            try { recordDepartmentEvent('handover_to_finance', { branch: getBranchId() }); } catch (e) {}
        }
        
        // Payment Functions (Unified with Finance)
        function showRecordPaymentModal() {
            const modal = document.createElement('div');
            modal.id = 'paymentModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            const today = new Date().toISOString().split('T')[0];
            const branchOptions = (window.branches || []).map(b => `<option value="${b}">${b}</option>`).join('');
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 640px;">
                    <span class="close" onclick="closeModal('paymentModal')">&times;</span>
                    <h2>ðŸ’³ Record Payment</h2>
                    <form id="recordPaymentForm" onsubmit="submitPayment(event)">
                        <div class="form-group">
                            <label>Branch *</label>
                            <select id="paymentBranch" required>
                                <option value="">Select Branch</option>
                                ${branchOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="paymentDate" value="${today}" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name *</label>
                            <input type="text" id="paymentClient" list="clientList" required>
                            <datalist id="clientList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="paymentInvoice" required>
                        </div>
                        <div class="form-group">
                            <label>Amount (N$) *</label>
                            <input type="number" id="paymentAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="paymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reference</label>
                            <input type="text" id="paymentReference" placeholder="Txn ref / last 4 / slip no.">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="paymentNotes" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">ðŸ’¾ Record Payment</button>
                            <button type="button" class="btn" onclick="closeModal('paymentModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            // Preselect branch if context is known
            try {
                const select = document.getElementById('paymentBranch');
                const financeSelect = document.getElementById('financeBranchSelect');
                const branchFromContext = (typeof getBranchId === 'function' && getBranchId()) || (financeSelect && financeSelect.value !== 'all' ? financeSelect.value : '');
                if (select && branchFromContext) select.value = branchFromContext;
            } catch (e) {}
        }
        
        function submitPayment(e) {
            e.preventDefault();
            const payment = {
                id: 'PAY' + Date.now(),
                branch: document.getElementById('paymentBranch')?.value || (typeof getBranchId === 'function' ? getBranchId() : ''),
                date: document.getElementById('paymentDate')?.value || new Date().toISOString().split('T')[0],
                client: document.getElementById('paymentClient')?.value || '',
                invoice: document.getElementById('paymentInvoice')?.value || '',
                amount: parseFloat(document.getElementById('paymentAmount')?.value || '0'),
                method: document.getElementById('paymentMethod')?.value || 'cash',
                reference: document.getElementById('paymentReference')?.value || '',
                notes: document.getElementById('paymentNotes')?.value || '',
                recordedBy: (window.currentUser && window.currentUser.fullName) || 'system',
                recordedAt: new Date().toISOString()
            };
            if (!payment.branch) { alert('Please select a branch'); return; }
            if (!payment.amount || payment.amount <= 0) { alert('Please enter a valid amount'); return; }
            const payments = JSON.parse(localStorage.getItem('finance_payments') || '[]');
            payments.push(payment);
            localStorage.setItem('finance_payments', JSON.stringify(payments));
            try { recordDepartmentEvent && recordDepartmentEvent('record_payment', { branch: payment.branch, amount: payment.amount, method: payment.method }); } catch (e) {}
            closeModal('paymentModal');
            displayPaymentHistory();
            try { refreshFinancialDashboard && refreshFinancialDashboard(); } catch (e) {}
            alert('Payment recorded successfully!');
        }
        
        function searchPayments() {
            displayPaymentHistory();
        }
        
        function displayPaymentHistory() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            const payments = JSON.parse(localStorage.getItem('finance_payments') || '[]');
            const branchFilter = (typeof getBranchId === 'function' && getBranchId()) || '';
            const term = (document.getElementById('paymentSearch')?.value || '').toLowerCase();
            const filtered = payments.filter(p => {
                const matchesBranch = !branchFilter || p.branch === branchFilter;
                const matchesTerm = !term || `${p.client} ${p.invoice}`.toLowerCase().includes(term);
                return matchesBranch && matchesTerm;
            }).sort((a,b)=> (b.recordedAt||'').localeCompare(a.recordedAt||''));
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No payment records found.</p>';
                return;
            }
            const rows = filtered.map(p => `
                <tr>
                    <td style="padding:10px; border:1px solid #ddd;">${new Date(p.date).toLocaleDateString()}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.branch}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.client}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.invoice}</td>
                    <td style="padding:10px; border:1px solid #ddd; text-align:right;">N$ ${Number(p.amount||0).toFixed(2)}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.method.replace('_',' ')}</td>
                    <td style="padding:10px; border:1px solid #ddd;">${p.reference||''}</td>
                </tr>
            `).join('');
            container.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:white;">
                        <thead>
                            <tr style="background:#c41e3a; color:white;">
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Date</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Branch</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Client</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Invoice</th>
                                <th style="padding:12px; text-align:right; border:1px solid #ddd;">Amount</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Method</th>
                                <th style="padding:12px; text-align:left; border:1px solid #ddd;">Reference</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }
        
        // Staff Functions
        const COMMUNICATION_STORAGE_KEY = 'dynapharm_portal_communications_v1';
        const STAFF_IDENTIFIER = 'staff';
        const COMMUNICATION_TARGETS = [
            { id: 'hr', label: 'HR', icon: 'ðŸ‘¥' },
            { id: 'gm', label: 'GM', icon: 'ðŸ‘”' },
            { id: 'director', label: 'Director', icon: 'ðŸŽ¯' },
            { id: 'finance', label: 'Finance', icon: 'ðŸ’°' },
            { id: 'frontdesk', label: 'Front Desk', icon: 'ðŸ–¥ï¸' },
            { id: 'mis', label: 'MIS', icon: 'ðŸ“Š' }
        ];
        const COMMUNICATION_TARGET_IDS = COMMUNICATION_TARGETS.map(p => p.id);
        let staffSubTabActive = 'services';
        let staffCommFilter = 'all';

        function getCommunicationMeta(id) {
            return COMMUNICATION_TARGETS.find(p => p.id === id) || { id, label: id.toUpperCase(), icon: 'ðŸ’¬' };
        }

        function escapeHTML(str) {
            return (str || '').replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch] || ch));
        }

        function getAllCommunications() {
            try {
                const raw = localStorage.getItem(COMMUNICATION_STORAGE_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.warn('Failed to load communications', e);
                return [];
            }
        }

        function saveAllCommunications(list) {
            try {
                localStorage.setItem(COMMUNICATION_STORAGE_KEY, JSON.stringify(list));
            } catch (e) {
                console.warn('Failed to save communications', e);
            }
        }

        function showStaffSubTab(tabName, evt) {
            if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
            staffSubTabActive = tabName;
            const section = document.getElementById('dispenserStaffSection');
            if (!section) return;
            section.querySelectorAll('.staff-subtab-btn').forEach(btn => {
                const btnTab = btn.dataset ? btn.dataset.tab : btn.getAttribute('data-tab');
                btn.classList.toggle('active', btnTab === tabName);
            });
            section.querySelectorAll('.staff-subtab-content').forEach(panel => {
                const isServices = tabName === 'services' && panel.id === 'staffServicesTab';
                const isComm = tabName === 'communications' && panel.id === 'staffCommunicationsTab';
                panel.classList.toggle('active', isServices || isComm);
            });
            if (tabName === 'communications') {
                renderStaffCommunications();
            }
        }

        function setStaffCommFilter(filter, evt) {
            if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
            staffCommFilter = filter;
            const containers = [
                document.getElementById('dispenserCommunicationSection'),
                document.getElementById('dispenserStaffSection')
            ].filter(Boolean);
            containers.forEach(section => {
                section.querySelectorAll('.staff-comm-filter-btn').forEach(btn => {
                    const btnFilter = btn.dataset ? btn.dataset.filter : btn.getAttribute('data-filter');
                    btn.classList.toggle('active', btnFilter === filter);
                });
            });
            renderStaffCommunications();
        }

        function toggleStaffRecipients(selectAll) {
            document.querySelectorAll('#staffCommRecipients input[name="staffCommRecipient"]').forEach(cb => {
                cb.checked = !!selectAll;
            });
        }

        function resetStaffCommunicationForm() {
            const form = document.getElementById('staffCommunicationForm');
            if (form) form.reset();
        }

        function submitStaffCommunication(event) {
            event.preventDefault();
            const recipients = Array.from(document.querySelectorAll('#staffCommRecipients input[name="staffCommRecipient"]:checked'))
                .map(cb => cb.value)
                .filter(id => COMMUNICATION_TARGET_IDS.includes(id));
            if (recipients.length === 0) {
                alert('Select at least one portal to send your message to.');
                return;
            }
            const messageInput = document.getElementById('staffCommMessage');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            if (!message) {
                alert('Enter a message before sending.');
                return;
            }
            const entry = {
                id: 'comm-' + Date.now(),
                from: STAFF_IDENTIFIER,
                fromName: (currentUser && currentUser.fullName) || 'Staff Member',
                to: recipients,
                message,
                createdAt: new Date().toISOString()
            };
            const communications = getAllCommunications();
            communications.push(entry);
            saveAllCommunications(communications);
            messageInput.value = '';
            renderStaffCommunications();
            recipients.forEach(portalId => renderPortalCommunications(portalId));
            alert('Communication sent successfully.');
        }

        function submitPortalCommunication(event, portalId) {
            event.preventDefault();
            const textarea = document.getElementById(`portalCommunicationMessage-${portalId}`);
            if (!textarea) return;
            const message = textarea.value.trim();
            if (!message) {
                alert('Enter a message before sending.');
                return;
            }
            const meta = getCommunicationMeta(portalId);
            const entry = {
                id: `comm-${Date.now()}-${portalId}`,
                from: portalId,
                fromName: (currentUser && currentUser.fullName) || meta.label,
                to: [STAFF_IDENTIFIER],
                message,
                createdAt: new Date().toISOString()
            };
            const communications = getAllCommunications();
            communications.push(entry);
            saveAllCommunications(communications);
            textarea.value = '';
            renderPortalCommunications(portalId);
            renderStaffCommunications();
            alert('Message sent to staff.');
        }

        function clearPortalCommunication(portalId) {
            const textarea = document.getElementById(`portalCommunicationMessage-${portalId}`);
            if (textarea) textarea.value = '';
        }

        function buildCommunicationHTML(entry, perspective) {
            const isOutgoing = perspective === STAFF_IDENTIFIER ? entry.from === STAFF_IDENTIFIER : entry.from === perspective;
            const senderMeta = entry.from === STAFF_IDENTIFIER ? { icon: 'ðŸ‘¤', label: 'Staff' } : getCommunicationMeta(entry.from);
            const senderName = entry.from === STAFF_IDENTIFIER ? (entry.fromName || 'Staff') : (entry.fromName || senderMeta.label);
            const recipients = (entry.to || []).map(target => {
                if (target === STAFF_IDENTIFIER) return 'ðŸ‘¤ Staff';
                const meta = getCommunicationMeta(target);
                return `${meta.icon} ${meta.label}`;
            }).join(', ');
            return `
                <div class="communication-message ${isOutgoing ? 'outgoing' : ''}">
                    <div class="communication-meta">
                        <span>${senderMeta.icon} ${escapeHTML(senderName)}</span>
                        <span> â†’ ${recipients || 'â€”'}</span>
                        <span style="margin-left:8px;">${new Date(entry.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="communication-body">${escapeHTML(entry.message)}</div>
                </div>
            `;
        }

        function isStaffEntryVisible(entry, filter) {
            const staffSent = entry.from === STAFF_IDENTIFIER;
            const toStaff = Array.isArray(entry.to) && entry.to.includes(STAFF_IDENTIFIER);
            const fromPortal = COMMUNICATION_TARGET_IDS.includes(entry.from);
            if (!staffSent && !fromPortal) return false;

            const involvedPortals = [];
            if (staffSent) {
                (entry.to || []).forEach(target => {
                    if (COMMUNICATION_TARGET_IDS.includes(target)) involvedPortals.push(target);
                });
            } else if (fromPortal && toStaff) {
                involvedPortals.push(entry.from);
            }

            if (filter === 'all') {
                return involvedPortals.length > 0;
            }
            return involvedPortals.includes(filter);
        }

        function renderStaffCommunications() {
            const container = document.getElementById('staffCommunicationInbox');
            if (!container) return;
            const communications = getAllCommunications();
            const filtered = communications
                .filter(entry => isStaffEntryVisible(entry, staffCommFilter))
                .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            if (filtered.length === 0) {
                container.innerHTML = '<div class="communication-empty">No communications yet.</div>';
                return;
            }
            container.innerHTML = filtered.map(entry => buildCommunicationHTML(entry, STAFF_IDENTIFIER)).join('');
        }

        function renderPortalCommunications(portalId) {
            const container = document.getElementById(`portalCommunicationList-${portalId}`);
            if (!container) return;
            const communications = getAllCommunications();
            const filtered = communications
                .filter(entry => {
                    if (entry.from === portalId && Array.isArray(entry.to) && entry.to.includes(STAFF_IDENTIFIER)) return true;
                    if (entry.from === STAFF_IDENTIFIER && Array.isArray(entry.to) && entry.to.includes(portalId)) return true;
                    return false;
                })
                .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            if (filtered.length === 0) {
                container.innerHTML = '<div class="communication-empty">No conversations yet.</div>';
                return;
            }
            container.innerHTML = filtered.map(entry => buildCommunicationHTML(entry, portalId)).join('');
        }

        function initializeCommunicationPanels() {
            try { renderStaffCommunications(); } catch (e) { console.warn(e); }
            COMMUNICATION_TARGET_IDS.forEach(id => {
                try { renderPortalCommunications(id); } catch (e) { console.warn(e); }
            });
        }

        initializeCommunicationPanels();

        function showDispenserLeaveRequest() {
            const modal = document.createElement('div');
            modal.id = 'leaveRequestModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('leaveRequestModal')">&times;</span>
                    <h2>ðŸ“… Request Leave</h2>
                    <form id="leaveRequestForm" onsubmit="submitLeaveRequest(event)">
                        <div class="form-group">
                            <label>Leave Type</label>
                            <select id="leaveType" required>
                                <option value="">Select Leave Type</option>
                                <option value="vacation">Vacation</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="leaveStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="leaveEndDate" required>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="leaveReason" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Urgent?</label>
                            <label><input type="checkbox" id="leaveUrgent"> Mark as urgent</label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">ðŸ“… Submit Request</button>
                            <button type="button" class="btn" onclick="closeModal('leaveRequestModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function viewMyLeaveRequests() {
            const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]').filter(r => r.staff === currentUser?.username);
            const statusDiv = document.getElementById('myLeaveStatus');
            if (!statusDiv) return;
            
            if (requests.length === 0) {
                statusDiv.innerHTML = '<p style="color: #666;">No leave requests yet.</p>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            requests.forEach(req => {
                const status = req.status || 'Pending';
                const badge = status === 'Approved' ? '#27ae60' : status === 'Rejected' ? '#e74c3c' : '#f39c12';
                html += `
                    <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${badge};">
                        <strong>${req.type}</strong> - ${new Date(req.startDate).toLocaleDateString()} to ${new Date(req.endDate).toLocaleDateString()}<br>
                        <span style="background: ${badge}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85rem;">${status}</span>
                    </div>
                `;
            });
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        function submitLeaveRequest(e) {
            e.preventDefault();
            const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
            const newRequest = {
                id: 'LV' + Date.now(),
                staff: currentUser?.username || 'Unknown',
                type: document.getElementById('leaveType').value,
                startDate: document.getElementById('leaveStartDate').value,
                endDate: document.getElementById('leaveEndDate').value,
                reason: document.getElementById('leaveReason').value,
                urgent: document.getElementById('leaveUrgent').checked,
                status: 'Pending',
                submittedAt: new Date().toISOString()
            };
            requests.push(newRequest);
            localStorage.setItem('leaveRequests', JSON.stringify(requests));
            closeModal('leaveRequestModal');
            alert('Leave request submitted successfully!');
            viewMyLeaveRequests();
        }
        
        function showDispenserCashRequest() {
            const modal = document.createElement('div');
            modal.id = 'cashRequestModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('cashRequestModal')">&times;</span>
                    <h2>ðŸ’µ Request Cash</h2>
                    <form id="cashRequestForm" onsubmit="submitCashRequest(event)">
                        <div class="form-group">
                            <label>Amount Needed (N$)</label>
                            <input type="number" id="cashAmount" step="0.01" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Purpose</label>
                            <textarea id="cashPurpose" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Urgent?</label>
                            <label><input type="checkbox" id="cashUrgent"> Mark as urgent</label>
                        </div>
                        <button type="submit" class="btn btn-success">Submit Request</button>
                        <button type="button" class="btn" onclick="closeModal('cashRequestModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function submitCashRequest(e) {
            e.preventDefault();
            try {
                const amount = parseFloat(document.getElementById('cashAmount').value);
                const purpose = document.getElementById('cashPurpose').value;
                const urgent = document.getElementById('cashUrgent').checked;
                const request = {
                    id: 'CASH' + Date.now(),
                    employee: currentUser?.fullName || 'Unknown',
                    employeeId: currentUser?.username || '',
                    branch: currentBranch || '',
                    amount,
                    purpose,
                    urgent,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                const storeKey = 'finance_cash_requests';
                const existing = JSON.parse(localStorage.getItem(storeKey) || '[]');
                existing.push(request);
                localStorage.setItem(storeKey, JSON.stringify(existing));
                recordDepartmentEvent && recordDepartmentEvent('cash_requested', request);
                alert('Cash request submitted successfully! It will be reviewed by Finance.');
                closeModal('cashRequestModal');
                displayFinanceCashRequests && displayFinanceCashRequests();
            } catch (err) {
                console.warn('submitCashRequest error', err);
                alert('Error submitting cash request.');
            }
        }
        
        function viewMyCashRequests() {
            try {
                const list = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]');
                const mine = list.filter(r => r.employeeId === (currentUser?.username || ''));
                const container = document.getElementById('myCashStatus');
                if (!container) return;
                if (mine.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No cash requests yet.</p>';
                    return;
                }
                container.innerHTML = mine.slice(-10).map(r => `
                    <div style="background: white; border-left: 4px solid ${r.status === 'approved' ? '#27ae60' : r.status === 'rejected' ? '#e74c3c' : '#3498db'}; padding: 10px; margin-bottom: 8px; border-radius: 6px;">
                        <div style="display:flex; justify-content: space-between;">
                            <strong>N$ ${r.amount.toFixed(2)}</strong>
                            <span style="background:${r.status === 'approved' ? '#27ae60' : r.status === 'rejected' ? '#e74c3c' : '#3498db'}; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem;">${r.status.toUpperCase()}</span>
                        </div>
                        <div style="color:#666; font-size:0.9rem;">${r.purpose}</div>
                        <div style="color:#999; font-size:0.8rem;">${new Date(r.createdAt).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.warn('viewMyCashRequests error', e);
            }
        }
        
        function loadMyStaffStatus() {
            viewMyLeaveRequests();
            viewMyCashRequests();
            showStaffSubTab(staffSubTabActive || 'services');
            renderStaffCommunications();
        }
        
        // Cash drawer functions
        function openCashDrawer() {
            cashDrawer.isOpen = true;
            cashDrawer.openedBy = currentUser?.fullName || 'Unknown';
            cashDrawer.openedAt = new Date().toISOString();
            displayCashDrawerStatus();
            alert('Cash drawer opened!');
        }
        
        function closeCashDrawer() {
            cashDrawer.isOpen = false;
            displayCashDrawerStatus();
            alert('Cash drawer closed!');
        }

        function displayCashDrawerStatus() {
            const statusDiv = document.getElementById('cashDrawerStatus');
            if (!statusDiv) return;
            
            // Calculate today's cash from paid prescriptions
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const todayReports = reports.filter(r => new Date(r.timestamp) >= startOfDay);
            
            let todayCash = 0;
            todayReports.forEach(r => {
                const client = clients.find(c => c.referenceNumber === r.clientId);
                if (r.medicines && client) {
                    const totals = calculatePrescriptionTotals(r.medicines, client.membershipStatus);
                    todayCash += totals.paid.dp + totals.paid.cp;
                }
            });
            
            const totalDrops = cashDrawer.drops.reduce((sum, drop) => sum + drop.amount, 0);
            const totalExpenses = cashDrawer.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const expectedCash = cashDrawer.openingBalance + todayCash - totalDrops - totalExpenses;
            
            statusDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'};">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Drawer Status</p>
                        <h3 style="color: ${cashDrawer.isOpen ? '#27ae60' : '#e74c3c'}; font-size: 16pt;">
                            ${cashDrawer.isOpen ? 'ðŸ”“ OPEN' : 'ðŸ”’ CLOSED'}
                        </h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #3498db;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Opening Balance</p>
                        <h3 style="color: #3498db; font-size: 16pt;">N$${cashDrawer.openingBalance.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #27ae60;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Today's Cash</p>
                        <h3 style="color: #27ae60; font-size: 16pt;">N$${todayCash.toFixed(2)}</h3>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #f39c12;">
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Expected in Drawer</p>
                        <h3 style="color: #f39c12; font-size: 16pt;">N$${expectedCash.toFixed(2)}</h3>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    ${!cashDrawer.isOpen ? `
                        <button class="btn btn-success" onclick="openCashDrawer()">ðŸ”“ Open Cash Drawer</button>
                    ` : `
                        <button class="btn btn-warning" onclick="recordCashDrop()" style="margin-right: 10px;">ðŸ’° Cash Drop</button>
                        <button class="btn btn-info" onclick="recordExpense()" style="margin-right: 10px;">ðŸ“ Record Expense</button>
                        <button class="btn btn-primary" onclick="viewCashHistory()" style="margin-right: 10px;">ðŸ“‹ View History</button>
                        <button class="btn btn-danger" onclick="closeCashDrawer()">ðŸ”’ Close & Reconcile</button>
                    `}
                </div>
            `;
        }

        function openCashDrawer() {
            const openingBalance = prompt('Enter opening cash balance in drawer (N$):');
            if (openingBalance === null) return;
            
            const amount = parseFloat(openingBalance) || 0;
            
            cashDrawer = {
                openingBalance: amount,
                currentBalance: amount,
                isOpen: true,
                openedBy: currentUser.fullName,
                openedAt: new Date().toISOString(),
                branch: currentUser ? currentUser.branch : (currentBranch || 'unknown'), // Save branch for finance access
                drops: [],
                expenses: []
            };
            
            // Save to localStorage for finance portal access
            localStorage.setItem('dyna_cash_drawer', JSON.stringify(cashDrawer));
            
            alert(`âœ… Cash drawer opened\nOpening Balance: N$${amount.toFixed(2)}\nOpened by: ${currentUser.fullName}`);
            displayCashDrawerStatus();
        }

        function recordCashDrop() {
            const amount = prompt('Enter cash drop amount (N$):');
            if (!amount) return;
            
            const dropAmount = parseFloat(amount);
            if (isNaN(dropAmount) || dropAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            const notes = prompt('Notes (optional):') || '';
            
            cashDrawer.drops.push({
                amount: dropAmount,
                recordedBy: currentUser.fullName,
                recordedAt: new Date().toISOString(),
                notes: notes,
                reference: 'DROP' + Date.now()
            });
            
            cashDrawer.currentBalance -= dropAmount;
            
            alert(`âœ… Cash drop recorded\nAmount: N$${dropAmount.toFixed(2)}\nRemaining in drawer: N$${cashDrawer.currentBalance.toFixed(2)}`);
            displayCashDrawerStatus();
        }

        function recordExpense() {
            const description = prompt('Expense description:');
            if (!description) return;
            
            const amount = prompt('Expense amount (N$):');
            if (!amount) return;
            
            const expenseAmount = parseFloat(amount);
            if (isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('Invalid amount');
                return;
            }
            
            cashDrawer.expenses.push({
                description: description,
                amount: expenseAmount,
                recordedBy: currentUser.fullName,
                recordedAt: new Date().toISOString(),
                reference: 'EXP' + Date.now()
            });
            
            cashDrawer.currentBalance -= expenseAmount;
            
            alert(`âœ… Expense recorded\nDescription: ${description}\nAmount: N$${expenseAmount.toFixed(2)}`);
            displayCashDrawerStatus();
        }

        function viewCashHistory() {
            let history = `CASH DRAWER HISTORY\n\n`;
            history += `Opening Balance: N$${cashDrawer.openingBalance.toFixed(2)}\n`;
            history += `Opened by: ${cashDrawer.openedBy} at ${new Date(cashDrawer.openedAt).toLocaleString('en-GB')}\n\n`;
            
            if (cashDrawer.drops.length > 0) {
                history += `CASH DROPS (${cashDrawer.drops.length}):\n`;
                cashDrawer.drops.forEach((drop, idx) => {
                    history += `${idx + 1}. N$${drop.amount.toFixed(2)} - ${new Date(drop.recordedAt).toLocaleString('en-GB')}\n`;
                    history += `   By: ${drop.recordedBy} | Ref: ${drop.reference}\n`;
                    if (drop.notes) history += `   Notes: ${drop.notes}\n`;
                });
                history += `\n`;
            }
            
            if (cashDrawer.expenses.length > 0) {
                history += `EXPENSES (${cashDrawer.expenses.length}):\n`;
                cashDrawer.expenses.forEach((exp, idx) => {
                    history += `${idx + 1}. ${exp.description} - N$${exp.amount.toFixed(2)}\n`;
                    history += `   By: ${exp.recordedBy} at ${new Date(exp.recordedAt).toLocaleString('en-GB')}\n`;
                });
            }
            
            alert(history);
        }

        function closeCashDrawer() {
            const actualCash = prompt('Enter actual cash counted in drawer (N$):');
            if (actualCash === null) return;
            
            const counted = parseFloat(actualCash);
            if (isNaN(counted)) {
                alert('Invalid amount');
                return;
            }
            
            // Calculate expected
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const todayReports = reports.filter(r => new Date(r.timestamp) >= startOfDay);
            
            let todayCash = 0;
            todayReports.forEach(r => {
                const client = clients.find(c => c.referenceNumber === r.clientId);
                if (r.medicines && client) {
                    const totals = calculatePrescriptionTotals(r.medicines, client.membershipStatus);
                    todayCash += totals.paid.dp + totals.paid.cp;
                }
            });
            
            const totalDrops = cashDrawer.drops.reduce((sum, drop) => sum + drop.amount, 0);
            const totalExpenses = cashDrawer.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const expectedCash = cashDrawer.openingBalance + todayCash - totalDrops - totalExpenses;
            const variance = counted - expectedCash;
            
            let reconciliation = `CASH DRAWER RECONCILIATION\n\n`;
            reconciliation += `Opening Balance: N$${cashDrawer.openingBalance.toFixed(2)}\n`;
            reconciliation += `+ Today's Cash: N$${todayCash.toFixed(2)}\n`;
            reconciliation += `- Cash Drops: N$${totalDrops.toFixed(2)}\n`;
            reconciliation += `- Expenses: N$${totalExpenses.toFixed(2)}\n`;
            reconciliation += `= Expected Cash: N$${expectedCash.toFixed(2)}\n\n`;
            reconciliation += `Actual Counted: N$${counted.toFixed(2)}\n`;
            reconciliation += `Variance: N$${variance.toFixed(2)} ${variance >= 0 ? '(Over)' : '(Short)'}\n\n`;
            
            if (Math.abs(variance) > 10) {
                reconciliation += `âš ï¸ WARNING: Variance exceeds N$10\nPlease investigate discrepancy.\n\n`;
            }
            
            if (confirm(reconciliation + 'Close cash drawer?')) {
                cashDrawer.isOpen = false;
                cashDrawer.closedBy = currentUser.fullName;
                cashDrawer.closedAt = new Date().toISOString();
                cashDrawer.actualCash = counted;
                cashDrawer.variance = variance;
                
                alert('âœ… Cash drawer closed successfully');
                displayCashDrawerStatus();
            }
        }

        function showAllInventory() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            list.innerHTML = Object.entries(inventory).map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Reorder At</p>
                                <strong>${data.reorderLevel}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">âž•</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">âž–</button>
                            <button class="btn btn-sm btn-info" onclick="setReorderLevel('${productName.replace(/'/g, "\\'")})" style="padding: 5px 10px;">âš™ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            if (!searchTerm) {
                showAllInventory();
                return;
            }
            
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const filtered = Object.entries(inventory).filter(([name, _]) => 
                name.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = filtered.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${productName}</strong>
                            ${data.currentStock <= data.reorderLevel ? ' <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">LOW STOCK</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.75rem; color: #666;">Stock</p>
                                <strong style="font-size: 1.2rem; color: ${data.currentStock <= data.reorderLevel ? '#e74c3c' : '#27ae60'};">${data.currentStock}</strong>
                            </div>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')" style="padding: 5px 10px;">âž•</button>
                            <button class="btn btn-sm" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'remove')" style="padding: 5px 10px;">âž–</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showLowStockItems() {
            initializeInventory();
            const list = document.getElementById('inventoryList');
            if (!list) return;
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            if (lowStock.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #27ae60;"><h3>âœ… All items adequately stocked</h3></div>';
                return;
            }
            
            list.innerHTML = `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">âš ï¸ ${lowStock.length} Items Need Reordering</h4>
                </div>
            ` + lowStock.map(([productName, data]) => `
                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #e74c3c;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${productName}</strong>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Current: ${data.currentStock} | Reorder at: ${data.reorderLevel}
                            </p>
                        </div>
                        <button class="btn btn-success" onclick="adjustStock('${productName.replace(/'/g, "\\'")}', 'add')">ðŸ“¦ Restock</button>
                    </div>
                </div>
            `).join('');
        }

        function adjustStock(productName, action) {
            const quantity = prompt(`Enter quantity to ${action === 'add' ? 'add' : 'remove'}:`);
            if (!quantity) return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                alert('Invalid quantity');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: 5,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            }
            
            const previousStock = inventory[productName].currentStock;
            
            if (action === 'add') {
                inventory[productName].currentStock += qty;
            } else {
                inventory[productName].currentStock = Math.max(0, inventory[productName].currentStock - qty);
            }
            
            // Record in history
            inventory[productName].history.push({
                action: action,
                quantity: qty,
                previousStock: previousStock,
                newStock: inventory[productName].currentStock,
                user: currentUser.fullName,
                timestamp: new Date().toISOString(),
                reference: (action === 'add' ? 'STOCK-IN' : 'STOCK-OUT') + Date.now()
            });
            
            inventory[productName].lastUpdated = new Date().toISOString();
            
            alert(`âœ… Stock updated\n${productName}\nPrevious: ${previousStock}\nNew: ${inventory[productName].currentStock}`);
            showAllInventory();
        }

        function setReorderLevel(productName) {
            const current = inventory[productName]?.reorderLevel || 5;
            const newLevel = prompt(`Set reorder level for:\n${productName}\n\nCurrent reorder level: ${current}\n\nEnter new reorder level:`);
            
            if (!newLevel) return;
            
            const level = parseInt(newLevel);
            if (isNaN(level) || level < 0) {
                alert('Invalid reorder level');
                return;
            }
            
            if (!inventory[productName]) {
                inventory[productName] = {
                    currentStock: 0,
                    reorderLevel: level,
                    lastUpdated: new Date().toISOString(),
                    history: []
                };
            } else {
                inventory[productName].reorderLevel = level;
            }
            
            alert(`âœ… Reorder level updated to ${level}`);
            showAllInventory();
        }

        function printInventoryReport() {
            initializeInventory();
            
            const lowStock = Object.entries(inventory).filter(([_, data]) => 
                data.currentStock <= data.reorderLevel
            );
            
            const totalProducts = Object.keys(inventory).length;
            const totalStock = Object.values(inventory).reduce((sum, data) => sum + data.currentStock, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Inventory Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th { background: #f8f9fa; padding: 8px; border: 1px solid #ddd; text-align: left; }
                        td { padding: 6px 8px; border: 1px solid #ddd; }
                        .low-stock { background: #ffebee; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Inventory Stock Report</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalProducts}</h3>
                            <p>Total Products</p>
                        </div>
                        <div style="text-align: center; background: #f8f9fa; padding: 12px; border-radius: 5px;">
                            <h3>${totalStock}</h3>
                            <p>Total Units in Stock</p>
                        </div>
                        <div style="text-align: center; background: #ffebee; padding: 12px; border-radius: 5px;">
                            <h3 style="color: #e74c3c;">${lowStock.length}</h3>
                            <p>Low Stock Items</p>
                        </div>
                    </div>
                    
                    ${lowStock.length > 0 ? `
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">âš ï¸ Low Stock Items (Reorder Required)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Level</th>
                                    <th>Shortage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStock.map(([name, data], idx) => `
                                    <tr class="low-stock">
                                        <td>${idx + 1}</td>
                                        <td>${name}</td>
                                        <td>${data.currentStock}</td>
                                        <td>${data.reorderLevel}</td>
                                        <td>${data.reorderLevel - data.currentStock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <h3 style="margin-top: 30px; margin-bottom: 10px;">ðŸ“¦ Full Inventory List</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(inventory).map(([name, data], idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${name}</td>
                                    <td>${data.currentStock}</td>
                                    <td>${data.reorderLevel}</td>
                                    <td>${data.currentStock > data.reorderLevel ? 'âœ… OK' : 'âš ï¸ LOW'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== Unified Sales Dashboard Functions ==========
        
        function refreshUnifiedSales() {
            const timeframe = document.getElementById('salesTimeframe')?.value || 'month';
            
            // Get all sales data
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const reports = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
            
            // Calculate date range based on timeframe
            let startDate = new Date();
            switch(timeframe) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case 'all':
                    startDate = new Date(0); // Start of epoch
                    break;
            }
            
            // Filter walk-in sales
            const filteredWalkInSales = walkInSales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate >= startDate;
            });
            
            // Filter prescription sales (paid items only)
            let prescriptionSales = [];
            reports.forEach(report => {
                if (!report.medicines || !report.medicines.length) return;
                
                report.medicines.forEach(med => {
                    if (med.paid && med.amountPaid) {
                        const paidDate = new Date(med.paidAt || report.createdAt);
                        if (paidDate >= startDate) {
                            prescriptionSales.push({
                                id: report.id,
                                customerName: report.clientName || 'Unknown',
                                distributorReferral: report.distributorReferral || { name: 'N/A', id: 'N/A' },
                                productName: med.name,
                                quantity: med.quantity || 1,
                                price: med.price || med.amountPaid,
                                totalAmount: med.amountPaid,
                                bv: med.bv || 0,
                                type: 'prescription',
                                saleDate: paidDate,
                                soldBy: med.paidBy || 'Unknown',
                                branch: report.branch || 'Unknown'
                            });
                        }
                    }
                });
            });
            
            // Aggregate data
            let totalSales = 0;
            let totalBV = 0;
            let distributorSales = 0;
            let customerSales = 0;
            
            filteredWalkInSales.forEach(sale => {
                totalSales += sale.total;
                totalBV += sale.totalBV || 0;
                if (sale.customerType === 'distributor') {
                    distributorSales += sale.total;
                } else {
                    customerSales += sale.total;
                }
            });
            
            prescriptionSales.forEach(sale => {
                totalSales += sale.totalAmount;
                totalBV += sale.bv * sale.quantity;
                customerSales += sale.totalAmount; // Prescriptions are always customer sales
            });
            
            // Update summary cards
            document.getElementById('totalSales').textContent = `N$ ${totalSales.toFixed(2)}`;
            document.getElementById('totalBV').textContent = totalBV.toFixed(0);
            document.getElementById('walkInCount').textContent = filteredWalkInSales.length;
            document.getElementById('prescriptionCount').textContent = prescriptionSales.length;
            
            // Update customer type breakdown
            document.getElementById('distributorSales').textContent = `N$ ${distributorSales.toFixed(2)}`;
            document.getElementById('customerSales').textContent = `N$ ${customerSales.toFixed(2)}`;
            
            const totalCustSales = distributorSales + customerSales;
            const distributorPercentage = totalCustSales > 0 ? (distributorSales / totalCustSales * 100) : 0;
            const customerPercentage = totalCustSales > 0 ? (customerSales / totalCustSales * 100) : 0;
            
            document.getElementById('distributorBar').style.width = distributorPercentage + '%';
            document.getElementById('customerBar').style.width = customerPercentage + '%';
            
            // Top distributors
            const distributorMap = new Map();
            [...filteredWalkInSales, ...prescriptionSales].forEach(sale => {
                const distName = sale.distributorReferral?.name || 'N/A';
                const current = distributorMap.get(distName) || { sales: 0, bv: 0 };
                current.sales += sale.total || sale.totalAmount || 0;
                current.bv += sale.totalBV || (sale.bv * sale.quantity) || 0;
                distributorMap.set(distName, current);
            });
            
            const topDistributors = Array.from(distributorMap.entries())
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 5);
            
            document.getElementById('topDistributors').innerHTML = topDistributors.length > 0
                ? topDistributors.map(([name, data]) => `
                    <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                        <span style="font-weight: 500;">${name}</span>
                        <span style="color: #27ae60;">N$ ${data.sales.toFixed(2)}</span>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: #7f8c8d; padding: 10px;">No distributor sales</p>';
            
            // Detailed sales breakdown
            const allSales = [
                ...filteredWalkInSales.map(sale => ({
                    ...sale,
                    type: 'walkin',
                    saleDate: new Date(sale.timestamp)
                })),
                ...prescriptionSales
            ].sort((a, b) => b.saleDate - a.saleDate);
            
            document.getElementById('unifiedSalesDetail').innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Referrer</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Amount</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">BV</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Sold By</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allSales.slice(0, 50).map(sale => `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 8px;">${sale.saleDate.toLocaleDateString('en-GB')}</td>
                                <td style="padding: 8px;">
                                    <span style="padding: 3px 8px; border-radius: 3px; font-size: 0.8rem; background: ${sale.type === 'walkin' ? '#fff3cd' : '#e8f5e9'};">
                                        ${sale.type === 'walkin' ? 'ðŸ›’ Walk-in' : 'ðŸ’Š Prescription'}
                                    </span>
                                </td>
                                <td style="padding: 8px;">${sale.customerName || 'N/A'}</td>
                                <td style="padding: 8px; font-size: 0.85rem;">${sale.distributorReferral?.name || 'N/A'}</td>
                                <td style="padding: 8px; text-align: right; font-weight: bold;">N$ ${(sale.total || sale.totalAmount || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">${(sale.totalBV || (sale.bv * sale.quantity) || 0).toFixed(0)}</td>
                                <td style="padding: 8px; font-size: 0.85rem;">${sale.soldBy || 'Unknown'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function printUnifiedSales() {
            const printWindow = window.open('', '_blank');
            const timeframe = document.getElementById('salesTimeframe')?.value || 'month';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Unified Sales Report - ${timeframe}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f8f9fa; }
                    </style>
                </head>
                <body>
                    <h1>Unified Sales Report - ${timeframe.charAt(0).toUpperCase() + timeframe.slice(1)}</h1>
                    ${document.getElementById('unifiedSalesDetail').innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        }
        
        function exportUnifiedSales() {
            alert('Excel export feature will be implemented soon.');
        }
        
        async function refreshBusinessIntelligence() {
            await loadData();
            
            const display = document.getElementById('biDisplay');
            if (!display) return;
            
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const biData = calculateBusinessIntelligence(timeframe);
            
            display.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #3498db; text-align: center;">
                            <h3 style="color: #3498db; font-size: 24pt; margin-bottom: 3px;">${biData.totalRevenue.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total Revenue (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #27ae60; text-align: center;">
                            <h3 style="color: #27ae60; font-size: 24pt; margin-bottom: 3px;">${biData.totalPaid.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Cash Collected (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #e74c3c; text-align: center;">
                            <h3 style="color: #e74c3c; font-size: 24pt; margin-bottom: 3px;">${biData.totalOutstanding.toFixed(0)}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Outstanding (N$)</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #9b59b6; text-align: center;">
                            <h3 style="color: #9b59b6; font-size: 24pt; margin-bottom: 3px;">${biData.totalBV}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Total BV</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #f39c12; text-align: center;">
                            <h3 style="color: #f39c12; font-size: 24pt; margin-bottom: 3px;">${biData.productsSold}</h3>
                            <p style="color: #666; font-size: 0.85rem;">Products Sold</p>
                        </div>
                    </div>

                    <!-- Top Selling Products & Revenue Breakdown -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ† Top Selling Products</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Rank</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Product</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">Qty</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${biData.topSellingProducts.slice(0, 10).map((product, idx) => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-weight: bold; color: #c41e3a;">#${idx + 1}</td>
                                            <td style="padding: 8px;">${product.name}</td>
                                            <td style="padding: 8px; text-align: center;">${product.quantity}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: bold;">N$${product.revenue.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ’° Revenue Breakdown</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Member Sales (DP):</span>
                                    <strong style="color: #27ae60;">N$${biData.dpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 12px; border-radius: 6px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.dpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.dpPercentage}%</p>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Referred Sales (CP):</span>
                                    <strong style="color: #f39c12;">N$${biData.cpRevenue.toFixed(2)}</strong>
                                </div>
                                <div style="background: #fff3cd; height: 12px; border-radius: 6px;">
                                    <div style="background: #f39c12; height: 100%; width: ${biData.cpPercentage}%; border-radius: 6px;"></div>
                                </div>
                                <p style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 3px;">${biData.cpPercentage}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Package vs Individual Sales -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ“¦ Package vs Individual Sales</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Package Sales:</span>
                                    <strong style="color: #27ae60;">${biData.packageSales} (N$${biData.packageRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e8f5e9; height: 10px; border-radius: 5px;">
                                    <div style="background: #27ae60; height: 100%; width: ${biData.packagePercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Individual Sales:</span>
                                    <strong style="color: #2196f3;">${biData.individualSales} (N$${biData.individualRevenue.toFixed(0)})</strong>
                                </div>
                                <div style="background: #e3f2fd; height: 10px; border-radius: 5px;">
                                    <div style="background: #2196f3; height: 100%; width: ${biData.individualPercentage}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ðŸ‘¥ Consultant Performance</h4>
                            ${biData.topConsultants.slice(0, 5).map((consultant, idx) => `
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 0.9rem;">${consultant.name}</span>
                                        <strong style="color: #c41e3a;">N$${consultant.revenue.toFixed(0)}</strong>
                                    </div>
                                    <div style="background: #f8f9fa; height: 8px; border-radius: 4px;">
                                        <div style="background: #c41e3a; height: 100%; width: ${consultant.percentage}%; border-radius: 4px;"></div>
                                    </div>
                                    <p style="font-size: 0.75rem; color: #666; margin-top: 2px;">${consultant.clients} clients | ${consultant.percentage}%</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateBusinessIntelligence(timeframe) {
            // Filter by timeframe
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            const filteredReports = reports.filter(r => new Date(r.timestamp) >= startDate);
            
            // Calculate revenue
            let totalRevenue = 0, totalPaid = 0, totalOutstanding = 0, totalBV = 0;
            let dpRevenue = 0, cpRevenue = 0;
            let packageSales = 0, individualSales = 0;
            let packageRevenue = 0, individualRevenue = 0;
            let productsSold = 0;
            
            const productRevenue = {};
            const consultantRevenue = {};
            
            filteredReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client || !report.medicines) return;
                
                const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                
                totalRevenue += totals.total.dp + totals.total.cp;
                totalPaid += totals.paid.dp + totals.paid.cp;
                totalOutstanding += totals.outstanding.dp + totals.outstanding.cp;
                totalBV += totals.total.bv;
                
                dpRevenue += totals.total.dp;
                cpRevenue += totals.total.cp;
                
                // Track consultant performance
                if (!consultantRevenue[report.consultant]) {
                    consultantRevenue[report.consultant] = { revenue: 0, clients: 0 };
                }
                consultantRevenue[report.consultant].revenue += totals.paid.dp + totals.paid.cp;
                consultantRevenue[report.consultant].clients++;
                
                // Track products
                report.medicines.forEach(med => {
                    const price = findProductPrice(med.name);
                    const isPackage = price.isPackage;
                    
                    if (isPackage) {
                        packageSales++;
                        const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                        const revenue = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                        packageRevenue += revenue;
                        
                        if (!productRevenue[med.name]) {
                            productRevenue[med.name] = { quantity: 0, revenue: 0 };
                        }
                        productRevenue[med.name].quantity++;
                        productRevenue[med.name].revenue += revenue;
                    } else {
                        if (med.dispensed) {
                            individualSales++;
                            const revenue = client.membershipStatus === 'member' ? price.dp : price.cp;
                            individualRevenue += revenue;
                            
                            if (!productRevenue[med.name]) {
                                productRevenue[med.name] = { quantity: 0, revenue: 0 };
                            }
                            productRevenue[med.name].quantity++;
                            productRevenue[med.name].revenue += revenue;
                        }
                    }
                    productsSold++;
                });
            });
            
            const topSellingProducts = Object.entries(productRevenue)
                .map(([name, data]) => ({
                    name,
                    quantity: data.quantity,
                    revenue: data.revenue
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const topConsultants = Object.entries(consultantRevenue)
                .map(([name, data]) => ({
                    name,
                    revenue: data.revenue,
                    clients: data.clients,
                    percentage: totalPaid > 0 ? Math.round((data.revenue / totalPaid) * 100) : 0
                }))
                .sort((a, b) => b.revenue - a.revenue);
            
            const totalSales = packageSales + individualSales;
            
            return {
                totalRevenue,
                totalPaid,
                totalOutstanding,
                totalBV,
                dpRevenue,
                cpRevenue,
                dpPercentage: totalRevenue > 0 ? Math.round((dpRevenue / totalRevenue) * 100) : 0,
                cpPercentage: totalRevenue > 0 ? Math.round((cpRevenue / totalRevenue) * 100) : 0,
                packageSales,
                individualSales,
                packageRevenue,
                individualRevenue,
                packagePercentage: totalSales > 0 ? Math.round((packageSales / totalSales) * 100) : 0,
                individualPercentage: totalSales > 0 ? Math.round((individualSales / totalSales) * 100) : 0,
                productsSold,
                topSellingProducts,
                topConsultants
            };
        }

        function printBusinessIntelligence() {
            const timeframe = document.getElementById('biTimeframe')?.value || 'month';
            const timeframeText = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'all': 'All Time'
            }[timeframe];
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Business Intelligence Report</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        .header { background: #c41e3a; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { font-size: 18pt; margin-bottom: 5px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>Business Intelligence Report - ${timeframeText}</p>
                        <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${document.getElementById('biDisplay').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Price list functions
        function displayPriceList() {
            const list = document.getElementById('priceList');
            if (!list) return;
            
            // Combine packages and individual products
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${allItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` ðŸ“¦ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function searchPriceList() {
            const searchTerm = document.getElementById('priceSearch').value.toLowerCase();
            const list = document.getElementById('priceList');
            if (!list) return;
            
            if (!searchTerm) {
                displayPriceList();
                return;
            }
            
            // Combine packages and individual products for search
            const packageItems = Object.entries(PACKAGE_DATABASE).map(([name, data]) => ({
                description: name,
                dp: data.price.dp,
                cp: data.price.cp,
                bv: data.price.bv,
                isPackage: true,
                productCount: data.products.length
            }));
            
            const allItems = [...packageItems, ...PRICE_LIST];
            const filteredItems = allItems.filter(item => 
                item.description.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="color: #c41e3a; margin-bottom: 10px;">Search Results (${filteredItems.length} items)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; font-weight: bold; border-bottom: 2px solid #c41e3a; padding-bottom: 5px;">
                        <div>DESCRIPTION</div>
                        <div style="text-align: center;">DP</div>
                        <div style="text-align: center;">CP</div>
                        <div style="text-align: center;">BV</div>
                    </div>
                </div>
                ${filteredItems.map(item => `
                    <div style="display: grid; grid-template-columns: 1fr 80px 80px 80px; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; ${item.isPackage ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : ''}">
                        <div style="word-break: break-word; ${item.isPackage ? 'font-weight: bold; color: #27ae60;' : ''}">
                            ${item.description}${item.isPackage ? ` ðŸ“¦ (${item.productCount} items)` : ''}
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #c41e3a;">${item.dp}</div>
                        <div style="text-align: center; font-weight: bold; color: #27ae60;">${item.cp}</div>
                        <div style="text-align: center; font-weight: bold; color: #f39c12;">${item.bv}</div>
                    </div>
                `).join('')}
            `;
        }

        function showAllPrices() {
            document.getElementById('priceSearch').value = '';
            displayPriceList();
        }

        function printPriceList() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #c41e3a; margin-bottom: 10px; }
                        .price-table { width: 100%; border-collapse: collapse; }
                        .price-table th, .price-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .price-table th { background-color: #f8f9fa; font-weight: bold; }
                        .price-table .description { width: 60%; }
                        .price-table .dp, .price-table .cp, .price-table .bv { width: 13.33%; text-align: center; }
                        .dp { color: #c41e3a; font-weight: bold; }
                        .cp { color: #27ae60; font-weight: bold; }
                        .bv { color: #f39c12; font-weight: bold; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM NAMIBIA OFFICIAL PRICE LIST JUNE 2025</h1>
                        <p>DESCRIPTION | DP | CP | BV</p>
                    </div>
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th class="description">DESCRIPTION</th>
                                <th class="dp">DP</th>
                                <th class="cp">CP</th>
                                <th class="bv">BV</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${PRICE_LIST.map(item => `
                                <tr>
                                    <td class="description">${item.description}</td>
                                    <td class="dp">${item.dp}</td>
                                    <td class="cp">${item.cp}</td>
                                    <td class="bv">${item.bv}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function viewPrescriptionDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            if (report) {
                alert(`Prescription Details:\n\nReport ID: ${report.id}\nClient: ${client ? client.fullName : 'Unknown'}\nConsultant: ${report.consultant}\nCreated: ${new Date(report.timestamp).toLocaleString()}\n\nPrescription:\n${report.prescription}\n\nNotes:\n${report.notes || 'None'}`);
            }
        }

        function printPrescription(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report) return;
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Prescription - ${report.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #c41e3a; padding-bottom: 20px; margin-bottom: 20px; }
                        .patient-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .medicines { margin: 20px 0; }
                        .medicine-item { padding: 8px; margin: 5px 0; border-left: 3px solid #c41e3a; background: #f8f9fa; }
                        .notes { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        .footer { margin-top: 30px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <h2>Summary Analysis Report Card</h2>
                        <p>Shop Commercial Building, Independence Avenue | Tel: 061-300877</p>
                        <p>Branch: ${client ? client.branch : 'Unknown'}</p>
                    </div>
                    
                    <div class="patient-info">
                        <h3>Patient Information</h3>
                        <p><strong>Name:</strong> ${client ? client.fullName : 'Unknown'}</p>
                        <p><strong>Reference:</strong> ${report.clientId}</p>
                        <p><strong>Phone:</strong> ${client ? client.phone : 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(report.timestamp).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="medicines">
                        <h3>Prescribed Medicines with Prices</h3>
                        ${report.medicines ? (() => {
                            const clientMembershipStatus = client ? client.membershipStatus : 'referred';
                            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
                            return `
                            ${report.medicines.map(med => {
                                const price = findProductPrice(med.name);
                                let effectivePrice;
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                
                                return `
                                <div class="medicine-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${med.name}</strong> ${med.dispensed ? 'âœ… Dispensed' : 'â³ Pending'}
                                            ${med.paid ? 'ðŸ’° Paid' : ''}
                                        </div>
                                        <div style="text-align: right; font-size: 0.9rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${effectivePrice.dp}</div>
                                                <div><strong>BV:</strong> ${effectivePrice.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${effectivePrice.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            
                            <!-- Receipt Totals -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; border: 2px solid #c41e3a;">
                                <h4 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">PRESCRIPTION TOTALS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                        <h5 style="color: #c41e3a; margin-bottom: 5px;">TOTAL</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.total.dp}</div>
                                                <div><strong>BV:</strong> ${totals.total.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.total.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #e8f5e9; padding: 10px; border-radius: 5px; border: 1px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin-bottom: 5px;">DISPENSED</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.dispensed.dp}</div>
                                                <div><strong>BV:</strong> ${totals.dispensed.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.dispensed.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #155724;">
                                        <h5 style="color: #155724; margin-bottom: 5px;">PAID</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.paid.dp}</div>
                                                <div><strong>BV:</strong> ${totals.paid.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.paid.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #721c24;">
                                        <h5 style="color: #721c24; margin-bottom: 5px;">OUTSTANDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.outstanding.dp}</div>
                                                <div><strong>BV:</strong> ${totals.outstanding.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.outstanding.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                    <div style="text-align: center; background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin-bottom: 5px;">PENDING</h5>
                                        <div style="font-size: 0.8rem;">
                                            ${clientMembershipStatus === 'member' ? `
                                                <div><strong>DP:</strong> N$${totals.pending.dp}</div>
                                                <div><strong>BV:</strong> ${totals.pending.bv}</div>
                                            ` : `
                                                <div><strong>CP:</strong> N$${totals.pending.cp}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        })() : '<p>No medicines prescribed</p>'}
                    </div>
                    
                    ${report.notes ? `
                    <div class="notes">
                        <h3>Consultant Notes</h3>
                        <p>${report.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p><strong>Consultant:</strong> ${report.consultant}</p>
                        <p><strong>Report ID:</strong> ${report.id}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printThermalReceipt(reportId) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            if (!report || !client) {
                alert('Report or client data not found');
                return;
            }
            
            const clientMembershipStatus = client.membershipStatus || 'referred';
            const totals = calculatePrescriptionTotals(report.medicines, clientMembershipStatus);
            const consultationFee = clientMembershipStatus === 'member' ? CONSULTATION_FEES.member : CONSULTATION_FEES.referred;
            const branchName = branches.find(b => b.id === client.branch)?.name || client.branch;
            
            // Create thermal receipt
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Receipt - ${report.id}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        .center {
                            text-align: center;
                        }
                        
                        .bold {
                            font-weight: bold;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                            margin-bottom: 8px;
                        }
                        
                        .header h1 {
                            font-size: 12pt;
                            margin-bottom: 3px;
                        }
                        
                        .header p {
                            font-size: 8pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin: 8px 0;
                            padding-bottom: 5px;
                        }
                        
                        .section-title {
                            font-weight: bold;
                            font-size: 9pt;
                            border-bottom: 2px solid #c41e3a;
                            margin-bottom: 4px;
                            padding-bottom: 2px;
                            color: #c41e3a;
                            text-transform: uppercase;
                        }
                        
                        .info-line {
                            display: flex;
                            justify-content: space-between;
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        
                        .item {
                            margin: 4px 0;
                            font-size: 9pt;
                        }
                        
                        .item-name {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        
                        .item-status {
                            display: flex;
                            justify-content: space-between;
                            font-size: 8pt;
                            margin-top: 1px;
                        }
                        
                        .divider {
                            border-top: 1px dashed #c41e3a;
                            margin: 6px 0;
                        }
                        
                        .total-line {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            font-size: 10pt;
                            margin: 3px 0;
                            color: #c41e3a;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 12px;
                            border-top: 2px solid #c41e3a;
                            padding-top: 8px;
                            font-size: 8pt;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 5px;">
                        ${generateLogoSVG(60, 40)}
                    </div>
                    
                    <!-- Header -->
                    <div class="header" style="border-bottom: 2px solid #c41e3a; background: linear-gradient(135deg, rgba(196,30,58,0.1) 0%, rgba(139,0,0,0.1) 100%); border-radius: 4px;">
                        <h1 style="color: #c41e3a; font-weight: 900;">DYNAPHARM NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>PRESCRIPTION RECEIPT</p>
                        <p>${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</p>
                    </div>
                    
                    <!-- Client Details -->
                    <div class="section">
                        <div class="section-title">CLIENT DETAILS</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span class="bold">${client.fullName}</span>
                        </div>
                        <div class="info-line">
                            <span>DOB:</span>
                            <span>${client.dob || 'N/A'}</span>
                        </div>
                        <div class="info-line">
                            <span>Contact:</span>
                            <span>${client.phone}</span>
                        </div>
                        <div class="info-line">
                            <span>Type:</span>
                            <span>${clientMembershipStatus === 'member' ? 'MEMBER (DP)' : 'REFERRED (CP)'}</span>
                        </div>
                        ${clientMembershipStatus === 'referred' ? `
                        <div class="info-line">
                            <span>Referred By:</span>
                            <span>${client.referralName || 'N/A'}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Consultant Info -->
                    <div class="section">
                        <div class="section-title">CONSULTANT</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span>${report.consultant}</span>
                        </div>
                        <div class="info-line">
                            <span>Date:</span>
                            <span>${new Date(report.timestamp).toLocaleDateString('en-GB')}</span>
                        </div>
                        <div class="info-line">
                            <span>Report ID:</span>
                            <span>${report.id}</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Prescribed Items -->
                    <div class="section">
                        <div class="section-title">PRESCRIBED PRODUCTS</div>
                        ${report.medicines.map(med => {
                            const price = findProductPrice(med.name);
                            const isPackage = price.isPackage;
                            let effectivePrice;
                            let isTaken;
                            
                            if (isPackage) {
                                const packagePricing = calculatePackagePricing(med, clientMembershipStatus);
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: packagePricing.dp, cp: packagePricing.dp, bv: packagePricing.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: packagePricing.cp, bv: 0 };
                                }
                                // For packages, show partial status if some items are dispensed
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    isTaken = 'âœ“ TAKEN';
                                } else if (packagePricing.dispensedCount > 0) {
                                    isTaken = `â— PARTIAL (${packagePricing.dispensedCount}/${packagePricing.totalCount})`;
                                } else {
                                    isTaken = 'â—‹ NOT TAKEN';
                                }
                            } else {
                                if (clientMembershipStatus === 'member') {
                                    effectivePrice = { dp: price.dp, cp: price.dp, bv: price.bv };
                                } else {
                                    effectivePrice = { dp: 0, cp: price.cp, bv: 0 };
                                }
                                isTaken = med.dispensed ? 'âœ“ TAKEN' : 'â—‹ NOT TAKEN';
                            }
                            
                            return `
                            <div class="item">
                                <div class="item-name">${med.name}${isPackage ? ' ðŸ“¦' : ''}</div>
                                <div class="item-status">
                                    <span>${isTaken}</span>
                                    <span class="bold">
                                        ${clientMembershipStatus === 'member' ? 
                                            `N$${effectivePrice.dp}` : 
                                            `N$${effectivePrice.cp}`}
                                    </span>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Totals -->
                    <div class="section">
                        <div class="section-title">SUMMARY</div>
                        <div class="info-line">
                            <span>Consultation Fee:</span>
                            <span>N$${consultationFee}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="total-line">
                            <span>TOTAL:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.total.dp}` : 
                                    `N$${totals.total.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Dispensed:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.dispensed.dp}` : 
                                    `N$${totals.dispensed.cp}`}
                            </span>
                        </div>
                        <div class="info-line">
                            <span>Pending:</span>
                            <span>
                                ${clientMembershipStatus === 'member' ? 
                                    `N$${totals.pending.dp}` : 
                                    `N$${totals.pending.cp}`}
                            </span>
                        </div>
                        ${clientMembershipStatus === 'member' ? `
                        <div class="info-line">
                            <span>Total BV:</span>
                            <span>${totals.total.bv}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p style="color: #c41e3a; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                        <p style="margin-top: 3px;">Thank you for choosing Dynapharm!</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function showDailyStatementModal() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Generate preview content directly (same as what gets printed in A4)
            const content = document.getElementById('dailyStatementContent');
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <!-- Summary Statistics -->
                    <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">ðŸ“Š DAILY SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalClientsToday}</h3>
                                <p style="color: #666; font-size: 9pt;">Total Clients</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalMembers}</h3>
                                <p style="color: #666; font-size: 9pt;">Registered Members</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${statementData.totalReferred}</h3>
                                <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">ðŸ‘¨â€âš•ï¸ CONSULTANTS BREAKDOWN</h3>
                        ${Object.keys(statementData.consultantStats).map(consultantName => {
                            const stats = statementData.consultantStats[consultantName];
                            return `
                            <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">ðŸ‘¨â€âš•ï¸ ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #e3f2fd;">
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                            <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">ðŸ“¦ PRODUCTS DISPENSED TODAY</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr style="background: #e8f5e9;">
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                    <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(statementData.productDispensed).map((product, idx) => `
                                    <tr>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                        <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">ðŸ’° FINANCIAL SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${statementData.totalRevenue.bv}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${statementData.totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.dp.toFixed(2)}</p>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${statementData.totalPaid.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(statementData.totalPaid.dp + statementData.totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal
            document.getElementById('dailyStatementModal').style.display = 'block';
        }
        
        function generateDailyStatementData() {
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            
            // Filter reports for today
            const todayReports = reports.filter(r => {
                const reportDate = new Date(r.timestamp);
                return reportDate >= startOfDay && reportDate <= endOfDay;
            });
            
            if (todayReports.length === 0) {
                alert('No consultations recorded for today');
                return;
            }
            
            // Group reports by consultant
            const consultantStats = {};
            let totalClientsToday = 0;
            let totalMembers = 0;
            let totalReferred = 0;
            let totalRevenue = { dp: 0, cp: 0, bv: 0 };
            let totalPaid = { dp: 0, cp: 0, bv: 0 };
            let totalOutstanding = { dp: 0, cp: 0, bv: 0 };
            
            // Product dispensing tracking
            const productDispensed = {};
            
            todayReports.forEach(report => {
                const client = clients.find(c => c.referenceNumber === report.clientId);
                if (!client) return;
                
                totalClientsToday++;
                const isMember = client.membershipStatus === 'member';
                if (isMember) totalMembers++;
                else totalReferred++;
                
                // Initialize consultant stats
                if (!consultantStats[report.consultant]) {
                    consultantStats[report.consultant] = {
                        totalClients: 0,
                        members: 0,
                        referred: 0,
                        clients: []
                    };
                }
                
                consultantStats[report.consultant].totalClients++;
                if (isMember) {
                    consultantStats[report.consultant].members++;
                } else {
                    consultantStats[report.consultant].referred++;
                }
                
                consultantStats[report.consultant].clients.push({
                    name: client.fullName,
                    type: isMember ? 'Member' : 'Referred',
                    referralNb: client.referralNbNumber || client.nbNumber || 'N/A',
                    referredBy: client.referralName || 'Self'
                });
                
                // Calculate totals
                if (report.medicines) {
                    const totals = calculatePrescriptionTotals(report.medicines, client.membershipStatus);
                    
                    totalRevenue.dp += totals.total.dp;
                    totalRevenue.cp += totals.total.cp;
                    totalRevenue.bv += totals.total.bv;
                    
                    totalPaid.dp += totals.paid.dp;
                    totalPaid.cp += totals.paid.cp;
                    totalPaid.bv += totals.paid.bv;
                    
                    totalOutstanding.dp += totals.outstanding.dp;
                    totalOutstanding.cp += totals.outstanding.cp;
                    totalOutstanding.bv += totals.outstanding.bv;
                    
                    // Track dispensed products
                    report.medicines.forEach(med => {
                        const price = findProductPrice(med.name);
                        const isPackage = price.isPackage;
                        
                        if (isPackage) {
                            // For packages, track individual items
                            const packagePricing = calculatePackagePricing(med, client.membershipStatus);
                            if (packagePricing.dispensedCount > 0) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        partialCount: 0,
                                        fullCount: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].partialCount++;
                                if (packagePricing.dispensedCount === packagePricing.totalCount) {
                                    productDispensed[med.name].fullCount++;
                                }
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += packagePricing.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += packagePricing.cp;
                                }
                            }
                        } else {
                            // For individual products
                            if (med.dispensed) {
                                if (!productDispensed[med.name]) {
                                    productDispensed[med.name] = {
                                        name: med.name,
                                        quantity: 0,
                                        revenue: { dp: 0, cp: 0 }
                                    };
                                }
                                productDispensed[med.name].quantity++;
                                if (isMember) {
                                    productDispensed[med.name].revenue.dp += price.dp;
                                } else {
                                    productDispensed[med.name].revenue.cp += price.cp;
                                }
                            }
                        }
                    });
                }
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        .summary-box {
                            background: #f8f9fa;
                            border: 2px solid #c41e3a;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-top: 10px;
                        }
                        
                        .summary-item {
                            background: white;
                            padding: 12px;
                            border-radius: 5px;
                            border-left: 4px solid #c41e3a;
                            text-align: center;
                        }
                        
                        .summary-item h3 {
                            color: #c41e3a;
                            font-size: 24pt;
                            margin-bottom: 5px;
                        }
                        
                        .summary-item p {
                            color: #666;
                            font-size: 9pt;
                        }
                        
                        .section {
                            margin-bottom: 25px;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            background: #c41e3a;
                            color: white;
                            padding: 8px 15px;
                            font-size: 12pt;
                            font-weight: bold;
                            border-radius: 5px;
                            margin-bottom: 10px;
                        }
                        
                        .consultant-section {
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            padding: 15px;
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                        }
                        
                        .consultant-section h4 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                            font-size: 11pt;
                        }
                        
                        .client-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .client-table th {
                            background: #e3f2fd;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .client-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .product-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 9pt;
                        }
                        
                        .product-table th {
                            background: #e8f5e9;
                            padding: 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        .product-table td {
                            padding: 5px 6px;
                            border: 1px solid #ddd;
                        }
                        
                        .totals-section {
                            background: #fff3cd;
                            border: 2px solid #ffc107;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        
                        .totals-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        
                        .total-item {
                            background: white;
                            padding: 10px;
                            border-radius: 5px;
                            border-left: 3px solid #f39c12;
                        }
                        
                        .total-item strong {
                            color: #c41e3a;
                            font-size: 11pt;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #c41e3a;
                            font-size: 9pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="summary-box">
                        <h3 style="color: #c41e3a; margin-bottom: 10px; text-align: center;">ðŸ“Š DAILY SUMMARY</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <h3>${totalClientsToday}</h3>
                                <p>Total Clients</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalMembers}</h3>
                                <p>Registered Members</p>
                            </div>
                            <div class="summary-item">
                                <h3>${totalReferred}</h3>
                                <p>Referred Clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultant Breakdown -->
                    <div class="section">
                        <div class="section-title">ðŸ‘¨â€âš•ï¸ CONSULTANTS BREAKDOWN</div>
                        ${Object.keys(consultantStats).map(consultantName => {
                            const stats = consultantStats[consultantName];
                            return `
                            <div class="consultant-section">
                                <h4>ðŸ‘¨â€âš•ï¸ ${consultantName}</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    <strong>Total Clients:</strong> ${stats.totalClients} | 
                                    <strong>Members:</strong> ${stats.members} | 
                                    <strong>Referred:</strong> ${stats.referred}
                                </p>
                                <table class="client-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Client Name</th>
                                            <th>Type</th>
                                            <th>Referral NB</th>
                                            <th>Referred By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.clients.map((client, idx) => `
                                            <tr>
                                                <td>${idx + 1}</td>
                                                <td>${client.name}</td>
                                                <td>${client.type}</td>
                                                <td>${client.referralNb}</td>
                                                <td>${client.referredBy}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Products Dispensed -->
                    <div class="section">
                        <div class="section-title">ðŸ“¦ PRODUCTS DISPENSED TODAY</div>
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product Name</th>
                                    <th>Quantity Dispensed</th>
                                    <th>Revenue (DP)</th>
                                    <th>Revenue (CP)</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(productDispensed).map((product, idx) => `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${product.name}</td>
                                        <td>
                                            ${product.quantity !== undefined ? 
                                                `${product.quantity} units` : 
                                                `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                        </td>
                                        <td>N$${product.revenue.dp.toFixed(2)}</td>
                                        <td>N$${product.revenue.cp.toFixed(2)}</td>
                                        <td><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="totals-section">
                        <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">ðŸ’° FINANCIAL SUMMARY</h3>
                        <div class="totals-grid">
                            <div class="total-item">
                                <strong>Total Revenue (DP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Total BV: ${totalRevenue.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Revenue (CP):</strong>
                                <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${totalRevenue.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (DP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Paid BV: ${totalPaid.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Total Paid (CP):</strong>
                                <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${totalPaid.cp.toFixed(2)}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (DP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.dp.toFixed(2)}</p>
                                <p style="font-size: 9pt; color: #666;">Outstanding BV: ${totalOutstanding.bv}</p>
                            </div>
                            <div class="total-item">
                                <strong>Outstanding (CP):</strong>
                                <p style="font-size: 14pt; color: #e74c3c; margin-top: 5px;">N$${totalOutstanding.cp.toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong style="font-size: 12pt; color: #27ae60;">TOTAL CASH COLLECTED: N$${(totalPaid.dp + totalPaid.cp).toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            return statementData;
        }
        
        function generateDailyStatementHTML(data, isThermal) {
            if (isThermal) {
                // Thermal receipt format - compact and bold
                return `
                    <div style="font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold;">
                        <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                            <div style="font-size: 11pt; font-weight: bold;">DYNAPHARM NAMIBIA</div>
                            <div style="font-size: 9pt;">DAILY STATEMENT</div>
                            <div style="font-size: 8pt;">${new Date().toLocaleDateString('en-GB')}</div>
                        </div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">SUMMARY</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total Clients:</span><span>${data.totalClientsToday}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Members:</span><span>${data.totalMembers}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Referred:</span><span>${data.totalReferred}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">REVENUE</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total DP:</span><span>N$${data.totalRevenue.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total CP:</span><span>N$${data.totalRevenue.cp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Total BV:</span><span>${data.totalRevenue.bv}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">CASH COLLECTED</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid DP:</span><span>N$${data.totalPaid.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Paid CP:</span><span>N$${data.totalPaid.cp.toFixed(2)}</span>
                            </div>
                            <div style="border-top: 1px solid #000; margin: 4px 0;"></div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0; font-size: 11pt;">
                                <span>TOTAL:</span><span>N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>
                        
                        <div style="margin: 8px 0; font-size: 9pt;">
                            <div style="border-bottom: 1px solid #000; margin-bottom: 4px; padding-bottom: 2px; font-weight: bold;">OUTSTANDING</div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding DP:</span><span>N$${data.totalOutstanding.dp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                <span>Outstanding CP:</span><span>N$${data.totalOutstanding.cp.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 8pt;">
                            <div>HEALTH | WEALTH | FREEDOM</div>
                        </div>
                    </div>
                `;
            } else {
                // A4 format - full detailed report
                return `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <!-- Summary Statistics -->
                        <div style="background: white; border: 2px solid #c41e3a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">ðŸ“Š DAILY SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalClientsToday}</h3>
                                    <p style="color: #666; font-size: 9pt;">Total Clients</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalMembers}</h3>
                                    <p style="color: #666; font-size: 9pt;">Registered Members</p>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border-left: 4px solid #c41e3a; text-align: center;">
                                    <h3 style="color: #c41e3a; font-size: 24pt; margin-bottom: 5px;">${data.totalReferred}</h3>
                                    <p style="color: #666; font-size: 9pt;">Referred Clients</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consultant Breakdown -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">ðŸ‘¨â€âš•ï¸ CONSULTANTS BREAKDOWN</h3>
                            ${Object.keys(data.consultantStats).map(consultantName => {
                                const stats = data.consultantStats[consultantName];
                                return `
                                <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                                    <h4 style="color: #2c3e50; margin-bottom: 10px;">ðŸ‘¨â€âš•ï¸ ${consultantName}</h4>
                                    <p style="margin-bottom: 10px; color: #666;">
                                        <strong>Total:</strong> ${stats.totalClients} | 
                                        <strong>Members:</strong> ${stats.members} | 
                                        <strong>Referred:</strong> ${stats.referred}
                                    </p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                        <thead>
                                            <tr style="background: #e3f2fd;">
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Client Name</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Type</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referral NB</th>
                                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Referred By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${stats.clients.map((client, idx) => `
                                                <tr>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.name}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.type}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referralNb}</td>
                                                    <td style="padding: 5px 6px; border: 1px solid #ddd;">${client.referredBy}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Products Dispensed -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="background: #c41e3a; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px;">ðŸ“¦ PRODUCTS DISPENSED TODAY</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                <thead>
                                    <tr style="background: #e8f5e9;">
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Product Name</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (DP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Revenue (CP)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(data.productDispensed).map((product, idx) => `
                                        <tr>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${idx + 1}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">${product.name}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">
                                                ${product.quantity !== undefined ? 
                                                    `${product.quantity} units` : 
                                                    `${product.fullCount} full, ${product.partialCount - product.fullCount} partial`}
                                            </td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.dp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;">N$${product.revenue.cp.toFixed(2)}</td>
                                            <td style="padding: 5px 6px; border: 1px solid #ddd;"><strong>N$${(product.revenue.dp + product.revenue.cp).toFixed(2)}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Financial Summary -->
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                            <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">ðŸ’° FINANCIAL SUMMARY</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (DP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.dp.toFixed(2)}</p>
                                    <p style="font-size: 9pt; color: #666;">Total BV: ${data.totalRevenue.bv}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Revenue (CP):</strong>
                                    <p style="font-size: 14pt; color: #27ae60; margin-top: 5px;">N$${data.totalRevenue.cp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (DP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.dp.toFixed(2)}</p>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                                    <strong style="color: #c41e3a;">Total Paid (CP):</strong>
                                    <p style="font-size: 14pt; color: #2196f3; margin-top: 5px;">N$${data.totalPaid.cp.toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                                <strong style="font-size: 14pt; color: #27ae60;">TOTAL CASH: N$${(data.totalPaid.dp + data.totalPaid.cp).toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // For preview (non-thermal), just return empty for now - modal will use direct content
            return '';
        }
        
        function printDailyStatementA4() {
            // Close modal first
            closeModal('dailyStatementModal');
            // Use the existing A4 print function logic
            printDailyStatement();
        }
        
        function printDailyStatementThermal() {
            // Close modal first
            closeModal('dailyStatementModal');
            
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${generateDailyStatementHTML(statementData, true)}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function printDailyStatement() {
            const statementData = generateDailyStatementData();
            if (!statementData) return;
            
            // Create A4 print window with full statement
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Daily Statement - ${new Date().toLocaleDateString('en-GB')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.4;
                            color: #333;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 20pt;
                            margin-bottom: 5px;
                        }
                        
                        .header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DYNAPHARM INTERNATIONAL NAMIBIA</h1>
                        <p>DAILY DISPENSING STATEMENT</p>
                        <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    ${generateDailyStatementHTML(statementData, false)}
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #c41e3a; font-size: 9pt; color: #666;">
                        <p><strong>Statement Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
                        <p style="margin-top: 10px; font-weight: bold;">HEALTH | WEALTH | FREEDOM</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function toggleDispense(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (report && report.medicines && report.medicines[medIndex]) {
        if (!hasActionPermission('dispense')) { alert('You do not have permission to dispense.'); return; }
                const medicine = report.medicines[medIndex];
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                
        // For packages, guide for partial/all dispensing
        if (isPackage) {
            const packageProducts = price.products || [];
            const allGiven = packageProducts.every(product => 
                medicine.packageStatus && medicine.packageStatus[product] === 'given'
            );
            if (!allGiven) {
                const doAll = confirm('Some items in this package are not marked as Given.\n\nOK: Mark all remaining as Given and dispense the full package.\nCancel: Keep partial (do not set as fully dispensed).');
                if (!doAll) { return; }
                medicine.packageStatus = medicine.packageStatus || {};
                packageProducts.forEach(p => { if (medicine.packageStatus[p] !== 'given') medicine.packageStatus[p] = 'given'; });
            }
        }

        // Due-out/backorder check when dispensing
        if (!medicine.dispensed) {
            try {
                const inv = (window.inventory && window.inventory[medicine.name]) ? window.inventory[medicine.name] : null;
                const neededQty = Number(medicine.quantity || 1);
                const available = inv ? Number(inv.currentStock || 0) : Infinity;
                if (available < neededQty) {
                    const proceed = confirm(`Insufficient stock for ${medicine.name}.\nAvailable: ${available}, Needed: ${neededQty}.\n\nOK: Mark as Due-out\nCancel: Abort dispensing`);
                    if (proceed) {
                        medicine.dueOut = Math.max(0, neededQty - available);
                        try { const res = await apiRequest('/reports', 'PUT', report); if (res?.success) { const idx = reports.findIndex(r=>r.id===reportId); if (idx!==-1) reports[idx]=report; displayPrescriptions(); alert('ðŸ“¦ Item marked as Due-out.'); } } catch(_){ }
                        return;
                    } else {
                        return;
                    }
                }
            } catch(_){ }
        }
                
                medicine.dispensed = !medicine.dispensed;
                
                // Update dispensed timestamp
                if (medicine.dispensed) {
                    medicine.dispensedBy = currentUser.fullName;
                    medicine.dispensedAt = new Date().toISOString();
            // FEFO lot assignment if available
            try {
                const lot = pickFefoLot(medicine.name, Number(medicine.quantity||1));
                if (lot) { medicine.lotBatch = lot.batch; medicine.lotExpiry = lot.expiry; }
            } catch(_){ }
            try { adjustInventoryForDispense(report, medicine, Number(medicine.quantity||1)); } catch(_){ }
                } else {
                    delete medicine.dispensedBy;
                    delete medicine.dispensedAt;
                    delete medicine.paid;
                    delete medicine.paidBy;
                    delete medicine.paidAt;
                    
                    // For packages, also reset individual product statuses
                    if (isPackage) {
                        const packageProducts = price.products || [];
                        packageProducts.forEach(product => {
                            if (medicine.packageStatus) {
                                medicine.packageStatus[product] = 'not_given';
                            }
                        });
                    }
                }
                
                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        // Update local data
                        const index = reports.findIndex(r => r.id === reportId);
                        if (index !== -1) {
                            reports[index] = report;
                        }
                        displayPrescriptions();
                        alert(`âœ… ${isPackage ? 'Package' : 'Medicine'} status updated successfully`);
                    } else {
                        console.error('Backend error:', result);
                        alert('Error updating prescription: ' + (result.error || result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            } else {
                alert('Report or medicine not found');
            }
        }

        async function togglePayment(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) {
                alert('Report or medicine not found');
                return;
            }
            
            const medicine = report.medicines[medIndex];
            const client = clients.find(c => c.referenceNumber === report.clientId);
            
            // If marking as paid, show payment details dialog
            if (!medicine.paid) {
                const price = findProductPrice(medicine.name);
                const isPackage = price.isPackage;
                let amount;
                
                if (isPackage) {
                    const packagePricing = calculatePackagePricing(medicine, client.membershipStatus);
                    amount = client.membershipStatus === 'member' ? packagePricing.dp : packagePricing.cp;
                } else {
                    amount = client.membershipStatus === 'member' ? price.dp : price.cp;
                }
                
                // Show payment method selection
                const paymentMethod = prompt(`Payment for: ${medicine.name}\nAmount: N$${amount}\n\nEnter payment method:\n1 - Cash\n2 - Card\n3 - Mobile Money\n4 - Bank Transfer\n\nEnter number (1-4):`);
                
                if (!paymentMethod) return; // Cancelled
                
                const methods = { '1': 'Cash', '2': 'Card', '3': 'Mobile Money', '4': 'Bank Transfer' };
                const method = methods[paymentMethod] || 'Cash';
                
                // Initialize payment history if not exists
                if (!medicine.paymentHistory) {
                    medicine.paymentHistory = [];
                }
                
                // Add payment record
                medicine.paymentHistory.push({
                    amount: amount,
                    method: method,
                    paidBy: currentUser.fullName,
                    paidAt: new Date().toISOString(),
                    reference: 'PAY' + Date.now()
                });
                
                medicine.paid = true;
                medicine.paidBy = currentUser.fullName;
                medicine.paidAt = new Date().toISOString();
                medicine.paymentMethod = method;
                medicine.amountPaid = amount;
            } else {
                // Unpay - remove payment info
                medicine.paid = false;
                delete medicine.paidBy;
                delete medicine.paidAt;
                delete medicine.paymentMethod;
                delete medicine.amountPaid;
            }
            
            try {
                const result = await apiRequest('/reports', 'PUT', report);
                if (result.success) {
                    const index = reports.findIndex(r => r.id === reportId);
                    if (index !== -1) {
                        reports[index] = report;
                    }
                    displayPrescriptions();
                    if (medicine.paid) {
                        alert(`âœ… Payment recorded successfully\nMethod: ${medicine.paymentMethod}\nAmount: N$${medicine.amountPaid}`);
                    }
                } else {
                    console.error('Backend error:', result);
                    alert('Error updating payment: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error updating payment. Please try again.');
            }
        }

        function viewPaymentHistory(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            if (!report || !report.medicines || !report.medicines[medIndex]) return;
            
            const medicine = report.medicines[medIndex];
            
            if (!medicine.paymentHistory || medicine.paymentHistory.length === 0) {
                alert('No payment history available for this item');
                return;
            }
            
            let historyHTML = `
                <div style="padding: 20px;">
                    <h3>Payment History: ${medicine.name}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Amount</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Method</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Received By</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Reference</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${medicine.paymentHistory.map(payment => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${new Date(payment.paidAt).toLocaleString('en-GB')}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">N$${payment.amount.toFixed(2)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.method}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.paidBy}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${payment.reference}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="printPaymentReceipt('${reportId}', ${medIndex})">ðŸ§¾ Print Receipt</button>
                    </div>
                </div>
            `;
            
            alert(historyHTML.replace(/<[^>]*>/g, '\\n').replace(/\\n+/g, '\\n'));
        }

        function printPaymentReceipt(reportId, medIndex) {
            const report = reports.find(r => r.id === reportId);
            const client = clients.find(c => c.referenceNumber === report.clientId);
            const medicine = report.medicines[medIndex];
            
            if (!medicine || !medicine.paymentHistory) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Payment Receipt</title>
                    <style>
                        @page { size: 80mm auto; margin: 0; }
                        body { font-family: 'Courier New', monospace; font-size: 10pt; font-weight: bold; padding: 5mm; width: 80mm; background: #fff; }
                        .center { text-align: center; }
                        .divider { border-top: 1px dashed #c41e3a; margin: 6px 0; }
                        .info-item { margin: 8px 0; font-size: 9pt; }
                        .info-item strong { color: #c41e3a; }
                        .amount { color: #27ae60; font-weight: bold; font-size: 10pt; }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 5px;">
                        ${generateLogoSVG(60, 40)}
                    </div>
                    
                    <div class="center" style="border-bottom: 2px solid #c41e3a; padding-bottom: 8px; margin-bottom: 10px; background: linear-gradient(135deg, rgba(196,30,58,0.1) 0%, rgba(139,0,0,0.1) 100%); border-radius: 4px;">
                        <div style="font-size: 12pt; color: #c41e3a; font-weight: 900;">DYNAPHARM NAMIBIA</div>
                        <div style="font-size: 9pt; color: #c41e3a; font-weight: bold;">PAYMENT RECEIPT</div>
                        <div style="font-size: 8pt; color: #666;">${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    
                    <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #c41e3a; font-size: 9pt;">
                        <div><strong>Client:</strong> ${client.fullName}</div>
                        <div><strong>Report:</strong> ${report.id}</div>
                        <div><strong>Product:</strong> ${medicine.name}</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    ${medicine.paymentHistory.map(payment => `
                        <div class="info-item" style="background: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #c41e3a;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Amount:</strong></span>
                                <span class="amount">N$${payment.amount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Method:</strong></span>
                                <span>${payment.method}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span><strong>Ref:</strong></span>
                                <span>${payment.reference}</span>
                            </div>
                            <div style="font-size: 8pt; margin-top: 3px; color: #666; text-align: right;">
                                ${new Date(payment.paidAt).toLocaleString('en-GB')}
                            </div>
                        </div>
                    `).join('<div class="divider"></div>')}
                    
                    <div class="divider"></div>
                    
                    <div class="center" style="margin-top: 12px; padding-top: 8px; border-top: 2px solid #c41e3a; font-size: 8pt;">
                        <div style="color: #c41e3a; font-weight: bold;">HEALTH | WEALTH | FREEDOM</div>
                        <div style="margin-top: 3px;">Thank you for choosing Dynapharm!</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function markDispensed(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (report) {
                // FEFO deduction across barcode/batch stock first
                const products = (report.medicines || []).map(m => ({ name: m.name, quantity: m.quantity || 1 }));
                const branchId = (currentUser && currentUser.branch) || (selectedBranch && selectedBranch.id) || 'unknown_branch';
                const userName = (currentUser && currentUser.fullName) || 'system';
                const fefoResult = await fefoDispenseProducts(products, branchId, userName, report.id);
                if (!fefoResult.success) {
                    alert('âš ï¸ FEFO deduction issues for prescription:\n' + fefoResult.errors.join('\n'));
                }

                // Also update simple inventory counters for legacy displays
                const invReduction = reduceInventoryForProducts(products, userName, report.id);
                if (!invReduction.success && (!fefoResult || !fefoResult.success)) {
                    // Only block if both mechanisms report failures across the board
                    alert('âš ï¸ Stock deduction issues persisted. Please review inventory.');
                }

                report.dispensed = true;
                report.dispensedBy = currentUser.fullName;
                report.dispensedAt = new Date().toISOString();
                
                // Record department event
                recordDepartmentEvent('prescription_dispensed', {
                    reportId: report.id,
                    clientId: report.clientId,
                    medicines: products
                });

                try {
                    const result = await apiRequest('/reports', 'PUT', report);
                    if (result.success) {
                        alert('âœ… Prescription marked as dispensed');
                        try { localStorage.setItem('dyna_reports', JSON.stringify(reports)); } catch(_) {}
                        try { window.dispatchEvent(new CustomEvent('reports:updated', { detail: { id: report.id, action: 'dispensed' } })); } catch(_) {}
                        try { fetch('/api/realtime_publish', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ channel: 'reports', event: { id: report.id, action: 'dispensed', ts: Date.now() } }) }); } catch(_) {}
                        try {
                            const m = document.querySelector('meta[name="rt-base"]');
                            const rtBase = m && m.content && m.content.trim();
                            if (rtBase) {
                                fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ event: { id: report.id, action: 'dispensed', ts: Date.now() } })
                                });
                            }
                        } catch(_) {}
                        displayPrescriptions();
                        if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                            try { if (typeof displayMyReports === 'function') displayMyReports(); } catch(e) { console.debug('displayMyReports error:', e); }
                        }
                    } else {
                        alert('Error updating prescription: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error updating prescription:', error);
                    alert('Error updating prescription. Please try again.');
                }
            }
        }

        function showAddUser() {
            loadBranches();
            loadBranchCheckboxes();
            document.getElementById('addUserModal').style.display = 'block';
        }

        function loadBranchCheckboxes() {
            const branchCheckboxes = document.getElementById('branchCheckboxes');
            branchCheckboxes.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="additionalBranches" value="${branch.id}" style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                branchCheckboxes.appendChild(checkboxDiv);
            });
        }

        function toggleAllBranchesAccess() {
            const checkbox = document.getElementById('allBranchesCheckbox');
            const branchSelect = document.getElementById('userBranchSelect');
            const additionalBranches = document.getElementById('additionalBranches');
            
            if (checkbox && checkbox.checked) {
                if (branchSelect) branchSelect.disabled = true;
                if (additionalBranches) additionalBranches.style.display = 'none';
            } else {
                if (branchSelect) branchSelect.disabled = false;
                // Check if role is consultant or sales_staff to show additional branches
                const role = document.querySelector('select[name="role"]')?.value;
                if ((role === 'consultant' || role === 'sales_staff') && additionalBranches) {
                    additionalBranches.style.display = 'block';
                }
            }
        }
        
        function updatePortalAccessByRole() {
            const roleSelect = document.querySelector('select[name="role"]');
            const role = roleSelect?.value;
            if (!role) return;
            
            const defaultPortals = ROLE_PORTAL_ACCESS[role] || ['client'];
            const portalCheckboxes = document.querySelectorAll('input[name="portalAccess"]');
            
            portalCheckboxes.forEach(cb => {
                cb.checked = defaultPortals.includes(cb.value);
            });
        }
        
        function toggleAdditionalBranches() {
            const roleSelect = document.querySelector('select[name="role"]');
            const additionalBranches = document.getElementById('additionalBranches');
            
            if (roleSelect.value === 'consultant' || roleSelect.value === 'sales_staff') {
                additionalBranches.style.display = 'block';
            } else {
                additionalBranches.style.display = 'none';
                // Clear all checkboxes when not consultant or sales_staff
                const checkboxes = document.querySelectorAll('input[name="additionalBranches"]');
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Get selected additional branches for consultants
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="additionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));
            
            // Get selected portal access
            const portalAccess = [];
            const portalCheckboxes = document.querySelectorAll('input[name="portalAccess"]:checked');
            portalCheckboxes.forEach(cb => portalAccess.push(cb.value));
            
            // Determine branch access
            const allBranchesAccess = document.getElementById('allBranchesCheckbox').checked;
            const primaryBranch = formData.get('branch') || null;
            
            // Create branches array - primary branch + additional branches
            let allBranches = [];
            if (allBranchesAccess) {
                // User has access to all branches
                allBranches = ['*']; // Special marker for all branches
            } else {
                if (primaryBranch) {
                    allBranches.push(primaryBranch);
                }
            if (formData.get('role') === 'consultant' || formData.get('role') === 'sales_staff') {
                additionalBranches.forEach(branchId => {
                        if (branchId !== primaryBranch && !allBranches.includes(branchId)) {
                        allBranches.push(branchId);
                    }
                });
                }
            }
            
            // Handle photo upload
            let photoBase64 = null;
            const photoFile = document.getElementById('userPhotoInput').files[0];
            if (photoFile) {
                try {
                    photoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(photoFile);
                    });
                } catch (error) {
                    console.error('Error reading photo:', error);
                }
            }
            
            const newUser = {
                id: 'USR' + Date.now(),
                username: formData.get('username'),
                password: formData.get('password'),
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                role: formData.get('role'),
                branch: primaryBranch || null,
                branches: allBranches,
                allBranchesAccess: allBranchesAccess,
                portalAccess: portalAccess.length > 0 ? portalAccess : (ROLE_PORTAL_ACCESS[formData.get('role')] || ['client']),
                photo: photoBase64,
                createdAt: new Date().toISOString()
            };
            
            if (users.find(u => u.username === newUser.username)) {
                alert('Username exists');
                return;
            }
            
            try {
                const result = await apiRequest('/users', 'POST', newUser);
                if (result.success) {
            users.push(newUser);
            try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    // Broadcast user update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: newUser, action: 'created' } }));
                        // Publish to Railway gateway
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: newUser, action: 'created', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        // Publish to Vercel SSE
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: newUser, action: 'created', ts: Date.now() } }) 
                        }).catch(_ => {});
                    } catch (_) {}
                    alert('âœ… User created successfully');
            closeModal('addUserModal');
            this.reset();
                    document.getElementById('userPhotoPreview').style.display = 'none';
                    document.getElementById('userPhotoPreviewImg').src = '';
                    await refreshAllData();
                } else {
                    alert('Error creating user: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user. Please try again.');
            }
        });

        function loadUserList() {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(user => {
                const branchName = branches.find(b => b.id === user.branch)?.name || user.branch;
                const userBranches = user.branches || [user.branch];
                const branchNames = userBranches.map(branchId => 
                    branches.find(b => b.id === branchId)?.name || branchId
                ).join(', ');
                
                const card = document.createElement('div');
                card.className = 'client-card';
                const userPhoto = user.photo ? (typeof user.photo === 'string' && user.photo.startsWith('data:') ? user.photo : `data:image/jpeg;base64,${user.photo}`) : null;
                
                // Check if current user is admin
                const isAdmin = currentUser && currentUser.role === 'admin';
                
                card.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: start;">
                        ${userPhoto ? `<img src="${userPhoto}" alt="${user.fullName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">` : '<div style="width: 80px; height: 80px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px;">ðŸ‘¤</div>'}
                        <div style="flex: 1;">
                    <h4>${user.fullName} (${user.username})</h4>
                    <p>Role: ${user.role} | Primary Branch: ${branchName}</p>
                    <p>All Branches: ${branchNames}</p>
                    <p>Email: ${user.email || 'Not provided'} | Phone: ${user.phone || 'Not provided'}</p>
                    ${isAdmin ? `<p id="password-display-${user.id}" style="margin-top: 5px; font-family: monospace; color: #666; display: none;">Password: <span id="password-value-${user.id}">${user.password || 'N/A'}</span></p>` : ''}
                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${isAdmin ? `
                            <button class="btn btn-info" onclick="togglePasswordView('${user.id}', this)" id="password-toggle-${user.id}" style="font-size: 0.85rem; padding: 6px 12px;">ðŸ‘ï¸ View Password</button>
                            <button class="btn btn-primary" onclick="showResetPasswordModal('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">ðŸ”‘ Reset Password</button>
                        ` : ''}
                        ${user.username !== 'admin' ? `
                            <button class="btn btn-warning" onclick="editUserBranches('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">Edit Branches</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 0.85rem; padding: 6px 12px;">ðŸ—‘ï¸ Delete</button>
                        ` : '<p style="color: #27ae60; margin: 0;">Protected</p>'}
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function togglePasswordView(userId, buttonElement) {
            const passwordDisplay = document.getElementById(`password-display-${userId}`);
            const passwordValue = document.getElementById(`password-value-${userId}`);
            const button = buttonElement || document.getElementById(`password-toggle-${userId}`);
            
            if (!passwordDisplay || !passwordValue) return;
            
            if (passwordDisplay.style.display === 'none' || passwordDisplay.style.display === '') {
                passwordDisplay.style.display = 'block';
                if (button) button.textContent = 'ðŸ™ˆ Hide Password';
            } else {
                passwordDisplay.style.display = 'none';
                if (button) button.textContent = 'ðŸ‘ï¸ View Password';
            }
        }

        function showResetPasswordModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            const userIdInput = document.getElementById('resetPasswordUserId');
            const usernameSpan = document.getElementById('resetPasswordUsername');
            const fullNameSpan = document.getElementById('resetPasswordFullName');
            const modal = document.getElementById('resetPasswordModal');
            
            if (!userIdInput || !usernameSpan || !fullNameSpan || !modal) {
                console.error('Reset password modal elements not found');
                alert('Error: Reset password modal not properly initialized');
                return;
            }
            
            userIdInput.value = userId;
            usernameSpan.textContent = user.username;
            fullNameSpan.textContent = user.fullName;
            modal.style.display = 'block';
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                const deletedUser = users.find(u => u.id === userId);
                try {
                    const result = await apiRequest(`/users?id=${userId}`, 'DELETE');
                    if (result.success) {
                users = users.filter(u => u.id !== userId);
                try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                        // Broadcast user update event for real-time sync
                        try {
                            window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: deletedUser, action: 'deleted' } }));
                            const m = document.querySelector('meta[name="rt-base"]');
                            const rtBase = m && m.content && m.content.trim();
                            if (rtBase) {
                                fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ event: { type: 'users:updated', user: deletedUser, action: 'deleted', ts: Date.now() } })
                                }).catch(_ => {});
                            }
                            fetch('/api/realtime_publish', { 
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ channel: 'users', event: { user: deletedUser, action: 'deleted', ts: Date.now() } }) 
                            }).catch(_ => {});
                        } catch (_) {}
                        alert('âœ… User deleted successfully');
                        await refreshAllData();
                    } else {
                        alert('Error deleting user: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user. Please try again.');
                }
            }
        }

        let editingUserId = null;

        function editUserBranches(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            
            // Show user info
            document.getElementById('editUserInfo').innerHTML = `
                <h4>${user.fullName} (${user.username})</h4>
                <p>Role: ${user.role}</p>
            `;

            // Populate primary branch dropdown
            const primarySelect = document.getElementById('editPrimaryBranch');
            primarySelect.innerHTML = '<option value="">Select Primary Branch</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                if (branch.id === user.branch) {
                    option.selected = true;
                }
                primarySelect.appendChild(option);
            });

            // Populate additional branches checkboxes
            const checkboxesDiv = document.getElementById('editBranchCheckboxes');
            checkboxesDiv.innerHTML = '';
            
            branches.forEach(branch => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                
                const isChecked = user.branches && user.branches.includes(branch.id) && branch.id !== user.branch;
                
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="editAdditionalBranches" value="${branch.id}" ${isChecked ? 'checked' : ''} style="margin-right: 8px;">
                        <span>${branch.name}</span>
                    </label>
                `;
                checkboxesDiv.appendChild(checkboxDiv);
            });

            // Show/hide additional branches based on role
            if (user.role === 'consultant') {
                checkboxesDiv.style.display = 'block';
            } else {
                checkboxesDiv.style.display = 'none';
            }

            document.getElementById('editBranchesModal').style.display = 'block';
        }

        document.getElementById('editBranchesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (!editingUserId) return;

            const user = users.find(u => u.id === editingUserId);
            if (!user) return;

            // Get selected additional branches
            const additionalBranches = [];
            const checkboxes = document.querySelectorAll('input[name="editAdditionalBranches"]:checked');
            checkboxes.forEach(cb => additionalBranches.push(cb.value));

            // Create branches array
            const allBranches = [formData.get('primaryBranch')];
            if (user.role === 'consultant') {
                additionalBranches.forEach(branchId => {
                    if (branchId !== formData.get('primaryBranch')) {
                        allBranches.push(branchId);
                    }
                });
            }

            // Update user
            const updatedUser = {
                ...user,
                branch: formData.get('primaryBranch'),
                branches: allBranches
            };

            try {
                const result = await apiRequest('/users', 'PUT', updatedUser);
                if (result.success) {
                    // Update local users array
                    const userIndex = users.findIndex(u => u.id === editingUserId);
                    if (userIndex !== -1) {
                        users[userIndex] = updatedUser;
                    }
                    try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    // Broadcast user update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: updatedUser, action: 'updated' } }));
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: updatedUser, action: 'updated', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: updatedUser, action: 'updated', ts: Date.now() } }) 
                        }).catch(_ => {});
                    } catch (_) {}
                    alert('âœ… User branches updated successfully');
                    closeModal('editBranchesModal');
                loadUserList();
                } else {
                    alert('Error updating user branches: ' + result.message);
            }
            } catch (error) {
                console.error('Error updating user branches:', error);
                alert('Error updating user branches. Please try again.');
        }
        });

                function showChangePassword() {
            const usernameField = document.querySelector('#changePasswordForm input[name="username"]');
            if (usernameField && currentUser) {
                usernameField.value = currentUser.username || currentUser.id || '';
            }
            document.getElementById('changePasswordModal').style.display = 'block';                                                                             
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (formData.get('currentPassword') !== currentUser.password) {
                alert('Current password incorrect');
                return;
            }
            
            if (formData.get('newPassword') !== formData.get('confirmPassword')) {
                alert('Passwords do not match');
                return;
            }
            
            currentUser.password = formData.get('newPassword');
            
            try {
                const result = await apiRequest('/users', 'PUT', currentUser);
                if (result.success) {
            const index = users.findIndex(u => u.id === currentUser.id);
            users[index] = currentUser;
            try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    alert('âœ… Password changed successfully');
            closeModal('changePasswordModal');
            this.reset();
                } else {
                    alert('Error changing password: ' + result.message);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password. Please try again.');
            }
        });

        // Admin Reset Password Form Handler
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        if (resetPasswordForm) {
            resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Check if current user is admin
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Only administrators can reset user passwords');
                return;
            }
            
            const userId = formData.get('userId');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (!newPassword || newPassword.length < 3) {
                alert('Password must be at least 3 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            // Update user password
            const updatedUser = {
                ...user,
                password: newPassword
            };
            
            try {
                const result = await apiRequest('/users', 'PUT', updatedUser);
                if (result.success) {
                    // Update local users array
                    const userIndex = users.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        users[userIndex] = updatedUser;
                    }
                    try { localStorage.setItem('dyna_users', JSON.stringify(users)); } catch (e) {}
                    
                    // Broadcast user update event for real-time sync
                    try {
                        window.dispatchEvent(new CustomEvent('users:updated', { detail: { user: updatedUser, action: 'password_reset' } }));
                        const m = document.querySelector('meta[name="rt-base"]');
                        const rtBase = m && m.content && m.content.trim();
                        if (rtBase) {
                            fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ event: { type: 'users:updated', user: updatedUser, action: 'password_reset', ts: Date.now() } })
                            }).catch(_ => {});
                        }
                        fetch('/api/realtime_publish', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ channel: 'users', event: { user: updatedUser, action: 'password_reset', ts: Date.now() } }) 
                        }).catch(_ => {});
                    } catch (_) {}
                    
                    alert(`âœ… Password reset successfully for ${user.fullName} (${user.username})`);
                    closeModal('resetPasswordModal');
                    this.reset();
                    loadUserList(); // Refresh user list to show updated password
                } else {
                    alert('Error resetting password: ' + result.message);
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Error resetting password. Please try again.');
            }
        });
        }

        async function addBranch() {
            const name = document.getElementById('newBranchName').value;
            if (!name) {
                alert('Enter branch name');
                return;
            }
            
            const branch = {
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name: name
            };
            
            try {
                const result = await apiRequest('/branches', 'POST', branch);
                if (result.success) {
            branches.push(branch);
            document.getElementById('newBranchName').value = '';
                    alert('âœ… Branch added successfully');
                    await refreshAllData();
                } else {
                    alert('Error adding branch: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding branch:', error);
                alert('Error adding branch. Please try again.');
            }
        }

        function loadBranchListAdmin() {
            const list = document.getElementById('branchList');
            list.innerHTML = '';
            branches.forEach(branch => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <h4>${branch.name}</h4>
                    <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')">Delete</button>
                `;
                list.appendChild(card);
            });
        }

        async function deleteBranch(branchId) {
            if (confirm('Delete branch?')) {
                try {
                    const result = await apiRequest(`/branches?id=${branchId}`, 'DELETE');
                    if (result.success) {
                branches = branches.filter(b => b.id !== branchId);
                        alert('âœ… Branch deleted successfully');
                        await refreshAllData();
                    } else {
                        alert('Error deleting branch: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting branch:', error);
                    alert('Error deleting branch. Please try again.');
                }
            }
        }

        // Export all data to JSON file
        function exportData() {
            const data = {
                clients: clients || [],
                users: users || [],
                branches: branches || [],
                reports: reports || [],
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dynapharm-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('dataStatus').innerHTML = 
                `<p style="color: green;">âœ… Data exported successfully!</p>` +
                `<p>Clients: ${data.clients.length} | Users: ${data.users.length} | Branches: ${data.branches.length} | Reports: ${data.reports.length}</p>`;
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.clients) clients = data.clients;
                    if (data.users) users = data.users;
                    if (data.branches) branches = data.branches;
                    if (data.reports) reports = data.reports;
                    
                    // Save to localStorage
                    if (clients) localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    if (users) localStorage.setItem('dyna_users', JSON.stringify(users));
                    if (branches) localStorage.setItem('dyna_branches', JSON.stringify(branches));
                    if (reports) localStorage.setItem('dyna_reports', JSON.stringify(reports));
                    
                    document.getElementById('dataStatus').innerHTML = 
                        `<p style="color: green;">âœ… Data imported successfully!</p>` +
                        `<p>Clients: ${clients.length} | Users: ${users.length} | Branches: ${branches.length} | Reports: ${reports.length}</p>` +
                        `<p style="color: orange;">âš ï¸ Please refresh the page to see the changes.</p>`;
                    
                    alert('Data imported successfully! Please refresh the page.');
                } catch (error) {
                    console.error('Import error:', error);
                    document.getElementById('dataStatus').innerHTML = 
                        `<p style="color: red;">âŒ Error importing data: ${error.message}</p>`;
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        let preferredCalendarDate = null;
        let selectedPreferredDate = null;

        function initializeAppointmentPreferences() {
            populatePreferredBranchSelect();

            const hiddenField = document.getElementById('preferredDate');
            const display = document.getElementById('preferredDateDisplay');
            const timeInput = document.getElementById('preferredTime');
            const branchSelect = document.getElementById('preferredBranchSelect');
            const visitTypeEl = document.getElementById('visitType');
            const visitType = visitTypeEl ? (visitTypeEl.value || '') : '';

            // For walk-ins, skip calendar/time init (no calendar needed)
            if (visitType === 'walkin') {
                if (timeInput) timeInput.value = '';
                return;
            }

            const today = new Date();
            const todayIso = today.toISOString().split('T')[0];
            let defaultDate = hiddenField && hiddenField.value ? hiddenField.value : todayIso;

            selectedPreferredDate = defaultDate;
            if (hiddenField) hiddenField.value = defaultDate;
            if (display) {
                try {
                    display.textContent = new Date(defaultDate + 'T00:00:00').toLocaleDateString('en-GB');
                } catch(_) {
                    display.textContent = defaultDate;
                }
            }

            // Suggest next available time if empty
            if (timeInput && !timeInput.value) {
                try {
                    const branchId = (branchSelect && branchSelect.value) || currentBranch || (function(){
                        const cs = document.getElementById('checkupBranchSelect');
                        return cs ? cs.value : '';
                    })();
                    const suggested = getNextAvailableTime(branchId, defaultDate);
                    timeInput.value = suggested || '09:00';
                } catch(_) {
                    timeInput.value = '09:00';
                }
            }

            preferredCalendarDate = new Date(defaultDate + 'T00:00:00');
            if (isNaN(preferredCalendarDate.getTime())) {
                preferredCalendarDate = new Date();
            }
            renderPreferredDateCalendar(preferredCalendarDate);

            const prevBtn = document.getElementById('preferredPrevMonth');
            const nextBtn = document.getElementById('preferredNextMonth');
            if (prevBtn) {
                prevBtn.onclick = function() {
                    if (!preferredCalendarDate) preferredCalendarDate = new Date();
                    preferredCalendarDate.setMonth(preferredCalendarDate.getMonth() - 1);
                    renderPreferredDateCalendar(preferredCalendarDate);
                };
            }
            if (nextBtn) {
                nextBtn.onclick = function() {
                    if (!preferredCalendarDate) preferredCalendarDate = new Date();
                    preferredCalendarDate.setMonth(preferredCalendarDate.getMonth() + 1);
                    renderPreferredDateCalendar(preferredCalendarDate);
                };
            }

            if (branchSelect) {
                branchSelect.onchange = function(e) {
                    if (e.target.value) {
                        currentBranch = e.target.value;
                        const checkSel = document.getElementById('checkupBranchSelect');
                        if (checkSel && checkSel.value !== e.target.value) {
                            checkSel.value = e.target.value;
                        }
                        // Recompute suggested time on branch change
                        try {
                             const suggested = getNextAvailableTime(e.target.value, selectedPreferredDate);
                             if (timeInput && suggested) timeInput.value = suggested;
                        } catch(_){ }
                    }
                };

                if (currentBranch && branchSelect.value !== currentBranch) {
                    branchSelect.value = currentBranch;
                } else if (!branchSelect.value) {
                    const checkSel = document.getElementById('checkupBranchSelect');
                    if (checkSel && checkSel.value) {
                        branchSelect.value = checkSel.value;
                    }
                }
            }
        }

        function populatePreferredBranchSelect() {
            const select = document.getElementById('preferredBranchSelect');
            if (!select) return;

            const previousValue = select.value;
            select.innerHTML = '<option value="">Select Branch</option>';

            (branches || []).forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                select.appendChild(option);
            });

            const fallbackValue = previousValue || currentBranch || (function(){
                const checkSel = document.getElementById('checkupBranchSelect');
                return checkSel ? checkSel.value : '';
            })();

            if (fallbackValue && select.querySelector(`option[value="${fallbackValue}"]`)) {
                select.value = fallbackValue;
            }
        }

        function renderPreferredDateCalendar(baseDate) {
            const grid = document.getElementById('preferredCalendarGrid');
            const label = document.getElementById('preferredCalendarLabel');
            if (!grid || !label) return;

            const workingDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            label.textContent = `${monthNames[workingDate.getMonth()]} ${workingDate.getFullYear()}`;

            const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const todayIso = new Date().toISOString().split('T')[0];
            let html = '';

            weekdays.forEach(day => {
                html += `<div class="weekday">${day}</div>`;
            });

            const startDay = workingDate.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div></div>';
            }

            const daysInMonth = new Date(workingDate.getFullYear(), workingDate.getMonth() + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${workingDate.getFullYear()}-${String(workingDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayIso;
                const isSelected = selectedPreferredDate === dateStr;
                const isPast = dateStr < todayIso;
                const classes = ['preferred-calendar-day'];
                if (isSelected) classes.push('selected');
                if (isToday) classes.push('today');

                html += `<button type="button" class="${classes.join(' ')}" data-date="${dateStr}" ${isPast ? 'disabled' : ''}>${day}</button>`;
            }

            grid.innerHTML = html;
            Array.from(grid.querySelectorAll('.preferred-calendar-day[data-date]')).forEach(btn => {
                btn.addEventListener('click', function() {
                    const dateStr = this.getAttribute('data-date');
                    setPreferredDate(dateStr);
                });
            });
        }

        function setPreferredDate(dateStr) {
            selectedPreferredDate = dateStr;
            preferredCalendarDate = new Date(dateStr + 'T00:00:00');
            if (isNaN(preferredCalendarDate.getTime())) {
                preferredCalendarDate = new Date();
            }

            const hiddenField = document.getElementById('preferredDate');
            const display = document.getElementById('preferredDateDisplay');
            if (hiddenField) hiddenField.value = dateStr;
            if (display) {
                try {
                    display.textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-GB');
                } catch(_) {
                    display.textContent = dateStr;
                }
            }

            renderPreferredDateCalendar(preferredCalendarDate);
            // Update suggested time when date changes (only for appointment bookings)
            try {
                const visitType = document.getElementById('visitType')?.value || '';
                if (visitType !== 'walkin') {
                    const branchId = (document.getElementById('preferredBranchSelect')?.value) || currentBranch || (function(){
                        const cs = document.getElementById('checkupBranchSelect');
                        return cs ? cs.value : '';
                    })();
                    const suggested = getNextAvailableTime(branchId, dateStr);
                    if (document.getElementById('preferredTime') && suggested) {
                        document.getElementById('preferredTime').value = suggested;
                    }
                }
            } catch(_){ }
        }

        // Helpers: find next available time slot for a branch/date
        function getNextAvailableTime(branchId, dateStr) {
            try {
                if (!dateStr) return '';
                const usedTimes = (appointments || []).filter(function(a){ return a && a.branch === branchId && a.date === dateStr; })
                    .map(function(a){ return a.time; });
                const slots = generateDailyTimeSlots();
                for (var i = 0; i < slots.length; i++) {
                    if (usedTimes.indexOf(slots[i]) === -1) return slots[i];
                }
                return slots[0] || '';
            } catch(_){ return ''; }
        }

        function generateDailyTimeSlots() {
            var slots = [];
            try {
                var windows = timeSlots || {};
                var ranges = [windows.morning, windows.afternoon].filter(Boolean);
                ranges.forEach(function(range){
                    var start = range.start;
                    var end = range.end;
                    var interval = Number(range.interval || 30);
                    var cursor = start;
                    while (cursor <= end) {
                        slots.push(cursor);
                        // increment HH:MM by interval minutes
                        var parts = cursor.split(':');
                        var h = parseInt(parts[0], 10);
                        var m = parseInt(parts[1], 10) + interval;
                        while (m >= 60) { h += 1; m -= 60; }
                        var hh = String(h).padStart(2, '0');
                        var mm = String(m).padStart(2, '0');
                        cursor = hh + ':' + mm;
                        if (hh + ':' + mm > end) break;
                    }
                });
            } catch(_){ }
            return slots;
        }

        function openClientReg(type) {
            try {
                var visitTypeEl = document.getElementById('visitType');
                if (visitTypeEl) visitTypeEl.value = type || '';
            } catch(_){ }
            var modal = document.getElementById('clientRegModal');
            if (modal) {
                if (type === 'appointment') {
                    modal.classList.add('mode-appointment');
                } else {
                    modal.classList.remove('mode-appointment');
                }
                modal.style.display = 'block';
            }
            initializeAppointmentPreferences();
        }

        // Unified print helper for consistent printing across portals
        function openPrintWindow(title, bodyHTML, options) {
            var opts = options || {};
            var pageSize = opts.pageSize || 'A4';
            var pageMargin = opts.pageMargin || '10mm';
            var fontSize = opts.fontSize || '10pt';
            var extraStyles = opts.extraStyles || '';
            var w = window.open('', '_blank');
            if (!w) { try { alert('Please allow popups to print.'); } catch(_){} return; }
            w.document.write(
                '<!DOCTYPE html>'+
                '<html><head><meta charset="UTF-8">'+
                '<title>'+(title||'Print')+'</title>'+
                '<style>@page{size:'+pageSize+';margin:'+pageMargin+';}'+
                'html,body{font-family:Arial,sans-serif;font-size:'+fontSize+';}'+
                '@media print{body{print-color-adjust:exact;-webkit-print-color-adjust:exact;margin:0;}}'+
                '.no-print{display:none !important;}'+
                extraStyles+
                '</style></head><body>'+ (bodyHTML||'') +'</body></html>'
            );
            w.document.close();
            setTimeout(function(){ try { w.print(); } catch(_){} }, 300);
        }

        // Walk-in Sales Functions
        let walkInCart = [];
        const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
        
        // Distributors Management with IndexedDB for large datasets
        let distributors = [];
        
        // IndexedDB setup for distributors
        const dbName = 'DynapharmDB';
        const dbVersion = 4; // Updated to match main database version (v4 adds distributors store)
        const storeName = 'distributors';
        let db = null;
        
        // Initialize IndexedDB
        function initDistributorsDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    // Verify the store exists, if not, force upgrade by reopening with higher version
                    if (!db.objectStoreNames.contains(storeName)) {
                        console.warn('Distributors store not found, forcing upgrade...');
                        db.close();
                        // Force upgrade by opening with a higher version
                        const forceUpgradeVersion = dbVersion + 1;
                        const upgradeRequest = indexedDB.open(dbName, forceUpgradeVersion);
                        upgradeRequest.onerror = () => reject(upgradeRequest.error);
                        upgradeRequest.onsuccess = () => {
                            db = upgradeRequest.result;
                            resolve(db);
                        };
                        upgradeRequest.onupgradeneeded = (event) => {
                            const upgradeDb = event.target.result;
                            // Preserve existing stores and add distributors store
                            if (!upgradeDb.objectStoreNames.contains('clients')) {
                                const clientsStore = upgradeDb.createObjectStore('clients', { keyPath: 'referenceNumber' });
                                try { clientsStore.createIndex('fullName', 'fullName', { unique: false }); } catch(_){}
                                try { clientsStore.createIndex('phone', 'phone', { unique: false }); } catch(_){}
                                try { clientsStore.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                            }
                            if (!upgradeDb.objectStoreNames.contains('stockMovements')) {
                                const movementsStore = upgradeDb.createObjectStore('stockMovements', { keyPath: 'id' });
                                try { movementsStore.createIndex('createdAt', 'createdAt', { unique: false }); } catch(_){}
                                try { movementsStore.createIndex('branchId', 'branchId', { unique: false }); } catch(_){}
                                try { movementsStore.createIndex('type', 'type', { unique: false }); } catch(_){}
                            }
                            if (!upgradeDb.objectStoreNames.contains(storeName)) {
                                const objectStore = upgradeDb.createObjectStore(storeName, { keyPath: 'id' });
                                objectStore.createIndex('distributorCode', 'distributorCode', { unique: false });
                                objectStore.createIndex('distributorName', 'distributorName', { unique: false });
                            }
                        };
                        return;
                    }
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    const oldVersion = event.oldVersion || 0;
                    
                    // Create object store if it doesn't exist
                    if (!db.objectStoreNames.contains(storeName)) {
                        const objectStore = db.createObjectStore(storeName, { keyPath: 'id' });
                        objectStore.createIndex('distributorCode', 'distributorCode', { unique: false });
                        objectStore.createIndex('distributorName', 'distributorName', { unique: false });
                    } else {
                        // If store exists, ensure indexes are present
                        const transaction = event.target.transaction;
                        const objectStore = transaction.objectStore(storeName);
                        
                        // Check and create indexes if they don't exist
                        if (!objectStore.indexNames.contains('distributorCode')) {
                            objectStore.createIndex('distributorCode', 'distributorCode', { unique: false });
                        }
                        if (!objectStore.indexNames.contains('distributorName')) {
                            objectStore.createIndex('distributorName', 'distributorName', { unique: false });
                        }
                    }
                };
            });
        }
        
        // Load distributors from IndexedDB
        async function loadDistributors() {
            try {
                if (!db) await initDistributorsDB();
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        distributors = request.result || [];
                        console.log(`Loaded ${distributors.length} distributors from IndexedDB`);
                        resolve(distributors);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Error loading distributors:', error);
                distributors = [];
                return distributors;
            }
        }
        
        // Save distributors to IndexedDB
        async function saveDistributors() {
            try {
                if (!db) await initDistributorsDB();
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Clear existing data
                await store.clear();
                
                // Add all distributors
                for (const distributor of distributors) {
                    await store.add(distributor);
                }
                
                console.log(`Saved ${distributors.length} distributors to IndexedDB`);
            } catch (error) {
                console.error('Error saving distributors:', error);
                throw error;
            }
        }
        
        // Flag to track if distributors are loaded
        let distributorsLoaded = false;

        // Initialize default distributors on page load
        async function initializeDefaultDistributors() {
            if (distributors.length === 0) {
                // Default distributors from sample data
                const defaultDistributors = [
                    { id: 'DIST001', distributorCode: 'NB001544', distributorName: 'OTTILIE NN SHEYA', mobileNo: '', email: '', commissionRate: 0 },
                    { id: 'DIST002', distributorCode: 'NB001868', distributorName: 'SHANAAZ SULAYMAN', mobileNo: '', email: '', commissionRate: 0 },
                    { id: 'DIST003', distributorCode: 'NB002099', distributorName: 'MONICA KATUMBU', mobileNo: '', email: '', commissionRate: 0 },
                    { id: 'DIST004', distributorCode: 'NB002393', distributorName: 'KARELESTHER TUTEKULA', mobileNo: '', email: '', commissionRate: 0 }
                ];
                
                distributors = [...defaultDistributors];
                try {
                    await saveDistributors();
                    console.log('Initialized default distributors');
                } catch (error) {
                    console.error('Error initializing default distributors:', error);
                }
            }
        }

        // Ensure all required distributor fields are populated and aliases are set
        function normalizeDistributors(list) {
            let changed = false;
            const normalized = (list || []).map((d, i) => {
                const dist = { ...d };
                const hasName = (dist.distributorName || dist.name || '').trim().length > 0;
                const hasCode = (dist.distributorCode || dist.code || '').trim().length > 0;
                // Prefer canonical fields
                if (!dist.distributorName && dist.name) dist.distributorName = dist.name;
                if (!dist.distributorCode && dist.code) dist.distributorCode = dist.code;
                // Try extract NB from name if code missing
                if (!dist.distributorCode && dist.distributorName) {
                    const m = String(dist.distributorName).toUpperCase().match(/NB\d+/);
                    if (m) dist.distributorCode = m[0];
                }
                // Generate fallback code/name if still missing
                if (!dist.distributorCode || String(dist.distributorCode).trim() === '') {
                    dist.distributorCode = 'DIST-' + (dist.id || Date.now() + '-' + i);
                }
                if (!dist.distributorName || String(dist.distributorName).trim() === '') {
                    dist.distributorName = 'Distributor ' + dist.distributorCode;
                }
                // Mirror to aliases used elsewhere
                if (dist.code !== dist.distributorCode) dist.code = dist.distributorCode;
                if (dist.name !== dist.distributorName) dist.name = dist.distributorName;
                // Normalise mobile alias
                if (!dist.mobileNo && dist.mobile) dist.mobileNo = dist.mobile;
                if (!dist.mobile && dist.mobileNo) dist.mobile = dist.mobileNo;
                // Track if anything changed
                if (!hasName || !hasCode || dist.code !== d.code || dist.name !== d.name) changed = true;
                return dist;
            });
            if (changed) console.log('normalizeDistributors: populated required fields for one or more records');
            return normalized;
        }

        function showWalkInSaleModal(customerType) {
            // Reset form
            document.getElementById('walkInSaleForm').reset();
            walkInCart = [];
            document.getElementById('walkInCustomerType').value = 'customer';
            
            // Clear distributor search fields and checkbox
            clearSelectedReferral();
            document.getElementById('distributorReferralDropdown').style.display = 'none';
            document.getElementById('customerNameDropdown').style.display = 'none';
            
            // Reset payment method to cash (default)
            selectWalkInPaymentMethod('cash');
            
            // Update title
            document.getElementById('walkInSaleTitle').textContent = 'ðŸ‘¤ Walk-in Sale';
            
            // Load and display all products with CP pricing
            loadAllProductsForSale();
            
            // Clear cart display
            updateWalkInCart();
            
            // Show modal
            document.getElementById('walkInSaleModal').style.display = 'block';
        }
        
        function selectWalkInPaymentMethod(method) {
            // Update hidden input
            const paymentMethodInput = document.getElementById('walkInPaymentMethod');
            if (paymentMethodInput) {
                paymentMethodInput.value = method;
            }
            
            // Get all payment method buttons
            const buttons = {
                cash: document.getElementById('paymentMethodCash'),
                card: document.getElementById('paymentMethodCard'),
                mobile: document.getElementById('paymentMethodMobile'),
                bank: document.getElementById('paymentMethodBank')
            };
            
            // Reset all buttons to inactive state
            Object.values(buttons).forEach(btn => {
                if (btn) {
                    btn.classList.remove('active');
                    btn.style.border = '2px solid #ddd';
                    btn.style.background = 'white';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            // Activate selected button
            const selectedBtn = buttons[method];
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.border = '2px solid #27ae60';
                selectedBtn.style.background = '#e8f5e9';
                selectedBtn.style.fontWeight = 'bold';
            }
        }
        
        function searchDistributorsForReferral() {
            // Check if distributors are loaded
            if (!distributorsLoaded || distributors.length === 0) {
                console.warn('Distributors not loaded yet, attempting to load...');
                if (typeof loadDistributors === 'function') {
                    loadDistributors().then(() => {
                        distributorsLoaded = true;
                        searchDistributorsForReferral();
                    }).catch(e => console.error('Error loading distributors:', e));
                }
                return;
            }
            
            const searchInput = document.getElementById('distributorReferralSearch');
            
            // Don't search if input is disabled (when "no referral" checkbox is checked)
            if (searchInput.disabled) {
                return;
            }
            
            const searchTerm = searchInput.value.trim();
            const dropdown = document.getElementById('distributorReferralDropdown');
            
            if (!searchTerm) {
                dropdown.style.display = 'none';
                document.getElementById('selectedDistributorInfo').style.display = 'none';
                document.getElementById('distributorReferralValue').value = '';
                return;
            }
            
            // Search by name or NB number (case-insensitive)
            const filteredDistributors = distributors.filter(dist => {
                const name = (dist.distributorName || dist.name || '').toLowerCase();
                const code = (dist.distributorCode || dist.code || '').toLowerCase();
                const search = searchTerm.toLowerCase();
                return name.includes(search) || code.includes(search);
            }).slice(0, 10); // Limit to 10 results
            
            if (filteredDistributors.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #7f8c8d;">No distributors found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Dropdown is positioned via CSS relative to parent
            dropdown.innerHTML = filteredDistributors.map(dist => {
                const name = dist.distributorName || dist.name;
                const code = dist.distributorCode || dist.code;
                return `
                    <div onclick="selectDistributorForReferral('${code}', '${name.replace(/'/g, "\\'")}', '${JSON.stringify(dist).replace(/'/g, "\\'")}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'">
                        <strong>${name}</strong><br>
                        <span style="color: #c41e3a; font-size: 0.9rem;">${code}</span>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== searchInput) {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function selectDistributorForReferral(code, name, distributorJson) {
            const distributor = JSON.parse(distributorJson);
            
            document.getElementById('distributorReferralSearch').value = name;
            document.getElementById('distributorReferralValue').value = code;
            document.getElementById('distributorReferralDropdown').style.display = 'none';
            
            document.getElementById('selectedDistributorName').textContent = name;
            document.getElementById('selectedDistributorCode').textContent = code;
            document.getElementById('selectedDistributorMobile').textContent = distributor.mobileNo || distributor.mobile || 'N/A';
            document.getElementById('selectedDistributorInfo').style.display = 'block';
            document.getElementById('changeReferralBtn').style.display = 'block';
            // Persist and broadcast selection globally
            try { setGlobalDistributor({ name: name, nbNumber: code, phone: distributor.mobileNo || distributor.mobile || '' }); } catch (_) {}
        }
        
        // Distributor search for bonus payment forms
        function searchDistributorsForBonus(type) {
            // Check if distributors are loaded
            if (!distributorsLoaded || distributors.length === 0) {
                console.warn('Distributors not loaded yet');
                if (typeof loadDistributors === 'function') {
                    loadDistributors().then(() => {
                        distributorsLoaded = true;
                        searchDistributorsForBonus(type);
                    }).catch(e => console.error('Error loading distributors:', e));
                }
                return;
            }
            
            const inputId = type === 'bank' ? 'bankBonusDistributorNB' : 'bonusDistributorNB';
            const dropdownId = type === 'bank' ? 'bankBonusDistributorDropdown' : 'bonusDistributorDropdown';
            const statusId = type === 'bank' ? 'bankBonusDistributorStatus' : 'bonusDistributorStatus';
            
            const searchInput = document.getElementById(inputId);
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim();
            const dropdown = document.getElementById(dropdownId);
            const statusEl = document.getElementById(statusId);
            
            if (!searchTerm) {
                if (dropdown) dropdown.style.display = 'none';
                if (statusEl) statusEl.textContent = '';
                return;
            }
            
            // Search by name or NB number (case-insensitive)
            const filteredDistributors = distributors.filter(dist => {
                const name = (dist.distributorName || dist.name || '').toLowerCase();
                const code = (dist.distributorCode || dist.code || '').toLowerCase();
                const search = searchTerm.toLowerCase();
                return name.includes(search) || code.includes(search);
            }).slice(0, 10); // Limit to 10 results
            
            if (!dropdown) return;
            
            if (filteredDistributors.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #7f8c8d;">No distributors found</div>';
                dropdown.style.display = 'block';
                if (statusEl) statusEl.textContent = 'Distributor not found';
                return;
            }
            
            // Dropdown is positioned via CSS relative to parent
            dropdown.innerHTML = filteredDistributors.map(dist => {
                const name = dist.distributorName || dist.name;
                const code = dist.distributorCode || dist.code;
                return `
                    <div onclick="selectDistributorForBonus('${code}', '${name.replace(/'/g, "\\'")}', '${type}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'">
                        <strong>${name}</strong><br>
                        <span style="color: #c41e3a; font-size: 0.9rem;">${code}</span>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== searchInput) {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function selectDistributorForBonus(code, name, type) {
            const inputId = type === 'bank' ? 'bankBonusDistributorNB' : 'bonusDistributorNB';
            const dropdownId = type === 'bank' ? 'bankBonusDistributorDropdown' : 'bonusDistributorDropdown';
            const statusId = type === 'bank' ? 'bankBonusDistributorStatus' : 'bonusDistributorStatus';
            
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const statusEl = document.getElementById(statusId);
            
            if (input) input.value = code;
            if (dropdown) dropdown.style.display = 'none';
            if (statusEl) {
                statusEl.textContent = `âœ“ ${name} (${code})`;
                statusEl.style.color = '#27ae60';
            }
            
            // Validate the selected distributor
            if (typeof validateDistributorNB === 'function') {
                const isValid = validateDistributorNB(code);
                if (!isValid && statusEl) {
                    statusEl.textContent = 'âš ï¸ Distributor not found in system';
                    statusEl.style.color = '#e74c3c';
                }
            }
        }
        
        function clearSelectedReferral() {
            // Clear the search input
            const searchInput = document.getElementById('distributorReferralSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Clear the hidden referral value
            const referralValue = document.getElementById('distributorReferralValue');
            if (referralValue) {
                referralValue.value = '';
            }
            
            // Hide the dropdown
            const dropdown = document.getElementById('distributorReferralDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
            }
            
            // Hide the selected distributor info
            const selectedInfo = document.getElementById('selectedDistributorInfo');
            if (selectedInfo) {
                selectedInfo.style.display = 'none';
            }
            
            // Hide the change referral button
            const changeBtn = document.getElementById('changeReferralBtn');
            if (changeBtn) {
                changeBtn.style.display = 'none';
            }
            
            // Reset the no referral checkbox
            const noReferralCheckbox = document.getElementById('noReferralCheckbox');
            if (noReferralCheckbox) {
                noReferralCheckbox.checked = false;
            }
        }
        
        function handleNoReferralCheckbox() {
            const noReferralCheckbox = document.getElementById('noReferralCheckbox');
            const referralSearch = document.getElementById('distributorReferralSearch');
            const referralValue = document.getElementById('distributorReferralValue');
            const referralField = document.getElementById('customerReferralField');
            
            if (noReferralCheckbox && noReferralCheckbox.checked) {
                // Set default to Dynapharm Namibia
                if (referralSearch) {
                    referralSearch.value = 'Dynapharm Namibia';
                    referralSearch.disabled = true;
                }
                if (referralValue) {
                    referralValue.value = 'DYNAPHARM-NAMIBIA';
                }
                
                // Hide the search field
                if (referralField) {
                    referralField.style.opacity = '0.7';
                }
                
                // Hide dropdown and clear it
                const dropdown = document.getElementById('distributorReferralDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                // Persist global selection
                try { setGlobalDistributor({ name: 'Dynapharm Namibia', nbNumber: 'DYNAPHARM-NAMIBIA' }); } catch (_) {}
            } else {
                // Enable search field again
                if (referralSearch) {
                    referralSearch.value = '';
                    referralSearch.disabled = false;
                }
                if (referralValue) {
                    referralValue.value = '';
                }
                
                // Show the search field
                if (referralField) {
                    referralField.style.opacity = '1';
                }
                // Clear global selection if any
                try { clearGlobalDistributor(); } catch (_) {}
            }
        }
        
        function searchDistributorsForCustomerName() {
            // Check if distributors are loaded
            if (!distributorsLoaded || distributors.length === 0) {
                console.warn('Distributors not loaded yet');
                return;
            }
            
            const searchTerm = document.getElementById('walkInCustomerName').value.trim();
            const customerType = document.getElementById('walkInCustomerType').value;
            
            // Only search if customer type is distributor
            if (customerType !== 'distributor') return;
            
            // Use the customer name dropdown
            const dropdown = document.getElementById('customerNameDropdown');
            const searchInput = document.getElementById('walkInCustomerName');
            
            if (!searchTerm) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Search by name or NB number (case-insensitive)
            const filteredDistributors = distributors.filter(dist => {
                const name = (dist.distributorName || dist.name || '').toLowerCase();
                const code = (dist.distributorCode || dist.code || '').toLowerCase();
                const search = searchTerm.toLowerCase();
                return name.includes(search) || code.includes(search);
            }).slice(0, 10); // Limit to 10 results
            
            if (filteredDistributors.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #7f8c8d;">No distributors found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Dropdown is positioned via CSS relative to parent
            dropdown.innerHTML = filteredDistributors.map(dist => {
                const name = dist.distributorName || dist.name;
                const code = dist.distributorCode || dist.code;
                return `
                    <div onclick="selectDistributorForCustomerName('${code}', '${name.replace(/'/g, "\\'")}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'">
                        <strong>${name}</strong><br>
                        <span style="color: #c41e3a; font-size: 0.9rem;">${code}</span>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== searchInput) {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function selectDistributorForCustomerName(code, name) {
            document.getElementById('walkInCustomerName').value = name;
            document.getElementById('walkInCustomerCode').value = code;
            document.getElementById('customerNameDropdown').style.display = 'none';
        }
        
        function onCustomerTypeChange() {
            const customerType = document.getElementById('walkInCustomerType').value;
            const customerNameField = document.getElementById('walkInCustomerName');
            const referralField = document.getElementById('customerReferralField');
            
            if (customerType === 'distributor') {
                // Show distributor name as searchable field
                customerNameField.placeholder = 'Search distributor by name or NB number';
                customerNameField.onkeyup = searchDistributorsForCustomerName;
                
                // Hide referral field - distributor doesn't need a referral
                referralField.style.display = 'none';
                document.getElementById('distributorReferralValue').required = false;
                
                // Hide the customer name dropdown
                document.getElementById('customerNameDropdown').style.display = 'none';
                
                // Clear referral fields and reset checkbox
                clearSelectedReferral();
            } else {
                // Regular customer - manual name entry
                customerNameField.placeholder = 'Full Name';
                customerNameField.onkeyup = null;
                customerNameField.value = '';
                document.getElementById('walkInCustomerCode').value = '';
                
                // Show referral field - customer needs a referral
                referralField.style.display = 'block';
                document.getElementById('distributorReferralValue').required = true;
                
                // Hide the customer name dropdown
                document.getElementById('customerNameDropdown').style.display = 'none';
                
                // Clear referral fields and reset checkbox when switching to customer
                clearSelectedReferral();
            }
            
            // Update product pricing based on customer type
            loadAllProductsForSale();
        }

        function loadAllProductsForSale() {
            const customerType = document.getElementById('walkInCustomerType').value;
            displayAllProducts(customerType);
        }

        function displayAllProducts(customerType) {
            const productsList = document.getElementById('walkInProductsList');
            
            // Filter out registration kits - they can only be sold through distributor agreement form
            const filteredProducts = PRICE_LIST.filter(product => {
                const desc = product.description.toLowerCase();
                return !desc.includes('registration kit');
            });
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No products available</p>';
                return;
            }
            
            // Get product photos
            let photoMap = {};
            try {
                photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            } catch (e) {
                photoMap = {};
            }
            
            // Change container to grid layout like online shop
            if (productsList) {
                productsList.style.display = 'grid';
                productsList.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                productsList.style.gap = '20px';
                productsList.style.padding = '10px';
            }
            
            productsList.innerHTML = filteredProducts.map(product => {
                // Show appropriate pricing based on customer type
                const displayPrice = customerType === 'distributor' ? product.dp : product.cp;
                const priceLabel = customerType === 'distributor' ? 'DP' : 'CP';
                
                // Get product images
                let productPhotos = getProductImage ? getProductImage(product.description, photoMap) : [];
                if (!productPhotos || productPhotos.length === 0) {
                    const slug = productNameToSlug ? productNameToSlug(product.description) : '';
                    const imageData = getProductImageUrl ? getProductImageUrl(product.description) : { imageUrls: [] };
                    productPhotos = imageData.imageUrls && imageData.imageUrls.length > 0 ? [imageData.imageUrls[0]] : [];
                }
                if (!Array.isArray(productPhotos)) productPhotos = [productPhotos];
                if (productPhotos.length > 4) productPhotos = productPhotos.slice(0, 4);
                
                const displayName = getProductDisplayName ? getProductDisplayName(product.description) : product.description;
                const uniqueId = `walkin-product-${product.description.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}-${Math.random()}`;
                
                return `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        ${productPhotos.length > 0 ? `
                        <div class="product-carousel-container" id="${uniqueId}" data-photo-count="${productPhotos.length}" style="position: relative; width: 100%; height: 200px; border-radius: 5px; margin-bottom: 10px; overflow: hidden; background: #f0f0f0;">
                            ${productPhotos.map((photo, idx) => {
                                const isObj = typeof photo === 'object' && photo !== null;
                                const src = isObj ? (photo.full || photo.src || photo.w600 || photo.w300) : photo;
                                return `
                                <img src="${src}" alt="${displayName}" 
                                     data-index="${idx}" ${idx === 0 ? 'loading="eager"' : 'loading="lazy"'} decoding="async"
                                     onerror="if(!this.hasAttribute('data-failed')) { this.setAttribute('data-failed', '1'); const placeholder = 'https://placehold.co/200x200?text=' + encodeURIComponent('${displayName.replace(/'/g, "\\'")}'); if(!this.src.includes('placehold.co')) { this.src = placeholder; } }"
                                     style="width: 100%; height: 200px; object-fit: cover; position: ${idx === 0 ? 'relative' : 'absolute'}; top: 0; left: 0; opacity: ${idx === 0 ? '1' : '0'}; transition: opacity 0.3s ease; background:#f3f4f6;">
                                `;
                            }).join('')}
                            ${productPhotos.length > 1 ? `
                                <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px;">
                                    ${productPhotos.map((_, idx) => `<div class="carousel-dot" data-index="${idx}" style="width: 8px; height: 8px; border-radius: 50%; background: ${idx === 0 ? '#fff' : 'rgba(255,255,255,0.5)'}; cursor: pointer;"></div>`).join('')}
                            </div>
                            ` : ''}
                        </div>
                        ` : `
                        <div style="width: 100%; height: 200px; border-radius: 5px; margin-bottom: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            ðŸ“¦
                        </div>
                        `}
                        <h4 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem; min-height: 40px;">${displayName}</h4>
                        <p style="color: #c41e3a; font-size: 1.3rem; font-weight: bold; margin: 10px 0;">
                            N$${displayPrice.toFixed(2)} <span style="font-size: 0.8rem; color: #666;">(${priceLabel})</span>
                        </p>
                        ${product.bv ? `<p style="color: #666; font-size: 0.9rem;">BV: ${product.bv}</p>` : ''}
                        <button class="btn btn-success" onclick="addToWalkInCart('${product.description.replace(/'/g, "\\'")}', ${product.cp}, ${product.dp}, ${product.bv || 0})" style="width: 100%; margin-top: 10px; background: #c41e3a; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            âž• Add to Cart
                        </button>
                    </div>
                `;
            }).join('');
            
            // Initialize carousels if available
            if (typeof initializeProductCarousels === 'function') {
                setTimeout(() => initializeProductCarousels(), 100);
            }
        }

        function searchProductsForWalkIn() {
            const searchTerm = document.getElementById('walkInProductSearch').value.toLowerCase();
            const productsList = document.getElementById('walkInProductsList');
            
            if (!searchTerm) {
                const customerType = document.getElementById('walkInCustomerType').value;
                displayAllProducts(customerType);
                return;
            }
            
            // Filter out registration kits - they can only be sold through distributor agreement form
            const filteredProducts = PRICE_LIST.filter(p => {
                const desc = p.description.toLowerCase();
                return !desc.includes('registration kit') && desc.includes(searchTerm);
            }).slice(0, 50); // Show more results in grid view
            
            displayWalkInProducts(filteredProducts);
        }

        function displayWalkInProducts(products) {
            const productsList = document.getElementById('walkInProductsList');
            const customerType = document.getElementById('walkInCustomerType').value;
            
            if (products.length === 0) {
                productsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; grid-column: 1 / -1;">No products found</p>';
                return;
            }
            
            // Ensure grid layout
            if (productsList) {
                productsList.style.display = 'grid';
                productsList.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                productsList.style.gap = '20px';
                productsList.style.padding = '10px';
            }
            
            // Get product photos
            let photoMap = {};
            try {
                photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            } catch (e) {
                photoMap = {};
            }
            
            productsList.innerHTML = products.map(product => {
                const displayPrice = customerType === 'distributor' ? product.dp : product.cp;
                const priceLabel = customerType === 'distributor' ? 'DP' : 'CP';
                
                // Get product images
                let productPhotos = getProductImage ? getProductImage(product.description, photoMap) : [];
                if (!productPhotos || productPhotos.length === 0) {
                    const imageData = getProductImageUrl ? getProductImageUrl(product.description) : { imageUrls: [] };
                    productPhotos = imageData.imageUrls && imageData.imageUrls.length > 0 ? [imageData.imageUrls[0]] : [];
                }
                if (!Array.isArray(productPhotos)) productPhotos = [productPhotos];
                if (productPhotos.length > 4) productPhotos = productPhotos.slice(0, 4);
                
                const displayName = getProductDisplayName ? getProductDisplayName(product.description) : product.description;
                const uniqueId = `walkin-product-${product.description.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}-${Math.random()}`;
                
                return `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        ${productPhotos.length > 0 ? `
                        <div class="product-carousel-container" id="${uniqueId}" data-photo-count="${productPhotos.length}" style="position: relative; width: 100%; height: 200px; border-radius: 5px; margin-bottom: 10px; overflow: hidden; background: #f0f0f0;">
                            ${productPhotos.map((photo, idx) => {
                                const isObj = typeof photo === 'object' && photo !== null;
                                const src = isObj ? (photo.full || photo.src || photo.w600 || photo.w300) : photo;
                                return `
                                <img src="${src}" alt="${displayName}" 
                                     data-index="${idx}" ${idx === 0 ? 'loading="eager"' : 'loading="lazy"'} decoding="async"
                                     onerror="if(!this.hasAttribute('data-failed')) { this.setAttribute('data-failed', '1'); const placeholder = 'https://placehold.co/200x200?text=' + encodeURIComponent('${displayName.replace(/'/g, "\\'")}'); if(!this.src.includes('placehold.co')) { this.src = placeholder; } }"
                                     style="width: 100%; height: 200px; object-fit: cover; position: ${idx === 0 ? 'relative' : 'absolute'}; top: 0; left: 0; opacity: ${idx === 0 ? '1' : '0'}; transition: opacity 0.3s ease; background:#f3f4f6;">
                                `;
                            }).join('')}
                            ${productPhotos.length > 1 ? `
                                <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px;">
                                    ${productPhotos.map((_, idx) => `<div class="carousel-dot" data-index="${idx}" style="width: 8px; height: 8px; border-radius: 50%; background: ${idx === 0 ? '#fff' : 'rgba(255,255,255,0.5)'}; cursor: pointer;"></div>`).join('')}
                        </div>
                            ` : ''}
                    </div>
                        ` : `
                        <div style="width: 100%; height: 200px; border-radius: 5px; margin-bottom: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            ðŸ“¦
                </div>
                        `}
                        <h4 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem; min-height: 40px;">${displayName}</h4>
                        <p style="color: #c41e3a; font-size: 1.3rem; font-weight: bold; margin: 10px 0;">
                            N$${displayPrice.toFixed(2)} <span style="font-size: 0.8rem; color: #666;">(${priceLabel})</span>
                        </p>
                        ${product.bv ? `<p style="color: #666; font-size: 0.9rem;">BV: ${product.bv}</p>` : ''}
                        <button class="btn btn-success" onclick="addToWalkInCart('${product.description.replace(/'/g, "\\'")}', ${product.cp}, ${product.dp}, ${product.bv || 0})" style="width: 100%; margin-top: 10px; background: #c41e3a; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            âž• Add to Cart
                        </button>
                    </div>
                `;
            }).join('');
            
            // Initialize carousels if available
            if (typeof initializeProductCarousels === 'function') {
                setTimeout(() => initializeProductCarousels(), 100);
            }
        }

        function addToWalkInCart(productName, cp, dp, bv) {
            const existingItem = walkInCart.find(item => item.name === productName);
            
            const customerType = document.getElementById('walkInCustomerType').value;
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                walkInCart.push({
                    name: productName,
                    cp: cp,
                    dp: dp,
                    bv: bv || 0,
                    quantity: 1
                });
            }
            
            updateWalkInCart();
        }

        function removeFromWalkInCart(index) {
            walkInCart.splice(index, 1);
            updateWalkInCart();
        }

        function updateWalkInCart() {
            const cartList = document.getElementById('walkInCartList');
            const customerType = document.getElementById('walkInCustomerType').value;
            
            if (walkInCart.length === 0) {
                cartList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Cart is empty</p>';
                updateWalkInTotals();
                return;
            }
            
            // Use DP for distributors, CP for customers
            cartList.innerHTML = walkInCart.map((item, index) => {
                const pricePerUnit = customerType === 'distributor' ? item.dp : item.cp;
                const priceLabel = customerType === 'distributor' ? 'DP' : 'CP';
                const totalPrice = pricePerUnit * item.quantity;
                
                return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${priceLabel}: N$ ${pricePerUnit.toFixed(2)}
                        </div>
                        <div style="font-size: 0.85rem; color: #c41e3a; margin-top: 3px;">
                            BV: ${(item.bv * item.quantity).toFixed(0)}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 0 15px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <button onclick="updateWalkInCartQuantity(${index}, -1)" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-weight: bold;">âˆ’</button>
                            <input type="number" id="qty-${index}" value="${item.quantity}" min="1" 
                                   onchange="updateWalkInCartQuantity(${index}, 0, this.value)" 
                                   onclick="this.select()"
                                   style="width: 50px; text-align: center; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="updateWalkInCartQuantity(${index}, 1)" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-weight: bold;">+</button>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                            <strong>N$ ${totalPrice.toFixed(2)}</strong>
                        </div>
                    </div>
                    <button class="btn" onclick="removeFromWalkInCart(${index})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">âŒ</button>
                </div>
            `;
            }).join('');
            
            updateWalkInTotals();
        }

        function updateWalkInTotals() {
            const customerType = document.getElementById('walkInCustomerType').value;
            
            // Use DP for distributors, CP for customers
            const subtotal = walkInCart.reduce((sum, item) => {
                const pricePerUnit = customerType === 'distributor' ? item.dp : item.cp;
                return sum + (pricePerUnit * item.quantity);
            }, 0);
            
            const totalBV = walkInCart.reduce((sum, item) => {
                return sum + (item.bv * item.quantity);
            }, 0);
            
            // No tax - grand total equals subtotal
            const grandTotal = subtotal;
            
            document.getElementById('walkInTotalAmount').textContent = `N$ ${subtotal.toFixed(2)}`;
            document.getElementById('walkInDiscountAmount').textContent = `BV: ${totalBV.toFixed(0)}`;
            document.getElementById('walkInTaxAmount').textContent = `N$ 0.00`;
            document.getElementById('walkInGrandTotal').textContent = `N$ ${grandTotal.toFixed(2)}`;
        }

        function updateWalkInCartQuantity(index, delta, newValue) {
            if (index < 0 || index >= walkInCart.length) return;
            
            const item = walkInCart[index];
            
            if (newValue !== undefined && newValue !== null) {
                // Direct value update from input field
                const quantity = parseInt(newValue) || 1;
                item.quantity = Math.max(1, quantity);
            } else if (delta !== 0) {
                // Increment/decrement
                item.quantity = Math.max(1, item.quantity + delta);
            }
            
            // Update the input field value
            const qtyInput = document.getElementById(`qty-${index}`);
            if (qtyInput) {
                qtyInput.value = item.quantity;
            }
            
            // Refresh cart display
            updateWalkInCart();
        }

        function showWalkInSaleConfirmation() {
            const customerName = document.getElementById('walkInCustomerName').value.trim();
            const phone = document.getElementById('walkInPhone').value.trim();
            const email = document.getElementById('walkInEmail').value.trim();
            const customerType = document.getElementById('walkInCustomerType').value;
            const paymentMethod = document.getElementById('walkInPaymentMethod')?.value || 'cash';
            
            // Validation
            if (!customerName || walkInCart.length === 0) {
                alert('Please fill in customer name and add products to cart');
                return;
            }
            
            // Check distributor referral for customers
            if (customerType === 'customer') {
                const distributorCode = document.getElementById('distributorReferralValue').value;
                if (!distributorCode) {
                    alert('âš ï¸ Required: Please search and select a referred distributor');
                    return;
                }
            }
            
            // Calculate totals
            const pricePerUnit = customerType === 'distributor' ? 'dp' : 'cp';
            const subtotal = walkInCart.reduce((sum, item) => {
                return sum + (item[pricePerUnit] * item.quantity);
            }, 0);
            
            const totalBV = walkInCart.reduce((sum, item) => {
                return sum + (item.bv * item.quantity);
            }, 0);
            
            // Build confirmation message
            const paymentMethodLabels = {
                'cash': 'ðŸ’µ Cash',
                'card': 'ðŸ’³ Card',
                'mobile': 'ðŸ“± Mobile Money',
                'bank': 'ðŸ¦ Bank Transfer'
            };
            const paymentLabel = paymentMethodLabels[paymentMethod] || paymentMethod;
            
            let confirmationMessage = 'ðŸ“‹ REVIEW & CONFIRM SALE\n\n';
            confirmationMessage += `Customer: ${customerName}\n`;
            if (phone) confirmationMessage += `Phone: ${phone}\n`;
            if (email) confirmationMessage += `Email: ${email}\n`;
            confirmationMessage += `Type: ${customerType === 'distributor' ? 'Distributor' : 'Customer'}\n`;
            confirmationMessage += `Payment Method: ${paymentLabel}\n\n`;
            confirmationMessage += 'Products:\n';
            walkInCart.forEach((item, idx) => {
                const price = customerType === 'distributor' ? item.dp : item.cp;
                const total = price * item.quantity;
                confirmationMessage += `  ${idx + 1}. ${item.name} x${item.quantity} = N$ ${total.toFixed(2)}\n`;
            });
            confirmationMessage += `\nSubtotal: N$ ${subtotal.toFixed(2)}\n`;
            confirmationMessage += `Total BV: ${totalBV.toFixed(0)}\n`;
            confirmationMessage += `Grand Total: N$ ${subtotal.toFixed(2)}\n\n`;
            confirmationMessage += 'Confirm this sale?';
            
            if (confirm(confirmationMessage)) {
                processWalkInPayment();
            }
        }

        async function processWalkInPayment() {
            const customerName = document.getElementById('walkInCustomerName').value.trim();
            const phone = document.getElementById('walkInPhone').value.trim();
            const email = document.getElementById('walkInEmail').value.trim();
            const customerType = document.getElementById('walkInCustomerType').value;
            
            // Validation
            if (!customerName || walkInCart.length === 0) {
                alert('Please fill in customer name and add products to cart');
                return;
            }
            
            // Handle distributor referral based on customer type
            let referralName = '';
            let referralId = '';
            
            if (customerType === 'customer') {
                // Customer needs a referral distributor
                const distributorCode = document.getElementById('distributorReferralValue').value;
                
                if (!distributorCode) {
                    alert('âš ï¸ Required: Please search and select a referred distributor');
                    return;
                }
                
                // Find distributor details
                const selectedDistributor = distributors.find(d => 
                    (d.distributorCode || d.code) === distributorCode
                );
                
                if (!selectedDistributor) {
                    alert('âš ï¸ Error: Selected distributor not found');
                    return;
                }
                
                referralName = selectedDistributor.distributorName || selectedDistributor.name;
                referralId = selectedDistributor.distributorCode || selectedDistributor.code;
            } else {
                // Distributor - get their own code
                referralId = document.getElementById('walkInCustomerCode').value;
                referralName = customerName; // Their own name
            }
            
            // Check if customer already exists as a client
            let existingClient = null;
            if (phone || email) {
                existingClient = clients.find(c => {
                    const clientName = (c.fullName || c.name || '').toLowerCase().trim();
                    const clientPhone = (c.phone || '').trim();
                    const clientEmail = (c.email || '').trim().toLowerCase();
                    
                    const searchName = customerName.toLowerCase().trim();
                    const searchPhone = phone.trim();
                    const searchEmail = email.trim().toLowerCase();
                    
                    // Match by name and phone/email
                    const nameMatch = clientName === searchName;
                    const phoneMatch = phone && clientPhone && clientPhone === searchPhone;
                    const emailMatch = email && clientEmail && clientEmail === searchEmail;
                    
                    return nameMatch && (phoneMatch || emailMatch);
                });
            }
            
            let clientId = null;
            let clientReferenceNumber = null;
            
            // Register new client if they don't exist
            if (!existingClient && customerType === 'customer') {
                try {
                    // Generate reference number
                    const firstName = customerName.split(' ')[0].toUpperCase();
                    const nbNumber = phone ? `NB${phone.replace(/\D/g, '').slice(-8)}` : '';
                    clientReferenceNumber = `CLT-${firstName}-${nbNumber}-${Date.now()}`;
                    
                    const newClient = {
                        referenceNumber: clientReferenceNumber,
                        fullName: customerName,
                        phone: phone || '',
                        email: email || '',
                        nbNumber: nbNumber,
                        membershipStatus: 'referred',
                        referralName: referralName,
                        referralNbNumber: referralId || '',
                        branch: currentUser ? currentUser.branch : 'unknown',
                        timestamp: new Date().toISOString(),
                        firstVisit: new Date().toISOString(),
                        registeredFrom: 'walkin_sale'
                    };
                    
                    // Try to save via API first
                    try {
                        const result = await apiRequest('/clients', 'POST', newClient);
                        if (result && result.id) {
                            clientId = result.id;
                            newClient.id = result.id;
                        } else {
                            clientId = clientReferenceNumber;
                            newClient.id = clientReferenceNumber;
                        }
                        clients.push(newClient);
                        console.log('âœ… New walk-in client registered:', newClient.referenceNumber);
                    } catch (apiError) {
                        console.warn('API save failed, saving locally:', apiError);
                        // Fallback to local storage
                        clientId = clientReferenceNumber;
                        newClient.id = clientReferenceNumber;
                        clients.push(newClient);
                        localStorage.setItem('dyna_clients', JSON.stringify(clients));
                    }
                } catch (error) {
                    console.error('Error registering new client:', error);
                    // Continue with sale even if client registration fails
                }
            } else if (existingClient) {
                clientId = existingClient.id || existingClient.referenceNumber;
                clientReferenceNumber = existingClient.referenceNumber;
            }
            
            // Use DP for distributors, CP for customers
            const subtotal = walkInCart.reduce((sum, item) => {
                const pricePerUnit = customerType === 'distributor' ? item.dp : item.cp;
                return sum + (pricePerUnit * item.quantity);
            }, 0);
            
            const totalBV = walkInCart.reduce((sum, item) => {
                return sum + (item.bv * item.quantity);
            }, 0);
            
            // No tax - grand total equals subtotal
            const grandTotal = subtotal;
            
            const now = new Date();
            const saleDate = now.toISOString().split('T')[0]; // YYYY-MM-DD format for finance
            
            // Get selected payment method
            const paymentMethod = document.getElementById('walkInPaymentMethod')?.value || 'cash';
            
            const sale = {
                id: 'WALKIN-' + Date.now(),
                clientId: clientId,
                clientReferenceNumber: clientReferenceNumber,
                customerName: customerName,
                phone: phone,
                email: email,
                customerType: customerType,
                distributorReferral: {
                    name: referralName,
                    id: referralId
                },
                products: walkInCart,
                subtotal: subtotal,
                tax: 0,
                total: grandTotal,
                totalAmount: grandTotal, // For finance compatibility
                totalBV: totalBV,
                date: saleDate, // For finance compatibility (YYYY-MM-DD)
                timestamp: now.toISOString(),
                soldBy: currentUser ? currentUser.fullName : 'Unknown',
                branch: currentUser ? currentUser.branch : 'unknown',
                paymentMethod: paymentMethod // Use selected payment method
            };
            
            // FEFO mandatory: deduct via barcode/batch FEFO first
            try {
                const branchId = (currentUser && currentUser.branch) || 'unknown_branch';
                const userName = (currentUser && currentUser.fullName) || 'system';
                const fefo = await fefoDispenseProducts(walkInCart.map(i=>({ name:i.name, quantity:i.quantity||1 })), branchId, userName, sale.id);
                if (!fefo.success) {
                    alert('âš ï¸ FEFO stock issues:\n' + fefo.errors.join('\n'));
                }
                // Update legacy counters for dashboards
                const invReduction = reduceInventoryForProducts(walkInCart, userName, sale.id);
                if (!invReduction.success && fefo.success) {
                    console.warn('Legacy counter update reported issues but FEFO deduction succeeded.');
                }
            } catch (e) {
                console.warn('FEFO dispense failed, falling back to simple counters:', e);
                const invReduction = reduceInventoryForProducts(walkInCart, (currentUser && currentUser.fullName) || 'system', sale.id);
                if (!invReduction.success) {
                    alert('âš ï¸ Stock deduction issues:\n' + invReduction.errors.join('\n'));
                }
            }

            // Record department event
            recordDepartmentEvent('walkin_sale', sale);
            
            // Broadcast stock update event for real-time sync
            try {
                const branchId = (currentUser && currentUser.branch) || 'unknown';
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: branchId, products: walkInCart, user: (currentUser && currentUser.fullName) || 'system', reference: sale.id } 
                }));
                // Also broadcast sale event for Finance/MIS portals
                window.dispatchEvent(new CustomEvent('sale:updated', { detail: { sale, type: 'walkin' } }));
                // Publish to Railway gateway
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: branchId, products: walkInCart, sale: sale.id, ts: Date.now() } })
                    }).catch(_ => {});
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'sale:updated', sale, type: 'walkin', ts: Date.now() } })
                    }).catch(_ => {});
                }
                // Publish to Vercel SSE
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: branchId, products: walkInCart, ts: Date.now() } }) 
                }).catch(_ => {});
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'sales', event: { sale, type: 'walkin', ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}

            // Save sale to localStorage - save to both keys for compatibility
            walkInSales.push(sale);
            localStorage.setItem('dyna_walkin_sales', JSON.stringify(walkInSales));
            
            // Also save to the key finance portal expects (for backward compatibility)
            const financeSales = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            financeSales.push(sale);
            localStorage.setItem('dynapharm_walkin_sales', JSON.stringify(financeSales));
            
            // Update cash drawer
            const cashDrawer = JSON.parse(localStorage.getItem('dyna_cash_drawer') || '{}');
            if (!cashDrawer.totalSales) cashDrawer.totalSales = [];
            cashDrawer.totalSales.push({
                type: 'walkin',
                amount: grandTotal,
                timestamp: sale.timestamp
            });
            localStorage.setItem('dyna_cash_drawer', JSON.stringify(cashDrawer));
            
            // Show success message with client registration info if applicable
            const paymentMethodLabels = {
                'cash': 'ðŸ’µ Cash',
                'card': 'ðŸ’³ Card',
                'mobile': 'ðŸ“± Mobile Money',
                'bank': 'ðŸ¦ Bank Transfer'
            };
            const paymentLabel = paymentMethodLabels[paymentMethod] || paymentMethod;
            
            let successMessage = `âœ… Sale processed successfully!\n\nTotal: N$ ${grandTotal.toFixed(2)}\nPayment Method: ${paymentLabel}`;
            if (clientReferenceNumber && !existingClient) {
                successMessage += `\n\nðŸ“ New client registered!\nReference: ${clientReferenceNumber}`;
            } else if (clientReferenceNumber) {
                successMessage += `\n\nðŸ‘¤ Client: ${clientReferenceNumber}`;
            }
            alert(successMessage);
            
            // Close modal and reset
            closeModal('walkInSaleModal');
            refreshWalkInSalesList();
        }

        function refreshWalkInSalesList() {
            const salesList = document.getElementById('walkInSalesList');
            const recentSales = walkInSales.slice(-10).reverse();
            
            if (recentSales.length === 0) {
                salesList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No walk-in sales yet</p>';                                                                                         
                return;
            }
            
            salesList.innerHTML = recentSales.map(sale => `
                <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid ${sale.customerType === 'distributor' ? '#e74c3c' : '#3498db'};">                         
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${sale.customerName}</strong>
                            ${sale.clientReferenceNumber ? `<div style="font-size: 0.75rem; color: #27ae60; font-weight: 500; margin-top: 2px;">ðŸ“ ${sale.clientReferenceNumber}</div>` : ''}
                            <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                                ${sale.phone || 'N/A'} | ${new Date(sale.timestamp).toLocaleString()}
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                ${sale.customerType === 'distributor' ? 'ðŸ¢ Distributor' : 'ðŸ‘¤ Customer'} | ${sale.products.length} items                                                                               
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <strong style="font-size: 1.1rem; color: #27ae60;">N$ ${sale.total.toFixed(2)}</strong>
                            ${sale.totalBV ? `<div style="font-size: 0.85rem; color: #c41e3a;">BV: ${sale.totalBV.toFixed(0)}</div>` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="printWalkInSaleReceipt('${sale.id}')" style="padding: 5px 15px; font-size: 0.85rem;">ðŸ§¾ Thermal Receipt</button>
                    </div>
                </div>
            `).join('');
        }

        function printWalkInSaleReceipt(saleId) {
            const sale = walkInSales.find(s => s.id === saleId);
            
            if (!sale) {
                alert('Sale not found');
                return;
            }
            
            const branchName = branches.find(b => b.id === sale.branch)?.name || sale.branch || 'UNKNOWN';
            
            // Determine price to use based on customer type
            const customerType = sale.customerType || 'customer';
            
            // Create thermal receipt
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Sale Receipt - ${sale.id}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10pt;
                            font-weight: bold;
                            line-height: 1.3;
                            padding: 5mm;
                            width: 80mm;
                        }
                        
                        .center {
                            text-align: center;
                        }
                        
                        .bold {
                            font-weight: bold;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                            margin-bottom: 8px;
                        }
                        
                        .header h1 {
                            font-size: 12pt;
                            margin-bottom: 3px;
                        }
                        
                        .header p {
                            font-size: 8pt;
                            margin: 1px 0;
                        }
                        
                        .section {
                            margin: 8px 0;
                            padding-bottom: 5px;
                        }
                        
                        .section-title {
                            font-weight: bold;
                            font-size: 9pt;
                            border-bottom: 2px solid #c41e3a;
                            margin-bottom: 4px;
                            padding-bottom: 2px;
                            color: #c41e3a;
                            text-transform: uppercase;
                        }
                        
                        .info-line {
                            display: flex;
                            justify-content: space-between;
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        
                        .item {
                            margin: 4px 0;
                            font-size: 9pt;
                        }
                        
                        .item-name {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        
                        .divider {
                            border-top: 1px dashed #c41e3a;
                            margin: 6px 0;
                        }
                        
                        .total-line {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            font-size: 10pt;
                            margin: 3px 0;
                            color: #c41e3a;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 12px;
                            border-top: 2px solid #c41e3a;
                            padding-top: 8px;
                            font-size: 8pt;
                            color: #c41e3a;
                            font-weight: bold;
                        }
                        
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Logo -->
                    <div style="text-align: center; margin-bottom: 5px;">
                        ${generateLogoSVG(60, 40)}
                    </div>
                    
                    <!-- Header -->
                    <div class="header" style="border-bottom: 2px solid #c41e3a; background: linear-gradient(135deg, rgba(196,30,58,0.1) 0%, rgba(139,0,0,0.1) 100%); border-radius: 4px;">
                        <h1 style="color: #c41e3a; font-weight: 900;">DYNAPHARM NAMIBIA</h1>
                        <p>${branchName}</p>
                        <p>SALE RECEIPT</p>
                        <p>${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</p>                                                                
                    </div>
                    
                    <!-- Customer Details -->
                    <div class="section">
                        <div class="section-title">CUSTOMER DETAILS</div>
                        <div class="info-line">
                            <span>Name:</span>
                            <span class="bold">${sale.customerName}</span>
                        </div>
                        ${sale.phone ? `
                        <div class="info-line">
                            <span>Contact:</span>
                            <span>${sale.phone}</span>
                        </div>
                        ` : ''}
                        <div class="info-line">
                            <span>Type:</span>
                            <span>${customerType.toUpperCase()}</span>
                        </div>
                        ${sale.distributorReferral ? `
                        <div class="info-line">
                            <span>Referred By:</span>
                            <span>${sale.distributorReferral.name}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Sale Info -->
                    <div class="section">
                        <div class="section-title">SALE INFO</div>
                        <div class="info-line">
                            <span>Receipt ID:</span>
                            <span>${sale.id}</span>
                        </div>
                        <div class="info-line">
                            <span>Sold By:</span>
                            <span>${sale.soldBy}</span>
                        </div>
                        <div class="info-line">
                            <span>Date:</span>
                            <span>${new Date(sale.timestamp).toLocaleDateString('en-GB')}</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Products -->
                    <div class="section">
                        <div class="section-title">PRODUCTS</div>
                        ${sale.products.map(item => {
                            const pricePerUnit = customerType === 'distributor' ? item.dp : item.cp;
                            const priceLabel = customerType === 'distributor' ? 'DP' : 'CP';
                            const total = pricePerUnit * item.quantity;
                            return `
                            <div class="item">
                                <div class="item-name">${item.name}</div>
                                <div class="info-line">
                                    <span>${priceLabel}: N$${pricePerUnit.toFixed(2)} x ${item.quantity}</span>
                                    <span>N$${total.toFixed(2)}</span>
                                </div>
                                ${item.bv ? `<div style="font-size: 8pt;">BV: ${(item.bv * item.quantity).toFixed(0)}</div>` : ''}
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Totals -->
                    <div class="section">
                        <div class="total-line">
                            <span>Subtotal:</span>
                            <span>N$${sale.subtotal.toFixed(2)}</span>
                        </div>
                        ${sale.totalBV ? `
                        <div class="total-line">
                            <span>Total BV:</span>
                            <span>${sale.totalBV.toFixed(0)}</span>
                        </div>
                        ` : ''}
                        <div class="divider"></div>
                        <div class="total-line" style="font-size: 11pt;">
                            <span>TOTAL:</span>
                            <span>N$${sale.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p>Thank you for your purchase!</p>
                        <p>For inquiries, contact</p>
                        <p>Dynapharm Namibia</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Add event listener for discount rate change
        if (typeof document !== 'undefined') {
            document.addEventListener('DOMContentLoaded', function() {
                const discountInput = document.getElementById('distributorDiscount');
                if (discountInput) {
                    discountInput.addEventListener('input', function() {
                        updateWalkInTotals();
                    });
                }
            });
        }

        // Function to load reports from reports_data.json
        async function loadReportsFromFile() {
            try {
                const response = await fetch('./reports_data.json');
                if (response.ok) {
                    const reportsData = await response.json();
                    if (reportsData && reportsData.length > 0) {
                        // Always load reports data from file to ensure we have the latest
                        const existingReports = localStorage.getItem('dyna_reports');
                        const existingCount = existingReports ? JSON.parse(existingReports).length : 0;
                        
                        localStorage.setItem('dyna_reports', JSON.stringify(reportsData));
                        reports = reportsData;
                        
                        if (existingCount === 0) {
                            console.log(`âœ… Loaded ${reportsData.length} reports from reports_data.json`);
                        } else {
                            console.log(`âœ… Updated ${reportsData.length} reports from reports_data.json (had ${existingCount} before)`);
                        }
                    }
                } else {
                    console.log('No reports_data.json file found, using localStorage only');
                }
            } catch (error) {
                console.log('Could not load reports from file:', error.message);
            }
        }

        // ========== Distributor Management Functions ==========
        
        async function uploadDistributorFile() {
            const fileInput = document.getElementById('distributorFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('distributorUploadStatus');
            
            if (!file) {
                statusDiv.innerHTML = '<p style="color: #e74c3c;">âš ï¸ Please select a file</p>';
                return;
            }
            
            if (!file.name.match(/\.(xlsx|xls|csv)$/)) {
                statusDiv.innerHTML = '<p style="color: #e74c3c;">âš ï¸ Please select a CSV (.csv) or Excel (.xlsx, .xls) file</p>';
                return;
            }
            
            // Load existing distributors before processing upload
            try {
                await loadDistributors();
            } catch (error) {
                console.warn('Could not load existing distributors, continuing with empty list:', error);
                distributors = [];
            }
            
            const fileType = file.name.endsWith('.csv') ? 'CSV' : 'Excel';
            statusDiv.innerHTML = `<p style="color: #f39c12;">â³ Uploading and processing ${fileType} file...</p>`;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                let header = [];
                let rows = [];
                
                // Check if it's an Excel file
                if (file.name.match(/\.(xlsx|xls)$/)) {
                    // Use SheetJS to parse Excel
                    if (typeof XLSX === 'undefined') {
                        statusDiv.innerHTML = '<p style="color: #e74c3c;">âŒ Error: Excel library not loaded. Please refresh the page.</p>';
                        return;
                    }
                    
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON with header row
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        throw new Error('File must contain headers and at least one data row');
                    }
                    
                    header = jsonData[0].map(h => h ? String(h).trim() : '');
                    rows = jsonData.slice(1);
                    
                    console.log('Excel file loaded. Headers:', header);
                    console.log('Total rows:', rows.length);
                    
                } else {
                    // Parse as CSV with proper CSV parsing (handles quoted values with commas)
                    const text = new TextDecoder().decode(new Uint8Array(arrayBuffer));
                    const lines = text.split('\n').filter(line => line.trim() && line.trim() !== '').map(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('File must contain headers and at least one data row');
                    }
                    
                    // Detect delimiter - check for tab, semicolon, then comma
                    let delimiter = ',';
                    if (lines[0].includes('\t')) {
                        delimiter = '\t';
                    } else if (lines[0].includes(';')) {
                        delimiter = ';';
                    }
                    
                    // Parse CSV properly (handle quoted values with commas inside)
                    function parseCSVLine(line) {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            const nextChar = line[i + 1];
                            
                            if (char === '"') {
                                if (inQuotes && nextChar === '"') {
                                    current += '"';
                                    i++; // skip next quote
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === delimiter && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim()); // push last field
                        return result;
                    }
                    
                    header = parseCSVLine(lines[0]).map(h => h.replace(/^["']|["']$/g, '').trim());
                    
                    // Parse rows
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]).map(v => v.replace(/^["']|["']$/g, '').trim());
                        // Only add rows that have at least one non-empty value
                        if (values.some(v => v !== '')) {
                            rows.push(values);
                        }
                    }
                    
                    console.log('CSV file loaded. Headers:', header);
                    console.log('Total rows:', rows.length);
                    if (rows.length > 0) {
                        console.log('First row sample:', rows[0]);
                    }
                }
                
                console.log('\n=== DEBUGGING INFO ===');
                console.log('All headers found:', header);
                console.log('Total data rows:', rows.length);
                if (rows.length > 0) {
                    console.log('Sample row values:', rows[0]);
                    console.log('Number of values in sample row:', rows[0].length);
                }
                
                // Create a normalized column map matching Distributor Agreement Form fields
                const createColumnMap = () => {
                    const map = {
                        // REQUIRED FIELDS
                        // Distributor Name (Full Name - Last, First, M.I.)
                        'DISTRIBUTOR NAME': 'distributorName',
                        'DISTRIBUTORNAME': 'distributorName',
                        'DIST NAME': 'distributorName',
                        'NAME': 'distributorName',
                        'FULL NAME': 'distributorName',
                        'LAST NAME, FIRST NAME, M.I.': 'distributorName',
                        // Assigned Distributor ID No. (NB number) - REQUIRED
                        'ASSIGNED DISTRIBUTOR ID NO.': 'distributorCode',
                        'DISTRIBUTOR ID': 'distributorCode',
                        'DISTRIBUTOR CODE': 'distributorCode',
                        'DRN': 'distributorCode',
                        'DNR': 'distributorCode',
                        'D.R.N': 'distributorCode',
                        'D.N.R': 'distributorCode',
                        'ID NO.': 'distributorCode',
                        'ID NO': 'distributorCode',
                        'IDNO': 'distributorCode',
                        'NB NUMBER': 'distributorCode',
                        'NB NO': 'distributorCode',
                        'NB NO.': 'distributorCode',
                        // OPTIONAL FIELDS - Distributor's Data
                        'BIRTHDATE': 'birthdate',
                        'BIRTH DATE': 'birthdate',
                        'BIRTHDATE (MONTH, DATE, YEAR)': 'birthdate',
                        'DATE OF BIRTH': 'birthdate',
                        'DOB': 'birthdate',
                        'AGE': 'age',
                        'SEX': 'sex',
                        'GENDER': 'sex',
                        'NATIONALITY': 'nationality',
                        'NATIONAL': 'nationality',
                        'MOBILE NO.': 'mobileNo',
                        'MOBILE NUMBER': 'mobileNo',
                        'MOBILE': 'mobileNo',
                        'RESIDENCE PHONE': 'residencePhone',
                        'RESIDENCE': 'residencePhone',
                        'RESIDENCE PHONE NO.': 'residencePhone',
                        'OFFICE PHONE': 'officePhone',
                        'OFFICE': 'officePhone',
                        'OFFICE PHONE NO.': 'officePhone',
                        'EMAIL ID': 'email',
                        'EMAIL': 'email',
                        'MAILING ADDRESS': 'address1',
                        'ADDRESS (HOUSE NUMBER, STREET)': 'address1',
                        'ADDRESS': 'address1',
                        'HOUSE NUMBER, STREET': 'address1',
                        'ADD1': 'address1',
                        'TOWN, CITY': 'city',
                        'CITY': 'city',
                        'TOWN': 'city',
                        'ZIP CODE': 'zipCode',
                        'ZIP/POSTAL CODE': 'zipCode',
                        'POSTAL CODE': 'zipCode',
                        'POST CODE': 'zipCode',
                        'PIN CODE': 'zipCode',
                        'TAX IDENTIFICATION NO.': 'taxId',
                        'TAX ID': 'taxId',
                        'TAX ID NO.': 'taxId',
                        'TAX ID NO': 'taxId',
                        'TIN': 'taxId',
                        'SSS NO.': 'sssNo',
                        'SSS NO': 'sssNo',
                        'SSS NUMBER': 'sssNo',
                        'BENEFICIARY': 'beneficiary',
                        // Direct Upline's Data
                        'UPLINE NAME': 'uplineName',
                        'DIRECT UPLINE\'S NAME': 'uplineName',
                        'DIRECT UPLINE NAME': 'uplineName',
                        'UPLINE': 'uplineName',
                        'DIRECT UPLINE\'S ID NO.': 'uplineIdNo',
                        'UPLINE ID NO.': 'uplineIdNo',
                        'UPLINE ID NO': 'uplineIdNo',
                        'UPLINE ID': 'uplineIdNo',
                        'DIRECT UPLINE ID': 'uplineIdNo',
                        'UPLINE MAILING ADDRESS': 'uplineAddress',
                        'UPLINE ADDRESS': 'uplineAddress',
                        'UPLINE CITY': 'uplineCity',
                        'UPLINE MOBILE': 'uplineMobile',
                        'UPLINE MOBILE NO.': 'uplineMobile',
                        'UPLINE ZIP CODE': 'uplineZipCode',
                        'UPLINE ZIP': 'uplineZipCode',
                        // Sponsor's Data
                        'SPONSOR NAME': 'sponsorName',
                        'SPONSOR\'S NAME': 'sponsorName',
                        'SPONSOR': 'sponsorName',
                        'SPONSOR\'S ID NO.': 'sponsorIdNo',
                        'SPONSOR ID NO.': 'sponsorIdNo',
                        'SPONSOR ID NO': 'sponsorIdNo',
                        'SPONSOR ID': 'sponsorIdNo',
                        'SPONSOR CODE': 'sponsorIdNo',
                        'SPONSOR. CODE': 'sponsorIdNo',
                        // Agreement Details
                        'AGREEMENT DATE': 'agreementDate',
                        'DATE': 'agreementDate',
                        'APPLICANT\'S SIGNATURE': 'applicantSignature',
                        'SIGNATURE': 'applicantSignature',
                        'APPLICANT SIGNATURE': 'applicantSignature',
                        // FOR OFFICIAL USE ONLY
                        'DATE RECEIVED': 'dateReceived',
                        'RECEIVED BY': 'receivedBy',
                        'PROCESSED BY': 'processedBy',
                        // Legacy/Other fields (for backward compatibility)
                        'S.NO.': 'serialNo',
                        'SN': 'serialNo',
                        'ADD2': 'address2',
                        'ADD3': 'address3',
                        'STATE': 'state',
                        'GST NO.': 'gstNo',
                        'GST NUMBER': 'gstNo',
                        'GST': 'gstNo',
                        'PAN NO.': 'panNo',
                        'PAN NUMBER': 'panNo',
                        'PAN': 'panNo',
                        'BANK NAME': 'bankName',
                        'BANK': 'bankName',
                        'ACCOUNT NO.': 'accountNo',
                        'ACCOUNT NUMBER': 'accountNo',
                        'ACCOUNT': 'accountNo',
                        'IFSC CODE': 'ifscCode',
                        'IFSC': 'ifscCode',
                        'ACCOUNT HOLDER NAME': 'accountHolderName',
                        'COMMISSION RATE': 'commissionRate',
                        'COMMISSION': 'commissionRate',
                        'STATUS': 'status',
                        'DATE OF JOINING': 'dateOfJoining',
                        'DATE JOINED': 'dateOfJoining',
                        'REFERRED BY': 'referredBy'
                    };
                    return map;
                };
                
                const columnMap = createColumnMap();
                
                // Parse data rows
                const newDistributors = [];
                console.log('\n=== PARSING ROWS ===');
                for (let i = 0; i < rows.length; i++) {
                    const values = rows[i];
                    const distributor = { id: 'DIST-' + Date.now() + '-' + i };
                    
                    console.log(`\nRow ${i + 1}:`, values);
                    console.log('Headers:', header);
                    
                    // Map columns based on header (case-insensitive)
                    header.forEach((colName, index) => {
                        // Normalize column name to uppercase for case-insensitive matching
                        const upperColName = colName.toUpperCase().trim();
                        const mappedKey = columnMap[upperColName];
                        
                        const value = values[index];
                        
                        // Only process if we have a mapped key
                        if (mappedKey && value !== undefined && value !== null) {
                            const trimmedValue = String(value).trim();
                            if (trimmedValue !== '') {
                                distributor[mappedKey] = trimmedValue;
                                console.log(`  Mapped "${colName}" -> ${mappedKey}: "${trimmedValue}"`);
                            }
                        } else {
                            console.log(`  Column "${colName}" not mapped (normalized: "${upperColName}")`);
                        }
                    });
                    
                    // Preserve ONLY essential original columns to save storage space
                    // Store all data in _originalColumns but only save essential fields to localStorage
                    distributor._originalColumns = {};
                    header.forEach((colName, index) => {
                        const value = values[index];
                        if (value !== undefined && value !== null) {
                            const trimmedValue = String(value).trim();
                            if (trimmedValue !== '') {
                                distributor._originalColumns[colName] = trimmedValue;
                            }
                        }
                    });
                    
                    // Store all fields from agreement form (not just lightweight version)
                    const distributorRecord = {
                        id: distributor.id,
                        distributorCode: distributor.distributorCode || null,
                        distributorName: distributor.distributorName || null,
                        // Distributor's Data
                        birthdate: distributor.birthdate || null,
                        age: distributor.age || null,
                        sex: distributor.sex || null,
                        nationality: distributor.nationality || null,
                        mobileNo: distributor.mobileNo || distributor.mobile || null,
                        residencePhone: distributor.residencePhone || null,
                        officePhone: distributor.officePhone || null,
                        email: distributor.email || null,
                        address1: distributor.address1 || distributor.address || null,
                        city: distributor.city || null,
                        zipCode: distributor.zipCode || distributor.pinCode || null,
                        taxId: distributor.taxId || null,
                        sssNo: distributor.sssNo || null,
                        beneficiary: distributor.beneficiary || null,
                        // Direct Upline's Data
                        uplineName: distributor.uplineName || null,
                        uplineIdNo: distributor.uplineIdNo || null,
                        uplineAddress: distributor.uplineAddress || null,
                        uplineCity: distributor.uplineCity || null,
                        uplineMobile: distributor.uplineMobile || null,
                        uplineZipCode: distributor.uplineZipCode || null,
                        // Sponsor's Data
                        sponsorName: distributor.sponsorName || null,
                        sponsorIdNo: distributor.sponsorIdNo || distributor.referredBy || null,
                        // Agreement Details
                        agreementDate: distributor.agreementDate || null,
                        applicantSignature: distributor.applicantSignature || null,
                        dateReceived: distributor.dateReceived || null,
                        receivedBy: distributor.receivedBy || null,
                        processedBy: distributor.processedBy || null,
                        // Legacy fields (for backward compatibility)
                        status: distributor.status || 'active',
                        commissionRate: distributor.commissionRate || 0,
                        dateOfJoining: distributor.dateOfJoining || distributor.agreementDate || null,
                        // Store original columns for display
                        _originalColumns: distributor._originalColumns
                    };
                    
                    console.log('Distributor object created:', distributorRecord);
                    
                    // VALIDATION: Only name and NB number are required
                    const hasName = distributorRecord.distributorName && distributorRecord.distributorName.trim() !== '';
                    const hasCode = distributorRecord.distributorCode && distributorRecord.distributorCode.trim() !== '';
                    
                    if (!hasName || !hasCode) {
                        console.log(`âœ— Row ${i + 1} skipped - missing required fields. Name: ${hasName ? 'âœ“' : 'âœ—'}, NB Number: ${hasCode ? 'âœ“' : 'âœ—'}`);
                        continue;
                    }
                    
                    // Normalize NB number format (ensure it starts with NB and is uppercase)
                    if (hasCode) {
                        const code = distributorRecord.distributorCode.trim().toUpperCase();
                        if (code.match(/^NB\d+$/i)) {
                            distributorRecord.distributorCode = code;
                        } else if (code.match(/^\d+$/)) {
                            // If it's just numbers, add NB prefix
                            distributorRecord.distributorCode = 'NB' + code;
                        } else {
                            // Try to extract NB number
                            const nbMatch = code.match(/NB\d+/i);
                                if (nbMatch) {
                                distributorRecord.distributorCode = nbMatch[0].toUpperCase();
                                } else {
                                console.log(`âš ï¸ Row ${i + 1}: Invalid NB number format "${code}", skipping`);
                                continue;
                            }
                        }
                    }
                    
                    // Add to list
                    newDistributors.push(distributorRecord);
                    console.log(`âœ“ Row ${i + 1} added (NB: ${distributorRecord.distributorCode}, Name: ${distributorRecord.distributorName})`);
                }
                
                console.log('\n=== SUMMARY ===');
                console.log(`Parsed ${newDistributors.length} distributors from ${rows.length} data rows`);
                
                // Check for duplicates - normalize codes for case-insensitive comparison
                const existingCodes = new Set(
                    distributors
                        .map(d => (d.distributorCode || d.code || '').toString().toUpperCase().trim())
                        .filter(code => code !== '')
                );
                
                // Filter out duplicates (case-insensitive) and keep only new distributors
                const duplicates = [];
                const uniqueNewDistributors = [];
                
                for (const newDist of newDistributors) {
                    const code = (newDist.distributorCode || '').toString().toUpperCase().trim();
                    if (!code) {
                        // Distributor without code - add it as new
                        uniqueNewDistributors.push(newDist);
                    } else if (existingCodes.has(code)) {
                        // Duplicate found - skip it
                        duplicates.push(newDist);
                        console.log(`Skipping duplicate: ${code} - ${newDist.distributorName || 'N/A'}`);
                    } else {
                        // New distributor - add to list
                        uniqueNewDistributors.push(newDist);
                        existingCodes.add(code); // Add to set to prevent duplicates within the same batch
                    }
                }
                
                // Add only unique new distributors
                if (uniqueNewDistributors.length === 0) {
                    const duplicateCodes = duplicates.map(d => d.distributorCode || 'N/A').join(', ');
                    statusDiv.innerHTML = `<p style="color: #f39c12;">âš ï¸ All ${duplicates.length} distributor(s) are duplicates. None were added.</p><p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 5px;">Duplicate codes: ${duplicateCodes}</p>`;
                    fileInput.value = '';
                    return;
                }
                
                // Save to database via API (bulk insert)
                try {
                    const bulkResponse = await fetch('/api/distributors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(uniqueNewDistributors.map(dist => ({
                            distributor_code: dist.distributorCode,
                            distributor_name: dist.distributorName,
                            mobile_no: dist.mobileNo || null,
                            email: dist.email || null,
                            commission_rate: dist.commissionRate || 0,
                            status: dist.status || 'active',
                            branch: window.currentUser?.branch || null,
                            // Store all agreement form data in metadata
                            _agreement_data: {
                                birthdate: dist.birthdate,
                                age: dist.age,
                                sex: dist.sex,
                                nationality: dist.nationality,
                                residencePhone: dist.residencePhone,
                                officePhone: dist.officePhone,
                                address1: dist.address1,
                                city: dist.city,
                                zipCode: dist.zipCode,
                                taxId: dist.taxId,
                                sssNo: dist.sssNo,
                                beneficiary: dist.beneficiary,
                                uplineName: dist.uplineName,
                                uplineIdNo: dist.uplineIdNo,
                                uplineAddress: dist.uplineAddress,
                                uplineCity: dist.uplineCity,
                                uplineMobile: dist.uplineMobile,
                                uplineZipCode: dist.uplineZipCode,
                                sponsorName: dist.sponsorName,
                                sponsorIdNo: dist.sponsorIdNo,
                                agreementDate: dist.agreementDate,
                                applicantSignature: dist.applicantSignature,
                                dateReceived: dist.dateReceived,
                                receivedBy: dist.receivedBy,
                                processedBy: dist.processedBy,
                                uploadedAt: new Date().toISOString(),
                                uploadedBy: window.currentUser?.fullName || 'Admin'
                            }
                        })))
                    });
                    
                    if (!bulkResponse.ok) {
                        const error = await bulkResponse.json();
                        throw new Error(error.error || 'Failed to save distributors to database');
                    }
                    
                    const bulkResult = await bulkResponse.json();
                    console.log('âœ… Saved to database:', bulkResult);
                } catch (apiError) {
                    console.warn('Database save failed, saving locally:', apiError);
                }
                
                // Also save to local storage for immediate access
                distributors.push(...uniqueNewDistributors);
                
                // Try to save with error handling for quota exceeded
                try {
                    await saveDistributors();
                    let message = `<p style="color: #27ae60;">âœ… Successfully added ${uniqueNewDistributors.length} new distributor(s)!</p>`;
                    if (duplicates.length > 0) {
                        message += `<p style="color: #f39c12; font-size: 0.9rem; margin-top: 5px;">âš ï¸ Skipped ${duplicates.length} duplicate(s): ${duplicates.map(d => d.distributorCode || 'N/A').join(', ')}</p>`;
                    }
                    statusDiv.innerHTML = message;
                } catch (error) {
                    if (error.message.includes('quota')) {
                        statusDiv.innerHTML = `
                            <p style="color: #e74c3c;">âš ï¸ Storage limit reached!</p>
                            <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 10px;">
                                Local storage is full. Please clear some data or contact support.
                                <br><br>
                                Distributors in memory: ${distributors.length}
                                <br><br>
                                <button onclick="clearAllDistributors()" class="btn" style="padding: 8px 16px; background: #c41e3a; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    ðŸ—‘ï¸ Clear All Distributors
                                </button>
                            </p>
                        `;
                        // Remove the items we just added since save failed
                        distributors.splice(-newDistributors.length);
                    } else {
                        throw error;
                    }
                }
                
                fileInput.value = '';
                
                // Refresh distributor list
                displayDistributorList();
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #e74c3c;">âŒ Error: ${error.message}</p>`;
                console.error('Upload error:', error);
            }
        }
        
        function displayDistributorList() {
            const listDiv = document.getElementById('distributorList');
            
            // Update storage info
            updateStorageInfo();
            
            if (distributors.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No distributors uploaded yet</p>';
                return;
            }
            
            // Get headers from first distributor's _originalColumns (in original CSV order)
            let headers = [];
            if (distributors[0] && distributors[0]._originalColumns) {
                headers = Object.keys(distributors[0]._originalColumns);
            }
            
            // Build table
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; background: white;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%); color: white;">
                            ${headers.map(h => `<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            distributors.forEach((dist, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        ${headers.map(h => {
                            const value = dist._originalColumns && dist._originalColumns[h] ? dist._originalColumns[h] : 'N/A';
                            return `<td style="padding: 8px; border: 1px solid #ddd;">${value}</td>`;
                        }).join('')}
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = html;
        }
        
        function searchDistributors() {
            const searchTerm = document.getElementById('distributorSearch').value.toLowerCase();
            const filtered = distributors.filter(d => 
                (d.distributorName || d.name || '').toLowerCase().includes(searchTerm) ||
                (d.distributorCode || d.code || '').toLowerCase().includes(searchTerm) ||
                (d.mobileNo || d.mobile || '').includes(searchTerm)
            );
            
            const listDiv = document.getElementById('distributorList');
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No distributors found</p>';
                return;
            }
            
            listDiv.innerHTML = filtered.map((dist, index) => `
                <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid ${dist.status === 'Active' ? '#27ae60' : '#95a5a6'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${dist.distributorName || dist.name || 'N/A'}</h4>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                <strong>Code:</strong> ${dist.distributorCode || dist.code || 'N/A'} | 
                                <strong>Mobile:</strong> ${dist.mobileNo || dist.mobile || 'N/A'} | 
                                <strong>Status:</strong> ${dist.status || 'Unknown'}
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                ${dist.city || ''} ${dist.state || ''} ${dist.pinCode || ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAllDistributors() {
            document.getElementById('distributorSearch').value = '';
            displayDistributorList();
        }
        
        function exportDistributors() {
            const dataStr = JSON.stringify(distributors, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'distributors.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function clearAllDistributors() {
            if (confirm('âš ï¸ Are you sure you want to delete ALL distributors? This action cannot be undone.')) {
                distributors = [];
                await saveDistributors();
                displayDistributorList();
                document.getElementById('distributorUploadStatus').innerHTML = '<p style="color: #27ae60;">âœ… All distributors cleared. You can now upload a new file.</p>';
            }
        }
        
        function checkStorageSpace() {
            try {
                const testKey = '__storage_test__';
                const testValue = 'x'.repeat(1024 * 1024); // 1MB
                
                // Get current usage
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length + key.length;
                    }
                }
                
                // Estimate max size (5MB for most browsers)
                const maxSize = 5 * 1024 * 1024; // 5MB
                const usedPercent = (totalSize / maxSize) * 100;
                
                return {
                    used: (totalSize / 1024 / 1024).toFixed(2),
                    max: (maxSize / 1024 / 1024).toFixed(0),
                    percent: usedPercent.toFixed(1)
                };
            } catch (e) {
                return { used: '?', max: '?', percent: '?' };
            }
        }

        // ==================== STOCK MANAGEMENT FUNCTIONS ====================
        
        // Stock data storage
        let countryStock = [];
        let windhoekStock = [];
        let ondangwaStock = [];
        let distributionHistory = [];
        let demandForecasts = [];
        let purchaseOrdersDetailed = [];
        let asnQueue = [];
        let qualityInspections = [];
        let putawayTasks = [];
        let branchReplenishmentRequests = [];
        let returnsLog = [];
        let replenishmentSuggestionCache = [];
        let reorderScenarios = [];

        const STOCK_STORAGE_KEYS = {
            forecasts: 'dyna_demand_forecasts',
            purchaseOrders: 'dyna_purchase_orders_detailed',
            asn: 'dyna_asn_queue',
            quality: 'dyna_quality_checks',
            putaway: 'dyna_putaway_tasks',
            branchRequests: 'dyna_branch_replenishment_requests',
            returns: 'dyna_returns_log',
            replenishment: 'dyna_replenishment_suggestions',
            scenarios: 'dyna_reorder_scenarios'
        };

        // Load stock data from localStorage
        function loadStockData() {
            countryStock = safeParseFromStorage('dyna_countryStock', '[]');
            windhoekStock = safeParseFromStorage('dyna_windhoekStock', '[]');
            ondangwaStock = safeParseFromStorage('dyna_ondangwaStock', '[]');
            distributionHistory = safeParseFromStorage('dyna_distributionHistory', '[]');

            demandForecasts = safeParseFromStorage(STOCK_STORAGE_KEYS.forecasts, '[]');
            purchaseOrdersDetailed = safeParseFromStorage(STOCK_STORAGE_KEYS.purchaseOrders, '[]');
            if (!Array.isArray(purchaseOrdersDetailed)) purchaseOrdersDetailed = [];

            const legacyPOs = safeParseFromStorage('dyna_purchase_orders', '[]');
            if (legacyPOs.length && purchaseOrdersDetailed.length === 0) {
                purchaseOrdersDetailed = legacyPOs.map(po => ({
                    id: po.id || ('PO-' + Date.now()),
                    supplier: po.supplier || 'Unknown Supplier',
                    number: po.number || po.id || ('PO-' + Math.random().toString(36).slice(2, 8).toUpperCase()),
                    eta: po.eta || '',
                    value: Number(po.value || 0),
                    currency: po.currency || 'NAD',
                    items: Array.isArray(po.items) ? po.items : ((po.items || '').toString().split(/\n|;/).map(i => i.trim()).filter(Boolean)),
                    linked: po.linked || '',
                    status: po.status || 'Open',
                    notes: po.notes || '',
                    createdAt: po.createdAt || new Date().toISOString(),
                    updatedAt: po.updatedAt || po.createdAt || new Date().toISOString()
                }));
            }

            asnQueue = safeParseFromStorage(STOCK_STORAGE_KEYS.asn, '[]');
            qualityInspections = safeParseFromStorage(STOCK_STORAGE_KEYS.quality, '[]');
            putawayTasks = safeParseFromStorage(STOCK_STORAGE_KEYS.putaway, '[]');
            branchReplenishmentRequests = safeParseFromStorage(STOCK_STORAGE_KEYS.branchRequests, '[]');
            returnsLog = safeParseFromStorage(STOCK_STORAGE_KEYS.returns, '[]');
            replenishmentSuggestionCache = safeParseFromStorage(STOCK_STORAGE_KEYS.replenishment, '[]');
            reorderScenarios = safeParseFromStorage(STOCK_STORAGE_KEYS.scenarios, '[]');
        }

        // Save stock data to localStorage
        function saveStockData() {
            localStorage.setItem('dyna_countryStock', JSON.stringify(countryStock));
            localStorage.setItem('dyna_windhoekStock', JSON.stringify(windhoekStock));
            localStorage.setItem('dyna_ondangwaStock', JSON.stringify(ondangwaStock));
            localStorage.setItem('dyna_distributionHistory', JSON.stringify(distributionHistory));
        }

        const persistDemandForecasts = () => localStorage.setItem(STOCK_STORAGE_KEYS.forecasts, JSON.stringify(demandForecasts));
        const persistPurchaseOrders = () => localStorage.setItem(STOCK_STORAGE_KEYS.purchaseOrders, JSON.stringify(purchaseOrdersDetailed));
        const persistAsnQueue = () => localStorage.setItem(STOCK_STORAGE_KEYS.asn, JSON.stringify(asnQueue));
        const persistQualityChecks = () => localStorage.setItem(STOCK_STORAGE_KEYS.quality, JSON.stringify(qualityInspections));
        const persistPutawayTasks = () => localStorage.setItem(STOCK_STORAGE_KEYS.putaway, JSON.stringify(putawayTasks));
        const persistBranchRequests = () => localStorage.setItem(STOCK_STORAGE_KEYS.branchRequests, JSON.stringify(branchReplenishmentRequests));
        const persistReturnsLog = () => localStorage.setItem(STOCK_STORAGE_KEYS.returns, JSON.stringify(returnsLog));
        const persistReplenishmentSuggestions = () => localStorage.setItem(STOCK_STORAGE_KEYS.replenishment, JSON.stringify(replenishmentSuggestionCache));
        const persistReorderScenarios = () => localStorage.setItem(STOCK_STORAGE_KEYS.scenarios, JSON.stringify(reorderScenarios));

        function renderPlanInsights() {
            const list = document.getElementById('planInsights');
            if (!list) return;
            loadStockData();

            const openPOs = purchaseOrdersDetailed.filter(po => po.status !== 'Delivered').length;
            const inboundCartons = asnQueue.reduce((sum, asn) => sum + Number(asn.cartons || 0), 0);
            const qualityOnHold = qualityInspections.filter(qc => (qc.disposition || '').toLowerCase() === 'quarantine').length;
            const barcodeStock = safeParseFromStorage('dyna_barcode_stock', '[]');
            const expiringSoon = barcodeStock.filter(batch => {
                if (!batch.expiry && !batch.expiryDate) return false;
                const expiry = new Date(batch.expiry || batch.expiryDate);
                const diffDays = (expiry - new Date()) / (1000 * 60 * 60 * 24);
                return diffDays >= 0 && diffDays <= 60;
            }).length;

            // Get auto-generated PO suggestions from stock movements
            let poSuggestions = null;
            try {
                const suggestionsData = localStorage.getItem('dyna_po_suggestions');
                if (suggestionsData) {
                    poSuggestions = JSON.parse(suggestionsData);
                }
            } catch(_) {}

            const bullets = [
                `ðŸ“¦ ${openPOs} purchase orders still open â€” ensure supplier follow-ups are in place.`,
                `ðŸš› ${asnQueue.length} inbound shipments registered covering ${inboundCartons} cartons.`,
                qualityOnHold
                    ? `ðŸ§ª ${qualityOnHold} batches currently quarantined pending QC sign-off.`
                    : 'ðŸ§ª All inspected batches are released.',
                expiringSoon
                    ? `â³ ${expiringSoon} batches expiring within 60 days â€” consider branch pull-through campaigns.`
                    : 'âœ… No batches expiring in the next 60 days.'
            ];

            // Add stock movement-based suggestions
            if (poSuggestions && poSuggestions.products && poSuggestions.products.length > 0) {
                const suggestionText = `ðŸ”„ ${poSuggestions.products.length} product(s) identified for auto-reorder based on stock movements â€” click "Auto-Generate from Stock Movements" to create purchase orders.`;
                bullets.unshift(suggestionText); // Add at the top as most important
            }

            list.innerHTML = bullets.map(text => `<li>${text}</li>`).join('');
        }

        function renderSupplierScorecard() {
            const table = document.getElementById('supplierScorecard');
            if (!table) return;
            loadStockData();

            if (!purchaseOrdersDetailed.length) {
                table.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No purchase orders captured yet.</p>';
                return;
            }

            const supplierMap = new Map();
            purchaseOrdersDetailed.forEach(po => {
                const supplier = (po.supplier || 'Unknown Supplier').trim();
                if (!supplierMap.has(supplier)) {
                    supplierMap.set(supplier, { total: 0, open: 0, delivered: 0, value: 0, leadTimes: [], qualityIssues: 0 });
                }
                const bucket = supplierMap.get(supplier);
                bucket.total += 1;
                bucket.value += Number(po.value || 0);
                if (po.status === 'Delivered') bucket.delivered += 1; else bucket.open += 1;
                if (po.receivedAt && po.createdAt) {
                    const lead = (new Date(po.receivedAt) - new Date(po.createdAt)) / (1000 * 60 * 60 * 24);
                    if (!Number.isNaN(lead)) bucket.leadTimes.push(Math.max(0, Math.round(lead)));
                }
            });

            qualityInspections.forEach(qc => {
                const supplier = (qc.supplier || qc.linkedSupplier || '').trim();
                if (!supplier) return;
                const bucket = supplierMap.get(supplier);
                if (!bucket) return;
                if ((qc.disposition || '').toLowerCase() !== 'released') bucket.qualityIssues += 1;
            });

            const rows = Array.from(supplierMap.entries()).map(([supplier, stats]) => {
                const avgLead = stats.leadTimes.length
                    ? (stats.leadTimes.reduce((a, b) => a + b, 0) / stats.leadTimes.length).toFixed(1)
                    : 'â€”';
                const qualityRate = stats.total ? Math.round(((stats.total - stats.qualityIssues) / stats.total) * 100) : 100;
                return `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd; font-weight:600;">${supplier}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${stats.total}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${stats.open}</td>
                        <td style="padding:10px; border:1px solid #ddd;">N$ ${stats.value.toFixed(2)}</td>
                        <td style="padding:10px; border:1px solid #ddd;">${avgLead} days</td>
                        <td style="padding:10px; border:1px solid #ddd; color:${qualityRate < 95 ? '#e67e22' : '#27ae60'};">${qualityRate}% pass</td>
                    </tr>
                `;
            }).join('');

            table.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#c41e3a; color:white;">
                            <th style="padding:10px; text-align:left;">Supplier</th>
                            <th style="padding:10px; text-align:left;">Total POs</th>
                            <th style="padding:10px; text-align:left;">Open</th>
                            <th style="padding:10px; text-align:left;">Value</th>
                            <th style="padding:10px; text-align:left;">Avg Lead Time</th>
                            <th style="padding:10px; text-align:left;">Quality Pass Rate</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function handleForecastSubmit(event) {
            event.preventDefault();
            const sku = (document.getElementById('forecastSku')?.value || '').trim();
            if (!sku) return;
            const forecast = {
                id: 'FC-' + Date.now(),
                sku,
                location: document.getElementById('forecastLocation')?.value || 'country',
                horizon: document.getElementById('forecastHorizon')?.value || 'monthly',
                method: document.getElementById('forecastMethod')?.value || 'exponential',
                quantity: Number(document.getElementById('forecastQuantity')?.value || 0),
                notes: document.getElementById('forecastNotes')?.value || '',
                createdBy: currentUser?.fullName || 'system',
                createdAt: new Date().toISOString()
            };
            demandForecasts.unshift(forecast);
            persistDemandForecasts();
            event.target.reset();
            renderForecastList();
            renderPlanInsights();
        }

        function renderForecastList() {
            const container = document.getElementById('forecastList');
            if (!container) return;
            loadStockData();

            if (!demandForecasts.length) {
                container.innerHTML = '<div style="padding:20px; border:1px dashed #ccc; border-radius:8px; text-align:center; color:#666;">No forecasts captured yet. Start by modelling expected demand.</div>';
                return;
            }

            container.innerHTML = demandForecasts.slice(0, 8).map(forecast => `
                <div class="client-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${forecast.sku}</div>
                            <div style="font-size:.85rem; color:#666;">${forecast.location.toUpperCase()} â€¢ ${forecast.horizon}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.4rem; font-weight:700; color:#27ae60;">${forecast.quantity}</div>
                            <div style="font-size:.75rem; color:#999;">${forecast.method}</div>
                        </div>
                    </div>
                    ${forecast.notes ? `<p style="margin-top:8px; color:#555;">${forecast.notes}</p>` : ''}
                    <div style="font-size:.75rem; color:#999; margin-top:6px;">Created ${new Date(forecast.createdAt).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function handlePurchaseOrderSubmit(event) {
            event.preventDefault();
            const supplier = (document.getElementById('poSupplier')?.value || '').trim();
            if (!supplier) return;
            const po = {
                id: 'PO-' + Date.now(),
                supplier,
                number: (document.getElementById('poNumber')?.value || '').trim() || ('PO-' + Date.now()),
                eta: document.getElementById('poEta')?.value || '',
                value: Number(document.getElementById('poValue')?.value || 0),
                currency: document.getElementById('poCurrency')?.value || 'NAD',
                items: (document.getElementById('poItems')?.value || '').split(/\n|;/).map(i => i.trim()).filter(Boolean),
                linked: document.getElementById('poLinked')?.value || '',
                status: document.getElementById('poStatus')?.value || 'Open',
                notes: document.getElementById('poNotes')?.value || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            purchaseOrdersDetailed.unshift(po);
            persistPurchaseOrders();
            event.target.reset();
            renderPurchaseOrders();
            renderSupplierScorecard();
            renderPlanInsights();
        }

        function renderPurchaseOrders() {
            const container = document.getElementById('purchaseOrderList');
            if (!container) return;
            loadStockData();

            if (!purchaseOrdersDetailed.length) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No purchase orders recorded yet.</p>';
                return;
            }

            container.innerHTML = purchaseOrdersDetailed.slice(0, 6).map(po => `
                <div class="client-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${po.number}</div>
                            <div style="font-size:.85rem; color:#666;">${po.supplier}</div>
                            <div style="font-size:.8rem; color:#999;">Created ${new Date(po.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right;">
                            <span style="display:inline-block; padding:4px 8px; border-radius:12px; background:${po.status==='Delivered' ? '#e8f5e9' : '#e8f4fd'}; color:${po.status==='Delivered' ? '#2e7d32' : '#1565c0'}; font-size:.8rem;">${po.status}</span>
                            <div style="font-size:1.1rem; font-weight:700; color:#27ae60; margin-top:6px;">${po.currency || 'NAD'} ${Number(po.value || 0).toFixed(2)}</div>
                        </div>
                    </div>
                    ${po.items && po.items.length ? `<div style="font-size:.85rem; color:#555; margin-top:8px;">${po.items.slice(0, 3).join(', ')}${po.items.length > 3 ? 'â€¦' : ''}</div>` : ''}
                    ${po.notes ? `<p style="font-size:.8rem; color:#777; margin-top:6px;">${po.notes}</p>` : ''}
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                        <button class="btn btn-success" style="flex:1; min-width:120px;" onclick="updatePurchaseOrderStatus('${po.id}', 'Delivered')">Mark Delivered</button>
                        <button class="btn btn-info" style="flex:1; min-width:120px;" onclick="updatePurchaseOrderStatus('${po.id}', 'In Transit')">In Transit</button>
                        <button class="btn" style="flex:1; min-width:120px;" onclick="updatePurchaseOrderStatus('${po.id}', 'Open')">Reopen</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePurchaseOrderStatus(poId, status) {
            const po = purchaseOrdersDetailed.find(p => p.id === poId);
            if (!po) return;
            po.status = status;
            po.updatedAt = new Date().toISOString();
            persistPurchaseOrders();
            renderPurchaseOrders();
            renderSupplierScorecard();
            renderPlanInsights();
        }

        function exportPurchaseOrders() {
            if (!purchaseOrdersDetailed.length) {
                alert('No purchase orders to export.');
                return;
            }
            const rows = ['PO Number,Supplier,Status,ETA,Value,Currency,Items'];
            purchaseOrdersDetailed.forEach(po => {
                rows.push([
                    po.number,
                    po.supplier,
                    po.status,
                    po.eta || '',
                    Number(po.value || 0).toFixed(2),
                    po.currency || 'NAD',
                    (po.items || []).join(' | ')
                ].map(v => String(v).replace(/,/g, ' ')).join(','));
            });
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'purchase_orders.csv';
            link.click();
        }

        function handleASNSubmit(event) {
            event.preventDefault();
            const asn = {
                id: 'ASN-' + Date.now(),
                supplier: (document.getElementById('asnSupplier')?.value || '').trim(),
                reference: (document.getElementById('asnReference')?.value || '').trim(),
                po: document.getElementById('asnPO')?.value || '',
                eta: document.getElementById('asnEta')?.value || '',
                cartons: Number(document.getElementById('asnCartons')?.value || 0),
                temperature: document.getElementById('asnTemperature')?.value || 'ambient',
                allocation: document.getElementById('asnAllocation')?.value || 'windhoek',
                contact: document.getElementById('asnContact')?.value || '',
                notes: document.getElementById('asnNotes')?.value || '',
                status: 'In Transit',
                createdAt: new Date().toISOString()
            };
            asnQueue.unshift(asn);
            persistAsnQueue();
            event.target.reset();
            renderASNList();
            renderPlanInsights();
        }

        function renderASNList() {
            const container = document.getElementById('asnList');
            if (!container) return;
            loadStockData();
            if (!asnQueue.length) {
                container.innerHTML = '<div style="padding:20px; border:1px dashed #ccc; border-radius:8px; text-align:center; color:#666;">No ASNs registered. Capture supplier pre-alerts here.</div>';
                return;
            }
            container.innerHTML = asnQueue.slice(0, 6).map(asn => `
                <div class="client-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${asn.reference}</div>
                            <div style="font-size:.85rem; color:#666;">${asn.supplier} â€¢ ${asn.allocation.toUpperCase()}</div>
                            <div style="font-size:.8rem; color:#999;">ETA ${asn.eta ? new Date(asn.eta).toLocaleString() : 'TBC'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:#27ae60;">${asn.cartons} cartons</div>
                            <span style="font-size:.75rem; color:#999;">${asn.temperature}</span>
                        </div>
                    </div>
                    ${asn.notes ? `<p style="margin-top:8px; color:#555;">${asn.notes}</p>` : ''}
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="btn btn-success" style="flex:1;" onclick="markASNArrived('${asn.id}')">Arrived</button>
                        <button class="btn btn-info" style="flex:1;" onclick="promoteASNToPutaway('${asn.id}')">Create Put-away Tasks</button>
                        <button class="btn" style="flex:1;" onclick="removeASN('${asn.id}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function markASNArrived(asnId) {
            const asn = asnQueue.find(a => a.id === asnId);
            if (!asn) return;
            asn.status = 'Arrived';
            asn.arrivedAt = new Date().toISOString();
            persistAsnQueue();
            renderASNList();
        }

        function removeASN(asnId) {
            asnQueue = asnQueue.filter(a => a.id !== asnId);
            persistAsnQueue();
            renderASNList();
        }

        function promoteASNToPutaway(asnId) {
            const asn = asnQueue.find(a => a.id === asnId);
            if (!asn) return;
            const task = {
                id: 'PT-' + Date.now(),
                reference: asn.reference,
                sku: asn.reference,
                quantity: Number(asn.cartons || 0),
                location: asn.allocation === 'windhoek' ? 'Windhoek inbound' : 'Ondangwa inbound',
                zone: asn.temperature,
                priority: 'high',
                notes: asn.notes || '',
                status: 'open',
                createdAt: new Date().toISOString()
            };
            putawayTasks.unshift(task);
            persistPutawayTasks();
            renderPutawayQueue();
        }

        function handleQualitySubmit(event) {
            event.preventDefault();
            const inspection = {
                id: 'QC-' + Date.now(),
                batch: (document.getElementById('qcBatch')?.value || '').trim(),
                asn: document.getElementById('qcAsn')?.value || '',
                date: document.getElementById('qcDate')?.value || new Date().toISOString().split('T')[0],
                temperature: document.getElementById('qcTemperature')?.value || '',
                visual: document.getElementById('qcVisual')?.value || 'Pass',
                docs: document.getElementById('qcDocs')?.value || 'Complete',
                disposition: document.getElementById('qcDisposition')?.value || 'Released',
                holdUntil: document.getElementById('qcHold')?.value || '',
                notes: document.getElementById('qcNotes')?.value || '',
                supplier: asnQueue.find(a => a.reference === document.getElementById('qcAsn')?.value)?.supplier || '',
                createdAt: new Date().toISOString()
            };
            qualityInspections.unshift(inspection);
            persistQualityChecks();
            event.target.reset();
            renderQualityList();
            renderSupplierScorecard();
            renderPlanInsights();
        }

        function renderQualityList() {
            const container = document.getElementById('qualityList');
            if (!container) return;
            loadStockData();
            if (!qualityInspections.length) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No quality inspections logged yet.</p>';
                return;
            }
            container.innerHTML = qualityInspections.slice(0, 6).map(qc => `
                <div class="client-card" style="border-left:4px solid ${qc.disposition==='Released' ? '#27ae60' : (qc.disposition==='Quarantine' ? '#f39c12' : '#e74c3c')};">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">Batch ${qc.batch}</div>
                            <div style="font-size:.85rem; color:#666;">${qc.asn || 'No ASN'} â€¢ ${qc.date}</div>
                        </div>
                        <div style="text-align:right; font-size:.85rem; color:#555;">${qc.disposition}</div>
                    </div>
                    ${qc.notes ? `<p style="margin-top:6px; color:#555;">${qc.notes}</p>` : ''}
                </div>
            `).join('');
        }

        function generateReplenishmentSuggestions() {
            loadStockData();
            const target = document.getElementById('replenishTarget')?.value || 'ondangwa';
            const horizon = Number(document.getElementById('replenishHorizon')?.value || 7);
            const serviceLevel = Number(document.getElementById('replenishServiceLevel')?.value || 0.95);
            const blend = document.getElementById('replenishForecastBlend')?.value || 'hybrid';

            const suggestions = [];
            const consumptionData = getBranchConsumptionSnapshot(horizon);

            Object.keys(consumptionData).forEach(product => {
                const dailyDemand = consumptionData[product] / horizon;
                const safetyFactor = serviceLevel >= 0.99 ? 2.5 : serviceLevel >= 0.95 ? 1.65 : 1.2;
                const demandProjection = Math.round((dailyDemand * horizon) + (safetyFactor * Math.sqrt(Math.max(0, dailyDemand * horizon))));
                const sourceStock = target === 'ondangwa' ? windhoekStock : countryStock;
                const sourceItem = sourceStock.find(item => item.productName === product);
                if (!sourceItem) return;
                const available = Number(sourceItem.quantity || 0);
                const quantity = Math.max(0, Math.min(available, demandProjection));
                if (quantity <= 0) return;
                suggestions.push({
                    id: 'RS-' + Date.now() + Math.random().toString(36).slice(2, 6),
                    product,
                    quantity,
                    source: target === 'ondangwa' ? 'windhoek' : 'country',
                    destination: target,
                    justification: `${blend === 'forecast' ? 'Forecast-led' : blend === 'sales' ? 'Sales-led' : 'Hybrid'} replenishment for ${horizon} day horizon`,
                    createdAt: new Date().toISOString()
                });
            });

            replenishmentSuggestionCache = suggestions;
            persistReplenishmentSuggestions();
            renderReplenishmentSuggestions();
        }

        function clearReplenishmentSuggestions() {
            replenishmentSuggestionCache = [];
            persistReplenishmentSuggestions();
            const container = document.getElementById('replenishmentSuggestions');
            if (container) container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No suggestions generated.</p>';
        }

        function renderReplenishmentSuggestions() {
            const container = document.getElementById('replenishmentSuggestions');
            if (!container) return;
            loadStockData();
            if (!replenishmentSuggestionCache.length) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No suggestions generated.</p>';
                return;
            }
            container.innerHTML = replenishmentSuggestionCache.map(s => `
                <div class="client-card" style="border-left:4px solid #2980b9;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${s.product}</div>
                            <div style="font-size:.85rem; color:#666;">${s.source.toUpperCase()} âžœ ${s.destination.toUpperCase()}</div>
                        </div>
                        <div style="text-align:right; font-size:1.2rem; font-weight:700; color:#27ae60;">${s.quantity}</div>
                    </div>
                    <p style="margin-top:8px; color:#555;">${s.justification}</p>
                    <div style="text-align:right; margin-top:8px;">
                        <button class="btn btn-success" onclick="acceptReplenishmentSuggestion('${s.id}')">Create Transfer</button>
                    </div>
                </div>
            `).join('');
        }

        function acceptReplenishmentSuggestion(id) {
            const suggestion = replenishmentSuggestionCache.find(s => s.id === id);
            if (!suggestion) return;
            const warehouseSelect = document.getElementById('distributionWarehouse');
            const productSelect = document.getElementById('distributionProduct');
            const quantityInput = document.getElementById('distributionQuantity');
            if (warehouseSelect) warehouseSelect.value = suggestion.source === 'windhoek' ? 'windhoek' : 'ondangwa';
            if (productSelect) productSelect.value = suggestion.product;
            if (quantityInput) quantityInput.value = suggestion.quantity;
            alert('Suggestion loaded into distribution form. Review and dispatch.');
        }

        function getBranchConsumptionSnapshot(days) {
            const walkInSales = safeParseFromStorage('walkInSales', '[]');
            const now = Date.now();
            const horizonMs = days * 24 * 60 * 60 * 1000;
            const totals = {};
            walkInSales.forEach(sale => {
                const saleDate = new Date(sale.date || sale.createdAt || now);
                if ((now - saleDate.getTime()) > horizonMs) return;
                (sale.items || []).forEach(item => {
                    if (!item.name) return;
                    totals[item.name] = (totals[item.name] || 0) + Number(item.quantity || 0);
                });
            });
            return totals;
        }

        function handleBranchRequestSubmit(event) {
            event.preventDefault();
            const request = {
                id: 'BR-' + Date.now(),
                branch: document.getElementById('branchRequestBranch')?.value || '',
                product: document.getElementById('branchRequestProduct')?.value || '',
                quantity: Number(document.getElementById('branchRequestQuantity')?.value || 0),
                requiredBy: document.getElementById('branchRequestDate')?.value || '',
                priority: document.getElementById('branchRequestPriority')?.value || 'medium',
                notes: document.getElementById('branchRequestNotes')?.value || '',
                status: 'Open',
                createdAt: new Date().toISOString()
            };
            branchReplenishmentRequests.unshift(request);
            persistBranchRequests();
            event.target.reset();
            renderBranchRequestList();
            updateBranchMetrics();
        }

        function renderBranchRequestList() {
            const container = document.getElementById('branchRequestList');
            if (!container) return;
            loadStockData();
            if (!branchReplenishmentRequests.length) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No branch requests captured.</p>';
                return;
            }
            container.innerHTML = branchReplenishmentRequests.slice(0, 6).map(req => `
                <div class="client-card" style="border-left:4px solid ${req.priority==='high' ? '#e74c3c' : req.priority==='medium' ? '#f39c12' : '#27ae60'};">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${req.branch}</div>
                            <div style="font-size:.85rem; color:#666;">${req.product}</div>
                        </div>
                        <div style="text-align:right; font-weight:700; color:#2c3e50;">${req.quantity}</div>
                    </div>
                    <div style="font-size:.8rem; color:#999; margin-top:6px;">Needed by ${req.requiredBy || 'TBC'} â€¢ ${req.priority.toUpperCase()}</div>
                    ${req.notes ? `<p style="margin-top:6px; color:#555;">${req.notes}</p>` : ''}
                </div>
            `).join('');
        }

        function updateBranchMetrics() {
            const sellThroughEl = document.getElementById('branchSellThrough');
            const lowStockEl = document.getElementById('branchLowStockCount');
            const requestsEl = document.getElementById('openBranchRequests');
            const scansEl = document.getElementById('todayScanCount');

            const consumption = Object.values(getBranchConsumptionSnapshot(1)).reduce((a, b) => a + b, 0);
            if (sellThroughEl) sellThroughEl.textContent = consumption.toString();

            const branchStock = safeParseFromStorage('branchInventory', '[]');
            const lowStock = branchStock.filter(item => Number(item.quantity || 0) <= Number(item.reorderLevel || 5)).length;
            if (lowStockEl) lowStockEl.textContent = lowStock.toString();

            if (requestsEl) requestsEl.textContent = branchReplenishmentRequests.filter(r => r.status === 'Open').length.toString();

            const scanAdjustments = safeParseFromStorage('dyna_scan_adjustments', '[]');
            const today = new Date().toDateString();
            const todayScans = scanAdjustments.filter(adj => new Date(adj.timestamp || Date.now()).toDateString() === today).length;
            if (scansEl) scansEl.textContent = todayScans.toString();
        }

        function renderBranchOpsInsights() {
            const container = document.getElementById('branchOpsInsights');
            if (!container) return;
            loadStockData();

            const insights = [];
            const branchStock = safeParseFromStorage('branchInventory', '[]');
            const lowStockItems = branchStock.filter(item => Number(item.quantity || 0) <= Number(item.reorderLevel || 5));
            if (lowStockItems.length) insights.push(`âš ï¸ ${lowStockItems.length} branch SKUs below reorder levels. Prioritize replenishment.`);

            const expiring = branchStock.filter(item => {
                const expiry = item.expiryDate || item.expiry;
                if (!expiry) return false;
                return (new Date(expiry) - new Date()) / (1000 * 60 * 60 * 24) <= 45;
            });
            if (expiring.length) insights.push(`â³ ${expiring.length} items expiring within 45 days. Consider markdowns or transfers.`);

            if (!insights.length) insights.push('âœ… Branch inventory healthy. No critical alerts.');
            container.innerHTML = insights.map(text => `<div style="background:#f8f9fa; border:1px solid #e1e5ec; border-radius:8px; padding:12px; color:#555;">${text}</div>`).join('');
        }

        function handleReturnSubmit(event) {
            event.preventDefault();
            const entry = {
                id: 'RTN-' + Date.now(),
                type: document.getElementById('returnType')?.value || 'customer',
                product: document.getElementById('returnProduct')?.value || '',
                batch: document.getElementById('returnBatch')?.value || '',
                quantity: Number(document.getElementById('returnQuantity')?.value || 0),
                reason: document.getElementById('returnReason')?.value || '',
                disposition: document.getElementById('returnDisposition')?.value || 'hold',
                notes: document.getElementById('returnNotes')?.value || '',
                createdAt: new Date().toISOString()
            };
            returnsLog.unshift(entry);
            persistReturnsLog();
            event.target.reset();
            renderReturnsList();
        }

        function renderReturnsList() {
            const container = document.getElementById('returnsList');
            if (!container) return;
            loadStockData();
            if (!returnsLog.length) {
                container.innerHTML = '<p style="text-align:center; color:#666;">No returns logged.</p>';
                return;
            }
            container.innerHTML = returnsLog.slice(0, 6).map(entry => `
                <div class="client-card" style="border-left:4px solid ${entry.disposition==='destroy' ? '#e74c3c' : '#f39c12'};">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${entry.product}</div>
                            <div style="font-size:.85rem; color:#666;">Batch ${entry.batch}</div>
                        </div>
                        <div style="text-align:right; font-weight:700; color:#2c3e50;">${entry.quantity}</div>
                    </div>
                    <div style="font-size:.8rem; color:#999;">${entry.type.toUpperCase()} â€¢ ${entry.disposition.toUpperCase()}</div>
                    ${entry.reason ? `<p style="margin-top:6px; color:#555;">${entry.reason}</p>` : ''}
                </div>
            `).join('');
        }

        function renderRouteBoard() {
            renderRouteOverview();
            renderColdChainAlerts();
            renderDeliveryTimeline();
        }

        function renderPutawayQueue() {
            const container = document.getElementById('putawayQueue');
            if (!container) return;
            loadStockData();
            if (!putawayTasks.length) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:10px;">No open put-away tasks.</p>';
                return;
            }
            container.innerHTML = putawayTasks.slice(0, 8).map(t => `
                <div class="client-card" style="border-left:4px solid ${t.status==='done' ? '#27ae60' : '#2980b9'};">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${t.reference}</div>
                            <div style="font-size:.85rem; color:#666;">${t.location} â€¢ ${t.zone || 'ambient'}</div>
                        </div>
                        <div style="font-weight:700; color:#2c3e50;">${t.quantity}</div>
                    </div>
                    ${t.notes ? `<p style=\"margin-top:6px; color:#555;\">${t.notes}</p>` : ''}
                    <div style="text-align:right; margin-top:8px;">
                        ${t.status !== 'done' ? `<button class=\"btn btn-success\" onclick=\"completePutawayTask('${t.id}')\">Complete</button>` : '<span style="color:#27ae60; font-weight:600;">Completed</span>'}
                    </div>
                </div>
            `).join('');
        }

        function completePutawayTask(taskId) {
            const task = putawayTasks.find(p => p.id === taskId);
            if (!task) return;
            task.status = 'done';
            task.completedAt = new Date().toISOString();
            persistPutawayTasks();
            renderPutawayQueue();
            renderWarehouseCapacity();
        }

        function renderWarehouseCapacity() {
            const container = document.getElementById('warehouseCapacity');
            if (!container) return;
            loadStockData();
            // Simple simulated capacity model
            const maxWindhoek = 10000; // units
            const usedWindhoek = windhoekStock.reduce((a, b) => a + Number(b.quantity || 0), 0);
            const pct = Math.min(100, Math.round((usedWindhoek / maxWindhoek) * 100));
            container.innerHTML = `
                <div style="background:#fff; border:1px solid #e1e5ec; border-radius:8px; padding:10px;">
                    <div style="display:flex; justify-content:space-between; font-weight:600; color:#2c3e50;">
                        <span>Windhoek Utilization</span>
                        <span>${usedWindhoek} / ${maxWindhoek}</span>
                    </div>
                    <div style="height:12px; background:#f1f3f5; border-radius:6px; margin-top:8px; overflow:hidden;">
                        <div style="width:${pct}%; height:100%; background:${pct>85?'#e74c3c':pct>70?'#f39c12':'#27ae60'};"></div>
                    </div>
                    <div style="margin-top:8px; font-size:.85rem; color:#666;">${pct}% used</div>
                </div>
            `;
        }

        function renderRouteOverview() {
            const container = document.getElementById('routeOverview');
            if (!container) return;
            loadStockData();
            if (!distributionHistory.length) {
                container.innerHTML = 'No dispatches recorded today.';
                return;
            }
            const today = new Date().toDateString();
            const todaysLoads = distributionHistory.filter(d => new Date(d.date || d.createdAt || Date.now()).toDateString() === today);
            if (!todaysLoads.length) {
                container.innerHTML = 'No dispatches scheduled for today.';
                return;
            }
            const grouped = todaysLoads.reduce((acc, load) => {
                acc[load.warehouse] = acc[load.warehouse] || { count: 0, qty: 0 };
                acc[load.warehouse].count += 1;
                acc[load.warehouse].qty += Number(load.quantity || 0);
                return acc;
            }, {});
            container.innerHTML = Object.entries(grouped).map(([warehouse, stats]) => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:6px 0;">
                    <span style="font-weight:600;">${warehouse.toUpperCase()}</span>
                    <span>${stats.count} drops â€¢ ${stats.qty} units</span>
                </div>
            `).join('');
        }

        function renderColdChainAlerts() {
            const container = document.getElementById('coldChainAlerts');
            if (!container) return;
            loadStockData();
            const coldLoads = distributionHistory.filter(d => (d.temperature || '').toLowerCase().includes('cold'));
            if (!coldLoads.length) {
                container.innerHTML = 'No temperature-controlled deliveries pending.';
                return;
            }
            container.innerHTML = coldLoads.slice(0, 5).map(load => `
                <div style="padding:8px 0; border-bottom:1px solid #eee;">
                    <div style="font-weight:600; color:#2c3e50;">${load.dispatchNumber || load.id}</div>
                    <div style="font-size:.8rem; color:#666;">${load.branch} â€¢ ${load.productName}</div>
                </div>
            `).join('');
        }

        function renderDeliveryTimeline() {
            const container = document.getElementById('deliveryTimeline');
            if (!container) return;
            loadStockData();
            if (!distributionHistory.length) {
                container.innerHTML = 'No deliveries recorded.';
                return;
            }
            container.innerHTML = distributionHistory.slice(0, 5).map(load => `
                <div style="padding:8px 0; border-bottom:1px solid #eee;">
                    <div style="font-weight:600; color:#2c3e50;">${load.branch}</div>
                    <div style="font-size:.8rem; color:#666;">${load.productName} â€¢ ${load.quantity} units</div>
                    <div style="font-size:.75rem; color:#999;">Dispatch ${load.dispatchNumber || load.id}</div>
                </div>
            `).join('');
        }

        function printDistributionManifest() {
            loadStockData();
            if (!distributionHistory.length) {
                alert('No distribution history available to print.');
                return;
            }
            const manifestRows = distributionHistory.slice(0, 20).map(load => [
                `Dispatch: ${load.dispatchNumber || load.id}`,
                `Warehouse: ${load.warehouse}`,
                `Branch: ${load.branch}`,
                `Product: ${load.productName}`,
                `Quantity: ${load.quantity}`,
                `Vehicle: ${load.vehicle || 'N/A'}`,
                `Driver: ${load.driver || 'N/A'}`,
                `ETA: ${load.eta || 'TBC'}`
            ].join('\n'));
            const manifest = manifestRows.join('\n----------------------------------------\n');
            const blob = new Blob([manifest], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'distribution_manifest.txt';
            link.click();
        }

        function optimizeRoutes() {
            loadStockData();
            if (!distributionHistory.length) {
                alert('No loads to optimize.');
                return;
            }
            alert('Route optimization complete â€” clustered by nearest branch geography. (Simulation)');
            renderRouteBoard();
        }

        function exportDistributionHistory() {
            loadStockData();
            if (!distributionHistory.length) {
                alert('No distribution history to export.');
                return;
            }
            const rows = ['Dispatch,Warehouse,Branch,Product,Quantity,Date,Vehicle,Driver,ETA'];
            distributionHistory.forEach(load => {
                rows.push([
                    load.dispatchNumber || load.id,
                    load.warehouse,
                    load.branch,
                    load.productName,
                    load.quantity,
                    load.date || load.createdAt,
                    load.vehicle || '',
                    load.driver || '',
                    load.eta || ''
                ].map(v => String(v).replace(/,/g, ' ')).join(','));
            });
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'distribution_history.csv';
            link.click();
        }

        function renderInventoryAlerts() {
            const container = document.getElementById('inventoryAlerts');
            if (!container) return;
            loadStockData();
            const alerts = [];

            const lowCountry = countryStock.filter(item => Number(item.quantity || 0) <= 10);
            if (lowCountry.length) alerts.push(`âš ï¸ ${lowCountry.length} country stock items below 10 units.`);

            const barcodeStock = safeParseFromStorage('dyna_barcode_stock', '[]');
            const nearExpiry = barcodeStock.filter(batch => {
                if (!batch.expiry && !batch.expiryDate) return false;
                return (new Date(batch.expiry || batch.expiryDate) - new Date()) / (1000 * 60 * 60 * 24) <= 30;
            });
            if (nearExpiry.length) alerts.push(`â³ ${nearExpiry.length} batches expiring within 30 days.`);

            if (distributionHistory.length > 20) alerts.push('ðŸšš High distribution volume today â€” review warehouse replenishment.');

            if (!alerts.length) alerts.push('âœ… Inventory health looks good.');
            container.innerHTML = alerts.map(alert => `<div style="background:#f8f9fa; border:1px solid #e1e5ec; border-radius:8px; padding:10px; color:#555;">${alert}</div>`).join('');
        }

        function handleReorderScenario(event) {
            event.preventDefault();
            const scenario = {
                id: 'SCN-' + Date.now(),
                name: document.getElementById('scenarioName')?.value || 'Scenario',
                uplift: Number(document.getElementById('scenarioUplift')?.value || 0),
                leadTime: Number(document.getElementById('scenarioLeadTime')?.value || 0),
                serviceLevel: Number(document.getElementById('scenarioServiceLevel')?.value || 0.95),
                notes: document.getElementById('scenarioNotes')?.value || '',
                createdAt: new Date().toISOString()
            };
            reorderScenarios.unshift(scenario);
            persistReorderScenarios();
            renderReorderScenarioResults();
        }

        function renderReorderScenarioResults() {
            const container = document.getElementById('reorderScenarioResults');
            if (!container) return;
            loadStockData();
            if (!reorderScenarios.length) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = reorderScenarios.slice(0, 3).map(s => {
                const projectedIncrease = (replenishmentSuggestionCache.length || 1) * (1 + s.uplift / 100);
                return `
                    <div style="background:#fff; border:1px solid #e1e5ec; border-radius:8px; padding:12px;">
                        <div style="font-weight:700; color:#2c3e50;">${s.name}</div>
                        <div style="font-size:.85rem; color:#666;">Uplift ${s.uplift}% â€¢ Lead time ${s.leadTime || 'default'} days â€¢ Service Level ${(s.serviceLevel * 100).toFixed(0)}%</div>
                        <div style="font-size:.85rem; color:#555; margin-top:6px;">Projected replenishment requirement: ${Math.round(projectedIncrease)} units</div>
                        ${s.notes ? `<p style="margin-top:6px; color:#777;">${s.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Receive stock to country inventory
        document.getElementById('receiveStockForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const stockItem = {
                id: 'STK-' + Date.now(),
                productName: document.getElementById('stockProductName').value,
                productCode: document.getElementById('stockProductCode').value,
                category: document.getElementById('stockCategory').value,
                quantity: parseInt(document.getElementById('stockQuantity').value),
                unit: document.getElementById('stockUnit').value,
                batchNumber: document.getElementById('stockBatchNumber').value,
                expiryDate: document.getElementById('stockExpiryDate').value,
                supplier: document.getElementById('stockSupplier').value,
                cost: parseFloat(document.getElementById('stockCost').value) || 0,
                notes: document.getElementById('stockNotes').value,
                receivedDate: new Date().toISOString(),
                location: 'country'
            };
            
            countryStock.push(stockItem);
            saveStockData();
            displayCountryStock();
            alert('Stock received successfully!');
            clearStockForm();
        });
        
        // Transfer to Windhoek Warehouse
        document.getElementById('transferToWindhoekForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const source = document.getElementById('windhoekSource').value;
            const productName = document.getElementById('windhoekProduct').value; // Changed from productId to productName
            const quantity = parseInt(document.getElementById('windhoekQuantity').value);
            
            if (source === 'country') {
                // Look in both countryStock and barcode stock
                let item = countryStock.find(s => s.productName === productName);
                let barcodeItem = null;
                
                // Check barcode stock if item not found in countryStock
                if (!item) {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    let matchingBatches = barcodeStock.filter(b => 
                        b.description === productName && 
                        b.location === 'country_stock' && 
                        b.status === 'available'
                    );
                    // FEFO: sort by soonest expiry and skip expired batches
                    const now = new Date();
                    matchingBatches = matchingBatches
                        .filter(b => { try { return new Date((b.expiryDate||'') + '-01') >= now; } catch(_) { return true; } })
                        .sort((a,b) => (a.expiryTimestamp||0) - (b.expiryTimestamp||0));
                    const totalBarcodeQty = matchingBatches.reduce((sum, b) => sum + (b.remainingQuantity || 0), 0);
                    
                    if (totalBarcodeQty >= quantity) {
                        barcodeItem = { description: productName, totalAvailable: totalBarcodeQty, batches: matchingBatches };
                    }
                }
                
                if ((!item && !barcodeItem) || (item && item.quantity < quantity) || (barcodeItem && barcodeItem.totalAvailable < quantity)) {
                    alert('Insufficient stock available!');
                    return;
                }
                
                // Deduct from source
                if (item) {
                    item.quantity -= quantity;
                } else if (barcodeItem) {
                    // Deduct from barcode stock batches
                    let remainingQty = quantity;
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    
                    barcodeItem.batches
                        .filter(b => { try { return new Date((b.expiryDate||'') + '-01') >= new Date(); } catch(_) { return true; } })
                        .sort((a,b) => (a.expiryTimestamp||0) - (b.expiryTimestamp||0))
                        .forEach(batch => {
                        if (remainingQty <= 0) return;
                        const deduct = Math.min(remainingQty, batch.remainingQuantity);
                        batch.remainingQuantity -= deduct;
                        remainingQty -= deduct;
                        if (batch.remainingQuantity === 0) {
                            batch.status = 'transferred';
                        }
                    });
                    
                    localStorage.setItem('dyna_barcode_stock', JSON.stringify(barcodeStock));
                }
            } else {
                // Source is ondangwa
                let item = ondangwaStock.find(s => s.productName === productName);
                if (!item || item.quantity < quantity) {
                    alert('Insufficient stock available!');
                    return;
                }
                item.quantity -= quantity;
            }
            
            // Add to Windhoek
            let windhoekItem = windhoekStock.find(s => s.productName === productName);
            if (windhoekItem) {
                windhoekItem.quantity += quantity;
            } else {
                let newItem = {
                    id: 'WIND-' + Date.now(),
                    productName: productName,
                    quantity: quantity,
                    unit: 'units',
                    location: 'windhoek'
                };
                windhoekStock.push(newItem);
            }
            
            saveStockData();
            
            // Broadcast stock update event for real-time sync
            try {
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: 'windhoek', products: [{ name: productName, quantity }], user: (currentUser?.fullName || 'system'), reference: 'TRANSFER-WINDHOEK-' + Date.now() } 
                }));
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: 'windhoek', products: [{ name: productName, quantity }], action: 'transferred', source, ts: Date.now() } })
                    }).catch(_ => {});
                }
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: 'windhoek', products: [{ name: productName, quantity }], action: 'transferred', source, ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}
            
            displayCountryStock();
            displayWindhoekStock();
            displayOndangwaStock();
            alert('Stock transferred to Windhoek Warehouse!');
            document.getElementById('transferToWindhoekForm').reset();
            const windhoekAvailableQty = document.getElementById('windhoekAvailableQty');
            if (windhoekAvailableQty) {
                windhoekAvailableQty.value = '';
                windhoekAvailableQty.placeholder = 'Select product to view available quantity';
            }
        });
        
        // Transfer to Ondangwa Warehouse
        document.getElementById('transferToOndangwaForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const source = document.getElementById('ondangwaSource').value;
            const productName = document.getElementById('ondangwaProduct').value; // Changed from productId to productName
            const quantity = parseInt(document.getElementById('ondangwaQuantity').value);
            
            if (source === 'country') {
                // Look in both countryStock and barcode stock
                let item = countryStock.find(s => s.productName === productName);
                let barcodeItem = null;
                
                // Check barcode stock if item not found in countryStock
                if (!item) {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    let matchingBatches = barcodeStock.filter(b => 
                        b.description === productName && 
                        b.location === 'country_stock' && 
                        b.status === 'available'
                    );
                    // FEFO: sort by soonest expiry and skip expired batches
                    const now2 = new Date();
                    matchingBatches = matchingBatches
                        .filter(b => { try { return new Date((b.expiryDate||'') + '-01') >= now2; } catch(_) { return true; } })
                        .sort((a,b) => (a.expiryTimestamp||0) - (b.expiryTimestamp||0));
                    const totalBarcodeQty = matchingBatches.reduce((sum, b) => sum + (b.remainingQuantity || 0), 0);
                    
                    if (totalBarcodeQty >= quantity) {
                        barcodeItem = { description: productName, totalAvailable: totalBarcodeQty, batches: matchingBatches };
                    }
                }
                
                if ((!item && !barcodeItem) || (item && item.quantity < quantity) || (barcodeItem && barcodeItem.totalAvailable < quantity)) {
                    alert('Insufficient stock available!');
                    return;
                }
                
                // Deduct from source
                if (item) {
                    item.quantity -= quantity;
                } else if (barcodeItem) {
                    // Deduct from barcode stock batches
                    let remainingQty = quantity;
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    
                    barcodeItem.batches
                        .filter(b => { try { return new Date((b.expiryDate||'') + '-01') >= new Date(); } catch(_) { return true; } })
                        .sort((a,b) => (a.expiryTimestamp||0) - (b.expiryTimestamp||0))
                        .forEach(batch => {
                        if (remainingQty <= 0) return;
                        const deduct = Math.min(remainingQty, batch.remainingQuantity);
                        batch.remainingQuantity -= deduct;
                        remainingQty -= deduct;
                        if (batch.remainingQuantity === 0) {
                            batch.status = 'transferred';
                        }
                    });
                    
                    localStorage.setItem('dyna_barcode_stock', JSON.stringify(barcodeStock));
                }
            } else {
                // Source is windhoek
                let item = windhoekStock.find(s => s.productName === productName);
                if (!item || item.quantity < quantity) {
                    alert('Insufficient stock available!');
                    return;
                }
                item.quantity -= quantity;
            }
            
            // Add to Ondangwa
            let ondangwaItem = ondangwaStock.find(s => s.productName === productName);
            if (ondangwaItem) {
                ondangwaItem.quantity += quantity;
            } else {
                let newItem = {
                    id: 'OND-' + Date.now(),
                    productName: productName,
                    quantity: quantity,
                    unit: 'units',
                    location: 'ondangwa'
                };
                ondangwaStock.push(newItem);
            }
            
            saveStockData();
            
            // Broadcast stock update event for real-time sync
            try {
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: 'ondangwa', products: [{ name: productName, quantity }], user: (currentUser?.fullName || 'system'), reference: 'TRANSFER-ONDANGWA-' + Date.now() } 
                }));
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: 'ondangwa', products: [{ name: productName, quantity }], action: 'transferred', source, ts: Date.now() } })
                    }).catch(_ => {});
                }
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: 'ondangwa', products: [{ name: productName, quantity }], action: 'transferred', source, ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}
            
            displayCountryStock();
            displayWindhoekStock();
            displayOndangwaStock();
            alert('Stock transferred to Ondangwa Warehouse!');
            document.getElementById('transferToOndangwaForm').reset();
            const ondangwaAvailableQty = document.getElementById('ondangwaAvailableQty');
            if (ondangwaAvailableQty) {
                ondangwaAvailableQty.value = '';
                ondangwaAvailableQty.placeholder = 'Select product to view available quantity';
            }
        });
        
        // Load products for Windhoek transfer based on source
        function loadWindhoekProducts() {
            const source = document.getElementById('windhoekSource')?.value;
            const productSelect = document.getElementById('windhoekProduct');
            const availableQtyField = document.getElementById('windhoekAvailableQty');
            
            if (!productSelect || !source) return;
            
            // Reset fields
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (availableQtyField) {
                availableQtyField.value = '';
                availableQtyField.placeholder = 'Select product to view available quantity';
            }
            document.getElementById('windhoekQuantity').value = '';
            
            loadStockData();
            let products = [];
            
            if (source === 'country') {
                // Get products from country stock and barcode stock
                const productMap = new Map();
                
                // Add from countryStock
                countryStock.forEach(item => {
                    if (!productMap.has(item.productName)) {
                        productMap.set(item.productName, item.quantity);
                    } else {
                        productMap.set(item.productName, productMap.get(item.productName) + item.quantity);
                    }
                });
                
                // Add from barcode stock
                try {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    barcodeStock.forEach(batch => {
                        if (batch.location === 'country_stock' && batch.status === 'available') {
                            const currentQty = productMap.get(batch.description) || 0;
                            productMap.set(batch.description, currentQty + (batch.remainingQuantity || 0));
                        }
                    });
                } catch (error) {
                    console.error('Error loading barcode stock:', error);
                }
                
                products = Array.from(productMap.entries()).map(([name, qty]) => ({ productName: name, quantity: qty }));
            } else if (source === 'ondangwa') {
                // Get products from Ondangwa warehouse
                products = ondangwaStock.map(item => ({
                    productName: item.productName,
                    quantity: item.quantity
                }));
            }
            
            // Populate dropdown
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.productName;
                option.textContent = `${product.productName} (Available: ${product.quantity} units)`;
                productSelect.appendChild(option);
            });
        }
        
        // Load products for Ondangwa transfer based on source
        function loadOndangwaProducts() {
            const source = document.getElementById('ondangwaSource')?.value;
            const productSelect = document.getElementById('ondangwaProduct');
            const availableQtyField = document.getElementById('ondangwaAvailableQty');
            
            if (!productSelect || !source) return;
            
            // Reset fields
            productSelect.innerHTML = '<option value="">Select Product</option>';
            if (availableQtyField) {
                availableQtyField.value = '';
                availableQtyField.placeholder = 'Select product to view available quantity';
            }
            document.getElementById('ondangwaQuantity').value = '';
            
            loadStockData();
            let products = [];
            
            if (source === 'country') {
                // Get products from country stock and barcode stock
                const productMap = new Map();
                
                // Add from countryStock
                countryStock.forEach(item => {
                    if (!productMap.has(item.productName)) {
                        productMap.set(item.productName, item.quantity);
                    } else {
                        productMap.set(item.productName, productMap.get(item.productName) + item.quantity);
                    }
                });
                
                // Add from barcode stock
                try {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    barcodeStock.forEach(batch => {
                        if (batch.location === 'country_stock' && batch.status === 'available') {
                            const currentQty = productMap.get(batch.description) || 0;
                            productMap.set(batch.description, currentQty + (batch.remainingQuantity || 0));
                        }
                    });
                } catch (error) {
                    console.error('Error loading barcode stock:', error);
                }
                
                products = Array.from(productMap.entries()).map(([name, qty]) => ({ productName: name, quantity: qty }));
            } else if (source === 'windhoek') {
                // Get products from Windhoek warehouse
                products = windhoekStock.map(item => ({
                    productName: item.productName,
                    quantity: item.quantity
                }));
            }
            
            // Populate dropdown
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.productName;
                option.textContent = `${product.productName} (Available: ${product.quantity} units)`;
                productSelect.appendChild(option);
            });
        }
        
        // Update available quantity for Windhoek transfer
        function updateWindhoekAvailableQuantity() {
            const source = document.getElementById('windhoekSource')?.value;
            const productName = document.getElementById('windhoekProduct')?.value;
            const availableQtyField = document.getElementById('windhoekAvailableQty');
            
            if (!productName || !availableQtyField) {
                if (availableQtyField) {
                    availableQtyField.value = '';
                    availableQtyField.placeholder = 'Select product to view available quantity';
                }
                return;
            }
            
            loadStockData();
            let availableQty = 0;
            
            if (source === 'country') {
                // Check both countryStock and barcode stock
                const item = countryStock.find(s => s.productName === productName);
                if (item) {
                    availableQty += item.quantity;
                }
                
                // Check barcode stock
                try {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    const matchingBatches = barcodeStock.filter(b => 
                        b.description === productName && 
                        b.location === 'country_stock' && 
                        b.status === 'available'
                    );
                    const totalBarcodeQty = matchingBatches.reduce((sum, b) => sum + (b.remainingQuantity || 0), 0);
                    availableQty += totalBarcodeQty;
                } catch (error) {
                    console.error('Error loading barcode stock:', error);
                }
            } else if (source === 'ondangwa') {
                const item = ondangwaStock.find(s => s.productName === productName);
                availableQty = item ? item.quantity : 0;
            }
            
            if (availableQty > 0) {
                availableQtyField.value = `${availableQty} units available`;
                availableQtyField.style.color = '#27ae60';
            } else {
                availableQtyField.value = '0 units available';
                availableQtyField.style.color = '#e74c3c';
            }
        }
        
        // Update available quantity for Ondangwa transfer
        function updateOndangwaAvailableQuantity() {
            const source = document.getElementById('ondangwaSource')?.value;
            const productName = document.getElementById('ondangwaProduct')?.value;
            const availableQtyField = document.getElementById('ondangwaAvailableQty');
            
            if (!productName || !availableQtyField) {
                if (availableQtyField) {
                    availableQtyField.value = '';
                    availableQtyField.placeholder = 'Select product to view available quantity';
                }
                return;
            }
            
            loadStockData();
            let availableQty = 0;
            
            if (source === 'country') {
                // Check both countryStock and barcode stock
                const item = countryStock.find(s => s.productName === productName);
                if (item) {
                    availableQty += item.quantity;
                }
                
                // Check barcode stock
                try {
                    const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                    const matchingBatches = barcodeStock.filter(b => 
                        b.description === productName && 
                        b.location === 'country_stock' && 
                        b.status === 'available'
                    );
                    const totalBarcodeQty = matchingBatches.reduce((sum, b) => sum + (b.remainingQuantity || 0), 0);
                    availableQty += totalBarcodeQty;
                } catch (error) {
                    console.error('Error loading barcode stock:', error);
                }
            } else if (source === 'windhoek') {
                const item = windhoekStock.find(s => s.productName === productName);
                availableQty = item ? item.quantity : 0;
            }
            
            if (availableQty > 0) {
                availableQtyField.value = `${availableQty} units available`;
                availableQtyField.style.color = '#27ae60';
            } else {
                availableQtyField.value = '0 units available';
                availableQtyField.style.color = '#e74c3c';
            }
        }
        
        // Distribute to branches
        document.getElementById('distributeStockForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const warehouse = document.getElementById('distributionWarehouse').value;
            const branch = document.getElementById('distributionBranch').value;
            const productName = document.getElementById('distributionProduct').value; // Changed from productId to productName
            const quantity = parseInt(document.getElementById('distributionQuantity').value);
            const date = document.getElementById('distributionDate').value || new Date().toISOString().split('T')[0];
            const expiryDate = document.getElementById('distributionExpiryDate').value;
            const dispatchNumber = document.getElementById('distributionDispatchNumber').value.trim();
            const notes = document.getElementById('distributionNotes').value;
            const vehicle = document.getElementById('distributionVehicle')?.value || '';
            const driver = document.getElementById('distributionDriver')?.value || '';
            const eta = document.getElementById('distributionEta')?.value || '';
            
            // Validate required fields
            if (!expiryDate) {
                alert('âŒ Expiry Date is required!');
                return;
            }
            
            if (!dispatchNumber) {
                alert('âŒ Dispatch Number is required!');
                return;
            }
            
            // Validate dispatch number is not empty after trim
            if (dispatchNumber.length === 0) {
                alert('âŒ Dispatch Number cannot be empty!');
                return;
            }
            
            // Check if dispatch number already exists
            const existingDispatch = distributionHistory.find(d => d.dispatchNumber && d.dispatchNumber.toLowerCase() === dispatchNumber.toLowerCase());
            if (existingDispatch) {
                alert(`âŒ Dispatch Number "${dispatchNumber}" already exists! Please use a unique dispatch number.`);
                return;
            }
            
            let warehouseStock = warehouse === 'windhoek' ? windhoekStock : ondangwaStock;
            let item = warehouseStock.find(s => s.productName === productName); // Changed from s.id to s.productName
            
            if (!item || item.quantity < quantity) {
                alert(`Insufficient stock available in warehouse! Available: ${item ? item.quantity : 0}, Requested: ${quantity}`);
                return;
            }
            
            // Deduct from warehouse stock (FEFO enforcement via barcode batches)
            let remainingQty = quantity;
            
            // Try to deduct from barcode stock first (FEFO enforced)
            try {
                const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                const warehouseLocation = warehouse === 'windhoek' ? 'windhoek_warehouse' : 'ondangwa_warehouse';
                
                // Find matching batches in warehouse, sorted by FEFO (expiry date ascending)
                let matchingBatches = barcodeStock.filter(b => 
                    b.description === productName && 
                    b.location === warehouseLocation && 
                    b.status === 'available' &&
                    (b.remainingQuantity || 0) > 0
                );
                
                // FEFO: Sort by expiry date (earliest first), filter out expired
                const now = Date.now();
                matchingBatches = matchingBatches
                    .filter(b => {
                        const exp = b.expiryTimestamp || (b.expiryDate ? new Date(b.expiryDate + '-01').getTime() : 0);
                        return exp >= now; // Only non-expired batches
                    })
                    .sort((a, b) => {
                        const aExp = a.expiryTimestamp || (a.expiryDate ? new Date(a.expiryDate + '-01').getTime() : 0);
                        const bExp = b.expiryTimestamp || (b.expiryDate ? new Date(b.expiryDate + '-01').getTime() : 0);
                        return aExp - bExp; // Ascending (earliest expiry first)
                    });
                
                // Deduct from batches using FEFO
                for (const batch of matchingBatches) {
                    if (remainingQty <= 0) break;
                    const take = Math.min(remainingQty, batch.remainingQuantity || 0);
                    batch.remainingQuantity -= take;
                    remainingQty -= take;
                    
                    // If batch is fully dispatched, update location to branch
                    if (batch.remainingQuantity === 0) {
                        batch.status = 'dispatched';
                    } else {
                        // Create a new batch record for the branch with the transferred quantity
                        const branchBatch = {
                            ...batch,
                            id: `BATCH-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            barcode: `BC${Date.now()}${Math.random().toString(36).substr(2, 9)}`,
                            location: branch.toLowerCase().replace(/\s+/g, '_'),
                            quantity: take,
                            remainingQuantity: take,
                            dispatchedQuantity: 0,
                            status: 'available',
                            distributionDate: date,
                            dispatchNumber: dispatchNumber
                        };
                        barcodeStock.push(branchBatch);
                    }
                    
                    // Record stock movement for FEFO tracking
                    try {
                        await recordStockMovement({
                            type: 'distribution',
                            product: productName,
                            quantity: take,
                            batchNo: batch.batchNo,
                            barcode: batch.barcode,
                            fromWarehouse: warehouse,
                            toBranch: branch,
                            expiryDate: batch.expiryDate,
                            reference: dispatchNumber,
                            createdBy: window.currentUser?.fullName || 'system'
                        });
                    } catch (movementError) {
                        console.warn('Failed to record distribution movement:', movementError);
                    }
                }
                
                // Save updated barcode stock
                localStorage.setItem('dyna_barcode_stock', JSON.stringify(barcodeStock));
                
                // If still remaining quantity, deduct from regular warehouse stock
                if (remainingQty > 0) {
                    item.quantity -= remainingQty;
                } else {
                    // All deducted from barcode stock, but we still need to update warehouse item quantity
                    // Recalculate from barcode stock
                    const warehouseBatches = barcodeStock.filter(b => 
                        b.description === productName && 
                        b.location === warehouseLocation && 
                        b.status === 'available'
                    );
                    const totalWarehouseQty = warehouseBatches.reduce((sum, b) => sum + (b.remainingQuantity || 0), 0);
                    item.quantity = totalWarehouseQty;
                }
            } catch (barcodeError) {
                console.warn('Barcode stock deduction failed, using regular stock:', barcodeError);
                // Fallback to regular stock deduction
            item.quantity -= quantity;
            }
            
            // Record distribution
            const distribution = {
                id: 'DIST-' + Date.now(),
                warehouse: warehouse,
                branch: branch,
                productName: productName,
                quantity: quantity,
                date: date,
                expiryDate: expiryDate,
                dispatchNumber: dispatchNumber,
                notes: notes,
                vehicle: vehicle,
                driver: driver,
                eta: eta,
                createdBy: currentUser?.username || 'system',
                createdAt: new Date().toISOString()
            };
            
            distributionHistory.unshift(distribution);
            saveStockData();
            
            // Broadcast stock update event for real-time sync
            try {
                window.dispatchEvent(new CustomEvent('stock:updated', { 
                    detail: { branch: branch, products: [{ name: productName, quantity }], user: (currentUser?.fullName || 'system'), reference: dispatchNumber } 
                }));
                const m = document.querySelector('meta[name="rt-base"]');
                const rtBase = m && m.content && m.content.trim();
                if (rtBase) {
                    fetch(rtBase.replace(/\/$/, '') + '/publish', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: { type: 'stock:updated', branch: branch, products: [{ name: productName, quantity }], action: 'distributed', warehouse, dispatchNumber, ts: Date.now() } })
                    }).catch(_ => {});
                }
                fetch('/api/realtime_publish', { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ channel: 'stock', event: { branch: branch, products: [{ name: productName, quantity }], action: 'distributed', warehouse, dispatchNumber, ts: Date.now() } }) 
                }).catch(_ => {});
            } catch (_) {}
            
            // Rebuild branch stock from all movements
            try {
                await rebuildBranchStockFromMovements();
            } catch (rebuildError) {
                console.warn('Failed to rebuild branch stock:', rebuildError);
            }
            
            displayWindhoekStock();
            displayOndangwaStock();
            displayDistributionHistory();
            alert('âœ… Stock distributed to branch successfully!');
            document.getElementById('distributeStockForm').reset();
        });
        
        // Display functions
        function displayCountryStock() {
            const container = document.getElementById('countryStockList');
            if (!container) return;
            
            // Show loading indicator
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">â³ Loading stock data...</p>';
            
            try {
                loadStockData();
                
                // Load barcode stock from storage
                let barcodeStock = [];
                try {
                    const stored = localStorage.getItem('dyna_barcode_stock');
                    if (stored) {
                        const batches = JSON.parse(stored);
                        // Convert barcode stock to displayable format
                        barcodeStock = batches
                            .filter(b => b.location === 'country_stock' && b.status === 'available')
                            .map(batch => ({
                                productName: batch.description,
                                productCode: batch.barcode,
                                category: 'Imported Stock',
                                quantity: batch.remainingQuantity,
                                unit: 'units',
                                batchNumber: batch.batchNo,
                                expiryDate: batch.expiryDate,
                                supplier: batch.cartonNo || 'N/A',
                                cost: 0,
                                receivedDate: batch.importDate,
                                barcode: batch.barcode,
                                id: batch.id,
                                isBarcodeStock: true
                            }));
                    }
                } catch (error) {
                    console.error('Error loading barcode stock:', error);
                }
                
                // Combine both sources
                const allStock = [...countryStock, ...barcodeStock];
                
                if (allStock.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No stock received yet.</p>';
                    return;
                }
                
                container.innerHTML = allStock.map(item => `
                    <div class="client-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${item.productName}</h4>
                                <p><strong>Code:</strong> ${item.productCode} | <strong>Category:</strong> ${item.category}</p>
                                <p><strong>Quantity:</strong> ${item.quantity} ${item.unit} | <strong>Batch:</strong> ${item.batchNumber}</p>
                                <p><strong>Expiry:</strong> ${item.expiryDate} | <strong>Supplier:</strong> ${item.supplier}</p>
                                <p><strong>Cost:</strong> N$ ${item.cost.toFixed(2)} per unit</p>
                                <p><strong>Received:</strong> ${new Date(item.receivedDate).toLocaleString()}</p>
                                ${item.barcode ? `<p><strong>Barcode:</strong> ${item.barcode}</p>` : ''}
                                ${item.notes ? `<p><em>${item.notes}</em></p>` : ''}
                            </div>
                            <button class="btn btn-success" onclick="transferToWarehouse('${item.id}', 'country')">Transfer</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error displaying country stock:', error);
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #d32f2f;">âŒ Error loading stock data. Please refresh the page.</p>';
            }
        }
        
        function displayWindhoekStock() {
            const container = document.getElementById('windhoekStockList');
            if (!container) return;
            
            // Show loading indicator
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">â³ Loading stock data...</p>';
            
            try {
                loadStockData();
                
                if (windhoekStock.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No stock in Windhoek Warehouse.</p>';
                    return;
                }
                
                container.innerHTML = windhoekStock.map(item => `
                <div class="client-card ${item.quantity < 10 ? 'low-stock' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${item.productName}</h4>
                            <p><strong>Code:</strong> ${item.productCode} | <strong>Category:</strong> ${item.category}</p>
                            <p><strong>Quantity:</strong> ${item.quantity} ${item.unit} ${item.quantity < 10 ? 'âš ï¸ LOW STOCK' : ''}</p>
                            <p><strong>Batch:</strong> ${item.batchNumber} | <strong>Expiry:</strong> ${item.expiryDate}</p>
                            ${item.notes ? `<p><em>${item.notes}</em></p>` : ''}
                        </div>
                        <button class="btn btn-primary" onclick="distributeToBranch('windhoek', '${item.productName}')">Distribute</button>
                    </div>
                </div>
            `).join('');
            } catch (error) {
                console.error('Error displaying Windhoek stock:', error);
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #d32f2f;">âŒ Error loading stock data. Please refresh the page.</p>';
            }
        }
        
        function displayOndangwaStock() {
            const container = document.getElementById('ondangwaStockList');
            if (!container) return;
            
            // Show loading indicator
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">â³ Loading stock data...</p>';
            
            try {
                loadStockData();
                
                if (ondangwaStock.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No stock in Ondangwa Warehouse.</p>';
                    return;
                }
                
                container.innerHTML = ondangwaStock.map(item => `
                <div class="client-card ${item.quantity < 10 ? 'low-stock' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${item.productName}</h4>
                            <p><strong>Code:</strong> ${item.productCode} | <strong>Category:</strong> ${item.category}</p>
                            <p><strong>Quantity:</strong> ${item.quantity} ${item.unit} ${item.quantity < 10 ? 'âš ï¸ LOW STOCK' : ''}</p>
                            <p><strong>Batch:</strong> ${item.batchNumber} | <strong>Expiry:</strong> ${item.expiryDate}</p>
                            ${item.notes ? `<p><em>${item.notes}</em></p>` : ''}
                        </div>
                        <button class="btn btn-primary" onclick="distributeToBranch('ondangwa', '${item.productName}')">Distribute</button>
                    </div>
                </div>
            `).join('');
            } catch (error) {
                console.error('Error displaying Ondangwa stock:', error);
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #d32f2f;">âŒ Error loading stock data. Please refresh the page.</p>';
            }
        }
        
        function displayDistributionHistory() {
            const container = document.getElementById('distributionHistoryList');
            if (!container) return;
            
            // Show loading indicator
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">â³ Loading distribution history...</p>';
            
            try {
                loadStockData();
                
                if (distributionHistory.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No distribution history.</p>';
                    return;
                }
                
                container.innerHTML = distributionHistory.map(dist => {
                const branchName = branches.find(b => b.id === dist.branch)?.name || dist.branch;
                return `
                <div class="client-card">
                    <h4>${dist.productName}</h4>
                    <p><strong>Dispatch Number:</strong> ${dist.dispatchNumber || 'N/A'}</p>
                    <p><strong>From:</strong> ${dist.warehouse === 'windhoek' ? 'Windhoek Warehouse' : 'Ondangwa Warehouse'} | <strong>To:</strong> ${branchName}</p>
                    <p><strong>Quantity:</strong> ${dist.quantity} units</p>
                    <p><strong>Distribution Date:</strong> ${dist.date} | <strong>Expiry Date:</strong> ${dist.expiryDate || 'N/A'}</p>
                    <p><strong>Vehicle:</strong> ${dist.vehicle || 'N/A'} | <strong>Driver:</strong> ${dist.driver || 'N/A'} | <strong>ETA:</strong> ${dist.eta || 'TBC'}</p>
                    <p><strong>Distributed by:</strong> ${dist.createdBy}</p>
                    ${dist.notes ? `<p><em>${dist.notes}</em></p>` : ''}
                </div>
            `;
            }).join('');
            } catch (error) {
                console.error('Error displaying distribution history:', error);
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #d32f2f;">âŒ Error loading distribution history. Please refresh the page.</p>';
            }
        }
        
        // Show stock tab - Updated for modern comprehensive structure
        function showStockTab(tabName) {
            document.querySelectorAll('.stock-tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('#stock .tabs button').forEach(b => b.classList.remove('active'));
            
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // Update active button
            const button = document.getElementById('stockTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (button) button.classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            
            // Load data when switching tabs
            if (tabName === 'overview') {
                refreshStockOverview();
            }
            else if (tabName === 'countryImport') {
                renderASNList();
                renderQualityList();
                displayCountryStock();
            }
            else if (tabName === 'warehouseDistribution') {
                // Combine windhoek and ondangwa functionality
                renderPutawayQueue();
                renderWarehouseCapacity();
                displayWindhoekStock();
                displayOndangwaStock();
                loadWindhoekProducts();
                loadOndangwaProducts();
            }
            else if (tabName === 'branchDistribution') {
                // Use distribution tab functionality
                renderReplenishmentSuggestions();
                renderBranchRequestList();
                renderRouteBoard();
                displayDistributionHistory();
            }
            else if (tabName === 'transfers') {
                loadStockTransfers();
            }
            else if (tabName === 'sharing') {
                loadShopWarehouseSharing();
            }
            else if (tabName === 'orders') {
                loadStockOrders();
            }
            else if (tabName === 'countryInventory') {
                displayCountryStockInventory();
            }
            else if (tabName === 'realtime') {
                loadRealtimeSyncStatus();
            }
            // Legacy tab support
            else if (tabName === 'dashboard') {
                renderForecastList();
                renderPurchaseOrders();
                renderSupplierScorecard();
                renderPlanInsights();
            }
            else if (tabName === 'countryStock') {
                renderASNList();
                renderQualityList();
                displayCountryStock();
            }
            else if (tabName === 'windhoek') {
                renderPutawayQueue();
                renderWarehouseCapacity();
                displayWindhoekStock();
                loadWindhoekProducts();
            }
            else if (tabName === 'ondangwa') {
                renderReplenishmentSuggestions();
                renderBranchRequestList();
                updateBranchMetrics();
                loadOndangwaProducts();
            }
            else if (tabName === 'distribution') {
                renderRouteBoard();
                displayDistributionHistory();
            }
            else if (tabName === 'inventory') {
                renderInventoryAlerts();
                displayInventoryMovements();
            }
            else if (tabName === 'barcode') {
                updateBranchMetrics();
                renderBranchOpsInsights();
                renderDefaultBarcodePreview();
            }
            else if (tabName === 'reorder') {
                displayReorderPoints();
                renderReorderScenarioResults();
            }
            else if (tabName === 'batch') {
                renderReturnsList();
                displayBatchTracking();
            }
            else if (tabName === 'valuation') displayStockValuation();
        }

        // New Stock Management Functions for Modern Tabs
        
        // Overview Tab Functions
        function refreshStockOverview() {
            try {
                // Calculate KPIs - Aggregate from all stock sources
            const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const countryStock = JSON.parse(localStorage.getItem('dyna_country_stock') || '[]');
            const warehouseStock = JSON.parse(localStorage.getItem('dyna_warehouse_stock') || '[]');
                const branchStockData = JSON.parse(localStorage.getItem('branch_stock') || '[]');
                
                // Get all branches to aggregate branch stock
                const allBranches = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
                let allBranchStock = [];
                allBranches.forEach(branch => {
                    const branchId = branch.id || branch.name;
                    const branchStock = JSON.parse(localStorage.getItem(`branch_stock_${branchId}`) || '[]');
                    allBranchStock = allBranchStock.concat(branchStock);
                });
                // Also include general branch_stock
                allBranchStock = allBranchStock.concat(branchStockData);
                
                // Calculate total stock value - Include ALL sources
            let totalValue = 0;
                
                // From barcode stock (primary source)
            barcodeStock.forEach(item => {
                    if (item.status !== 'exhausted' && item.status !== 'sold') {
                        const price = (typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === item.description))?.cp || 
                                     (typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === item.description))?.dp || 0;
                        totalValue += (item.remainingQuantity || item.quantity || 0) * price;
                    }
                });
                
                // From branch stock
                allBranchStock.forEach(item => {
                    const price = item.unitPrice || 
                                ((typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === item.product))?.cp || 0);
                    totalValue += (item.quantity || 0) * price;
                });
                
                // From warehouse stock (if separate)
                if (Array.isArray(warehouseStock)) {
                    warehouseStock.forEach(item => {
                        const price = item.unitPrice || 
                                    ((typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === item.product || p.description === item.description))?.cp || 0);
                        totalValue += (item.quantity || 0) * price;
                    });
                }
                
                // Update UI safely
                const overviewTotalValue = document.getElementById('overviewTotalValue');
                if (overviewTotalValue) {
                    overviewTotalValue.textContent = `N$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
            
            // Count pending orders
            const orders = JSON.parse(localStorage.getItem('dyna_stock_requests') || '[]');
            const pendingOrders = orders.filter(o => o.status === 'pending' || o.status === 'approved').length;
                const overviewPendingOrders = document.getElementById('overviewPendingOrders');
                if (overviewPendingOrders) {
                    overviewPendingOrders.textContent = pendingOrders;
                }
            
                // Count low stock items - Check all sources
            let lowStockCount = 0;
            barcodeStock.forEach(item => {
                    if (item.status !== 'exhausted' && item.status !== 'sold' && (item.remainingQuantity || item.quantity || 0) < 10) {
                        lowStockCount++;
                    }
                });
                allBranchStock.forEach(item => {
                    if ((item.quantity || 0) < 10) lowStockCount++;
                });
                
                const overviewLowStock = document.getElementById('overviewLowStock');
                if (overviewLowStock) {
                    overviewLowStock.textContent = lowStockCount;
                }
            
            // Count active transfers
            const transfers = JSON.parse(localStorage.getItem('dyna_stock_transfers') || '[]');
            const activeTransfers = transfers.filter(t => t.status === 'pending' || t.status === 'in_transit').length;
                const overviewActiveTransfers = document.getElementById('overviewActiveTransfers');
                if (overviewActiveTransfers) {
                    overviewActiveTransfers.textContent = activeTransfers;
                }
                
                // Stock flow visualization - Accurate counts
                const countryQty = barcodeStock
                    .filter(b => (b.location === 'country_stock' || b.location === 'country') && b.status !== 'exhausted' && b.status !== 'sold')
                    .reduce((sum, b) => sum + (b.remainingQuantity || b.quantity || 0), 0);
                
                const warehouseQty = barcodeStock
                    .filter(b => b.location && (b.location.includes('windhoek') || b.location.includes('ondangwa')) && b.status !== 'exhausted' && b.status !== 'sold')
                    .reduce((sum, b) => sum + (b.remainingQuantity || b.quantity || 0), 0);
                
                const branchQty = allBranchStock.reduce((sum, b) => sum + (b.quantity || 0), 0);
                
                const overviewCountryStock = document.getElementById('overviewCountryStock');
                const overviewWarehouseStock = document.getElementById('overviewWarehouseStock');
                const overviewBranchStock = document.getElementById('overviewBranchStock');
                const overviewShopStock = document.getElementById('overviewShopStock');
                
                if (overviewCountryStock) overviewCountryStock.textContent = countryQty.toLocaleString();
                if (overviewWarehouseStock) overviewWarehouseStock.textContent = warehouseQty.toLocaleString();
                if (overviewBranchStock) overviewBranchStock.textContent = branchQty.toLocaleString();
                if (overviewShopStock) overviewShopStock.textContent = '0'; // Can be calculated from sales later
            
            // Recent movements
            loadRecentMovements();
            } catch (error) {
                console.error('Error refreshing stock overview:', error);
            }
        }
        
        function loadRecentMovements() {
            const container = document.getElementById('overviewRecentMovements');
            if (!container) return;
            
            const movements = [];
            // Aggregate from various sources
            const transfers = JSON.parse(localStorage.getItem('dyna_stock_transfers') || '[]');
            const distributions = JSON.parse(localStorage.getItem('dyna_distributions') || '[]');
            const imports = JSON.parse(localStorage.getItem('dyna_country_imports') || '[]');
            
            movements.push(...transfers.slice(0, 10).map(t => ({...t, type: 'transfer', date: t.createdAt || t.date})));
            movements.push(...distributions.slice(0, 10).map(d => ({...d, type: 'distribution', date: d.date || d.createdAt})));
            movements.push(...imports.slice(0, 10).map(i => ({...i, type: 'import', date: i.createdAt || i.date})));
            
            movements.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            
            if (movements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No recent movements</p>';
                return;
            }
            
            container.innerHTML = movements.slice(0, 20).map(m => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${m.product || m.description || 'Unknown'}</strong>
                        <div style="font-size: 0.85rem; color: #666;">${m.type} â€¢ ${m.quantity || 0} units</div>
                    </div>
                    <div style="font-size: 0.85rem; color: #999;">${new Date(m.date || Date.now()).toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        // Transfers Tab Functions
        function loadStockTransfers() {
            const container = document.getElementById('activeTransfersList');
            if (!container) return;
            
            const statusFilter = document.getElementById('transferStatusFilter')?.value || 'all';
            const transfers = JSON.parse(localStorage.getItem('dyna_stock_transfers') || '[]');
            let filtered = transfers;
            
            if (statusFilter !== 'all') {
                filtered = transfers.filter(t => t.status === statusFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No transfers found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(t => `
                <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${t.product || 'Unknown'}</strong>
                            <div style="font-size: 0.85rem; color: #666;">From: ${t.from || 'N/A'} â†’ To: ${t.to || 'N/A'}</div>
                            <div style="font-size: 0.85rem; color: #666;">Quantity: ${t.quantity || 0}</div>
                        </div>
                        <span class="pill ${t.status === 'completed' ? 'good' : t.status === 'pending' ? 'warn' : 'bad'}">${(t.status || 'pending').toUpperCase()}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Sharing Tab Functions
        function loadShopWarehouseSharing() {
            const shopList = document.getElementById('shopVisibilityList');
            const warehouseList = document.getElementById('warehouseSharingList');
            
            if (shopList) {
                const sharing = JSON.parse(localStorage.getItem('dyna_stock_sharing') || '[]');
                const shopSharing = sharing.filter(s => s.type === 'shop_visibility');
                
                if (shopSharing.length === 0) {
                    shopList.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No shop visibility rules configured</p>';
                } else {
                    shopList.innerHTML = shopSharing.map(s => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between;">
                            <span>${s.from} â†’ ${s.to}</span>
                            <span class="pill ${s.status === 'active' ? 'good' : 'bad'}">${s.status}</span>
                        </div>
                    `).join('');
                }
            }
            
            if (warehouseList) {
                const sharing = JSON.parse(localStorage.getItem('dyna_stock_sharing') || '[]');
                const warehouseSharing = sharing.filter(s => s.type === 'warehouse_sharing');
                
                if (warehouseSharing.length === 0) {
                    warehouseList.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No warehouse sharing rules configured</p>';
                } else {
                    warehouseList.innerHTML = warehouseSharing.map(s => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between;">
                            <span>${s.from} â†’ ${s.to}</span>
                            <span class="pill ${s.status === 'active' ? 'good' : 'bad'}">${s.status}</span>
                        </div>
                    `).join('');
                }
            }
        }
        
        // Orders Tab Functions
        function loadStockOrders() {
            const autoContainer = document.getElementById('automaticOrdersList');
            const manualContainer = document.getElementById('manualOrdersList');
            
            const orders = JSON.parse(localStorage.getItem('dyna_stock_orders') || '[]');
            const automatic = orders.filter(o => o.type === 'automatic');
            const manual = orders.filter(o => o.type === 'manual');
            
            if (autoContainer) {
                if (automatic.length === 0) {
                    autoContainer.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No automatic orders</p>';
                } else {
                    autoContainer.innerHTML = automatic.map(o => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                            <strong>${o.product || 'Unknown'}</strong>
                            <div style="font-size: 0.85rem; color: #666;">Qty: ${o.quantity || 0} â€¢ ${new Date(o.createdAt || Date.now()).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }
            }
            
            if (manualContainer) {
                if (manual.length === 0) {
                    manualContainer.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No manual orders</p>';
                } else {
                    manualContainer.innerHTML = manual.map(o => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                            <strong>${o.product || 'Unknown'}</strong>
                            <div style="font-size: 0.85rem; color: #666;">Qty: ${o.quantity || 0} â€¢ ${new Date(o.createdAt || Date.now()).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }
            }
        }
        
        // Country Inventory Functions
        function displayCountryStockInventory() {
            const container = document.getElementById('countryInventoryTable');
            if (!container) return;
            
            // Aggregate inventory from all locations
            const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const locationFilter = document.getElementById('countryInvLocationFilter')?.value || 'all';
            
            let filtered = barcodeStock;
            if (locationFilter !== 'all') {
                if (locationFilter === 'branches') {
                    filtered = JSON.parse(localStorage.getItem('branch_stock') || '[]');
                } else {
                    filtered = barcodeStock.filter(b => b.location && b.location.includes(locationFilter));
                }
            }
            
            // Calculate totals
            const countryTotal = barcodeStock.filter(b => b.location === 'country_stock').reduce((sum, b) => sum + ((b.remainingQuantity || 0) * ((typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === b.description))?.cp || 0)), 0);
            const warehouseTotal = barcodeStock.filter(b => b.location && (b.location.includes('windhoek') || b.location.includes('ondangwa'))).reduce((sum, b) => sum + ((b.remainingQuantity || 0) * ((typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === b.description))?.cp || 0)), 0);
            const branchStock = JSON.parse(localStorage.getItem('branch_stock') || '[]');
            const branchTotal = branchStock.reduce((sum, b) => sum + ((b.quantity || 0) * (b.unitPrice || 0)), 0);
            
            document.getElementById('countryTotalValue').textContent = `N$${countryTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('warehouseTotalValue').textContent = `N$${warehouseTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('branchTotalValue').textContent = `N$${branchTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('countryTotalProducts').textContent = filtered.length;
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No inventory found</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #c41e3a;">
                            <th style="padding: 12px; text-align: left;">Location</th>
                            <th style="padding: 12px; text-align: left;">Product</th>
                            <th style="padding: 12px; text-align: right;">Quantity</th>
                            <th style="padding: 12px; text-align: right;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.slice(0, 100).map(item => {
                            const location = item.location || item.branch || 'N/A';
                            const product = item.description || item.product || 'Unknown';
                            const qty = item.remainingQuantity || item.quantity || 0;
                            const price = (typeof PRICE_LIST !== 'undefined' && PRICE_LIST.find(p => p.description === product))?.cp || item.unitPrice || 0;
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${location}</td>
                                    <td style="padding: 10px;">${product}</td>
                                    <td style="padding: 10px; text-align: right;">${qty}</td>
                                    <td style="padding: 10px; text-align: right;">N$${(qty * price).toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Real-time Sync Functions
        function loadRealtimeSyncStatus() {
            // Update sync status indicators
            const stockPortal = document.getElementById('syncStockPortal');
            const branchPortal = document.getElementById('syncBranchPortal');
            const gmPortal = document.getElementById('syncGMPortal');
            
            if (stockPortal) {
                stockPortal.className = 'pill good';
                stockPortal.textContent = 'ðŸŸ¢ Connected';
            }
            if (branchPortal) {
                branchPortal.className = 'pill good';
                branchPortal.textContent = 'ðŸŸ¢ Connected';
            }
            if (gmPortal) {
                gmPortal.className = 'pill good';
                gmPortal.textContent = 'ðŸŸ¢ Connected';
            }
            
            // Load recent sync events
            const eventsContainer = document.getElementById('realtimeSyncEvents');
            if (eventsContainer) {
                const events = JSON.parse(localStorage.getItem('dyna_sync_events') || '[]');
                if (events.length === 0) {
                    eventsContainer.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No recent sync events</p>';
                } else {
                    eventsContainer.innerHTML = events.slice(0, 20).map(e => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                            <div style="font-size: 0.85rem;"><strong>${e.type || 'Sync'}</strong></div>
                            <div style="font-size: 0.75rem; color: #666;">${e.message || ''} â€¢ ${new Date(e.timestamp || Date.now()).toLocaleString()}</div>
                        </div>
                    `).join('');
                }
            }
        }
        
        // Placeholder functions for form handlers
        function handleTransferToWindhoek(event) { event.preventDefault(); alert('Transfer functionality - integrate with existing transfer functions'); }
        function handleTransferToOndangwa(event) { event.preventDefault(); alert('Transfer functionality - integrate with existing transfer functions'); }
        function handleBranchDistribution(event) { event.preventDefault(); alert('Distribution functionality - integrate with existing distribution functions'); }
        function handleStockTransfer(event) { event.preventDefault(); alert('Transfer functionality - integrate with existing transfer functions'); }
        function handleSharingRule(event) { event.preventDefault(); alert('Sharing rule functionality - to be implemented'); }
        function refreshAutomaticOrders() { loadStockOrders(); }
        function showCreateManualOrder() { alert('Manual order creation - to be implemented'); }
        function saveAutoOrderSettings() { alert('Auto order settings saved'); }
        function saveSyncSettings() { alert('Sync settings saved'); }
        function testSyncConnection() { alert('Sync connection test - to be implemented'); }
        function exportCountryInventory() { alert('Export functionality - to be implemented'); }
        function updateWindhoekAvailableQuantity() { /* Integrate with existing */ }
        function updateOndangwaAvailableQuantity() { /* Integrate with existing */ }
        function updateBranchDistAvailableQty() { /* Integrate with existing */ }
        function loadTransferFromProducts() { /* Integrate with existing */ }
        function updateTransferAvailableQty() { /* Integrate with existing */ }

        // Inventory movements (aggregate view across sources)
        function filterInventoryMovements() {
            displayInventoryMovements();
        }

        function displayInventoryMovements() {
            const container = document.getElementById('inventoryMovementsList');
            if (!container) return;

            const loc = document.getElementById('inventoryLocationFilter')?.value || 'all';
            const type = document.getElementById('inventoryMovementFilter')?.value || 'all';
            const term = (document.getElementById('inventoryProductSearch')?.value || '').toLowerCase();
            const from = document.getElementById('inventoryDateFrom')?.value || '';
            const to = document.getElementById('inventoryDateTo')?.value || '';

            const inRange = (dateStr) => {
                if (!from && !to) return true;
                const d = new Date(dateStr || Date.now());
                if (from && d < new Date(from)) return false;
                if (to) {
                    const end = new Date(to);
                    end.setHours(23,59,59,999);
                    if (d > end) return false;
                }
                return true;
            };

            // Gather movements from various sources
            const imports = JSON.parse(localStorage.getItem('dyna_country_imports') || '[]').map(r => ({
                movementType: 'import',
                location: 'country',
                product: r.description || r.product || 'Unknown',
                quantity: Number(r.quantity || r.ctns || 0),
                reference: r.batchNumber || r.batch || r.reference || '',
                date: r.createdAt || r.date || new Date().toISOString(),
                user: r.createdBy || (currentUser?.fullName || 'system')
            }));

            const transfers = JSON.parse(localStorage.getItem('dyna_transfers') || '[]').map(t => ({
                movementType: 'transfer',
                location: (t.to || '').toLowerCase(),
                product: t.product || 'Unknown',
                quantity: Number(t.quantity || 0),
                reference: t.id || '',
                date: t.createdAt || t.date || new Date().toISOString(),
                user: t.createdBy || (currentUser?.fullName || 'system')
            }));

            const distributions = JSON.parse(localStorage.getItem('dyna_distributions') || '[]').map(d => ({
                movementType: 'distribution',
                location: (d.branch || '').toLowerCase(),
                product: d.product || 'Unknown',
                quantity: Number(d.quantity || 0),
                reference: d.dispatchNumber || d.id || '',
                date: d.date || d.createdAt || new Date().toISOString(),
                user: d.createdBy || (currentUser?.fullName || 'system')
            }));

            const adjustments = JSON.parse(localStorage.getItem('dyna_scan_adjustments') || '[]').map(a => ({
                movementType: 'adjustment',
                location: 'barcode',
                product: a.code || 'Unknown',
                quantity: a.action === 'remove' ? -Math.abs(Number(a.quantity||0)) : Math.abs(Number(a.quantity||0)),
                reference: a.id || '',
                date: a.timestamp || new Date().toISOString(),
                user: a.user || (currentUser?.fullName || 'system')
            }));

            let rows = [...imports, ...transfers, ...distributions, ...adjustments];

            // Apply filters
            rows = rows.filter(r => (type === 'all' || r.movementType === type));
            rows = rows.filter(r => (loc === 'all' || r.location === loc));
            rows = rows.filter(r => (term === '' || (r.product || '').toLowerCase().includes(term)));
            rows = rows.filter(r => inRange(r.date));

            if (rows.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px; color:#666;">No inventory movements match your filters.</p>';
                return;
            }

            // Sort by date desc
            rows.sort((a,b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = rows.map(r => `
                <div class="client-card" style="border-left:4px solid ${r.movementType==='import'?'#27ae60':(r.movementType==='transfer'?'#2980b9':(r.movementType==='distribution'?'#8e44ad':'#f39c12'))};">
                    <div style="display:flex; justify-content:space-between; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${r.product}</div>
                            <div style="font-size:.9rem; color:#666;">${r.movementType.toUpperCase()} â€¢ ${r.location || 'N/A'}</div>
                            <div style="font-size:.85rem; color:#777;">Ref: ${r.reference || '-'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:${r.quantity<0?'#e74c3c':'#27ae60'};">${r.quantity<0?'-':''}${Math.abs(r.quantity)}</div>
                            <div style="font-size:.85rem; color:#666;">${new Date(r.date).toLocaleString()}</div>
                            <div style="font-size:.8rem; color:#999;">${r.user || ''}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function exportInventoryMovements() {
            const loc = document.getElementById('inventoryLocationFilter')?.value || 'all';
            const type = document.getElementById('inventoryMovementFilter')?.value || 'all';
            const term = (document.getElementById('inventoryProductSearch')?.value || '').toLowerCase();
            const from = document.getElementById('inventoryDateFrom')?.value || '';
            const to = document.getElementById('inventoryDateTo')?.value || '';

            const inRange = (dateStr) => {
                if (!from && !to) return true;
                const d = new Date(dateStr || Date.now());
                if (from && d < new Date(from)) return false;
                if (to) {
                    const end = new Date(to); end.setHours(23,59,59,999);
                    if (d > end) return false;
                }
                return true;
            };

            const sources = [];
            sources.push(...JSON.parse(localStorage.getItem('dyna_country_imports') || '[]').map(r => ({ movementType:'import', location:'country', product:r.description||r.product||'Unknown', quantity:Number(r.quantity||r.ctns||0), reference:r.batchNumber||r.batch||r.reference||'', date:r.createdAt||r.date||new Date().toISOString(), user:r.createdBy||(currentUser?.fullName||'system') })));
            sources.push(...JSON.parse(localStorage.getItem('dyna_transfers') || '[]').map(t => ({ movementType:'transfer', location:(t.to||'').toLowerCase(), product:t.product||'Unknown', quantity:Number(t.quantity||0), reference:t.id||'', date:t.createdAt||t.date||new Date().toISOString(), user:t.createdBy||(currentUser?.fullName||'system') })));
            sources.push(...JSON.parse(localStorage.getItem('dyna_distributions') || '[]').map(d => ({ movementType:'distribution', location:(d.branch||'').toLowerCase(), product:d.product||'Unknown', quantity:Number(d.quantity||0), reference:d.dispatchNumber||d.id||'', date:d.date||d.createdAt||new Date().toISOString(), user:d.createdBy||(currentUser?.fullName||'system') })));
            sources.push(...JSON.parse(localStorage.getItem('dyna_scan_adjustments') || '[]').map(a => ({ movementType:'adjustment', location:'barcode', product:a.code||'Unknown', quantity:a.action==='remove' ? -Math.abs(Number(a.quantity||0)) : Math.abs(Number(a.quantity||0)), reference:a.id||'', date:a.timestamp||new Date().toISOString(), user:a.user||(currentUser?.fullName||'system') })));

            let rows = sources.filter(r => (type==='all' || r.movementType===type));
            rows = rows.filter(r => (loc==='all' || r.location===loc));
            rows = rows.filter(r => (term==='' || (r.product||'').toLowerCase().includes(term)));
            rows = rows.filter(r => inRange(r.date));

            const csv = ['Type,Location,Product,Quantity,Reference,Date,User'];
            rows.forEach(r => csv.push([r.movementType, r.location, r.product.replace(/,/g,' '), r.quantity, r.reference, r.date, (r.user||'').replace(/,/g,' ')].join(',')));
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'inventory_movements.csv'; a.click();
        }

        // Barcode generation
        function renderDefaultBarcodePreview() {
            const container = document.getElementById('barcodePreview');
            if (!container) return;
            container.innerHTML = '<p style="color:#666;">Enter a SKU/Code and click Generate to preview barcode.</p>';
        }
        // Simple toast system for inline feedback with optional action
        function showToast(message, options = {}) {
            let root = document.getElementById('toastContainer');
            if (!root) {
                root = document.createElement('div');
                root.id = 'toastContainer';
                root.style.position = 'fixed';
                root.style.bottom = '20px';
                root.style.right = '20px';
                root.style.display = 'flex';
                root.style.flexDirection = 'column';
                root.style.gap = '8px';
                root.style.zIndex = '9999';
                document.body.appendChild(root);
            }
            const toast = document.createElement('div');
            toast.style.background = '#2c3e50';
            toast.style.color = '#ecf0f1';
            toast.style.padding = '10px 12px';
            toast.style.borderRadius = '6px';
            toast.style.boxShadow = '0 4px 14px rgba(0,0,0,0.2)';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '10px';
            const span = document.createElement('span');
            span.textContent = message;
            toast.appendChild(span);
            if (options && options.actionLabel && typeof options.onAction === 'function') {
                const btn = document.createElement('button');
                btn.className = 'btn btn-warning';
                btn.textContent = options.actionLabel;
                btn.onclick = () => { try { options.onAction(); } finally { root.removeChild(toast); } };
                toast.appendChild(btn);
            }
            root.appendChild(toast);
            if (!options || !options.actionLabel) {
                setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 5000);
            }
        }
        function generateProductBarcode() {
            const name = document.getElementById('barcodeProductName')?.value || '';
            const sku = (document.getElementById('barcodeSku')?.value || '').trim();
            const formatSelect = document.getElementById('barcodeFormat')?.value || 'code128';
            const container = document.getElementById('barcodePreview');
            if (!container) return;
            if (!sku) { container.innerHTML = '<p style="color:#e74c3c;">Please enter a SKU/Code.</p>'; return; }
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = 'generatedBarcode';
            try {
                const formatMap = { code128: 'CODE128', ean13: 'EAN13', qr: 'pharmacode' };
                const jsFormat = formatMap[formatSelect] || 'CODE128';
                JsBarcode(svg, sku, { format: jsFormat, displayValue: true, width: 2, height: 60, margin: 10 });
                container.innerHTML = '';
                container.appendChild(svg);
                const meta = document.createElement('div');
                meta.innerHTML = `<div style="color:#2c3e50; font-weight:600;">${name ? name + ' â€¢ ' : ''}${sku}</div>`;
                container.appendChild(meta);
            } catch (e) {
                container.innerHTML = '<p style="color:#e74c3c;">Failed to generate barcode.</p>';
            }
        }
        function applyScannedUpdate() {
            const code = (document.getElementById('scannedCode')?.value || '').trim();
            const qty = parseInt(document.getElementById('scannedQuantity')?.value || '0', 10);
            const action = document.getElementById('scanAction')?.value || 'add';
            const location = document.getElementById('scanLocation')?.value || 'branch';
            const status = document.getElementById('scanUpdateStatus');
            if (!code || !qty || qty <= 0) { if (status) status.textContent = 'Enter code and valid quantity.'; return; }
            // If barcode API is available and action removes stock, enforce FEFO and assist user
            try {
                if (window.barcodeStockAPI && action === 'remove') {
                    const found = window.barcodeStockAPI.getStockByBarcode(code);
                    if (found && found.success && found.data) {
                        const productName = found.data.description;
                        const fefo = window.barcodeStockAPI.getFEFOStock(productName, qty);
                        if (fefo && fefo.success && Array.isArray(fefo.data) && fefo.data.length > 0) {
                            const earliest = fefo.data[0];
                            if (typeof found.data.expiryTimestamp === 'number' && typeof earliest.expiryTimestamp === 'number') {
                                if (found.data.expiryTimestamp > earliest.expiryTimestamp) {
                                    // FEFO violation: show toast with quick action to select earliest batch
                                    showToast(`FEFO required: use earliest batch ${earliest.batchNo} expiring first.`, {
                                        actionLabel: 'Use earliest batch',
                                        onAction: () => {
                                            const input = document.getElementById('scannedCode');
                                            if (input) {
                                                input.value = earliest.barcode;
                                                if (status) status.textContent = `Selected earliest batch ${earliest.batchNo} (${earliest.barcode}). Click Apply again.`;
                                            }
                                        }
                                    });
                                    return; // block apply until user confirms using earliest
                                }
                            }
                        }
                    }
                }
            } catch (_) {}
            // Minimal implementation: record an adjustment event
            const adjustments = JSON.parse(localStorage.getItem('dyna_scan_adjustments') || '[]');
            adjustments.push({ id: 'ADJ-' + Date.now(), code, quantity: qty, action, location, timestamp: new Date().toISOString(), user: currentUser?.fullName || 'system' });
            localStorage.setItem('dyna_scan_adjustments', JSON.stringify(adjustments));
            if (status) status.textContent = `Recorded ${action} of ${qty} for ${code} (${location}).`;
            // Record movement (adjust) for branch
            try {
                let productName = code;
                if (window.barcodeStockAPI) {
                    const found = window.barcodeStockAPI.getStockByBarcode(code);
                    if (found && found.success && found.data && found.data.description) productName = found.data.description;
                }
                const delta = action === 'remove' ? -Math.abs(qty) : Math.abs(qty);
                recordStockMovement({
                    type: 'adjust',
                    product: productName,
                    quantity: delta,
                    batchNo: null,
                    branchId: (currentUser && currentUser.branch) || 'unknown_branch',
                    reference: adjustments[adjustments.length-1]?.id,
                    createdBy: (currentUser && currentUser.fullName) || 'system'
                });
            } catch(_){}
            // Optionally refresh inventory movements
            if (typeof displayInventoryMovements === 'function') displayInventoryMovements();
        }

        // Reorder points
        function displayReorderPoints() {
            const container = document.getElementById('reorderList');
            if (!container) return;
            initializeInventory();
            const entries = Object.entries(inventory).map(([name, data]) => ({ name, current: data.currentStock || 0, reorder: data.reorderLevel || 0 }));
            const low = entries.filter(e => e.current <= e.reorder).sort((a,b) => (a.current - a.reorder) - (b.current - b.reorder));
            if (low.length === 0) { container.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">No items at or below reorder level.</p>'; return; }
            container.innerHTML = low.map(e => `
                <div class="client-card" style="border-left:4px solid #e74c3c;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700; color:#2c3e50;">${e.name}</div>
                            <div style="font-size:.9rem; color:#666;">Current: <strong style="color:${e.current<=e.reorder?'#e74c3c':'#27ae60'};">${e.current}</strong> â€¢ Reorder at: <strong>${e.reorder}</strong></div>
                        </div>
                        <button class="btn btn-primary" onclick="createPOForItem('${e.name.replace(/'/g, "\\'")}')">ðŸ§¾ Create PO</button>
                    </div>
                </div>
            `).join('');
        }
        function createPOForItem(productName) {
            const defaultQty = 50;
            const po = {
                id: 'PO-' + Date.now(),
                product: productName,
                quantity: defaultQty,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.fullName || 'system',
                status: 'draft'
            };
            const pos = JSON.parse(localStorage.getItem('dyna_purchase_orders') || '[]');
            pos.push(po);
            localStorage.setItem('dyna_purchase_orders', JSON.stringify(pos));
            alert(`PO created for ${productName} (Qty ${defaultQty}).`);
        }
        function generatePurchaseOrders() {
            displayReorderPoints();
            const list = document.getElementById('reorderList');
            if (!list) return;
            // Create POs for all visible items
            const names = Array.from(list.querySelectorAll('.client-card div div[style*="font-weight:700"]')).map(el => el.textContent.trim());
            names.forEach(n => createPOForItem(n));
        }
        function exportReorderList() {
            const data = JSON.parse(localStorage.getItem('dyna_purchase_orders') || '[]');
            const csv = ['PO ID,Product,Quantity,Status,Created At'];
            data.forEach(d => csv.push([d.id, d.product, d.quantity, d.status, d.createdAt].join(',')));
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'reorder_list.csv'; a.click();
        }

        // Batch tracking
        function displayBatchTracking() {
            const container = document.getElementById('batchTrackingList');
            if (!container) return;
            const term = (document.getElementById('batchSearch')?.value || '').toLowerCase();
            const filter = document.getElementById('batchExpiryFilter')?.value || 'all';
            const batches = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const now = new Date();
            const items = batches.map(b => {
                const exp = b.expiryDate ? new Date(b.expiryDate + '-01') : null;
                const daysLeft = exp ? Math.ceil((exp - now) / (1000*60*60*24)) : null;
                return { ...b, daysLeft };
            }).filter(b => {
                const match = (b.description||'').toLowerCase().includes(term) || (b.batchNumber||'').toLowerCase().includes(term);
                if (!match) return false;
                if (filter === 'expiring60') return b.daysLeft !== null && b.daysLeft <= 60 && b.daysLeft >= 0;
                if (filter === 'expired') return b.daysLeft !== null && b.daysLeft < 0;
                if (filter === 'recalled') return b.recalled === true;
                return true;
            });
            if (items.length === 0) { container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No matching batches.</p>'; return; }
            container.innerHTML = items.map(b => `
                <div class="client-card" style="border-left:4px solid ${b.recalled ? '#e74c3c' : (b.daysLeft!==null && b.daysLeft<=60 ? '#f39c12' : '#27ae60')};">
                    <h4>${b.description || 'Unknown Product'}</h4>
                    <p><strong>Batch:</strong> ${b.batchNumber || 'N/A'} â€¢ <strong>Expiry:</strong> ${b.expiryDate || 'N/A'} ${b.daysLeft!==null ? `(in ${b.daysLeft} days)` : ''}</p>
                    <p><strong>Remaining:</strong> ${b.remainingQuantity || 0} â€¢ <strong>Location:</strong> ${b.location || 'N/A'}</p>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn btn-warning recall-btn" data-batch-id="${encodeURIComponent((b.id||b.batchNumber||'').toString())}" data-recalled="${b.recalled===true?'true':'false'}">${b.recalled===true?'Undo Recall':'Recall Batch'}</button>
                    </div>
                </div>
            `).join('');
            // Attach click handlers for recall buttons (delegated per render)
            container.querySelectorAll('.recall-btn').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    const target = ev.currentTarget;
                    const batchId = decodeURIComponent(target.getAttribute('data-batch-id') || '');
                    const isRecalled = (target.getAttribute('data-recalled') || 'false') === 'true';
                    toggleRecall(batchId, isRecalled);
                });
            });
        }
        function toggleRecall(batchId, currentlyRecalled) {
            const batches = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
            const idx = batches.findIndex(b => (b.id||b.batchNumber||'') === batchId);
            if (idx >= 0) {
                batches[idx].recalled = !currentlyRecalled;
                localStorage.setItem('dyna_barcode_stock', JSON.stringify(batches));
                displayBatchTracking();
            }
        }

        // Stock valuation (basic using CP from PRICE_LIST and batches quantities)
        function displayStockValuation() {
            const summary = document.getElementById('stockValuationSummary');
            const details = document.getElementById('stockValuationDetails');
            if (!summary || !details) return;
            const method = document.getElementById('valuationMethod')?.value || 'fifo';
            initializeInventory();
            const priceMap = new Map();
            if (Array.isArray(window.PRICE_LIST)) {
                window.PRICE_LIST.forEach(p => priceMap.set(p.description, parseFloat(p.cp||0)));
            }
            const rows = Object.entries(inventory).map(([name, data]) => {
                const qty = data.currentStock || 0;
                const cp = priceMap.get(name) || 0;
                return { name, qty, cp, value: qty*cp };
            }).filter(r => r.qty > 0);
            const totalQty = rows.reduce((s,r)=>s+r.qty,0);
            const totalVal = rows.reduce((s,r)=>s+r.value,0);
            summary.innerHTML = `
                <div class="analytics-card"><h4>Total Quantity</h4><div class="value">${totalQty}</div></div>
                <div class="analytics-card"><h4>Total Value (${method.toUpperCase()})</h4><div class="value">N$ ${totalVal.toFixed(2)}</div></div>
            `;
            details.innerHTML = rows.sort((a,b)=>b.value-a.value).map(r => `
                <div class="client-card">
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>${r.name}</strong><div style="color:#666; font-size:.85rem;">CP: N$ ${r.cp.toFixed(2)}</div></div>
                        <div style="text-align:right;">
                            <div>Qty: <strong>${r.qty}</strong></div>
                            <div>Value: <strong>N$ ${r.value.toFixed(2)}</strong></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function exportStockValuation() {
            const method = document.getElementById('valuationMethod')?.value || 'fifo';
            initializeInventory();
            const priceMap = new Map();
            if (Array.isArray(window.PRICE_LIST)) window.PRICE_LIST.forEach(p => priceMap.set(p.description, parseFloat(p.cp||0)));
            const rows = Object.entries(inventory).map(([name, data]) => ({ name, qty: data.currentStock||0, cp: priceMap.get(name)||0 }));
            const csv = ['Product,Quantity,CP,Value'];
            rows.forEach(r => csv.push([r.name, r.qty, r.cp.toFixed(2), (r.qty*r.cp).toFixed(2)].join(',')));
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `stock_valuation_${method}.csv`; a.click();
        }
        
        // Stock Import Functions with Barcode and FEFO
        function addStockImportRow() {
            const tbody = document.getElementById('stockImportTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="text" class="stock-description" style="width: 100%; padding: 8px;" placeholder="Product description" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1" required>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                </td>
            `;
            tbody.appendChild(newRow);
        }
        
        function removeStockImportRow(btn) {
            const row = btn.closest('tr');
            const tbody = document.getElementById('stockImportTableBody');
            if (tbody.children.length > 1) {
                row.remove();
            } else {
                alert('At least one row must remain');
            }
        }
        
        // CSV Import Function
        function importFromCSV() {
            try {
                // Create file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                fileInput.style.display = 'none';
                
                fileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const text = await file.text();
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            alert('CSV file must have at least a header row and one data row');
                            return;
                        }
                        
                        // Detect delimiter
                        const firstLine = lines[0];
                        let delimiter = ',';
                        if (firstLine.includes('\t')) delimiter = '\t';
                        else if (firstLine.includes(';')) delimiter = ';';
                        
                        // Parse headers (case-insensitive)
                        const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, '').toLowerCase());
                        
                        // Find column indices
                        const cartonIdx = headers.findIndex(h => h.includes('carton') || h.includes('ctn'));
                        const descIdx = headers.findIndex(h => h.includes('description') || h.includes('product') || h.includes('name'));
                        const batchIdx = headers.findIndex(h => h.includes('batch'));
                        const expiryIdx = headers.findIndex(h => h.includes('expiry') || h.includes('exp'));
                        const qtyIdx = headers.findIndex(h => h.includes('quantity') || h.includes('qty') || h.includes('qnt'));
                        const totalCtnsIdx = headers.findIndex(h => h.includes('total') && (h.includes('carton') || h.includes('ctn'))) || 
                                           headers.findIndex(h => h.includes('total') && !h.includes('value') && !h.includes('amount'));
                        
                        if (descIdx === -1 || qtyIdx === -1) {
                            alert('CSV must contain at least Description and Quantity columns');
                            return;
                        }
                        
                        // Clear existing rows (keep first empty row)
                        const tbody = document.getElementById('stockImportTableBody');
                        const firstRow = tbody.querySelector('tr');
                        tbody.innerHTML = '';
                        if (firstRow) tbody.appendChild(firstRow);
                        
                        // Parse and add rows
                        let successCount = 0;
                        let errorCount = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                            if (values.length < Math.max(descIdx, qtyIdx) + 1) continue;
                            
                            const description = values[descIdx] || '';
                            const quantity = values[qtyIdx] || '';
                            
                            if (!description || !quantity) {
                                errorCount++;
                                continue;
                            }
                            
                            // Add row to table
                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" value="${cartonIdx >= 0 ? (values[cartonIdx] || '') : ''}" placeholder="A1-98">
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="text" class="stock-description" style="width: 100%; padding: 8px;" value="${description}" required>
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" value="${batchIdx >= 0 ? (values[batchIdx] || '') : ''}" placeholder="DP24265">
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" value="${expiryIdx >= 0 ? (values[expiryIdx] || '').substring(0, 7) : ''}" placeholder="YYYY-MM">
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" value="${quantity}" min="1" required>
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" value="${totalCtnsIdx >= 0 ? (values[totalCtnsIdx] || quantity) : quantity}" min="1" required>
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                                </td>
                            `;
                            tbody.appendChild(newRow);
                            successCount++;
                        }
                        
                        // Clean up
                        document.body.removeChild(fileInput);
                        
                        // Show result
                        if (successCount > 0) {
                            alert(`âœ… CSV imported successfully!\n${successCount} row(s) added${errorCount > 0 ? `\n${errorCount} row(s) skipped (missing data)` : ''}`);
                        } else {
                            alert('âŒ No valid rows found in CSV file');
                        }
                        
                    } catch (error) {
                        console.error('CSV import error:', error);
                        alert('âŒ Error importing CSV: ' + error.message);
                        document.body.removeChild(fileInput);
                    }
                });
                
                // Trigger file picker
                document.body.appendChild(fileInput);
                fileInput.click();
                
            } catch (error) {
                console.error('Error setting up CSV import:', error);
                alert('âŒ Error: ' + error.message);
            }
        }
        
        function clearStockImportForm() {
            const tbody = document.getElementById('stockImportTableBody');
            tbody.innerHTML = `
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="text" class="stock-carton-no" style="width: 100%; padding: 8px;" placeholder="A1-98">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="text" class="stock-description" style="width: 100%; padding: 8px;" placeholder="Product description">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="text" class="stock-batch-no" style="width: 100%; padding: 8px;" placeholder="DP24265">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="month" class="stock-expiry-date" style="width: 100%; padding: 8px;" placeholder="YYYY-MM">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="number" class="stock-quantity" style="width: 100%; padding: 8px;" placeholder="Qty" min="1">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="number" class="stock-total-ctns" style="width: 100%; padding: 8px;" placeholder="CTNS" min="1">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <button type="button" class="btn btn-danger" onclick="removeStockImportRow(this)" style="padding: 5px 10px;">Remove</button>
                    </td>
                </tr>
            `;
        }
        
        // Import barcode stock API (moved out of /api to avoid Vercel serverless routing)
        import('./web-modules/barcode-stock.js').then(module => {
            window.barcodeStockAPI = module;
            console.log('âœ… Barcode Stock API loaded successfully');
        }).catch(err => {
            console.error('âŒ Barcode Stock API not loaded:', err);
            console.log('Using fallback localStorage method');
        });
        
        // Handle bulk stock import submission
        document.getElementById('bulkStockImportForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rows = document.querySelectorAll('#stockImportTableBody tr');
            const items = [];
            
            // Validate and collect data
            for (let row of rows) {
                const cartonNo = row.querySelector('.stock-carton-no')?.value;
                const description = row.querySelector('.stock-description')?.value;
                const batchNo = row.querySelector('.stock-batch-no')?.value;
                const expiryDate = row.querySelector('.stock-expiry-date')?.value;
                const quantity = row.querySelector('.stock-quantity')?.value;
                const totalCtns = row.querySelector('.stock-total-ctns')?.value;
                
                if (!cartonNo || !description || !batchNo || !expiryDate || !quantity || !totalCtns) {
                    alert('Please fill all fields in every row');
                    return;
                }
                
                items.push({ cartonNo, description, batchNo, expiryDate, quantity, totalCtns });
            }
            
            // Import each item with barcode generation
            let successCount = 0;
            let failCount = 0;
            
            for (let item of items) {
                try {
                    if (window.barcodeStockAPI) {
                        const result = await window.barcodeStockAPI.importStockWithBarcode(item);
                        if (result.success) {
                            successCount++;
                            console.log(`Imported: ${item.description} - Barcode: ${result.data.barcode}`);
                        } else {
                            failCount++;
                            console.error(`Failed to import: ${item.description}`, result.error);
                        }
                    } else {
                        // Fallback: save to localStorage with barcode and FEFO enforcement
                        const stockBatches = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                        
                        // Generate unique barcode for each batch
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 9);
                        const barcode = `BC${timestamp}${random}`;
                        
                        // Calculate expiry timestamp for FEFO sorting (First Expired First Out)
                        const expiryDateObj = new Date(item.expiryDate + '-01');
                        const expiryTimestamp = expiryDateObj.getTime();
                        
                        // Validate expiry date is not in the past
                        if (expiryTimestamp < Date.now()) {
                            alert(`âš ï¸ Warning: ${item.description} has an expired date (${item.expiryDate}). Please verify.`);
                            if (!confirm('Continue importing this expired batch?')) {
                                failCount++;
                                continue;
                            }
                        }
                        
                        const batch = {
                            id: `BATCH-${timestamp}-${random}`,
                            barcode: barcode,
                            cartonNo: item.cartonNo,
                            description: item.description,
                            batchNo: item.batchNo,
                            expiryDate: item.expiryDate,
                            expiryTimestamp: expiryTimestamp, // Critical for FEFO sorting
                            quantity: parseInt(item.quantity),
                            totalCtns: parseInt(item.totalCtns),
                            importDate: new Date().toISOString(),
                            location: 'country_stock', // Always start in country stock
                            status: 'available',
                            dispatchedQuantity: 0,
                            remainingQuantity: parseInt(item.quantity),
                            // FEFO metadata
                            fefoPriority: expiryTimestamp, // Lower = expires sooner = higher priority for dispensing
                            isExpired: expiryTimestamp < Date.now(),
                            daysUntilExpiry: Math.ceil((expiryTimestamp - Date.now()) / (1000 * 60 * 60 * 24))
                        };
                        
                        stockBatches.push(batch);
                        
                        // Sort by FEFO (expiry date ascending) to ensure first expired batches are first
                        stockBatches.sort((a, b) => {
                            const aExp = a.expiryTimestamp || 0;
                            const bExp = b.expiryTimestamp || 0;
                            return aExp - bExp; // Ascending order (earliest expiry first)
                        });
                        
                        localStorage.setItem('dyna_barcode_stock', JSON.stringify(stockBatches));
                        
                        // Record stock movement for import
                        try {
                            await recordStockMovement({
                                type: 'import',
                                product: item.description,
                                quantity: parseInt(item.quantity),
                                batchNo: item.batchNo,
                                barcode: barcode,
                                location: 'country_stock',
                                expiryDate: item.expiryDate,
                                reference: 'IMPORT-' + timestamp,
                                createdBy: window.currentUser?.fullName || 'system'
                            });
                        } catch (movementError) {
                            console.warn('Failed to record stock movement:', movementError);
                        }
                        
                        successCount++;
                    }
                } catch (error) {
                    failCount++;
                    console.error('Import error:', error);
                }
            }
            
            alert(`âœ… Imported ${successCount} items successfully${failCount > 0 ? ' (Failed: ' + failCount + ')' : ''}`);
            
            // Broadcast stock update event for real-time sync
            if (successCount > 0) {
                try {
                    const products = items.filter((_, idx) => idx < successCount).map(item => ({ 
                        name: item.description || item.productName || 'Unknown', 
                        quantity: parseInt(item.quantity || 0) 
                    }));
                    window.dispatchEvent(new CustomEvent('stock:updated', { 
                        detail: { branch: 'country_stock', products, user: (currentUser?.fullName || 'system'), reference: 'IMPORT-' + Date.now() } 
                    }));
                    const m = document.querySelector('meta[name="rt-base"]');
                    const rtBase = m && m.content && m.content.trim();
                    if (rtBase) {
                        fetch(rtBase.replace(/\/$/, '') + '/publish', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event: { type: 'stock:updated', branch: 'country_stock', products, action: 'imported', ts: Date.now() } })
                        }).catch(_ => {});
                    }
                    fetch('/api/realtime_publish', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ channel: 'stock', event: { branch: 'country_stock', products, action: 'imported', ts: Date.now() } }) 
                    }).catch(_ => {});
                } catch (_) {}
            }
            
            // Clear form and refresh display
            clearStockImportForm();
            displayCountryStock();
        });
        
        // Helper functions
        function clearStockForm() {
            document.getElementById('receiveStockForm').reset();
        }
        
        function transferToWarehouse(productId, source) {
            const item = countryStock.find(s => s.id === productId);
            if (!item) return;
            
            const warehouse = prompt(`Transfer ${item.productName} to which warehouse?\n1. Windhoek\n2. Ondangwa`, '1');
            if (!warehouse) return;
            
            const quantity = prompt(`Enter quantity to transfer (Available: ${item.quantity}):`, '');
            if (!quantity || parseInt(quantity) > item.quantity) {
                alert('Invalid quantity!');
                return;
            }
            
            if (warehouse === '1') {
                document.getElementById('windhoekSource').value = 'country';
                document.getElementById('windhoekProduct').value = productId;
                document.getElementById('windhoekQuantity').value = quantity;
                showStockTab('windhoek');
            } else {
                document.getElementById('ondangwaSource').value = 'country';
                document.getElementById('ondangwaProduct').value = productId;
                document.getElementById('ondangwaQuantity').value = quantity;
                showStockTab('ondangwa');
            }
        }
        
        function distributeToBranch(warehouse, productName) {
            document.getElementById('distributionWarehouse').value = warehouse;
            document.getElementById('distributionProduct').value = productName; // Now using productName instead of productId
            document.getElementById('distributionDate').value = new Date().toISOString().split('T')[0];
            showStockTab('distribution');
        }
        
        function loadBranchesForDistribution() {
            const branchSelect = document.getElementById('distributionBranch');
            if (!branchSelect) return;
            
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            branches.forEach(branch => {
                branchSelect.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }
        
        function searchCountryStock() {
            const search = document.getElementById('countryStockSearch')?.value.toLowerCase() || '';
            loadStockData();
            
            // Load barcode stock from storage
            let barcodeStock = [];
            try {
                const stored = localStorage.getItem('dyna_barcode_stock');
                if (stored) {
                    const batches = JSON.parse(stored);
                    barcodeStock = batches
                        .filter(b => b.location === 'country_stock' && b.status === 'available')
                        .map(batch => ({
                            productName: batch.description,
                            productCode: batch.barcode,
                            category: 'Imported Stock',
                            quantity: batch.remainingQuantity,
                            unit: 'units',
                            batchNumber: batch.batchNo,
                            expiryDate: batch.expiryDate,
                            supplier: batch.cartonNo || 'N/A',
                            cost: 0,
                            receivedDate: batch.importDate,
                            barcode: batch.barcode,
                            id: batch.id,
                            isBarcodeStock: true
                        }));
                }
            } catch (error) {
                console.error('Error loading barcode stock:', error);
            }
            
            // Combine both sources and filter
            const allStock = [...countryStock, ...barcodeStock];
            const filtered = allStock.filter(item => 
                item.productName.toLowerCase().includes(search) ||
                item.productCode.toLowerCase().includes(search) ||
                item.category.toLowerCase().includes(search) ||
                item.batchNumber.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('countryStockList');
            if (!container) return;
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No matching stock found.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(item => `
                <div class="client-card">
                    <h4>${item.productName}</h4>
                    <p><strong>Code:</strong> ${item.productCode} | <strong>Category:</strong> ${item.category}</p>
                    <p><strong>Quantity:</strong> ${item.quantity} ${item.unit}</p>
                    <p><strong>Batch:</strong> ${item.batchNumber} | <strong>Expiry:</strong> ${item.expiryDate}</p>
                    ${item.barcode ? `<p><strong>Barcode:</strong> ${item.barcode}</p>` : ''}
                </div>
            `).join('');
        }
        
        function searchWindhoekStock() {
            const search = document.getElementById('windhoekSearch')?.value.toLowerCase() || '';
            loadStockData();
            const filtered = windhoekStock.filter(item => 
                item.productName.toLowerCase().includes(search) ||
                item.productCode.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('windhoekStockList');
            if (!container) return;
            
            container.innerHTML = filtered.map(item => `
                <div class="client-card">
                    <h4>${item.productName}</h4>
                    <p><strong>Quantity:</strong> ${item.quantity} ${item.unit}</p>
                </div>
            `).join('');
        }
        
        function searchOndangwaStock() {
            const search = document.getElementById('ondangwaSearch')?.value.toLowerCase() || '';
            loadStockData();
            const filtered = ondangwaStock.filter(item => 
                item.productName.toLowerCase().includes(search) ||
                item.productCode.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('ondangwaStockList');
            if (!container) return;
            
            container.innerHTML = filtered.map(item => `
                <div class="client-card">
                    <h4>${item.productName}</h4>
                    <p><strong>Quantity:</strong> ${item.quantity} ${item.unit}</p>
                </div>
            `).join('');
        }
        
        function searchDistribution() {
            const search = document.getElementById('distributionSearch')?.value.toLowerCase() || '';
            loadStockData();
            
            const filtered = distributionHistory.filter(dist => {
                const branchName = branches.find(b => b.id === dist.branch)?.name?.toLowerCase() || dist.branch?.toLowerCase() || '';
                const dispatchNum = (dist.dispatchNumber || '').toLowerCase();
                const expiryDate = (dist.expiryDate || '').toLowerCase();
                
                return dist.productName?.toLowerCase().includes(search) ||
                    branchName.includes(search) ||
                    dist.warehouse?.toLowerCase().includes(search) ||
                    dispatchNum.includes(search) ||
                    expiryDate.includes(search);
            });
            
            const container = document.getElementById('distributionHistoryList');
            if (!container) return;
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No matching distributions found.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(dist => {
                const branchName = branches.find(b => b.id === dist.branch)?.name || dist.branch;
                return `
                <div class="client-card">
                    <h4>${dist.productName}</h4>
                    <p><strong>Dispatch Number:</strong> ${dist.dispatchNumber || 'N/A'}</p>
                    <p><strong>From:</strong> ${dist.warehouse === 'windhoek' ? 'Windhoek Warehouse' : 'Ondangwa Warehouse'} | <strong>To:</strong> ${branchName}</p>
                    <p><strong>Quantity:</strong> ${dist.quantity} units</p>
                    <p><strong>Distribution Date:</strong> ${dist.date} | <strong>Expiry Date:</strong> ${dist.expiryDate || 'N/A'}</p>
                    <p><strong>Distributed by:</strong> ${dist.createdBy}</p>
                    ${dist.notes ? `<p><em>${dist.notes}</em></p>` : ''}
                </div>
            `;
            }).join('');
        }
        
        function showLowStockWindhoek() {
            loadStockData();
            const lowStock = windhoekStock.filter(item => item.quantity < 10);
            
            const container = document.getElementById('windhoekStockList');
            if (!container) return;
            
            if (lowStock.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: green;">âœ“ No low stock items!</p>';
                return;
            }
            
            container.innerHTML = lowStock.map(item => `
                <div class="client-card" style="border-left: 4px solid red;">
                    <h4>${item.productName}</h4>
                    <p><strong>Current Stock:</strong> ${item.quantity} ${item.unit} âš ï¸</p>
                    <p><strong>Code:</strong> ${item.productCode}</p>
                </div>
            `).join('');
        }
        
        function showLowStockOndangwa() {
            loadStockData();
            const lowStock = ondangwaStock.filter(item => item.quantity < 10);
            
            const container = document.getElementById('ondangwaStockList');
            if (!container) return;
            
            if (lowStock.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: green;">âœ“ No low stock items!</p>';
                return;
            }
            
            container.innerHTML = lowStock.map(item => `
                <div class="client-card" style="border-left: 4px solid red;">
                    <h4>${item.productName}</h4>
                    <p><strong>Current Stock:</strong> ${item.quantity} ${item.unit} âš ï¸</p>
                    <p><strong>Code:</strong> ${item.productCode}</p>
                </div>
            `).join('');
        }
        
        // ==================== FINANCE PORTAL FUNCTIONS ====================
        
        // Load expenses and budgets with API integration
        async function loadFinancialData() {
            try {
                const apiBase = getApiBase();
                
                // Try API first for expenses
                try {
                    const expensesResponse = await fetch(`${apiBase}/expenses`);
                    if (expensesResponse.ok) {
                        const apiExpenses = await expensesResponse.json();
                        if (Array.isArray(apiExpenses) && apiExpenses.length > 0) {
                            expenses = apiExpenses;
                            localStorage.setItem('dynapharm_expenses', JSON.stringify(expenses));
                        }
                    }
                } catch (e) {
                    console.debug('Expenses API not available, using localStorage');
                }
                
                // Try API for budgets
                try {
                    const budgetsResponse = await fetch(`${apiBase}/budgets`);
                    if (budgetsResponse.ok) {
                        const apiBudgets = await budgetsResponse.json();
                        if (Array.isArray(apiBudgets) && apiBudgets.length > 0) {
                            budgets = apiBudgets;
                            localStorage.setItem('dynapharm_budgets', JSON.stringify(budgets));
                        }
                    }
                } catch (e) {
                    console.debug('Budgets API not available, using localStorage');
                }
            } catch (e) {
                console.debug('API loading failed, using localStorage only');
            }
            
            // Fallback to localStorage
            if (!expenses || expenses.length === 0) {
                expenses = JSON.parse(localStorage.getItem('dynapharm_expenses') || '[]');
            }
            if (!budgets || budgets.length === 0) {
                budgets = JSON.parse(localStorage.getItem('dynapharm_budgets') || '[]');
            }
        }
        
        // Save expenses and budgets to localStorage
        function saveFinancialData() {
            localStorage.setItem('dynapharm_expenses', JSON.stringify(expenses));
            localStorage.setItem('dynapharm_budgets', JSON.stringify(budgets));
        }
        
        // Show add expense modal
        function showAddExpenseModal() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addExpenseModal').style.display = 'block';
        }
        
        // Add expense
        document.getElementById('addExpenseForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const expense = {
                id: Date.now().toString(),
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                date: document.getElementById('expenseDate').value,
                paymentMethod: document.getElementById('expensePaymentMethod').value,
                notes: document.getElementById('expenseNotes').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'system'
            };
            expenses.push(expense);
            saveFinancialData();
            closeModal('addExpenseModal');
            refreshExpenses();
            refreshFinancialOverview();
            document.getElementById('addExpenseForm').reset();
        });
        
        // Show add budget modal
        function showAddBudgetModal() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            document.getElementById('budgetMonth').value = String(currentMonth).padStart(2, '0');
            document.getElementById('budgetYear').value = currentYear;
            document.getElementById('addBudgetModal').style.display = 'block';
        }
        
        // Add budget
        document.getElementById('addBudgetForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const budget = {
                id: Date.now().toString(),
                period: document.getElementById('budgetPeriod').value,
                month: document.getElementById('budgetMonth').value,
                year: parseInt(document.getElementById('budgetYear').value),
                category: document.getElementById('budgetCategory').value,
                amount: parseFloat(document.getElementById('budgetAmount').value),
                notes: document.getElementById('budgetNotes').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'system'
            };
            budgets.push(budget);
            saveFinancialData();
            closeModal('addBudgetModal');
            refreshBudgets();
            document.getElementById('addBudgetForm').reset();
        });
        
        // Refresh expenses
        function refreshExpenses() {
            loadFinancialData();
            
            // Load cash bonuses from localStorage
            const bonuses = JSON.parse(localStorage.getItem('dynapharm_cash_bonuses') || '[]');
            
            // Convert bonuses to expense format for unified display
            const bonusExpenses = bonuses.map(b => ({
                id: b.id,
                category: 'other',
                description: `Cash Bonus - ${b.distributorNB || 'N/A'} (${b.branch || 'All'}) - ${b.reason || ''}`,
                amount: parseFloat(b.amount || 0),
                date: b.date || b.createdAt,
                paymentMethod: 'cash',
                notes: `Distributor: ${b.distributorNB || 'N/A'}, Approved by: ${b.approvedBy || 'N/A'}`,
                createdAt: b.createdAt,
                createdBy: b.approvedBy || 'system',
                type: 'bonus'
            }));
            
            // Combine expenses and bonuses
            const allExpenses = [...expenses, ...bonusExpenses];
            
            const category = document.getElementById('expenseCategoryFilter')?.value || 'all';
            const month = document.getElementById('expenseMonthFilter')?.value || 'all';
            const search = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            
            let filtered = allExpenses;
            if (category !== 'all') filtered = filtered.filter(e => e.category === category);
            if (month !== 'all') filtered = filtered.filter(e => e.date.startsWith(month));
            if (search) filtered = filtered.filter(e => e.description.toLowerCase().includes(search));
            
            displayExpenses(filtered);
        }
        
        // Display expenses
        function displayExpenses(expenseList) {
            const container = document.getElementById('expenseList');
            if (!container) return;
            
            if (expenseList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No expenses found</p>';
                return;
            }
            
            container.innerHTML = expenseList.map(expense => `
                <div class="client-card" style="${expense.type === 'bonus' ? 'border-left: 4px solid #3498db;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4>${expense.description} ${expense.type === 'bonus' ? '<span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">BONUS</span>' : ''}</h4>
                            <p><strong>Category:</strong> ${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}</p>
                            <p><strong>Date:</strong> ${new Date(expense.date).toLocaleDateString()}</p>
                            <p><strong>Payment:</strong> ${expense.paymentMethod}</p>
                            ${expense.notes ? `<p><strong>Notes:</strong> ${expense.notes}</p>` : ''}
                            ${expense.type === 'bonus' && expense.createdBy ? `<p><strong>Recorded by:</strong> ${expense.createdBy}</p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">N$ ${expense.amount.toFixed(2)}</div>
                            ${expense.type !== 'bonus' ? `<button class="btn btn-danger" onclick="deleteExpense('${expense.id}')" style="margin-top: 10px; padding: 5px 15px;">ðŸ—‘ï¸ Delete</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Delete expense
        function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;
            expenses = expenses.filter(e => e.id !== id);
            saveFinancialData();
            refreshExpenses();
            refreshFinancialOverview();
        }
        
        // Filter expenses
        function filterExpenses() {
            refreshExpenses();
        }
        
        // Refresh budgets
        function refreshBudgets() {
            loadFinancialData();
            const month = document.getElementById('budgetMonthFilter')?.value || '';
            const year = document.getElementById('budgetYearFilter')?.value || '';
            
            let filtered = budgets;
            if (month) filtered = filtered.filter(b => b.month === month);
            if (year) filtered = filtered.filter(b => b.year === parseInt(year));
            
            displayBudgets(filtered);
        }
        
        // Display budgets
        function displayBudgets(budgetList) {
            const container = document.getElementById('budgetList');
            if (!container) return;
            
            if (budgetList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No budgets found</p>';
                return;
            }
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            container.innerHTML = budgetList.map(budget => {
                const actualExpenses = expenses.filter(e => {
                    const expenseMonth = e.date.split('-')[1];
                    const expenseYear = parseInt(e.date.split('-')[0]);
                    return expenseMonth === budget.month && expenseYear === budget.year && e.category === budget.category;
                }).reduce((sum, e) => sum + e.amount, 0);
                
                const percentage = (actualExpenses / budget.amount) * 100;
                const status = percentage > 100 ? 'danger' : percentage > 80 ? 'warning' : 'success';
                
                return `
                    <div class="client-card" style="border-left: 4px solid ${status === 'success' ? '#27ae60' : status === 'warning' ? '#f39c12' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4>${budget.category.charAt(0).toUpperCase() + budget.category.slice(1)} - ${monthNames[parseInt(budget.month) - 1]} ${budget.year}</h4>
                                <p><strong>Period:</strong> ${budget.period}</p>
                                <div style="margin-top: 10px;">
                                    <p><strong>Budgeted:</strong> N$ ${budget.amount.toFixed(2)}</p>
                                    <p><strong>Actual:</strong> N$ ${actualExpenses.toFixed(2)}</p>
                                    <p><strong>Remaining:</strong> N$ ${(budget.amount - actualExpenses).toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${status === 'success' ? '#27ae60' : status === 'warning' ? '#f39c12' : '#e74c3c'};">
                                    ${percentage.toFixed(1)}%
                                </div>
                                <button class="btn btn-danger" onclick="deleteBudget('${budget.id}')" style="margin-top: 10px; padding: 5px 15px;">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter budgets
        function filterBudgets() {
            refreshBudgets();
        }
        
        // Delete budget
        function deleteBudget(id) {
            if (!confirm('Delete this budget?')) return;
            budgets = budgets.filter(b => b.id !== id);
            saveFinancialData();
            refreshBudgets();
        }
        
        // Refresh financial overview
        function refreshFinancialOverview() {
            loadFinancialData();
            
            // Calculate totals
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Calculate revenue from reports/sales
            const prescriptionRevenue = reports.reduce((sum, r) => {
                if (r.prescription && Array.isArray(r.prescription)) {
                    return sum + r.prescription.reduce((s, p) => s + (p.totalPrice || 0), 0);
                }
                return sum;
            }, 0);
            
            const walkinRevenue = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]').reduce((sum, s) => sum + (s.totalAmount || 0), 0);
            const totalRevenue = prescriptionRevenue + walkinRevenue;
            const netProfit = totalRevenue - totalExpenses;
            const cashFlow = totalRevenue - totalExpenses;
            
            // Update display
            const revenueEl = document.getElementById('totalRevenue');
            const expensesEl = document.getElementById('totalExpenses');
            const profitEl = document.getElementById('netProfit');
            const flowEl = document.getElementById('cashFlow');
            
            if (revenueEl) revenueEl.textContent = `N$ ${totalRevenue.toFixed(2)}`;
            if (expensesEl) expensesEl.textContent = `N$ ${totalExpenses.toFixed(2)}`;
            if (profitEl) {
                profitEl.textContent = `N$ ${netProfit.toFixed(2)}`;
                profitEl.style.color = netProfit >= 0 ? '#27ae60' : '#e74c3c';
            }
            if (flowEl) {
                flowEl.textContent = `N$ ${cashFlow.toFixed(2)}`;
                flowEl.style.color = cashFlow >= 0 ? '#27ae60' : '#e74c3c';
            }
        }
        
        // Refresh revenue
        function refreshRevenue() {
            loadFinancialData();
            
            const prescriptionRevenue = reports.reduce((sum, r) => {
                if (r.prescription && Array.isArray(r.prescription)) {
                    return sum + r.prescription.reduce((s, p) => s + (p.totalPrice || 0), 0);
                }
                return sum;
            }, 0);
            
            const walkinRevenue = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]').reduce((sum, s) => sum + (s.totalAmount || 0), 0);
            const totalSales = prescriptionRevenue + walkinRevenue;
            
            const prescriptionEl = document.getElementById('prescriptionRevenue');
            const walkinEl = document.getElementById('walkinRevenue');
            const totalEl = document.getElementById('totalSales');
            
            if (prescriptionEl) prescriptionEl.textContent = `N$ ${prescriptionRevenue.toFixed(2)}`;
            if (walkinEl) walkinEl.textContent = `N$ ${walkinRevenue.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `N$ ${totalSales.toFixed(2)}`;
        }
        
        // Generate financial report
        function generateFinancialReport() {
            refreshFinancialOverview();
            alert('Full financial report feature coming soon!');
        }
        
        // Export financial data
        function exportFinancialData() {
            loadFinancialData();
            const data = {
                expenses,
                budgets,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        // Report generation functions
        function generateProfitLossReport() {
            loadFinancialData();
            refreshFinancialOverview();
            
            const display = document.getElementById('financeReportDisplay');
            if (!display) return;
            
            const totalRevenue = parseFloat(document.getElementById('totalRevenue')?.textContent.replace(/[^0-9.]/g, '') || '0');
            const totalExpenses = parseFloat(document.getElementById('totalExpenses')?.textContent.replace(/[^0-9.]/g, '') || '0');
            const netProfit = totalRevenue - totalExpenses;
            
            display.innerHTML = `
                <h3>ðŸ“Š Profit & Loss Report</h3>
                <div style="margin-top: 20px;">
                    <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                        <h4>Total Revenue: <span style="color: #27ae60;">N$ ${totalRevenue.toFixed(2)}</span></h4>
                    </div>
                    <div style="padding: 15px; background: #ffebee; border-radius: 8px; margin-bottom: 10px;">
                        <h4>Total Expenses: <span style="color: #e74c3c;">N$ ${totalExpenses.toFixed(2)}</span></h4>
                    </div>
                    <div style="padding: 15px; background: ${netProfit >= 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; border: 2px solid ${netProfit >= 0 ? '#27ae60' : '#e74c3c'};">
                        <h4>Net Profit: <span style="color: ${netProfit >= 0 ? '#27ae60' : '#e74c3c'}; font-size: 1.5rem;">N$ ${netProfit.toFixed(2)}</span></h4>
                    </div>
                </div>
            `;
        }
        
        function generateCashFlowReport() {
            loadFinancialData();
            alert('Cash Flow Report feature coming soon!');
        }
        
        function generateBudgetReport() {
            loadFinancialData();
            refreshBudgets();
            
            const display = document.getElementById('financeReportDisplay');
            if (!display) return;
            
            display.innerHTML = `
                <h3>ðŸ“ˆ Budget vs Actual Report</h3>
                <div style="margin-top: 20px;">
                    ${budgets.length === 0 ? '<p style="text-align: center; color: #7f8c8d;">No budgets created yet</p>' : 'View budgets above'}
                </div>
            `;
        }
        
        function generateExpenseReport() {
            loadFinancialData();
            
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });
            
            const display = document.getElementById('financeReportDisplay');
            if (!display) return;
            
            display.innerHTML = `
                <h3>ðŸ’¸ Expense Report by Category</h3>
                <div style="margin-top: 20px;">
                    ${Object.entries(categoryTotals).map(([cat, total]) => `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between;">
                            <h4>${cat.charAt(0).toUpperCase() + cat.slice(1)}</h4>
                            <span style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">N$ ${total.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Monthly Financial Summary Functions
        function generateMonthlySummary() {
            const month = document.getElementById('summaryMonth').value;
            const year = document.getElementById('summaryYear').value;
            const monthDate = `${year}-${month}`;
            
            // Load all reports and sales data
            const reports = JSON.parse(localStorage.getItem('dyna_reports') || '[]');
            const walkInSales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const expenses = JSON.parse(localStorage.getItem('dynapharm_expenses') || '[]');
            const bonuses = JSON.parse(localStorage.getItem('dynapharm_cash_bonuses') || '[]');
            const deposits = JSON.parse(localStorage.getItem('dynapharm_deposits') || '[]');
            
            // Filter data for the selected month
            const monthReports = reports.filter(r => r.createdAt && r.createdAt.startsWith(monthDate));
            const monthSales = walkInSales.filter(s => s.createdAt && s.createdAt.startsWith(monthDate));
            const monthExpenses = expenses.filter(e => e.date && e.date.startsWith(monthDate));
            const monthBonuses = bonuses.filter(b => b.date && b.date.startsWith(monthDate));
            const monthDeposits = deposits.filter(d => d.date && d.date.startsWith(monthDate));
            
            // Group by branch
            const branchData = {};
            
            // Process reports (prescription sales)
            monthReports.forEach(report => {
                const branch = report.branch || 'Unknown';
                if (!branchData[branch]) {
                    branchData[branch] = {
                        name: branch,
                        sales: 0,
                        swiped: 0,
                        eft: 0,
                        cashSale: 0,
                        bonus: 0,
                        cashBack: 0,
                        otherExpenses: 0,
                        totalExpenses: 0,
                        cashAtHand: 0,
                        banked: 0
                    };
                }
                
                report.medicines.forEach(med => {
                    const price = med.currentPrice || {};
                    const quantity = med.quantity || 1;
                    const amount = (price.cp || 0) * quantity;
                    
                    if (report.paymentMethod === 'card' || report.paymentMethod === 'swiped') {
                        branchData[branch].swiped += amount;
                        branchData[branch].sales += amount;
                    } else if (report.paymentMethod === 'eft') {
                        branchData[branch].eft += amount;
                        branchData[branch].sales += amount;
                    } else {
                        branchData[branch].cashSale += amount;
                        branchData[branch].sales += amount;
                    }
                });
            });
            
            // Process walk-in sales
            monthSales.forEach(sale => {
                const branch = sale.branch || 'Unknown';
                if (!branchData[branch]) {
                    branchData[branch] = {
                        name: branch,
                        sales: 0,
                        swiped: 0,
                        eft: 0,
                        cashSale: 0,
                        bonus: 0,
                        cashBack: 0,
                        otherExpenses: 0,
                        totalExpenses: 0,
                        cashAtHand: 0,
                        banked: 0
                    };
                }
                
                const total = parseFloat(sale.totalAmount || 0);
                branchData[branch].sales += total;
                
                if (sale.paymentMethod === 'card' || sale.paymentMethod === 'swiped') {
                    branchData[branch].swiped += total;
                } else if (sale.paymentMethod === 'eft') {
                    branchData[branch].eft += total;
                } else {
                    branchData[branch].cashSale += total;
                }
            });
            
            // Process bonuses and expenses
            monthBonuses.forEach(bonus => {
                const branch = bonus.branch || 'Unknown';
                const amount = parseFloat(bonus.amount || 0);
                if (!branchData[branch]) {
                    branchData[branch] = {
                        name: branch,
                        sales: 0,
                        swiped: 0,
                        eft: 0,
                        cashSale: 0,
                        bonus: 0,
                        cashBack: 0,
                        otherExpenses: 0,
                        totalExpenses: 0,
                        cashAtHand: 0,
                        banked: 0
                    };
                }
                branchData[branch].bonus += amount;
                branchData[branch].totalExpenses += amount;
            });
            
            monthExpenses.forEach(exp => {
                const branch = exp.branch || 'Unknown';
                const amount = parseFloat(exp.amount || 0);
                if (!branchData[branch]) {
                    branchData[branch] = {
                        name: branch,
                        sales: 0,
                        swiped: 0,
                        eft: 0,
                        cashSale: 0,
                        bonus: 0,
                        cashBack: 0,
                        otherExpenses: 0,
                        totalExpenses: 0,
                        cashAtHand: 0,
                        banked: 0
                    };
                }
                
                if (exp.type === 'bonus') {
                    branchData[branch].cashBack += amount;
                } else {
                    branchData[branch].otherExpenses += amount;
                }
                branchData[branch].totalExpenses += amount;
            });
            
            // Process deposits
            monthDeposits.forEach(deposit => {
                const branch = deposit.branch || 'Unknown';
                const amount = parseFloat(deposit.amount || 0);
                if (!branchData[branch]) {
                    branchData[branch] = {
                        name: branch,
                        sales: 0,
                        swiped: 0,
                        eft: 0,
                        cashSale: 0,
                        bonus: 0,
                        cashBack: 0,
                        otherExpenses: 0,
                        totalExpenses: 0,
                        cashAtHand: 0,
                        banked: 0
                    };
                }
                branchData[branch].banked += amount;
            });
            
            // Calculate final summary
            const branches = Object.values(branchData);
            const totals = {
                name: 'TOTAL',
                sales: branches.reduce((sum, b) => sum + b.sales, 0),
                swiped: branches.reduce((sum, b) => sum + b.swiped, 0),
                eft: branches.reduce((sum, b) => sum + b.eft, 0),
                cashSale: branches.reduce((sum, b) => sum + b.cashSale, 0),
                bonus: branches.reduce((sum, b) => sum + b.bonus, 0),
                cashBack: branches.reduce((sum, b) => sum + b.cashBack, 0),
                otherExpenses: branches.reduce((sum, b) => sum + b.otherExpenses, 0),
                totalExpenses: branches.reduce((sum, b) => sum + b.totalExpenses, 0),
                cashAtHand: 0,
                banked: branches.reduce((sum, b) => sum + b.banked, 0)
            };
            totals.cashAtHand = totals.cashSale - totals.totalExpenses;
            totals.netBalance = totals.sales - totals.totalExpenses;
            
            // Calculate net balance for each branch
            branches.forEach(branch => {
                branch.cashAtHand = branch.cashSale - branch.totalExpenses;
                branch.netBalance = branch.sales - branch.totalExpenses;
            });
            
            const allRows = [...branches, totals];
            
            // Display table
            const container = document.getElementById('monthlySummaryTable');
            if (!container) return;
            
            const monthName = new Date(`${year}-${month}-01`).toLocaleDateString('en-US', { month: 'long' });
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border: 2px solid #c41e3a;">
                        <thead>
                            <tr style="background: #c41e3a; color: white;">
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold;">DPC NAME</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">SALES</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">SWIPED</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">EFT</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">CASH SALE</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">BONUS</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">CASH BACK</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">OTHER EXPENSES</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">TOTAL EXPENSES</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">CASH AT HAND</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">BANKED</th>
                                <th style="padding: 12px; border: 1px solid #fff; font-weight: bold; text-align: right;">NET BALANCE</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allRows.map((row, idx) => {
                                const isTotal = row.name === 'TOTAL';
                                return `
                                    <tr style="${isTotal ? 'background: #fff3cd; font-weight: bold;' : ''}">
                                        <td style="padding: 10px; border: 1px solid #ddd; ${isTotal ? 'font-size: 1.1rem;' : ''}">${row.name}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.sales.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.swiped.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.eft.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.cashSale.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.bonus.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.cashBack.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.otherExpenses.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.totalExpenses.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; ${isTotal && row.cashAtHand < 0 ? 'color: #e74c3c;' : ''}">N$ ${row.cashAtHand.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">N$ ${row.banked.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; ${row.netBalance < 0 ? 'color: #e74c3c;' : 'color: #27ae60;'}">N$ ${row.netBalance.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0;">Summary for ${monthName} ${year}</h4>
                    <p style="margin: 5px 0; color: #666;">Generated on: ${new Date().toLocaleString()}</p>
                </div>
            `;
        }
        
        function exportMonthlySummaryCSV() {
            const container = document.getElementById('monthlySummaryTable');
            if (!container || !container.querySelector('table')) {
                alert('Please generate summary first');
                return;
            }
            
            let csv = 'DPC NAME,SALES,SWIPED,EFT,CASH SALE,BONUS,CASH BACK,OTHER EXPENSES,TOTAL EXPENSES,CASH AT HAND,BANKED,NET BALANCE\n';
            
            const rows = container.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const values = Array.from(cols).map(td => {
                    let text = td.textContent.trim();
                    return text.startsWith('N$') ? text.replace('N$', '').trim() : text;
                });
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monthly_summary_${document.getElementById('summaryMonth').value}_${document.getElementById('summaryYear').value}.csv`;
            a.click();
        }
        
        function printMonthlySummary() {
            const container = document.getElementById('monthlySummaryTable');
            if (!container) {
                alert('Please generate summary first');
                return;
            }
            
            window.print();
        }
        
        function showExpenseSummary() {
            loadFinancialData();
            generateExpenseReport();
        }
        
        function showRevenueBreakdown() {
            refreshRevenue();
            const display = document.getElementById('revenueList');
            if (!display) return;
            
            loadReportsFromFile();
            const prescriptionSales = reports.filter(r => r.prescription && r.prescription.length > 0).length;
            const walkinSales = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]').length;
            
            display.innerHTML = `
                <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                    <h4>ðŸ“‹ Prescription Sales: ${prescriptionSales} transactions</h4>
                </div>
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                    <h4>ðŸ›’ Walk-in Sales: ${walkinSales} transactions</h4>
                </div>
            `;
        }
        
        // Initialize finance data on load
        loadFinancialData();
        
        // ============================================
        // ENHANCED FINANCE PORTAL FUNCTIONS
        // ============================================
        
        // Get API base URL
        function getApiBase() {
            const metaTag = document.querySelector('meta[name="api-base"]');
            if (metaTag && metaTag.content) {
                return metaTag.content;
            }
            // Default to relative path
            return '/api';
        }
        
        // Load enhanced finance data with API integration
        async function loadEnhancedFinanceData() {
            try {
                // Try API first for deposits, bonuses, and expenses
                const apiBase = getApiBase();
                
                // Load deposits from API
                try {
                    const depositsResponse = await fetch(`${apiBase}/deposits`);
                    if (depositsResponse.ok) {
                        bankDeposits = await depositsResponse.json();
                        if (!Array.isArray(bankDeposits)) bankDeposits = [];
                        // Cache to localStorage
                        localStorage.setItem('finance_deposits', JSON.stringify(bankDeposits));
                    }
                } catch (e) {
                    console.debug('Deposits API not available, using localStorage');
                }
                
                // Load bonuses from API
                try {
                    const bonusesResponse = await fetch(`${apiBase}/bonus?action=payments`);
                    if (bonusesResponse.ok) {
                        const bonusData = await bonusesResponse.json();
                        if (Array.isArray(bonusData)) {
                            cashBonuses = bonusData.filter(b => b.method === 'cash');
                            bankBonuses = bonusData.filter(b => b.method === 'bank');
                        }
                        // Cache to localStorage
                        localStorage.setItem('finance_bonuses', JSON.stringify(cashBonuses));
                        localStorage.setItem('finance_bank_bonuses', JSON.stringify(bankBonuses));
                    }
                } catch (e) {
                    console.debug('Bonuses API not available, using localStorage');
                }
                
                // Load expenses from API
                try {
                    const expensesResponse = await fetch(`${apiBase}/expenses`);
                    if (expensesResponse.ok) {
                        const apiExpenses = await expensesResponse.json();
                        if (Array.isArray(apiExpenses) && apiExpenses.length > 0) {
                            expenses = apiExpenses;
                            localStorage.setItem('dynapharm_expenses', JSON.stringify(expenses));
                        }
                    }
                } catch (e) {
                    console.debug('Expenses API not available, using localStorage');
                }
            } catch (e) {
                console.debug('API loading failed, using localStorage only');
            }
            
            // Fallback to localStorage
            if (!bankDeposits || bankDeposits.length === 0) {
                bankDeposits = JSON.parse(localStorage.getItem('finance_deposits') || '[]');
            }
            if (!cashBonuses || cashBonuses.length === 0) {
                cashBonuses = JSON.parse(localStorage.getItem('finance_bonuses') || '[]');
            }
            if (!bankBonuses || bankBonuses.length === 0) {
                bankBonuses = JSON.parse(localStorage.getItem('finance_bank_bonuses') || '[]');
            }
            if (!expenses || expenses.length === 0) {
                expenses = JSON.parse(localStorage.getItem('dynapharm_expenses') || '[]');
            }
            
            cashShifts = JSON.parse(localStorage.getItem('finance_shifts') || '[]');
            currentShift = JSON.parse(localStorage.getItem('finance_current_shift') || 'null');
            
            // Also load from legacy keys for compatibility
            const legacyBonuses = JSON.parse(localStorage.getItem('dynapharm_cash_bonuses') || '[]');
            if (legacyBonuses.length > 0 && cashBonuses.length === 0) {
                cashBonuses = legacyBonuses;
            }
        }
        
        // Save enhanced finance data
        function saveEnhancedFinanceData() {
            localStorage.setItem('finance_deposits', JSON.stringify(bankDeposits));
            localStorage.setItem('finance_bonuses', JSON.stringify(cashBonuses));
            localStorage.setItem('finance_bank_bonuses', JSON.stringify(bankBonuses));
            localStorage.setItem('finance_shifts', JSON.stringify(cashShifts));
            localStorage.setItem('finance_current_shift', JSON.stringify(currentShift));
        }
        
        // Calculate live cash at hand
        function calculateCashAtHand(branch) {
            const today = new Date().toISOString().split('T')[0];
            
            // Get opening float (from current shift or most recent shift)
            let openingFloat = 0;
            if (currentShift && currentShift.branch === branch && currentShift.openTime) {
                openingFloat = currentShift.openingFloat || 0;
            } else {
                const recentShift = cashShifts
                    .filter(s => s.branch === branch)
                    .sort((a, b) => new Date(b.closeTime) - new Date(a.closeTime))[0];
                if (recentShift) {
                    openingFloat = recentShift.countedCash || 0;
                } else {
                    // Fallback: Check dispenser cash drawer data for this branch
                    try {
                        const drawerData = JSON.parse(localStorage.getItem('dyna_cash_drawer') || '{}');
                        // If drawer is open and matches branch, use its opening balance
                        if (drawerData.isOpen && drawerData.branch === branch) {
                            openingFloat = drawerData.openingBalance || 0;
                        } else if (drawerData.openingBalance) {
                            // Use stored opening balance if available
                            openingFloat = drawerData.openingBalance || 0;
                        }
                    } catch (e) {
                        console.warn('Error reading cash drawer data:', e);
                    }
                }
            }
            
            // Calculate cash sales
            const cashSales = getCashSalesForBranch(today, branch);
            
            // Get bank deposits
            const deposits = bankDeposits
                .filter(d => d.date === today && d.branch === branch)
                .reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
            
            // Get cash expenses (approved only)
            const cashExpenses = expenses
                .filter(e => e.date === today && e.paymentMethod === 'cash' && e.branch === branch)
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            
            // Get cash bonuses
            const bonuses = cashBonuses
                .filter(b => b.date === today && b.branch === branch)
                .reduce((sum, b) => sum + parseFloat(b.amount || 0), 0);
            
            // Cash at Hand = Opening Float + Cash Sales - Deposits - Cash Expenses - Bonuses
            const cashAtHand = openingFloat + cashSales - deposits - cashExpenses - bonuses;
            
            return {
                openingFloat,
                cashSales,
                deposits,
                cashExpenses,
                bonuses,
                cashAtHand
            };
        }
        
        // Get cash sales for a specific branch and date
        function getCashSalesForBranch(date, branch) {
            let total = 0;
            
            // Check walk-in sales - check both storage keys
            const walkinSales1 = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const walkinSales2 = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            const allWalkinSales = [...walkinSales1, ...walkinSales2];
            const uniqueWalkinSales = Array.from(new Map(allWalkinSales.map(s => [s.id, s])).values());
            
            uniqueWalkinSales.forEach(sale => {
                const saleDate = sale.date || (sale.timestamp ? sale.timestamp.split('T')[0] : null);
                if (saleDate === date && sale.customerType === 'customer') {
                    if (!branch || sale.branch === branch) {
                        // Only count if it's cash payment (or estimate for customers)
                        const amount = parseFloat(sale.totalAmount || sale.total || 0);
                        if (sale.paymentMethod === 'cash' || !sale.paymentMethod) {
                            total += amount;
                        } else if (sale.paymentMethod === 'card') {
                            // Card sales not counted as cash
                        } else {
                            // If unknown, assume cash for customer sales
                            total += amount;
                        }
                    }
                }
            });
            
            // Add prescription sales (paid medicines) - these are typically cash
            reports.forEach(report => {
                const reportDate = report.date || (report.timestamp ? report.timestamp.split('T')[0] : null);
                if (reportDate === date) {
                    if (!branch || report.branch === branch) {
                        if (report.medicines && Array.isArray(report.medicines)) {
                            report.medicines.forEach(med => {
                                if (med.paid && med.amountPaid) {
                                    total += parseFloat(med.amountPaid || 0);
                                }
                            });
                        }
                    }
                }
            });
            
            return total;
        }
        
        // Refresh financial dashboard with live data
        async function refreshFinancialDashboard() {
            // Ensure data is loaded first
            if (typeof loadEnhancedFinanceData === 'function') {
                await loadEnhancedFinanceData();
            }
            
            const branch = document.getElementById('financeBranchSelect')?.value || 'all';
            const today = new Date().toISOString().split('T')[0];
            
            if (branch === 'all') {
                // Show company-wide totals
                const totalSales = getAllSalesForDate(today);
                const totalCash = getAllCashSalesForDate(today);
                const totalCard = totalSales - totalCash;
                
                document.getElementById('dailyTotalSales').textContent = `N$ ${totalSales.toFixed(2)}`;
                document.getElementById('dailyCashSales').textContent = `N$ ${totalCash.toFixed(2)}`;
                document.getElementById('dailyCardSales').textContent = `N$ ${totalCard.toFixed(2)}`;
                document.getElementById('cashAtHand').textContent = 'N$ 0.00';
                document.getElementById('dailyDeposits').textContent = `N$ ${getAllDepositsForDate(today).toFixed(2)}`;
                document.getElementById('dailyCashExpenses').textContent = `N$ ${getAllCashExpensesForDate(today).toFixed(2)}`;
                document.getElementById('dailyBonuses').textContent = `N$ ${getAllBonusesForDate(today).toFixed(2)}`;
                document.getElementById('dailyBankBonuses').textContent = `N$ ${getAllBankBonusesForDate(today).toFixed(2)}`;
                document.getElementById('variance').textContent = 'N$ 0.00';
                document.getElementById('varianceStatus').textContent = 'Status: All Branches';
                // Company-wide stock summary from dynapharm_inventory
                const inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}');
                const totals = Object.keys(inv).reduce((acc, k) => {
                    const q = parseFloat(inv[k]?.currentStock || 0);
                    const ro = inv[k]?.reorderLevel ?? 5;
                    acc.qty += q;
                    if (q <= ro) acc.low += 1;
                    return acc;
                }, { qty: 0, low: 0 });
                const qtyEl = document.getElementById('financeBranchStockQty');
                const lowEl = document.getElementById('financeBranchLowStock');
                if (qtyEl) qtyEl.textContent = `${totals.qty}`;
                if (lowEl) lowEl.textContent = `${totals.low}`;
                try { renderInventoryBreakdown('financeInventoryBreakdown', 'all'); } catch (e) {}
                return;
            }
            
            // Branch-specific calculations
            const cashData = calculateCashAtHand(branch);
            const countedCash = currentShift?.countedCash || cashData.cashAtHand;
            const variance = countedCash - cashData.cashAtHand;
            
            // Get sales breakdown for branch
            const salesBreakdown = getSalesBreakdownForBranch(today, branch);
            
            // Update display
            document.getElementById('dailyTotalSales').textContent = `N$ ${salesBreakdown.total.toFixed(2)}`;
            document.getElementById('dailyCashSales').textContent = `N$ ${salesBreakdown.cash.toFixed(2)}`;
            document.getElementById('dailyCardSales').textContent = `N$ ${salesBreakdown.card.toFixed(2)}`;
            document.getElementById('cashAtHand').textContent = `N$ ${cashData.cashAtHand.toFixed(2)}`;
            document.getElementById('dailyDeposits').textContent = `N$ ${cashData.deposits.toFixed(2)}`;
            document.getElementById('dailyCashExpenses').textContent = `N$ ${cashData.cashExpenses.toFixed(2)}`;
            document.getElementById('dailyBonuses').textContent = `N$ ${cashData.bonuses.toFixed(2)}`;
            
            // Calculate bank bonuses for this branch
            const bankBonusesForBranch = bankBonuses
                .filter(b => b.date === today && b.branch === branch)
                .reduce((sum, b) => sum + parseFloat(b.amount || 0), 0);
            document.getElementById('dailyBankBonuses').textContent = `N$ ${bankBonusesForBranch.toFixed(2)}`;
            
            document.getElementById('variance').textContent = `N$ ${variance.toFixed(2)}`;
            
            // Variance status
            const varianceAbs = Math.abs(variance);
            const varianceEl = document.getElementById('variance');
            const statusEl = document.getElementById('varianceStatus');
            
            if (varianceAbs <= 50) {
                varianceEl.style.color = '#27ae60';
                statusEl.textContent = 'Status: âœ… OK';
            } else if (varianceAbs <= 200) {
                varianceEl.style.color = '#f39c12';
                statusEl.textContent = 'Status: âš ï¸ Minor Variance';
            } else {
                varianceEl.style.color = '#e74c3c';
                statusEl.textContent = 'Status: ðŸš¨ Significant Variance';
            }

            // Branch stock summary from dynapharm_inventory
            try {
                const inv = JSON.parse(localStorage.getItem('dynapharm_inventory') || '{}');
                const totals = Object.keys(inv).reduce((acc, k) => {
                    const q = parseFloat(inv[k]?.currentStock || 0);
                    const ro = inv[k]?.reorderLevel ?? 5;
                    acc.qty += q;
                    if (q <= ro) acc.low += 1;
                    return acc;
                }, { qty: 0, low: 0 });
                const qtyEl = document.getElementById('financeBranchStockQty');
                const lowEl = document.getElementById('financeBranchLowStock');
                if (qtyEl) qtyEl.textContent = `${totals.qty}`;
                if (lowEl) lowEl.textContent = `${totals.low}`;
            } catch (e) {}
            try { renderInventoryBreakdown('financeInventoryBreakdown', branch); } catch (e) {}
        }
        
        // Get sales breakdown for branch
        function getSalesBreakdownForBranch(date, branch) {
            let cash = 0;
            let card = 0;
            let total = 0;
            
            // Walk-in sales - check both storage keys for compatibility
            const walkinSales1 = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const walkinSales2 = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            const allWalkinSales = [...walkinSales1, ...walkinSales2];
            
            // Remove duplicates by ID
            const uniqueWalkinSales = Array.from(new Map(allWalkinSales.map(s => [s.id, s])).values());
            
            uniqueWalkinSales.forEach(sale => {
                const saleDate = sale.date || (sale.timestamp ? sale.timestamp.split('T')[0] : null);
                if (saleDate === date && sale.branch === branch) {
                    const amount = parseFloat(sale.totalAmount || sale.total || 0);
                    total += amount;
                    
                    // Use paymentMethod if available, otherwise estimate
                    if (sale.paymentMethod === 'cash') {
                        cash += amount;
                    } else if (sale.paymentMethod === 'card') {
                        card += amount;
                    } else {
                        // Default: assume 60% cash, 40% card
                        cash += amount * 0.6;
                        card += amount * 0.4;
                    }
                }
            });
            
            // Add prescription sales (paid medicines)
            reports.forEach(report => {
                const reportDate = report.date || (report.timestamp ? report.timestamp.split('T')[0] : null);
                if (reportDate === date && report.branch === branch) {
                    if (report.medicines && Array.isArray(report.medicines)) {
                        report.medicines.forEach(med => {
                            if (med.paid && med.amountPaid) {
                                const amount = parseFloat(med.amountPaid || 0);
                                total += amount;
                                // Prescription payments are typically cash
                                cash += amount;
                            }
                        });
                    }
                }
            });
            
            return { cash, card, total };
        }
        
        // Helper functions for totals
        function getAllSalesForDate(date) {
            let total = 0;
            
            // Walk-in sales - check both storage keys
            const walkinSales1 = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const walkinSales2 = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            const allWalkinSales = [...walkinSales1, ...walkinSales2];
            const uniqueWalkinSales = Array.from(new Map(allWalkinSales.map(s => [s.id, s])).values());
            
            uniqueWalkinSales.forEach(sale => {
                const saleDate = sale.date || (sale.timestamp ? sale.timestamp.split('T')[0] : null);
                if (saleDate === date) {
                    total += parseFloat(sale.totalAmount || sale.total || 0);
                }
            });
            
            // Add prescription sales (paid medicines) from all branches
            reports.forEach(report => {
                const reportDate = report.date || (report.timestamp ? report.timestamp.split('T')[0] : null);
                if (reportDate === date) {
                    if (report.medicines && Array.isArray(report.medicines)) {
                        report.medicines.forEach(med => {
                            if (med.paid && med.amountPaid) {
                                total += parseFloat(med.amountPaid || 0);
                            }
                        });
                    }
                }
            });
            
            return total;
        }
        
        function getAllCashSalesForDate(date) {
            let cashTotal = 0;
            
            // Walk-in sales - check both storage keys
            const walkinSales1 = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const walkinSales2 = JSON.parse(localStorage.getItem('dynapharm_walkin_sales') || '[]');
            const allWalkinSales = [...walkinSales1, ...walkinSales2];
            const uniqueWalkinSales = Array.from(new Map(allWalkinSales.map(s => [s.id, s])).values());
            
            uniqueWalkinSales.forEach(sale => {
                const saleDate = sale.date || (sale.timestamp ? sale.timestamp.split('T')[0] : null);
                if (saleDate === date) {
                    const amount = parseFloat(sale.totalAmount || sale.total || 0);
                    if (sale.paymentMethod === 'cash') {
                        cashTotal += amount;
                    } else if (sale.paymentMethod === 'card') {
                        // Don't count card
                    } else {
                        // Default: assume 60% cash, 40% card
                        cashTotal += amount * 0.6;
                    }
                }
            });
            
            // Add prescription sales (paid medicines) - typically cash
            reports.forEach(report => {
                const reportDate = report.date || (report.timestamp ? report.timestamp.split('T')[0] : null);
                if (reportDate === date) {
                    if (report.medicines && Array.isArray(report.medicines)) {
                        report.medicines.forEach(med => {
                            if (med.paid && med.amountPaid) {
                                cashTotal += parseFloat(med.amountPaid || 0);
                            }
                        });
                    }
                }
            });
            
            return cashTotal;
        }
        
        function getAllDepositsForDate(date) {
            return bankDeposits
                .filter(d => d.date === date)
                .reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
        }
        
        function getAllCashExpensesForDate(date) {
            return expenses
                .filter(e => e.date === date && e.paymentMethod === 'cash')
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        }
        
        function getAllBonusesForDate(date) {
            return cashBonuses
                .filter(b => b.date === date)
                .reduce((sum, b) => sum + parseFloat(b.amount || 0), 0);
        }
        
        function getAllBankBonusesForDate(date) {
            return bankBonuses
                .filter(b => b.date === date)
                .reduce((sum, b) => sum + parseFloat(b.amount || 0), 0);
        }
        
        // Populate branch selectors
        function populateBranchSelects() {
            const financeSelect = document.getElementById('financeBranchSelect');
            const depositSelect = document.getElementById('depositBranch');
            const bonusSelect = document.getElementById('bonusBranch');
            const bankBonusSelect = document.getElementById('bankBonusBranch');
            
            if (financeSelect) {
                financeSelect.innerHTML = '<option value="all">All Branches</option>';
                branches.forEach(b => {
                    financeSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            }
            
            [depositSelect, bonusSelect, bankBonusSelect].forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select Branch</option>';
                    branches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    });
                }
            });
        }
        
        // Shift Manager Functions
        function showShiftManager() {
            document.getElementById('shiftManagerModal').style.display = 'block';
            populateShiftContent();
        }
        
        function populateShiftContent() {
            const content = document.getElementById('shiftContent');
            if (!content) return;
            
            const branch = document.getElementById('financeBranchSelect')?.value;
            if (!branch || branch === 'all') {
                content.innerHTML = '<p style="text-align: center; padding: 40px;">Please select a branch first.</p>';
                return;
            }
            
            const cashData = calculateCashAtHand(branch);
            
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Current Cash Status</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 5px;">
                            <strong>Opening Float:</strong> N$ ${cashData.openingFloat.toFixed(2)}
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 5px;">
                            <strong>Cash Sales:</strong> N$ ${cashData.cashSales.toFixed(2)}
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 5px;">
                            <strong>Cash at Hand:</strong> N$ ${cashData.cashAtHand.toFixed(2)}
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 5px;">
                            <strong>Expected Count:</strong> N$ ${cashData.cashAtHand.toFixed(2)}
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Close Shift</h3>
                    <form id="closeShiftForm">
                        <div class="form-group">
                            <label>Actual Counted Cash (N$) *</label>
                            <input type="number" id="countedCash" step="0.01" min="0" required placeholder="Enter actual cash count">
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <textarea id="shiftNotes" rows="3" placeholder="Any notes about the shift..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">âœ… Close Shift</button>
                    </form>
                </div>
            `;
            
            document.getElementById('closeShiftForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const countedCash = parseFloat(document.getElementById('countedCash').value);
                const notes = document.getElementById('shiftNotes').value;
                
                closeShift(branch, countedCash, notes);
            });
        }
        
        function closeShift(branch, countedCash, notes) {
            if (!confirm('Close this shift? This will finalize the cash count.')) return;
            
            const shift = {
                id: 'SHIFT' + Date.now(),
                branch: branch,
                openedBy: currentShift?.openedBy || currentUser?.username || 'Unknown',
                openingFloat: currentShift?.openingFloat || 0,
                openTime: currentShift?.openTime || new Date().toISOString(),
                closedBy: currentUser?.username || 'Unknown',
                closeTime: new Date().toISOString(),
                countedCash: countedCash,
                notes: notes
            };
            
            cashShifts.push(shift);
            saveEnhancedFinanceData();
            
            currentShift = null;
            localStorage.setItem('finance_current_shift', 'null');
            
            alert('Shift closed successfully!');
            closeModal('shiftManagerModal');
            refreshFinancialDashboard();
        }
        
        // Bank Deposit Functions
        function showBankDeposit() {
            document.getElementById('depositDate').value = new Date().toISOString().split('T')[0];
            populateBranchSelects();
            document.getElementById('bankDepositModal').style.display = 'block';
        }
        
        document.getElementById('bankDepositForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const deposit = {
                id: 'DEP' + Date.now(),
                branch: document.getElementById('depositBranch').value,
                date: document.getElementById('depositDate').value,
                amount: parseFloat(document.getElementById('depositAmount').value),
                slipNo: document.getElementById('depositSlipNo').value,
                bankName: document.getElementById('depositBank').value,
                bankBranch: document.getElementById('depositBankBranch').value,
                accountNumber: document.getElementById('depositAccountNumber').value,
                accountType: document.getElementById('depositAccountType').value,
                depositedBy: document.getElementById('depositedBy').value,
                notes: document.getElementById('depositNotes').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'Unknown'
            };
            
            bankDeposits.push(deposit);
            saveEnhancedFinanceData();
            closeModal('bankDepositModal');
            refreshFinancialDashboard();
            alert('Deposit recorded successfully!');
            this.reset();
        });
        
        // Cash Bonus Functions
        function showCashBonus() {
            document.getElementById('bonusDate').value = new Date().toISOString().split('T')[0];
            populateBranchSelects();
            document.getElementById('cashBonusModal').style.display = 'block';
        }
        
        function checkBonusLimit() {
            const amount = parseFloat(document.getElementById('bonusAmount')?.value || 0);
            const branch = document.getElementById('bonusBranch')?.value;
            const warning = document.getElementById('bonusLimitWarning');
            
            if (!branch || !amount) return;
            
            const cashData = calculateCashAtHand(branch);
            const availableCash = cashData.cashAtHand;
            const branchLimit = 5000; // N$ 5000 default limit
            
            if (amount > branchLimit || amount > availableCash) {
                if (warning) warning.style.display = 'block';
            } else {
                if (warning) warning.style.display = 'none';
            }
        }
        
        document.getElementById('cashBonusForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const bonus = {
                id: 'BNS' + Date.now(),
                branch: document.getElementById('bonusBranch').value,
                distributorNB: document.getElementById('bonusDistributorNB').value,
                date: document.getElementById('bonusDate').value,
                amount: parseFloat(document.getElementById('bonusAmount').value),
                reason: document.getElementById('bonusReason').value,
                approvedBy: document.getElementById('bonusApprovedBy').value,
                limitChecked: true,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'Unknown'
            };
            
            cashBonuses.push(bonus);
            saveEnhancedFinanceData();
            closeModal('cashBonusModal');
            refreshFinancialDashboard();
            alert('Cash bonus recorded successfully!');
            this.reset();
        });
        
        // Bank Bonus Functions
        function showBankBonus() {
            document.getElementById('bankBonusDate').value = new Date().toISOString().split('T')[0];
            populateBranchSelects();
            document.getElementById('bankBonusModal').style.display = 'block';
        }
        
        document.getElementById('bankBonusForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const distributorNB = document.getElementById('bankBonusDistributorNB').value.trim().toUpperCase();
            
            // Validate distributor NB
            if (!validateDistributorNB(distributorNB)) {
                alert('âš ï¸ Invalid distributor NB number. Please select a valid distributor from the list.');
                const statusEl = document.getElementById('bankBonusDistributorStatus');
                if (statusEl) {
                    statusEl.textContent = 'âš ï¸ Invalid distributor NB number';
                    statusEl.style.color = '#e74c3c';
                }
                return;
            }
            
            const bonus = {
                id: 'BNKBNS' + Date.now(),
                branch: document.getElementById('bankBonusBranch').value,
                distributorNB: distributorNB,
                date: document.getElementById('bankBonusDate').value,
                amount: parseFloat(document.getElementById('bankBonusAmount').value),
                reason: document.getElementById('bankBonusReason').value,
                approvedBy: document.getElementById('bankBonusApprovedBy').value,
                bankName: document.getElementById('bankBonusBank').value,
                bankBranch: document.getElementById('bankBonusBankBranch').value,
                accountNumber: document.getElementById('bankBonusAccountNumber').value,
                accountType: document.getElementById('bankBonusAccountType').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.username || 'Unknown'
            };
            
            bankBonuses.push(bonus);
            saveEnhancedFinanceData();
            closeModal('bankBonusModal');
            refreshFinancialDashboard();
            alert('Bank bonus recorded successfully!');
            this.reset();
        });
        
        // Bonus Upload Functions
        let bonusUploadData = [];
        let bonusUploadHeaders = [];
        
        // Initialize bonus upload section
        function showBonusUpload() {
            const section = document.getElementById('bonusUploadSection');
            if (section) {
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Set default month to current month
            const today = new Date();
            const monthInput = document.getElementById('bonusUploadMonth');
            if (monthInput) {
                monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            
            // Set up file input listener (remove old listener first to prevent duplicates)
            const fileInput = document.getElementById('bonusUploadFile');
            if (fileInput) {
                // Clone and replace to remove all event listeners
                const newFileInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newFileInput, fileInput);
                newFileInput.addEventListener('change', handleBonusFileUpload);
            }
            
            // Set up branch filter listener (remove old listener first to prevent duplicates)
            const branchFilter = document.getElementById('bonusUploadBranchFilter');
            if (branchFilter) {
                // Remove existing listener by cloning
                const newBranchFilter = branchFilter.cloneNode(true);
                branchFilter.parentNode.replaceChild(newBranchFilter, branchFilter);
                newBranchFilter.addEventListener('change', renderBonusUploadTable);
            }
        }
        
        // CSV parsing function
        function parseBonusCsv(text) {
            const rows = [];
            let current = '';
            let insideQuotes = false;
            let row = [];
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') {
                    if (insideQuotes && text[i+1] === '"') { current += '"'; i++; }
                    else { insideQuotes = !insideQuotes; }
                } else if ((c === ',' || c === ';') && !insideQuotes) {
                    row.push(current.trim()); current = '';
                } else if ((c === '\n' || c === '\r') && !insideQuotes) {
                    if (current.length || row.length) { row.push(current.trim()); rows.push(row); }
                    current = ''; row = [];
                } else { current += c; }
            }
            if (current.length || row.length) { row.push(current.trim()); rows.push(row); }
            return rows.filter(r => r.length && r.join('').length);
        }
        
        // Normalize amount values
        function normalizeBonusAmount(val) {
            if (val == null) return 0;
            let s = String(val).trim();
            // Handle formats like "2 708,03" or "1,602" or "196,25"
            s = s.replace(/\s/g, '');
            // If comma used as decimal separator
            if (/\d,\d{2}$/.test(s) && !/\./.test(s)) { s = s.replace(/\./g,'').replace(',', '.'); }
            // Remove thousands separators
            s = s.replace(/,(?=\d{3}(\D|$))/g, '');
            const n = Number(s);
            return isNaN(n) ? 0 : n;
        }
        
        // Map CSV row to data object
        function mapBonusRow(row) {
            const idx = (name) => bonusUploadHeaders.findIndex(h => h.toLowerCase() === name);
            const h = (name) => row[idx(name)] ?? '';
            return {
                drn: h('drn'),
                name: h('name'),
                stockist: h('stockist'),
                area: h('area'),
                amount: normalizeBonusAmount(h('nad')),
                amountRaw: h('nad'),
                signature: h('signature') || ''
            };
        }
        
        // Handle file upload with inline validation & progress
        async function handleBonusFileUpload(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const wrap = document.getElementById('bonusUploadTableWrap');
            const totals = document.getElementById('bonusUploadTotals');
            if (totals) totals.innerHTML = '<div style="color:#334e68;">Parsing CSV...</div>';
            const text = await file.text();
            const rows = parseBonusCsv(text);
            if (!rows.length) { alert('CSV appears empty.'); return; }
            bonusUploadHeaders = rows[0].map(h => String(h).trim().toLowerCase());
            const required = ['drn','name','stockist','area','nad'];
            const missing = required.filter(r => !bonusUploadHeaders.includes(r));
            if (missing.length) { alert('Missing columns: ' + missing.join(', ')); return; }
            const errors = [];
            const data = [];
            const maxPreview = 10;
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const mapped = mapBonusRow(row);
                if (!mapped.drn || !mapped.name) {
                    errors.push({ row: i+1, message: 'Missing DRN or Name' });
                } else if (isNaN(mapped.amount)) {
                    errors.push({ row: i+1, message: 'Invalid NAD amount' });
                } else {
                    data.push(mapped);
                }
                if (i <= maxPreview && totals) {
                    totals.innerHTML = `<div style="color:#334e68;">Parsing row ${i}/${rows.length}...</div>`;
                }
            }
            bonusUploadData = data;
            renderBonusUploadTable();
            if (errors.length) {
                const errHtml = errors.slice(0, 10).map(e => `<div style='color:#c41e3a;'>Row ${e.row}: ${e.message}</div>`).join('');
                if (totals) totals.innerHTML += `<div style='margin-top:6px;'>${errHtml}${errors.length>10?`<div>...and ${errors.length-10} more</div>`:''}</div>`;
            }
            if (wrap) wrap.style.display = 'block';
            const uploadBtn = document.getElementById('bonusUploadBtn');
            if (uploadBtn) uploadBtn.disabled = bonusUploadData.length === 0;
            // Remember selections
            const monthInput = document.getElementById('bonusUploadMonth');
            const branchFilter = document.getElementById('bonusUploadBranchFilter');
            localStorage.setItem('finance_bonus_month', monthInput?.value || '');
            localStorage.setItem('finance_bonus_branch', branchFilter?.value || '');
        }
        
        // Render bonus upload table
        function renderBonusUploadTable() {
            const branchFilter = document.getElementById('bonusUploadBranchFilter');
            const branch = branchFilter ? branchFilter.value : '';
            const data = bonusUploadData.filter(r => !branch || r.area === branch);
            
            const body = document.getElementById('bonusUploadBody');
            const wrap = document.getElementById('bonusUploadTableWrap');
            const totals = document.getElementById('bonusUploadTotals');
            
            if (!body || !wrap || !totals) return;
            
            body.innerHTML = '';
            data.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${i+1}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.drn}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.name}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.stockist}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.area}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.amount.toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td style="padding: 10px 12px; border-bottom: 1px solid #eef2f7;">${r.signature}</td>
                `;
                body.appendChild(tr);
            });
            
            const total = data.reduce((s, r) => s + r.amount, 0);
            totals.innerHTML = `
                <div style="background: #eef2f7; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #334e68;">Records: ${data.length}</div>
                <div style="background: #eef2f7; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #334e68;">Total NAD: N$${total.toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})}</div>
            `;
            wrap.style.display = data.length === 0 ? 'none' : 'block';
        }
        
        // Upload bonus CSV with progress indicator
        async function uploadBonusCsv() {
            const monthInput = document.getElementById('bonusUploadMonth');
            if (!monthInput || !monthInput.value) {
                alert('Please select a month for this bonus upload.');
                return;
            }
            if (bonusUploadData.length === 0) {
                alert('No data to upload. Please select a CSV file first.');
                return;
            }
            
            const month = monthInput.value; // Format: YYYY-MM
            // Compute integrity hash (SHA-256) client-side
            async function sha256Hex(str){
                const enc = new TextEncoder();
                const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
                const arr = Array.from(new Uint8Array(buf));
                return arr.map(b => b.toString(16).padStart(2, '0')).join('');
            }
            const integrityHash = (window.crypto?.subtle) ? await sha256Hex(JSON.stringify(bonusUploadData)) : null;
            const payload = {
                action: 'upload',
                month: month,
                items: bonusUploadData,
                uploadedBy: 'finance',
                integrityHash
            };
            
            // Save locally as backup
            localStorage.setItem('finance_bonus_list', JSON.stringify({ month, items: bonusUploadData, createdAt: new Date().toISOString() }));
            
            let message = '';
            try {
            const base = getApiBase();
            const res = await fetch(`${base}/bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    const result = await res.json();
                    message = `âœ… Monthly bonus uploaded successfully for ${month}.\n\nRecords: ${result.totalRecords}\nTotal Amount: N$${result.totalAmount.toLocaleString('en-NA', {minimumFractionDigits:2, maximumFractionDigits:2})}\n\nâš ï¸ IMPORTANT: Only distributors in this CSV can be paid for ${month}.`;
                } else {
                    const error = await res.json();
                    message = `âŒ Error: ${error.error || 'Failed to upload bonus data'}`;
                }
            } catch(e) {
                message = `âš ï¸ API not reachable. Data saved locally. Please try again when online.\n\nMonth: ${month}\nRecords: ${bonusUploadData.length}`;
            }
            alert(message);
            // Save last settings
            localStorage.setItem('finance_bonus_month', month);
            const branchFilter = document.getElementById('bonusUploadBranchFilter');
            localStorage.setItem('finance_bonus_branch', branchFilter?.value || '');
        }

        // Approve/Reject monthly upload
        async function approveBonusUpload() {
            try {
                const month = document.getElementById('bonusUploadMonth')?.value;
                if (!month) { 
                    alert('âš ï¸ Please select a month first. Click the month selector and choose a month.'); 
                    return; 
                }
                const base = typeof getApiBase === 'function' ? getApiBase() : (location.hostname.includes('railway.app') ? `${location.protocol}//${location.hostname}/api` : (location.hostname.includes('vercel.app') ? '/api' : 'http://localhost:8001/api'));
                const headers = { 'Content-Type': 'application/json' };
                if (typeof currentUser !== 'undefined' && currentUser) {
                    headers['x-user-role'] = currentUser.role || '';
                    headers['x-user-name'] = currentUser.username || '';
                }
                const res = await fetch(`${base}/bonus`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action: 'approve-upload', month })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to approve');
                alert('âœ… Upload approved successfully');
            } catch (e) { 
                alert(`âŒ Approval failed: ${e.message}`); 
                console.error('Approve error:', e);
            }
        }
        async function rejectBonusUpload() {
            try {
                const month = document.getElementById('bonusUploadMonth')?.value;
                if (!month) { 
                    alert('âš ï¸ Please select a month first. Click the month selector and choose a month.'); 
                    return; 
                }
                const reason = prompt('Reason for rejection?') || '';
                const base = typeof getApiBase === 'function' ? getApiBase() : (location.hostname.includes('railway.app') ? `${location.protocol}//${location.hostname}/api` : (location.hostname.includes('vercel.app') ? '/api' : 'http://localhost:8001/api'));
                const headers = { 'Content-Type': 'application/json' };
                if (typeof currentUser !== 'undefined' && currentUser) {
                    headers['x-user-role'] = currentUser.role || '';
                    headers['x-user-name'] = currentUser.username || '';
                }
                const res = await fetch(`${base}/bonus`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action: 'reject-upload', month, reason })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to reject');
                alert('â›” Upload rejected');
            } catch (e) { 
                alert(`âŒ Rejection failed: ${e.message}`); 
                console.error('Reject error:', e);
            }
        }

        // Batch exports
        async function exportBankBatch() {
            const month = document.getElementById('bonusUploadMonth')?.value;
            if (!month) { alert('Select month first'); return; }
            const base = getApiBase();
            const url = `${base}/bonus?action=export-bank-csv&month=${encodeURIComponent(month)}`;
            try {
                const res = await fetch(url, { headers: { 'x-user-role': (currentUser?.role || ''), 'x-user-name': (currentUser?.username || '') } });
                if (!res.ok) { const e = await res.text(); throw new Error(e || 'Export failed'); }
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `bank_batch_${month}.csv`; a.click();
                URL.revokeObjectURL(a.href);
            } catch (e) { alert(`âŒ ${e.message}`); }
        }
        async function exportCashSheet() {
            const month = document.getElementById('bonusUploadMonth')?.value;
            if (!month) { alert('Select month first'); return; }
            const base = getApiBase();
            const url = `${base}/bonus?action=export-cash-csv&month=${encodeURIComponent(month)}`;
            try {
                const res = await fetch(url, { headers: { 'x-user-role': (currentUser?.role || ''), 'x-user-name': (currentUser?.username || '') } });
                if (!res.ok) { const e = await res.text(); throw new Error(e || 'Export failed'); }
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `cash_sheet_${month}.csv`; a.click();
                URL.revokeObjectURL(a.href);
            } catch (e) { alert(`âŒ ${e.message}`); }
        }

        async function exportPain001() {
            const month = document.getElementById('bonusUploadMonth')?.value;
            if (!month) { alert('Select month first'); return; }
            const base = getApiBase();
            const url = `${base}/bonus?action=export-bank-pain001&month=${encodeURIComponent(month)}`;
            try {
                const res = await fetch(url, { headers: { 'x-user-role': (currentUser?.role || ''), 'x-user-name': (currentUser?.username || '') } });
                if (!res.ok) { const e = await res.text(); throw new Error(e || 'Export failed'); }
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `bank_batch_${month}.pain.001.xml`; a.click();
                URL.revokeObjectURL(a.href);
            } catch (e) { alert(`âŒ ${e.message}`); }
        }

        // Reconciliation view
        function showFinanceReconciliation() {
            const section = document.getElementById('financeReconciliation');
            if (!section) return;
            const monthInput = document.getElementById('reconMonth');
            const bonusMonth = document.getElementById('bonusUploadMonth')?.value;
            if (monthInput && !monthInput.value) {
                const today = new Date();
                monthInput.value = bonusMonth || `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            section.style.display = 'block';
            loadReconciliation();
        }
        async function loadReconciliation() {
            const month = document.getElementById('reconMonth')?.value;
            if (!month) { alert('Select month'); return; }
            try {
                const base = getApiBase();
                const res = await fetch(`${base}/bonus?action=variances&month=${encodeURIComponent(month)}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to load reconciliation');
                const body = document.getElementById('reconBody');
                const summary = document.getElementById('reconSummary');
                // Load config for tolerance
                const cfgRes = await fetch(`${base}/bonus?action=config`);
                const cfg = await cfgRes.json();
                const tol = (cfg?.varianceTolerance ?? 0.5);
                if (body) body.innerHTML = '';
                let totalUpload = 0, totalPaid = 0, outliers = 0;
                data.items.forEach(r => {
                    totalUpload += (r.uploadedAmount || 0);
                    totalPaid += (r.paidAmount || 0);
                    const tr = document.createElement('tr');
                    const variance = (r.variance || 0);
                    const isOutlier = Math.abs(variance) > tol;
                    if (isOutlier) outliers++;
                    tr.innerHTML = `
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${r.drn}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${r.name || ''}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${(r.uploadedAmount||0).toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${(r.paidAmount||0).toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${r.method || ''}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7;">${r.status}</td>
                        <td style="padding:10px;border-bottom:1px solid #eef2f7; color:${isOutlier?'#c41e3a':'#2e7d32'};">
                            ${variance.toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})}
                            ${isOutlier && r.status !== 'unpaid' ? `<button class='btn btn-sm' style='margin-left:8px' onclick="approveVariance('${month}','${r.drn}')">Approve</button>` : ''}
                        </td>
                    `;
                    body?.appendChild(tr);
                });
                if (summary) {
                    summary.innerHTML = `Uploaded: N$ ${totalUpload.toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})} Â· Paid: N$ ${totalPaid.toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})} Â· Variance: N$ ${(totalPaid-totalUpload).toLocaleString('en-NA',{minimumFractionDigits:2, maximumFractionDigits:2})} Â· Duplicates: ${data.duplicateKeys?.length || 0} Â· Outliers: ${outliers} (tol N$ ${tol})`;
                }
            } catch (e) { alert(`âŒ ${e.message}`); }
        }

        async function approveVariance(month, drn) {
            try {
                const base = getApiBase();
                const res = await fetch(`${base}/bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-user-role': (currentUser?.role || ''), 'x-user-name': (currentUser?.username || '') },
                    body: JSON.stringify({ action: 'approve-variance', month, drn })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to approve variance');
                loadReconciliation();
            } catch (e) { alert(`âŒ ${e.message}`); }
        }
        
        // Clear bonus upload
        function clearBonusUpload() {
            bonusUploadData = [];
            bonusUploadHeaders = [];
            const body = document.getElementById('bonusUploadBody');
            const totals = document.getElementById('bonusUploadTotals');
            const wrap = document.getElementById('bonusUploadTableWrap');
            const file = document.getElementById('bonusUploadFile');
            const uploadBtn = document.getElementById('bonusUploadBtn');
            
            if (body) body.innerHTML = '';
            if (totals) totals.innerHTML = '';
            if (wrap) wrap.style.display = 'none';
            if (file) file.value = '';
            if (uploadBtn) uploadBtn.disabled = true;
        }
        
        // Download template
        function downloadBonusTemplate() {
            const csv = 'DRN,NAME,STOCKIST,AREA,NAD,SIGNATURE\nDZ011269,NALUMINO MOYOWANYAMBE,NBA,NB1,2708.03,PAID';
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bonus-template.csv'; a.click();
            URL.revokeObjectURL(url);
        }
        
        // Z-Report Functions
        function generateZReport() {
            const branch = document.getElementById('financeBranchSelect')?.value;
            if (!branch || branch === 'all') {
                alert('Please select a branch first');
                return;
            }
            
            const cashData = calculateCashAtHand(branch);
            const salesBreakdown = getSalesBreakdownForBranch(new Date().toISOString().split('T')[0], branch);
            
            const content = document.getElementById('zReportContent');
            if (!content) return;
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border: 2px solid #c41e3a; border-radius: 8px;">
                    <h2 style="color: #c41e3a; text-align: center;">DYNAPHARM INTERNATIONAL NAMIBIA</h2>
                    <h3 style="text-align: center;">Z-REPORT - ${new Date().toLocaleDateString()}</h3>
                    <p style="text-align: center; margin-bottom: 20px;"><strong>Branch:</strong> ${branches.find(b => b.id === branch)?.name || branch}</p>
                    
                    <div style="margin: 20px 0;">
                        <h4>Opening Status</h4>
                        <p><strong>Opening Float:</strong> N$ ${cashData.openingFloat.toFixed(2)}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Sales Summary</h4>
                        <p><strong>Total Sales:</strong> N$ ${salesBreakdown.total.toFixed(2)}</p>
                        <p><strong>Cash Sales:</strong> N$ ${salesBreakdown.cash.toFixed(2)}</p>
                        <p><strong>Card Sales:</strong> N$ ${salesBreakdown.card.toFixed(2)}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Cash Transactions</h4>
                        <p><strong>Bank Deposits:</strong> N$ ${cashData.deposits.toFixed(2)}</p>
                        <p><strong>Cash Expenses:</strong> N$ ${cashData.cashExpenses.toFixed(2)}</p>
                        <p><strong>Cash Bonuses:</strong> N$ ${cashData.bonuses.toFixed(2)}</p>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4>Cash Reconciliation</h4>
                        <p><strong>Opening Float:</strong> N$ ${cashData.openingFloat.toFixed(2)}</p>
                        <p><strong>+ Cash Sales:</strong> N$ ${cashData.cashSales.toFixed(2)}</p>
                        <p><strong>- Deposits:</strong> N$ ${cashData.deposits.toFixed(2)}</p>
                        <p><strong>- Cash Expenses:</strong> N$ ${cashData.cashExpenses.toFixed(2)}</p>
                        <p><strong>- Cash Bonuses:</strong> N$ ${cashData.bonuses.toFixed(2)}</p>
                        <hr style="margin: 10px 0;">
                        <p><strong style="font-size: 1.2rem;">Expected Cash at Hand:</strong> <span style="font-size: 1.5rem; color: #c41e3a;">N$ ${cashData.cashAtHand.toFixed(2)}</span></p>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <p>Generated: ${new Date().toLocaleString()}</p>
                        <p>Generated by: ${currentUser?.username || 'System'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('zReportModal').style.display = 'block';
        }
        
        function printZReport() {
            window.print();
        }
        
        function exportZReportCSV() {
            alert('CSV export feature coming soon!');
        }
        
        // Initialize enhanced finance on load
        loadEnhancedFinanceData();
        
        // Safari/iOS compatibility helpers and polyfills
        (function safariCompat() {
            // Polyfill for Element.closest in very old Safari
            if (!Element.prototype.closest) {
                Element.prototype.closest = function(selector) {
                    let el = this;
                    while (el) {
                        if (el.matches && el.matches(selector)) return el;
                        el = el.parentElement;
                    }
                    return null;
                };
            }
            // Smooth scroll behavior polyfill fallback
            try {
                if (!('scrollBehavior' in document.documentElement.style)) {
                    window.scrollTo = function(x, y) { window.scroll({ left: x, top: y }); };
                }
            } catch(e) { /* ignore */ }
            // Prevent iOS zoom on input focus by ensuring font-size >= 16px
            const style = document.createElement('style');
            style.textContent = 'input, select, textarea { font-size: 16px; }';
            document.head.appendChild(style);
        })();

        // ============================================
        // HR PORTAL FUNCTIONS
        // ============================================
        
        // Function to show HR sub-tabs
        function showHRSubTab(tabName, event) {
            document.querySelectorAll('.hr-tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.hr-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the clicked button
            const buttons = document.querySelectorAll('.hr-tab-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // Load data based on which tab is opened
            if (tabName === 'employee-management') {
                // Always reload employees when tab is opened to ensure data is fresh
                loadEmployees();
            } else if (tabName === 'leave-management') {
                loadLeaveRequests();
            } else if (tabName === 'warnings') {
                loadWarnings();
            } else if (tabName === 'terminations') {
                loadTerminations();
            } else if (tabName === 'attendance') {
                loadAttendance();
            } else if (tabName === 'performance') {
                loadPerformanceReviews();
            } else if (tabName === 'hr-communication') {
                renderPortalCommunications('hr');
            } else if (tabName === 'data-collection') {
                loadDataCollectionList();
                const currentUser = window.currentUser || {};
                if(currentUser) {
                    const hrField = document.getElementById('dcHROfficer');
                    if(hrField) hrField.value = currentUser.fullName || currentUser.username || '';
                }
            }
        }

        // Data Collection Functions
        async function submitDataCollection(event) {
            event.preventDefault();
            const criminalRecord = document.getElementById('dcCriminalYes').checked ? 'yes' : 'no';
            const payload = {
                id: `DC-${Date.now()}`,
                personalInfo: {
                    fullName: document.getElementById('dcFullName').value.trim(),
                    idNumber: document.getElementById('dcIdNumber').value.trim(),
                    dateOfBirth: document.getElementById('dcDob').value,
                    nationality: document.getElementById('dcNationality').value.trim(),
                    gender: document.getElementById('dcGender').value,
                    maritalStatus: document.getElementById('dcMaritalStatus').value
                },
                contactInfo: {
                    mobile: document.getElementById('dcMobile').value.trim(),
                    email: document.getElementById('dcEmail').value.trim(),
                    residentialAddress: document.getElementById('dcResAddress').value.trim(),
                    postalAddress: document.getElementById('dcPostAddress').value.trim()
                },
                education: {
                    highestLevel: document.getElementById('dcEducation').value.trim(),
                    institution: document.getElementById('dcInstitution').value.trim(),
                    yearCompleted: document.getElementById('dcYearCompleted').value
                },
                employment: {
                    branch: document.getElementById('dcBranch').value,
                    startDate: document.getElementById('dcStartDate').value,
                    socialSecurity: document.getElementById('dcSocialSecurity').value.trim(),
                    position: document.getElementById('dcPosition').value.trim()
                },
                banking: {
                    bankName: document.getElementById('dcBankName').value.trim(),
                    accountNumber: document.getElementById('dcAccountNumber').value.trim(),
                    branchCode: document.getElementById('dcBranchCode').value.trim()
                },
                emergencyContact: {
                    nextOfKin: document.getElementById('dcNextOfKin').value.trim(),
                    relationship: document.getElementById('dcRelationship').value.trim(),
                    contactNumber: document.getElementById('dcKinContact').value.trim(),
                    address: document.getElementById('dcKinAddress').value.trim()
                },
                medical: {
                    height: document.getElementById('dcHeight').value,
                    weight: document.getElementById('dcWeight').value,
                    chronicIllness: document.getElementById('dcChronicIllness').value.trim(),
                    disabilities: document.getElementById('dcDisabilities').value.trim(),
                    criminalRecord: criminalRecord,
                    criminalSpecify: document.getElementById('dcCriminalSpecify').value.trim(),
                    allergies: document.getElementById('dcAllergies').value.trim()
                },
                signatures: {
                    employeeSignature: document.getElementById('dcEmpSignature').value.trim(),
                    hrOfficer: document.getElementById('dcHROfficer').value.trim()
                },
                submittedAt: new Date().toISOString(),
                submittedBy: (window.currentUser && window.currentUser.fullName) || (window.currentUser && window.currentUser.username) || 'HR'
            };
            try {
                const employees = await fetch('/api/employees').then(r => r.json()).catch(() => []);
                const existing = employees.find(e => e.dataCollection?.personalInfo?.idNumber === payload.personalInfo.idNumber);
                if(existing) {
                    await fetch('/api/employees', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: existing.id,
                            dataCollection: payload,
                            fullName: payload.personalInfo.fullName,
                            email: payload.contactInfo.email,
                            phone: payload.contactInfo.mobile
                        })
                    });
                    alert('Data collection form updated successfully!');
                } else {
                    await fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fullName: payload.personalInfo.fullName,
                            userId: `STAFF-${payload.personalInfo.idNumber.slice(-6)}`,
                            role: 'consultant',
                            branch: payload.employment.branch,
                            hireDate: payload.employment.startDate,
                            email: payload.contactInfo.email,
                            phone: payload.contactInfo.mobile,
                            dataCollection: payload
                        })
                    });
                    alert('Data collection form submitted successfully!');
                }
                clearDataCollectionForm();
                await loadDataCollectionList();
            } catch(e) {
                alert('Error submitting form: ' + e.message);
            }
        }

        function clearDataCollectionForm() {
            const form = document.getElementById('dataCollectionForm');
            if(form) form.reset();
            const currentUser = window.currentUser || {};
            if(currentUser) {
                const hrField = document.getElementById('dcHROfficer');
                if(hrField) hrField.value = currentUser.fullName || currentUser.username || '';
            }
        }

        async function loadDataCollectionList() {
            try {
                const employees = await fetch('/api/employees').then(r => r.json()).catch(() => []);
                const withData = employees.filter(e => e.dataCollection);
                const container = document.getElementById('dcTable');
                if(!container) return;
                
                if(withData.length === 0) {
                    container.innerHTML = '<div style="color:#64748b; padding:20px; text-align:center;">No data collection forms submitted yet.</div>';
                    return;
                }
                
                const rows = withData.map(e => {
                    const dc = e.dataCollection;
                    return `<tr>
                        <td>${escapeHTML(dc.personalInfo.fullName)}</td>
                        <td>${escapeHTML(dc.personalInfo.idNumber)}</td>
                        <td>${escapeHTML(dc.employment.branch)}</td>
                        <td>${escapeHTML(dc.employment.position)}</td>
                        <td>${new Date(dc.submittedAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewDataCollection('${e.id}')">View</button>
                            <button class="btn btn-warning" onclick="exportDataCollection('${e.id}')">Export</button>
                        </td>
                    </tr>`;
                }).join('');
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th><th>ID Number</th><th>Branch</th><th>Position</th><th>Submitted</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } catch(e) {
                const container = document.getElementById('dcTable');
                if(container) container.innerHTML = `<div style="color:#ef4444; padding:20px;">Error loading data: ${e.message}</div>`;
            }
        }

        async function viewDataCollection(empId) {
            try {
                const employees = await fetch('/api/employees').then(r => r.json()).catch(() => []);
                const emp = employees.find(e => e.id === empId);
                if(!emp || !emp.dataCollection) {
                    alert('Data not found');
                    return;
                }
                const dc = emp.dataCollection;
                const details = `
Personal Information:
- Full Name: ${dc.personalInfo.fullName}
- ID/Passport: ${dc.personalInfo.idNumber}
- Date of Birth: ${dc.personalInfo.dateOfBirth}
- Nationality: ${dc.personalInfo.nationality}
- Gender: ${dc.personalInfo.gender}
- Marital Status: ${dc.personalInfo.maritalStatus}

Contact Information:
- Mobile: ${dc.contactInfo.mobile}
- Email: ${dc.contactInfo.email}
- Residential Address: ${dc.contactInfo.residentialAddress}
- Postal Address: ${dc.contactInfo.postalAddress}

Education:
- Level: ${dc.education.highestLevel}
- Institution: ${dc.education.institution}
- Year Completed: ${dc.education.yearCompleted}

Employment:
- Branch: ${dc.employment.branch}
- Start Date: ${dc.employment.startDate}
- Social Security: ${dc.employment.socialSecurity}
- Position: ${dc.employment.position}

Banking:
- Bank: ${dc.banking.bankName}
- Account: ${dc.banking.accountNumber}
- Branch Code: ${dc.banking.branchCode}

Emergency Contact:
- Next of Kin: ${dc.emergencyContact.nextOfKin}
- Relationship: ${dc.emergencyContact.relationship}
- Contact: ${dc.emergencyContact.contactNumber}
- Address: ${dc.emergencyContact.address}

Medical:
- Height: ${dc.medical.height} cm
- Weight: ${dc.medical.weight} kg
- Chronic Illness: ${dc.medical.chronicIllness || 'None'}
- Disabilities: ${dc.medical.disabilities || 'None'}
- Criminal Record: ${dc.medical.criminalRecord}
${dc.medical.criminalRecord === 'yes' ? `- Details: ${dc.medical.criminalSpecify}` : ''}
- Allergies: ${dc.medical.allergies || 'None'}

Signatures:
- Employee: ${dc.signatures.employeeSignature}
- HR Officer: ${dc.signatures.hrOfficer}
                `;
                alert(details);
            } catch(e) {
                alert('Error loading data: ' + e.message);
            }
        }

        async function exportDataCollection(empId) {
            try {
                const employees = await fetch('/api/employees').then(r => r.json()).catch(() => []);
                const emp = employees.find(e => e.id === empId);
                if(!emp || !emp.dataCollection) {
                    alert('Data not found');
                    return;
                }
                const dc = emp.dataCollection;
                const csv = `Name,ID Number,Date of Birth,Nationality,Gender,Marital Status,Mobile,Email,Residential Address,Postal Address,Education Level,Institution,Year Completed,Branch,Start Date,Social Security,Position,Bank Name,Account Number,Branch Code,Next of Kin,Relationship,Contact,Address,Height,Weight,Chronic Illness,Disabilities,Criminal Record,Criminal Details,Allergies,Employee Signature,HR Officer
${dc.personalInfo.fullName},${dc.personalInfo.idNumber},${dc.personalInfo.dateOfBirth},${dc.personalInfo.nationality},${dc.personalInfo.gender},${dc.personalInfo.maritalStatus},${dc.contactInfo.mobile},${dc.contactInfo.email},"${dc.contactInfo.residentialAddress}","${dc.contactInfo.postalAddress}",${dc.education.highestLevel},${dc.education.institution},${dc.education.yearCompleted},${dc.employment.branch},${dc.employment.startDate},${dc.employment.socialSecurity},${dc.employment.position},${dc.banking.bankName},${dc.banking.accountNumber},${dc.banking.branchCode},${dc.emergencyContact.nextOfKin},${dc.emergencyContact.relationship},${dc.emergencyContact.contactNumber},"${dc.emergencyContact.address}",${dc.medical.height},${dc.medical.weight},${dc.medical.chronicIllness || ''},${dc.medical.disabilities || ''},${dc.medical.criminalRecord},${dc.medical.criminalSpecify || ''},${dc.medical.allergies || ''},${dc.signatures.employeeSignature},${dc.signatures.hrOfficer}`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `data-collection-${dc.personalInfo.fullName.replace(/\s+/g,'-')}-${Date.now()}.csv`;
                a.click();
            } catch(e) {
                alert('Error exporting data: ' + e.message);
            }
        }
        
        // Employee Management Functions
        function loadEmployees() {
            try {
                // Prefer HR key, but fall back to dyna_employees if present
                const hrDataRaw = localStorage.getItem('hr_employees');
                const dynaDataRaw = localStorage.getItem('dyna_employees');
                const hrList = hrDataRaw ? JSON.parse(hrDataRaw) : null;
                const dynaList = dynaDataRaw ? JSON.parse(dynaDataRaw) : null;

                if (Array.isArray(hrList) && hrList.length > 0) {
                    employees = hrList;
                    console.log(`âœ… Loaded ${employees.length} employees from localStorage (hr_employees)`);
                } else if (Array.isArray(dynaList) && dynaList.length > 0) {
                    employees = dynaList;
                    // Heal hr_employees from dyna_employees for HR portal compatibility
                    try { localStorage.setItem('hr_employees', JSON.stringify(dynaList)); } catch(_) {}
                    console.log(`âœ… Loaded ${employees.length} employees from localStorage (dyna_employees fallback)`);
                } else {
                    employees = [];
                    console.log('âš ï¸ No employees found in localStorage (hr_employees/dyna_employees empty)');
                }
                displayEmployees();
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                employees = [];
                displayEmployees();
            }
        }
        
        function displayEmployees() {
            const searchTerm = document.getElementById('employeeSearch')?.value.toLowerCase() || '';
            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.employeeId.toLowerCase().includes(searchTerm) ||
                emp.department.toLowerCase().includes(searchTerm)
            );
            
            const listDiv = document.getElementById('employeeList');
            if (!listDiv) return;
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No employees found. Click "Add New Employee" to get started.</p>';
                return;
            }
            
            listDiv.innerHTML = filtered.map(emp => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0; color: #c41e3a;">${emp.name} <span style="color: #666; font-size: 0.9em;">(${emp.employeeId})</span></h4>
                            <p style="margin: 5px 0; color: #666;">${emp.position} - ${emp.department}</p>
                            <p style="margin: 5px 0; color: #999; font-size: 0.85em;">ðŸ“§ ${emp.email} | ðŸ“ž ${emp.phone}</p>
                            <p style="margin: 5px 0; color: #999; font-size: 0.85em;">Started: ${new Date(emp.hireDate).toLocaleDateString()}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="editEmployee('${emp.employeeId}')">âœï¸ Edit</button>
                            <button class="btn btn-danger" onclick="deleteEmployee('${emp.employeeId}')">ðŸ—‘ï¸ Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAddEmployee() {
            document.getElementById('addEmployeeModal').style.display = 'block';
            document.getElementById('employeeId').value = 'EMP' + Date.now().toString().slice(-6);
            document.getElementById('employeeHireDate').value = new Date().toISOString().split('T')[0];
        }
        
        function editEmployee(employeeId) {
            const emp = employees.find(e => e.employeeId === employeeId);
            if (!emp) return;
            
            // Populate form with employee data
            document.getElementById('employeeId').value = emp.employeeId;
            document.getElementById('employeeName').value = emp.name;
            document.getElementById('employeeDepartment').value = emp.department;
            document.getElementById('employeePosition').value = emp.position;
            document.getElementById('employeeEmail').value = emp.email;
            document.getElementById('employeePhone').value = emp.phone;
            document.getElementById('employeeHireDate').value = emp.hireDate;
            document.getElementById('employmentType').value = emp.employmentType;
            document.getElementById('employeeSalary').value = emp.salary || '';
            document.getElementById('employeeAddress').value = emp.address || '';
            document.getElementById('employeeDOB').value = emp.dob || '';
            document.getElementById('emergencyContactName').value = emp.emergencyContactName || '';
            document.getElementById('emergencyContactPhone').value = emp.emergencyContactPhone || '';
            document.getElementById('employeeNotes').value = emp.notes || '';
            
            document.getElementById('addEmployeeModal').style.display = 'block';
        }
        
        function deleteEmployee(employeeId) {
            if (!confirm('Are you sure you want to delete this employee?')) return;
            
            employees = employees.filter(e => e.employeeId !== employeeId);
            localStorage.setItem('hr_employees', JSON.stringify(employees));
            displayEmployees();
        }
        
        function refreshEmployeeList() {
            loadEmployees();
        }
        
        function exportEmployeeData() {
            const dataStr = JSON.stringify(employees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'employees_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }
        
        // Leave Management Functions
        async function loadLeaveRequests() {
            try {
                const r = await fetch('/api/leave');
                if (r.ok) {
                    const list = await r.json();
                    const ui = (list||[]).map(l => ({
                        id: l.id || ('LEAVE' + Date.now()),
                        employee: l.fullName || l.userId || 'Unknown',
                        type: l.type || 'Annual',
                        startDate: l.startDate,
                        endDate: l.endDate,
                        days: l.days || 0,
                        status: l.status || 'pending',
                        reason: l.reason || ''
                    }));
                    localStorage.setItem('hr_leave', JSON.stringify(ui));
                }
            } catch(_) {}
            const leaveData = localStorage.getItem('hr_leave');
            leaveRequests = leaveData ? JSON.parse(leaveData) : [];
            displayLeaveRequests();
        }

        function approveLeave(leaveId) {
            const idx = leaveRequests.findIndex(l => l.id === leaveId);
            if (idx === -1) return;
            leaveRequests[idx].status = 'approved';
            leaveRequests[idx].approvedBy = currentUser?.fullName || 'Approver';
            leaveRequests[idx].approvedAt = new Date().toISOString();
            localStorage.setItem('hr_leave', JSON.stringify(leaveRequests));
            displayLeaveRequests();
            recordDepartmentEvent && recordDepartmentEvent('leave_approved', leaveRequests[idx]);
        }

        function rejectLeave(leaveId) {
            const idx = leaveRequests.findIndex(l => l.id === leaveId);
            if (idx === -1) return;
            leaveRequests[idx].status = 'rejected';
            leaveRequests[idx].rejectedBy = currentUser?.fullName || 'Approver';
            leaveRequests[idx].rejectedAt = new Date().toISOString();
            localStorage.setItem('hr_leave', JSON.stringify(leaveRequests));
            displayLeaveRequests();
            recordDepartmentEvent && recordDepartmentEvent('leave_rejected', leaveRequests[idx]);
        }
        
        function displayLeaveRequests() {
            const listDiv = document.getElementById('leaveList');
            if (!listDiv) return;
            
            if (leaveRequests.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No leave requests found.</p>';
                return;
            }
            
            listDiv.innerHTML = leaveRequests.map(leave => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${
                    leave.status === 'approved' ? '#27ae60' : leave.status === 'rejected' ? '#e74c3c' : '#f39c12'
                }; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0;">${leave.type} Leave</h4>
                    <p style="margin: 5px 0; color: #666;">Employee: ${leave.employee}</p>
                    <p style="margin: 5px 0; color: #666;">Period: ${new Date(leave.startDate).toLocaleDateString()} - ${new Date(leave.endDate).toLocaleDateString()}</p>
                    <p style="margin: 5px 0; color: #666;">Days: ${leave.days}</p>
                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="background: ${
                        leave.status === 'approved' ? '#27ae60' : leave.status === 'rejected' ? '#e74c3c' : '#f39c12'
                    }; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${leave.status.toUpperCase()}</span></p>
                    ${leave.status === 'pending' ? `
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="approveLeave('${leave.id}')">âœ… Approve</button>
                            <button class="btn btn-danger" onclick="rejectLeave('${leave.id}')">âŒ Reject</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function showApplyLeave() {
            document.getElementById('applyLeaveModal').style.display = 'block';
            populateEmployeeSelect('leaveEmployeeSelect');
            setupLeaveDateCalculations();
        }
        
        function setupLeaveDateCalculations() {
            const startDate = document.getElementById('leaveStartDate');
            const endDate = document.getElementById('leaveEndDate');
            const daysInput = document.getElementById('leaveDays');
            
            function calculateDays() {
                if (startDate.value && endDate.value) {
                    const start = new Date(startDate.value);
                    const end = new Date(endDate.value);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    daysInput.value = days;
                }
            }
            
            startDate.addEventListener('change', calculateDays);
            endDate.addEventListener('change', calculateDays);
        }
        
        function refreshLeaveList() {
            loadLeaveRequests();
        }
        
        function showLeaveReports() {
            // Generate comprehensive leave report
            if (leaveRequests.length === 0) {
                alert('No leave requests found.');
                return;
            }
            
            // Calculate summary statistics
            const totalRequests = leaveRequests.length;
            const pendingCount = leaveRequests.filter(l => l.status === 'pending').length;
            const approvedCount = leaveRequests.filter(l => l.status === 'approved').length;
            const rejectedCount = leaveRequests.filter(l => l.status === 'rejected').length;
            
            // Group by leave type
            const leaveTypeStats = {};
            leaveRequests.forEach(leave => {
                if (!leaveTypeStats[leave.type]) {
                    leaveTypeStats[leave.type] = { total: 0, days: 0, approved: 0 };
                }
                leaveTypeStats[leave.type].total++;
                leaveTypeStats[leave.type].days += parseInt(leave.days) || 0;
                if (leave.status === 'approved') {
                    leaveTypeStats[leave.type].approved++;
                }
            });
            
            // Calculate total days
            const totalDays = leaveRequests.reduce((sum, leave) => sum + (parseInt(leave.days) || 0), 0);
            const approvedDays = leaveRequests.filter(l => l.status === 'approved').reduce((sum, leave) => sum + (parseInt(leave.days) || 0), 0);
            
            // Generate report HTML
            const reportHTML = `
                <h2>ðŸ“… Leave Management Report</h2>
                <div style="margin-bottom: 20px;">
                    <h3>Summary Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #27ae60;">Total Requests</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${totalRequests}</p>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #f39c12;">Pending</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${pendingCount}</p>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #27ae60;">Approved</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${approvedCount}</p>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #e74c3c;">Rejected</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${rejectedCount}</p>
                        </div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #3498db;">Total Days</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${totalDays}</p>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #27ae60;">Approved Days</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${approvedDays}</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Leave by Type</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #c41e3a; color: white;">
                                    <th style="padding: 10px; text-align: left;">Leave Type</th>
                                    <th style="padding: 10px; text-align: center;">Total Requests</th>
                                    <th style="padding: 10px; text-align: center;">Approved</th>
                                    <th style="padding: 10px; text-align: center;">Total Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(leaveTypeStats).map(([type, stats]) => `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px;">${type}</td>
                                        <td style="padding: 10px; text-align: center;">${stats.total}</td>
                                        <td style="padding: 10px; text-align: center; color: #27ae60;">${stats.approved}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: bold;">${stats.days}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Recent Leave Requests</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #c41e3a; color: white;">
                                    <th style="padding: 10px; text-align: left;">Employee</th>
                                    <th style="padding: 10px; text-align: left;">Type</th>
                                    <th style="padding: 10px; text-align: center;">Start Date</th>
                                    <th style="padding: 10px; text-align: center;">End Date</th>
                                    <th style="padding: 10px; text-align: center;">Days</th>
                                    <th style="padding: 10px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaveRequests.slice(-20).map(leave => `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px;">${leave.employee}</td>
                                        <td style="padding: 10px;">${leave.type}</td>
                                        <td style="padding: 10px; text-align: center;">${new Date(leave.startDate).toLocaleDateString()}</td>
                                        <td style="padding: 10px; text-align: center;">${new Date(leave.endDate).toLocaleDateString()}</td>
                                        <td style="padding: 10px; text-align: center;">${leave.days}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <span style="background: ${
                                                leave.status === 'approved' ? '#27ae60' : leave.status === 'rejected' ? '#e74c3c' : '#f39c12'
                                            }; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${leave.status.toUpperCase()}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Display in a new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Leave Management Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h2 { color: #c41e3a; }
                            h3 { color: #2c3e50; margin-top: 20px; }
                            table { border-collapse: collapse; width: 100%; margin-top: 10px; }
                            th, td { padding: 10px; border: 1px solid #ddd; }
                            th { background: #c41e3a; color: white; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportHTML}
                        <div class="no-print" style="margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #c41e3a; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">ðŸ–¨ï¸ Print</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">âŒ Close</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Warnings Functions
        function loadWarnings() {
            const warningData = localStorage.getItem('hr_warnings');
            warnings = warningData ? JSON.parse(warningData) : [];
            displayWarnings();
        }
        
        function displayWarnings() {
            const listDiv = document.getElementById('warningList');
            if (!listDiv) return;
            
            if (warnings.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No warnings found.</p>';
                return;
            }
            
            listDiv.innerHTML = warnings.map(w => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #f39c12; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0; color: #f39c12;">${w.type} Warning</h4>
                    <p style="margin: 5px 0; color: #666;">Employee: ${w.employee}</p>
                    <p style="margin: 5px 0; color: #666;">Date: ${new Date(w.date).toLocaleDateString()}</p>
                    <p style="margin: 5px 0; color: #666;">Issued By: ${w.issuedBy}</p>
                    <p style="margin: 5px 0;">Reason: ${w.reason}</p>
                </div>
            `).join('');
        }
        
        function showIssueWarning() {
            document.getElementById('issueWarningModal').style.display = 'block';
            document.getElementById('warningDate').value = new Date().toISOString().split('T')[0];
            populateEmployeeSelect('warningEmployeeSelect');
        }
        
        function refreshWarningList() {
            loadWarnings();
        }
        
        // Termination Functions
        function loadTerminations() {
            const terminationData = localStorage.getItem('hr_terminations');
            terminations = terminationData ? JSON.parse(terminationData) : [];
            displayTerminations();
        }
        
        function displayTerminations() {
            const listDiv = document.getElementById('terminationList');
            if (!listDiv) return;
            
            if (terminations.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No terminations found.</p>';
                return;
            }
            
            listDiv.innerHTML = terminations.map(t => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #e74c3c; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0; color: #e74c3c;">${t.type}</h4>
                    <p style="margin: 5px 0; color: #666;">Employee: ${t.employee}</p>
                    <p style="margin: 5px 0; color: #666;">Date: ${new Date(t.date).toLocaleDateString()}</p>
                    <p style="margin: 5px 0;">Reason: ${t.reason}</p>
                </div>
            `).join('');
        }
        
        function showTerminateEmployee() {
            document.getElementById('terminateEmployeeModal').style.display = 'block';
            document.getElementById('terminationDate').value = new Date().toISOString().split('T')[0];
            populateEmployeeSelect('terminationEmployeeSelect');
        }
        
        function refreshTerminationList() {
            loadTerminations();
        }
        
        // Attendance Functions
        async function loadAttendance() {
            try {
                const r = await fetch('/api/attendance');
                if (r.ok) {
                    const list = await r.json();
                    const ui = (list||[]).map(a => ({
                        id: a.id || ('ATT' + Date.now()),
                        employee: a.fullName || a.userId || 'Unknown',
                        date: a.date,
                        status: (a.status||'').charAt(0).toUpperCase() + (a.status||'').slice(1),
                        checkIn: a.checkIn || '',
                        checkOut: a.checkOut || '',
                        notes: a.notes || ''
                    }));
                    localStorage.setItem('hr_attendance', JSON.stringify(ui));
                }
            } catch(_) {}
            const attendanceData = localStorage.getItem('hr_attendance');
            attendanceRecords = attendanceData ? JSON.parse(attendanceData) : [];
            displayAttendance();
        }
        
        function displayAttendance() {
            const listDiv = document.getElementById('attendanceList');
            if (!listDiv) return;
            
            if (attendanceRecords.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No attendance records found.</p>';
                return;
            }
            
            listDiv.innerHTML = attendanceRecords.map(a => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0;">${a.employee}</h4>
                    <p style="margin: 5px 0; color: #666;">Date: ${new Date(a.date).toLocaleDateString()}</p>
                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="background: ${
                        a.status === 'Present' ? '#27ae60' : a.status === 'Late' ? '#f39c12' : '#e74c3c'
                    }; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${a.status}</span></p>
                    ${a.checkIn ? '<p style="margin: 5px 0; color: #666;">Check In: ' + a.checkIn + '</p>' : ''}
                    ${a.checkOut ? '<p style="margin: 5px 0; color: #666;">Check Out: ' + a.checkOut + '</p>' : ''}
                </div>
            `).join('');
        }
        
        function showRecordAttendance() {
            document.getElementById('recordAttendanceModal').style.display = 'block';
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            populateEmployeeSelect('attendanceEmployeeSelect');
        }
        
        function refreshAttendanceList() {
            loadAttendance();
        }
        
        function generateAttendanceReport() {
            // Generate comprehensive attendance report
            if (attendanceRecords.length === 0) {
                alert('No attendance records found.');
                return;
            }
            
            // Calculate summary statistics
            const totalRecords = attendanceRecords.length;
            const presentCount = attendanceRecords.filter(a => a.status === 'Present').length;
            const lateCount = attendanceRecords.filter(a => a.status === 'Late').length;
            const absentCount = attendanceRecords.filter(a => a.status === 'Absent').length;
            const presentRate = ((presentCount / totalRecords) * 100).toFixed(2);
            
            // Get unique employees
            const uniqueEmployees = [...new Set(attendanceRecords.map(a => a.employee))];
            
            // Generate employee-specific stats
            const employeeStats = uniqueEmployees.map(emp => {
                const empRecords = attendanceRecords.filter(a => a.employee === emp);
                const empPresent = empRecords.filter(a => a.status === 'Present').length;
                const empLate = empRecords.filter(a => a.status === 'Late').length;
                const empAbsent = empRecords.filter(a => a.status === 'Absent').length;
                return {
                    employee: emp,
                    total: empRecords.length,
                    present: empPresent,
                    late: empLate,
                    absent: empAbsent,
                    attendanceRate: ((empPresent / empRecords.length) * 100).toFixed(2)
                };
            });
            
            // Create report HTML
            const reportHTML = `
                <h2>ðŸ“Š Attendance Report</h2>
                <div style="margin-bottom: 20px;">
                    <h3>Summary Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #27ae60;">Total Records</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${totalRecords}</p>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #27ae60;">Present</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${presentCount}</p>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #f39c12;">Late</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${lateCount}</p>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #e74c3c;">Absent</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${absentCount}</p>
                        </div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0; color: #3498db;">Attendance Rate</h4>
                            <p style="font-size: 2rem; margin: 5px 0; font-weight: bold;">${presentRate}%</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Employee Attendance Statistics</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #c41e3a; color: white;">
                                    <th style="padding: 10px; text-align: left;">Employee</th>
                                    <th style="padding: 10px; text-align: center;">Total Days</th>
                                    <th style="padding: 10px; text-align: center;">Present</th>
                                    <th style="padding: 10px; text-align: center;">Late</th>
                                    <th style="padding: 10px; text-align: center;">Absent</th>
                                    <th style="padding: 10px; text-align: center;">Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employeeStats.map(stat => `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px;">${stat.employee}</td>
                                        <td style="padding: 10px; text-align: center;">${stat.total}</td>
                                        <td style="padding: 10px; text-align: center; color: #27ae60;">${stat.present}</td>
                                        <td style="padding: 10px; text-align: center; color: #f39c12;">${stat.late}</td>
                                        <td style="padding: 10px; text-align: center; color: #e74c3c;">${stat.absent}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: bold;">${stat.attendanceRate}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Display in a new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Attendance Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h2 { color: #c41e3a; }
                            h3 { color: #2c3e50; margin-top: 20px; }
                            table { border-collapse: collapse; width: 100%; margin-top: 10px; }
                            th, td { padding: 10px; border: 1px solid #ddd; }
                            th { background: #c41e3a; color: white; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportHTML}
                        <div class="no-print" style="margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #c41e3a; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">ðŸ–¨ï¸ Print</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">âŒ Close</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Performance Review Functions
        function loadPerformanceReviews() {
            const perfData = localStorage.getItem('hr_performance');
            performanceReviews = perfData ? JSON.parse(perfData) : [];
            displayPerformanceReviews();
        }
        
        function displayPerformanceReviews() {
            const listDiv = document.getElementById('performanceList');
            if (!listDiv) return;
            
            if (performanceReviews.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No performance reviews found.</p>';
                return;
            }
            
            listDiv.innerHTML = performanceReviews.map(p => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0;">${p.employee}</h4>
                    <p style="margin: 5px 0; color: #666;">Period: ${new Date(p.startDate).toLocaleDateString()} - ${new Date(p.endDate).toLocaleDateString()}</p>
                    <p style="margin: 5px 0;"><strong>Rating:</strong> <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${p.rating}</span></p>
                    <p style="margin: 5px 0; color: #666;">Reviewed By: ${p.reviewedBy}</p>
                </div>
            `).join('');
        }
        
        function showAddPerformanceReview() {
            document.getElementById('addPerformanceReviewModal').style.display = 'block';
            populateEmployeeSelect('performanceEmployeeSelect');
        }
        
        function refreshPerformanceList() {
            loadPerformanceReviews();
        }
        
        // Helper function to populate employee select dropdowns
        function populateEmployeeSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Employee</option>';
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.employeeId;
                option.textContent = emp.name + ' (' + emp.employeeId + ')';
                select.appendChild(option);
            });
        }
        
        // Form Submission Handlers
        document.addEventListener('submit', function(e) {
            if (e.target.id === 'addEmployeeForm') {
                e.preventDefault();
                const formData = {
                    employeeId: document.getElementById('employeeId').value,
                    name: document.getElementById('employeeName').value,
                    department: document.getElementById('employeeDepartment').value,
                    position: document.getElementById('employeePosition').value,
                    email: document.getElementById('employeeEmail').value,
                    phone: document.getElementById('employeePhone').value,
                    hireDate: document.getElementById('employeeHireDate').value,
                    employmentType: document.getElementById('employmentType').value,
                    salary: document.getElementById('employeeSalary').value,
                    address: document.getElementById('employeeAddress').value,
                    dob: document.getElementById('employeeDOB').value,
                    emergencyContactName: document.getElementById('emergencyContactName').value,
                    emergencyContactPhone: document.getElementById('emergencyContactPhone').value,
                    notes: document.getElementById('employeeNotes').value
                };
                
                // Ensure employees array exists
                if (!employees || !Array.isArray(employees)) {
                    employees = [];
                }
                
                const existingIndex = employees.findIndex(e => e.employeeId === formData.employeeId);
                if (existingIndex >= 0) {
                    employees[existingIndex] = formData;
                    console.log(`âœ… Updated employee: ${formData.name} (${formData.employeeId})`);
                } else {
                    employees.push(formData);
                    console.log(`âœ… Added new employee: ${formData.name} (${formData.employeeId})`);
                }
                
                // Save to localStorage immediately (both hr_employees and dyna_employees for consistency)
                try {
                    localStorage.setItem('hr_employees', JSON.stringify(employees));
                    localStorage.setItem('dyna_employees', JSON.stringify(employees));
                    console.log(`âœ… Saved ${employees.length} employees to localStorage (both hr_employees and dyna_employees)`);
                    
                    // Verify save was successful
                    const verifyHR = localStorage.getItem('hr_employees');
                    const verifyDyna = localStorage.getItem('dyna_employees');
                    if (!verifyHR || !verifyDyna) {
                        console.error('âŒ Save verification failed - localStorage save incomplete!');
                        alert('âš ï¸ Warning: Employee may not have been saved properly. Please try again.');
                        return;
                    }
                    
                    // Set a flag to prevent cloud-sync from overwriting for the next few seconds
                    if (typeof window !== 'undefined') {
                        window._employeeJustSaved = Date.now();
                        console.log('ðŸ›¡ï¸ Set protection flag against cloud-sync overwrite');
                    }
                    
                    closeModal('addEmployeeModal');
                    displayEmployees();
                    alert(`âœ… Employee saved successfully! Total employees: ${employees.length}`);
                } catch (error) {
                    console.error('âŒ Error saving employee to localStorage:', error);
                    alert('âŒ Error saving employee: ' + error.message);
                }
                // Try to save to cloud via serverless API
                (async () => {
                    try {
                        const payload = {
                            fullName: formData.name,
                            userId: formData.employeeId || ('STAFF-' + Date.now()),
                            role: formData.position || 'staff',
                            branch: (currentUser && currentUser.branch) || 'townshop',
                            email: formData.email || '',
                            phone: formData.phone || '',
                            hireDate: formData.hireDate || new Date().toISOString().split('T')[0],
                            employmentStatus: 'active'
                        };
                        await fetch('/api/employees', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-user-role': 'hr_manager' },
                            body: JSON.stringify(payload)
                        });
                    } catch(_) { /* ignore */ }
                })();
            }
            
            if (e.target.id === 'applyLeaveForm') {
                e.preventDefault();
                const formData = {
                    id: 'LEAVE' + Date.now(),
                    employee: employees.find(e => e.employeeId === document.getElementById('leaveEmployeeSelect').value)?.name || '',
                    type: document.getElementById('leaveType').value,
                    startDate: document.getElementById('leaveStartDate').value,
                    endDate: document.getElementById('leaveEndDate').value,
                    days: document.getElementById('leaveDays').value,
                    reason: document.getElementById('leaveReason').value,
                    status: 'pending',
                    appliedDate: new Date().toISOString()
                };
                
                leaveRequests.push(formData);
                localStorage.setItem('hr_leave', JSON.stringify(leaveRequests));
                closeModal('applyLeaveModal');
                displayLeaveRequests();
                alert('Leave request submitted!');
                // Mirror to cloud API
                (async () => {
                    try {
                        const empId = document.getElementById('leaveEmployeeSelect').value;
                        const emp = employees.find(e => e.employeeId === empId);
                        const payload = {
                            userId: empId || ('STAFF-' + Date.now()),
                            fullName: emp?.name || formData.employee,
                            branch: (currentUser && currentUser.branch) || 'townshop',
                            type: formData.type,
                            startDate: formData.startDate,
                            endDate: formData.endDate,
                            halfDay: false,
                            reason: formData.reason
                        };
                        await fetch('/api/leave', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-user-role':'hr_manager' }, body: JSON.stringify(payload) });
                    } catch(_){}
                })();
            }
            
            if (e.target.id === 'issueWarningForm') {
                e.preventDefault();
                const formData = {
                    id: 'WARN' + Date.now(),
                    employee: employees.find(e => e.employeeId === document.getElementById('warningEmployeeSelect').value)?.name || '',
                    type: document.getElementById('warningType').value,
                    date: document.getElementById('warningDate').value,
                    issuedBy: document.getElementById('warningIssuedBy').value,
                    reason: document.getElementById('warningReason').value,
                    notes: document.getElementById('warningNotes').value
                };
                
                warnings.push(formData);
                localStorage.setItem('hr_warnings', JSON.stringify(warnings));
                closeModal('issueWarningModal');
                displayWarnings();
                alert('Warning issued!');
            }
            
            if (e.target.id === 'terminateEmployeeForm') {
                e.preventDefault();
                const formData = {
                    id: 'TERM' + Date.now(),
                    employee: employees.find(e => e.employeeId === document.getElementById('terminationEmployeeSelect').value)?.name || '',
                    type: document.getElementById('terminationType').value,
                    date: document.getElementById('terminationDate').value,
                    reason: document.getElementById('terminationReason').value,
                    noticePeriod: document.getElementById('noticePeriod').value,
                    notes: document.getElementById('terminationNotes').value
                };
                
                terminations.push(formData);
                localStorage.setItem('hr_terminations', JSON.stringify(terminations));
                closeModal('terminateEmployeeModal');
                displayTerminations();
                alert('Termination recorded!');
            }
            
            if (e.target.id === 'recordAttendanceForm') {
                e.preventDefault();
                const formData = {
                    id: 'ATT' + Date.now(),
                    employee: employees.find(e => e.employeeId === document.getElementById('attendanceEmployeeSelect').value)?.name || '',
                    date: document.getElementById('attendanceDate').value,
                    status: document.getElementById('attendanceStatus').value,
                    checkIn: document.getElementById('checkInTime').value,
                    checkOut: document.getElementById('checkOutTime').value,
                    notes: document.getElementById('attendanceNotes').value
                };
                
                attendanceRecords.push(formData);
                localStorage.setItem('hr_attendance', JSON.stringify(attendanceRecords));
                closeModal('recordAttendanceModal');
                displayAttendance();
                alert('Attendance recorded!');
                // Mirror to cloud API
                (async () => {
                    try {
                        const empId = document.getElementById('attendanceEmployeeSelect').value;
                        const emp = employees.find(e => e.employeeId === empId);
                        const payload = {
                            userId: empId || ('STAFF-' + Date.now()),
                            fullName: emp?.name || formData.employee,
                            branch: (currentUser && currentUser.branch) || 'townshop',
                            date: formData.date,
                            status: (formData.status||'').toLowerCase(),
                            checkIn: formData.checkIn || null,
                            checkOut: formData.checkOut || null,
                            notes: formData.notes || ''
                        };
                        await fetch('/api/attendance', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-user-role':'hr_manager' }, body: JSON.stringify(payload) });
                    } catch(_){}
                })();
            }
            
            if (e.target.id === 'addPerformanceReviewForm') {
                e.preventDefault();
                const formData = {
                    id: 'PERF' + Date.now(),
                    employee: employees.find(e => e.employeeId === document.getElementById('performanceEmployeeSelect').value)?.name || '',
                    startDate: document.getElementById('reviewStartDate').value,
                    endDate: document.getElementById('reviewEndDate').value,
                    reviewedBy: document.getElementById('reviewedBy').value,
                    rating: document.getElementById('overallRating').value,
                    strengths: document.getElementById('strengths').value,
                    improvements: document.getElementById('improvements').value,
                    goals: document.getElementById('goals').value,
                    comments: document.getElementById('reviewComments').value
                };
                
                performanceReviews.push(formData);
                localStorage.setItem('hr_performance', JSON.stringify(performanceReviews));
                closeModal('addPerformanceReviewModal');
                displayPerformanceReviews();
                alert('Performance review saved!');
            }
        });
        
        // Search handlers
        document.addEventListener('keyup', function(e) {
            if (e.target.id === 'employeeSearch') {
                displayEmployees();
            }
        });
        
        // Initialize HR portal data on load
        function initHRPortal() {
            loadEmployees();
            loadLeaveRequests();
            loadWarnings();
            loadTerminations();
            loadAttendance();
            loadPerformanceReviews();
        }
        
        // ==========================
        // Global population helpers
        // ==========================
        function populateBranchDropdowns() {
            try {
                const branchSelectIds = [
                    'branchSelect',
                    'distributionBranch',
                    'requestBranch',
                    'financeBranchSelect',
                    'misBranchSelect'
                ];
                branchSelectIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const isAllSupported = (id === 'financeBranchSelect' || id === 'misBranchSelect');
                    el.innerHTML = isAllSupported ? '<option value="all">All Branches</option>' : '<option value="">Select Branch</option>';
                    (branches || []).forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b.id || b.name || '';
                        opt.textContent = b.name || b.id;
                        el.appendChild(opt);
                    });
                });
            } catch (e) { console.warn('populateBranchDropdowns error', e); }
        }

        function populateProductDropdowns() {
            try {
                const productSelectIds = [
                    'windhoekProduct',
                    'ondangwaProduct',
                    'distributionProduct'
                ];
                const allSelects = [
                    ...productSelectIds.map(id => document.getElementById(id)).filter(Boolean),
                    ...Array.from(document.querySelectorAll('.request-product-select'))
                ];
                
                // Load actual stock to populate dropdowns
                loadStockData();
                
                // Get unique product names from all stock sources
                const allStockProducts = new Set();
                
                // From country stock
                (countryStock || []).forEach(item => {
                    if (item.productName) allStockProducts.add(item.productName);
                });
                
                // From barcode stock
                const barcodeStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                barcodeStock.forEach(batch => {
                    if (batch.description && batch.location === 'country_stock' && batch.status === 'available') {
                        allStockProducts.add(batch.description);
                    }
                });
                
                // Combine with PRICE_LIST for full coverage
                const productsToShow = Array.from(allStockProducts).length > 0 
                    ? Array.from(allStockProducts).sort()
                    : PRICE_LIST.map(p => p.description);
                
                allSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Product</option>';
                    productsToShow.forEach(productName => {
                        const opt = document.createElement('option');
                        opt.value = productName;
                        opt.textContent = productName;
                        // Try to get price data
                        const priceData = PRICE_LIST.find(p => p.description === productName);
                        if (priceData) {
                            opt.setAttribute('data-dp', priceData.dp);
                            opt.setAttribute('data-cp', priceData.cp);
                            opt.setAttribute('data-bv', priceData.bv);
                        }
                        select.appendChild(opt);
                    });
                });
            } catch (e) { console.warn('populateProductDropdowns error', e); }
        }

        function updatePriceBadges() {
            try {
                // Walk-in POS product cards
                if (typeof displayWalkInProducts === 'function') {
                    // Trigger refresh using current filtered list if any
                    displayWalkInProducts(PRICE_LIST);
                }
                // Any DP/CP/BV chips in DOM can be updated here if needed later
            } catch (e) { console.warn('updatePriceBadges error', e); }
        }

        // Finance - Cash Requests approval list
        function displayFinanceCashRequests() {
            try {
                const container = document.getElementById('financeCashRequests');
                if (!container) return;
                const list = JSON.parse(localStorage.getItem('finance_cash_requests') || '[]');
                if (list.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No cash requests yet.</p>';
                    return;
                }
                container.innerHTML = list.slice().reverse().map(r => `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${r.status === 'approved' ? '#27ae60' : r.status === 'rejected' ? '#e74c3c' : '#3498db'};">
                        <div style="display:flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${r.employee}</strong>
                                <div style="color:#999; font-size: 0.85rem;">${new Date(r.createdAt).toLocaleString()}</div>
                            </div>
                            <div>
                                <span style="background:${r.status === 'approved' ? '#27ae60' : r.status === 'rejected' ? '#e74c3c' : '#3498db'}; color:white; padding:2px 8px; border-radius: 12px; font-size:0.8rem;">${r.status.toUpperCase()}</span>
                            </div>
                        </div>
                        <div style="margin-top:8px; color:#555;">Purpose: ${r.purpose}</div>
                        <div style="margin-top:4px; color:#2c3e50; font-weight:600;">Amount: N$ ${Number(r.amount).toFixed(2)}</div>
                        ${r.status === 'pending' ? `
                        <div style="margin-top: 10px; display:flex; gap:10px;">
                            <button class="btn btn-success" onclick="approveCashRequest('${r.id}')">âœ… Approve</button>
                            <button class="btn btn-danger" onclick="rejectCashRequest('${r.id}')">âŒ Reject</button>
                        </div>` : ''}
                    </div>
                `).join('');
            } catch (e) { console.warn('displayFinanceCashRequests error', e); }
        }

        function approveCashRequest(id) {
            try {
                const key = 'finance_cash_requests';
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const i = list.findIndex(r => r.id === id);
                if (i === -1) return;
                list[i].status = 'approved';
                list[i].approvedBy = currentUser?.fullName || 'Finance';
                list[i].approvedAt = new Date().toISOString();
                localStorage.setItem(key, JSON.stringify(list));
                displayFinanceCashRequests();
                recordDepartmentEvent && recordDepartmentEvent('cash_approved', list[i]);
            } catch (e) { console.warn('approveCashRequest error', e); }
        }

        function rejectCashRequest(id) {
            try {
                const key = 'finance_cash_requests';
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const i = list.findIndex(r => r.id === id);
                if (i === -1) return;
                list[i].status = 'rejected';
                list[i].rejectedBy = currentUser?.fullName || 'Finance';
                list[i].rejectedAt = new Date().toISOString();
                localStorage.setItem(key, JSON.stringify(list));
                displayFinanceCashRequests();
                recordDepartmentEvent && recordDepartmentEvent('cash_rejected', list[i]);
            } catch (e) { console.warn('rejectCashRequest error', e); }
        }
        
        // Populate product dropdown for an import row
        function populateImportRowProductDropdown(rowEl) {
            try {
                const select = rowEl.querySelector('.stock-description');
                if (!select) return;
                select.innerHTML = '<option value="">Select Product</option>';
                (PRICE_LIST || []).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.description;
                    opt.textContent = p.description;
                    opt.setAttribute('data-dp', p.dp);
                    opt.setAttribute('data-cp', p.cp);
                    opt.setAttribute('data-bv', p.bv);
                    select.appendChild(opt);
                });
            } catch (e) { console.warn('populateImportRowProductDropdown error', e); }
        }

        async function seedIfEmpty() {
            try {
                // Seed branches in localStorage if missing
                const storedBranches = localStorage.getItem('dyna_branches_seeded');
                if (!storedBranches) {
                    if (Array.isArray(branches) && branches.length > 0) {
                        localStorage.setItem('dyna_branches', JSON.stringify(branches));
                        localStorage.setItem('dyna_branches_seeded', '1');
                    }
                }
                // Seed products
                const storedProducts = localStorage.getItem('dyna_products_seeded');
                if (!storedProducts) {
                    const seeded = (PRICE_LIST || []).map((p, i) => ({
                        id: 'PRDSEED' + i,
                        sku: p.description.toUpperCase().replace(/\s+/g, '-'),
                        name: p.description,
                        description: p.description,
                        category: 'General',
                        unit: 'Unit',
                        dp: p.dp,
                        cp: p.cp,
                        bv: p.bv,
                        isActive: true
                    }));
                    localStorage.setItem('dyna_products', JSON.stringify(seeded));
                    localStorage.setItem('dyna_price_history', JSON.stringify([]));
                    localStorage.setItem('dyna_products_seeded', '1');
                }
            } catch (e) { console.warn('seedIfEmpty error', e); }
        }
        
        // Initialize stock data on load
        window.onload = async function() {
            // Load stock data
            loadStockData();
            
            // Load distributors first
            await loadDistributors();
            // Initialize default distributors if none exist
            await initializeDefaultDistributors();
            distributorsLoaded = true;
            console.log('Distributors loaded and ready for use!');
            
            // Then load reports and initialize
            await loadReportsFromFile();
            await init();
            
            // Seed and populate global dropdowns
            await seedIfEmpty();
            populateBranchDropdowns();
            populateProductDropdowns();
            // Populate initial import row product dropdown
            try {
                const firstRow = document.querySelector('#stockImportTableBody tr');
                if (firstRow) populateImportRowProductDropdown(firstRow);
            } catch (e) { console.warn('initial import row populate error', e); }
            updatePriceBadges();
            
            // Initialize HR Portal
            initHRPortal();

            // Initialize Product Photo Management
            try { populatePhotoProductSelect(); loadProductPhotos(); } catch (e) { console.warn('photo init error', e); }
            
            // Ensure shop products show immediately on first load
            try { if (typeof loadShopProducts === 'function') loadShopProducts(); } catch (e) { console.warn('shop init error', e); }
        };
        
        // ==========================
        // Distributor Portal Functions
        // ==========================
        let shopCart = [];
        let shopCustomerTypeSelected = false; // Track if customer type has been explicitly selected
        let previousCustomerType = ''; // Store previous customer type selection
        let onlineOrders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
        
        function showDistributorTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.distributor-subtab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            const tabElement = document.getElementById(`distributor-${tabName}-tab`);
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // Add active class to button
            if (event && event.target) {
            event.target.classList.add('active');
            }
            
            // Load content based on tab
            if (tabName === 'shop') {
                if (typeof loadShopProducts === 'function') {
                loadShopProducts();
                }
                // Load media preview widget on shop tab
                setTimeout(() => {
                    if (typeof loadMediaPreviewWidget === 'function') {
                        loadMediaPreviewWidget();
                    }
                }, 100);
            } else if (tabName === 'media') {
                loadMediaNews();
            } else if (tabName === 'testimonials') {
                loadTestimonials();
            }
            
            // Show add news button for admins
            const showAddNewsBtn = document.getElementById('showAddNewsBtn');
            if (showAddNewsBtn) {
                const currentUser = window.currentUser || JSON.parse(localStorage.getItem('currentUser') || 'null');
                showAddNewsBtn.style.display = (currentUser && currentUser.role === 'admin') ? 'inline-block' : 'none';
            }
        }
        
        // Load Media & News
        function loadMediaNews() {
            const contentDiv = document.getElementById('mediaNewsContent');
            if (!contentDiv) return;
            
            try {
                const newsItems = JSON.parse(localStorage.getItem('dyna_media_news') || '[]');
                
                // If empty, load default news items
                if (newsItems.length === 0) {
                    const defaultNews = [
                        {
                            id: 'NEWS001',
                            title: 'Welcome to Dynapharm Namibia',
                            category: 'company',
                            content: 'Dynapharm International brings world-class health and wellness products to Namibia. Our mission is to promote natural health solutions for better living.',
                            imageUrl: '',
                            date: new Date().toISOString().split('T')[0],
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'NEWS002',
                            title: 'Health Benefits of Natural Supplements',
                            category: 'health',
                            content: 'Natural supplements can help support your immune system, improve energy levels, and promote overall wellness. Consult with our health consultants for personalized recommendations.',
                            imageUrl: '',
                            date: new Date().toISOString().split('T')[0],
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'NEWS003',
                            title: 'New Product Launch - Power Coffee',
                            category: 'product',
                            content: 'Experience the benefits of our new Power Coffee - not just coffee, it\'s Power Coffee! Packed with natural ingredients to boost your energy and wellness.',
                            imageUrl: '',
                            date: new Date().toISOString().split('T')[0],
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('dyna_media_news', JSON.stringify(defaultNews));
                    displayMediaNews(defaultNews);
                } else {
                    displayMediaNews(newsItems);
                }
            } catch (error) {
                console.error('Error loading media news:', error);
                contentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Error loading news. Please try again later.</p>';
            }
        }
        
        function displayMediaNews(newsItems) {
            const contentDiv = document.getElementById('mediaNewsContent');
            if (!contentDiv) return;
            
            if (newsItems.length === 0) {
                contentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">No news items available. Check back soon for updates!</p>';
                return;
            }
            
            const categoryIcons = {
                health: 'ðŸ¥',
                product: 'ðŸ“¦',
                company: 'ðŸ¢',
                event: 'ðŸŽ‰',
                promotion: 'ðŸŽ'
            };
            
            const categoryColors = {
                health: '#3498db',
                product: '#2ecc71',
                company: '#c41e3a',
                event: '#f39c12',
                promotion: '#e74c3c'
            };
            
            contentDiv.innerHTML = newsItems.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt)).map(item => {
                const categoryIcon = categoryIcons[item.category] || 'ðŸ“°';
                const categoryColor = categoryColors[item.category] || '#666';
                const date = new Date(item.date || item.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                return `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                        ${item.imageUrl ? `
                            <img src="${item.imageUrl}" alt="${item.title}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;">
                        ` : ''}
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem;">${categoryIcon}</span>
                            <span style="background: ${categoryColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">
                                ${item.category || 'news'}
                            </span>
                            <span style="color: #666; font-size: 0.85rem; margin-left: auto;">${date}</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.2rem;">${item.title}</h3>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">${item.content}</p>
                    </div>
                `;
            }).join('');
        }
        
        // Load Media Preview Widget for Shop Tab
        function loadMediaPreviewWidget() {
            const previewContent = document.getElementById('mediaPreviewContent');
            if (!previewContent) return;
            
            try {
                // Load media/news items from localStorage
                const newsItems = JSON.parse(localStorage.getItem('dyna_media_news') || '[]');
                
                // Also check for front desk uploaded media (videos/slideshows)
                const frontDeskMedia = JSON.parse(localStorage.getItem('dyna_frontdesk_media') || '[]');
                
                // Combine both sources and get items with images/videos
                const allMedia = [...newsItems, ...frontDeskMedia]
                    .filter(item => item.imageUrl || item.videoUrl || item.slideshow)
                    .sort((a, b) => new Date(b.date || b.createdAt || 0) - new Date(a.date || a.createdAt || 0))
                    .slice(0, 6); // Show up to 6 items
                
                if (allMedia.length === 0) {
                    previewContent.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; opacity: 0.8;">
                            <p style="margin: 0; font-size: 14px;">ðŸ“º No media available yet</p>
                            <p style="margin: 5px 0 0; font-size: 12px; opacity: 0.7;">Check back soon for updates!</p>
                        </div>
                    `;
                    return;
                }
                
                previewContent.innerHTML = allMedia.map(item => {
                    const hasVideo = item.videoUrl || (item.type === 'video');
                    const hasSlideshow = item.slideshow || (item.type === 'slideshow');
                    const mediaType = hasVideo ? 'video' : (hasSlideshow ? 'slideshow' : 'image');
                    const icon = mediaType === 'video' ? 'â–¶' : mediaType === 'slideshow' ? 'ðŸ“·' : 'ðŸ–¼';
                    const thumbnail = item.imageUrl || item.thumbnail || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect width=%22120%22 height=%22120%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22%3E' + encodeURIComponent(icon) + '%3C/text%3E%3C/svg%3E';
                    const title = (item.title || 'Media').replace(/"/g, '&quot;');
                    const shortTitle = title.length > 20 ? title.substring(0, 20) + '...' : title;
                    
                    return '<div style="position: relative; border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'">' +
                        '<div style="position: relative; width: 100%; padding-top: 75%; background: rgba(0,0,0,0.3);">' +
                        '<img src="' + thumbnail + '" alt="' + title + '" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect width=%22120%22 height=%22120%22 fill=%22%23ddd%22/%3E%3C/svg%3E\'">' +
                        (hasVideo ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 16px;">â–¶</div>' : '') +
                        (hasSlideshow ? '<div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">ðŸ“·</div>' : '') +
                        '</div>' +
                        (item.title ? '<div style="padding: 8px; background: rgba(0,0,0,0.5); color: white; font-size: 11px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" title="' + title + '">' + shortTitle + '</div>' : '') +
                        '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading media preview:', error);
                previewContent.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px; opacity: 0.8;">
                        <p style="margin: 0; font-size: 14px;">Error loading media</p>
                    </div>
                `;
            }
        }
        
        // Function to open media tab from widget click
        function openMediaTab() {
            const mediaBtn = document.querySelector('.tabs button[onclick*="showDistributorTab"]');
            if (mediaBtn && mediaBtn.textContent.includes('Media')) {
                mediaBtn.click();
            } else {
                // Fallback: find button by onclick attribute
                const buttons = document.querySelectorAll('.tabs button');
                for (let btn of buttons) {
                    const onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes('media')) {
                        btn.click();
                        break;
                    }
                }
            }
        }
        
        // Make functions globally accessible
        if (typeof window !== 'undefined') {
            window.loadMediaPreviewWidget = loadMediaPreviewWidget;
            window.openMediaTab = openMediaTab;
        }
        
        function addNewsItem(event) {
            event.preventDefault();
            
            const title = document.getElementById('newsTitle').value;
            const category = document.getElementById('newsCategory').value;
            const content = document.getElementById('newsContent').value;
            const imageUrl = document.getElementById('newsImageUrl').value;
            const date = document.getElementById('newsDate').value || new Date().toISOString().split('T')[0];
            
            const newsItem = {
                id: 'NEWS' + Date.now(),
                title,
                category,
                content,
                imageUrl,
                date,
                createdAt: new Date().toISOString()
            };
            
            try {
                const existingNews = JSON.parse(localStorage.getItem('dyna_media_news') || '[]');
                existingNews.push(newsItem);
                localStorage.setItem('dyna_media_news', JSON.stringify(existingNews));
                
                // Clear form
                document.getElementById('newsTitle').value = '';
                document.getElementById('newsContent').value = '';
                document.getElementById('newsImageUrl').value = '';
                document.getElementById('newsDate').value = '';
                
                // Hide form
                document.getElementById('addNewsForm').style.display = 'none';
                
                // Reload news
                loadMediaNews();
                
                alert('News item published successfully!');
            } catch (error) {
                console.error('Error adding news item:', error);
                alert('Error publishing news item. Please try again.');
            }
        }
        
        // Load Testimonials
        function loadTestimonials() {
            const contentDiv = document.getElementById('testimonialsContent');
            if (!contentDiv) return;
            
            try {
                let testimonials = JSON.parse(localStorage.getItem('dyna_testimonials') || '[]');
                
                // If empty, load default testimonials (similar to dynapharm.net/ph/)
                if (testimonials.length === 0) {
                    const defaultTestimonials = [
                        {
                            id: 'TEST001',
                            name: 'Sarah M.',
                            location: 'Windhoek, Namibia',
                            text: 'Two years ago, I was dyingâ€¦ today, I am healthy and 6 months pregnant! Dynapharm products have truly transformed my life. I am so grateful for the natural solutions they provide.',
                            date: new Date().toISOString(),
                            approved: true
                        },
                        {
                            id: 'TEST002',
                            name: 'Maria K.',
                            location: 'Ondangwa, Namibia',
                            text: 'I had cancer of the ovaries stage 3â€¦ I have an option to treat it by taking Dynapharm productsâ€¦ The natural approach combined with my medical treatment has been life-changing. I feel stronger and more hopeful every day.',
                            date: new Date().toISOString(),
                            approved: true
                        },
                        {
                            id: 'TEST003',
                            name: 'John D.',
                            location: 'Swakopmund, Namibia',
                            text: 'My arthritic pain was unbearableâ€¦ After using Dynapharm\'s natural relief products for just a few weeks, I noticed a significant improvement. I can now move freely without constant pain.',
                            date: new Date().toISOString(),
                            approved: true
                        },
                        {
                            id: 'TEST004',
                            name: 'Anna T.',
                            location: 'Rundu, Namibia',
                            text: 'I WAS A WALKING MEDICINE BOX, UNTIL DYNAPHARM. Now I take natural supplements and feel better than I have in years. The products are effective and I trust them completely.',
                            date: new Date().toISOString(),
                            approved: true
                        },
                        {
                            id: 'TEST005',
                            name: 'Grace L.',
                            location: 'Katima Mulilo, Namibia',
                            text: 'I HAD BREAST CANCER â€¦NOW I AM HEALED! Dynapharm products have been an essential part of my healing journey. The support and quality products have given me hope and strength.',
                            date: new Date().toISOString(),
                            approved: true
                        }
                    ];
                    localStorage.setItem('dyna_testimonials', JSON.stringify(defaultTestimonials));
                    displayTestimonials(defaultTestimonials);
                } else {
                    // Filter to show only approved testimonials
                    const approved = testimonials.filter(t => t.approved !== false);
                    displayTestimonials(approved);
                }
            } catch (error) {
                console.error('Error loading testimonials:', error);
                contentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">Error loading testimonials. Please try again later.</p>';
            }
        }
        
        function displayTestimonials(testimonials) {
            const contentDiv = document.getElementById('testimonialsContent');
            if (!contentDiv) return;
            
            if (testimonials.length === 0) {
                contentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">No testimonials yet. Be the first to share your story!</p>';
                return;
            }
            
            contentDiv.innerHTML = testimonials.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt)).map(testimonial => {
                const date = new Date(testimonial.date || testimonial.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                return `
                    <div style="background: white; border: 2px solid #c41e3a; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(196, 30, 58, 0.15); position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; font-size: 2rem; opacity: 0.2;">ðŸ’¬</div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #c41e3a, #8b0000); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">
                                    ${testimonial.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50; font-size: 1.1rem;">${testimonial.name}</h4>
                                    <p style="margin: 0; color: #666; font-size: 0.85rem;">${testimonial.location || 'Namibia'}</p>
                                </div>
                            </div>
                        </div>
                        <p style="color: #333; line-height: 1.8; font-style: italic; margin-bottom: 15px; position: relative; z-index: 1;">
                            "${testimonial.text}"
                        </p>
                        <div style="display: flex; align-items: center; gap: 5px; color: #c41e3a; font-size: 0.9rem;">
                            â­â­â­â­â­
                            <span style="margin-left: auto; color: #666; font-size: 0.8rem;">${date}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function submitTestimonial(event) {
            event.preventDefault();
            
            const name = document.getElementById('testimonialName').value.trim();
            const location = document.getElementById('testimonialLocation').value.trim();
            const text = document.getElementById('testimonialText').value.trim();
            
            if (!text) {
                alert('Please enter your testimonial.');
                return;
            }
            
            const testimonial = {
                id: 'TEST' + Date.now(),
                name: name || 'Anonymous',
                location: location || 'Namibia',
                text,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                approved: false // Requires admin approval
            };
            
            try {
                const existingTestimonials = JSON.parse(localStorage.getItem('dyna_testimonials') || '[]');
                existingTestimonials.push(testimonial);
                localStorage.setItem('dyna_testimonials', JSON.stringify(existingTestimonials));
                
                // Clear form
                document.getElementById('testimonialName').value = '';
                document.getElementById('testimonialLocation').value = '';
                document.getElementById('testimonialText').value = '';
                
                alert('Thank you for sharing your story! Your testimonial has been submitted and will be reviewed before publishing.');
                
                // Reload testimonials
                loadTestimonials();
            } catch (error) {
                console.error('Error submitting testimonial:', error);
                alert('Error submitting testimonial. Please try again.');
            }
        }
        
        function initializeProductCarousels() {
            // Use setTimeout to ensure DOM is fully updated
            setTimeout(() => {
                const containers = document.querySelectorAll('.product-carousel-container');
                if (!containers || containers.length === 0) return;
                
                containers.forEach(container => {
                    // Skip if already initialized
                    if (container.dataset.initialized === 'true') return;
                    
                    const photoCount = parseInt(container.getAttribute('data-photo-count') || '1');
                    if (photoCount <= 1) {
                        // Even if only one photo, mark as initialized to avoid re-processing
                        container.dataset.initialized = 'true';
                        return;
                    }
                    
                    container.dataset.initialized = 'true';
                
                let currentIndex = 0;
                const images = container.querySelectorAll('img');
                const dots = container.querySelectorAll('.carousel-dot');
                    let autoRotateInterval;
                    
                    function showImage(index) {
                        images.forEach((img, idx) => {
                            img.style.opacity = idx === index ? '1' : '0';
                            img.style.position = idx === index ? 'relative' : 'absolute';
                            img.style.zIndex = idx === index ? '1' : '0';
                        });
                        dots.forEach((dot, idx) => {
                            dot.style.background = idx === index ? '#fff' : 'rgba(255,255,255,0.5)';
                        });
                        currentIndex = index;
                    }
                    
                    function nextImage() {
                        currentIndex = (currentIndex + 1) % photoCount;
                        showImage(currentIndex);
                    }
                    
                    function startAutoRotate() {
                        autoRotateInterval = setInterval(nextImage, 3000); // Change every 3 seconds
                    }
                    
                    function stopAutoRotate() {
                        if (autoRotateInterval) {
                            clearInterval(autoRotateInterval);
                        }
                    }
                    
                    let isPaused = false;
                    container.addEventListener('click', function(e) {
                    // Click on dot navigates to specific image
                    if (e.target.classList.contains('carousel-dot')) {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        showImage(index);
                        stopAutoRotate();
                        isPaused = true;
                        setTimeout(() => {
                            if (!isPaused) startAutoRotate();
                        }, 5000);
                    } else {
                        // Click anywhere else on carousel advances to next image
                        nextImage();
                        stopAutoRotate();
                        isPaused = true;
                        setTimeout(() => {
                            isPaused = false;
                            startAutoRotate();
                        }, 10000);
                    }
                });
                
                // Start auto-rotation
                startAutoRotate();
                
                // Pause on hover
                container.addEventListener('mouseenter', stopAutoRotate);
                container.addEventListener('mouseleave', function() {
                    if (!isPaused) startAutoRotate();
                });
                }); // Close forEach
            }, 50); // Close setTimeout (small delay to ensure DOM is ready)
        }
        
        // Product name mapping to dynapharm.net/ph format
        // Maps internal product names to website display names
        const PRODUCT_NAME_MAPPING = {
            // Bee Pollen products
            "BEE POLEN CAPSULE (30's)": "Bee Pollen Capsule",
            "BEE POLLEN CAPSULE (100's)": "Bee Pollen Capsule",
            
            // Gin Ali products
            "GINALI CAPSULE 100's": "Gin Ali Capsule",
            "GINALI CAPSULE 30's": "Gin Ali Capsule",
            
            // Soybean products
            "D.I. INSTANT SOYBEAN MIXTURE WITH GINGER 25g x 20'": "Instant Soybean Powder",
            "SOYBEAN POWDER 454g": "Instant Soybean Powder",
            
            // Yeeyangyen products
            "YEEYANGYEN TABLET 30's": "Yeeyangyen",
            "YEEYANGYEN TABLET 90's": "Yeeyangyen",
            
            // Sea Cucumber products
            "SEA CUCUMBER JELLY (250ml)": "Sea Cucumber Jelly",
            "SEA CUCUMBER JELLY (500ml)": "Sea Cucumber Jelly"
        };
        
        // Product slug mapping for specific products that don't follow standard naming
        const PRODUCT_SLUG_MAPPING = {
            "BEE POLEN CAPSULE (30's)": "bee-pollen-capsule",
            "BEE POLLEN CAPSULE (100's)": "bee-pollen-capsule",
            "GINALI CAPSULE 100's": "gin-ali-capsule",
            "GINALI CAPSULE 30's": "gin-ali-capsule",
            "D.I. INSTANT SOYBEAN MIXTURE WITH GINGER 25g x 20'": "instant-soybean-power",
            "SOYBEAN POWDER 454g": "instant-soybean-power",
            "YEEYANGYEN TABLET 30's": "yeeyangyen",
            "YEEYANGYEN TABLET 90's": "yeeyangyen",
            "SEA CUCUMBER JELLY (250ml)": "sea-cucumber-jelly",
            "SEA CUCUMBER JELLY (500ml)": "sea-cucumber-jelly"
        };
        
        // Function to convert product name to URL slug format
        function productNameToSlug(productName) {
            // First check if there's a specific slug mapping
            if (PRODUCT_SLUG_MAPPING[productName]) {
                return PRODUCT_SLUG_MAPPING[productName];
            }
            
            // Then check the name mapping
            const mappedName = PRODUCT_NAME_MAPPING[productName] || productName;
            
            // Convert to slug format (lowercase, spaces to hyphens, remove special chars)
            return mappedName
                .toLowerCase()
                .replace(/[^\w\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-')    // Replace spaces with hyphens
                .replace(/-+/g, '-')      // Replace multiple hyphens with single
                .trim();
        }
        
        // Function to get product image URL from dynapharm.net/ph
        function getProductImageUrl(productName) {
            const slug = productNameToSlug(productName);
            const baseUrl = 'https://dynapharm.net/ph';
            const productUrl = `${baseUrl}/product/${slug}/`;
            
            // Try multiple common WordPress/WooCommerce image URL patterns
            // Most sites store images in: /wp-content/uploads/YYYY/MM/filename.jpg
            // Or in a products folder: /wp-content/uploads/products/filename.jpg
            // Or use the product slug directly
            const imageUrls = [
                // Direct product image paths (most common)
                `${baseUrl}/wp-content/uploads/products/${slug}.jpg`,
                `${baseUrl}/wp-content/uploads/products/${slug}.png`,
                `${baseUrl}/wp-content/uploads/${slug}.jpg`,
                `${baseUrl}/wp-content/uploads/${slug}.png`,
                // WooCommerce product image path
                `${baseUrl}/wp-content/uploads/wc-product-images/${slug}.jpg`,
                // Try with different extensions
                `${baseUrl}/wp-content/uploads/products/${slug}-1.jpg`,
                `${baseUrl}/wp-content/uploads/products/${slug}-300x300.jpg`
            ];
            
            return {
                productUrl: productUrl,
                imageUrls: imageUrls,
                slug: slug
            };
        }
        
        // Function to fetch product image from dynapharm.net/ph
        async function fetchProductImageFromWebsite(productName) {
            try {
                const { slug, productUrl } = getProductImageUrl(productName);
                
                // Try to fetch the product page and extract image
                try {
                    // Use a proxy or CORS-enabled fetch if available
                    const response = await fetch(productUrl, { 
                        mode: 'cors',
                        headers: { 
                            'Accept': 'text/html',
                            'User-Agent': 'Mozilla/5.0'
                        }
                    });
                    if (response.ok) {
                        const html = await response.text();
                        
                        // Try multiple patterns to find product image
                        // Pattern 1: WooCommerce featured image in meta tag
                        let imgMatch = html.match(/<meta[^>]+property="og:image"[^>]+content="([^"]+)"/i);
                        if (imgMatch && imgMatch[1]) {
                            return imgMatch[1];
                        }
                        
                        // Pattern 2: Product image in img tag with product class
                        imgMatch = html.match(/<img[^>]+(?:class="[^"]*product[^"]*|woocommerce-product-gallery__image)[^>]+src="([^"]+)"[^>]*>/i);
                        if (imgMatch && imgMatch[1]) {
                            let imgUrl = imgMatch[1];
                            // Convert relative URLs to absolute
                            if (imgUrl.startsWith('/')) {
                                imgUrl = 'https://dynapharm.net' + imgUrl;
                            } else if (imgUrl.startsWith('./')) {
                                imgUrl = 'https://dynapharm.net/ph' + imgUrl.substring(1);
                            }
                            return imgUrl;
                        }
                        
                        // Pattern 3: Any img tag in product gallery
                        imgMatch = html.match(/<img[^>]+src="([^"]*wp-content[^"]*uploads[^"]*)"[^>]*>/i);
                        if (imgMatch && imgMatch[1]) {
                            let imgUrl = imgMatch[1];
                            if (!imgUrl.startsWith('http')) {
                                imgUrl = imgUrl.startsWith('/') ? 'https://dynapharm.net' + imgUrl : 'https://dynapharm.net/ph/' + imgUrl;
                            }
                            return imgUrl;
                        }
                    }
                } catch (e) {
                    console.debug('Could not fetch product page:', e);
                }
                
                // Fallback: return first potential image URL
                const { imageUrls } = getProductImageUrl(productName);
                return imageUrls[0] || null;
            } catch (error) {
                console.debug('Error fetching product image:', error);
                return null;
            }
        }
        
        // Function to get or create product image with website fallback
        // Cache for database images to avoid repeated API calls
        let productImagesCache = null;
        let productImagesCacheTime = 0;
        const CACHE_DURATION = 300000; // 5 minutes

        async function loadProductImagesFromDatabase() {
            // Return cached data if still valid
            if (productImagesCache && (Date.now() - productImagesCacheTime) < CACHE_DURATION) {
                return productImagesCache;
            }

            try {
                const response = await fetch('/api/product_images');
                if (response.ok) {
                    const images = await response.json();
                    // Group by product name and description
                    const imageMap = {};
                    for (const img of images) {
                        // Try product_name first, then product_description, then fallback to product_id
                        const productKey = img.product_name || img.product_description || img.product_id;
                        if (productKey) {
                            // Store by both name and description if available
                            if (img.product_name && !imageMap[img.product_name]) {
                                imageMap[img.product_name] = [];
                            }
                            if (img.product_description && !imageMap[img.product_description]) {
                                imageMap[img.product_description] = [];
                            }
                            
                            const imageObj = {
                                url: img.image_url,
                                thumbnail: img.thumbnail_url,
                                full: img.image_url,
                                src: img.image_url,
                                w300: img.thumbnail_url || img.image_url,
                                w600: img.image_url,
                                is_primary: img.is_primary
                            };
                            
                            if (img.product_name) imageMap[img.product_name].push(imageObj);
                            if (img.product_description && img.product_description !== img.product_name) {
                                imageMap[img.product_description].push(imageObj);
                            }
                        }
                    }
                    productImagesCache = imageMap;
                    productImagesCacheTime = Date.now();
                    console.log(`âœ… Loaded ${images.length} product images from database, mapped to ${Object.keys(imageMap).length} products`);
                    return imageMap;
                } else {
                    console.warn('Failed to load product images:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading product images from database:', error);
            }
            return {};
        }

        async function getProductImage(productName, photoMap) {
            // First check if we have stored photos in localStorage
            let productPhotos = photoMap[productName];
            if (productPhotos) {
                if (typeof productPhotos === 'string') {
                    productPhotos = [productPhotos];
                }
                if (Array.isArray(productPhotos) && productPhotos.length > 0) {
                    // Filter and validate
                    const valid = productPhotos.filter(photo => {
                        if (!photo) return false;
                        if (typeof photo === 'string') {
                            const url = photo.trim();
                            return url.length > 0 && !url.includes('placehold.co') && (url.startsWith('http') || url.startsWith('data:'));
                        }
                        if (typeof photo === 'object') return !!(photo.full || photo.src || photo.w600 || photo.w300 || photo.url);
                        return false;
                    });
                    if (valid.length > 0) return valid;
                }
            }
            
            // Try to load from database API
            try {
                const dbImages = await loadProductImagesFromDatabase();
                if (dbImages[productName] && dbImages[productName].length > 0) {
                    console.log(`âœ… Loaded ${dbImages[productName].length} image(s) for ${productName} from database`);
                    return dbImages[productName];
                }
            } catch (error) {
                console.debug('Error loading from database:', error);
            }
            
            // Try direct API call for this product
            try {
                const response = await fetch(`/api/product_images?product_name=${encodeURIComponent(productName)}`);
                if (response.ok) {
                    const images = await response.json();
                    if (images && images.length > 0) {
                        const formatted = images.map(img => ({
                            url: img.image_url,
                            thumbnail: img.thumbnail_url,
                            full: img.image_url,
                            src: img.image_url,
                            w300: img.thumbnail_url || img.image_url,
                            w600: img.image_url,
                            is_primary: img.is_primary
                        })).sort((a, b) => (b.is_primary ? 1 : 0) - (a.is_primary ? 1 : 0));
                        console.log(`âœ… Loaded ${formatted.length} image(s) for ${productName} from database API`);
                        return formatted;
                    }
                }
            } catch (error) {
                console.debug('Error fetching product image from API:', error);
            }
            
            // If no stored photos, try to get from website
            const { imageUrls, slug } = getProductImageUrl(productName);
            // Return the first image URL as a fallback (will be checked when loading)
            return imageUrls.length > 0 ? [imageUrls[0]] : null;
        }
        
        // Function to download product image and convert to base64 data URL
        async function downloadImageAsDataUrl(imageUrl) {
            try {
                const response = await fetch(imageUrl, { 
                    mode: 'cors',
                    cache: 'no-cache'
                });
                if (!response.ok) {
                    return null;
                }
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.debug('Error downloading image:', imageUrl, error);
                return null;
            }
        }
        
        // Function to download and save all product images to localStorage
        async function downloadAllProductImages(options = {}) {
            const {
                onProgress = null,
                onComplete = null,
                batchSize = 5,
                delayBetweenBatches = 1000,
                skipExisting = true
            } = options;
            
            const products = PRICE_LIST || [];
            const photoMap = {};
            try {
                const existing = localStorage.getItem('dyna_product_photos');
                if (existing) {
                    Object.assign(photoMap, JSON.parse(existing));
                }
            } catch (e) {
                console.warn('Error loading existing photos:', e);
            }
            
            const results = {
                total: products.length,
                downloaded: 0,
                failed: 0,
                skipped: 0,
                errors: []
            };
            
            console.log(`Starting download of ${products.length} product images...`);
            
            // Process products in batches to avoid overwhelming the server
            for (let i = 0; i < products.length; i += batchSize) {
                const batch = products.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (product) => {
                    const productName = product.description;
                    
                    // Skip if already exists and skipExisting is true
                    if (skipExisting && photoMap[productName]) {
                        const existingPhotos = Array.isArray(photoMap[productName]) 
                            ? photoMap[productName] 
                            : [photoMap[productName]];
                        const hasValidPhoto = existingPhotos.some(photo => {
                            if (typeof photo === 'string') {
                                return photo && !photo.includes('placehold.co') && !photo.includes('dynapharm.net');
                            }
                            return false;
                        });
                        
                        if (hasValidPhoto) {
                            results.skipped++;
                            if (onProgress) onProgress(productName, 'skipped', results);
                            return;
                        }
                    }
                    
                    // Get image URLs for this product
                    const { imageUrls } = getProductImageUrl(productName);
                    
                    // Try each URL until one works
                    let downloaded = false;
                    for (const imageUrl of imageUrls) {
                        try {
                            const dataUrl = await downloadImageAsDataUrl(imageUrl);
                            if (dataUrl) {
                                // Save to photoMap
                                if (!photoMap[productName]) {
                                    photoMap[productName] = [];
                                }
                                if (!Array.isArray(photoMap[productName])) {
                                    photoMap[productName] = [photoMap[productName]];
                                }
                                
                                // Check if this image is already stored
                                if (!photoMap[productName].includes(dataUrl)) {
                                    photoMap[productName].push(dataUrl);
                                }
                                
                                results.downloaded++;
                                downloaded = true;
                                if (onProgress) onProgress(productName, 'success', results);
                                console.log(`âœ… Downloaded: ${productName}`);
                                break;
                            }
                        } catch (error) {
                            console.debug(`Failed to download ${imageUrl}:`, error);
                        }
                    }
                    
                    if (!downloaded) {
                        results.failed++;
                        results.errors.push({ product: productName, urls: imageUrls });
                        if (onProgress) onProgress(productName, 'failed', results);
                        console.warn(`âŒ Failed: ${productName}`);
                    }
                }));
                
                // Save progress after each batch
                try {
                    localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                } catch (e) {
                    console.error('Error saving photos to localStorage:', e);
                }
                
                // Delay between batches to be respectful to the server
                if (i + batchSize < products.length) {
                    await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
                }
                
                if (onProgress) {
                    onProgress(null, 'batch_complete', results);
                }
            }
            
            // Final save
            try {
                localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                console.log(`âœ… Completed! Downloaded: ${results.downloaded}, Failed: ${results.failed}, Skipped: ${results.skipped}`);
            } catch (e) {
                console.error('Error saving final photos to localStorage:', e);
            }
            
            if (onComplete) {
                onComplete(results);
            }
            
            return results;
        }
        
        // Make function available globally for console access
        window.downloadAllProductImages = downloadAllProductImages;
        
        // Function to get display name from mapping or original
        function getProductDisplayName(productName) {
            return PRODUCT_NAME_MAPPING[productName] || productName;
        }
        
        async function loadShopProducts() {
            // Check for both landing page grid and regular shop grid
            const landingShopProductsGrid = document.getElementById('landingShopProductsGrid');
            const shopProductsGrid = document.getElementById('shopProductsGrid');
            
            const targetGrid = landingShopProductsGrid || shopProductsGrid;
            
            if (!targetGrid) {
                console.warn('Shop products grid not found');
                return;
            }
            
            // Ensure PRICE_LIST is available (check both const and window)
            const products = (typeof PRICE_LIST !== 'undefined' ? PRICE_LIST : (window.PRICE_LIST || []));
            
            if (!products || products.length === 0) {
                const noProductsMsg = '<p style="text-align: center; padding: 40px; color: #666;">No products available. Please check back later.</p>';
                if (landingShopProductsGrid) landingShopProductsGrid.innerHTML = noProductsMsg;
                if (shopProductsGrid) shopProductsGrid.innerHTML = noProductsMsg;
                console.warn('PRICE_LIST is empty or not available');
                return;
            }
            let photoMap = {};
            try {
                photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            } catch (e) {
                console.error('Error parsing product photos:', e);
                photoMap = {};
            }
            
            // Pre-load database images
            await loadProductImagesFromDatabase();
            
            // Show loading state
            const loadingMsg = '<p style="text-align: center; padding: 40px; color: #666;">Loading products...</p>';
            if (landingShopProductsGrid) landingShopProductsGrid.innerHTML = loadingMsg;
            if (shopProductsGrid) shopProductsGrid.innerHTML = loadingMsg;
            
            // Get effective customer type (default to customer for landing page)
                const selectedType = document.getElementById('shopCustomerType')?.value || '';
            const effectiveType = shopCustomerTypeSelected ? (previousCustomerType || selectedType || 'customer') : 'customer';
            
            // Generate HTML for all products using async function
            const productsHTML = await Promise.all(products.map(async (product) => {
                return await generateProductHTML(product, effectiveType, photoMap);
            }));
            
            const productsHTMLString = productsHTML.join('');
            
            // Populate both grids if they exist
            if (landingShopProductsGrid) landingShopProductsGrid.innerHTML = productsHTMLString;
            if (shopProductsGrid) shopProductsGrid.innerHTML = productsHTMLString;
            
            // Initialize carousels after rendering
            try {
                initializeProductCarousels();
            } catch (e) {
                console.error('Error initializing carousels:', e);
            }
            
        }
        
        function onShopCustomerTypeChange() {
            const customerType = document.getElementById('shopCustomerType')?.value;
            if (!customerType) {
                shopCustomerTypeSelected = false;
                filterShopProducts();
                return;
            }

            // If changing type with items in cart, reprice without clearing
            if (previousCustomerType && customerType !== previousCustomerType && Array.isArray(shopCart) && shopCart.length > 0) {
                shopCart = shopCart.map(item => {
                    const newPrice = customerType === 'distributor' ? (item.dp || item.price || 0) : (item.cp || item.price || 0);
                    return {
                        ...item,
                        price: newPrice,
                        customerType: customerType
                    };
                });
                updateShopCart();
            }

            shopCustomerTypeSelected = true;
            previousCustomerType = customerType;
            filterShopProducts();
        }
        
        async function filterShopProducts() {
            // Check both landing page search and regular shop search
            const landingSearch = document.getElementById('landingShopSearch')?.value.toLowerCase() || '';
            const shopSearch = document.getElementById('shopSearch')?.value.toLowerCase() || '';
            const searchTerm = landingSearch || shopSearch;
            
            const selectedType = document.getElementById('shopCustomerType')?.value || '';
            const effectiveType = shopCustomerTypeSelected ? (previousCustomerType || selectedType || 'customer') : 'customer';
            const products = PRICE_LIST || [];
            const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            
            const landingShopProductsGrid = document.getElementById('landingShopProductsGrid');
            const shopProductsGrid = document.getElementById('shopProductsGrid');
            
            if (!landingShopProductsGrid && !shopProductsGrid) return;
            
            // Ensure database images are loaded
            await loadProductImagesFromDatabase();
            
            // Filter products by search term (check both original description and display name)
            const filteredProducts = searchTerm 
                ? products.filter(product => {
                const displayName = getProductDisplayName(product.description);
                const searchInOriginal = product.description.toLowerCase().includes(searchTerm);
                const searchInDisplay = displayName.toLowerCase().includes(searchTerm);
                return searchInOriginal || searchInDisplay;
                })
                : products;
            
            // Generate HTML for all products
            const productsHTML = await Promise.all(filteredProducts.map(async (product) => {
                return await generateProductHTML(product, effectiveType, photoMap);
            }));
            
            const productsHTMLString = productsHTML.join('');
            
            // Update both grids if they exist
            if (landingShopProductsGrid) landingShopProductsGrid.innerHTML = productsHTMLString;
            if (shopProductsGrid) shopProductsGrid.innerHTML = productsHTMLString;
            
            // Initialize carousels after rendering
            try {
                initializeProductCarousels();
            } catch (e) {
                console.error('Error initializing carousels:', e);
            }
        }
        
        async function generateProductHTML(product, effectiveType, photoMap) {
                const displayPrice = effectiveType === 'distributor' ? product.dp : product.cp;
                const priceLabel = effectiveType === 'distributor' ? 'DP' : 'CP';
                
                // Get display name from mapping (website format)
                const displayName = getProductDisplayName(product.description);
                
            // Get product images - try stored first, then database, then website
            let productPhotos = await getProductImage(product.description, photoMap);
                
                // If no stored photos or only placeholders, try to get from website
                if (!productPhotos || productPhotos.length === 0 || 
                (productPhotos.length === 1 && productPhotos[0] && typeof productPhotos[0] === 'string' && productPhotos[0].includes('placehold.co'))) {
                    const slug = productNameToSlug(product.description);
                    const { imageUrls } = getProductImageUrl(product.description);
                    // Use only the first URL to reduce failed requests
                if (imageUrls && imageUrls.length > 0) {
                    productPhotos = [imageUrls[0]];
                }
                }
                
                // Ensure it's an array
            if (!productPhotos) productPhotos = [];
                if (!Array.isArray(productPhotos)) {
                    productPhotos = [productPhotos];
                }
                
                // Filter out invalid entries
                productPhotos = productPhotos.filter(photo => {
                    if (!photo) return false;
                if (typeof photo === 'string') {
                    const url = photo.trim();
                    return url.length > 0 && !url.includes('placehold.co') && (url.startsWith('http') || url.startsWith('data:') || url.startsWith('/'));
                }
                if (typeof photo === 'object') {
                    return !!(photo.full || photo.src || photo.w600 || photo.w300 || photo.url);
                }
                    return false;
                });
                
                // If still no valid photos, try direct website image paths
                if (productPhotos.length === 0) {
                    const slug = productNameToSlug(product.description);
                    const { imageUrls } = getProductImageUrl(product.description);
                if (imageUrls && imageUrls.length > 0) {
                    productPhotos = [imageUrls[0]]; // Try only first URL to reduce failed requests
                }
                }
                
                // Limit to max 4 photos
                if (productPhotos.length > 4) {
                    productPhotos = productPhotos.slice(0, 4);
                }
                
                const uniqueId = `product-carousel-filter-${product.description.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}-${Math.random()}`;
                
                return `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); content-visibility: auto; contain-intrinsic-size: 300px 260px;">
                        <div class="product-carousel-container" id="${uniqueId}" data-photo-count="${productPhotos.length}" style="position: relative; width: 100%; height: 200px; border-radius: 5px; margin-bottom: 10px; overflow: hidden; cursor: pointer; background: #f0f0f0;">
                            ${productPhotos.map((photo, idx) => {
                                const isObj = typeof photo === 'object' && photo !== null;
                                const src = isObj ? (photo.full || photo.src || photo.w600 || photo.w300) : photo;
                                const srcset = isObj ? `${photo.w300 || src} 300w, ${photo.w600 || src} 600w, ${photo.full || src} 1200w` : '';
                                return `
                            <img ${srcset ? `srcset="${srcset}"` : ''} src="${src}" alt="${displayName} - Image ${idx + 1}" 
                                     data-index="${idx}" ${idx === 0 ? 'loading="eager" fetchpriority="high"' : 'loading="lazy" fetchpriority="low"'} decoding="async" width="200" height="200" sizes="(max-width: 640px) 100vw, 600px"
                                     onerror="if(!this.hasAttribute('data-failed')) { this.setAttribute('data-failed', '1'); const placeholder = 'https://placehold.co/200x200?text=' + encodeURIComponent('${displayName.replace(/'/g, "\\'")}'); if(!this.src.includes('placehold.co')) { this.src = placeholder; } }"
                                     onload="this.removeAttribute('data-failed');"
                                     style="width: 100%; height: 200px; object-fit: cover; position: ${idx === 0 ? 'relative' : 'absolute'}; top: 0; left: 0; opacity: ${idx === 0 ? '1' : '0'}; transition: opacity 0.5s ease-in-out;">
                                `;
                            }).join('')}
                            ${productPhotos.length > 1 ? `
                                <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px;">
                                    ${productPhotos.map((_, idx) => `<div class="carousel-dot" data-index="${idx}" style="width: 8px; height: 8px; border-radius: 50%; background: ${idx === 0 ? '#fff' : 'rgba(255,255,255,0.5)'}; cursor: pointer; transition: background 0.3s;"></div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <h4 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem;">${displayName}</h4>
                        <p style="color: #c41e3a; font-size: 1.3rem; font-weight: bold; margin: 10px 0;">
                            N$${displayPrice.toFixed(2)} <span style="font-size: 0.8rem; color: #666;">(${priceLabel})</span>
                        </p>
                        ${product.bv ? `<p style="color: #666; font-size: 0.9rem;">BV: ${product.bv}</p>` : ''}
                        <button class="btn btn-success" onclick="addToShopCart('${product.description.replace(/'/g, "\\'")}', ${product.cp}, ${product.dp}, ${product.bv || 0})" style="width: 100%; margin-top: 10px;">
                            Add to Cart
                        </button>
                    </div>
                `;
        }
        
        // Store pending product info for cart addition
        let pendingCartItem = null;
        
        function addToShopCart(productName, cp, dp, bv) {
            // Require branch selection before adding to cart
            try {
                if (!currentBranch || currentBranch === '') {
                    alert('Please select your nearest branch first (top of page) to receive your order.');
                    const sel = document.getElementById('branchSelect');
                    if (sel) sel.focus();
                    return;
                }
            } catch (e) { /* no-op */ }
            // Store the product info
            pendingCartItem = { productName, cp, dp, bv };
            
            // If cart is empty, show customer type selection
            if (shopCart.length === 0) {
                showCustomerTypeModal();
                return;
            }
            
            // If cart has items, check if they match the first item's customer type
            const firstItemCustomerType = shopCart[0].customerType;
            if (firstItemCustomerType) {
                // Use existing customer type
                addToCartWithCustomerType(productName, cp, dp, bv, firstItemCustomerType);
            } else {
                // Show modal if customer type not set
                showCustomerTypeModal();
            }
        }
        
        function showCustomerTypeModal() {
            const modal = document.getElementById('customerTypeModal') || createCustomerTypeModal();
            modal.style.display = 'block';
        }
        
        function createCustomerTypeModal() {
            const modal = document.createElement('div');
            modal.id = 'customerTypeModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeModal('customerTypeModal')">&times;</span>
                    <h2>Select Customer Type</h2>
                    <p style="margin-bottom: 20px; color: #666;">Please select your customer type to continue.</p>
                    <div class="form-group">
                        <label>Customer Type</label>
                        <select id="modalCustomerType" style="padding: 10px; width: 100%; font-size: 1rem;">
                            <option value="customer">Customer (CP Pricing)</option>
                            <option value="distributor">Distributor (DP Pricing)</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="confirmCustomerTypeSelection()" style="width: 100%;">Confirm</button>
                        <button class="btn" onclick="closeModal('customerTypeModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        function confirmCustomerTypeSelection() {
            const customerType = document.getElementById('modalCustomerType')?.value;
            if (!customerType || !pendingCartItem) {
                alert('Please select a customer type.');
                return;
            }
            
            // Set customer type for all cart items
            shopCustomerTypeSelected = true;
            previousCustomerType = customerType;
            // Update product pricing display to reflect selection
            try { filterShopProducts(); } catch (e) { /* ignore */ }
            
            // Add item to cart
            addToCartWithCustomerType(
                pendingCartItem.productName,
                pendingCartItem.cp,
                pendingCartItem.dp,
                pendingCartItem.bv,
                customerType
            );
            
            closeModal('customerTypeModal');
            pendingCartItem = null;
        }
        
        function addToCartWithCustomerType(productName, cp, dp, bv, customerType) {
            const price = customerType === 'distributor' ? dp : cp;
            
            const existingItem = shopCart.find(item => item.name === productName && item.customerType === customerType);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                shopCart.push({
                    name: productName,
                    price: price,
                    cp: cp,
                    dp: dp,
                    bv: bv,
                    quantity: 1,
                    customerType: customerType
                });
            }
            
            updateShopCart();
        }
        
        function updateShopCart() {
            const cartItems = document.getElementById('shopCartItems');
            const cartSection = document.getElementById('shopCartSection');
            const cartTotal = document.getElementById('shopCartTotal');
            const cartCustomerType = document.getElementById('shopCartCustomerType');
            const cartBadge = document.getElementById('shopCartBadge');
            const cartCount = document.getElementById('shopCartCount');
            
            if (!cartItems || !cartSection || !cartTotal) return;
            
            if (shopCart.length === 0) {
                cartSection.style.display = 'none';
                shopCustomerTypeSelected = false;
                previousCustomerType = '';
                try { filterShopProducts(); } catch (e) { /* ignore */ }
                if (cartBadge) cartBadge.style.display = 'none';
                return;
            }
            
            cartSection.style.display = 'block';
            
            // Show customer type, and globally selected distributor if available
            const customerType = shopCart[0]?.customerType;
            if (cartCustomerType) {
                if (customerType) {
                    const typeLabel = customerType === 'distributor' ? 'Distributor (DP Pricing)' : 'Customer (CP Pricing)';
                    let line = `Customer Type: ${typeLabel}`;
                    try {
                        const gd = getGlobalDistributor();
                        if (gd && gd.name && gd.nbNumber) {
                            line += ` | Distributor: ${gd.name} (${gd.nbNumber})`;
                        }
                    } catch (_) {}
                    cartCustomerType.textContent = line;
                } else {
                    cartCustomerType.textContent = '';
                }
            }
            
            cartItems.innerHTML = shopCart.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee;">
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">N$${item.price.toFixed(2)} x ${item.quantity}</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 1.2rem; font-weight: bold; color: #c41e3a;">N$${(item.price * item.quantity).toFixed(2)}</p>
                        <button class="btn btn-danger" onclick="removeFromShopCart(${index})" style="padding: 5px 10px; margin-top: 5px;">Remove</button>
                    </div>
                </div>
            `).join('');
            
            const total = shopCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = `N$ ${total.toFixed(2)}`;

            // Update floating badge count
            try {
                const countVal = shopCart.reduce((sum, item) => sum + (item.quantity || 0), 0);
                if (cartCount) cartCount.textContent = String(countVal);
                if (cartBadge) cartBadge.style.display = countVal > 0 ? 'inline-block' : 'none';
            } catch (_) {}
            try { updateFloatingCartUI(); } catch(_) {}
        }

        function ensureFloatingCart(){
            if (document.getElementById('floatingCart')) return;
            const el = document.createElement('div');
            el.id = 'floatingCart';
            el.style.position = 'fixed';
            el.style.right = '20px';
            el.style.bottom = '20px';
            el.style.background = 'white';
            el.style.border = '2px solid #c41e3a';
            el.style.borderRadius = '12px';
            el.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
            el.style.padding = '12px 16px';
            el.style.minWidth = '220px';
            el.style.zIndex = '9999';
            el.style.display = 'none';
            el.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="background:#c41e3a; color:white; border-radius:999px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-weight:700;" id="floatingCartCount">0</div>
                    <div style="flex:1;">
                        <div style="font-weight:700; color:#2c3e50;">Cart</div>
                        <div style="color:#7f8c8d; font-size:12px;" id="floatingCartTotal">N$ 0.00</div>
                    </div>
                    <button class="btn btn-success" style="padding:8px 12px;" onclick="checkoutShopOrder()">Checkout</button>
                </div>`;
            el.onclick = function(e){ if (e.target.tagName !== 'BUTTON') scrollToShopCart(); };
            document.body.appendChild(el);
        }

        function updateFloatingCartUI(){
            ensureFloatingCart();
            const el = document.getElementById('floatingCart');
            const countEl = document.getElementById('floatingCartCount');
            const totalEl = document.getElementById('floatingCartTotal');
            const countVal = (shopCart || []).reduce((sum, item) => sum + (item.quantity || 0), 0);
            const totalVal = (shopCart || []).reduce((sum, item) => sum + (item.price * (item.quantity || 0)), 0);
            if (countVal > 0) {
                el.style.display = 'block';
                if (countEl) countEl.textContent = String(countVal);
                if (totalEl) totalEl.textContent = 'N$ ' + totalVal.toFixed(2);
            } else {
                el.style.display = 'none';
            }
        }
        
        function removeFromShopCart(index) {
            shopCart.splice(index, 1);
            updateShopCart();
        }
        
        function clearShopCart() {
            if (confirm('Are you sure you want to clear your cart?')) {
                shopCart = [];
                shopCustomerTypeSelected = false;
                previousCustomerType = '';
                updateShopCart();
            }
        }

        function scrollToShopCart() {
            const el = document.getElementById('shopCartSection');
            if (!el) return;
            el.style.display = 'block';
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function checkoutShopOrder() {
            if (shopCart.length === 0) {
                alert('Your cart is empty');
                return;
            }
            
            // Show checkout modal
            showCheckoutModal();
        }
        
        function showCheckoutModal() {
            const modal = document.getElementById('checkoutModal') || createCheckoutModal();
            modal.style.display = 'block';
            // Lock checkout customer type to cart's customer type for pricing consistency
            try {
                const cartType = (shopCart && shopCart[0] && shopCart[0].customerType) || '';
                const typeSelect = document.getElementById('checkoutCustomerType');
                if (typeSelect && cartType) {
                    typeSelect.value = cartType;
                    typeSelect.disabled = true;
                    onCheckoutCustomerTypeChange();
                }
            } catch (e) { /* ignore */ }
            // Apply default referral for customers
            try { applyDefaultReferral(); } catch (e) { /* ignore */ }
            // Initialize payment method display
            try { 
                setTimeout(() => {
                    if (document.getElementById('checkoutPaymentMethod')?.value) {
                        onPaymentMethodChange();
                    }
                }, 100);
            } catch (e) { /* ignore */ }
        }
        
        function createCheckoutModal() {
            const modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeModal('checkoutModal')">&times;</span>
                    <h2>ðŸ›’ Checkout</h2>
                    <form id="checkoutForm" onsubmit="processCheckout(event)">
                        <div class="form-group">
                            <label class="required">Nearest Branch (Order will be fulfilled from)</label>
                            <select id="checkoutBranch" required></select>
                        </div>
                        <div class="form-group">
                            <label class="required">Customer Type</label>
                            <select id="checkoutCustomerType" required onchange="onCheckoutCustomerTypeChange()">
                                <option value="customer" selected>Customer</option>
                                <option value="distributor">Distributor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" id="checkoutName" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Phone Number</label>
                            <input type="tel" id="checkoutPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Email</label>
                            <input type="email" id="checkoutEmail" required>
                        </div>
                        <div id="checkoutDistributorSection" style="display:none; background:#f8f9fa; padding:12px; border-radius:6px;">
                            <div class="form-group">
                                <label class="required">Distributor NB Number</label>
                                <input type="text" id="checkoutDistributorNB" placeholder="e.g., NB00001234" pattern="NB[0-9]+">
                                <small id="checkoutDistributorNBStatus" style="display:block; margin-top:5px; color:#666;"></small>
                            </div>
                        </div>
                        <div id="checkoutReferralSection" style="display:block; background:#f8f9fa; padding:12px; border-radius:6px;">
                            <div class="form-group">
                                <label class="required">Referral Name</label>
                                <input type="text" id="checkoutReferralName" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Referral NB Number</label>
                                <input type="text" id="checkoutReferralNB" required pattern="NB[0-9]+">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required">Delivery Address</label>
                            <textarea id="checkoutAddress" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="required">Payment Method</label>
                            <select id="checkoutPaymentMethod" required onchange="onPaymentMethodChange()">
                                <option value="">Select Payment Method</option>
                                <option value="online">Online (Card/Mobile via Flutterwave)</option>
                                <option value="ewallet">E-Wallet (+264817317160)</option>
                                <option value="easywallet">Easy Wallet (+264817317160)</option>
                                <option value="bluewallet">Blue Wallet (+264817317160)</option>
                                <option value="mobimoney">Mobi Money Wallet (+264817317160)</option>
                                <option value="paytocell">Pay to Cell (+264817317160)</option>
                                <option value="cod">Cash on Delivery</option>
                                <option value="pickup">Pick Up at Branch</option>
                            </select>
                        </div>
                        <div id="paymentNumberDisplay" style="display:none; background:#e8f5e9; padding:12px; border-radius:6px; margin-top:10px;">
                            <p style="margin:0; color:#2c3e50; font-weight:bold;">ðŸ“± Payment Number: <span style="color:#c41e3a;">+264817317160</span></p>
                            <p style="margin:5px 0 0 0; color:#666; font-size:0.9rem;">Please send your payment to this number and include Order ID as reference</p>
                        </div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-success">Complete Order</button>
                            <button type="button" class="btn" onclick="closeModal('checkoutModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            // Initialize default referral values on create
            try { applyDefaultReferral(); } catch (e) { /* ignore */ }
            // Populate branch selector
            try { populateCheckoutBranch(); } catch (e) { /* ignore */ }
            return modal;
        }
        
        function processCheckout(event) {
            event.preventDefault();
            
            // Validate customer type specific requirements
            const customerType = document.getElementById('checkoutCustomerType')?.value || 'customer';
            if (customerType === 'distributor') {
                const nb = (document.getElementById('checkoutDistributorNB')?.value || '').trim().toUpperCase();
                const valid = validateDistributorNB(nb);
                const status = document.getElementById('checkoutDistributorNBStatus');
                if (!valid) {
                    if (status) status.textContent = 'Invalid or unknown NB number. Please ensure it exists in uploaded distributors.';
                    alert('Please provide a valid Distributor NB number from uploaded distributors.');
                    return;
                }
                if (status) status.textContent = 'NB verified âœ“';
            } else {
                // Ensure referral fields populated (default is applied on open/change)
                const refName = (document.getElementById('checkoutReferralName')?.value || '').trim();
                const refNB = (document.getElementById('checkoutReferralNB')?.value || '').trim();
                if (!refName || !refNB) {
                    alert('Please provide referral name and NB number.');
                    return;
                }
            }

            const paymentMethod = document.getElementById('checkoutPaymentMethod').value;
            const walletMethods = ['ewallet', 'easywallet', 'bluewallet', 'mobimoney', 'paytocell'];

            // Calculate totals using dual pricing and include BV similar to walk-in sell workflow
            const subtotal = (shopCart || []).reduce((sum, item) => {
                const unit = (customerType === 'distributor') ? (item.dp || item.price || 0) : (item.cp || item.price || 0);
                return sum + unit * (item.quantity || 0);
            }, 0);
            const totalBV = (shopCart || []).reduce((sum, item) => sum + (item.bv || 0) * (item.quantity || 0), 0);

            	    const order = {
                id: 'ORD' + Date.now(),
                receiptNo: 'WEB' + Date.now(),
                source: 'online',
                date: new Date().toISOString(),
                branch: (document.getElementById('checkoutBranch')?.value || ''),
                customerName: document.getElementById('checkoutName').value,
                customerPhone: document.getElementById('checkoutPhone').value,
                customerEmail: document.getElementById('checkoutEmail').value,
                customerAddress: document.getElementById('checkoutAddress').value,
                paymentMethod: paymentMethod,
                paymentNumber: walletMethods.includes(paymentMethod) ? '+264817317160' : null,
                customerType: document.getElementById('checkoutCustomerType')?.value || 'customer',
                distributorNB: document.getElementById('checkoutCustomerType')?.value === 'distributor' ? (document.getElementById('checkoutDistributorNB')?.value || '').toUpperCase() : null,
                referral: document.getElementById('checkoutCustomerType')?.value === 'customer' ? {
                    name: document.getElementById('checkoutReferralName')?.value || '',
                    nb: (document.getElementById('checkoutReferralNB')?.value || '').toUpperCase()
                } : null,
                items: shopCart,
                status: 'pending',
                subtotal: subtotal,
                totalBV: totalBV,
                total: subtotal
            };

                // If online payment selected, start gateway checkout first
                if (paymentMethod === 'online') {
                    try { startOnlinePayment(order); } catch (e) { alert('Payment init failed'); }
                    return;
                }
                // Otherwise submit immediately as pending (wallet/COD/Pickup)
                finalizeOrder(order, false, null);
        }

        function finalizeOrder(order, isPaid, paymentMeta){
            if (isPaid) {
                order.status = 'paid';
                order.payment = Object.assign({}, paymentMeta || {}, { verified: !!paymentMeta });
            }
            (async () => {
                const payload = JSON.stringify(order);
                const headers = { 'Content-Type': 'application/json' };
                const endpoints = ['/api/orders', 'http://localhost:8001/api/orders'];
                let submitted = false;
                for (let i = 0; i < endpoints.length; i++) {
                    try {
                        const res = await fetch(endpoints[i], { method: 'POST', headers, body: payload });
                        if (res.ok) {
                            const data = await res.json();
                            if (data && data.success && data.order) {
                                submitted = true;
                                order.id = data.order.id || order.id;
                                break;
                            }
                        }
                    } catch (e) {}
                }
                if (!submitted) {
                    try {
                        onlineOrders.push(order);
                        localStorage.setItem('dyna_online_orders', JSON.stringify(onlineOrders));
                        // Broadcast new order for real-time sync
                        try {
                            window.dispatchEvent(new CustomEvent('orders:updated', { detail: { order: order, action: 'created' } }));
                            const m = document.querySelector('meta[name="rt-base"]');
                            const rtBase = m && m.content && m.content.trim();
                            if (rtBase) {
                                fetch(rtBase.replace(/\/$/, '') + '/publish', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ event: { type: 'orders:updated', order: order, action: 'created', ts: Date.now() } })
                                }).catch(_ => {});
                            }
                            fetch('/api/realtime_publish', { 
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ channel: 'orders', event: { order: order, action: 'created', ts: Date.now() } }) 
                            }).catch(_ => {});
                        } catch (_) {}
                    } catch (e) {}
                }
                try { recordDepartmentEvent && recordDepartmentEvent('online_order_placed', order); } catch (_) {}
                alert('Order placed successfully! Order ID: ' + order.id + (isPaid ? '\nPayment received.' : ''));
                closeModal('checkoutModal');
                clearShopCart();
            })();
        }

        function loadFlutterwaveScript(cb){
            if (window.FlutterwaveCheckout) { cb(); return; }
            const existing = document.querySelector('script[src="https://checkout.flutterwave.com/v3.js"]');
            if (existing) { existing.onload = () => cb(); return; }
            const s = document.createElement('script');
            s.src = 'https://checkout.flutterwave.com/v3.js';
            s.onload = () => cb();
            s.onerror = () => alert('Failed to load payment script');
            document.head.appendChild(s);
        }

        function startOnlinePayment(order){
            loadFlutterwaveScript(() => {
                const pub = (window.FLW_PUBLIC_KEY || localStorage.getItem('FLW_PUBLIC_KEY') || '').trim();
                if (!pub) {
                    alert('Payment not configured. Set FLW_PUBLIC_KEY in environment.');
                    return;
                }
                const amount = Number(order.total || 0);
                const txRef = order.id;
                const customer = { email: order.customerEmail, phonenumber: order.customerPhone, name: order.customerName };
                try {
                    FlutterwaveCheckout({
                        public_key: pub,
                        tx_ref: txRef,
                        amount: amount,
                        currency: 'NAD',
                        customer,
                        meta: { order_id: order.id, branch: order.branch },
                        callback: function (data) {
                            // Verify on backend
                            const body = JSON.stringify({ transaction_id: data?.transaction_id || data?.id, order_id: order.id });
                            fetch('/api/payments/verify/flutterwave', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body })
                                .then(r => r.json()).then(v => {
                                    const ok = v?.success && v?.verify?.success;
                                    finalizeOrder(order, !!ok, { provider: 'flutterwave', ref: data?.tx_ref, transaction_id: data?.transaction_id || data?.id });
                                }).catch(() => finalizeOrder(order, false, null));
                        },
                        onclose: function () {
                            // If user closed without paying, still place order as pending
                            finalizeOrder(order, false, null);
                        }
                    });
                } catch (e) {
                    alert('Payment error. Order will be placed as pending.');
                    finalizeOrder(order, false, null);
                }
            });
        }
        
        // ==========================
        // Front Desk Portal Functions
        // ==========================
        function onCheckoutCustomerTypeChange() {
            const type = document.getElementById('checkoutCustomerType')?.value || 'customer';
            const refSec = document.getElementById('checkoutReferralSection');
            const distSec = document.getElementById('checkoutDistributorSection');
            if (type === 'distributor') {
                if (refSec) refSec.style.display = 'none';
                if (distSec) distSec.style.display = 'block';
            } else {
                if (refSec) refSec.style.display = 'block';
                if (distSec) distSec.style.display = 'none';
                applyDefaultReferral();
            }
        }

        function onPaymentMethodChange() {
            const method = document.getElementById('checkoutPaymentMethod')?.value || '';
            const paymentDisplay = document.getElementById('paymentNumberDisplay');
            const walletMethods = ['ewallet', 'easywallet', 'bluewallet', 'mobimoney', 'paytocell'];
            if (paymentDisplay) {
                if (walletMethods.includes(method)) {
                    paymentDisplay.style.display = 'block';
                } else {
                    paymentDisplay.style.display = 'none';
                }
            }
        }

        function populateCheckoutBranch() {
            const select = document.getElementById('checkoutBranch');
            if (!select) return;
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Branch';
            select.appendChild(defaultOption);
            try {
                if (Array.isArray(branches) && branches.length > 0) {
                    branches.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b.id || b.name || '';
                        opt.textContent = b.name || b.id || '';
                        select.appendChild(opt);
                    });
                    // Preselect from currentBranch if available
                    try {
                        if (currentBranch) {
                            select.value = currentBranch;
                        }
                    } catch (_) {}
                } else {
                    // Fallback static list if branches not loaded
                    ['TOWNSHOP','KHOMASDAL','KATIMA','OUTAPI','ONDANGWA','OKONGO','OKAHAO','NKURENKURU','SWAKOPMUND','HOCHLAND PARK','RUNDU','GOBABIS','WALVISBAY','EENHANA','OTJIWARONGO']
                        .forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name.toLowerCase().replace(/\s+/g,'-');
                            opt.textContent = name;
                            select.appendChild(opt);
                        });
                }
            } catch (e) {
                // ignore
            }
        }

        function applyDefaultReferral() {
            const defaultReferral = { name: 'Dynapharm Namibia', nb: 'NB005676' };
            const refNameEl = document.getElementById('checkoutReferralName');
            const refNBEl = document.getElementById('checkoutReferralNB');
            if (refNameEl && !refNameEl.value) refNameEl.value = defaultReferral.name;
            if (refNBEl && !refNBEl.value) refNBEl.value = defaultReferral.nb;
        }

        function validateDistributorNB(nb) {
            if (!nb || !/^NB[0-9]+$/.test(nb)) return false;
            try {
                // distributors may be loaded globally by loadDistributors()
                const all = Array.isArray(distributors) ? distributors : [];
                return all.some(d => (d.DRN || d.NB || d.nb || '').toString().toUpperCase() === nb);
            } catch (e) { return false; }
        }
        function showOrderTab(tabName) {
            document.querySelectorAll('.order-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const tabMap = {
                'pending': 'pendingOrders',
                'appointments': 'frontdeskAppointments',
                'fullBodyCheckup': 'frontdeskFullBodyCheckup',
                'clientRegistration': 'frontdeskClientRegistration',
                'payments': 'frontdeskPayments',
                'clientLookup': 'frontdeskClientLookup',
                'delivery': 'frontdeskDelivery',
                'visitors': 'frontdeskVisitors',
                'processing': 'processingOrders',
                'shipped': 'shippedOrders',
                'delivered': 'deliveredOrders',
                'all': 'allOrders',
                'crm': 'frontdeskCRM',
                'documents': 'frontdeskDocuments',
                'notifications': 'frontdeskNotifications',
                'staffComm': 'frontdeskStaffCommunication'
            };
            
            const tabElement = document.getElementById(tabMap[tabName]);
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            if (tabName === 'pending') {
                refreshPendingOrders();
            } else if (tabName === 'appointments') {
                refreshFrontdeskAppointments();
            } else if (tabName === 'fullBodyCheckup') {
                // Initialize Full Body Checkup tab - populate branch select
                const branchSelect = document.getElementById('frontdeskCheckupBranchSelect');
                if (branchSelect && branches && branches.length > 0) {
                    branchSelect.innerHTML = '<option value="">Select Branch</option>';
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id || branch.name;
                        option.textContent = branch.name || branch.id;
                        branchSelect.appendChild(option);
                    });
                }
            } else if (tabName === 'clientRegistration') {
                // Initialize client registration tab
            } else if (tabName === 'payments') {
                refreshFrontDeskPayments();
            } else if (tabName === 'clientLookup') {
                // Initialize client lookup tab
            } else if (tabName === 'delivery') {
                refreshDeliveries();
            } else if (tabName === 'visitors') {
                refreshVisitors();
            } else if (tabName === 'processing') {
                refreshProcessingOrders();
            } else if (tabName === 'shipped') {
                refreshShippedOrders();
            } else if (tabName === 'delivered') {
                refreshDeliveredOrders();
            } else if (tabName === 'all') {
                refreshAllOrders();
            } else if (tabName === 'crm') {
                refreshCRMLeads();
            } else if (tabName === 'documents') {
                try { populateBranchFilterOptions(); } catch(_) {}
                try { renderDocumentLibrary(); } catch(_) {}
                try { ensureDocReminderTimer(); } catch(_) {}
            } else if (tabName === 'notifications') {
                try { renderNotifications(); } catch(_) {}
            } else if (tabName === 'staffComm') {
                renderPortalCommunications('frontdesk');
            }
        }
        
        function refreshFrontdeskAppointments() {
            const listDiv = document.getElementById('frontdeskAppointmentsList');
            if (!listDiv) return;
            
            try {
                const consultAppts = JSON.parse(localStorage.getItem('dyna_consult_appointments') || '[]');
                const branchFilter = document.getElementById('appointmentBranchFilter')?.value || '';
                
                const filtered = consultAppts.filter(a => {
                    if (a.status === 'completed') return false;
                    if (branchFilter && a.branch !== branchFilter) return false;
                    return true;
                });
                
                if (filtered.length === 0) {
                    listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><p>No pending appointments for selected branch.</p></div>';
                    return;
                }
                
                listDiv.innerHTML = filtered.map(a => `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0; color: #2c3e50;">${a.fullName}</h4>
                                <div style="color: #7f8c8d; font-size: 14px; margin-top: 4px;">
                                    ðŸ“… ${a.date} at ${a.time} â€¢ ${a.branch}
                                </div>
                                ${a.clientReference ? `<div style="color: #666; font-size: 12px; margin-top: 4px;">Reference: ${a.clientReference}</div>` : ''}
                            </div>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${a.type || 'Full Body Check-Up'}
                            </span>
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ðŸ“ž ${a.phone || 'N/A'} â€¢ âœ‰ï¸ ${a.email || 'N/A'}
                        </div>
                        ${a.clientForm ? `
                            <div style="margin-top: 12px;">
                                <button class="btn btn-info" onclick="viewFrontdeskClientForm('${a.id}')" style="padding: 6px 12px; font-size: 13px;">
                                    ðŸ“‹ View Full Client Form
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading appointments:', error);
                listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #c41e3a;"><p>Error loading appointments. Please refresh.</p></div>';
            }
        }
        
        function viewFrontdeskClientForm(id) {
            try {
                const consultAppts = JSON.parse(localStorage.getItem('dyna_consult_appointments') || '[]');
                const appt = consultAppts.find(x => x.id === id);
                if (!appt || !appt.clientForm) {
                    alert('Client form data not available');
                    return;
                }
                const cf = appt.clientForm;
                const popup = document.createElement('div');
                popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;overflow-y:auto;padding:40px 20px;';
                popup.innerHTML = `
                    <div style="background:white;border-radius:12px;padding:24px;max-width:800px;margin:0 auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;color:#2c3e50;">Full Body Checkup Form</h2>
                            <button onclick="this.parentElement.parentElement.remove()" style="background:transparent;border:none;color:#666;font-size:28px;cursor:pointer;">&times;</button>
                        </div>
                        <div style="color:#2c3e50;line-height:1.8;">
                            <div style="margin-bottom:16px;"><strong>Client Reference:</strong> ${appt.clientReference || 'N/A'}</div>
                            <div style="margin-bottom:16px;"><strong>Name:</strong> ${cf.fullName || ''}</div>
                            <div style="margin-bottom:16px;"><strong>Phone:</strong> ${cf.phone || ''}</div>
                            <div style="margin-bottom:16px;"><strong>Email:</strong> ${cf.email || ''}</div>
                            ${cf.gender ? `<div style="margin-bottom:16px;"><strong>Gender:</strong> ${cf.gender}</div>` : ''}
                            ${cf.dob ? `<div style="margin-bottom:16px;"><strong>Date of Birth:</strong> ${cf.dob}</div>` : ''}
                            ${cf.age ? `<div style="margin-bottom:16px;"><strong>Age:</strong> ${cf.age}</div>` : ''}
                            ${cf.primaryReason ? `<div style="margin-bottom:16px;"><strong>Primary Reason:</strong> ${cf.primaryReason}</div>` : ''}
                            ${cf.medicalHistory && cf.medicalHistory.length ? `<div style="margin-bottom:16px;"><strong>Medical History:</strong> ${cf.medicalHistory.join(', ')}</div>` : ''}
                            ${cf.currentMedications ? `<div style="margin-bottom:16px;"><strong>Current Medications:</strong> ${cf.currentMedications}</div>` : ''}
                            ${cf.supplements ? `<div style="margin-bottom:16px;"><strong>Supplements:</strong> ${cf.supplements}</div>` : ''}
                            ${cf.exerciseFreq ? `<div style="margin-bottom:16px;"><strong>Exercise Frequency:</strong> ${cf.exerciseFreq}</div>` : ''}
                            ${cf.sleepHours ? `<div style="margin-bottom:16px;"><strong>Sleep Hours:</strong> ${cf.sleepHours}</div>` : ''}
                            ${cf.waterIntake ? `<div style="margin-bottom:16px;"><strong>Water Intake:</strong> ${cf.waterIntake}</div>` : ''}
                            ${cf.familyHistory && cf.familyHistory.length ? `<div style="margin-bottom:16px;"><strong>Family History:</strong> ${cf.familyHistory.join(', ')}</div>` : ''}
                        </div>
                        <div style="margin-top:24px;text-align:center;">
                            <button onclick="this.closest('div[style*=\\"position:fixed\\"]').remove()" class="btn" style="background:#0b5aa0;color:white;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(popup);
            } catch (error) {
                console.error('Error viewing client form:', error);
                alert('Error loading client form data');
            }
        }
        
        function refreshPendingOrders() {
            const orders = onlineOrders.filter(o => o.status === 'pending');
            displayOrders(orders, 'pendingOrdersList');
        }
        
        function refreshProcessingOrders() {
            const orders = onlineOrders.filter(o => o.status === 'processing');
            displayOrders(orders, 'processingOrdersList');
        }
        
        function refreshShippedOrders() {
            const orders = onlineOrders.filter(o => o.status === 'shipped');
            displayOrders(orders, 'shippedOrdersList');
        }
        
        function refreshDeliveredOrders() {
            const orders = onlineOrders.filter(o => o.status === 'delivered');
            displayOrders(orders, 'deliveredOrdersList');
        }
        
        function refreshAllOrders() {
            displayOrders(onlineOrders, 'allOrdersList');
        }
        
        function displayOrders(orders, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">No orders found</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusColors = {
                    'pending': '#e74c3c',
                    'processing': '#f39c12',
                    'shipped': '#3498db',
                    'delivered': '#27ae60'
                };
                
                const statusLabels = {
                    'pending': 'â³ Pending',
                    'processing': 'ðŸ”„ Processing',
                    'shipped': 'ðŸšš Shipped',
                    'delivered': 'âœ… Delivered'
                };
                
                return `
                    <div style="background: white; border: 2px solid ${statusColors[order.status]}; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: #2c3e50; margin-bottom: 5px;">Order #${order.id} ${order.receiptNo ? `&middot; Receipt: ${order.receiptNo}` : ''}</h4>
                                <p style="color: #666; font-size: 0.9rem;">${order.date} ${order.branch ? `&middot; Branch: ${order.branch}` : ''} ${order.source ? `&middot; Source: ${order.source}` : ''}</p>
                            </div>
                            <span style="background: ${statusColors[order.status]}; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                ${statusLabels[order.status]}
                            </span>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <p><strong>Customer:</strong> ${order.customerName}</p>
                            <p><strong>Phone:</strong> ${order.customerPhone}</p>
                            <p><strong>Email:</strong> ${order.customerEmail}</p>
                            <p><strong>Address:</strong> ${order.customerAddress}</p>
                            <p><strong>Payment:</strong> ${order.paymentMethod.toUpperCase()} ${order.paymentNumber ? `(${order.paymentNumber})` : ''}</p>
                            ${order.customerType ? `<p><strong>Customer Type:</strong> ${order.customerType === 'distributor' ? 'Distributor (DP)' : 'Customer (CP)'}</p>` : ''}
                            ${order.referral ? `<p><strong>Referral:</strong> ${order.referral.name} (${order.referral.nb})</p>` : ''}
                            ${order.distributorNB ? `<p><strong>Distributor NB:</strong> ${order.distributorNB}</p>` : ''}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <strong>Items:</strong>
                            ${order.items.map(item => `
                                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                    <span>${item.name} x ${item.quantity}</span>
                                    <span>N$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                            <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>Total:</span>
                                <span style="color: #c41e3a; font-size: 1.2rem;">N$${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${order.status === 'pending' ? '<button class="btn btn-success" onclick="updateOrderStatus(\'' + order.id + '\', \'processing\')">Start Processing</button>' : ''}
                            ${order.status === 'processing' ? '<button class="btn btn-info" onclick="updateOrderStatus(\'' + order.id + '\', \'shipped\')">Mark as Shipped</button>' : ''}
                            ${order.status === 'shipped' ? '<button class="btn btn-success" onclick="updateOrderStatus(\'' + order.id + '\', \'delivered\')">Mark as Delivered</button>' : ''}
                            ${order.saleCreated && order.receiptNo ? '<button class="btn btn-info" onclick="viewSaleByReceipt(\'' + order.receiptNo + '\')">View Sales Record</button>' : ''}
                            <button class="btn" onclick="viewOrderDetails('${order.id}')">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderStatus(orderId, newStatus) {
            const order = onlineOrders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                order.updatedAt = new Date().toISOString();
                
                // When order is delivered, create sales record for Dispenser Portal and update stock
                if (newStatus === 'delivered' && !order.saleCreated) {
                    createSaleFromOrder(order);
                    order.saleCreated = true;
                }
                
                localStorage.setItem('dyna_online_orders', JSON.stringify(onlineOrders));
                
                // Refresh current view
                const activeTab = document.querySelector('.tabs button.active');
                if (activeTab) {
                    activeTab.click();
                }
                
                alert(`Order ${orderId} status updated to ${newStatus}${newStatus === 'delivered' ? ' - Sales record created' : ''}`);
            }
        }

        // ==========================
        // Front Desk CRM Workflow
        // ==========================
        let crmLeads = [];
        (function loadCRMData(){
            try { crmLeads = JSON.parse(localStorage.getItem('dyna_crm_leads') || '[]'); } catch (e) { crmLeads = []; }
        })();

        function persistCRM() {
            try { localStorage.setItem('dyna_crm_leads', JSON.stringify(crmLeads)); } catch (e) {}
        }

        function addCRMLead() {
            const name = document.getElementById('crmLeadName')?.value?.trim();
            const phone = document.getElementById('crmLeadPhone')?.value?.trim();
            const email = document.getElementById('crmLeadEmail')?.value?.trim();
            const interest = document.getElementById('crmLeadInterest')?.value?.trim();
            const followUp = document.getElementById('crmLeadFollowUp')?.value || '';
            if (!name) { alert('Please enter lead name'); return; }
            const lead = {
                id: 'LEAD-' + Date.now(),
                name, phone, email, interest,
                status: 'new',
                createdAt: new Date().toISOString(),
                nextFollowUp: followUp || null,
                assignedTo: (currentUser && currentUser.fullName) || 'Front Desk',
                branch: (currentUser && currentUser.branch) || currentBranch || ''
            };
            crmLeads.push(lead);
            persistCRM();
            try { recordDepartmentEvent('crm_lead_created', lead); } catch (e) {}
            refreshCRMLeads();
            alert('Lead added');
        }

        function updateCRMLeadStatus(leadId, newStatus) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            lead.status = newStatus;
            lead.updatedAt = new Date().toISOString();
            persistCRM();
            try { recordDepartmentEvent('crm_lead_status', { id: leadId, status: newStatus }); } catch (e) {}
            refreshCRMLeads();
        }

        function convertLeadToOrder(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            // Create a minimal pending order draft for Front Desk
            const order = {
                id: 'WEB' + Date.now(),
                date: new Date().toISOString().split('T')[0],
                status: 'pending',
                customerName: lead.name,
                customerPhone: lead.phone || '',
                customerEmail: lead.email || '',
                customerAddress: '',
                paymentMethod: 'cash',
                customerType: 'customer',
                items: [],
                total: 0,
                source: 'crm',
                branch: (currentUser && currentUser.branch) || currentBranch || ''
            };
            onlineOrders.push(order);
            try { localStorage.setItem('dyna_online_orders', JSON.stringify(onlineOrders)); } catch (e) {}
            updateCRMLeadStatus(leadId, 'converted');
            try { recordDepartmentEvent('crm_lead_converted', { leadId, orderId: order.id }); } catch (e) {}
            alert('Lead converted to pending order #' + order.id);
        }

        function refreshCRMLeads() {
            const container = document.getElementById('crmLeadsList');
            if (!container) return;
            const list = (Array.isArray(crmLeads) ? crmLeads : []).slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#7f8c8d;">No leads yet.</p>';
                return;
            }
            container.innerHTML = list.map(lead => `
                <div style="background:white; border:2px solid #ddd; border-left-color:${lead.status==='converted'?'#27ae60':(lead.status==='followup'?'#f39c12':'#3498db')}; border-radius:8px; padding:12px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <strong>${lead.name}</strong>
                            <div style="color:#666; font-size:0.9rem;">${lead.phone||''} ${lead.email? ' | '+lead.email: ''}</div>
                            ${lead.interest ? `<div style="color:#666; font-size:0.9rem;">Interest: ${lead.interest}</div>` : ''}
                            ${lead.nextFollowUp ? `<div style=\"color:#f39c12; font-size:0.85rem;\">Next follow-up: ${lead.nextFollowUp}</div>` : ''}
                        </div>
                        <span class="pill" style="background:${lead.status==='converted'?'#27ae60':'#3498db'}; color:white; padding:4px 10px; border-radius:20px; font-size:0.8rem;">${lead.status.toUpperCase()}</span>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="updateCRMLeadStatus('${lead.id}','followup')">ðŸ“… Mark Follow-up</button>
                        <button class="btn btn-success" onclick="convertLeadToOrder('${lead.id}')">ðŸ›’ Convert to Order</button>
                    </div>
                </div>
            `).join('');
        }

        function openMISFromCRM() {
            window.open('mis-portal.html', '_blank');
        }

        // ==========================
        // Front Desk CRM Advanced Tabs
        // ==========================
        let fdcrmInteractions = []; let fdcrmSegments = []; let fdcrmWorkflows = [];
        (function fdcrmLoad(){
            try { fdcrmInteractions = JSON.parse(localStorage.getItem('dyna_crm_interactions') || '[]'); } catch(e) { fdcrmInteractions = []; }
            try { fdcrmSegments = JSON.parse(localStorage.getItem('dyna_crm_segments') || '[]'); } catch(e) { fdcrmSegments = []; }
            try { fdcrmWorkflows = JSON.parse(localStorage.getItem('dyna_crm_workflows') || '[]'); } catch(e) { fdcrmWorkflows = []; }
        })();

        function showFrontdeskCRMTab(name) {
            const map = { comm: 'fdcrm-comm', segments: 'fdcrm-segments', workflows: 'fdcrm-workflows', loyalty: 'fdcrm-loyalty' };
            Object.values(map).forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
            document.querySelectorAll('#frontdeskCRM .tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const target = document.getElementById(map[name]); if (target) target.style.display = 'block';
            if (name === 'comm') fdcrmRefreshInteractions();
            if (name === 'segments') fdcrmRefreshSegments();
            if (name === 'workflows') fdcrmRefreshWorkflows();
            if (name === 'loyalty') fdcrmRefreshLoyalty();
        }

        function fdcrmPersist() {
            try { localStorage.setItem('dyna_crm_interactions', JSON.stringify(fdcrmInteractions)); } catch(e) {}
            try { localStorage.setItem('dyna_crm_segments', JSON.stringify(fdcrmSegments)); } catch(e) {}
            try { localStorage.setItem('dyna_crm_workflows', JSON.stringify(fdcrmWorkflows)); } catch(e) {}
        }

        // Communication
        function fdcrmAddInteraction() {
            const client = document.getElementById('fdcrmCommClient')?.value?.trim() || '';
            const channel = document.getElementById('fdcrmCommChannel')?.value || 'call';
            const note = document.getElementById('fdcrmCommNote')?.value?.trim() || '';
            if (!client && !note) { alert('Add a client or a note.'); return; }
            fdcrmInteractions.push({ id: 'CM-' + Date.now(), client, channel, note, createdAt: new Date().toISOString(), by: (currentUser && currentUser.fullName) || 'Front Desk' });
            fdcrmPersist(); fdcrmRefreshInteractions();
        }
        function fdcrmRefreshInteractions() {
            const el = document.getElementById('fdcrmCommList'); if (!el) return;
            const list = fdcrmInteractions.slice().sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
            if (list.length === 0) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No interactions yet.</p>'; return; }
            el.innerHTML = list.map(i => `
                <div style="border:1px solid #ddd;border-left:4px solid #c41e3a;border-radius:6px;padding:10px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;">
                        <strong>${i.client || 'Unknown'}</strong>
                        <span style="font-size:0.85rem;color:#666;">${new Date(i.createdAt).toLocaleString()}</span>
                    </div>
                    <div style="font-size:0.9rem;color:#333;">${i.channel.toUpperCase()} - ${i.note || ''}</div>
                </div>`).join('');
        }

        // Segmentation
        function fdcrmCreateSegment() {
            const name = document.getElementById('fdcrmSegName')?.value?.trim();
            const rule = document.getElementById('fdcrmSegRule')?.value;
            if (!name) { alert('Enter segment name'); return; }
            fdcrmSegments.push({ id: 'SEG-' + Date.now(), name, rule, createdAt: new Date().toISOString() });
            fdcrmPersist(); fdcrmRefreshSegments();
        }
        function fdcrmRefreshSegments() {
            const el = document.getElementById('fdcrmSegList'); if (!el) return;
            if (fdcrmSegments.length === 0) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No segments defined.</p>'; return; }
            el.innerHTML = fdcrmSegments.map(s => `
                <div style="border:1px solid #ddd;border-left:4px solid #27ae60;border-radius:6px;padding:10px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong>${s.name}</strong>
                        <span style="font-size:0.8rem;color:#666;">${s.rule}</span>
                    </div>
                    <div style="margin-top:6px;display:flex;gap:8px;">
                        <button class="btn btn-info" onclick="fdcrmPreviewSegment('${s.id}')">ðŸ‘ï¸ Preview Members</button>
                    </div>
                </div>`).join('');
        }
        function fdcrmPreviewSegment(segId) {
            const s = fdcrmSegments.find(x=>x.id===segId); if (!s) return;
            const members = fdcrmComputeSegmentMembers(s.rule);
            alert(`Segment: ${s.name}\nMembers: ${members.slice(0,10).join(', ')}${members.length>10?' ...':''}\nTotal: ${members.length}`);
        }
        function fdcrmComputeSegmentMembers(rule) {
            const names = new Set();
            try {
                const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
                const now = new Date();
                if (rule === 'bv_1000') {
                    sales.forEach(s=>{ if ((s.totalBV||0) >= 1000) names.add(s.customerName||'Unknown'); });
                } else if (rule === 'purchases_3m') {
                    const cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth()-3);
                    const counts = {};
                    sales.forEach(s=>{ const ts = new Date(s.timestamp||s.date||0); if (ts>=cutoff) { const n=(s.customerName||'Unknown'); counts[n]=(counts[n]||0)+1; }});
                    Object.keys(counts).forEach(n=>{ if (counts[n] >= 3) names.add(n); });
                } else if (rule === 'no_purchase_60d') {
                    const cutoff = new Date(now); cutoff.setDate(cutoff.getDate()-60);
                    const last = {};
                    sales.forEach(s=>{ const n=(s.customerName||'Unknown'); const ts = new Date(s.timestamp||s.date||0); if (!last[n] || ts>last[n]) last[n]=ts; });
                    Object.keys(last).forEach(n=>{ if (last[n] < cutoff) names.add(n); });
                }
            } catch(e) {}
            return Array.from(names);
        }

        // Workflows (simple registry)
        function fdcrmCreateWorkflow() {
            const trigger = document.getElementById('fdcrmWfTrigger')?.value;
            const action = document.getElementById('fdcrmWfAction')?.value;
            fdcrmWorkflows.push({ id: 'WF-' + Date.now(), trigger, action, createdAt: new Date().toISOString() });
            fdcrmPersist(); fdcrmRefreshWorkflows();
            alert('Workflow created');
        }
        function fdcrmRefreshWorkflows() {
            const el = document.getElementById('fdcrmWfList'); if (!el) return;
            if (fdcrmWorkflows.length === 0) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No workflows defined.</p>'; return; }
            el.innerHTML = fdcrmWorkflows.map(w => `
                <div style="border:1px solid #ddd;border-left:4px solid #9b59b6;border-radius:6px;padding:10px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong>${w.trigger}</strong>
                        <span style="font-size:0.8rem;color:#666;">${w.action}</span>
                    </div>
                </div>`).join('');
        }
        // Hook into existing lead created event to demo workflow execution
        const _fdAddCRMLead = addCRMLead;
        addCRMLead = function() {
            _fdAddCRMLead();
            try {
                const actions = fdcrmWorkflows.filter(w=>w.trigger==='lead_created').map(w=>w.action);
                if (actions.includes('send_sms')) console.log('[CRM WF] Sending SMS for new lead');
                if (actions.includes('send_email')) console.log('[CRM WF] Sending Email for new lead');
                if (actions.includes('create_task')) console.log('[CRM WF] Creating Follow-up Task for new lead');
            } catch(e) {}
        };
        
        // ==========================
        // Front Desk New Tab Functions
        // ==========================
        
        // Client Registration Functions
        function registerFrontDeskClient() {
            const name = document.getElementById('fdClientName')?.value?.trim();
            const phone = document.getElementById('fdClientPhone')?.value?.trim();
            const email = document.getElementById('fdClientEmail')?.value?.trim();
            const dob = document.getElementById('fdClientDOB')?.value;
            const idNumber = document.getElementById('fdClientID')?.value?.trim();
            const address = document.getElementById('fdClientAddress')?.value?.trim();
            const referral = document.getElementById('fdClientReferral')?.value?.trim().toUpperCase();
            
            if (!name || !phone) {
                alert('Please enter full name and phone number');
                return;
            }
            
            // Check if client already exists
            const existingClients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
            const existing = existingClients.find(c => 
                (c.phone === phone) || (c.fullName?.toLowerCase() === name.toLowerCase())
            );
            
            if (existing) {
                if (confirm('Client already exists. Do you want to update their information?')) {
                    existing.fullName = name;
                    existing.email = email || existing.email;
                    existing.dob = dob || existing.dob;
                    existing.idNumber = idNumber || existing.idNumber;
                    existing.address = address || existing.address;
                    existing.referralNbNumber = referral || existing.referralNbNumber;
                    existing.updatedAt = new Date().toISOString();
                    localStorage.setItem('dyna_clients', JSON.stringify(existingClients));
                    document.getElementById('fdClientRegistrationResult').innerHTML = 
                        '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">âœ… Client information updated successfully!</div>';
                    clearFrontDeskClientForm();
                    return;
                } else {
                    return;
                }
            }
            
            const newClient = {
                id: 'CLI-' + Date.now(),
                fullName: name,
                phone: phone,
                email: email || '',
                dob: dob || '',
                idNumber: idNumber || '',
                address: address || '',
                referralNbNumber: referral || '',
                createdAt: new Date().toISOString(),
                branch: (currentUser && currentUser.branch) || currentBranch || ''
            };
            
            existingClients.push(newClient);
            localStorage.setItem('dyna_clients', JSON.stringify(existingClients));
            document.getElementById('fdClientRegistrationResult').innerHTML = 
                '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">âœ… Client registered successfully! Client ID: ' + newClient.id + '</div>';
            clearFrontDeskClientForm();
            try { recordDepartmentEvent && recordDepartmentEvent('client_registered', newClient); } catch (e) {}
        }
        
        function checkExistingClient() {
            const phone = document.getElementById('fdClientPhone')?.value?.trim();
            const name = document.getElementById('fdClientName')?.value?.trim();
            
            if (!phone && !name) {
                alert('Please enter phone number or name to search');
                return;
            }
            
            const clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
            const found = clients.find(c => 
                (phone && c.phone === phone) || (name && c.fullName?.toLowerCase().includes(name.toLowerCase()))
            );
            
            if (found) {
                document.getElementById('fdClientRegistrationResult').innerHTML = 
                    `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px;">
                        <strong>Client Found:</strong><br>
                        Name: ${found.fullName}<br>
                        Phone: ${found.phone}<br>
                        Email: ${found.email || 'N/A'}<br>
                        Client ID: ${found.id}
                    </div>`;
            } else {
                document.getElementById('fdClientRegistrationResult').innerHTML = 
                    '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">âŒ Client not found. You can proceed with registration.</div>';
            }
        }
        
        function clearFrontDeskClientForm() {
            document.getElementById('fdClientName').value = '';
            document.getElementById('fdClientPhone').value = '';
            document.getElementById('fdClientEmail').value = '';
            document.getElementById('fdClientDOB').value = '';
            document.getElementById('fdClientID').value = '';
            document.getElementById('fdClientAddress').value = '';
            document.getElementById('fdClientReferral').value = '';
        }
        
        // Payment Collection Functions
        function lookupOrderForPayment() {
            const orderID = document.getElementById('fdPaymentOrderID')?.value?.trim();
            if (!orderID) {
                alert('Please enter an Order ID');
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
            const order = orders.find(o => o.id === orderID);
            
            if (order) {
                document.getElementById('fdPaymentCustomer').value = order.customerName || '';
                document.getElementById('fdPaymentAmount').value = order.total || 0;
            } else {
                // Try to find in walk-in sales
                const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
                const sale = sales.find(s => s.id === orderID || s.invoiceNumber === orderID);
                if (sale) {
                    document.getElementById('fdPaymentCustomer').value = sale.customerName || '';
                    document.getElementById('fdPaymentAmount').value = sale.total || 0;
                } else {
                    alert('Order not found');
                }
            }
        }
        
        function processFrontDeskPayment() {
            const orderID = document.getElementById('fdPaymentOrderID')?.value?.trim();
            const method = document.getElementById('fdPaymentMethod')?.value;
            const amountPaid = parseFloat(document.getElementById('fdPaymentPaid')?.value || 0);
            const reference = document.getElementById('fdPaymentReference')?.value?.trim();
            
            if (!orderID || !method || !amountPaid) {
                alert('Please fill in all required fields');
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
            const order = orders.find(o => o.id === orderID);
            
            if (order) {
                order.paymentStatus = 'paid';
                order.paymentMethod = method;
                order.paymentAmount = amountPaid;
                order.paymentReference = reference;
                order.paymentDate = new Date().toISOString();
                order.status = 'paid';
                localStorage.setItem('dyna_online_orders', JSON.stringify(orders));
                
                document.getElementById('fdPaymentResult').innerHTML = 
                    '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">âœ… Payment processed successfully!</div>';
                clearPaymentForm();
                refreshFrontDeskPayments();
                try { recordDepartmentEvent && recordDepartmentEvent('payment_collected', { orderID, method, amount: amountPaid }); } catch (e) {}
            } else {
                alert('Order not found');
            }
        }
        
        function clearPaymentForm() {
            document.getElementById('fdPaymentOrderID').value = '';
            document.getElementById('fdPaymentCustomer').value = '';
            document.getElementById('fdPaymentAmount').value = '';
            document.getElementById('fdPaymentMethod').value = '';
            document.getElementById('fdPaymentPaid').value = '';
            document.getElementById('fdPaymentReference').value = '';
        }
        
        function refreshFrontDeskPayments() {
            const container = document.getElementById('fdPaymentsList');
            if (!container) return;
            
            const orders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
            const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            const allPayments = [
                ...orders.filter(o => o.paymentStatus === 'paid').map(o => ({
                    id: o.id,
                    customer: o.customerName,
                    amount: o.paymentAmount || o.total,
                    method: o.paymentMethod,
                    date: o.paymentDate || o.date,
                    type: 'Online Order'
                })),
                ...sales.filter(s => s.paymentStatus === 'paid' || s.paid).map(s => ({
                    id: s.id || s.invoiceNumber,
                    customer: s.customerName,
                    amount: s.total || s.amountPaid,
                    method: s.paymentMethod || 'cash',
                    date: s.timestamp || s.date,
                    type: 'Walk-in Sale'
                }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allPayments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No payments found</p>';
                return;
            }
            
            container.innerHTML = allPayments.slice(0, 50).map(p => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${p.customer}</strong><br>
                            <small style="color: #666;">${p.id} - ${p.type}</small><br>
                            <small style="color: #666;">${new Date(p.date).toLocaleDateString()}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong style="color: #27ae60;">N$ ${parseFloat(p.amount).toFixed(2)}</strong><br>
                            <small style="color: #666;">${p.method}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Client Lookup Functions
        function updateLookupFields() {
            const type = document.getElementById('fdLookupType')?.value;
            const placeholder = {
                'name': 'Enter client name',
                'phone': 'Enter phone number',
                'email': 'Enter email address',
                'id': 'Enter ID number',
                'order': 'Enter Order ID'
            }[type] || 'Enter search term';
            document.getElementById('fdLookupTerm').placeholder = placeholder;
        }
        
        function performClientLookup() {
            const type = document.getElementById('fdLookupType')?.value;
            const term = document.getElementById('fdLookupTerm')?.value?.trim().toLowerCase();
            
            if (!term) {
                alert('Please enter a search term');
                return;
            }
            
            const clients = JSON.parse(localStorage.getItem('dyna_clients') || '[]');
            const orders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
            const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
            
            let results = [];
            
            if (type === 'name') {
                results = clients.filter(c => (c.fullName || '').toLowerCase().includes(term));
            } else if (type === 'phone') {
                results = clients.filter(c => (c.phone || '').includes(term));
            } else if (type === 'email') {
                results = clients.filter(c => (c.email || '').toLowerCase().includes(term));
            } else if (type === 'id') {
                results = clients.filter(c => (c.idNumber || '').includes(term));
            } else if (type === 'order') {
                const order = orders.find(o => o.id === term.toUpperCase()) || sales.find(s => s.id === term.toUpperCase() || s.invoiceNumber === term.toUpperCase());
                if (order) {
                    results = [order];
                }
            }
            
            displayLookupResults(results, type);
        }
        
        function displayLookupResults(results, type) {
            const container = document.getElementById('fdLookupResults');
            if (!container) return;
            
            if (results.length === 0) {
                container.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; text-align: center;">No results found</div>';
                return;
            }
            
            if (type === 'order') {
                const order = results[0];
                container.innerHTML = `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #f8f9fa;">
                        <h4>Order Information</h4>
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Customer:</strong> ${order.customerName || 'N/A'}</p>
                        <p><strong>Total:</strong> N$ ${parseFloat(order.total || 0).toFixed(2)}</p>
                        <p><strong>Status:</strong> ${order.status || 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(order.date || order.timestamp).toLocaleDateString()}</p>
                    </div>
                `;
            } else {
                container.innerHTML = results.map(client => `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <h4>${client.fullName}</h4>
                        <p><strong>Phone:</strong> ${client.phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${client.email || 'N/A'}</p>
                        <p><strong>ID Number:</strong> ${client.idNumber || 'N/A'}</p>
                        <p><strong>Address:</strong> ${client.address || 'N/A'}</p>
                        <p><strong>Client ID:</strong> ${client.id}</p>
                        ${client.referralNbNumber ? `<p><strong>Referral NB:</strong> ${client.referralNbNumber}</p>` : ''}
                    </div>
                `).join('');
            }
        }
        
        function clearLookupResults() {
            document.getElementById('fdLookupTerm').value = '';
            document.getElementById('fdLookupResults').innerHTML = '';
        }
        
        // Delivery Scheduling Functions
        function lookupOrderForDelivery() {
            lookupOrderForPayment(); // Reuse payment lookup logic
            const orderID = document.getElementById('fdPaymentOrderID')?.value?.trim();
            if (orderID) {
                document.getElementById('fdDeliveryOrderID').value = orderID;
                const orders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
                const order = orders.find(o => o.id === orderID);
                if (order) {
                    document.getElementById('fdDeliveryCustomer').value = order.customerName || '';
                    document.getElementById('fdDeliveryAddress').value = order.customerAddress || '';
                    document.getElementById('fdDeliveryPhone').value = order.customerPhone || '';
                }
            }
        }
        
        function scheduleDelivery() {
            const orderID = document.getElementById('fdDeliveryOrderID')?.value?.trim();
            const date = document.getElementById('fdDeliveryDate')?.value;
            const time = document.getElementById('fdDeliveryTime')?.value;
            const method = document.getElementById('fdDeliveryMethod')?.value;
            const notes = document.getElementById('fdDeliveryNotes')?.value?.trim();
            
            if (!orderID || !date) {
                alert('Please enter Order ID and Delivery Date');
                return;
            }
            
            const deliveries = JSON.parse(localStorage.getItem('dyna_deliveries') || '[]');
            const delivery = {
                id: 'DEL-' + Date.now(),
                orderID: orderID,
                customerName: document.getElementById('fdDeliveryCustomer')?.value || '',
                address: document.getElementById('fdDeliveryAddress')?.value || '',
                phone: document.getElementById('fdDeliveryPhone')?.value || '',
                date: date,
                time: time || '',
                method: method || 'standard',
                notes: notes || '',
                status: 'scheduled',
                createdAt: new Date().toISOString(),
                branch: (currentUser && currentUser.branch) || currentBranch || ''
            };
            
            deliveries.push(delivery);
            localStorage.setItem('dyna_deliveries', JSON.stringify(deliveries));
            
            document.getElementById('fdDeliveryResult').innerHTML = 
                '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">âœ… Delivery scheduled successfully! Delivery ID: ' + delivery.id + '</div>';
            clearDeliveryForm();
            refreshDeliveries();
            try { recordDepartmentEvent && recordDepartmentEvent('delivery_scheduled', delivery); } catch (e) {}
        }
        
        function clearDeliveryForm() {
            document.getElementById('fdDeliveryOrderID').value = '';
            document.getElementById('fdDeliveryCustomer').value = '';
            document.getElementById('fdDeliveryAddress').value = '';
            document.getElementById('fdDeliveryDate').value = '';
            document.getElementById('fdDeliveryTime').value = '';
            document.getElementById('fdDeliveryMethod').value = 'standard';
            document.getElementById('fdDeliveryNotes').value = '';
            document.getElementById('fdDeliveryPhone').value = '';
        }
        
        function refreshDeliveries() {
            const container = document.getElementById('fdDeliveriesList');
            if (!container) return;
            
            const statusFilter = document.getElementById('fdDeliveryStatusFilter')?.value || 'all';
            let deliveries = JSON.parse(localStorage.getItem('dyna_deliveries') || '[]');
            
            if (statusFilter !== 'all') {
                deliveries = deliveries.filter(d => d.status === statusFilter);
            }
            
            deliveries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (deliveries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No deliveries found</p>';
                return;
            }
            
            container.innerHTML = deliveries.map(d => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${d.customerName}</strong><br>
                            <small style="color: #666;">Order: ${d.orderID}</small><br>
                            <small style="color: #666;">${d.address}</small><br>
                            <small style="color: #666;">${new Date(d.date).toLocaleDateString()} ${d.time || ''}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${d.status === 'delivered' ? '#d4edda' : d.status === 'in_transit' ? '#d1ecf1' : '#fff3cd'}; 
                                       color: ${d.status === 'delivered' ? '#155724' : d.status === 'in_transit' ? '#0c5460' : '#856404'}; 
                                       padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">
                                ${d.status}
                            </span><br>
                            <small style="color: #666;">${d.method}</small>
                        </div>
                    </div>
                    ${d.notes ? `<p style="margin-top: 10px; color: #666; font-size: 0.9rem;"><em>${d.notes}</em></p>` : ''}
                </div>
            `).join('');
        }
        
        // Visitor Management Functions
        function registerVisitor() {
            const name = document.getElementById('fdVisitorName')?.value?.trim();
            const phone = document.getElementById('fdVisitorPhone')?.value?.trim();
            const purpose = document.getElementById('fdVisitorPurpose')?.value;
            const contact = document.getElementById('fdVisitorContact')?.value?.trim();
            const notes = document.getElementById('fdVisitorNotes')?.value?.trim();
            
            if (!name || !purpose) {
                alert('Please enter visitor name and purpose of visit');
                return;
            }
            
            const visitors = JSON.parse(localStorage.getItem('dyna_visitors') || '[]');
            const visitor = {
                id: 'VIS-' + Date.now(),
                name: name,
                phone: phone || '',
                purpose: purpose,
                contact: contact || '',
                notes: notes || '',
                checkInTime: new Date().toISOString(),
                checkOutTime: null,
                status: 'checked_in',
                branch: (currentUser && currentUser.branch) || currentBranch || ''
            };
            
            visitors.push(visitor);
            localStorage.setItem('dyna_visitors', JSON.stringify(visitors));
            
            document.getElementById('fdVisitorResult').innerHTML = 
                '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">âœ… Visitor registered successfully!</div>';
            clearVisitorForm();
            refreshVisitors();
            try { recordDepartmentEvent && recordDepartmentEvent('visitor_registered', visitor); } catch (e) {}
        }
        
        function clearVisitorForm() {
            document.getElementById('fdVisitorName').value = '';
            document.getElementById('fdVisitorPhone').value = '';
            document.getElementById('fdVisitorPurpose').value = '';
            document.getElementById('fdVisitorContact').value = '';
            document.getElementById('fdVisitorNotes').value = '';
        }
        
        function refreshVisitors() {
            const container = document.getElementById('fdVisitorsList');
            if (!container) return;
            
            const searchTerm = (document.getElementById('fdVisitorSearch')?.value || '').toLowerCase();
            let visitors = JSON.parse(localStorage.getItem('dyna_visitors') || '[]');
            
            // Filter by today
            const today = new Date().toISOString().split('T')[0];
            visitors = visitors.filter(v => v.checkInTime.startsWith(today));
            
            // Filter by search term
            if (searchTerm) {
                visitors = visitors.filter(v => 
                    (v.name || '').toLowerCase().includes(searchTerm) ||
                    (v.phone || '').includes(searchTerm) ||
                    (v.purpose || '').toLowerCase().includes(searchTerm)
                );
            }
            
            visitors.sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime));
            
            if (visitors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No visitors found for today</p>';
                return;
            }
            
            container.innerHTML = visitors.map(v => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${v.name}</strong><br>
                            <small style="color: #666;">${v.phone || 'No phone'}</small><br>
                            <small style="color: #666;">Purpose: ${v.purpose}</small><br>
                            ${v.contact ? `<small style="color: #666;">Visiting: ${v.contact}</small><br>` : ''}
                            <small style="color: #666;">${new Date(v.checkInTime).toLocaleTimeString()}</small>
                        </div>
                        <div>
                            <span style="background: ${v.status === 'checked_out' ? '#d4edda' : '#d1ecf1'}; 
                                       color: ${v.status === 'checked_out' ? '#155724' : '#0c5460'}; 
                                       padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">
                                ${v.status === 'checked_out' ? 'Checked Out' : 'Checked In'}
                            </span>
                        </div>
                    </div>
                    ${v.notes ? `<p style="margin-top: 10px; color: #666; font-size: 0.9rem;"><em>${v.notes}</em></p>` : ''}
                </div>
            `).join('');
        }

        // Loyalty (approx using sales and BV)
        function fdcrmRefreshLoyalty() {
            const el = document.getElementById('fdcrmLoyaltyList'); if (!el) return;
            try {
                const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
                const totals = {};
                sales.forEach(s=>{ const n=s.customerName||'Unknown'; totals[n]=(totals[n]||0)+(s.totalBV||0); });
                const top = Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,20);
                if (top.length===0) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No loyalty data yet.</p>'; return; }
                el.innerHTML = top.map(([name,bv])=>`<div style="display:flex;justify-content:space-between;border:1px solid #eee;padding:8px;border-radius:6px;margin-bottom:6px;"><span>${name}</span><strong style="color:#c41e3a;">BV ${Number(bv).toFixed(0)}</strong></div>`).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No loyalty data.</p>'; }
        }
        
        function createSaleFromOrder(order) {
            try {
                // Get existing sales from localStorage
                const sales = JSON.parse(localStorage.getItem('walkInSales') || '[]');
                
                // Create sale record matching Dispenser Portal format
                const sale = {
                    id: 'SALE' + Date.now(),
                    receiptNo: order.receiptNo || 'WEB' + Date.now(),
                    date: new Date().toISOString(),
                    branch: order.branch || '',
                    source: 'online',
                    orderId: order.id,
                    customerName: order.customerName,
                    customerPhone: order.customerPhone,
                    customerEmail: order.customerEmail,
                    customerType: order.customerType || 'customer',
                    distributorNB: order.distributorNB || null,
                    referral: order.referral || null,
                    items: order.items.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        cp: item.cp,
                        dp: item.dp,
                        bv: item.bv || 0
                    })),
                    total: order.total,
                    paymentMethod: order.paymentMethod,
                    paymentNumber: order.paymentNumber || null,
                    createdBy: currentUser ? currentUser.fullName : 'Front Desk',
                    createdAt: new Date().toISOString()
                };
                
                sales.push(sale);
                localStorage.setItem('walkInSales', JSON.stringify(sales));
                
                // Update stock for the branch if stock management exists
                try {
                    order.items.forEach(item => {
                        updateBranchStock(order.branch, item.name, item.quantity);
                    });
                } catch (e) {
                    console.warn('Stock update failed:', e);
                }
                
                return sale;
            } catch (e) {
                console.error('Error creating sale from order:', e);
                alert('Warning: Order status updated but sales record creation failed: ' + e.message);
            }
        }
        
        function updateBranchStock(branchId, productName, quantity) {
            try {
                // Get branch stock data
                const stockData = JSON.parse(localStorage.getItem('dyna_branch_stock') || '{}');
                const branchKey = branchId || 'default';
                
                if (!stockData[branchKey]) {
                    stockData[branchKey] = {};
                }
                
                if (!stockData[branchKey][productName]) {
                    stockData[branchKey][productName] = 0;
                }
                
                stockData[branchKey][productName] = Math.max(0, (stockData[branchKey][productName] - quantity));
                
                localStorage.setItem('dyna_branch_stock', JSON.stringify(stockData));
            } catch (e) {
                console.warn('Branch stock update failed:', e);
            }
        }
        
        function viewOrderDetails(orderId) {
            const order = onlineOrders.find(o => o.id === orderId);
            if (!order) return;
            
            alert(`Order Details\n\n${JSON.stringify(order, null, 2)}`);
        }
        
        function viewSaleByReceipt(receiptNo) {
            try {
                const sales = JSON.parse(localStorage.getItem('walkInSales') || '[]');
                const sale = sales.find(s => s.receiptNo === receiptNo || s.id === receiptNo);
                
                if (sale) {
                    const saleDetails = `
Sales Record Details

Receipt Number: ${sale.receiptNo}
Date: ${new Date(sale.date).toLocaleString()}
Branch: ${sale.branch || 'N/A'}
Source: ${sale.source || 'Online'}
Customer: ${sale.customerName}
Phone: ${sale.customerPhone}
Customer Type: ${sale.customerType}
Total: N$${sale.total.toFixed(2)}
Payment: ${sale.paymentMethod?.toUpperCase() || 'N/A'}
${sale.paymentNumber ? `Payment Number: ${sale.paymentNumber}` : ''}

Items:
${sale.items?.map(item => `  - ${item.name} x ${item.quantity} = N$${(item.price * item.quantity).toFixed(2)}`).join('\n') || 'No items'}

This sale appears in the Dispenser Portal sales reports.
                    `;
                    alert(saleDetails);
                } else {
                    alert('Sales record not found for receipt: ' + receiptNo);
                }
            } catch (e) {
                alert('Error viewing sales record: ' + e.message);
            }
        }
        
        function exportOrdersReport() {
            const dataStr = JSON.stringify(onlineOrders, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'orders-report-' + new Date().toISOString() + '.json';
            link.click();
        }

        // Simple order lookup via backend
        async function promptAndLookupOrder() {
            const id = (prompt('Enter Order ID (e.g., ORD172...):') || '').trim();
            if (!id) return;
            try {
                let res = await fetch(`/api/orders?id=${encodeURIComponent(id)}`);
                if (!res.ok) res = await fetch(`http://localhost:8001/api/orders?id=${encodeURIComponent(id)}`);
                const data = await res.json();
                if (data && !data.error && data.id) {
                    alert(`Order ${data.id}\nStatus: ${data.status}\nName: ${data.customerName}\nTotal: N$ ${(+(data.total||0)).toFixed(2)}\nItems: ${Array.isArray(data.items)?data.items.length:0}`);
                } else {
                    alert('Order not found');
                }
            } catch (e) {
                alert('Lookup failed. Please try again later.');
            }
        }

        // Floating button to trigger order lookup
        (function(){
            try {
                const btn = document.createElement('button');
                btn.textContent = 'Find Order';
                btn.style.position = 'fixed';
                btn.style.right = '14px';
                btn.style.bottom = '14px';
                btn.style.zIndex = '9999';
                btn.className = 'btn';
                btn.onclick = promptAndLookupOrder;
                document.addEventListener('DOMContentLoaded', function(){
                    document.body.appendChild(btn);
                });
            } catch (e) { /* ignore */ }
        })();

        // ==========================
        // Admin - Product Photos
        // ==========================
        function populatePhotoProductSelect() {
            const select = document.getElementById('photoProductSelect');
            if (!select || !Array.isArray(PRICE_LIST)) return;
            select.innerHTML = '<option value="">Select Product</option>';
            PRICE_LIST.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.description;
                opt.textContent = p.description;
                select.appendChild(opt);
            });
        }

        function previewUserPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('userPhotoPreview');
                    const previewImg = document.getElementById('userPhotoPreviewImg');
                    if (previewDiv && previewImg) {
                        previewImg.src = e.target.result;
                        previewDiv.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                const previewDiv = document.getElementById('userPhotoPreview');
                if (previewDiv) previewDiv.style.display = 'none';
            }
        }

        function previewDistributorPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('distributorPhotoPreview');
                    const previewImg = document.getElementById('distributorPhotoPreviewImg');
                    if (previewDiv && previewImg) {
                        previewImg.src = e.target.result;
                        previewDiv.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                const previewDiv = document.getElementById('distributorPhotoPreview');
                if (previewDiv) previewDiv.style.display = 'none';
            }
        }

        function previewProductPhoto(event) {
            const files = event.target.files;
            const preview = document.getElementById('photoPreview');
            const status = document.getElementById('photoUploadStatus');
            
            if (!files || !preview) return;
            
            // Clear previous status
            if (status) status.textContent = '';
            
            // Limit to 4 files max
            const fileArray = Array.from(files).slice(0, 4);
            const totalFiles = fileArray.length;
            
            if (totalFiles === 0) {
                preview.innerHTML = '';
                return;
            }
            
            // Clear preview and show loading message
            preview.innerHTML = `<p style="color: #666; margin: 10px 0;">ðŸ”„ Loading ${totalFiles} photo(s)...</p>`;
            
            let loadedCount = 0;
            const previewImages = [];
            const errors = [];
            
            fileArray.forEach((file, index) => {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    errors.push(`"${file.name}" is too large (Max 5MB)`);
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        displayPreview();
                    }
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    errors.push(`"${file.name}" is not a valid image file`);
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        displayPreview();
                    }
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImages.push({
                        name: file.name,
                        src: e.target.result,
                        size: file.size
                    });
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        displayPreview();
                    }
                };
                reader.onerror = () => {
                    errors.push(`Failed to load "${file.name}"`);
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        displayPreview();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            function displayPreview() {
                if (errors.length > 0 && status) {
                    status.innerHTML = `<p style="color: #e74c3c;">âš ï¸ ${errors.join(', ')}</p>`;
                }
                
                if (previewImages.length === 0) {
                    preview.innerHTML = '<p style="color: #e74c3c;">No valid photos to preview</p>';
                    return;
                }
                
                // Display preview grid
                const gridStyle = `
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                    gap: 15px;
                    margin-top: 10px;
                `;
                
                preview.innerHTML = `
                    <div style="${gridStyle}">
                        ${previewImages.map((img, idx) => `
                            <div style="position: relative; background: #f8f9fa; padding: 8px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <img src="${img.src}" alt="Preview ${idx + 1}" loading="lazy" decoding="async"
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; display: block;">
                                <div style="margin-top: 8px; text-align: center;">
                                    <small style="color: #666; font-size: 0.75rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" 
                                           title="${img.name}">${img.name}</small>
                                    <small style="color: #999; font-size: 0.7rem;">${(img.size / 1024).toFixed(1)} KB</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${previewImages.length > 0 ? `<p style="color: #27ae60; margin-top: 10px; text-align: center;">âœ… ${previewImages.length} photo(s) ready to upload</p>` : ''}
                `;
            }
        }

        // Resize and generate responsive variants
        async function createImageVariantsFromFile(file, { maxDimension = 1200, quality = 0.85 } = {}) {
            const dataUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            const img = await new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => resolve(image);
                image.onerror = reject;
                image.src = dataUrl;
            });
            const makeVariant = (targetMax) => {
                const scale = Math.min(1, targetMax / Math.max(img.width, img.height));
                const w = Math.round(img.width * scale);
                const h = Math.round(img.height * scale);
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                // Prefer WebP when supported
                const type = 'image/webp';
                return canvas.toDataURL(type, quality);
            };
            const full = makeVariant(maxDimension);
            const w600 = makeVariant(600);
            const w300 = makeVariant(300);
            return { full, w600, w300, width: Math.min(img.width, maxDimension), height: Math.min(img.height, maxDimension) };
        }

        function uploadProductPhoto() {
            const productName = document.getElementById('photoProductSelect')?.value || '';
            const fileInput = document.getElementById('productPhotoInput');
            const status = document.getElementById('photoUploadStatus');
            if (!productName) { status.textContent = 'Please select a product.'; return; }
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) { 
                status.textContent = 'Please choose at least one photo.'; 
                return; 
            }
            
            const files = Array.from(fileInput.files).slice(0, 4); // Limit to 4 files
            const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            
            // Initialize as array if it doesn't exist or if it's a string (legacy single photo)
            if (!photoMap[productName] || typeof photoMap[productName] === 'string') {
                photoMap[productName] = [];
            }
            
            let loadedCount = 0;
            const totalFiles = files.length;
            (async () => {
                for (const file of files) {
                    try {
                        const { maxDimension, quality } = getPhotoOptimizationSettings();
                        const variants = await createImageVariantsFromFile(file, { maxDimension, quality });
                        if (photoMap[productName].length < 4) {
                            photoMap[productName].push(variants);
                        }
                        loadedCount++;
                    } catch (e) {
                        console.warn('Image processing failed for', file.name, e);
                    }
                }
                // Ensure we don't exceed 4 photos
                photoMap[productName] = photoMap[productName].slice(0, 4);
                localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                status.textContent = `${loadedCount} photo(s) uploaded and optimized! (Total: ${photoMap[productName].length}/4)`;
                loadProductPhotos();
                if (typeof loadShopProducts === 'function') {
                    loadShopProducts();
                }
                clearPhotoForm();
            })();
        }

        // UI controls for photo optimization
        function ensurePhotoUploadControls() {
            const fileInput = document.getElementById('productPhotoInput');
            if (!fileInput) return;
            const existing = document.getElementById('photoOptimizeControls');
            if (existing) return;
            const wrap = document.createElement('div');
            wrap.id = 'photoOptimizeControls';
            wrap.style.cssText = 'margin-top:8px; display:flex; flex-wrap:wrap; gap:12px; align-items:center;';
            wrap.innerHTML = `
                <label style="display:flex; align-items:center; gap:6px;">
                    <span style="min-width:90px; color:#2c3e50;">Quality</span>
                    <input id="photoQualityInput" type="range" min="50" max="95" value="85" step="5" style="width:160px;">
                    <span id="photoQualityLabel" style="color:#666; width:42px;">85%</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px;">
                    <span style="min-width:90px; color:#2c3e50;">Max size</span>
                    <select id="photoMaxDimensionInput" style="padding:6px;">
                        <option value="800">800px</option>
                        <option value="1000">1000px</option>
                        <option value="1200" selected>1200px</option>
                        <option value="1600">1600px</option>
                    </select>
                </label>
                <button id="runPhotoMigrationBtn" class="btn btn-secondary">Optimize existing photos</button>
                <button id="recoverPhotosBtn" class="btn btn-info">Recover missing photos</button>
            `;
            fileInput.parentElement?.appendChild(wrap);
            const range = document.getElementById('photoQualityInput');
            const label = document.getElementById('photoQualityLabel');
            range?.addEventListener('input', () => { if (label) label.textContent = `${range.value}%`; });
            document.getElementById('runPhotoMigrationBtn')?.addEventListener('click', () => migrateLegacyPhotosToVariants(true));
            document.getElementById('recoverPhotosBtn')?.addEventListener('click', () => recoverMissingProductPhotos());
        }

        function getPhotoOptimizationSettings() {
            const qEl = document.getElementById('photoQualityInput');
            const dEl = document.getElementById('photoMaxDimensionInput');
            const quality = qEl ? Math.min(0.95, Math.max(0.5, Number(qEl.value || 85) / 100)) : 0.85;
            const maxDimension = dEl ? Number(dEl.value || 1200) : 1200;
            return { quality, maxDimension };
        }

        // Generate a branded placeholder SVG for a product
        function generateProductPlaceholderSVG(productName = 'Product', width = 600, height = 400) {
            const safeName = String(productName).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const bg = '#c41e3a';
            const fg = '#ffffff';
            const sub = '#ffd7df';
            const svg = `
                <svg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}' viewBox='0 0 ${width} ${height}'>
                    <defs>
                        <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
                            <stop offset='0%' stop-color='${bg}' stop-opacity='0.95'/>
                            <stop offset='100%' stop-color='#8b0000' stop-opacity='0.95'/>
                        </linearGradient>
                    </defs>
                    <rect width='100%' height='100%' fill='url(#g)'/>
                    <g fill='none' stroke='${sub}' stroke-opacity='0.25'>
                        <circle cx='${width/2}' cy='${height/2}' r='${Math.min(width,height)/3}' />
                        <circle cx='${width/2}' cy='${height/2}' r='${Math.min(width,height)/2.2}' />
                    </g>
                    <text x='50%' y='45%' text-anchor='middle' fill='${fg}' font-family='Arial, Helvetica, sans-serif' font-size='28' font-weight='700'>Dynapharm Namibia</text>
                    <text x='50%' y='60%' text-anchor='middle' fill='${fg}' font-family='Arial, Helvetica, sans-serif' font-size='22' font-weight='600'>${safeName}</text>
                </svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        // Recover missing product photos with branded placeholders
        function recoverMissingProductPhotos() {
            try {
                const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
                let created = 0;
                if (Array.isArray(PRICE_LIST)) {
                    PRICE_LIST.forEach(p => {
                        const key = p.description;
                        let list = photoMap[key];
                        if (!list || (Array.isArray(list) && list.length === 0)) {
                            const img = generateProductPlaceholderSVG(key, 1200, 800);
                            photoMap[key] = [img];
                            created++;
                        }
                    });
                }
                localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                loadShopProducts();
                try { loadProductPhotos(); } catch(_) {}
                alert(`âœ… Recovered ${created} product photo(s).`);
            } catch (e) {
                console.error('Recovery failed:', e);
                alert('âŒ Failed to recover photos.');
            }
        }

        // One-time migration: convert data-URL strings to variant objects
        async function migrateLegacyPhotosToVariants(force = false) {
            try {
                if (!force && localStorage.getItem('dyna_photo_migrated') === '1') return;
                const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
                const names = Object.keys(photoMap);
                if (names.length === 0) { localStorage.setItem('dyna_photo_migrated', '1'); return; }
                const { quality, maxDimension } = getPhotoOptimizationSettings();
                for (const name of names) {
                    let list = photoMap[name];
                    if (!list) continue;
                    if (typeof list === 'string') list = [list];
                    if (!Array.isArray(list)) list = [list];
                    const converted = [];
                    for (const p of list) {
                        if (typeof p === 'object' && p && (p.full || p.w600 || p.w300)) { converted.push(p); continue; }
                        if (typeof p === 'string' && p.startsWith('data:image')) {
                            // Safe to downscale data URLs
                            try {
                                const res = await fetch(p);
                                const blob = await res.blob();
                                const variants = await createImageVariantsFromFile(blob, { maxDimension, quality });
                                converted.push(variants);
                            } catch (_) {
                                converted.push(p); // fallback keep
                            }
                        } else {
                            // Remote URLs may taint canvas; keep as-is
                            converted.push(p);
                        }
                        if (converted.length >= 4) break;
                    }
                    photoMap[name] = converted.slice(0, 4);
                }
                localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                localStorage.setItem('dyna_photo_migrated', '1');
                try { loadProductPhotos(); } catch (_) {}
                try { if (typeof loadShopProducts === 'function') loadShopProducts(); } catch (_) {}
                const status = document.getElementById('photoUploadStatus');
                if (status) status.textContent = 'Existing photos optimized.';
            } catch (_) {}
        }

        // Initialize controls and run migration once on load
        (function initPhotoOptimizerUI() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => { ensurePhotoUploadControls(); migrateLegacyPhotosToVariants(false); });
            } else {
                ensurePhotoUploadControls(); migrateLegacyPhotosToVariants(false);
            }
        })();

        function clearPhotoForm() {
            const select = document.getElementById('photoProductSelect');
            const input = document.getElementById('productPhotoInput');
            const preview = document.getElementById('photoPreview');
            const status = document.getElementById('photoUploadStatus');
            if (select) select.value = '';
            if (input) input.value = '';
            if (preview) preview.innerHTML = '';
            if (status) status.textContent = '';
        }

        function loadProductPhotos() {
            const container = document.getElementById('productPhotosGrid');
            if (!container) return;
            const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            const search = (document.getElementById('photoSearch')?.value || '').toLowerCase();
            const names = Object.keys(photoMap).filter(n => n.toLowerCase().includes(search)).sort();
            if (names.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No product photos yet</p>';
                return;
            }
            container.innerHTML = names.map(name => {
                // Handle both legacy single photo and new array format
                let productPhotos = photoMap[name];
                if (!productPhotos) {
                    productPhotos = [];
                } else if (typeof productPhotos === 'string') {
                    // Legacy format: convert single photo to array
                    productPhotos = [productPhotos];
                }
                // Ensure it's an array
                if (!Array.isArray(productPhotos)) {
                    productPhotos = [productPhotos];
                }
                // Filter out invalid entries
                productPhotos = productPhotos.filter(photo => photo && typeof photo === 'string' && photo.trim().length > 0);
                
                const photoCount = productPhotos.length;
                const displayPhoto = productPhotos.length > 0 ? productPhotos[0] : 'https://placehold.co/200x200?text=No+Photo';
                
                return `
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                        <div style="position: relative;">
                            <img src="${displayPhoto}" alt="${name}" loading="lazy" decoding="async" referrerpolicy="no-referrer" width="200" height="200"
                                 onload="this.style.filter='none'; this.style.background='transparent'"
                                 style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; aspect-ratio: 1/1; background:#f3f4f6; filter: blur(8px); transition: filter .3s ease;">
                            ${photoCount > 1 ? `
                                <div style="position: absolute; top: 5px; right: 5px; background: rgba(196, 30, 58, 0.9); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                                    ${photoCount} photos
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span style="font-size: 0.95rem; color: #2c3e50;">${name}</span>
                            <button class="btn btn-danger" onclick="removeProductPhoto('${name.replace(/'/g, "\\'")}')">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterProductPhotos() { loadProductPhotos(); }
        
        // Function to start downloading product images with UI updates
        async function startDownloadProductImages() {
            const btn = document.getElementById('downloadImagesBtn');
            const progressDiv = document.getElementById('downloadProgress');
            const statusSpan = document.getElementById('downloadStatus');
            const statsSpan = document.getElementById('downloadStats');
            const progressBar = document.getElementById('downloadProgressBar');
            const logDiv = document.getElementById('downloadLog');
            
            if (!btn || !progressDiv) return;
            
            // Confirm action
            if (!confirm('This will download all product images from dynapharm.net/ph and save them to localStorage. This may take several minutes. Continue?')) {
                return;
            }
            
            // Disable button and show progress
            btn.disabled = true;
            btn.textContent = 'â¬‡ï¸ Downloading...';
            progressDiv.style.display = 'block';
            logDiv.innerHTML = '';
            statusSpan.textContent = 'Starting download...';
            statsSpan.textContent = '0/0';
            progressBar.style.width = '0%';
            
            let lastLogTime = Date.now();
            const logMessages = [];
            
            function addLog(message, type = 'info') {
                const now = Date.now();
                const timeStr = new Date(now).toLocaleTimeString();
                const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'skip' ? 'â­ï¸' : 'â„¹ï¸';
                logMessages.push(`[${timeStr}] ${icon} ${message}`);
                
                // Keep only last 50 messages
                if (logMessages.length > 50) {
                    logMessages.shift();
                }
                
                logDiv.innerHTML = logMessages.map(msg => `<div>${msg}</div>`).join('');
                logDiv.scrollTop = logDiv.scrollHeight;
                
                // Update every second or immediately for important messages
                if (type !== 'info' || now - lastLogTime > 1000) {
                    lastLogTime = now;
                }
            }
            
            try {
                const results = await downloadAllProductImages({
                    batchSize: 3,
                    delayBetweenBatches: 1500,
                    skipExisting: true,
                    onProgress: (productName, status, stats) => {
                        if (productName) {
                            if (status === 'success') {
                                addLog(`Downloaded: ${productName}`, 'success');
                            } else if (status === 'failed') {
                                addLog(`Failed: ${productName}`, 'error');
                            } else if (status === 'skipped') {
                                addLog(`Skipped: ${productName}`, 'skip');
                            }
                        }
                        
                        // Update progress
                        const progress = stats.total > 0 ? ((stats.downloaded + stats.failed + stats.skipped) / stats.total) * 100 : 0;
                        progressBar.style.width = `${progress}%`;
                        statsSpan.textContent = `${stats.downloaded + stats.failed + stats.skipped}/${stats.total}`;
                        statusSpan.textContent = `Downloaded: ${stats.downloaded} | Failed: ${stats.failed} | Skipped: ${stats.skipped}`;
                    },
                    onComplete: (results) => {
                        statusSpan.textContent = `Complete! Downloaded: ${results.downloaded} | Failed: ${results.failed} | Skipped: ${results.skipped}`;
                        progressBar.style.width = '100%';
                        addLog(`\n=== Download Complete ===`, 'info');
                        addLog(`Total: ${results.total}`, 'info');
                        addLog(`Downloaded: ${results.downloaded}`, 'success');
                        addLog(`Failed: ${results.failed}`, results.failed > 0 ? 'error' : 'info');
                        addLog(`Skipped: ${results.skipped}`, 'skip');
                        
                        if (results.failed > 0 && results.errors.length > 0) {
                            addLog(`\nFailed products:`, 'error');
                            results.errors.slice(0, 10).forEach(err => {
                                addLog(`  - ${err.product}`, 'error');
                            });
                            if (results.errors.length > 10) {
                                addLog(`  ... and ${results.errors.length - 10} more`, 'error');
                            }
                        }
                        
                        btn.disabled = false;
                        btn.textContent = 'â¬‡ï¸ Download All Images';
                        
                        // Refresh the photo gallery
                        setTimeout(() => {
                            loadProductPhotos();
                        }, 1000);
                    }
                });
            } catch (error) {
                console.error('Download error:', error);
                addLog(`Error: ${error.message}`, 'error');
                statusSpan.textContent = 'Download failed. Check console for details.';
                btn.disabled = false;
                btn.textContent = 'â¬‡ï¸ Download All Images';
            }
        }
        
        // Refresh UI on cloud sync updates (near real-time for shop and photos)
        try {
            window.addEventListener('cloud-sync:updated', () => {
                try { loadProductPhotos(); } catch(_) {}
                try { if (typeof loadShopProducts === 'function') loadShopProducts(); } catch(_) {}
            });
        } catch(_) {}

        // Refresh consultant/dispenser views when reports change in-memory
        try {
            window.addEventListener('reports:updated', () => {
                // Only call user-specific functions if user is logged in
                if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                    try { if (typeof displayMyReports === 'function') displayMyReports(); } catch(e) { console.debug('displayMyReports error:', e); }
                    try { if (typeof displayFollowUps === 'function') displayFollowUps(); } catch(e) { console.debug('displayFollowUps error:', e); }
                }
                try { if (typeof displayPrescriptions === 'function') displayPrescriptions(); } catch(_) {}
            });
            // Finance portal: refresh on reports, sales, and stock updates
            window.addEventListener('reports:updated', () => {
                try { 
                    if (typeof loadEnhancedFinanceData === 'function') loadEnhancedFinanceData();
                    if (typeof refreshFinancialDashboard === 'function') refreshFinancialDashboard(); 
                    if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview(); 
                    if (typeof refreshRevenue === 'function') refreshRevenue(); 
                    if (typeof refreshExpenses === 'function') refreshExpenses(); 
                } catch(_) {}
            });
            window.addEventListener('sale:updated', () => {
                try { 
                    if (typeof loadEnhancedFinanceData === 'function') loadEnhancedFinanceData();
                    if (typeof refreshFinancialDashboard === 'function') refreshFinancialDashboard(); 
                    if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview(); 
                    if (typeof refreshRevenue === 'function') refreshRevenue(); 
                    if (typeof refreshExpenses === 'function') refreshExpenses(); 
                } catch(_) {}
            });
            window.addEventListener('stock:updated', () => {
                try { 
                    if (typeof refreshFinancialDashboard === 'function') refreshFinancialDashboard(); 
                    if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview(); 
                } catch(_) {}
            });
            window.addEventListener('deposit:updated', () => {
                try { 
                    if (typeof loadEnhancedFinanceData === 'function') loadEnhancedFinanceData();
                    if (typeof refreshFinancialDashboard === 'function') refreshFinancialDashboard(); 
                } catch(_) {}
            });
            window.addEventListener('bonus:updated', () => {
                try { 
                    if (typeof loadEnhancedFinanceData === 'function') loadEnhancedFinanceData();
                    if (typeof refreshFinancialDashboard === 'function') refreshFinancialDashboard(); 
                } catch(_) {}
            });
            // MIS portal: refresh on reports and sales updates
            window.addEventListener('reports:updated', () => {
                try { if (typeof displayMISReports === 'function') displayMISReports(); } catch(_) {}
                try { if (typeof refreshMISData === 'function') refreshMISData(); } catch(_) {}
            });
            window.addEventListener('sale:updated', () => {
                try { if (typeof displayMISReports === 'function') displayMISReports(); } catch(_) {}
                try { if (typeof refreshMISData === 'function') refreshMISData(); } catch(_) {}
            });
            // Stock portal: refresh on stock updates
            window.addEventListener('stock:updated', () => {
                try { if (typeof loadStockData === 'function') loadStockData(); } catch(_) {}
                try { if (typeof renderInventoryBreakdown === 'function') {
                    const branchId = document.getElementById('misBranchSelect')?.value || 'all';
                    renderInventoryBreakdown('misInventoryBreakdown', branchId);
                } } catch(_) {}
            });
            // User updates: refresh all portals when users change
            window.addEventListener('users:updated', () => {
                try { if (typeof loadData === 'function') loadData(); } catch(_) {}
                try { if (typeof loadUserList === 'function') loadUserList(); } catch(_) {}
            });
            // Front Desk Portal: refresh orders on order updates
            window.addEventListener('orders:updated', () => {
                try { 
                    if (typeof fetchAllOrders === 'function') {
                        fetchAllOrders().then(() => {
                            if (typeof displayBranchOnlineOrders === 'function') displayBranchOnlineOrders();
                            if (typeof refreshPendingOrders === 'function') refreshPendingOrders();
                            if (typeof refreshProcessingOrders === 'function') refreshProcessingOrders();
                            if (typeof refreshShippedOrders === 'function') refreshShippedOrders();
                            if (typeof refreshDeliveredOrders === 'function') refreshDeliveredOrders();
                            if (typeof refreshAllOrders === 'function') refreshAllOrders();
                        });
                    }
                } catch(_) {}
            });
            // GM Portal: refresh dashboard on reports/sales updates
            window.addEventListener('reports:updated', () => {
                try { if (typeof refreshGMData === 'function') refreshGMData(); } catch(_) {}
                try { if (typeof calculateGMMetrics === 'function') calculateGMMetrics(); } catch(_) {}
            });
            window.addEventListener('sale:updated', () => {
                try { if (typeof refreshGMData === 'function') refreshGMData(); } catch(_) {}
                try { if (typeof calculateGMMetrics === 'function') calculateGMMetrics(); } catch(_) {}
            });
            // Director Portal: refresh dashboard on reports/sales updates
            window.addEventListener('reports:updated', () => {
                try { if (typeof refreshDirectorData === 'function') refreshDirectorData(); } catch(_) {}
                try { if (typeof calculateDirectorMetrics === 'function') calculateDirectorMetrics(); } catch(_) {}
            });
            window.addEventListener('sale:updated', () => {
                try { if (typeof refreshDirectorData === 'function') refreshDirectorData(); } catch(_) {}
                try { if (typeof calculateDirectorMetrics === 'function') calculateDirectorMetrics(); } catch(_) {}
            });
        } catch(_) {}

        // HR: refresh employee list when employees sync arrives
        try {
            window.addEventListener('cloud-sync:employees', () => {
                try { if (typeof loadEmployees === 'function') loadEmployees(); } catch(_) {}
            });
        } catch(_) {}

        function removeProductPhoto(productName) {
            const photoMap = JSON.parse(localStorage.getItem('dyna_product_photos') || '{}');
            if (photoMap[productName]) {
                delete photoMap[productName];
                localStorage.setItem('dyna_product_photos', JSON.stringify(photoMap));
                loadProductPhotos();
            }
        }
        // --- PWA: Service Worker Registration and Notifications ---
        (function registerPWA() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function () {
                    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
                        .then(function (registration) {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                            // Force immediate update check
                            registration.update();
                            
                            // Listen for updates
                            registration.addEventListener('updatefound', function() {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', function() {
                                    if (newWorker.state === 'activated') {
                                        // New service worker activated, reload to get fresh content
                                        if (navigator.serviceWorker.controller) {
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch(function (err) {
                        console.warn('ServiceWorker registration failed:', err);
                        });
                    
                    // Check if there's a waiting service worker and prompt reload
                    navigator.serviceWorker.addEventListener('controllerchange', function() {
                        window.location.reload();
                    });
                });
            }
            if ('Notification' in window && Notification.permission === 'default') {
                try { Notification.requestPermission(); } catch (e) {}
            }
        })();

        // --- Realtime updates via SSE (Upstash Redis) ---
        (function setupRealtime() {
            try {
                const meta = document.querySelector('meta[name="rt-base"]');
                const rtBase = (meta && meta.content && meta.content.trim()) || '';
                if (rtBase && 'WebSocket' in window) {
                    const url = rtBase.replace(/\/$/, '') + '/ws';
                    const connectWS = () => {
                        try {
                            const wsUrl = url.replace(/^http/i, 'ws');
                            const ws = new WebSocket(wsUrl);
                            ws.onmessage = () => {
                                try { if (typeof loadData === 'function') loadData(); } catch(_) {}
                                // Only call user-specific functions if user is logged in (with double-check)
                                if (typeof currentUser !== 'undefined' && currentUser !== null && currentUser && typeof currentUser.fullName === 'string' && currentUser.fullName.length > 0) {
                                    try { 
                                        if (typeof displayMyReports === 'function') {
                                            // Double-check currentUser still exists before calling
                                            if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                                                displayMyReports();
                                            }
                                        }
                                    } catch(e) { 
                                        console.debug('displayMyReports error:', e); 
                                    }
                                    try { 
                                        if (typeof displayFollowUps === 'function') {
                                            // Double-check currentUser still exists before calling
                                            if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                                                displayFollowUps();
                                            }
                                        }
                                    } catch(e) { 
                                        console.debug('displayFollowUps error:', e); 
                                    }
                                }
                                try { if (typeof displayPrescriptions === 'function') displayPrescriptions(); } catch(_) {}
                                try { if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview(); } catch(_) {}
                                try { if (typeof displayMISReports === 'function') displayMISReports(); } catch(_) {}
                                try { if (typeof loadStockData === 'function') loadStockData(); } catch(_) {}
                                try { if (typeof fetchAllOrders === 'function') fetchAllOrders().then(() => { if (typeof displayBranchOnlineOrders === 'function') displayBranchOnlineOrders(); }); } catch(_) {}
                                try { if (typeof refreshGMData === 'function') refreshGMData(); } catch(_) {}
                                try { if (typeof refreshDirectorData === 'function') refreshDirectorData(); } catch(_) {}
                            };
                            ws.onclose = () => setTimeout(connectWS, 3000);
                            ws.onerror = () => { try { ws.close(); } catch(_) {}; };
                        } catch(_) {}
                    };
                    connectWS();
                    return;
                }
                if (!('EventSource' in window)) return;
                const connectSSE = () => {
                    try {
                        const es = new EventSource('/api/realtime_stream?channel=reports');
                        es.onmessage = () => {
                            try { if (typeof loadData === 'function') loadData(); } catch(_) {}
                            // Only call user-specific functions if user is logged in (with double-check)
                            if (typeof currentUser !== 'undefined' && currentUser !== null && currentUser && typeof currentUser.fullName === 'string' && currentUser.fullName.length > 0) {
                                try { 
                                    if (typeof displayMyReports === 'function') {
                                        // Double-check currentUser still exists before calling
                                        if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                                            displayMyReports();
                                        }
                                    }
                                } catch(e) { 
                                    console.debug('displayMyReports error:', e); 
                                }
                                try { 
                                    if (typeof displayFollowUps === 'function') {
                                        // Double-check currentUser still exists before calling
                                        if (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) {
                                            displayFollowUps();
                                        }
                                    }
                                } catch(e) { 
                                    console.debug('displayFollowUps error:', e); 
                                }
                            }
                            try { if (typeof displayPrescriptions === 'function') displayPrescriptions(); } catch(_) {}
                            try { if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview(); } catch(_) {}
                            try { if (typeof displayMISReports === 'function') displayMISReports(); } catch(_) {}
                            try { if (typeof loadStockData === 'function') loadStockData(); } catch(_) {}
                            try { if (typeof fetchAllOrders === 'function') fetchAllOrders().then(() => { if (typeof displayBranchOnlineOrders === 'function') displayBranchOnlineOrders(); }); } catch(_) {}
                            try { if (typeof refreshGMData === 'function') refreshGMData(); } catch(_) {}
                            try { if (typeof refreshDirectorData === 'function') refreshDirectorData(); } catch(_) {}
                        };
                        es.onerror = () => { es.close(); setTimeout(connectSSE, 3000); };
                    } catch (_) { /* ignore */ }
                };
                connectSSE();

                // Also subscribe to client registration updates for real-time client lists
                try {
                    const esClients = new EventSource('/api/realtime_stream?channel=clients');
                    esClients.onmessage = () => {
                        try { if (typeof loadData === 'function') loadData(); } catch(_) {}
                        try { if (typeof displayClients === 'function') displayClients(); } catch(_) {}
                    };
                    esClients.onerror = () => { try { esClients.close(); } catch(_) {}; setTimeout(() => { /* reconnect */ try { const _es = new EventSource('/api/realtime_stream?channel=clients'); _es.onmessage = esClients.onmessage; _es.onerror = esClients.onerror; } catch(_) {} }, 3000); };
                } catch(_) {}
            } catch (_) {}
        })();

        // --- Mobile Utilities: Barcode, GPS, Voice Notes ---
        async function startBarcodeScanner(onDetect) {
            try {
                const supported = 'BarcodeDetector' in window;
                const video = document.createElement('video');
                video.autoplay = true; video.playsInline = true; video.style.maxWidth = '100%';
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
                const wrap = document.createElement('div');
                wrap.style.cssText = 'background:#fff;padding:16px;border-radius:8px;max-width:95%;width:480px;text-align:center;';
                const controls = document.createElement('div');
                controls.style.cssText = 'margin-top:10px;display:flex;gap:8px;justify-content:center;';
                const close = document.createElement('button'); close.className='btn btn-danger'; close.textContent='Close';
                close.onclick = stop;
                wrap.appendChild(video); wrap.appendChild(controls); controls.appendChild(close); modal.appendChild(wrap); document.body.appendChild(modal);

                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;

                let rafId = 0, detector = null;
                if (supported) detector = new window.BarcodeDetector({ formats: ['qr_code', 'code_128', 'ean_13', 'ean_8'] });
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                async function tick() {
                    if (video.readyState >= 2) {
                        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        if (detector) {
                            try {
                                const codes = await detector.detect(canvas);
                                if (codes && codes.length > 0) {
                                    const value = codes[0].rawValue || codes[0].data || '';
                                    if (typeof onDetect === 'function') onDetect(value);
                                    stop();
                                    return;
                                }
                            } catch (_) {}
                        }
                    }
                    rafId = requestAnimationFrame(tick);
                }
                rafId = requestAnimationFrame(tick);

                function stop() {
                    if (rafId) cancelAnimationFrame(rafId);
                    if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
                    if (document.body.contains(modal)) document.body.removeChild(modal);
                }
            } catch (err) {
                const manual = prompt('Barcode scanner unavailable. Enter code manually:');
                if (manual && typeof onDetect === 'function') onDetect(manual.trim());
            }
        }

        function getCurrentLocation(callback) {
            if (!('geolocation' in navigator)) { alert('GPS not supported'); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
                try { localStorage.setItem('dyna_last_location', JSON.stringify(coords)); } catch (_) {}
                if (typeof callback === 'function') callback(coords);
            }, (err) => {
                alert('Location error: ' + err.message);
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        // Voice notes using MediaRecorder
        let voiceMediaRecorder = null; let voiceChunks = [];
        async function startVoiceNote() {
            if (!('MediaRecorder' in window)) { alert('Voice notes not supported'); return; }
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            voiceChunks = [];
            voiceMediaRecorder = new MediaRecorder(stream);
            voiceMediaRecorder.ondataavailable = e => { if (e.data.size > 0) voiceChunks.push(e.data); };
            voiceMediaRecorder.onstop = () => { stream.getTracks().forEach(t => t.stop()); };
            voiceMediaRecorder.start();
        }
        async function stopVoiceNote(saveKey = 'dyna_last_voice_note') {
            return new Promise((resolve) => {
                if (!voiceMediaRecorder) { resolve(null); return; }
                voiceMediaRecorder.onstop = async () => {
                    const blob = new Blob(voiceChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        const b64 = reader.result;
                        try { localStorage.setItem(saveKey, b64); } catch (_) {}
                        resolve(b64);
                    };
                    reader.readAsDataURL(blob);
                };
                voiceMediaRecorder.stop();
            });
        }

        // --- Document Management System (localStorage-backed) ---
        function ensureDocumentsTab() {
            try {
                // Move Documents into Front Desk as a sub-tab
                const frontdeskTabs = document.querySelector('#frontdesk .tabs');
                if (frontdeskTabs && !frontdeskTabs.querySelector('[onclick="showOrderTab(\'documents\')"]')) {
                    const btn = document.createElement('button');
                    btn.className = 'tab-button';
                    btn.textContent = 'ðŸ“ Documents';
                    btn.setAttribute('onclick', "showOrderTab('documents')");
                    frontdeskTabs.appendChild(btn);
                }

                // Ensure the Front Desk Documents container exists
                if (!document.getElementById('frontdeskDocuments')) {
                    const container = document.createElement('div');
                    container.id = 'frontdeskDocuments';
                    container.className = 'order-tab-content';
                    container.style.display = 'none';
                    container.innerHTML = `
                        <div class="portal-header"><h2>ðŸ“ Document Library</h2><p>Store and manage reports, prescriptions, invoices</p></div>
                        <div class="search-box">
                            <input id="docSearch" placeholder="Search documents by title, type, client, branch" oninput="renderDocumentLibrary()">
                            <select id="docTypeFilter" onchange="renderDocumentLibrary()">
                                <option value="">All Types</option>
                                <option>Report</option>
                                <option>Prescription</option>
                                <option>Invoice</option>
                                <option>Other</option>
                            </select>
                            <select id="docStatusFilter" onchange="renderDocumentLibrary()">
                                <option value="">All Statuses</option>
                                <option>Draft</option>
                                <option>Pending Approval</option>
                                <option>Approved</option>
                                <option>Completed</option>
                                <option>Archived</option>
                            </select>
                            <select id="docBranchFilter" onchange="renderDocumentLibrary()">
                                <option value="">All Branches</option>
                            </select>
                            <button class="btn" onclick="openNewDocumentModal()">âž• New Document</button>
                            <button class="btn btn-warning" onclick="bulkPrintSelectedDocuments()">ðŸ–¨ï¸ Bulk Print</button>
                            <button class="btn btn-success" onclick="bulkEmailSelectedDocuments()">âœ‰ï¸ Bulk Email</button>
                            <button class="btn btn-danger" onclick="bulkArchiveSelectedDocuments()">ðŸ—„ï¸ Archive</button>
                        </div>
                        <div id="documentList"></div>
                    `;

                    // Insert after existing Front Desk tabs content blocks
                    const anchor = document.querySelector('#frontdesk');
                    if (anchor) anchor.appendChild(container);
                }

                populateBranchFilterOptions();
                renderDocumentLibrary();
            } catch (e) { console.warn('Documents tab init failed', e); }
        }

        function getDocuments() { return JSON.parse(localStorage.getItem('dyna_documents') || '[]'); }
        function saveDocuments(docs) { localStorage.setItem('dyna_documents', JSON.stringify(docs)); }

        function populateBranchFilterOptions() {
            const select = document.getElementById('docBranchFilter'); if (!select) return;
            const branches = (JSON.parse(localStorage.getItem('branches') || '[]')).map(b => b.name) || [];
            const existing = new Set(Array.from(select.options).map(o => o.value));
            branches.forEach(name => { if (!existing.has(name)) { const o = document.createElement('option'); o.value = o.textContent = name; select.appendChild(o); } });
        }

        function renderDocumentLibrary() {
            const list = document.getElementById('documentList'); if (!list) return;
            const q = (document.getElementById('docSearch')?.value || '').toLowerCase();
            const type = document.getElementById('docTypeFilter')?.value || '';
            const status = document.getElementById('docStatusFilter')?.value || '';
            const branch = document.getElementById('docBranchFilter')?.value || '';
            const docs = getDocuments().filter(d =>
                (!q || `${d.title} ${d.client||''} ${d.branch||''} ${d.type||''}`.toLowerCase().includes(q)) &&
                (!type || d.type === type) &&
                (!status || (d.status||'Draft') === status) &&
                (!branch || d.branch === branch)
            );
            if (docs.length === 0) { list.innerHTML = '<p style="color:#7f8c8d;">No documents yet</p>'; return; }
            list.innerHTML = docs.map(d => `
                <div class="client-card" style="display:flex;gap:12px;align-items:center;">
                    <input type="checkbox" data-doc-id="${d.id}">
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>${d.title}</strong>
                                <span style="margin-left:8px;padding:2px 8px;border-radius:12px;font-size:0.8rem;background:#f4f6f8;border:1px solid #e1e5e8;">${d.type||'Other'}</span>
                            </div>
                            <div>
                                <span style="margin-right:8px;padding:2px 8px;border-radius:12px;font-size:0.8rem;${docStatusBadgeStyle(d.status)}">${d.status||'Draft'}</span>
                                <span style="font-size:0.8rem;color:#666;">${d.assignedTo?('ðŸ‘¤ '+d.assignedTo):''}</span>
                            </div>
                        </div>
                        <div style="color:#666;font-size:.9rem;">Client: ${d.client||'-'} â€¢ Branch: ${d.branch||'-'} â€¢ ${new Date(d.createdAt).toLocaleString()}</div>
                        ${d.dueAt ? `<div style=\"margin-top:4px;font-size:0.85rem;\">Due: <strong>${new Date(d.dueAt).toLocaleString()}</strong> ${isOverdue(d)?'<span style=\\"color:#c0392b;margin-left:6px;\\">(Overdue)</span>':''}</div>`:''}
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                        <button class="btn" onclick="previewDocument('${d.id}')">Preview</button>
                        <button class="btn btn-warning" onclick="printDocument('${d.id}')">Print</button>
                        <button class="btn btn-success" onclick="emailDocument('${d.id}')">Email</button>
                        <button class="btn" onclick="assignDocument('${d.id}')">Assign</button>
                        <button class="btn" onclick="advanceDocumentStatus('${d.id}')">Advance</button>
                        <button class="btn" onclick="overrideDocumentStatus('${d.id}')">Override</button>
                        <button class="btn" onclick="setDocumentDueDate('${d.id}')">Set Due</button>
                        <button class="btn" onclick="addDocumentComment('${d.id}')">Comment</button>
                        <button class="btn btn-danger" onclick="archiveDocument('${d.id}')">Archive</button>
                        <button class="btn" onclick="viewDocumentActivity('${d.id}')">Activity</button>
                    </div>
                </div>
            `).join('');
        }

        function openNewDocumentModal() {
            const title = prompt('Document title'); if (!title) return;
            const type = prompt('Type (Report, Prescription, Invoice, Other)') || 'Other';
            const client = prompt('Client name (optional)') || '';
            const branch = prompt('Branch (optional)') || '';
            const assignedTo = prompt('Assign to (name, optional)') || '';
            const content = prompt('Document content (plain text)') || '';
            const slaHoursStr = prompt('SLA (due in hours, optional)', '48') || '';
            const now = Date.now();
            const dueAt = slaHoursStr && !isNaN(Number(slaHoursStr)) ? new Date(now + Number(slaHoursStr)*3600*1000).toISOString() : '';
            const doc = { id: 'doc_'+now, title, type, client, branch, content, createdAt: now, archived: false, status: 'Draft', assignedTo: assignedTo||'', dueAt };
            addDocumentActivity(doc, `Created document '${title}'`);
            const docs = getDocuments(); docs.unshift(doc); saveDocuments(docs); renderDocumentLibrary();
        }

        // ---- Document Workflow helpers ----
        function docStatusBadgeStyle(status){
            const s = (status||'Draft');
            if (s==='Draft') return 'background:#fff3cd;border:1px solid #ffeeba;color:#7d6608;';
            if (s==='Pending Approval') return 'background:#e8f4fd;border:1px solid #d6eaf8;color:#0b5fa5;';
            if (s==='Approved') return 'background:#eafaf1;border:1px solid #d4efdf;color:#1e8449;';
            if (s==='Completed') return 'background:#f2f4f4;border:1px solid #e5e8e8;color:#424949;';
            if (s==='Archived') return 'background:#f8f9f9;border:1px solid #ebedef;color:#7b7d7d;';
            return 'background:#f4f6f8;border:1px solid #e1e5e8;color:#566573;';
        }

        function isOverdue(doc){
            if (!doc || !doc.dueAt) return false;
            const terminal = ['Completed','Archived'];
            if (terminal.includes(doc.status)) return false;
            const due = new Date(doc.dueAt).getTime();
            return Date.now() > due;
        }

        function addDocumentActivity(docOrId, message){
            const docs = getDocuments();
            const id = typeof docOrId === 'string' ? docOrId : docOrId.id;
            const idx = docs.findIndex(d=>d.id===id);
            const now = new Date().toISOString();
            if (idx>=0){
                docs[idx].activity = Array.isArray(docs[idx].activity)? docs[idx].activity: [];
                docs[idx].activity.push({ at: now, by: (currentUser && currentUser.fullName) || 'Front Desk', message });
                saveDocuments(docs);
            } else if (typeof docOrId !== 'string') {
                docOrId.activity = [{ at: now, by: (currentUser && currentUser.fullName) || 'Front Desk', message }];
            }
        }

        function assignDocument(id){
            const name = prompt('Assign to (name)'); if (!name) return;
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            docs[idx].assignedTo = name;
            saveDocuments(docs);
            addDocumentActivity(id, `Assigned to ${name}`);
            renderDocumentLibrary();
        }

        function advanceDocumentStatus(id){
            const order = ['Draft','Pending Approval','Approved','Completed'];
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            const curr = docs[idx].status || 'Draft';
            const i = order.indexOf(curr);
            if (i < order.length-1) {
                const next = order[i+1];
                if (!canChangeDocumentStatus(currentUser?.role, curr, next)) { alert('Not permitted to advance to '+next); return; }
                docs[idx].status = next;
                saveDocuments(docs);
                addDocumentActivity(id, `Status changed: ${curr} â†’ ${next}`);
                renderDocumentLibrary();
            } else {
                alert('Already at final status.');
            }
        }

        function overrideDocumentStatus(id){
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            const curr = docs[idx].status || 'Draft';
            const target = prompt("Set status to (Draft, Pending Approval, Approved, Completed, Archived)", curr);
            const allowed = ['Draft','Pending Approval','Approved','Completed','Archived'];
            if (!target || !allowed.includes(target)) return;
            if (!canChangeDocumentStatus(currentUser?.role, curr, target)) { alert('Not permitted to set status to '+target); return; }
            docs[idx].status = target;
            if (target==='Archived') docs[idx].archived = true;
            saveDocuments(docs);
            addDocumentActivity(id, `Status overridden: ${curr} â†’ ${target}`);
            renderDocumentLibrary();
        }

        // Multi-step approvals
        function approveDocument(id){
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            const role = currentUser?.role || 'guest';
            const from = docs[idx].status || 'Draft';
            let to = from;
            if (role==='consultant' && from==='Pending Approval') to = 'Approved';
            else if ((role==='gm'||role==='admin'||role==='director') && from==='Approved') to = 'Completed';
            else { alert('Approval not allowed at this stage for your role.'); return; }
            if (!canChangeDocumentStatus(role, from, to)) { alert('Not permitted.'); return; }
            docs[idx].status = to;
            saveDocuments(docs);
            addDocumentActivity(id, `Approved by ${currentUser?.fullName||role}. Status: ${from} â†’ ${to}`);
            renderDocumentLibrary();
        }

        function requestDocumentChanges(id){
            const reason = prompt('Reason for changes (optional)') || '';
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            const from = docs[idx].status || 'Draft';
            docs[idx].status = 'Draft';
            saveDocuments(docs);
            addDocumentActivity(id, `Requested changes${reason?': '+reason:''}. Status: ${from} â†’ Draft`);
            renderDocumentLibrary();
        }

        // SLA reminders
        let docReminderTimer = null;
        function ensureDocReminderTimer(){
            if (docReminderTimer) return;
            docReminderTimer = setInterval(runDocReminderSweep, 60000);
        }
        function runDocReminderSweep(){
            const docs = getDocuments();
            let changed = false;
            docs.forEach(d => {
                if (!d || !d.dueAt) return;
                if (['Completed','Archived'].includes(d.status)) return;
                const dueMs = new Date(d.dueAt).getTime();
                const lead = typeof d.reminderLeadMs === 'number' ? d.reminderLeadMs : 2*3600*1000;
                d.notifications = d.notifications || {};
                const now = Date.now();
                if (!d.notifications.dueSoonSent && now >= (dueMs - lead) && now < dueMs){
                    sendDocumentNotification(d, `Document '${d.title}' is due soon (${new Date(d.dueAt).toLocaleString()}).`);
                    d.notifications.dueSoonSent = true; changed = true;
                }
                if (!d.notifications.overdueSent && now >= dueMs){
                    sendDocumentNotification(d, `Document '${d.title}' is OVERDUE (${new Date(d.dueAt).toLocaleString()}).`);
                    d.notifications.overdueSent = true; changed = true;
                }
            });
            if (changed) saveDocuments(docs);
        }
        function sendDocumentNotification(doc, message){
            try {
                const queue = JSON.parse(localStorage.getItem('dyna_notifications') || '[]');
                queue.push({ id: 'NTF-'+Date.now(), docId: doc.id, message, at: new Date().toISOString(), to: doc.assignedTo||'Front Desk' });
                localStorage.setItem('dyna_notifications', JSON.stringify(queue));
            } catch(e) {}
            console.log('[Notification]', message);
        }

        // --- Notifications Inbox (Front Desk) ---
        function getNotifications(){
            try { return JSON.parse(localStorage.getItem('dyna_notifications') || '[]'); } catch(e) { return []; }
        }
        function saveNotifications(list){
            try { localStorage.setItem('dyna_notifications', JSON.stringify(list || [])); } catch(e) {}
        }
        function renderNotifications(){
            const el = document.getElementById('notificationsList'); if (!el) return;
            const notes = getNotifications().slice().sort((a,b)=> new Date(b.at) - new Date(a.at));
            if (notes.length === 0) { el.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:12px;">No notifications.</p>'; return; }
            el.innerHTML = notes.map(n => {
                const time = new Date(n.at).toLocaleString();
                const read = n.readAt ? true : false;
                const doc = (getDocuments().find(d=>d.id===n.docId) || null);
                const title = doc ? doc.title : (n.docId || 'Unknown');
                return `
                <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;border:1px solid #eee;border-left:4px solid ${read?'#bdc3c7':'#c41e3a'};border-radius:6px;padding:10px;margin-bottom:8px;background:${read?'#fafafa':'#fff'};">
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>${title}</strong>
                            <span style="font-size:0.85rem;color:#666;">${time}</span>
                        </div>
                        <div style="color:#333;font-size:0.95rem;margin-top:4px;">${n.message}</div>
                        ${doc?`<div style=\"font-size:0.85rem;color:#7f8c8d;margin-top:4px;\">Status: ${doc.status||'-'} â€¢ Assigned: ${doc.assignedTo||'-'}</div>`:''}
                    </div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap;">
                        ${!read?`<button class=\"btn\" onclick=\"markNotificationRead('${n.id}')\">Mark Read</button>`:''}
                        ${doc?`<button class=\"btn\" onclick=\"openDocFromNotification('${doc.id}')\">Open</button>`:''}
                    </div>
                </div>`;
            }).join('');
        }
        function markNotificationRead(id){
            const list = getNotifications();
            const idx = list.findIndex(n=>n.id===id); if (idx<0) return;
            list[idx].readAt = new Date().toISOString();
            saveNotifications(list);
            renderNotifications();
        }
        function markAllNotificationsRead(){
            const list = getNotifications().map(n => ({ ...n, readAt: n.readAt || new Date().toISOString() }));
            saveNotifications(list);
            renderNotifications();
        }
        function clearAllNotifications(){
            if (!confirm('Clear all notifications?')) return;
            saveNotifications([]);
            renderNotifications();
        }
        function openDocFromNotification(docId){
            try { openTab('frontdesk'); } catch(_) {}
            try { showOrderTab('documents'); } catch(_) {}
            // Optionally scroll to the document it if needed
        }

        function canChangeDocumentStatus(role, from, to){
            const r = role || 'guest';
            const power = {
                'frontdesk': [ ['Draft','Pending Approval'] ],
                'consultant': [ ['Draft','Pending Approval'], ['Pending Approval','Approved'] ],
                'gm': [ ['Draft','Pending Approval'], ['Pending Approval','Approved'], ['Approved','Completed'], ['Draft','Archived'], ['Pending Approval','Archived'], ['Approved','Archived'], ['Completed','Archived'] ],
                'admin': 'any',
                'director': 'any'
            };
            if (to===from) return true;
            if (r==='admin' || r==='director') return true;
            const rules = power[r] || [];
            return rules==='any' ? true : rules.some(([a,b])=>a===from&&b===to);
        }

        function setDocumentDueDate(id){
            const docs = getDocuments();
            const idx = docs.findIndex(d=>d.id===id); if (idx<0) return;
            const current = docs[idx].dueAt ? new Date(docs[idx].dueAt).toISOString() : '';
            const input = prompt('Set due date/time (ISO or YYYY-MM-DD HH:mm)', current);
            if (!input) return;
            let iso = '';
            try {
                if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2})?$/.test(input)) {
                    const normalized = input.replace(' ', 'T');
                    iso = new Date(normalized).toISOString();
                } else {
                    iso = new Date(input).toISOString();
                }
            } catch(e) { alert('Invalid date'); return; }
            if (!iso || isNaN(new Date(iso).getTime())) { alert('Invalid date'); return; }
            docs[idx].dueAt = iso;
            docs[idx].notifications = docs[idx].notifications || {};
            docs[idx].notifications.dueSoonSent = false;
            docs[idx].notifications.overdueSent = false;
            saveDocuments(docs);
            addDocumentActivity(id, `Due date set: ${new Date(iso).toLocaleString()}`);
            renderDocumentLibrary();
        }

        function addDocumentComment(id){
            const note = prompt('Comment'); if (!note) return;
            addDocumentActivity(id, `Comment: ${note}`);
            renderDocumentLibrary();
        }

        function viewDocumentActivity(id){
            const docs = getDocuments();
            const doc = docs.find(d=>d.id===id); if (!doc) return;
            const items = (doc.activity||[]).slice().sort((a,b)=> new Date(a.at)-new Date(b.at));
            if (items.length===0) { alert('No activity yet.'); return; }
            const text = items.map(x=>`${new Date(x.at).toLocaleString()} â€” ${x.by}: ${x.message}`).join('\n');
            alert(`Activity for ${doc.title}\n\n${text}`);
        }

        function previewDocument(id) {
            const doc = getDocuments().find(d => d.id === id); if (!doc) return;
            const win = window.open('', '_blank');
            win.document.write(`<pre style="font-family:inherit;white-space:pre-wrap;padding:16px;">${doc.content || ''}</pre>`);
            win.document.close();
        }
        function printDocument(id) { const doc = getDocuments().find(d => d.id === id); if (!doc) return; const w = window.open('', '_blank'); w.document.write(`<pre>${doc.content||''}</pre>`); w.document.close(); w.print(); }
        function emailDocument(id) { alert('Email queued for document: '+ id); }
        function archiveDocument(id) { const docs = getDocuments().map(d => d.id===id?{...d, archived:true, status:'Archived'}:d); saveDocuments(docs); renderDocumentLibrary(); }
        function bulkSelectedIds() { return Array.from(document.querySelectorAll('[data-doc-id]:checked')).map(cb => cb.getAttribute('data-doc-id')); }
        function bulkPrintSelectedDocuments() { bulkSelectedIds().forEach(printDocument); }
        function bulkEmailSelectedDocuments() { alert('Emails queued: '+ bulkSelectedIds().length); }
        function bulkArchiveSelectedDocuments() { const ids = new Set(bulkSelectedIds()); const docs = getDocuments().map(d => ids.has(d.id)?{...d, archived:true, status:'Archived'}:d); saveDocuments(docs); renderDocumentLibrary(); }

        // Initialize documents and optional advanced reports section if present
        document.addEventListener('DOMContentLoaded', () => {
            ensureDocumentsTab();
            try { ensureDocReminderTimer(); } catch(_) {}
            // --- Stock Workflows Help wiring ---
            (function initStockHelp(){
                const helpGlobal = document.getElementById('stockHelpBtnGlobal');
                const helpModal = document.getElementById('stockHelpModal');
                const helpClose = document.getElementById('stockHelpClose');
                const helpBody = document.getElementById('stockHelpBody');
                const helpTitle = document.getElementById('stockHelpTitle');
                if (!helpModal || !helpBody) return;

                let workflowsMd = '';
                async function loadMd(){
                    if (workflowsMd) return workflowsMd;
                    try {
                        const resp = await fetch('STOCK_WORKFLOWS.md', { cache: 'no-store' });
                        if (resp.ok) workflowsMd = await resp.text();
                    } catch(e) {}
                    return workflowsMd;
                }

                function mdToHtml(md){
                    let html = md
                        .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
                        .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
                        .replace(/^\-\s+\*\*(.*?)\*\*:(.*)$/gm, '<li><strong>$1</strong>:$2</li>')
                        .replace(/^\-\s+(.*)$/gm, '<li>$1</li>');
                    html = html.replace(/(?:^(?:<li>.*<\/li>)\n?)+/gms, m => `<ul>${m}</ul>`);
                    return html;
                }

                function extract(md, regexList){
                    for (const rx of regexList){
                        const m = md.match(rx);
                        if (m){
                            const start = m.index;
                            const rest = md.slice(start);
                            const next = rest.slice(m[0].length).search(/^###\s/m);
                            return (next>=0? rest.slice(0, m[0].length+next): rest).trim();
                        }
                    }
                    return '';
                }

                async function openHelp(section){
                    const md = await loadMd();
                    let title = 'Stock Workflows';
                    let sectionMd = '';
                    if (section === 'dashboard'){
                        title = 'Dashboard & FEFO';
                        const a = extract(md, [/^###\s+6\)\s+Dashboard[\s\S]*/m]);
                        const b = extract(md, [/^###\s+4\)\s+Barcode\/Batch[\s\S]*/m]);
                        sectionMd = [a,b].filter(Boolean).join('\n\n');
                    } else if (section === 'country'){
                        title = 'Country Stock Intake (Barcode/Batches)';
                        sectionMd = extract(md, [/^###\s+4\)\s+Barcode\/Batch[\s\S]*/m]);
                    } else if (section === 'warehouse'){
                        title = 'Warehouse Stock Management';
                        sectionMd = extract(md, [/^###\s+3\)\s+Warehouse[\s\S]*/m]);
                    } else if (section === 'requests'){
                        title = 'Stock Requests & Approvals';
                        const a = extract(md, [/^###\s+1\)\s+Stock Requests[\s\S]*/m]);
                        const b = extract(md, [/^###\s+2\)\s+Stock Transfers[\s\S]*/m]);
                        sectionMd = [a,b].filter(Boolean).join('\n\n');
                    } else {
                        sectionMd = md.split('\n').slice(0,120).join('\n');
                    }
                    helpTitle.textContent = title;
                    helpBody.innerHTML = mdToHtml(sectionMd);
                    helpModal.style.display = 'flex';
                }

                if (helpGlobal) helpGlobal.addEventListener('click', () => openHelp('dashboard'));
                if (helpClose) helpClose.addEventListener('click', () => { helpModal.style.display = 'none'; });
                if (helpModal) helpModal.addEventListener('click', (e) => { if (e.target && e.target.id === 'stockHelpModal') helpModal.style.display = 'none'; });
                document.querySelectorAll('[data-stock-help]').forEach(btn => {
                    btn.addEventListener('click', () => openHelp(btn.getAttribute('data-stock-help')));
                });
            })();
        });
    </script>
    <!-- Payment Modal -->
        <div id="rxPaymentModal" style="display:none; position:fixed; inset:0; z-index:10000; align-items:center; justify-content:center; background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); animation: fadeIn 0.3s ease-out;">                              
        <div style="background:#fff; width: 95%; max-width: 900px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow:hidden; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto;">        
            <div style="padding: 20px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; display:flex; align-items:center; justify-content:space-between; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">              
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 4px;">PAYMENT COLLECTION</div>
                    <div style="font-weight:700; font-size: 1.3rem;">Checkout</div>
                </div>           
                <button id="paymentCloseBtn" onclick="closePaymentModal()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; cursor:pointer; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ–</button>                     
            </div>
            <div style="padding: 24px;">                                      
                <div id="paymentSummary" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom: 20px;">                       
                    <!-- dynamic totals injected here -->                     
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">              
                    <div>
                        <label style="display:block; font-size: 0.85rem; color:#555; margin-bottom:8px; font-weight:600;">Discount Amount (N$)</label>                                 
                        <input id="paymentDiscount" type="number" min="0" step="0.01" value="0" oninput="recalcPaymentTotals()" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:1rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'" />                            
                    </div>
                    <div>
                        <label style="display:block; font-size: 0.85rem; color:#555; margin-bottom:8px; font-weight:600;">Consultation Fee</label>                              
                        <div id="paymentConsultation" style="padding:12px; border:2px solid #e0e0e0; border-radius:8px; background:#f8f9fa; font-size:1rem; font-weight:600; color:#667eea;">N$ 0.00</div>     
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">                               
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <strong style="font-size: 1rem; color: #2c3e50;">Payment Methods</strong>                              
                        <button class="btn btn-info" onclick="addTenderRow()" style="padding: 8px 16px; border-radius: 6px; font-weight: 600;">âž• Add Payment Method</button>                 
                    </div>
                    <div id="tenderRows" style="display:flex; flex-direction: column; gap:12px;">                         
                        <!-- tender rows inserted here -->                    
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px;">       
                    <div style="background:white; padding:16px; border-radius:8px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #27ae60;">            
                        <div style="font-size:0.75rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Amount Due</div>                                 
                        <div id="amountDue" style="font-weight:700; color:#27ae60; font-size:1.5rem;">N$ 0.00</div>                    
                    </div>
                    <div style="background:white; padding:16px; border-radius:8px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">            
                        <div style="font-size:0.75rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Tender Total</div>                               
                        <div id="tenderTotal" style="font-weight:700; color:#f39c12; font-size:1.5rem;">N$ 0.00</div>                  
                    </div>
                    <div style="background:white; padding:16px; border-radius:8px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #3498db;">            
                        <div style="font-size:0.75rem; color:#666; margin-bottom:6px; font-weight:600; text-transform:uppercase;">Change / Balance</div>                           
                        <div id="changeBalance" style="font-weight:700; color:#3498db; font-size:1.5rem;">N$ 0.00</div>                
                    </div>
                </div>
                <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:28px; padding-top:20px; border-top: 2px solid #e0e0e0;">                     
                    <button class="btn" onclick="closePaymentModal()" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; background: #f8f9fa; border: 2px solid #e0e0e0; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">Cancel</button>                                
                    <button class="btn btn-success" onclick="confirmPayment()" style="padding: 12px 32px; border-radius: 8px; font-weight: 700; font-size: 1.05rem; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(39, 174, 96, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(39, 174, 96, 0.4)'">âœ… Confirm Payment</button>           
                </div>
            </div>
        </div>
    </div>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</body>
<script>
    (function(){
        try{
            const raw = localStorage.getItem('currentUser');
            const user = raw ? JSON.parse(raw) : null;
            const allowed = user && ['hr_manager','hr_admin','admin'].includes(user.role);
            if(!allowed) return;
            const btn = document.createElement('a');
            btn.href = './hr-portal.html';
            btn.textContent = 'Open HR Portal';
            btn.style.position = 'fixed';
            btn.style.right = '16px';
            btn.style.bottom = '16px';
            btn.style.background = '#2563eb';
            btn.style.color = '#fff';
            btn.style.padding = '10px 14px';
            btn.style.borderRadius = '10px';
            btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.15)';
            btn.style.textDecoration = 'none';
            btn.style.fontWeight = '700';
            btn.style.zIndex = '9999';
            btn.setAttribute('aria-label','Open HR Portal');
            document.body.appendChild(btn);
        } catch(e){}
    })();
</script>
</html>