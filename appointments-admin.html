<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dynapharm | Appointments Admin</title>
    <link rel="icon" href="./favicon.ico">
    <meta name="description" content="Staff-only appointments view and management.">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827">
    <style>
        html,body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Helvetica Neue",Arial; background:#0f172a; color:#e5e7eb}
        header{position:sticky;top:0;z-index:10;background:#111827;border-bottom:1px solid #334155}
        .wrap{max-width:1100px;margin:0 auto;padding:16px}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .logo img{display:block;height:24px;width:auto}
        main{padding:24px 16px}
        select,input{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:8px;padding:10px}
        .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px}
        .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
        .btn.primary{background:#16a34a;color:#fff}
        .btn.warn{background:#f59e0b;color:#111827}
        .btn.ghost{background:transparent;color:#93c5fd}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#172554;color:#93c5fd;font-size:12px;font-weight:700}
        .list{display:grid;gap:12px;padding:12px}
        .item{border:1px solid #1f2937;border-radius:10px;padding:12px;background:#0a0f1c}
        .muted{color:#94a3b8;font-size:12px}
        .right{margin-left:auto}
    </style>
    <script defer src="/cloud-sync.js"></script>
    <script defer src="/auto-cloud-sync.js"></script>
    <script>
        (function(){
            const STORAGE_KEY = 'dyna_consult_appointments';
            const PASSCODE = 'dynastaff';
            function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch(_){return[]} }
            function save(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
            function qs(n){ return new URLSearchParams(location.search).get(n) }

            function ensureStaff(){
                if(qs('staff')==='1') return true;
                const code = prompt('Staff access - enter passcode:');
                return code === PASSCODE;
            }

            function render(){
                const branch = document.getElementById('branch').value;
                const target = document.getElementById('list');
                const all = load();
                const items = all.filter(a => (a.status!=='completed') && (!branch || a.branch===branch));
                if(!items.length){ target.innerHTML = '<div class="muted">No pending appointments for selection.</div>'; return; }
                target.innerHTML = items.map(a => `
                    <div class="item">
                        <div class="row" style="justify-content:space-between;gap:8px;">
                            <div style="font-weight:800;">${a.fullName}</div>
                            <span class="pill">${a.type||'Consultation'} â€¢ ${a.branch}</span>
                        </div>
                        <div class="muted" style="margin-top:6px;">${a.date} at ${a.time} â€¢ ${a.phone||a.email||''}</div>
                        ${a.clientReference?`<div class="muted" style="margin-top:4px;">Ref: ${a.clientReference}</div>`:''}
                        ${a.notes?`<div style="margin-top:6px;">${a.notes.replace(/[<>]/g,'')}</div>`:''}
                        ${a.clientForm?`<div style="margin-top:6px;"><button class="btn" style="background:#fff3cd;color:#856404;padding:4px 8px;font-size:11px;" onclick="viewClientForm('${a.id}')">ðŸ“‹ View Full Body Checkup Form</button></div>`:''}
                        <div class="row" style="margin-top:8px;">
                            <button class="btn primary" onclick="markCompleted('${a.id}')">Mark completed (prescription/report created)</button>
                            <span class="right muted">Created ${new Date(a.createdAt).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            window.viewClientForm = function(id){
                const list = load();
                const appt = list.find(x=>x.id===id);
                if(!appt || !appt.clientForm){
                    alert('Client form data not available');
                    return;
                }
                const cf = appt.clientForm;
                const popup = document.createElement('div');
                popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;overflow-y:auto;padding:40px 20px;';
                popup.innerHTML = `
                    <div style="background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:24px;max-width:800px;margin:0 auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;color:#e5e7eb;">Full Body Checkup Form</h2>
                            <button onclick="this.parentElement.parentElement.remove()" style="background:transparent;border:none;color:#e5e7eb;font-size:24px;cursor:pointer;">&times;</button>
                        </div>
                        <div style="color:#e5e7eb;line-height:1.8;">
                            <div style="margin-bottom:16px;"><strong>Client Reference:</strong> ${appt.clientReference||'N/A'}</div>
                            <div style="margin-bottom:16px;"><strong>Name:</strong> ${cf.fullName||''}</div>
                            <div style="margin-bottom:16px;"><strong>Phone:</strong> ${cf.phone||''}</div>
                            <div style="margin-bottom:16px;"><strong>Email:</strong> ${cf.email||''}</div>
                            ${cf.gender?`<div style="margin-bottom:16px;"><strong>Gender:</strong> ${cf.gender}</div>`:''}
                            ${cf.dob?`<div style="margin-bottom:16px;"><strong>Date of Birth:</strong> ${cf.dob}</div>`:''}
                            ${cf.age?`<div style="margin-bottom:16px;"><strong>Age:</strong> ${cf.age}</div>`:''}
                            ${cf.primaryReason?`<div style="margin-bottom:16px;"><strong>Primary Reason:</strong> ${cf.primaryReason}</div>`:''}
                            ${cf.medicalHistory&&cf.medicalHistory.length?`<div style="margin-bottom:16px;"><strong>Medical History:</strong> ${cf.medicalHistory.join(', ')}</div>`:''}
                            ${cf.currentMedications?`<div style="margin-bottom:16px;"><strong>Current Medications:</strong> ${cf.currentMedications}</div>`:''}
                            ${cf.supplements?`<div style="margin-bottom:16px;"><strong>Supplements:</strong> ${cf.supplements}</div>`:''}
                            ${cf.exerciseFreq?`<div style="margin-bottom:16px;"><strong>Exercise Frequency:</strong> ${cf.exerciseFreq}</div>`:''}
                            ${cf.sleepHours?`<div style="margin-bottom:16px;"><strong>Sleep Hours:</strong> ${cf.sleepHours}</div>`:''}
                            ${cf.waterIntake?`<div style="margin-bottom:16px;"><strong>Water Intake:</strong> ${cf.waterIntake}</div>`:''}
                        </div>
                        <div style="margin-top:24px;text-align:center;">
                            <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" class="btn ghost">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(popup);
            };

            window.addEventListener('DOMContentLoaded', function(){
                if(!ensureStaff()) { document.body.innerHTML='<div class="wrap"><p>Access denied.</p></div>'; return; }
                const branchSel = document.getElementById('branch');
                branchSel.addEventListener('change', render);
                document.getElementById('refresh').addEventListener('click', function(){
                    if(window.cloudStorage){ window.cloudStorage.syncToLocal().then(render); } else { render(); }
                });
                document.getElementById('saveCloud').addEventListener('click', function(){
                    if(window.cloudSaveToGitHub){ window.cloudSaveToGitHub(); } else { alert('Cloud save not available'); }
                });
                render();
            });

            window.markCompleted = function(id){
                const list = load();
                const idx = list.findIndex(x=>x.id===id);
                if(idx===-1) return;
                list[idx].status = 'completed';
                list[idx].completedAt = new Date().toISOString();
                save(list);
                try{ if(window.cloudAutoSaveAll){ window.cloudAutoSaveAll('Cloud sync: appointment completed'); } }catch(_){ }
                alert('Marked as completed. Remember to Save to Cloud.');
                const branch = document.getElementById('branch').value;
                const target = document.getElementById('list');
                const items = load().filter(a => (a.status!=='completed') && (!branch || a.branch===branch));
                target.innerHTML = items.length? '': '<div class="muted">No pending appointments for selection.</div>';
                // Re-render 
                const evt = new Event('change'); document.getElementById('branch').dispatchEvent(evt);
            }
        })();
    </script>
</head>
<body>
    <header>
        <div class="wrap row" style="justify-content:space-between;">
            <div class="row" style="gap:10px;">
                <span class="logo"><img src="./assets/dynapharm-logo.png" alt="Dynapharm Namibia Logo"></span>
                <strong>Appointments Admin</strong>
                <span class="pill">Staff Only</span>
            </div>
            <nav class="row" style="gap:8px;">
                <a href="/dynapharm-complete-system.html" class="btn ghost">Back to Main</a>
                <button onclick="window.cloudSetGitHubToken && window.cloudSetGitHubToken()" class="btn ghost">Set Token</button>
                <button id="saveCloud" class="btn warn">Save to Cloud</button>
            </nav>
        </div>
    </header>
    <main>
        <div class="wrap card">
            <div class="row" style="padding:12px; border-bottom:1px solid #1f2937;">
                <label>Branch</label>
                <select id="branch">
                    <option value="">All branches</option>
                    <option>Windhoek Main</option>
                    <option>Oshakati</option>
                    <option>Walvis Bay</option>
                    <option>Swakopmund</option>
                    <option>Rundu</option>
                </select>
                <button id="refresh" class="btn ghost">Refresh from Cloud</button>
            </div>
            <div id="list" class="list"></div>
        </div>
    </main>
</body>
</html>


