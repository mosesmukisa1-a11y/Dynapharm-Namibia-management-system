<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Branch Stock Inventory</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#0b1020; --card:#111831; --muted:#8aa0b5; --text:#e6eef7; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
        header { position: sticky; top:0; z-index:10; background: rgba(11,16,32,0.8); backdrop-filter: blur(8px); border-bottom: 1px solid #1e2a44; }
        .container { max-width: 1280px; margin: 0 auto; padding: 12px 16px; }
        .top-bar { display:flex; align-items:center; justify-content: space-between; gap: 12px; }
        .brand { display:flex; align-items:center; gap:10px; }
        .logo img { display:block; height:32px; width:auto; }
        .title { font-weight:700; letter-spacing: .2px; }
        .filters { display:flex; flex-wrap: wrap; gap: 8px; align-items:center; }
        .select, .input { background: #0e162b; color: var(--text); border: 1px solid #223154; border-radius: 8px; padding: 8px 10px; }
        .btn { appearance:none; border:1px solid #1e2a44; background:#0f1830; color:var(--text); border-radius:8px; padding:8px 10px; cursor:pointer; }
        .btn.primary { background:#0f2a24; border-color:#0e7d5c; }
        .tabs { display:flex; gap:6px; flex-wrap:wrap; padding:8px 0; }
        .tab { padding:8px 10px; border-radius:8px; border:1px solid #1e2a44; background:#0f1830; cursor:pointer; font-weight:600; color:var(--muted); }
        .tab.active { color: var(--text); border-color:#0e7d5c; background:#0f2a24; }
        .card { background: var(--card); border: 1px solid #1e2a44; border-radius: 12px; padding: 14px; }
        .muted { color: var(--muted); }
        .grid { display:grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
        .col-12 { grid-column: span 12; }
        .table { width:100%; border-collapse: collapse; font-size: 13px; }
        .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #1e2a44; text-align: left; }
        .section { margin: 12px 0; }
        iframe { width:100%; height: 72vh; border: 1px solid #1e2a44; border-radius: 10px; background:#0b1020; }
        
        @media (max-width: 768px) {
            .filters { flex-direction: column; align-items: stretch; }
            .select, .input, .btn { width: 100%; min-height: 44px; font-size: 16px; }
            iframe { height: 66vh; }
        }
    </style>
    <script defer src="./cloud-sync.js"></script>
    <script defer src="./auto-cloud-sync.js"></script>
    <script type="module">
        // Try to import transactions, but handle gracefully if missing
        let getTransactions;
        
        // Initialize getTransactions with fallback
        (async function() {
            try {
                const transactionsModule = await import('./web-modules/transactions.js');
                getTransactions = transactionsModule.getTransactions;
            } catch (error) {
                console.warn('transactions.js module not found, using fallback');
                // Fallback function
                getTransactions = async function({ dateRange = 'month', branch = 'all' } = {}) {
                try {
                    // Try to get from localStorage
                    const sales = JSON.parse(localStorage.getItem('dyna_walkin_sales') || '[]');
                    const onlineOrders = JSON.parse(localStorage.getItem('dyna_online_orders') || '[]');
                    const transactions = [...sales, ...onlineOrders].map(t => ({
                        id: t.id || t.receiptNo || `TXN-${Date.now()}`,
                        clientName: t.clientName || t.customerName || 'Unknown',
                        branch: t.branch || 'Unknown',
                        amount: t.total || t.amount || 0,
                        date: t.date || new Date().toISOString().split('T')[0],
                        status: t.status || 'completed'
                    }));
                    
                    // Filter by date range
                    const now = new Date();
                    let startDate = new Date(now);
                    switch(dateRange) {
                        case 'today':
                            startDate.setHours(0,0,0,0);
                            break;
                        case 'week':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'year':
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                        default:
                            startDate = new Date(0);
                    }
                    
                    let filtered = transactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= startDate;
                    });
                    
                    // Filter by branch
                    if (branch && branch !== 'all') {
                        filtered = filtered.filter(t => t.branch === branch);
                    }
                    
                    return { transactions: filtered };
                } catch (err) {
                    console.error('Error loading transactions:', err);
                    return { transactions: [] };
                }
            };
            }
        })();

        let branches = [];

        async function loadBranches() {
            const isStaticHost = (location.hostname.endsWith('github.io') || location.protocol === 'file:');
            if (isStaticHost) {
                try {
                    const fromLS = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
                    branches = Array.isArray(fromLS) ? fromLS : [];
                } catch(err) {
                    branches = [];
                }
            } else {
                try {
                    const resp = await fetch('/api/branches');
                    if (resp.ok) {
                        const apiResp = await resp.json();
                        branches = Array.isArray(apiResp) ? apiResp : (apiResp.branches || []);
                    }
                } catch (_) {}
                if (!Array.isArray(branches) || branches.length === 0) {
                    try {
                        const fromLS = JSON.parse(localStorage.getItem('dyna_branches') || '[]');
                        branches = Array.isArray(fromLS) ? fromLS : [];
                    } catch(err) { branches = []; }
                }
            }
            const sel = document.getElementById('branchFilter');
            sel.innerHTML = '<option value="all">All Branches</option>';
            branches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id; opt.textContent = b.name || b.id; sel.appendChild(opt);
            });
        }

        function switchTab(name){
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===name));
            document.querySelectorAll('[data-view]')
                .forEach(v => v.style.display = (v.dataset.view===name) ? 'block' : 'none');
            if (name === 'sales') renderSales();
            if (name === 'invoices') renderInvoices();
        }

        function applyFilters(){
            const branch = document.getElementById('branchFilter').value;
            const range = document.getElementById('dateRange').value;
            const q = document.getElementById('searchBox').value.trim().toLowerCase();
            return { branch, range, q };
        }

        function setIframe(){
            const iframe = document.getElementById('invFrame');
            if (!iframe) return;
            
            // Try to load stock-management-portal.html, with better error handling
            iframe.src = './stock-management-portal.html';
            
            // Handle iframe load errors
            iframe.onerror = function() {
                console.warn('stock-management-portal.html failed to load');
                showIframeFallback();
            };
            
            // Also check if iframe loads but content is blocked
            iframe.onload = function() {
                try {
                    // Check if iframe loaded successfully by trying to access its content
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                    if (!iframeDoc) {
                        // Iframe might be blocked by CORS, show fallback
                        setTimeout(() => {
                            if (iframe.contentWindow?.location?.href === 'about:blank' || 
                                iframe.contentWindow?.location?.href?.includes('refused')) {
                                showIframeFallback();
                            }
                        }, 1000);
                    }
                } catch (e) {
                    // CORS error - this is expected for cross-origin iframes
                    // Iframe is likely loading, just wait
                    console.log('Iframe CORS check (expected):', e.message);
                }
            };
            
            // Timeout fallback - if iframe doesn't load in 3 seconds, show fallback
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                    if (!iframeDoc || !iframeDoc.body) {
                        showIframeFallback();
                    }
                } catch (e) {
                    // This might be CORS, which is OK - don't show fallback yet
                    // Check if URL is blocked
                    if (iframe.contentWindow?.location?.href?.includes('refused') || 
                        iframe.contentWindow?.location?.href === 'about:blank') {
                        showIframeFallback();
                    }
                }
            }, 3000);
        }
        
        function showIframeFallback() {
            const iframe = document.getElementById('invFrame');
            if (!iframe) return;
            
            const container = iframe.parentElement;
            if (container) {
                iframe.style.display = 'none';
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #0e162b; border-radius: 12px; border: 1px solid #1e2a44;">
                        <h3 style="color: var(--text); margin-bottom: 15px;">üì¶ Stock Management Portal</h3>
                        <p style="color: var(--muted); margin-bottom: 20px;">The stock management portal can be accessed directly from the main system.</p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <a href="./dynapharm-complete-system.html#stock" class="btn primary" style="text-decoration: none; display: inline-block;">Open Stock Portal</a>
                            <a href="./stock-management-portal.html" target="_blank" class="btn" style="text-decoration: none; display: inline-block;">Open in New Tab ‚Üó</a>
                        </div>
                        <div style="margin-top: 30px; padding: 20px; background: #0b1020; border-radius: 8px; border: 1px solid #1e2a44;">
                            <h4 style="color: var(--text); margin-bottom: 10px;">Quick Inventory Summary</h4>
                            <div id="quickInventorySummary" style="color: var(--muted);">
                                <p>Loading inventory data...</p>
                            </div>
                        </div>
                    </div>
                `;
                loadQuickInventorySummary();
            }
        }
        
        function loadQuickInventorySummary() {
            const summaryDiv = document.getElementById('quickInventorySummary');
            if (!summaryDiv) return;
            
            try {
                const inventory = JSON.parse(localStorage.getItem('dynapharm_inventory') || '[]');
                const branchStock = JSON.parse(localStorage.getItem('dyna_barcode_stock') || '[]');
                
                if (inventory.length === 0 && branchStock.length === 0) {
                    summaryDiv.innerHTML = '<p>No inventory data available. Please add stock items.</p>';
                    return;
                }
                
                const totalItems = inventory.length + branchStock.length;
                const totalQuantity = [...inventory, ...branchStock].reduce((sum, item) => {
                    return sum + (parseInt(item.quantity) || 0);
                }, 0);
                
                summaryDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: left;">
                        <div>
                            <strong style="color: var(--accent);">Total Products:</strong>
                            <div style="font-size: 1.5rem; color: var(--text);">${totalItems}</div>
                        </div>
                        <div>
                            <strong style="color: var(--accent);">Total Quantity:</strong>
                            <div style="font-size: 1.5rem; color: var(--text);">${totalQuantity}</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: var(--muted); font-size: 0.9rem;">
                        Click "Open Stock Portal" above to access full inventory management features.
                    </p>
                `;
            } catch (error) {
                console.error('Error loading inventory summary:', error);
                summaryDiv.innerHTML = '<p>Error loading inventory data. Please try opening the stock portal.</p>';
            }
        }

        async function renderSales(){
            const tbody = document.getElementById('salesBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
            const { branch, range, q } = applyFilters();
            
            // Ensure getTransactions is available
            if (!getTransactions) {
                await new Promise(resolve => setTimeout(resolve, 100));
                if (!getTransactions) {
                    tbody.innerHTML = '<tr><td colspan="6" class="muted">Error: Transactions module not available</td></tr>';
                    return;
                }
            }
            
            const res = await getTransactions({ dateRange: range, branch: branch });
            let rows = res.transactions;
            if (q) {
                rows = rows.filter(t => [t.id, t.clientName, t.branch].filter(Boolean).join(' ').toLowerCase().includes(q));
            }
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="muted">No sales found</td></tr>';
                return;
            }
            tbody.innerHTML = rows.slice(0,50).map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.clientName}</td>
                    <td>${t.branch}</td>
                    <td>N$ ${parseFloat(t.amount).toFixed(2)}</td>
                    <td>${t.date}</td>
                    <td>${t.status}</td>
                </tr>
            `).join('');
        }

        async function renderInvoices(){
            // For now, invoices mirror sales transactions list
            const tbody = document.getElementById('invBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading...</td></tr>';
            const { branch, range, q } = applyFilters();
            
            // Ensure getTransactions is available
            if (!getTransactions) {
                // Wait a bit for it to initialize
                await new Promise(resolve => setTimeout(resolve, 100));
                if (!getTransactions) {
                    tbody.innerHTML = '<tr><td colspan="5" class="muted">Error: Transactions module not available</td></tr>';
                    return;
                }
            }
            
            const res = await getTransactions({ dateRange: range, branch: branch });
            let rows = res.transactions;
            if (q) {
                rows = rows.filter(t => [t.id, t.clientName, t.branch].filter(Boolean).join(' ').toLowerCase().includes(q));
            }
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="muted">No invoices found</td></tr>';
                return;
            }
            tbody.innerHTML = rows.slice(0,50).map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.clientName}</td>
                    <td>${t.branch}</td>
                    <td>N$ ${parseFloat(t.amount).toFixed(2)}</td>
                    <td>${t.date}</td>
                </tr>
            `).join('');
        }

        function onFiltersChanged(){
            const active = document.querySelector('.tab.active')?.dataset.tab || 'inventory';
            if (active === 'inventory') setIframe();
            if (active === 'sales') renderSales();
            if (active === 'invoices') renderInvoices();
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadBranches();
                setIframe();
                switchTab('inventory');
                
                const branchFilter = document.getElementById('branchFilter');
                const dateRange = document.getElementById('dateRange');
                const searchBox = document.getElementById('searchBox');
                
                if (branchFilter) {
                    branchFilter.addEventListener('change', onFiltersChanged);
                }
                if (dateRange) {
                    dateRange.addEventListener('change', onFiltersChanged);
                }
                if (searchBox) {
                    searchBox.addEventListener('input', () => { 
                        clearTimeout(window.__t); 
                        window.__t = setTimeout(onFiltersChanged, 250); 
                    });
                }
                
                document.querySelectorAll('.tab').forEach(t => {
                    t.addEventListener('click', () => switchTab(t.dataset.tab));
                });
            } catch (error) {
                console.error('Error initializing branch stock inventory:', error);
                // Show error message to user
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: var(--danger);">
                            <h3>Error Loading Stock Inventory</h3>
                            <p>${error.message}</p>
                            <a href="./dynapharm-complete-system.html#stock" class="btn primary" style="margin-top: 20px; text-decoration: none; display: inline-block;">
                                Open Stock Portal
                            </a>
                        </div>
                    `;
                }
            }
        });
        
        // Global error handler for uncaught errors
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            // Don't show alerts for script errors, just log them
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent default browser error handling
            event.preventDefault();
        });
    </script>
</head>
<body>
    <header>
        <div class="container top-bar">
            <div class="brand">
                <div class="logo"><img src="./assets/dynapharm-logo.png" alt="Dynapharm Namibia Logo"></div>
                <div class="title">üè¨ Branch Stock Inventory</div>
            </div>
            <div class="filters">
                <select id="branchFilter" class="select">
                    <option value="all">All Branches</option>
                </select>
                <select id="dateRange" class="select">
                    <option value="today">Today</option>
                    <option value="week">Last 7 days</option>
                    <option value="month" selected>Last 30 days</option>
                    <option value="year">Last 12 months</option>
                </select>
                <input id="searchBox" class="input" placeholder="Search sales/invoices (id, client, branch)" />
                <a class="btn" href="./stock-management-portal.html" target="_blank" rel="noopener">Open Full Stock Portal ‚Üó</a>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 12px;">
        <div class="tabs">
            <div class="tab active" data-tab="inventory">Inventory Dashboard</div>
            <div class="tab" data-tab="sales">Daily Sales</div>
            <div class="tab" data-tab="invoices">Invoices</div>
        </div>

        <section class="section card" data-view="inventory">
            <div class="muted" style="margin-bottom:8px;">Embedded stock dashboard with movements, requests, transfers and warehouse snapshot.</div>
            <iframe id="invFrame" title="Stock Management"></iframe>
        </section>

        <section class="section card" data-view="sales" style="display:none;">
            <div class="muted" style="margin-bottom:8px;">Sales filtered by date range and branch.</div>
            <div style="overflow:auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Branch</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody"></tbody>
                </table>
            </div>
        </section>

        <section class="section card" data-view="invoices" style="display:none;">
            <div class="muted" style="margin-bottom:8px;">Invoices overview (based on sales transactions).</div>
            <div style="overflow:auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Client</th>
                            <th>Branch</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </section>
    </main>
</body>
</html>


